<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Finance Career Skills Tracker </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --pe-color: #e74c3c;
            --ib-color: #3498db;
            --hf-color: #f39c12;
            --sc-color: #2ecc71;
            --english-color: #fbe82c;
            --fintech-color: #00ffef;
            --chinese-color: #00ffd2;
            --tools-color: #ff1265;
            --cfa1-color: #00ff82;
            --primary: #3b82f6;
            --bg-light: #f3f4f6;
            --bg-white: #ffffff;
            --text-dark: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.3s ease;
            --quote-bg: rgba(255, 255, 255, 0.8);
            --quote-text: #1e293b;
            --quote-icon: #f59e0b;
            --quote-border: rgba(226, 232, 240, 0.5);
            --header-bg: #ffffff; 
            --header-text: #1e293b; 
        }


        /* --- NÃºt Cool-Timer Hover Effect --- */
        .sidebar-card a[href="https://cool-timer.com/"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .dark-mode {
            --primary: #60a5fa;
            --bg-light: #0f172a;
            --bg-white: #1e293b;
            --text-dark: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --quote-bg: rgba(30, 41, 59, 0.7);
            --quote-text: #e2e8f0;
            --quote-icon: #fbbf24;
            --quote-border: rgba(51, 65, 85, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            position: relative;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #a29bfe);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
            margin-bottom: 10px;
        }

        .dark-mode h1 {
            background: linear-gradient(45deg, #fb7185, #fbbf24, #38bdf8, #a78bfa);
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        /* --- Quote Card Styles --- */
        #quoteCard {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--quote-bg);
            backdrop-filter: blur(5px);
            border: 1px solid var(--quote-border);
            border-radius: var(--radius-md);
            padding: 15px 20px;
            max-width: 300px;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: var(--transition), transform 0.2s ease;
            z-index: 100;
        }

        #quoteCard:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .quote-icon {
            font-size: 1.2rem;
            color: var(--quote-icon);
            margin-bottom: 8px;
        }

        #quoteText {
            font-style: italic;
            font-size: 0.95rem;
            color: var(--quote-text);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        #quoteAuthor {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: right;
        }
        /* --- End Quote Card Styles --- */

        /* --- DAILY STUDY CHART DARK MODE --- */
        .dark-mode .chart-container {
            background: #334155 !important;
        }
        .dark-mode #dailyStudyChart {
            filter: brightness(1.1);
        }     
        /* --- END DAILY STUDY CHART DARK MODE --- */   

        
        /* Progress Overview */
        .progress-overview {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .progress-title {
            font-size: 1.8rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-stats {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fef3c7;
            padding: 8px 15px;
            border-radius: 20px;
            color: #92400e;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .dark-mode .progress-stats {
            background: #78350f;
            color: #fef3c7;
        }

        .progress-bar-container {
            width: 100%;
            height: 16px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .dark-mode .progress-bar-container {
            background: #334155;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 8px;
            transition: width 0.5s ease;
        }

        .dark-mode .progress-bar {
            background: linear-gradient(90deg, #60a5fa, #a78bfa);
        }

        /* Main Content Grid */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
        }

        /* Skills Section */
        .skills-section {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-md);
        }

        .skills-section h2 {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: var(--text-dark);
        }

        /* Skill Category */
        .skill-category {
            margin-bottom: 30px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: var(--radius-md);
            margin-bottom: 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .dark-mode .category-header {
            background: #334155;
        }

        .category-header:hover {
            background: #f1f5f9;
        }

        .dark-mode .category-header:hover {
            background: #475569;
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-icon {
            font-size: 1.8rem;
        }

        .category-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        /* Skills List */
        .skills-list {
            display: grid;
            gap: 15px;
        }

        .skills-list.collapsed {
            display: none;
        }

        .skill-item {
            background: #f8fafc;
            border-radius: var(--radius-md);
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            border-left: 4px solid var(--primary);
            transition: var(--transition);
        }

        .dark-mode .skill-item {
            background: #334155;
        }

        .skill-item:hover {
            background: #f1f5f9;
            transform: translateX(5px);
        }

        .dark-mode .skill-item:hover {
            background: #475569;
        }

        .skill-item[data-career="pe"] { border-left-color: var(--pe-color); }
        .skill-item[data-career="ib"] { border-left-color: var(--ib-color); }
        .skill-item[data-career="hf"] { border-left-color: var(--hf-color); }
        .skill-item[data-career="sc"] { border-left-color: var(--sc-color); }
        .skill-item[data-career="english"] { border-left-color: var(--english-color); }
        .skill-item[data-career="chinese"] { border-left-color: var(--chinese-color); }
        .skill-item[data-career="tools"] {border-left-color: var(--tools-color); }
        .skill-item[data-career="cfa1"] { border-left-color: var(--cfa1-color); }


        .skill-info {
            flex: 1;
            min-width: 200px;
        }

        .skill-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .skill-meta {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .skill-time, .skill-hours {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .skill-progress-container {
            width: 120px;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
        }

        .dark-mode .skill-progress-container {
            background: #475569;
        }

        .skill-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .dark-mode .skill-progress-fill {
            background: linear-gradient(90deg, #34d399, #10b981);
        }

        .skill-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-input {
            width: 70px;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            text-align: center;
            background: var(--bg-white);
            color: var(--text-dark);
        }

        .add-time-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .add-time-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .dark-mode .add-time-btn:hover {
            background: #3b82f6;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .sidebar-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-md);
        }

 

        /* --- SIDEBAR TITLE --- */
        .sidebar-title {
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            font-size: 1.35rem;
            font-weight: 700;
            margin-bottom: 22px;
            position: relative;
            padding-bottom: 8px;
            color: var(--text-dark);
            letter-spacing: -0.5px;
            cursor: default;
            transition: color 0.3s ease;
        }

        .sidebar-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.6;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.22, 0.61, 0.36, 1);
        }

        .sidebar-title:hover::after {
            transform: scaleX(1);
        }

        .sidebar-title:hover {
            transform: translateY(-2px) scale(1.02);
            filter: drop-shadow(0 4px 8px rgba(59, 130, 246, 0.2));
            color: var(--primary);
        }

        .sidebar-title:hover {
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
        }

        .dark-mode .sidebar-title {
            color: var(--text-dark);
        }

        .dark-mode .sidebar-title:hover {
            color: #60a5fa;
            text-shadow: 0 0 10px rgba(96, 165, 250, 0.4);
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
        }

        .dark-mode .sidebar-title::after {
            background: linear-gradient(90deg, transparent, #60a5fa, transparent);
        }

        .sidebar-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-title-icon {
            font-size: 1.4rem;
            line-height: 1;
            transition: transform 0.3s ease;
        }

        .sidebar-title:hover .sidebar-title-icon {
            transform: scale(1.15) rotate(5deg);
        }

        .sidebar-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        .dark-mode .sidebar-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .sidebar-title {
            margin: -25px -25px 20px -25px;
            padding: 20px 25px 15px;
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent);
            backdrop-filter: blur(4px);
        }   
        

        .dark-mode .sidebar-title {
            text-shadow: 0 0 5px rgba(96, 165, 250, 0.5);
        }
        .dark-mode .sidebar-title:hover {
            text-shadow: 
                0 0 8px rgba(96, 165, 250, 0.7),
                0 0 16px rgba(96, 165, 250, 0.5),
                0 0 24px rgba(96, 165, 250, 0.3);
        }



        /* --- LEARNING MOOD WIDGET --- */
        #learningMoodWidget {
            margin-bottom: 24px;
            padding: 24px;
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(59, 130, 246, 0.1);
            transition: all 0.3s ease;
        }

        .dark-mode #learningMoodWidget {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.15);
            backdrop-filter: blur(8px);
            box-shadow: 0 8px 32px rgba(30, 41, 59, 0.1);
        }

        .random-skill {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(96, 165, 250, 0.05));
            color: var(--text-dark);
            padding: 22px;
            border-radius: var(--radius-xl);
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 130, 246, 0.15);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.08);
            transition: all 0.3s ease;
        }

        .dark-mode .random-skill {
            background: rgba(30, 41, 59, 0.2);
            border-color: rgba(96, 165, 250, 0.2);
            box-shadow: 0 4px 16px rgba(96, 165, 250, 0.05);
        }

        .random-skill h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: -0.1px;
        }

        #randomSkillText {
            font-size: 1.05rem;
            line-height: 1.5;
            color: var(--text-dark);
            font-weight: 600;
            padding: 0 16px;
            word-wrap: break-word;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            letter-spacing: -0.05px;
        }

        .dark-mode #randomSkillText {
            color: #e2e8f0;
            font-weight: 500;
        }

        
        .mood-selector {
            margin-top: 16px;
        }

        .mood-title {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 14px;
            text-align: center;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: 0.1px;
        }

        .mood-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 8px;
        }

        .mood-btn {
            padding: 12px 24px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            background: transparent;
            color: var(--text-dark);
            border-radius: 16px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', 'Segoe UI', sans-serif;
            letter-spacing: 0.1px;
            min-width: 100px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.05);
        }

        .dark-mode .mood-btn {
            color: #e2e8f0;
            border-color: rgba(96, 165, 250, 0.2);
            box-shadow: 0 2px 8px rgba(96, 165, 250, 0.05);
        }

        .mood-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.15);
        }

        .mood-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.6);
            color: var(--primary);
            font-weight: 700;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
            animation: pulse 0.8s ease-in-out;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .dark-mode .mood-btn.active {
            background: rgba(96, 165, 250, 0.25);
            border-color: rgba(96, 165, 250, 0.7);
            color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.4);
            animation: pulse 0.8s ease-in-out;
        }


        .mood-btn.active::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 18px;
            pointer-events: none;
            opacity: 0;
            animation: glow 1.5s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .mood-btn {
                padding: 10px 18px;
                font-size: 0.85rem;
                min-width: 80px;
            }
            .random-skill {
                padding: 18px;
            }
            #randomSkillText {
                font-size: 1rem;
            }
        }
        /* --- END LEARNING MOOD WIDGET --- */


        .dark-mode-toggle {
        position: relative;
        overflow: hidden;
        }

        .dark-mode-toggle::after {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(96, 165, 250, 0.4) 0%, transparent 70%);
        animation: pulseGlow 2s ease-in-out infinite;
        pointer-events: none;
        border-radius: 50%;
        }

        @keyframes pulseGlow {
        0%, 100% {
            opacity: 0.4;
            transform: scale(1);
        }
        50% {
            opacity: 0.8;
            transform: scale(1.2);
        }
        }
                
        /* STATS SECTION */
        .gamification-stats {
            background: linear-gradient(135deg, #4B0082, #3A0CA3, #4F46E5, #3B82F6);
            background-size: 400% 400%;
            color: white;
            padding: 28px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            text-align: center;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.15);
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .gamification-stats::before {
            content: '';
            position: absolute;
            top: -10%;
            left: -10%;
            width: 120%;
            height: 120%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: pulseGlow 6s ease-in-out infinite;
            pointer-events: none;
            border-radius: 50%;
        }

        @keyframes pulseGlow {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.2); }
        }

        .level-container,
        .points-container,
        .streak-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 12px 0;
            font-size: 1.2rem;
            letter-spacing: -0.3px;
            transition: transform 0.3s ease, opacity 0.3s ease;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .level-container:hover,
        .points-container:hover,
        .streak-container:hover {
            transform: translateY(-4px) scale(1.05);
            opacity: 1;
            text-shadow: 0 0 15px rgba(255,255,255,0.5), 0 0 25px rgba(255,255,255,0.3);
        }

        .level-icon,
        .points-icon,
        .streak-icon {
            font-size: 1.8rem;
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.4));
            animation: iconGlow 2s ease-in-out infinite alternate;
        }

        @keyframes iconGlow {
            from { filter: drop-shadow(0 0 8px rgba(255,255,255,0.4)); }
            to { filter: drop-shadow(0 0 15px rgba(255,255,255,0.7)); }
        }

        .level-text,
        .points-text,
        .streak-text {
            font-size: 1.7rem;
            font-weight: 800;
            color: white;
            text-shadow: 
                0 0 5px rgba(255,255,255,0.5),
                0 0 10px rgba(255,255,255,0.4),
                0 0 15px rgba(255,255,255,0.3);
            font-family: 'Poppins', sans-serif;
            background: none;
            -webkit-background-clip: unset;
            -webkit-text-fill-color: unset;
            background-clip: unset;
        }

        .dark-mode .gamification-stats {
            background: linear-gradient(135deg, #1E1B4B, #2E2C7B, #3B82F6, #4F46E5);
        }

        .dark-mode .level-text,
        .dark-mode .points-text,
        .dark-mode .streak-text {
            text-shadow: 
                0 0 5px rgba(255,255,255,0.4),
                0 0 10px rgba(255,255,255,0.3),
                0 0 15px rgba(255,255,255,0.2);
        }

        .total-hours {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            margin-bottom: 20px;
        }

        .chart-container {
            width: 100%;
            height: 200px;
            margin: 20px 0;
            background: #f8fafc;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dark-mode .chart-container {
            background: #334155;
        }

        .export-btn, .import-btn {
            width: 100%;
            padding: 14px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
            transition: var(--transition);
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .dark-mode .export-btn {
            background: #10b981;
        }

        .import-btn {
            background: #3498db;
        }

        .dark-mode .import-btn {
            background: #60a5fa;
        }

        .export-btn:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        .dark-mode .export-btn:hover {
            background: #059669;
        }

        .import-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        .dark-mode .import-btn:hover {
            background: #3b82f6;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .dark-mode .notification {
            box-shadow: var(--shadow-lg);
        }

        .notification.show {
            transform: translateX(0);
        }

        /* --- Dark Mode Toggle Button --- */
        .dark-mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;          
            background: rgba(59, 130, 246, 0.1); 
            color: #1e40af;            
            border: 1px solid #3b82f6; 
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            font-weight: 500; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            backdrop-filter: blur(2px); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        .dark-mode .dark-mode-toggle {
            background: rgba(30, 41, 59, 0.7); 
            color: #f1f5f9; 
            border: 1px solid #475569;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .dark-mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .dark-mode .dark-mode-toggle:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        /* --- End Dark Mode Toggle Button --- */


        /* --- COURSE MANAGEMENT--- */
        .course-item {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .dark-mode .course-item {
            background: #334155;
            border-color: #475569;
            box-shadow: var(--shadow-sm);
        }

        .course-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-left-color: var(--primary);
        }

        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .course-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-dark);
            flex: 1;
            min-width: 180px;
            word-wrap: break-word;
            font-family: 'Segoe UI', sans-serif;
            line-height: 1.35;
            letter-spacing: -0.1px;
        }

        .course-status-badge {
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            font-family: 'Segoe UI', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .course-status-badge.active { 
            background-color: #fef3c7; 
            color: #92400e; 
            border: 1px solid #fbbf24;
        }
        .course-status-badge.completed { 
            background-color: #d1fae5; 
            color: #065f46; 
            border: 1px solid #10b981;
        }
        .course-status-badge.paused { 
            background-color: #e5e7eb; 
            color: #374151; 
            border: 1px solid #d1d5db;
        }

        .dark-mode .course-status-badge.active { 
            background-color: #78350f; 
            color: #fef3c7; 
            border: 1px solid #fbbf24;
        }
        .dark-mode .course-status-badge.completed { 
            background-color: #065f46; 
            color: #d1fae5; 
            border: 1px solid #10b981;
        }
        .dark-mode .course-status-badge.paused { 
            background-color: #374151; 
            color: #e5e7eb; 
            border: 1px solid #475569;
        }

        .course-meta {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 14px;
            color: var(--text-muted);
            font-size: 0.88rem;
            margin-bottom: 14px;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: -0.05px;
        }

        .course-difficulty, .course-priority, .course-deadline {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .course-icon {
            font-size: 1rem;
            color: var(--text-muted);
        }

        .course-progress-container {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin: 12px 0;
        }

        .course-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #8b5cf6);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .course-progress-fill.completed {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .course-deadline.overdue { color: #e74c3c; font-weight: bold; }
        .course-deadline.soon { color: #f39c12; font-weight: bold; }

        .course-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .course-action-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-white);
            color: var(--text-dark);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.25s ease;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: -0.05px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }

        .dark-mode .course-action-btn {
            background: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        .course-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }

        .course-action-btn.open-link {
            background: #10b981;
            color: white;
            border-color: #059669;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }
        .course-action-btn.open-link:hover {
            background: #059669;
            color: white;
            border-color: #059669;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .course-action-btn.edit {
            background: #f8fafc;
            color: #3b82f6;
            border-color: #e2e8f0;
        }
        .course-action-btn.edit:hover {
            background: #e2e8f0;
            color: #2563eb;
            border-color: #cbd5e1;
        }

        .course-action-btn.delete {
            color: #e74c3c;
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }
        .course-action-btn.delete:hover {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border-color: #e74c3c;
        }


        .course-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: var(--radius-lg);
            background: radial-gradient(circle at 10% 10%, rgba(59, 130, 246, 0.05) 0%, transparent 40%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .course-item:hover::before {
            opacity: 1;
        }


        .goal-empty-state {
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.95rem;
            padding: 30px 16px;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: -0.1px;
        }

        .favorite-icon {
            font-size: 1.2rem;
            color: #f59e0b; 
            cursor: pointer;
            margin-left: 8px;
            transition: color 0.2s ease, transform 0.2s ease;
            user-select: none;
        }

        .favorite-icon:hover {
            color: #fbbf24;
            transform: scale(1.1);
        }

        .dark-mode .favorite-icon {
            color: #fbbf24;
        }

        .dark-mode .favorite-icon:hover {
            color: #f59e0b;
        } 

        /* Responsive */
        @media (max-width: 480px) {
            .course-item {
                padding: 16px;
            }
            .course-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .course-title {
                width: 100%;
            }
            .course-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            .course-actions {
                flex-direction: row;
                justify-content: space-between;
                gap: 6px;
            }
            .course-action-btn {
                flex: 1;
                max-width: 48%;
            }
        }
        /* --- END COURSE MANAGEMENT --- */

        .career-title {
            font-weight: 600;
            color: var(--primary); 
            transition: color 0.3s ease;
        }

        .career-title[data-career="pe"] { color: var(--pe-color); }
        .career-title[data-career="ib"] { color: var(--ib-color); }
        .career-title[data-career="hf"] { color: var(--hf-color); }
        .career-title[data-career="sc"] { color: var(--sc-color); }
        .career-title[data-career="english"] { color: var(--english-color); }
        .career-title[data-career="chinese"] { color: var(--chinese-color); }
        .career-title[data-career="fintech"] { color: var(--fintech-color); }
        .career-title[data-career="tools"] { color: var(--tools-color); }
        .career-title[data-career="cfa1"] { color: var(--cfa1-color); }       
       
        @media (max-width: 1100px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .sidebar {
                grid-row: 1;
            }
            #quoteCard {
                max-width: 250px;
                bottom: 10px;
                left: 10px;
                padding: 12px 15px;
            }
            #quoteText {
                font-size: 0.85rem;
            }
            #quoteAuthor {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 768px) {
            .career-grid {
                grid-template-columns: 1fr 1fr;
            }
            h1 {
                font-size: 2rem;
            }
            .skill-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .skill-controls {
                width: 100%;
                justify-content: flex-end;
            }
        }

        @media (max-width: 480px) {
            .career-grid {
                grid-template-columns: 1fr;
            }
            .progress-header {
                flex-direction: column;
                align-items: flex-start;
            }
            #quoteCard {
                max-width: calc(100vw - 20px);
                left: 10px;
                right: 10px;
            }
        }
                #sessionLogsContainer::-webkit-scrollbar {
            width: 8px;
        }
        
        #sessionLogsContainer::-webkit-scrollbar-track {
            background: var(--bg-light);
            border-radius: 4px;
        }
        
        #sessionLogsContainer::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        .session-log {
            padding: 12px;
            margin-bottom: 10px;
            background: var(--bg-light);
            border-left: 4px solid var(--primary);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            font-size: 0.9rem;
        }
        
        .dark-mode #sessionNote {
            background: var(--bg-white);
            color: var(--text-dark);
            border-color: var(--border-color);
        }
        
        .dark-mode .session-log {
            background: var(--bg-white);
            border-left-color: var(--primary);
        }

        /* --- GOAL MANAGEMENT --- */

        .goal-add-btn {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.1); 
            color: var(--text-dark); 
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-lg);
            font-family: 'Inter', 'Segoe UI', system-ui;
            font-weight: 600;
            font-size: 1rem;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
        }



        .goal-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.2);
            background: rgba(59, 130, 246, 0.15); 
            border-color: rgba(59, 130, 246, 0.5);
            color: var(--text-dark);
        }

        .dark-mode .goal-add-btn {
            background: rgba(30, 41, 59, 0.5); 
            color: #f1f5f9; 
            border-color: rgba(96, 165, 250, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .dark-mode .goal-add-btn:hover {
            background: rgba(96, 165, 250, 0.2); 
            border-color: rgba(96, 165, 250, 0.5);
            box-shadow: 0 6px 16px rgba(96, 165, 250, 0.3);
        }

        .goal-progress-summary {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin: 15px 0;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .dark-mode .goal-progress-summary {
            background: #334155;
            border-color: #475569;
        }

        .goal-progress-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: -0.2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .goal-progress-text {
            font-size: 0.95rem;
            color: var(--primary);
            font-weight: 700;
            margin-top: 8px;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: -0.1px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .dark-mode .goal-progress-text {
            color: #60a5fa;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .goal-empty-state {
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.95rem;
            padding: 30px 16px;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: -0.1px;
        }

        .goal-item {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .dark-mode .goal-item {
            background: #334155;
            border-color: #475569;
            box-shadow: var(--shadow-sm);
        }

        .goal-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-left-color: var(--primary);
            border-color: var(--border-color);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .goal-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-dark);
            flex: 1;
            min-width: 180px;
            word-wrap: break-word;
            font-family: 'Segoe UI', sans-serif;
            line-height: 1.35;
            letter-spacing: -0.1px;
        }

        .goal-status-badge {
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            font-family: 'Segoe UI', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .goal-status-badge.active { 
            background-color: #fef3c7; 
            color: #92400e; 
            border: 1px solid #fbbf24;
        }
        .goal-status-badge.completed { 
            background-color: #d1fae5; 
            color: #065f46; 
            border: 1px solid #10b981;
        }
        .goal-status-badge.overdue { 
            background-color: #fee2e2; 
            color: #b91c1c; 
            border: 1px solid #ef4444;
        }

        .dark-mode .goal-status-badge.active { 
            background-color: #78350f; 
            color: #fef3c7; 
            border: 1px solid #fbbf24;
        }
        .dark-mode .goal-status-badge.completed { 
            background-color: #065f46; 
            color: #d1fae5; 
            border: 1px solid #10b981;
        }
        .dark-mode .goal-status-badge.overdue { 
            background-color: #7f1d1d; 
            color: #fee2e2; 
            border: 1px solid #ef4444;
        }

        .goal-meta {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 14px;
            color: var(--text-muted);
            font-size: 0.88rem;
            margin-bottom: 14px;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: -0.05px;
        }

        .goal-type, .goal-deadline, .goal-progress-text {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .goal-icon {
            font-size: 1rem;
            color: var(--text-muted);
        }

        .goal-progress-container {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin: 12px 0;
        }

        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #8b5cf6);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .goal-progress-fill.completed {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .goal-progress-text {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-align: right;
            margin-bottom: 14px;
            font-family: 'Segoe UI', sans-serif;
            font-weight: 500;
        }

        .goal-forecast {
            font-size: 0.85rem;
            color: #3b82f6;
            font-style: italic;
            margin-top: 8px;
            padding: 5px 10px;
            background: rgba(59, 130, 246, 0.08);
            border-radius: 8px;
            display: inline-block;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: -0.05px;
        }

        .dark-mode .goal-forecast {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
        }

        .goal-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .goal-action-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-white);
            color: var(--text-dark);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.25s ease;
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: -0.05px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }

        .dark-mode .goal-action-btn {
            background: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        .goal-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }

        .goal-action-btn.delete {
            color: #e74c3c;
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }
        .goal-action-btn.delete:hover {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .goal-action-btn.complete {
            background: #10b981;
            color: white;
            border-color: #059669;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }
        .goal-action-btn.complete:hover {
            background: #059669;
            color: white;
            border-color: #059669;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .goal-action-btn.edit {
            background: #f8fafc;
            color: #3b82f6;
            border-color: #e2e8f0;
        }
        .goal-action-btn.edit:hover {
            background: #e2e8f0;
            color: #2563eb;
            border-color: #cbd5e1;
        }

        .goal-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: var(--radius-lg);
            background: radial-gradient(circle at 10% 10%, rgba(59, 130, 246, 0.05) 0%, transparent 40%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .goal-item:hover::before {
            opacity: 1;
        }
        .goal-item,
        .goal-progress-title,
        .goal-progress-text,
        .goal-title,
        .goal-action-btn,
        .goal-status-badge,
        .goal-forecast,
        .goal-meta,
        .goal-progress-text,
        .goal-add-btn {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', sans-serif;
        }

        @media (max-width: 480px) {
            .goal-item {
                padding: 16px;
            }
            .goal-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .goal-title {
                width: 100%;
            }
            .goal-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            .goal-actions {
                flex-direction: row;
                justify-content: space-between;
                gap: 6px;
            }
            .goal-action-btn {
                flex: 1;
                max-width: 48%;
            }
        }
        /* --- END GOAL MANAGEMENT --- */

        /* --- COURSE ACTION BUTTONS --- */
        .course-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Segoe UI', sans-serif;
            letter-spacing: -0.05px;
            min-height: 36px; 
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .course-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .course-action-btn.open-link {
            background: #10b981;
            color: white;
        }
        .course-action-btn.open-link:hover {
            background: #059669;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .course-action-btn.add-hours {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
        }
        .dark-mode .course-action-btn.add-hours {
            background: #475569;
            color: #f1f5f9;
            border-color: #64748b;
        }
        .course-action-btn.add-hours:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .course-action-btn.edit {
            background: #f8fafc;
            color: #3b82f6;
            border: 1px solid #e2e8f0;
        }
        .dark-mode .course-action-btn.edit {
            background: #475569;
            color: #60a5fa;
            border-color: #64748b;
        }
        .course-action-btn.edit:hover {
            background: #dbeafe;
            color: #2563eb;
            border-color: #bfdbfe;
        }

        .course-action-btn.delete {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .dark-mode .course-action-btn.delete {
            background: #7f1d1d;
            color: #fee2e2;
            border-color: #ef4444;
        }
        .course-action-btn.delete:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }

        .course-action-btn.open-link svg {
            transition: filter 0.3s ease;
        }
        .course-action-btn.open-link:hover svg {
            filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.5));
        }        

        @media (max-width: 480px) {
            .course-actions {
                flex-direction: row;
                justify-content: space-between;
                gap: 6px;
            }
            .course-action-btn {
                flex: 1;
                max-width: 48%;
                justify-content: center;
            }
        }
        /* --- END COURSE ACTION BUTTONS --- */

        /* --- RANDOM MEME WIDGET --- */
        .meme-widget {
            margin: 24px 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .meme-widget:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }

        .meme-image-container {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            overflow: hidden;
            border-radius: var(--radius-md);
            background: #f8fafc;
            padding: 10px;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .meme-image-container img {
            width: 100%;
            height: auto;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s ease;
        }

        .meme-image-container img:hover {
            transform: scale(1.05);
        }

        .meme-caption {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 8px;
            font-style: italic;
            line-height: 1.4;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .dark-mode .meme-caption {
            color: #e2e8f0;
        }

        @media (max-width: 480px) {
            .meme-image-container {
                max-width: 250px;
            }
        }

        /* --- READING LIST STYLES --- */
        :root {

            --primary: #6366f1; 
            --bg-white: #ffffff; 
            --bg-light: #f8fafc; 
            --text-dark: #1e293b; 
            --text-muted: #64748b; 
            --border-color: #e2e8f0; 
            --radius-sm: 6px; 
            --radius-md: 8px; 
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05); 
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --transition: all 0.2s ease; 
        }

        .filter-section {
            margin: 15px 0;
            padding: 16px;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .filter-section label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .filter-section select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-white);
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .stats-section {
            display: flex;
            justify-content: space-around;
            margin: 16px 0;
            padding: 16px;
            background: var(--bg-light);
            border-radius: var(--radius-md);
        }

        .stat-item {
            text-align: center;
        }

        .stat-emoji {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }

        .stat-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-dark);
        }

        .reading-container {
            margin-top: 16px;
            max-height: 500px; 
            overflow-y: auto;
            padding: 8px 0;
        }

        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
            font-style: italic;
        }

        /* IMPROVED BOOK ITEM DESIGN */
        .book-item {
            display: grid;
            grid-template-columns: 60px 1fr auto; 
            gap: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: var(--radius-md);
            background: var(--bg-white);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            align-items: start;
        }

        .book-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-left-color: var(--primary);
        }

        .book-cover {
            width: 60px;
            height: 84px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .book-details {
            min-width: 0; 
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .book-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.4;
            margin-bottom: 4px;
            word-wrap: break-word;
            hyphens: auto;
        }

        .book-author {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-style: italic;
            line-height: 1.3;
        }

        .book-meta-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .book-genre {
            font-size: 0.75rem;
            color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .book-status-badge {
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .book-status-badge.want {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }

        .book-status-badge.reading {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .book-status-badge.finished {
            background-color: #e0e7ff;
            color: #3730a3;
            border: 1px solid #6366f1;
        }

        .book-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-shrink: 0;
        }

        .book-action-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-muted);
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .book-action-btn:hover {
            background: var(--bg-light);
            color: var(--primary);
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .book-rating {
            margin: 5px 0;
            color: #f59e0b; 
            font-size: 1rem;
        }

        .book-rating .star {
            color: #d1d5db;
        }

        .book-rating .star.filled {
            color: #f59e0b; 
        }

        .book-rating .star.half {
            position: relative;
            color: #d1d5db; 
        }

        .book-rating .star.half::before {
            content: "â";
            position: absolute;
            left: 0;
            top: 0;
            width: 50%; 
            overflow: hidden;
            color: #f59e0b; 
        }

        .book-review {
            font-size: 0.9rem;
            color: var(--text-light); 
            margin-bottom: 10px;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }

        .dark-mode .book-review {
            color: #94a3b8; 
        }



        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg-white);
            padding: 24px;
            border-radius: var(--radius-md);
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-dark);
            padding: 4px;
            border-radius: var(--radius-sm);
        }

        .modal-close:hover {
            background: var(--bg-light);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-white);
            color: var(--text-dark);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 500;
            z-index: 10000;
            transition: var(--transition);
        }

        .notification.success {
            background: #10b981;
        }

        .notification.error {
            background: #ef4444;
        }

        /* Responsive Design */
        @media (max-width: 640px) {
            .book-item {
                grid-template-columns: 50px 1fr;
                gap: 12px;
                padding: 14px;
            }

            .book-actions {
                grid-column: 1 / -1;
                flex-direction: row;
                justify-content: flex-start;
                gap: 8px;
                margin-top: 8px;
            }

            .book-cover {
                width: 50px;
                height: 70px;
            }

            .book-title {
                font-size: 1rem;
            }

            .book-author {
                font-size: 0.85rem;
            }

            .stats-section {
                gap: 16px;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
            }
        }

        .notification {
            font-family: Arial, sans-serif;
            font-size: 14px;
        }

        /* Dark mode support */
        .dark-mode .book-item {
            background: var(--bg-white); 
            border-left-color: #334155;
        }

        .dark-mode .book-genre {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .dark-mode .book-status-badge.want {
            background-color: #78350f;
            color: #fef3c7;
        }

        .dark-mode .book-status-badge.reading {
            background-color: #065f46;
            color: #d1fae5;
        }

        .dark-mode .book-status-badge.finished {
            background-color: #3730a3;
            color: #e0e7ff;
        }

        .dark-mode .book-action-btn:hover {
            background: #475569;
            color: #60a5fa;
        }
        /* --- END READING LIST STYLES --- */


        /* CSS cho pháº§n review */
        .book-review.truncated {
            cursor: pointer;
            background-color: #f8fafc;
            padding: 6px 8px;
            border-radius: 4px;
            border-left: 2px solid #3b82f6;
            margin-top: 4px;
        }
        .book-review.truncated:hover {
            background-color: #e2e8f0;
        }
        .read-more {
            font-style: italic;
            color: #60a5fa;
            font-size: 0.85em;
        }

        #fullReviewModal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); 
            backdrop-filter: blur(4px); 
        }

        #fullReviewModal .modal-content {
            background-color: white;
            margin: 5% auto; 
            padding: 0;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh; 
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        #fullReviewModal .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #fullReviewModal .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: #1e293b;
        }

        #fullReviewModal .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }

        #fullReviewModal .modal-close:hover {
            color: #0f172a;
        }

        #fullReviewModal .modal-body {
            padding: 20px;
            flex-grow: 1; 
            overflow-y: auto; 
        }

        #bookDetailsModal .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 700px; 
            max-height: 85vh; 
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        #bookDetailsModal .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; 
        }        

        #bookDetailsModal .modal-header h3 {
            margin: 0 0 4px 0; 
            font-size: 1.25rem;
            color: #1e293b;
        }


        #bookDetailsModal .modal-header p {
            margin: 0;
            color: #64748b;
            font-size: 1rem;
        }

        #bookDetailsModal .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            margin-left: 10px;
        }

        #bookDetailsModal .modal-close:hover {
            color: #0f172a;
        }

        #bookDetailsModal .modal-body {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto; 
            max-height: 60vh; 
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .sidebar {
                order: -1; 
            }
            
            .skill-item {
                padding: 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .skill-controls {
                width: 100%;
                justify-content: flex-end;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .time-input {
                width: 80px;
            }
            
            .course-item, .goal-item {
                padding: 15px;
                margin-bottom: 12px;
            }
            
            .course-actions, .goal-actions {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .course-action-btn, .goal-action-btn {
                flex: 1;
                min-width: 100px;
                font-size: 0.8rem;
                padding: 8px 12px;
            }

            #timerDisplay {
                font-size: 1.5rem !important;
            }
            
            .gamification-stats {
                padding: 20px 15px;
            }
            
            .level-text, .points-text, .streak-text {
                font-size: 1.4rem !important;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .career-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .career-card {
                padding: 15px 10px;
            }
            
            .career-icon {
                font-size: 2rem;
            }
            
            .career-name {
                font-size: 1rem;
            }
            
            .modal-content {
                margin: 5px;
                max-height: 95vh;
                overflow-y: auto;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; =
            }
            
            #quoteCard {
                left: 5px;
                right: 5px;
                max-width: calc(100vw - 10px);
                bottom: 5px;
            }
            
            #quoteText {
                font-size: 0.8rem;
                line-height: 1.3;
            }
        }

        #bookDetailsModal .modal-content {
            background-color: var(--bg-white); 
            color: var(--text-dark); 
            margin: 5% auto;
            padding: 0;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg); 
        }

        #bookDetailsModal .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color); 
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        #bookDetailsModal .modal-header h3 {
            margin: 0 0 4px 0;
            font-size: 1.25rem;
            color: var(--text-dark); 
        }

        #bookDetailsModal .modal-header p {
            margin: 0;
            color: var(--text-muted); 
            font-size: 1rem;
        }

        #bookDetailsModal .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted); 
            margin-left: 10px;
        }

        #bookDetailsModal .modal-close:hover {
            color: var(--text-dark); 
        }

        #bookDetailsModal .modal-body {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .dark-mode #bookDetailsModal .modal-content {
            background-color: var(--bg-light); 
            color: var(--text-dark); 
        }

        .dark-mode #bookDetailsModal .modal-header {
            border-bottom: 1px solid var(--border-color); 
        }

        .dark-mode #bookDetailsModal .modal-header h3,
        .dark-mode #bookDetailsModal .modal-header p {
            color: var(--text-dark); 
        }

        .dark-mode #bookDetailsModal .modal-close {
            color: var(--text-muted); 
        }

        .dark-mode #bookDetailsModal .modal-close:hover {
            color: var(--text-dark); 
        }

        #bookDetailsModal #bookDetailsCover {
            width: 100px;
            height: 140px;
            object-fit: cover;
            border-radius: 6px;
            display: none; 
        }

        #bookDetailsModal .modal-body div > div { 
            flex-grow: 1;
        }

        #bookDetailsModal .modal-body p {
            margin: 8px 0;
            font-size: 0.95rem;
        }

        #bookDetailsModal .modal-body p strong {
            font-weight: 600;
        }

        #bookDetailsModal #bookDetailsGenre,
        #bookDetailsModal #bookDetailsStatus {
            font-size: 0.95rem;
            font-weight: 500;
        }

        #bookDetailsModal #bookDetailsRating {
            margin: 8px 0;
            color: var(--primary); 
            font-size: 1.1rem;
        }

        #bookDetailsModal #bookDetailsReview {
            margin-top: 10px;
            font-style: italic;
            line-height: 1.5;
        }

        .dark-mode #bookDetailsModal .modal-body p {
            color: var(--text-dark);
        }

        .dark-mode #bookDetailsModal .modal-body p strong {
            color: var(--text-dark);
        }

        .dark-mode #bookDetailsModal #bookDetailsGenre,
        .dark-mode #bookDetailsModal #bookDetailsStatus {
            color: var(--text-dark);
        }

        .dark-mode #bookDetailsModal #bookDetailsRating {
            color: var(--primary); 
        }

        .dark-mode #bookDetailsModal #bookDetailsReview {
            color: var(--text-dark);
        }


        /* --- READING LIST STYLES --- */
        .reading-controls {
            display: flex;
            flex-wrap: wrap; 
            gap: 10px;
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-white); 
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm); 
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .dark-mode .reading-controls {
            background: var(--bg-white);
            border-color: #334155;
        }

        .reading-controls select, 
        .reading-controls input {
            padding: 8px 12px; 
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-light); 
            color: var(--text-dark);
            flex-grow: 1; 
            min-width: 120px;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .dark-mode .reading-controls select, 
        .dark-mode .reading-controls input {
            background: #334155;
            border-color: #475569;
            color: #f1f5f9;
        }

        .filter-section, .sort-filter-container { 
            display: none !important; 
        } 

        .stats-section {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-around;
            gap: 15px;
            border: 1px solid var(--border-color);
        }

        .dark-mode .stats-section {
            background: var(--bg-white);
            border-color: #334155;
        }

        .stat-emoji {
            font-size: 1.8rem;
            margin-bottom: 5px;
            transition: transform 0.2s ease;
        }

        .stat-item:hover .stat-emoji {
            transform: scale(1.15);
        }

        .stat-label {
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary); 
            margin-top: 2px;
        }

        .book-rating {
            margin: 5px 0;
            font-size: 1rem;
            white-space: nowrap;
        }

        .book-rating .star {
            color: #d1d5db; 
            font-size: 1.1em;
            transition: color 0.1s;
        }

        .book-rating .star.filled {
            color: #f59e0b; 
        }

        .book-rating .star.half {
            position: relative;
            color: #d1d5db; 
            display: inline-block;
            overflow: hidden; 
        }

        .book-rating .star.half::before {
            content: "â";
            position: absolute;
            left: 0;
            top: 0;
            width: 50%; 
            overflow: hidden;
            color: #f59e0b; 
        }

        .book-review.truncated {
            cursor: pointer;
            background-color: var(--bg-light);
            padding: 6px 8px;
            border-radius: 4px;
            border-left: 2px solid var(--primary);
            margin-top: 4px;
            font-size: 0.9rem;
            color: var(--text-dark);
            word-break: break-word; 
            white-space: normal; 
        }
        .dark-mode .book-review.truncated {
            background-color: #334155;
            border-left-color: var(--primary);
            color: #f1f5f9;
        }
        .book-review.truncated:hover {
            background-color: #e2e8f0;
        }
        .dark-mode .book-review.truncated:hover {
            background-color: #475569;
        }
        .read-more {
            font-style: italic;
            color: #60a5fa;
            font-size: 0.85em;
            white-space: nowrap;
        }

        .custom-dropdown-wrapper {
            margin: 15px 0;
        }

        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-selected {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .dropdown-selected:hover {
            border-color: var(--primary);
        }

        .dropdown-arrow {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .custom-dropdown.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            margin-top: 5px;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .custom-dropdown.active .dropdown-options {
            max-height: 300px;
            opacity: 1;
        }

        .dropdown-option {
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .dropdown-option:hover {
            background: var(--bg-light);
            color: var(--primary);
        }

        .dropdown-option.selected {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            font-weight: 600;
        }

        /* Dark mode */
        .dark-mode .dropdown-selected,
        .dark-mode .dropdown-options {
            background: #334155;
            border-color: #475569;
        }

        .dark-mode .dropdown-option:hover {
            background: #475569;
        }

        /* Skill completed state */
        .skill-item.skill-done {
            opacity: 0.7;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05));
        }

        .skill-item.skill-done:hover {
            opacity: 0.85;
        }

        .skill-item.skill-done .skill-progress-fill {
            background: linear-gradient(90deg, #10b981, #059669) !important;
        }

        /* Goal Type Option Hover & Selection */
        .goal-type-option:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .goal-type-option.selected {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .dark-mode .goal-type-option {
            background: #334155;
            border-color: #475569;
        }

        .dark-mode .goal-type-option:hover {
            background: rgba(96, 165, 250, 0.15);
            border-color: #60a5fa;
        }

        .dark-mode .goal-type-option.selected {
            background: rgba(96, 165, 250, 0.2);
            border-color: #60a5fa;
        }

        /* Suggestion Button Hover Effects */
        .suggestion-btn:hover {
            background: var(--primary) !important;
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
        }

        .dark-mode .suggestion-btn {
            background: #334155 !important;
            color: #60a5fa !important;
            border-color: #60a5fa !important;
        }

        .dark-mode .suggestion-btn:hover {
            background: #60a5fa !important;
            color: white !important;
        }

        /* Goal Card Hover Effect */
        .goal-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1) !important;
        }

        .dark-mode .goal-item:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3) !important;
        }

        /* Button Hover Effects */
        .goal-item button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }


        /* Suggestion Card Hover Effect */
        .suggestion-card:not([style*="cursor: default"]):hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15) !important;
            border-width: 3px !important;
        }

        .dark-mode .suggestion-card:not([style*="cursor: default"]):hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4) !important;
        }

        /* Close button hover */
        #smartSuggestionsModal button:hover {
            background: var(--bg-light) !important;
            transform: rotate(90deg);
        }

        /* Smart Suggestions Modal Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #smartSuggestionsModal > div {
            animation: fadeIn 0.3s ease;
        }



        /* --- CORRELATION ANALYTICS --- */
        .correlation-dashboard {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
        }

        .correlation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .correlation-title {
            font-size: 1.8rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .correlation-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .insight-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(96, 165, 250, 0.05));
            padding: 20px;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .insight-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .insight-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .insight-description {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .correlation-strength {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .correlation-strength.strong {
            background: #d1fae5;
            color: #065f46;
        }

        .correlation-strength.moderate {
            background: #fef3c7;
            color: #92400e;
        }

        .correlation-strength.weak {
            background: #fee2e2;
            color: #991b1b;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: var(--bg-light);
            padding: 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .chart-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .no-data-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Dark mode adjustments */
        .dark-mode .insight-card {
            background: rgba(30, 41, 59, 0.3);
            border-left-color: #60a5fa;
        }

        .dark-mode .chart-card {
            background: #1e293b;
            border-color: #334155;
        }

        .dark-mode .correlation-strength.strong {
            background: #065f46;
            color: #d1fae5;
        }

        .dark-mode .correlation-strength.moderate {
            background: #78350f;
            color: #fef3c7;
        }

        .dark-mode .correlation-strength.weak {
            background: #7f1d1d;
            color: #fee2e2;
        }

        @media (max-width: 768px) {
            .correlation-insights {
                grid-template-columns: 1fr;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        .analysis-card {
            background: var(--bg-white);
            border-left: 4px solid #3b82f6;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s ease;
        }
        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .analysis-card.stock_pitch { border-left-color: #10b981; }
        .analysis-card.lbo { border-left-color: #f59e0b; }
        .analysis-card.dcf { border-left-color: #8b5cf6; }
        .analysis-card.ma { border-left-color: #ef4444; }
        .analysis-card.industry { border-left-color: #06b6d4; }

        .deal-card {
            background: var(--bg-white);
            border-left: 4px solid #8b5cf6;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s ease;
        }
        .deal-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .deal-card.M&A { border-left-color: #ef4444; }
        .deal-card.LBO { border-left-color: #f59e0b; }
        .deal-card.IPO { border-left-color: #10b981; }
        .deal-card.Restructuring { border-left-color: #6366f1; }

        /* Header styles */
        .animated-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--header-text);
        }

        /* Gradient for title text only */
        header h1 .title-text {
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #a29bfe);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
        }

        /* Heart icons - keep original red color */
        .heart {
            font-size: 1.8rem;
            display: inline-block;
            vertical-align: middle;
            -webkit-text-fill-color: initial; /* Force original color */
            animation: heartbeat 1.8s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .left-heart { animation-delay: 0s; }
        .right-heart { animation-delay: 0.9s; }

        /* Animations */
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.25); }
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Dark mode */
        .dark-mode {
            --primary: #60a5fa;
            --bg-light: #0f172a;
            --bg-white: #1e293b;
            --text-dark: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --quote-bg: rgba(30, 41, 59, 0.7);
            --quote-text: #e2e8f0;
            --quote-icon: #fbbf24;
            --quote-border: rgba(51, 65, 85, 0.5);
            --header-bg: #1e293b; 
            --header-text: #f1f5f9; 
        }

        .dark-mode header h1 .title-text {
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: brightness(1.2);
        }


        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .dark-mode .subtitle {
            color: var(--text-muted); 
        }

        .dark-mode-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000; 
            pointer-events: auto; 
        }

        .dark-mode-toggle {
            position: relative;
            overflow: hidden;
            background: rgba(59, 130, 246, 0.1); 
            color: #1e40af;            
            border: 1px solid #3b82f6; 
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            font-weight: 500; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            backdrop-filter: blur(2px); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }

        .dark-mode .dark-mode-toggle {
            background: rgba(30, 41, 59, 0.7); 
            color: #f1f5f9; 
            border: 1px solid #475569;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .dark-mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .dark-mode .dark-mode-toggle:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }


        .dark-mode-toggle::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(96, 165, 250, 0.4) 0%, transparent 70%);
            animation: pulseGlow 2s ease-in-out infinite;
            pointer-events: none;
            border-radius: 50%;
        }
        
        @keyframes pulseGlow {
            0%, 100% {
                opacity: 0.4;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }

        /* --- STYLES FOR SELECT DROPDOWNS IN DEAL AND ANALYSIS CARDS --- */
        .deal-card select,
        .analysis-card select {
            border-radius: 12px;
            padding: 10px;
            font-size: 0.9rem;
            width: 100%;
            margin-bottom: 10px;
            background: var(--bg-light);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .dark-mode .deal-card select,
        .dark-mode .analysis-card select {
            background: #334155;
            color: #f1f5f9;
            border-color: #475569;
        }

        .deal-card select:focus,
        .analysis-card select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .dark-mode .deal-card select:focus,
        .dark-mode .analysis-card select:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .filter-select {
            flex: 1;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-white); 
            color: var(--text-dark);
            transition: var(--transition);
        }

        .dark-mode .filter-select {
            background: rgba(30, 41, 59, 0.7); 
            color: var(--text-muted);
            border-color: #60a5fa; 
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2); 
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .dark-mode .filter-select:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .add-deal-btn,
        .add-analysis-btn {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .add-deal-btn,
        .dark-mode .add-analysis-btn {
            border-color: #60a5fa;
            color: #60a5fa;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .add-deal-btn:hover,
        .add-analysis-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .dark-mode .add-deal-btn:hover,
        .dark-mode .add-analysis-btn:hover {
            background: #60a5fa;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        .sidebar-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }

        .dark-mode .sidebar-card {
            background: rgba(30, 41, 59, 0.7); 
            box-shadow: var(--shadow-lg);
        }

        .filter-select:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .dark-mode .filter-select:hover {
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.1);
        }


        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Confetti on Goal Completion */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f39c12;
            animation: confetti-fall 3s linear;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }



        /* --- CAREER GRID SYSTEM --- */
        .career-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px; 
            margin-bottom: 30px;
        }

        .career-card {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 20px;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            text-align: center;
            background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.05),
                inset 0 1px 1px rgba(255, 255, 255, 0.5);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .career-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none; 
            z-index: 0;
        }

        .career-card:hover::before {
            opacity: 1;
        }

        .career-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.8);
            border-color: rgba(255, 255, 255, 0.9);
        }

        .career-card.selected {
            background: rgba(59, 130, 246, 0.1); 
            border: 2px solid rgba(59, 130, 246, 0.6);
            box-shadow: 
                0 12px 40px rgba(59, 130, 246, 0.25),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
            transform: translateY(-8px) scale(1.02);
        }

        .dark-mode .career-card {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .dark-mode .career-card:hover {
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(96, 165, 250, 0.5);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .dark-mode .career-card.selected {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(96, 165, 250, 0.8);
            box-shadow: 0 0 30px rgba(96, 165, 250, 0.3);
        }

        .career-icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
            z-index: 1; 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            transition: transform 0.3s ease;
        }

        .career-card:hover .career-icon {
            transform: scale(1.15) translateY(-5px);
        }

        .career-name {
            font-size: 1.3rem;
            font-weight: 700; 
            color: var(--text-dark, #1e293b); 
            z-index: 1;
            text-shadow: 0 2px 4px rgba(255,255,255,0.5);
        }

        .dark-mode .career-name {
            color: var(--text-light, #f1f5f9);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .career-card[data-career="pe"] { border-top: 4px solid var(--pe-color, #ef4444); }
        .career-card[data-career="pe"].selected { border-color: var(--pe-color, #ef4444); }

        .career-card[data-career="ib"] { border-top: 4px solid var(--ib-color, #f59e0b); }
        .career-card[data-career="ib"].selected { border-color: var(--ib-color, #f59e0b); }

        .career-card[data-career="hf"] { border-top: 4px solid var(--hf-color, #10b981); }
        .career-card[data-career="hf"].selected { border-color: var(--hf-color, #10b981); }

        .career-card[data-career="sc"] { border-top: 4px solid var(--sc-color, #8b5cf6); }
        .career-card[data-career="sc"].selected { border-color: var(--sc-color, #8b5cf6); }

        .career-card[data-career="fintech"] { border-top: 4px solid var(--fintech-color, #3b82f6); }
        .career-card[data-career="fintech"].selected { border-color: var(--fintech-color, #3b82f6); }

        .career-card[data-career="english"] { border-top: 4px solid var(--english-color, #ec4899); }
        .career-card[data-career="english"].selected { border-color: var(--english-color, #ec4899); }

        .career-card[data-career="chinese"] { border-top: 4px solid var(--chinese-color, #db2777); }
        .career-card[data-career="chinese"].selected { border-color: var(--chinese-color, #db2777); }

        .career-card[data-career="tools"] { border-top: 4px solid var(--tools-color, #64748b); }
        .career-card[data-career="tools"].selected { border-color: var(--tools-color, #64748b); }

        .career-card[data-career="cfa1"] { border-top: 4px solid var(--cfa1-color, #f97316); }
        .career-card[data-career="cfa1"].selected { border-color: var(--cfa1-color, #f97316); }        


        /* Progress Overview */
        .progress-overview {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .dark-mode .progress-overview {
            background: rgba(30, 41, 59, 0.4);
            border-color: rgba(96, 165, 250, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .progress-title {
            font-size: 1.8rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .dark-mode .progress-title {
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .progress-stats {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(251, 191, 36, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 10px 18px;
            border-radius: 20px;
            color: #92400e;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 
                0 4px 12px rgba(251, 191, 36, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .dark-mode .progress-stats {
            background: rgba(251, 191, 36, 0.25);
            color: #fef3c7;
            box-shadow: 
                0 4px 12px rgba(251, 191, 36, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
        }

        .progress-bar-container {
            width: 100%;
            height: 20px;
            background: rgba(226, 232, 240, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .dark-mode .progress-bar-container {
            background: rgba(51, 65, 85, 0.4);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            background-size: 200% 100%;
            border-radius: 10px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 
                0 0 20px rgba(59, 130, 246, 0.6),
                0 0 40px rgba(139, 92, 246, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shine 2s ease-in-out infinite;
        }

        @keyframes shine {
            0% {
                left: -100%;
            }
            50%, 100% {
                left: 100%;
            }
        }

        .dark-mode .progress-bar {
            background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6);
            box-shadow: 
                0 0 20px rgba(96, 165, 250, 0.7),
                0 0 40px rgba(167, 139, 250, 0.5),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }        


        .dark-mode {
            --primary: #60a5fa;
            --bg-light: #0f172a;
            --bg-white: #1e293b;
            --text-dark: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --quote-bg: rgba(30, 41, 59, 0.7);
            --quote-text: #e2e8f0;
            --quote-icon: #fbbf24;
            --quote-border: rgba(51, 65, 85, 0.5);
            --header-bg: #1e293b; 
            --header-text: #f1f5f9; 
        }

        body.dark-mode {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            background-attachment: fixed;
            position: relative;
        }

        body.dark-mode::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 50%, rgba(96, 165, 250, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 70% 50%, rgba(167, 139, 250, 0.15) 0%, transparent 50%);
            animation: darkGlow 15s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes darkGlow {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            33% {
                transform: translate(10%, 10%) rotate(120deg);
            }
            66% {
                transform: translate(-10%, -10%) rotate(240deg);
            }
        }

        .dark-mode h1 {
            background: linear-gradient(45deg, #fb7185, #fbbf24, #38bdf8, #a78bfa);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
            filter: brightness(1.3) drop-shadow(0 0 20px rgba(251, 113, 133, 0.4));
        }

        .dark-mode .subtitle {
            color: #94a3b8;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        .dark-mode .skill-item {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(96, 165, 250, 0.2);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .skill-item:hover {
            background: rgba(51, 65, 85, 0.7);
            box-shadow: 
                0 8px 24px rgba(96, 165, 250, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.15);
            border-color: rgba(96, 165, 250, 0.4);
        }

        .dark-mode .category-header {
            background: rgba(51, 65, 85, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(96, 165, 250, 0.2);
        }

        .dark-mode .category-header:hover {
            background: rgba(71, 85, 105, 0.6);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.2);
        }

        .dark-mode .sidebar-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(96, 165, 250, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .gamification-stats {
            background: linear-gradient(135deg, #1e1b4b, #2e2c7b, #3b82f6, #4f46e5);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 40px rgba(59, 130, 246, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .chart-container {
            background: rgba(51, 65, 85, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(96, 165, 250, 0.2);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .dark-mode .course-item,
        .dark-mode .goal-item {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(96, 165, 250, 0.2);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .course-item:hover,
        .dark-mode .goal-item:hover {
            box-shadow: 
                0 8px 24px rgba(96, 165, 250, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.15);
            border-color: rgba(96, 165, 250, 0.4);
        }

        .dark-mode input,
        .dark-mode select,
        .dark-mode textarea {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(96, 165, 250, 0.3);
            color: #f1f5f9;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .dark-mode input:focus,
        .dark-mode select:focus,
        .dark-mode textarea:focus {
            border-color: #60a5fa;
            box-shadow: 
                0 0 0 3px rgba(96, 165, 250, 0.2),
                inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .dark-mode .modal-content {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(96, 165, 250, 0.3);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode #quoteCard {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(96, 165, 250, 0.3);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(96, 165, 250, 0.2);
        }

        .dark-mode #quoteCard:hover {
            box-shadow: 
                0 12px 40px rgba(96, 165, 250, 0.4),
                0 0 30px rgba(96, 165, 250, 0.3);
            border-color: rgba(96, 165, 250, 0.5);
        }       
        
        

        /* --- SIDEBAR GLASS CARDS --- */
        .sidebar-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-card:hover {
            transform: translateY(-4px);
            box-shadow: 
                0 12px 40px rgba(59, 130, 246, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
            border-color: rgba(59, 130, 246, 0.3);
        }

        /* Gamification Stats vá»i Glass */
        .gamification-stats {
            background: linear-gradient(135deg, #4B0082, #3A0CA3, #4F46E5, #3B82F6);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.2),
                0 0 40px rgba(59, 130, 246, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .gamification-stats::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            animation: pulseGlow 6s ease-in-out infinite;
        }

        /* Level/Points/Streak containers vá»i hover glow */
        .level-container,
        .points-container,
        .streak-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 12px 0;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .level-container:hover,
        .points-container:hover,
        .streak-container:hover {
            transform: translateY(-4px) scale(1.05);
            text-shadow: 0 0 15px rgba(255,255,255,0.5), 0 0 25px rgba(255,255,255,0.3);
        }

        .level-icon,
        .points-icon,
        .streak-icon {
            font-size: 1.8rem;
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.4));
            animation: iconGlow 2s ease-in-out infinite alternate;
        }

        @keyframes iconGlow {
            from { filter: drop-shadow(0 0 8px rgba(255,255,255,0.4)); }
            to { filter: drop-shadow(0 0 15px rgba(255,255,255,0.7)); }
        }

        /* Chart Container Glass */
        .chart-container {
            background: rgba(248, 250, 252, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* Dark Mode Sidebar Adjustments */
        .dark-mode .sidebar-card {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(96, 165, 250, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .sidebar-card:hover {
            box-shadow: 
                0 12px 40px rgba(96, 165, 250, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.15);
            border-color: rgba(96, 165, 250, 0.4);
        }

        .dark-mode .gamification-stats {
            background: linear-gradient(135deg, #1e1b4b, #2e2c7b, #3b82f6, #4f46e5);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 40px rgba(59, 130, 246, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .chart-container {
            background: rgba(51, 65, 85, 0.5);
            border-color: rgba(96, 165, 250, 0.2);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }   
        
        
        /* --- INPUT FIELDS FROSTED GLASS --- */
        input,
        select,
        textarea {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--text-dark);
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.05),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        input:hover,
        select:hover,
        textarea:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 
                0 6px 16px rgba(59, 130, 246, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 
                0 0 0 3px rgba(59, 130, 246, 0.15),
                0 8px 20px rgba(59, 130, 246, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Placeholder styling */
        input::placeholder,
        textarea::placeholder {
            color: rgba(100, 116, 139, 0.6);
            font-style: italic;
        }

        input:focus::placeholder,
        textarea:focus::placeholder {
            color: rgba(59, 130, 246, 0.5);
        }

        /* Time input special styling */
        .time-input {
            width: 70px;
            padding: 8px 10px;
            text-align: center;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            font-weight: 600;
            box-shadow: 
                0 2px 8px rgba(59, 130, 246, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        .time-input:focus {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(59, 130, 246, 0.7);
            box-shadow: 
                0 0 0 3px rgba(59, 130, 246, 0.2),
                0 4px 12px rgba(59, 130, 246, 0.25),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* Dark Mode Input Fields */
        .dark-mode input,
        .dark-mode select,
        .dark-mode textarea {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(96, 165, 250, 0.3);
            color: #f1f5f9;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode input:hover,
        .dark-mode select:hover,
        .dark-mode textarea:hover {
            background: rgba(51, 65, 85, 0.7);
            border-color: rgba(96, 165, 250, 0.5);
            box-shadow: 
                0 6px 16px rgba(96, 165, 250, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.15);
        }

        .dark-mode input:focus,
        .dark-mode select:focus,
        .dark-mode textarea:focus {
            background: rgba(51, 65, 85, 0.8);
            border-color: rgba(96, 165, 250, 0.7);
            box-shadow: 
                0 0 0 3px rgba(96, 165, 250, 0.2),
                0 8px 20px rgba(96, 165, 250, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        .dark-mode input::placeholder,
        .dark-mode textarea::placeholder {
            color: rgba(148, 163, 184, 0.5);
        }

        .dark-mode input:focus::placeholder,
        .dark-mode textarea:focus::placeholder {
            color: rgba(96, 165, 250, 0.5);
        }

        .dark-mode .time-input {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(96, 165, 250, 0.4);
            color: #60a5fa;
            box-shadow: 
                0 2px 8px rgba(96, 165, 250, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .time-input:focus {
            background: rgba(51, 65, 85, 0.8);
            border-color: rgba(96, 165, 250, 0.8);
            box-shadow: 
                0 0 0 3px rgba(96, 165, 250, 0.25),
                0 4px 12px rgba(96, 165, 250, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.15);
        }

        /* Input glow animation on focus */
        @keyframes inputGlow {
            0%, 100% {
                box-shadow: 
                    0 0 0 3px rgba(59, 130, 246, 0.15),
                    0 8px 20px rgba(59, 130, 246, 0.2),
                    inset 0 1px 1px rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow: 
                    0 0 0 5px rgba(59, 130, 246, 0.2),
                    0 12px 28px rgba(59, 130, 246, 0.3),
                    inset 0 1px 1px rgba(255, 255, 255, 0.4);
            }
        }

        input:focus,
        select:focus,
        textarea:focus {
            animation: inputGlow 2s ease-in-out infinite;
        }        


        /* --- BUTTONS GRADIENT GLOW --- */

        /* Primary Button - Add Time / Submit */
        .add-time-btn,
        button[type="submit"],
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            background-size: 200% 200%;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 12px rgba(59, 130, 246, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .add-time-btn::before,
        button[type="submit"]::before,
        .btn-primary::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .add-time-btn:hover,
        button[type="submit"]:hover,
        .btn-primary:hover {
            transform: translateY(-3px);
            background-position: 100% 50%;
            box-shadow: 
                0 8px 20px rgba(59, 130, 246, 0.4),
                0 0 30px rgba(139, 92, 246, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        .add-time-btn:hover::before,
        button[type="submit"]:hover::before,
        .btn-primary:hover::before {
            opacity: 1;
        }

        .add-time-btn:active,
        button[type="submit"]:active,
        .btn-primary:active {
            transform: translateY(-1px);
            box-shadow: 
                0 4px 12px rgba(59, 130, 246, 0.3),
                0 0 20px rgba(139, 92, 246, 0.2);
        }

        /* Export Button - Green Gradient */
        .export-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            background-size: 200% 200%;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 12px rgba(16, 185, 129, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .export-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-3px);
            background-position: 100% 50%;
            box-shadow: 
                0 8px 20px rgba(16, 185, 129, 0.4),
                0 0 30px rgba(5, 150, 105, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        .export-btn:hover::before {
            opacity: 1;
        }

        /* Import Button - Blue Gradient */
        .import-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            background-size: 200% 200%;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 12px rgba(59, 130, 246, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .import-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .import-btn:hover {
            transform: translateY(-3px);
            background-position: 100% 50%;
            box-shadow: 
                0 8px 20px rgba(59, 130, 246, 0.4),
                0 0 30px rgba(37, 99, 235, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        .import-btn:hover::before {
            opacity: 1;
        }

        /* Secondary Button - Gray Glass */
        .btn-secondary {
            background: rgba(100, 116, 139, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-dark);
            border: 1px solid rgba(100, 116, 139, 0.3);
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.05),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(100, 116, 139, 0.3);
            border-color: rgba(100, 116, 139, 0.5);
            transform: translateY(-2px);
            box-shadow: 
                0 6px 16px rgba(0, 0, 0, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* Dark Mode Toggle Button */
        .dark-mode-toggle {
            background: rgba(59, 130, 246, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #1e40af;
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 12px rgba(59, 130, 246, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .dark-mode-toggle::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(96, 165, 250, 0.4) 0%, transparent 70%);
            animation: pulseGlow 2s ease-in-out infinite;
            pointer-events: none;
        }

        .dark-mode-toggle:hover {
            transform: translateY(-3px);
            background: rgba(59, 130, 246, 0.25);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 
                0 6px 20px rgba(59, 130, 246, 0.3),
                0 0 30px rgba(59, 130, 246, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* Pulse Glow Animation */
        @keyframes pulseGlow {
            0%, 100% {
                opacity: 0.4;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }

        /* Course/Goal Action Buttons */
        .course-action-btn,
        .goal-action-btn {
            padding: 8px 14px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: var(--text-dark);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.05),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        .course-action-btn:hover,
        .goal-action-btn:hover {
            transform: translateY(-2px);
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 
                0 6px 16px rgba(59, 130, 246, 0.2),
                0 0 20px rgba(59, 130, 246, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* Delete Button - Red Gradient */
        .course-action-btn.delete,
        .goal-action-btn.delete {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
            border-color: rgba(239, 68, 68, 0.4);
            color: #dc2626;
        }

        .course-action-btn.delete:hover,
        .goal-action-btn.delete:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(220, 38, 38, 0.25));
            border-color: rgba(239, 68, 68, 0.6);
            box-shadow: 
                0 6px 16px rgba(239, 68, 68, 0.3),
                0 0 20px rgba(239, 68, 68, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        /* --- DARK MODE BUTTONS --- */
        .dark-mode .add-time-btn,
        .dark-mode button[type="submit"],
        .dark-mode .btn-primary {
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            box-shadow: 
                0 4px 12px rgba(96, 165, 250, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        .dark-mode .add-time-btn:hover,
        .dark-mode button[type="submit"]:hover,
        .dark-mode .btn-primary:hover {
            box-shadow: 
                0 8px 20px rgba(96, 165, 250, 0.5),
                0 0 30px rgba(167, 139, 250, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        .dark-mode .export-btn {
            background: linear-gradient(135deg, #34d399, #10b981);
            box-shadow: 
                0 4px 12px rgba(52, 211, 153, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        .dark-mode .export-btn:hover {
            box-shadow: 
                0 8px 20px rgba(52, 211, 153, 0.5),
                0 0 30px rgba(16, 185, 129, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        .dark-mode .import-btn {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            box-shadow: 
                0 4px 12px rgba(96, 165, 250, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        .dark-mode .import-btn:hover {
            box-shadow: 
                0 8px 20px rgba(96, 165, 250, 0.5),
                0 0 30px rgba(59, 130, 246, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        .dark-mode .btn-secondary {
            background: rgba(51, 65, 85, 0.6);
            border-color: rgba(148, 163, 184, 0.3);
            color: #f1f5f9;
        }

        .dark-mode .btn-secondary:hover {
            background: rgba(71, 85, 105, 0.7);
            border-color: rgba(148, 163, 184, 0.5);
            box-shadow: 
                0 6px 16px rgba(0, 0, 0, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.15);
        }

        .dark-mode .dark-mode-toggle {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(96, 165, 250, 0.3);
            color: #f1f5f9;
        }

        .dark-mode .dark-mode-toggle:hover {
            background: rgba(51, 65, 85, 0.8);
            border-color: rgba(96, 165, 250, 0.5);
            box-shadow: 
                0 6px 20px rgba(96, 165, 250, 0.4),
                0 0 30px rgba(96, 165, 250, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        .dark-mode .course-action-btn,
        .dark-mode .goal-action-btn {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(96, 165, 250, 0.3);
            color: #f1f5f9;
        }

        .dark-mode .course-action-btn:hover,
        .dark-mode .goal-action-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
            box-shadow: 
                0 6px 16px rgba(96, 165, 250, 0.3),
                0 0 20px rgba(96, 165, 250, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        .dark-mode .course-action-btn.delete,
        .dark-mode .goal-action-btn.delete {
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.2), rgba(239, 68, 68, 0.2));
            border-color: rgba(239, 68, 68, 0.5);
            color: #f87171;
        }

        .dark-mode .course-action-btn.delete:hover,
        .dark-mode .goal-action-btn.delete:hover {
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.3), rgba(239, 68, 68, 0.3));
            border-color: rgba(239, 68, 68, 0.7);
            box-shadow: 
                0 6px 16px rgba(239, 68, 68, 0.4),
                0 0 20px rgba(239, 68, 68, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.15);
        }    
        
        




       
        


        /* --- COURSE/GOAL CARDS GLASS EFFECT --- */

        /* Base Card Style */
        .course-item,
        .goal-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.08),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* Card Glow Overlay */
        .course-item::before,
        .goal-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(59, 130, 246, 0.05) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
            border-radius: 16px;
        }

        .course-item:hover::before,
        .goal-item:hover::before {
            opacity: 1;
        }

        /* Card Hover Effect */
        .course-item:hover,
        .goal-item:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 
                0 8px 24px rgba(59, 130, 246, 0.2),
                0 0 30px rgba(59, 130, 246, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* Card Header */
        .course-header,
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }

        .course-title,
        .goal-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-dark);
            flex: 1;
            line-height: 1.4;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Status Badges */
        .course-status-badge,
        .goal-status-badge {
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        /* Active Status */
        .course-status-badge.active,
        .goal-status-badge.active {
            background: rgba(251, 191, 36, 0.2);
            color: #92400e;
            border: 1px solid rgba(251, 191, 36, 0.4);
        }

        /* Completed Status */
        .course-status-badge.completed,
        .goal-status-badge.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #065f46;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        /* Overdue Status */
        .goal-status-badge.overdue {
            background: rgba(239, 68, 68, 0.2);
            color: #b91c1c;
            border: 1px solid rgba(239, 68, 68, 0.4);
            animation: pulseWarning 2s ease-in-out infinite;
        }

        @keyframes pulseWarning {
            0%, 100% {
                box-shadow: 
                    0 2px 8px rgba(239, 68, 68, 0.1),
                    inset 0 1px 1px rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow: 
                    0 4px 16px rgba(239, 68, 68, 0.3),
                    0 0 20px rgba(239, 68, 68, 0.2),
                    inset 0 1px 1px rgba(255, 255, 255, 0.3);
            }
        }

        /* Progress Bar Container */
        .course-progress-container,
        .goal-progress-container {
            width: 100%;
            height: 8px;
            background: rgba(226, 232, 240, 0.3);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 10px;
            overflow: hidden;
            margin: 12px 0;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Progress Fill */
        .course-progress-fill,
        .goal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            background-size: 200% 100%;
            border-radius: 10px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 0 15px rgba(59, 130, 246, 0.5),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
            animation: shimmerProgress 3s ease-in-out infinite;
            position: relative;
        }

        @keyframes shimmerProgress {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Shine Effect on Progress */
        .course-progress-fill::before,
        .goal-progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            animation: shineProgress 2s ease-in-out infinite;
        }

        @keyframes shineProgress {
            0% {
                left: -100%;
            }
            50%, 100% {
                left: 100%;
            }
        }

        /* Completed Progress */
        .course-progress-fill.completed,
        .goal-progress-fill.completed {
            background: linear-gradient(90deg, #10b981, #059669);
            box-shadow: 
                0 0 15px rgba(16, 185, 129, 0.5),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* Card Meta Information */
        .course-meta,
        .goal-meta {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin: 10px 0;
        }

        .course-difficulty,
        .course-priority,
        .course-deadline,
        .goal-type,
        .goal-deadline {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Deadline Warning Colors */
        .course-deadline.overdue,
        .goal-deadline.overdue {
            color: #dc2626;
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            font-weight: 600;
        }

        .course-deadline.soon,
        .goal-deadline.soon {
            color: #d97706;
            background: rgba(251, 191, 36, 0.15);
            border-color: rgba(251, 191, 36, 0.3);
            font-weight: 600;
        }

        /* Actions Container */
        .course-actions,
        .goal-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(59, 130, 246, 0.15);
        }

        /* Favorite Icon */
        .favorite-icon {
            font-size: 1.4rem;
            color: #f59e0b;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 2px 4px rgba(245, 158, 11, 0.3));
        }

        .favorite-icon:hover {
            color: #fbbf24;
            transform: scale(1.2) rotate(15deg);
            filter: drop-shadow(0 4px 8px rgba(245, 158, 11, 0.5));
        }

        /* Goal Forecast Box */
        .goal-forecast {
            font-size: 0.85rem;
            color: #3b82f6;
            font-style: italic;
            margin-top: 10px;
            padding: 10px 14px;
            background: rgba(59, 130, 246, 0.1);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-left: 3px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 
                0 2px 8px rgba(59, 130, 246, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        /* --- DARK MODE CARDS --- */
        .dark-mode .course-item,
        .dark-mode .goal-item {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(96, 165, 250, 0.2);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .course-item::before,
        .dark-mode .goal-item::before {
            background: radial-gradient(circle at 30% 30%, rgba(96, 165, 250, 0.08) 0%, transparent 60%);
        }

        .dark-mode .course-item:hover,
        .dark-mode .goal-item:hover {
            background: rgba(51, 65, 85, 0.7);
            border-color: rgba(96, 165, 250, 0.4);
            box-shadow: 
                0 8px 24px rgba(96, 165, 250, 0.3),
                0 0 30px rgba(96, 165, 250, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.15);
        }

        .dark-mode .course-title,
        .dark-mode .goal-title {
            color: #f1f5f9;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Dark Mode Status Badges */
        .dark-mode .course-status-badge.active,
        .dark-mode .goal-status-badge.active {
            background: rgba(251, 191, 36, 0.25);
            color: #fef3c7;
            border-color: rgba(251, 191, 36, 0.5);
        }

        .dark-mode .course-status-badge.completed,
        .dark-mode .goal-status-badge.completed {
            background: rgba(16, 185, 129, 0.25);
            color: #d1fae5;
            border-color: rgba(16, 185, 129, 0.5);
        }

        .dark-mode .goal-status-badge.overdue {
            background: rgba(239, 68, 68, 0.25);
            color: #fee2e2;
            border-color: rgba(239, 68, 68, 0.5);
        }

        /* Dark Mode Progress Bar */
        .dark-mode .course-progress-container,
        .dark-mode .goal-progress-container {
            background: rgba(51, 65, 85, 0.5);
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .dark-mode .course-progress-fill,
        .dark-mode .goal-progress-fill {
            background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6);
            box-shadow: 
                0 0 15px rgba(96, 165, 250, 0.6),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        .dark-mode .course-progress-fill.completed,
        .dark-mode .goal-progress-fill.completed {
            background: linear-gradient(90deg, #34d399, #10b981);
            box-shadow: 
                0 0 15px rgba(52, 211, 153, 0.6),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* Dark Mode Meta Tags */
        .dark-mode .course-difficulty,
        .dark-mode .course-priority,
        .dark-mode .course-deadline,
        .dark-mode .goal-type,
        .dark-mode .goal-deadline {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(96, 165, 250, 0.2);
            color: #94a3b8;
        }

        .dark-mode .course-deadline.overdue,
        .dark-mode .goal-deadline.overdue {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            color: #f87171;
        }

        .dark-mode .course-deadline.soon,
        .dark-mode .goal-deadline.soon {
            background: rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
            color: #fbbf24;
        }

        /* Dark Mode Actions Border */
        .dark-mode .course-actions,
        .dark-mode .goal-actions {
            border-top-color: rgba(96, 165, 250, 0.2);
        }

        /* Dark Mode Forecast */
        .dark-mode .goal-forecast {
            background: rgba(96, 165, 250, 0.15);
            border-left-color: #60a5fa;
            color: #60a5fa;
            box-shadow: 
                0 2px 8px rgba(96, 165, 250, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .favorite-icon {
            color: #fbbf24;
            filter: drop-shadow(0 2px 4px rgba(251, 191, 36, 0.4));
        }

        .dark-mode .favorite-icon:hover {
            color: #f59e0b;
            filter: drop-shadow(0 4px 8px rgba(251, 191, 36, 0.6));
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .course-item,
            .goal-item {
                padding: 16px;
            }
            
            .course-header,
            .goal-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .course-title,
            .goal-title {
                font-size: 1rem;
            }
            
            .course-meta,
            .goal-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            
            .course-actions,
            .goal-actions {
                gap: 6px;
            }
        }        



        /* --- SKILL ITEMS ANIMATED GLASS --- */

        /* Base Skill Item */
        .skill-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.08),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* Animated Border Gradient */
        .skill-item::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(59, 130, 246, 0.4) 50%,
                transparent 70%
            );
            background-size: 400% 400%;
            border-radius: 16px;
            z-index: -1;
            opacity: 0;
            animation: borderFlow 8s linear infinite;
            transition: opacity 0.5s ease;
        }

        @keyframes borderFlow {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Hover State - Activate Border Animation */
        .skill-item:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateX(8px) scale(1.02);
            box-shadow: 
                0 8px 24px rgba(59, 130, 246, 0.2),
                0 0 40px rgba(59, 130, 246, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        .skill-item:hover::before {
            opacity: 1;
        }

        /* Glow Effect Overlay */
        .skill-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: left 0.8s ease;
        }

        .skill-item:hover::after {
            left: 100%;
        }

        /* Career-Specific Left Border Colors */
        .skill-item[data-career="pe"] { 
            border-left: 4px solid var(--pe-color);
        }
        .skill-item[data-career="ib"] { 
            border-left: 4px solid var(--ib-color);
        }
        .skill-item[data-career="hf"] { 
            border-left: 4px solid var(--hf-color);
        }
        .skill-item[data-career="sc"] { 
            border-left: 4px solid var(--sc-color);
        }
        .skill-item[data-career="fintech"] { 
            border-left: 4px solid var(--fintech-color);
        }
        .skill-item[data-career="english"] { 
            border-left: 4px solid var(--english-color);
        }
        .skill-item[data-career="chinese"] { 
            border-left: 4px solid var(--chinese-color);
        }
        .skill-item[data-career="tools"] { 
            border-left: 4px solid var(--tools-color);
        }
        .skill-item[data-career="cfa1"] { 
            border-left: 4px solid var(--cfa1-color);
        }

        /* Career-Specific Hover Border Glow */
        .skill-item[data-career="pe"]:hover::before {
            background: linear-gradient(45deg, transparent 30%, rgba(231, 76, 60, 0.5) 50%, transparent 70%);
            background-size: 400% 400%;
        }

        .skill-item[data-career="ib"]:hover::before {
            background: linear-gradient(45deg, transparent 30%, rgba(52, 152, 219, 0.5) 50%, transparent 70%);
            background-size: 400% 400%;
        }

        .skill-item[data-career="hf"]:hover::before {
            background: linear-gradient(45deg, transparent 30%, rgba(243, 156, 18, 0.5) 50%, transparent 70%);
            background-size: 400% 400%;
        }

        .skill-item[data-career="sc"]:hover::before {
            background: linear-gradient(45deg, transparent 30%, rgba(46, 204, 113, 0.5) 50%, transparent 70%);
            background-size: 400% 400%;
        }

        .skill-item[data-career="fintech"]:hover::before {
            background: linear-gradient(45deg, transparent 30%, rgba(0, 255, 239, 0.5) 50%, transparent 70%);
            background-size: 400% 400%;
        }

        .skill-item[data-career="english"]:hover::before {
            background: linear-gradient(45deg, transparent 30%, rgba(251, 232, 44, 0.5) 50%, transparent 70%);
            background-size: 400% 400%;
        }

        .skill-item[data-career="chinese"]:hover::before {
            background: linear-gradient(45deg, transparent 30%, rgba(0, 255, 210, 0.5) 50%, transparent 70%);
            background-size: 400% 400%;
        }

        .skill-item[data-career="tools"]:hover::before {
            background: linear-gradient(45deg, transparent 30%, rgba(255, 18, 101, 0.5) 50%, transparent 70%);
            background-size: 400% 400%;
        }

        .skill-item[data-career="cfa1"]:hover::before {
            background: linear-gradient(45deg, transparent 30%, rgba(0, 255, 130, 0.5) 50%, transparent 70%);
            background-size: 400% 400%;
        }

        /* Skill Name */
        .skill-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: color 0.3s ease;
        }

        .skill-item:hover .skill-name {
            color: #3b82f6;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }

        /* Skill Progress Container */
        .skill-progress-container {
            width: 120px;
            height: 10px;
            background: rgba(226, 232, 240, 0.3);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        /* Progress Fill with Shine */
        .skill-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 5px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 0 10px rgba(16, 185, 129, 0.5),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
            position: relative;
        }

        /* Shine Animation on Progress */
        .skill-progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: progressShine 2s ease-in-out infinite;
        }

        @keyframes progressShine {
            0% {
                left: -100%;
            }
            50%, 100% {
                left: 100%;
            }
        }

        /* Skill Completed State */
        .skill-item.skill-done {
            opacity: 0.75;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(5, 150, 105, 0.08));
            border-left-color: #10b981;
        }

        .skill-item.skill-done:hover {
            opacity: 0.9;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.12));
        }

        .skill-item.skill-done::before {
            background: linear-gradient(45deg, transparent 30%, rgba(16, 185, 129, 0.4) 50%, transparent 70%);
            background-size: 400% 400%;
        }

        .skill-item.skill-done .skill-progress-fill {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        /* --- DARK MODE SKILL ITEMS --- */
        .dark-mode .skill-item {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(96, 165, 250, 0.2);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .skill-item::before {
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(96, 165, 250, 0.5) 50%,
                transparent 70%
            );
            background-size: 400% 400%;
        }

        .dark-mode .skill-item:hover {
            background: rgba(51, 65, 85, 0.7);
            border-color: rgba(96, 165, 250, 0.4);
            box-shadow: 
                0 8px 24px rgba(96, 165, 250, 0.3),
                0 0 40px rgba(96, 165, 250, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.15);
        }

        .dark-mode .skill-name {
            color: #f1f5f9;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .dark-mode .skill-item:hover .skill-name {
            color: #60a5fa;
            text-shadow: 0 0 10px rgba(96, 165, 250, 0.4);
        }

        .dark-mode .skill-progress-container {
            background: rgba(51, 65, 85, 0.5);
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .dark-mode .skill-progress-fill {
            background: linear-gradient(90deg, #34d399, #10b981);
            box-shadow: 
                0 0 10px rgba(52, 211, 153, 0.6),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        .dark-mode .skill-item.skill-done {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.12));
        }

        .dark-mode .skill-item.skill-done:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.18), rgba(5, 150, 105, 0.18));
        }

        /* Pulse Animation for High Priority Skills */
        @keyframes skillPulse {
            0%, 100% {
                box-shadow: 
                    0 4px 16px rgba(0, 0, 0, 0.08),
                    inset 0 1px 1px rgba(255, 255, 255, 0.2);
            }
            50% {
                box-shadow: 
                    0 8px 24px rgba(59, 130, 246, 0.15),
                    0 0 30px rgba(59, 130, 246, 0.1),
                    inset 0 1px 1px rgba(255, 255, 255, 0.25);
            }
        }

        /* Apply pulse to skills with importance >= 4 */
        .skill-item[data-importance="4"],
        .skill-item[data-importance="5"] {
            animation: skillPulse 3s ease-in-out infinite;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .skill-item {
                padding: 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .skill-item:hover {
                transform: translateX(4px) scale(1.01);
            }
            
            .skill-progress-container {
                width: 100%;
            }
        }




        /* --- QUOTE CARD FIXED BOTTOM LEFT (OPTIMIZED) --- */

        #quoteCard {
            position: fixed;
            bottom: 80px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 20px;
            padding: 16px 20px;
            max-width: 320px;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.12),
                0 0 60px rgba(59, 130, 246, 0.08),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
            animation: floatingQuote 6s ease-in-out infinite;
            overflow: hidden;
        }

        /* Floating Animation */
        @keyframes floatingQuote {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-8px) rotate(0.5deg); }
            50% { transform: translateY(-4px) rotate(-0.5deg); }
            75% { transform: translateY(-10px) rotate(0.3deg); }
        }

        /* Animated Border Gradient */
        #quoteCard::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(
                135deg,
                rgba(59, 130, 246, 0.5),
                rgba(139, 92, 246, 0.5),
                rgba(236, 72, 153, 0.5),
                rgba(251, 191, 36, 0.5)
            );
            background-size: 400% 400%;
            border-radius: 20px;
            z-index: -1;
            opacity: 0;
            animation: borderGradientFlow 8s ease infinite;
            transition: opacity 0.4s ease;
        }

        @keyframes borderGradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Quote Icon with Pulse */
        .quote-icon {
            font-size: 1.2rem;
            color: #f59e0b;
            margin-bottom: 10px;
            display: inline-block;
            filter: drop-shadow(0 4px 8px rgba(245, 158, 11, 0.4));
            animation: iconPulse 2s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 4px 8px rgba(245, 158, 11, 0.4));
            }
            50% {
                transform: scale(1.15);
                filter: drop-shadow(0 6px 12px rgba(245, 158, 11, 0.6));
            }
        }

        #quoteCard:hover .quote-icon {
            animation: iconSpin 0.6s ease-in-out forwards;
            color: #fbbf24;
        }

        @keyframes iconSpin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        /* Quote Text */
        #quoteText {
            font-style: italic;
            font-size: 0.9rem;
            color: var(--text-dark);
            margin-bottom: 8px;
            line-height: 1.5;
            font-weight: 500;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            letter-spacing: 0.3px;
            transition: color 0.3s ease;
        }

        /* Quote Author */
        #quoteAuthor {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: right;
            font-weight: 600;
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        /* Hover Effects */
        #quoteCard:hover {
            transform: translateY(-12px) scale(1.03) rotate(1deg);
            box-shadow:
                0 16px 48px rgba(59, 130, 246, 0.25),
                0 0 80px rgba(139, 92, 246, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.4);
            border-color: rgba(59, 130, 246, 0.5);
            animation-play-state: paused;
        }

        #quoteCard:hover::before {
            opacity: 1;
        }

        #quoteCard:hover #quoteText {
            background: linear-gradient(
                90deg,
                #3b82f6 0%,
                #8b5cf6 25%,
                #ec4899 50%,
                #8b5cf6 75%,
                #3b82f6 100%
            );
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: textShimmer 3s linear infinite;
            text-shadow: none;
        }

        #quoteCard:hover #quoteAuthor {
            opacity: 1;
            color: #8b5cf6;
            transform: translateX(5px);
        }

        @keyframes textShimmer {
            0% { background-position: -500%; }
            100% { background-position: 500%; }
        }

        /* Click Ripple Effect */
        #quoteCard .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.4);
            transform: scale(0);
            animation: rippleEffect 0.6s ease-out;
            pointer-events: none;
        }

        @keyframes rippleEffect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Glow Ring */
        #quoteCard .glow-ring {
            position: absolute;
            inset: -20px;
            border: 2px solid transparent;
            border-radius: 25px;
            background: linear-gradient(45deg,
                rgba(59, 130, 246, 0.3),
                rgba(139, 92, 246, 0.3),
                rgba(236, 72, 153, 0.3)
            ) border-box;
            -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
        }

        #quoteCard:hover .glow-ring {
            animation: glowRing 4s ease-in-out infinite;
        }

        @keyframes glowRing {
            0%, 100% { opacity: 0; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        /* --- DARK MODE --- */
        .dark-mode #quoteCard {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(96, 165, 250, 0.3);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 60px rgba(96, 165, 250, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.15);
        }

        .dark-mode #quoteCard::before {
            background: linear-gradient(
                135deg,
                rgba(96, 165, 250, 0.6),
                rgba(167, 139, 250, 0.6),
                rgba(244, 114, 182, 0.6),
                rgba(251, 191, 36, 0.6)
            );
        }

        .dark-mode #quoteCard:hover {
            box-shadow:
                0 16px 48px rgba(96, 165, 250, 0.35),
                0 0 80px rgba(167, 139, 250, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
            border-color: rgba(96, 165, 250, 0.6);
        }

        .dark-mode #quoteText {
            color: #e2e8f0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .dark-mode #quoteCard:hover #quoteText {
            background: linear-gradient(
                90deg,
                #60a5fa 0%,
                #a78bfa 25%,
                #f472b6 50%,
                #a78bfa 75%,
                #60a5fa 100%
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dark-mode #quoteAuthor {
            color: #94a3b8;
        }

        .dark-mode #quoteCard:hover #quoteAuthor {
            color: #a78bfa;
        }

        .dark-mode .quote-icon {
            color: #fbbf24;
            filter: drop-shadow(0 4px 8px rgba(251, 191, 36, 0.5));
        }

        .dark-mode #quoteCard:hover .quote-icon {
            color: #f59e0b;
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            #quoteCard {
                max-width: calc(100vw - 40px);
                left: 20px;
                right: 20px;
                bottom: 20px;
                padding: 14px 18px;
            }
            #quoteText { font-size: 0.85rem; line-height: 1.4; }
            #quoteAuthor { font-size: 0.75rem; }
        }

        @media (max-width: 480px) {
            #quoteCard {
                max-width: calc(100vw - 20px);
                left: 10px;
                right: 10px;
                padding: 12px 16px;
            }
            .quote-icon { font-size: 1.1rem; }
        }

        /* --- TOUCH DEVICES --- */
        @media (hover: none) and (pointer: coarse) {
            #quoteCard {
                animation-duration: 8s;
            }
            #quoteCard:active {
                transform: translateY(-8px) scale(1.02);
            }
        }

        /* --- REDUCED MOTION ACCESSIBILITY --- */
        @media (prefers-reduced-motion: reduce) {
            #quoteCard,
            .quote-icon,
            #quoteCard::before,
            #quoteCard .glow-ring {
                animation: none !important;
            }
            #quoteCard {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
        }



        /* ====== NEW: Unified Finance Card for Deals & Analyses ====== */
        .finance-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.08),
                inset 0 1px 1px rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .finance-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(59, 130, 246, 0.05) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
            border-radius: 16px;
        }

        .finance-card:hover::before {
            opacity: 1;
        }

        .finance-card:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 
                0 8px 24px rgba(59, 130, 246, 0.2),
                0 0 30px rgba(59, 130, 246, 0.1),
                inset 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* Dark Mode for Finance Cards */
        .dark-mode .finance-card {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(96, 165, 250, 0.2);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.3),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .finance-card::before {
            background: radial-gradient(circle at 30% 30%, rgba(96, 165, 250, 0.08) 0%, transparent 60%);
        }

        .dark-mode .finance-card:hover {
            background: rgba(51, 65, 85, 0.7);
            border-color: rgba(96, 165, 250, 0.4);
            box-shadow: 
                0 8px 24px rgba(96, 165, 250, 0.3),
                0 0 30px rgba(96, 165, 250, 0.15),
                inset 0 1px 1px rgba(255, 255, 255, 0.15);
        }

        /* Card Header: Title and Meta */
        .finance-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }

        .finance-card-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-dark);
            flex: 1;
            line-height: 1.4;
        }

        .dark-mode .finance-card-title {
            color: #f1f5f9;
        }

        /* Card Content */
        .finance-card-content {
            margin: 12px 0;
        }

        .finance-card-thesis, .finance-card-learnings {
            font-style: italic;
            line-height: 1.5;
            margin: 8px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.08);
        }

        .dark-mode .finance-card-thesis, .dark-mode .finance-card-learnings {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Key Metrics Grid */
        .finance-card-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 12px 0;
            padding: 12px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
        }

        .dark-mode .finance-card-metrics {
            background: rgba(255, 255, 255, 0.05);
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .dark-mode .metric-value {
            color: #f1f5f9;
        }

        /* Tags */
        .finance-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 10px 0;
        }

        .tag {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Action Buttons */
        .finance-card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(59, 130, 246, 0.15);
        }

        .dark-mode .finance-card-actions {
            border-top-color: rgba(96, 165, 250, 0.2);
        }
        /* ====== END NEW CSS ====== */




        /* === Career Category Headers (Optimized) === */
        .category-header {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            /* Responsive */
            padding: 12px 16px;
        }

        /* Icon base */
        .category-icon {
            font-size: 1.8rem;
            transition: transform 0.3s ease;
            /* Base glow (no filter) */
            text-shadow: 0 0 8px rgba(0,0,0,0.2);
        }

        /* Career-specific glow using box-shadow (more performant) */
        [data-career="pe"] .category-icon      { text-shadow: 0 0 12px var(--pe-color); }
        [data-career="ib"] .category-icon      { text-shadow: 0 0 12px var(--ib-color); }
        [data-career="hf"] .category-icon      { text-shadow: 0 0 12px var(--hf-color); }
        [data-career="sc"] .category-icon      { text-shadow: 0 0 12px var(--sc-color); }
        [data-career="fintech"] .category-icon { text-shadow: 0 0 12px var(--fintech-color); }
        [data-career="english"] .category-icon { text-shadow: 0 0 12px var(--english-color); }
        [data-career="chinese"] .category-icon { text-shadow: 0 0 12px var(--chinese-color); }
        [data-career="tools"] .category-icon  { text-shadow: 0 0 12px var(--tools-color); }
        [data-career="cfa1"] .category-icon    { text-shadow: 0 0 12px var(--cfa1-color); }

        .category-header:hover .category-icon {
            transform: scale(1.2) rotate(6deg);
        }

        /* Animated border glow on hover */
        .category-header::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(
                45deg,
                transparent,
                var(--career-glow, #3b82f6),
                transparent
            );
            background-size: 300% 300%;
            border-radius: 12px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.4s ease, background 0.4s ease;
            pointer-events: none;
        }

        .category-header:hover::before {
            opacity: 0.7;
        }

        /* Assign glow color via CSS var */
        [data-career="pe"]      { --career-glow: var(--pe-color); }
        [data-career="ib"]      { --career-glow: var(--ib-color); }
        [data-career="hf"]      { --career-glow: var(--hf-color); }
        [data-career="sc"]      { --career-glow: var(--sc-color); }
        [data-career="fintech"] { --career-glow: var(--fintech-color); }
        [data-career="english"] { --career-glow: var(--english-color); }
        [data-career="chinese"] { --career-glow: var(--chinese-color); }
        [data-career="tools"]  { --career-glow: var(--tools-color); }
        [data-career="cfa1"]    { --career-glow: var(--cfa1-color); }

        /* Mobile */
        @media (max-width: 768px) {
            .category-icon { font-size: 1.5rem; }
            .category-header { padding: 10px 14px; }
        }


        

        /* ===================================================================
        FLASHCARD SYSTEM
        ================================================================= */

        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;600;700;900&display=swap');

        /* ===== ROOT VARIABLES ===== */
        :root {
            --fc-primary: #dc2626;
            --fc-primary-hover: #b91c1c;
            --fc-primary-light: #fee2e2;
            --fc-bg: #ffffff;
            --fc-bg-secondary: #f9fafb;
            --fc-bg-tertiary: #f3f4f6;
            --fc-text: #111827;
            --fc-text-muted: #6b7280;
            --fc-border: #e5e7eb;
            --fc-shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --fc-shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --fc-shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --fc-radius: 12px;
            --fc-glass-bg: rgba(255, 255, 255, 0.8);
            --fc-glass-border: rgba(220, 38, 38, 0.1);
        }

        /* ===== DARK MODE VARIABLES ===== */
        .dark-mode {
            --fc-bg: #111827;
            --fc-bg-secondary: #1f2937;
            --fc-bg-tertiary: #374151;
            --fc-text: #f9fafb;
            --fc-text-muted: #9ca3af;
            --fc-border: #374151;
            --fc-primary-light: #7f1d1d;
            --fc-glass-bg: rgba(31, 41, 55, 0.8);
            --fc-glass-border: rgba(220, 38, 38, 0.2);
        }

        /* ===== FLASHCARD DISPLAY - MAIN CARD ===== */
        #flashcardDisplay {
            font-family: 'Noto Serif', 'Georgia', serif;
            background: var(--fc-bg);
            border: 2px solid var(--fc-border);
            border-radius: var(--fc-radius);
            padding: 48px 40px;
            margin-bottom: 20px;
            min-height: 400px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: var(--fc-shadow-sm);
        }

        #flashcardDisplay:hover {
            transform: translateY(-2px);
            box-shadow: var(--fc-shadow-md);
            border-color: var(--fc-primary);
        }

        #flashcardDisplay:active {
            transform: translateY(0);
        }

        /* ===== FLASHCARD TEXT STYLING ===== */
        #flashcardQuestion, 
        #flashcardAnswer {
            font-family: 'Noto Serif', 'Georgia', serif;
            font-size: 1.25rem;
            font-weight: 400;
            color: var(--fc-text);
            line-height: 1.85;
            letter-spacing: -0.01em;
        }

        #flashcardQuestion {
            font-weight: 600;
            font-size: 1.5rem;
        }

        #flashcardAnswer {
            max-height: 480px;
            overflow-y: auto;
            padding-right: 12px;
        }

        /* ===== TEXT FORMATTING ===== */
        #flashcardAnswer strong,
        #flashcardAnswer b,
        #flashcardQuestion strong,
        #flashcardQuestion b {
            font-weight: 900;
            color: var(--fc-primary);
        }

        #flashcardAnswer em,
        #flashcardAnswer i,
        #flashcardQuestion em,
        #flashcardQuestion i {
            font-style: italic;
            color: var(--fc-text);
            font-weight: 400;
        }

        #flashcardAnswer p,
        #flashcardQuestion p {
            margin-bottom: 16px;
            line-height: 1.85;
        }

        #flashcardAnswer ul,
        #flashcardAnswer ol {
            margin: 16px 0;
            padding-left: 28px;
        }

        #flashcardAnswer li {
            margin-bottom: 12px;
            line-height: 1.85;
        }

        #flashcardAnswer code {
            background: var(--fc-bg-tertiary);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 0.9em;
            color: var(--fc-primary);
            border: 1px solid var(--fc-border);
        }

        #flashcardAnswer blockquote {
            margin: 20px 0;
            padding: 15px 20px;
            border-left: 4px solid var(--fc-primary);
            background: var(--fc-bg-secondary);
            font-style: italic;
            color: var(--fc-text-muted);
        }

        #flashcardAnswer h3,
        #flashcardAnswer h2 {
            color: var(--fc-primary);
            margin-top: 24px;
            margin-bottom: 12px;
        }

        /* ===== FLASHCARD IMAGE ===== */
        #flashcardImage {
            max-width: 100%;
            max-height: 320px;
            border-radius: var(--fc-radius);
            margin-bottom: 24px;
            box-shadow: var(--fc-shadow-sm);
            object-fit: contain;
            border: 1px solid var(--fc-border);
        }

        /* ===== FLIP INDICATOR ===== */
        .flip-indicator {
            position: absolute;
            bottom: 24px;
            right: 24px;
            font-size: 0.875rem;
            color: var(--fc-text);
            background: var(--fc-glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--fc-glass-border);
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 10;
            transition: all 0.3s ease;
        }

        #flashcardDisplay:hover .flip-indicator {
            border-color: var(--fc-primary);
            background: var(--fc-primary-light);
            color: var(--fc-primary);
        }

        /* ===== CONTROL BUTTONS ===== */
        .flashcard-btn {
            padding: 14px 24px;
            border: 2px solid var(--fc-border);
            border-radius: var(--fc-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--fc-bg);
            color: var(--fc-text);
            box-shadow: var(--fc-shadow-sm);
        }

        .flashcard-btn:hover {
            background: var(--fc-primary);
            color: white;
            border-color: var(--fc-primary);
            transform: translateY(-2px);
            box-shadow: var(--fc-shadow-md);
        }

        .flashcard-btn:active {
            transform: translateY(0);
        }

        .flashcard-btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            padding: 14px;
        }

        /* ===== ANKI BUTTON ===== */
        .anki-glass-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 24px;
            background: var(--fc-glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--fc-glass-border);
            border-radius: var(--fc-radius);
            text-decoration: none;
            color: var(--fc-text);
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--fc-shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .anki-glass-btn:hover {
            background: var(--fc-primary);
            color: white;
            border-color: var(--fc-primary);
            transform: translateY(-2px);
            box-shadow: var(--fc-shadow-md);
        }

        .anki-content {
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1;
        }

        .anki-icon-glass {
            font-size: 1.3rem;
        }

        .anki-text-glass {
            font-size: 1rem;
        }

        .anki-badge {
            padding: 4px 10px;
            background: var(--fc-primary);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .anki-glass-btn:hover .anki-badge {
            background: white;
            color: var(--fc-primary);
        }

        /* ===== STATS ===== */
        .flashcard-stats {
            text-align: center;
            font-size: 0.95rem;
            color: var(--fc-text);
            padding: 16px;
            background: var(--fc-bg-secondary);
            border: 2px solid var(--fc-border);
            border-radius: var(--fc-radius);
            margin-bottom: 16px;
            font-weight: 600;
        }

        .flashcard-stats strong {
            color: var(--fc-primary);
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* ===== MODAL ===== */
        .flashcard-modal-content {
            background: var(--fc-bg);
            border-radius: var(--fc-radius);
            padding: 40px;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--fc-shadow-lg);
            border: 2px solid var(--fc-border);
        }

        .flashcard-modal-close {
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: var(--fc-text-muted);
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .flashcard-modal-close:hover {
            color: var(--fc-primary);
            background: var(--fc-primary-light);
        }

        /* ===== TEXTAREA ===== */
        .flashcard-textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--fc-border);
            border-radius: var(--fc-radius);
            background: var(--fc-bg);
            color: var(--fc-text);
            resize: vertical;
            font-family: 'Noto Serif', 'Georgia', serif;
            font-size: 0.95rem;
            line-height: 1.7;
            transition: all 0.3s ease;
            min-height: 120px;
        }

        .flashcard-textarea:focus {
            outline: none;
            border-color: var(--fc-primary);
            box-shadow: 0 0 0 3px var(--fc-primary-light);
        }

        /* ===== MANAGE FLASHCARDS ===== */
        .manage-flashcard-item {
            background: var(--fc-bg-secondary);
            padding: 24px;
            border-radius: var(--fc-radius);
            margin-bottom: 16px;
            border-left: 4px solid var(--fc-primary);
            transition: all 0.3s ease;
            box-shadow: var(--fc-shadow-sm);
        }

        .manage-flashcard-item:hover {
            transform: translateX(4px);
            box-shadow: var(--fc-shadow-md);
        }

        .manage-flashcard-question {
            font-weight: 700;
            color: var(--fc-text);
            margin-bottom: 10px;
            font-size: 1.05rem;
        }

        .manage-flashcard-date {
            font-size: 0.85rem;
            color: var(--fc-text-muted);
            margin-bottom: 14px;
        }

        .manage-flashcard-answer-preview {
            margin-top: 12px;
            padding: 16px;
            background: var(--fc-bg);
            border-radius: 8px;
            font-size: 0.92rem;
            line-height: 1.8;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--fc-border);
        }

        .manage-flashcard-buttons {
            display: flex;
            gap: 8px;
        }

        .manage-flashcard-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .manage-flashcard-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: var(--fc-shadow-md);
        }

        /* ===== EMPTY STATE ===== */
        .flashcard-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--fc-text-muted);
        }

        .flashcard-empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .flashcard-empty-state-text {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* ===== SCROLLBAR ===== */
        #flashcardAnswer::-webkit-scrollbar,
        .flashcard-modal-content::-webkit-scrollbar,
        .manage-flashcard-answer-preview::-webkit-scrollbar,
        .fullscreen-flashcard-content::-webkit-scrollbar {
            width: 10px;
        }

        #flashcardAnswer::-webkit-scrollbar-track,
        .flashcard-modal-content::-webkit-scrollbar-track,
        .manage-flashcard-answer-preview::-webkit-scrollbar-track,
        .fullscreen-flashcard-content::-webkit-scrollbar-track {
            background: transparent;
        }

        #flashcardAnswer::-webkit-scrollbar-thumb,
        .flashcard-modal-content::-webkit-scrollbar-thumb,
        .manage-flashcard-answer-preview::-webkit-scrollbar-thumb,
        .fullscreen-flashcard-content::-webkit-scrollbar-thumb {
            background: var(--fc-border);
            border-radius: 5px;
        }

        #flashcardAnswer::-webkit-scrollbar-thumb:hover,
        .flashcard-modal-content::-webkit-scrollbar-thumb:hover,
        .manage-flashcard-answer-preview::-webkit-scrollbar-thumb:hover,
        .fullscreen-flashcard-content::-webkit-scrollbar-thumb:hover {
            background: var(--fc-primary);
        }

        /* ===== FORMATTING GUIDE ===== */
        .formatting-guide {
            background: var(--fc-bg-secondary);
            border-left: 4px solid var(--fc-primary);
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .formatting-guide summary {
            cursor: pointer;
            font-weight: 700;
            color: var(--fc-primary);
            padding: 8px 0;
            list-style: none;
        }

        .formatting-guide-content {
            margin-top: 16px;
            font-size: 0.9rem;
            color: var(--fc-text);
            line-height: 1.8;
        }

        /* ===== EXPAND BUTTON ===== */
        .flashcard-expand-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--fc-glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--fc-text);
            border: 1px solid var(--fc-glass-border);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .flashcard-expand-btn:hover {
            background: var(--fc-primary);
            border-color: var(--fc-primary);
            color: white;
        }

        /* ===================================================================
        FULLSCREEN MODE - OPTIMIZED
        ================================================================= */

        #fullscreenFlashcardModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10002;
            overflow: hidden;
        }

        .fullscreen-flashcard-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 12px;
            overflow: hidden;
        }

        .fullscreen-flashcard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--fc-glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--fc-glass-border);
            border-radius: var(--fc-radius);
            flex-shrink: 0;
            min-height: 50px;
        }

        .fullscreen-flashcard-title {
            color: var(--fc-text);
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fullscreen-flashcard-info {
            display: flex;
            gap: 16px;
            color: var(--fc-text);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .fullscreen-close-btn {
            background: transparent;
            color: var(--fc-text);
            border: 2px solid var(--fc-border);
            padding: 8px 16px;
            border-radius: var(--fc-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fullscreen-close-btn:hover {
            background: var(--fc-primary);
            border-color: var(--fc-primary);
            color: white;
        }

        .fullscreen-flashcard-display {
            font-family: 'Noto Serif', 'Georgia', serif;
            flex: 1;
            background: var(--fc-bg);
            border: 2px solid var(--fc-border);
            border-radius: var(--fc-radius);
            padding: 20px 30px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: var(--fc-shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
            width: 100%;
            height: 100%;
        }

        .fullscreen-flashcard-content {
            width: 100%;
            max-width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 10px;
            margin: 0;
        }



        #fullscreenFlashcardFront {
            width: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }


        #fullscreenFlashcardBack {
            width: 100%;
            text-align: left;
            padding: 20px;
        }

        .fullscreen-front-visible {
            display: flex !important;
        }

        .fullscreen-front-hidden {
            display: none !important;
        }

        .fullscreen-back-visible {
            display: block !important;
        }

        .fullscreen-back-hidden {
            display: none !important;
        }

        .fullscreen-flashcard-question {
            font-family: 'Noto Serif', 'Georgia', serif;
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--fc-text);
            line-height: 1.8;
            width: 100%;
            text-align: center;
            margin-bottom: 24px;
            max-width: 100%;
            padding: 0 5px;
        }

        .fullscreen-flashcard-answer {
            font-family: 'Noto Serif', 'Georgia', serif;
            font-size: 1.3rem;
            font-weight: 400;
            color: var(--fc-text);
            line-height: 1.8;
            width: 100%;
            text-align: left;
            max-width: 100%;
            padding: 0 5px;
            margin: 0;
            display: block;
        }

        .fullscreen-flashcard-answer strong,
        .fullscreen-flashcard-question strong,
        .fullscreen-flashcard-answer b,
        .fullscreen-flashcard-question b {
            font-weight: 900;
            color: var(--fc-primary);
        }

        .fullscreen-flashcard-answer h2,
        .fullscreen-flashcard-answer h3 {
            color: var(--fc-primary);
            margin-top: 24px;
            margin-bottom: 12px;
            font-size: 1.4rem;
        }

        .fullscreen-flashcard-answer p {
            margin-bottom: 14px;
        }

        .fullscreen-flashcard-answer ul,
        .fullscreen-flashcard-answer ol {
            margin: 14px 0;
            padding-left: 28px;
        }

        .fullscreen-flashcard-answer li {
            margin-bottom: 10px;
        }

        .fullscreen-flashcard-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: var(--fc-radius);
            margin-bottom: 24px;
            object-fit: contain;
            border: 1px solid var(--fc-border);
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .fullscreen-flashcard-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            background: var(--fc-glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--fc-glass-border);
            border-radius: var(--fc-radius);
            flex-shrink: 0;
            flex-wrap: wrap;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .fullscreen-flashcard-stats {
            display: none;
        }

        .fullscreen-stat-inline {
            display: flex;
            align-items: center;
            gap: 20px;
            color: var(--fc-text-muted);
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0 12px;
        }

        .fullscreen-stat-inline span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fullscreen-stat-inline strong {
            color: var(--fc-primary);
            font-size: 1rem;
        }

        .fullscreen-shortcuts-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--fc-text-muted);
            font-size: 0.75rem;
            padding: 0 12px;
            border-left: 1px solid var(--fc-border);
        }

        .fullscreen-shortcuts-inline kbd {
            padding: 3px 6px;
            background: var(--fc-bg-tertiary);
            border: 1px solid var(--fc-border);
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--fc-text);
            font-weight: 600;
        }

        .flashcard-btn-secondary {
            background: var(--fc-bg-secondary);
            color: var(--fc-text);
            border-color: var(--fc-border);
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        .flashcard-btn-secondary:hover {
            background: var(--fc-bg-tertiary);
            color: var(--fc-text);
            border-color: var(--fc-text-muted);
        }

        .flashcard-btn-success {
            background: var(--fc-bg);
            color: var(--fc-primary);
            border-color: var(--fc-primary);
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        .flashcard-btn-success:hover {
            background: var(--fc-primary);
            color: white;
            border-color: var(--fc-primary);
        }

        .flashcard-btn-primary {
            background: var(--fc-primary);
            color: white;
            border-color: var(--fc-primary);
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        .flashcard-btn-primary:hover {
            background: var(--fc-primary-hover);
            border-color: var(--fc-primary-hover);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            #flashcardDisplay {
                padding: 36px 28px;
                min-height: 350px;
            }
            
            #flashcardQuestion {
                font-size: 1.25rem;
            }
            
            #flashcardAnswer {
                font-size: 1.1rem;
            }
            
            .flashcard-btn {
                padding: 12px 20px;
                font-size: 0.95rem;
            }
            
            .fullscreen-flashcard-container {
                padding: 12px;
                gap: 10px;
            }
            
            .fullscreen-flashcard-display {
                padding: 15px;
            }
            
            .fullscreen-flashcard-question {
                font-size: 1.3rem;
            }
            
            .fullscreen-flashcard-answer {
                font-size: 1.1rem;
            }
            
            .fullscreen-flashcard-controls {
                flex-wrap: wrap;
                gap: 8px;
                padding: 10px 16px;
            }
            
            .flashcard-modal-content {
                padding: 24px;
            }
        }

        .fullscreen-flashcard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--fc-glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--fc-glass-border);
            border-radius: var(--fc-radius);
            flex-shrink: 0;
            min-height: 50px;
        }

        .fullscreen-flashcard-info {
            display: flex;
            gap: 20px;
            color: var(--fc-text);
            font-weight: 600;
            font-size: 0.95rem;
            align-items: center;
        }

        .fullscreen-flashcard-info span {
            padding: 4px 10px;
            background: var(--fc-bg-secondary);
            border-radius: 6px;
            border: 1px solid var(--fc-border);
        }


        /* Resource Dashboard Styles */
        .resource-dashboard {
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 15px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .dashboard-stats {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stat-box {
            transition: all 0.2s ease;
        }

        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        #typeDistribution > div {
            transition: all 0.2s ease;
        }

        #typeDistribution > div:hover {
            transform: scale(1.05);
        }







        /* ===== RESOURCE STATUS BUTTONS - MINIMAL ICON STYLE ===== */
        .resource-buttons-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(59, 130, 246, 0.1);
        }

        .resource-status-btn {
            width: 100%;
            height: 40px;
            padding: 0;
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-muted);
            position: relative;
            overflow: hidden;
        }

        .resource-status-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.4);
            color: var(--text-dark);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .resource-status-btn:active {
            transform: translateY(0);
        }

        /* Tooltip */
        .resource-status-btn::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: var(--text-dark);
            color: white;
            font-size: 0.7rem;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }

        .resource-status-btn:hover::after {
            opacity: 1;
            margin-bottom: 5px;
        }

        /* ===== SPECIFIC BUTTON STYLES ===== */
        /* Start Reading - Blue */
        .resource-status-btn:nth-child(1):not(.open-link):not(.edit):not(.delete) {
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.3);
        }

        .resource-status-btn:nth-child(1):not(.open-link):not(.edit):not(.delete):hover {
            background: rgba(59, 130, 246, 0.15);
            color: #2563eb;
        }

        /* Mark Complete - Green */
        .resource-status-btn:nth-child(1):has-content("â"),
        .resource-status-btn[title="Mark Complete"] {
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .resource-status-btn:nth-child(1):has-content("â"):hover,
        .resource-status-btn[title="Mark Complete"]:hover {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
        }

        /* Update Progress - Orange */
        .resource-status-btn:nth-child(2):has-content("ð"),
        .resource-status-btn[title="Update Progress"] {
            color: #f59e0b;
            border-color: rgba(245, 158, 11, 0.3);
        }

        .resource-status-btn:nth-child(2):has-content("ð"):hover,
        .resource-status-btn[title="Update Progress"]:hover {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        /* Re-open - Purple */
        .resource-status-btn:nth-child(1):has-content("ð"),
        .resource-status-btn[title="Re-open"] {
            color: #8b5cf6;
            border-color: rgba(139, 92, 246, 0.3);
        }

        .resource-status-btn:nth-child(1):has-content("ð"):hover,
        .resource-status-btn[title="Re-open"]:hover {
            background: rgba(139, 92, 246, 0.15);
            color: #7c3aed;
        }

        /* Edit - Gray */
        .resource-status-btn.edit,
        .resource-status-btn[title="Edit"] {
            color: #6b7280;
            border-color: rgba(107, 114, 128, 0.3);
        }

        .resource-status-btn.edit:hover,
        .resource-status-btn[title="Edit"]:hover {
            background: rgba(107, 114, 128, 0.15);
            color: #4b5563;
        }

        /* Delete - Red */
        .resource-status-btn.delete,
        .resource-status-btn[title="Delete"] {
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .resource-status-btn.delete:hover,
        .resource-status-btn[title="Delete"]:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        /* Open Link - Teal */
        .resource-status-btn.open-link {
            color: #06b6d4;
            border-color: rgba(6, 182, 212, 0.3);
        }

        .resource-status-btn.open-link:hover {
            background: rgba(6, 182, 212, 0.15);
            color: #0891b2;
        }

        /* ===== DARK MODE ===== */
        .dark-mode .resource-buttons-grid {
            border-top-color: rgba(96, 165, 250, 0.1);
        }

        .dark-mode .resource-status-btn {
            background: rgba(30, 41, 59, 0.3);
            border-color: rgba(96, 165, 250, 0.15);
            color: #94a3b8;
        }

        .dark-mode .resource-status-btn:hover {
            background: rgba(96, 165, 250, 0.1);
            border-color: rgba(96, 165, 250, 0.3);
            color: #f1f5f9;
        }

        /* Dark mode tooltip */
        .dark-mode .resource-status-btn::after {
            background: #1e293b;
            color: #f1f5f9;
            border: 1px solid #334155;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .resource-buttons-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
            }
            
            .resource-status-btn {
                height: 36px;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .resource-buttons-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .resource-status-btn {
                height: 40px;
                font-size: 1.1rem;
            }
        }

        /* ===== ICON ANIMATIONS ===== */
        .resource-status-btn:hover {
            position: relative;
        }

        .resource-status-btn:nth-child(1):has-content("ð"):hover {
            animation: bookFlip 0.6s ease;
        }

        .resource-status-btn:nth-child(1):has-content("â"):hover {
            animation: checkPop 0.6s ease;
        }

        .resource-status-btn:nth-child(2):has-content("ð"):hover {
            animation: pencilShake 0.6s ease;
        }

        .resource-status-btn:nth-child(1):has-content("ð"):hover {
            animation: rotateLoop 0.8s linear infinite;
        }

        @keyframes bookFlip {
            0% { transform: rotateY(0) translateY(-1px); }
            50% { transform: rotateY(180deg) translateY(-1px); }
            100% { transform: rotateY(360deg) translateY(-1px); }
        }

        @keyframes checkPop {
            0%, 100% { transform: scale(1) translateY(-1px); }
            50% { transform: scale(1.3) translateY(-1px); }
        }

        @keyframes pencilShake {
            0%, 100% { transform: rotate(0deg) translateY(-1px); }
            25% { transform: rotate(15deg) translateY(-1px); }
            75% { transform: rotate(-15deg) translateY(-1px); }
        }

        @keyframes rotateLoop {
            from { transform: rotate(0deg) translateY(-1px); }
            to { transform: rotate(360deg) translateY(-1px); }
        }

        /* ===== RESOURCE CARD COLLAPSIBLE STYLES ===== */
        .resource-card-collapsible {
            max-height: 200px;
            overflow: hidden;
            position: relative;
            transition: max-height 0.3s ease;
        }

        .resource-card-collapsible.expanded {
            max-height: none;
        }

        .resource-card-fade {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to bottom, transparent, var(--bg-white));
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .resource-card-collapsible.expanded .resource-card-fade {
            opacity: 0;
        }

        .resource-expand-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 8px;
            margin-top: 8px;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-dark);
            transition: all 0.2s ease;
        }

        .resource-expand-btn:hover {
            background: var(--bg-white);
            border-color: var(--primary);
            color: var(--primary);
        }

        .finance-card-thesis {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-dark);
            font-style: normal; 
        }

        .finance-card-thesis strong {
            color: var(--text-dark);
            font-weight: 600;
        }

        .finance-card-thesis em {
            color: var(--text-dark);
            font-style: normal; 
            font-weight: 500;
        }


        .dark-mode .resource-card-fade {
            background: linear-gradient(to bottom, transparent, var(--bg-card));
        }

        /* ===== TAG IMPROVEMENTS ===== */
        .finance-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
            max-height: 80px;
            overflow: hidden;
            position: relative;
            transition: max-height 0.3s ease;
        }

        .finance-card-tags.expanded {
            max-height: none;
        }

        .finance-card-tags .tag {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            white-space: nowrap;
        }

        .finance-card-tags .tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-color: currentColor;
        }

        .tag-expand-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            font-size: 0.7rem;
            color: var(--text-muted);
            cursor: pointer;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 6px;
            transition: all 0.2s ease;
        }

        .tag-expand-btn:hover {
            color: var(--primary);
            border-color: var(--primary);
        }

        /* ===== TAG FILTER SECTION ===== */
        .tag-filter-section {
            margin-bottom: 15px;
            padding: 12px;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .tag-filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .tag-filter-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 120px;
            overflow-y: auto;
            padding: 4px;
        }

        .tag-cloud-item {
            padding: 6px 12px;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tag-cloud-item:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .tag-cloud-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: 600;
        }

        .tag-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .tag-cloud-item.active .tag-count {
            background: rgba(255,255,255,0.3);
        }

        .clear-tags-btn {
            padding: 4px 10px;
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .clear-tags-btn:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        /* ===== ACTIVE FILTERS DISPLAY ===== */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .active-filter-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .active-filter-chip button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            margin-left: 4px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .active-filter-chip button:hover {
            opacity: 1;
        }

        /* ===== RESOURCE CARD ===== */
        .resource-card-collapsible {
            max-height: 200px;
            overflow: hidden;
            position: relative;
            transition: max-height 0.3s ease;
        }

        .resource-card-collapsible.expanded {
            max-height: none;
        }

        .resource-card-fade {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to bottom, transparent, var(--bg-white));
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .resource-card-collapsible.expanded .resource-card-fade {
            opacity: 0;
        }

        .resource-expand-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 8px;
            margin-top: 8px;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-dark);
            transition: all 0.2s ease;
        }

        .resource-expand-btn:hover {
            background: var(--bg-white);
            border-color: var(--primary);
            color: var(--primary);
        }

        .finance-card-thesis {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-dark);
            font-style: normal;
        }

        .finance-card-thesis strong {
            color: var(--text-dark);
            font-weight: 600;
        }

        .finance-card-thesis em {
            color: var(--text-dark);
            font-style: normal;
            font-weight: 500;
        }

        .dark-mode .resource-card-fade {
            background: linear-gradient(to bottom, transparent, var(--bg-card));
        }

        .dark-mode .tag-cloud-item {
            background: var(--bg-card);
        }

        .dark-mode .tag-cloud-item:hover,
        .dark-mode .tag-cloud-item.active {
            background: var(--primary);
        }

        /* ===== END RESOURCE ===== */
  
        









.correlation-strength {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 8px;
    text-transform: uppercase;
}

.correlation-strength.strong {
    background: #10b981;
    color: white;
}

.correlation-strength.moderate {
    background: #f59e0b;
    color: white;
}

.correlation-strength.weak {
    background: #6b7280;
    color: white;
}

.no-data-message {
    text-align: center;
    color: var(--text-muted);
    padding: 20px;
    font-style: italic;
    background: var(--bg-light);
    border-radius: 8px;
    border: 1px dashed var(--border-color);
}

.insight-card {
    background: var(--bg-white);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.insight-label {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.insight-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
}

.insight-description {
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.4;
}


.no-data-message {
    text-align: center;
    padding: 30px 20px;
    color: var(--text-muted);
    background: var(--bg-light);
    border-radius: 12px;
    border: 2px dashed var(--border-color);
    font-size: 0.95rem;
    line-height: 1.5;
}

.no-data-message div:first-child {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 10px;
    font-size: 1rem;
}

.error-message {
    text-align: center;
    padding: 20px;
    color: #ef4444;
    background: #fef2f2;
    border-radius: 8px;
    border: 1px solid #fecaca;
    font-size: 0.9rem;
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    margin: 20px 0;
}

.insight-card {
    background: var(--bg-white);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: transform 0.2s;
}

.insight-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.insight-label {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 8px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.insight-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
}

.insight-description {
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.5;
}


/* ====== INSOMNIA ANALYSIS CSS ====== */
.insomnia-analysis {
    background: linear-gradient(135deg, #1a237e, #311b92);
    border-radius: 16px;
    padding: 24px;
    color: white;
    margin-bottom: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
}

.insomnia-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

.insomnia-header h3 {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 700;
    color: white;
}

.severity-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.severe {
    background: linear-gradient(135deg, #ff0000, #ff6b6b);
    color: white;
    animation: pulse 2s infinite;
}

.moderate_severe {
    background: linear-gradient(135deg, #ff9500, #ffcc00);
    color: white;
}

.moderate {
    background: linear-gradient(135deg, #f59e0b, #fbbf24);
    color: white;
}

.mild {
    background: linear-gradient(135deg, #3b82f6, #60a5fa);
    color: white;
}

.subclinical {
    background: linear-gradient(135deg, #10b981, #34d399);
    color: white;
}

.risk-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.85rem;
    animation: alert-pulse 1.5s infinite;
}

.extreme-risk {
    background: linear-gradient(135deg, #ff0000, #ff6b6b);
    color: white;
    font-weight: 800;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@keyframes alert-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.insomnia-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.insomnia-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: transform 0.3s ease, border-color 0.3s ease;
}

.insomnia-card:hover {
    transform: translateY(-4px);
    border-color: rgba(255, 255, 255, 0.4);
}

.insomnia-card h4 {
    margin: 0 0 12px 0;
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 600;
}

.insomnia-value {
    font-size: 2.2rem;
    font-weight: 800;
    margin: 12px 0;
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.insomnia-description {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.4;
    margin-top: 8px;
}

.penalty-card {
    background: linear-gradient(135deg, rgba(255, 59, 48, 0.3), rgba(255, 149, 0, 0.3));
    border-color: rgba(255, 59, 48, 0.5);
}

.efficiency-section {
    background: rgba(0, 0, 0, 0.3);
    padding: 24px;
    border-radius: 12px;
    margin: 24px 0;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.efficiency-section h4 {
    margin: 0 0 20px 0;
    color: white;
    font-size: 1.2rem;
    font-weight: 600;
}

.efficiency-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin: 20px 0;
}

.metric-item {
    text-align: center;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: background 0.3s ease;
}

.metric-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

.metric-label {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 8px;
    font-weight: 500;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
}

.metric-value.low { color: #ff6b6b; }
.metric-value.medium { color: #feca57; }
.metric-value.high { color: #1dd1a1; }
.metric-value.waste { 
    color: #ff6b6b; 
    font-weight: 800;
    text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
}

.roi-visualization {
    margin: 30px 0;
}

.roi-bar {
    height: 50px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    margin-bottom: 12px;
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.roi-effective {
    background: linear-gradient(90deg, #1dd1a1, #10ac84);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
    transition: width 1s ease;
}

.roi-wasted {
    background: linear-gradient(90deg, #ff6b6b, #ee5a52);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
    transition: width 1s ease;
}

.roi-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.8);
    margin-top: 8px;
}

.efficiency-message {
    margin: 20px 0;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    border-left: 4px solid #3b82f6;
}

.highlight {
    color: #ff6b6b;
    font-weight: bold;
    background: rgba(255, 107, 107, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
}

.brain-status {
    margin: 20px 0;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    border-left: 4px solid #f59e0b;
    font-size: 0.95rem;
    line-height: 1.5;
}

.penalty-details {
    background: rgba(255, 59, 48, 0.1);
    padding: 20px;
    border-radius: 10px;
    margin-top: 20px;
    border-left: 4px solid #ff3b30;
}

.penalty-details strong {
    display: block;
    margin-bottom: 12px;
    color: #ff6b6b;
    font-size: 1rem;
}

.penalty-details ul {
    margin: 8px 0 0 0;
    padding-left: 20px;
}

.penalty-details li {
    margin-bottom: 8px;
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.9rem;
    line-height: 1.4;
}

.penalty-score {
    color: #ff6b6b;
    font-weight: bold;
    font-size: 0.8rem;
    margin-left: 8px;
}

.insomnia-recommendations {
    margin-top: 30px;
}

.insomnia-recommendations h4 {
    margin: 0 0 20px 0;
    color: white;
    font-size: 1.2rem;
    font-weight: 600;
}

.recommendation {
    display: flex;
    gap: 16px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    margin-bottom: 16px;
    border-left: 4px solid;
    transition: transform 0.3s ease, background 0.3s ease;
}

.recommendation:hover {
    transform: translateX(8px);
    background: rgba(255, 255, 255, 0.1);
}

.recommendation.critical {
    border-left-color: #ff0000;
    background: linear-gradient(135deg, rgba(255, 0, 0, 0.1), transparent);
}

.recommendation.high {
    border-left-color: #ff9500;
    background: linear-gradient(135deg, rgba(255, 149, 0, 0.1), transparent);
}

.recommendation.medium {
    border-left-color: #3b82f6;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent);
}

.rec-icon {
    font-size: 1.8rem;
    flex-shrink: 0;
}

.rec-content {
    flex: 1;
}

.rec-content strong {
    display: block;
    margin-bottom: 8px;
    color: white;
    font-size: 1.1rem;
    font-weight: 700;
}

.rec-content p {
    margin: 0 0 12px 0;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.95rem;
    line-height: 1.5;
}

.urgency-tag {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.immediate {
    background: #ff0000;
    color: white;
    animation: blink 1s infinite;
}

.today {
    background: #ff9500;
    color: white;
}

.this_week {
    background: #007aff;
    color: white;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.emergency-notice {
    background: linear-gradient(135deg, rgba(255, 0, 0, 0.2), rgba(255, 107, 107, 0.2));
    border: 2px solid #ff3b30;
    border-radius: 12px;
    padding: 24px;
    margin-top: 30px;
    animation: pulse 3s infinite;
}

.emergency-icon {
    font-size: 3rem;
    text-align: center;
    margin-bottom: 20px;
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.emergency-content h4 {
    margin: 0 0 16px 0;
    color: #ff6b6b;
    font-size: 1.3rem;
    font-weight: 800;
}

.emergency-content p {
    margin: 0 0 16px 0;
    color: rgba(255, 255, 255, 0.9);
    line-height: 1.6;
}

.emergency-content ol {
    margin: 16px 0;
    padding-left: 24px;
    color: rgba(255, 255, 255, 0.9);
}

.emergency-content li {
    margin-bottom: 12px;
    line-height: 1.5;
}

.warning {
    color: #ff6b6b;
    font-weight: bold;
    font-size: 1.1rem;
    margin-top: 20px !important;
    padding: 12px;
    background: rgba(255, 107, 107, 0.1);
    border-radius: 8px;
    border-left: 4px solid #ff6b6b;
}

/* Dark mode adjustments */
.dark-mode .insomnia-analysis {
    background: linear-gradient(135deg, #0f172a, #1e293b);
    border-color: rgba(255, 255, 255, 0.05);
}

.dark-mode .insomnia-card {
    background: rgba(30, 41, 59, 0.5);
    border-color: rgba(255, 255, 255, 0.05);
}

.dark-mode .efficiency-section {
    background: rgba(15, 23, 42, 0.5);
}

.dark-mode .metric-item {
    background: rgba(30, 41, 59, 0.5);
}

/* Responsive */
@media (max-width: 768px) {
    .insomnia-grid {
        grid-template-columns: 1fr;
    }
    
    .efficiency-metrics {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .insomnia-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .recommendation {
        flex-direction: column;
        gap: 12px;
    }
}

@media (max-width: 480px) {
    .efficiency-metrics {
        grid-template-columns: 1fr;
    }
    
    .insomnia-analysis {
        padding: 16px;
    }
    
    .insomnia-value {
        font-size: 1.8rem;
    }
}

    </style>
</head>
<body>

    <div class="dark-mode-container">
        <button class="dark-mode-toggle" onclick="toggleDarkMode()">ð Dark Mode</button>
    </div>

    <div class="container">
        <header>
            <h1 class="animated-title">
                <span class="heart left-heart">â¤ï¸</span>
                My Tracker
                <span class="heart right-heart">â¤ï¸</span>
            </h1>            
            <p class="subtitle">Personal Growth Dashboard</p>
        </header>




        <div id="career-section">
            <div class="career-grid">
                <div class="career-card" data-career="pe" onclick="selectCareer('pe')">
                    <div class="career-icon">ð¼</div>
                    <div class="career-name">Private Equity</div>
                </div>
                <div class="career-card" data-career="ib" onclick="selectCareer('ib')">
                    <div class="career-icon">ð¦</div>
                    <div class="career-name">Investment Banking</div>
                </div>
                <div class="career-card" data-career="hf" onclick="selectCareer('hf')">
                    <div class="career-icon">ð</div>
                    <div class="career-name">Hedge Funds</div>
                </div>
                <div class="career-card" data-career="sc" onclick="selectCareer('sc')">
                    <div class="career-icon">ð¯</div>
                    <div class="career-name">Strategy Consulting</div>
                </div>               
                <div class="career-card" data-career="fintech" onclick="selectCareer('fintech')">
                    <div class="career-icon">ð³</div>
                    <div class="career-name">Fintech</div>
                </div>
                <div class="career-card" data-career="english" onclick="selectCareer('english')">
                    <div class="career-icon">ð</div>
                    <div class="career-name">English</div>
                </div>
                <div class="career-card" data-career="chinese" onclick="selectCareer('chinese')">
                    <div class="career-icon">ð</div>
                    <div class="career-name">Chinese</div>
                </div>                

                <div class="career-card" data-career="tools" onclick="selectCareer('tools')">
                    <div class="career-icon">ð ï¸</div>
                    <div class="career-name">Finance Tools</div>
                </div>

                <div class="career-card" data-career="cfa1" onclick="selectCareer('cfa1')">
                    <div class="career-icon">ð</div>
                    <div class="career-name">CFA Level 1</div>
                </div>
            </div>

            <div class="progress-overview">
                <div class="progress-header">
                    <h2 class="progress-title">
                        <span>ð¯</span> <span id="career-title">Private Equity</span> Progress
                    </h2>
                    <div class="progress-stats">
                        <span>ð</span> <span id="total-progress">0.0</span>% Complete
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="career-progress-bar" style="width: 0%"></div>
                </div>
            </div>

            <div class="main-content">
                <div class="skills-section">
                    <h2 id="currentCareerTitle">Courses</h2>
                    <div id="skillsContainer">
                        <!-- Skills will be dynamically loaded here -->
                    </div>
                </div>

                <div class="sidebar">
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">ð Your Progress</h3>
                        <div class="gamification-stats">
                            <div class="level-container">
                                <span class="level-icon"><i class="fas fa-trophy"></i></span>
                                <span class="level-text" id="levelBadge">Level 1</span>
                            </div>
                            <div class="points-container">
                                <span class="points-icon"><i class="fas fa-star"></i></span>
                                <span class="points-text" id="pointsDisplay">0 XP</span>
                            </div>
                            <div class="streak-container">
                                <span class="streak-icon"><i class="fas fa-fire"></i></span>
                                <span class="streak-text" id="streakDisplay">0 day streak</span>
                            </div>
                        </div>
                        <div class="total-hours" id="totalHours">0.0 hours</div>

                        <div style="margin: 15px 0; text-align: center; font-size: 0.95rem; color: var(--text-dark); font-weight: 600;">
                            <span id="dailyStudyInfo">Today: 0.0 hours</span> | 
                            <span id="totalStudyInfo">Total: 0.0 hours</span>
                        </div>

                        <div class="chart-container" style="height: 140px; margin: 15px 0; background: #f8fafc; border-radius: var(--radius-md);">
                            <canvas id="dailyStudyChart"></canvas>
                        </div>
                    
                        <div class="meme-widget" onclick="getRandomMeme()">
                            <div class="meme-image-container">
                                <img id="memeImage" src="" alt="Random Meme" style="width: 100%; height: auto; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); cursor: pointer;" />
                            </div>
                            <div class="meme-caption" id="memeCaption"></div>
                        </div>                        
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                        <div id="achievements">
                        </div>
                    </div>
 
                    <!-- - Goal Setting Section - -->
                    <div class="sidebar-card" id="goalsSection">
                        <h3 class="sidebar-title">
                            <span>ð¯</span>
                            <span id="goalsCareerTitle" class="career-title">Private Equity</span> Goals
                        </h3>

                        <button class="goal-add-btn" onclick="openAddGoalModal()">
                            â Add New Goal
                        </button>

                        <div class="goal-progress-summary">
                            <h4 class="goal-progress-title">ð¯ Goal Completion</h4>
                            <div class="chart-container" style="height: 120px; margin: 12px 0;">
                                <canvas id="goalProgressChart"></canvas>
                            </div>
                            <div class="goal-progress-text" id="goalProgressSummary">
                                0/0 goals completed
                            </div>
                        </div>

                        <div id="goalsContainer">
                            <p class="goal-empty-state">No goals added yet. Create one to track your progress.</p>
                        </div>
                    </div>                                      

                    <!-- - LEARNING MOOD WIDGET --->
                    <div class="sidebar-card" id="learningMoodWidget">
                        <div class="random-skill">
                            <h4><span>ð¡</span> Suggested Skill</h4>
                            <div id="learningMoodSkillText">Loading...</div>
                        </div>

                        <div class="mood-selector">
                            <h4 class="mood-title">Choose Your Focus</h4>
                            <div class="mood-buttons">
                                <button class="mood-btn" data-mood="focused">Focused</button>
                                <button class="mood-btn" data-mood="creative">Creative</button>
                                <button class="mood-btn" data-mood="analytical">Analytical</button>
                                <button class="mood-btn" data-mood="random">Random</button>
                            </div>
                        </div>
                    </div>
                    <!-- - End Learning Mood Widget -->

                    <div class="sidebar-card">
                        <h3 class="sidebar-title">â±ï¸ Focus Timer</h3>
                        <div id="timerDisplay" style="text-align: center; font-size: 1.8rem; font-weight: bold; color: #3b82f6; margin: 15px 0; padding: 10px; background-color: #f8fafc; border-radius: var(--radius-md);">
        25:00
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                                <button class="add-time-btn" onclick="startTimer()">â¶ Start</button>
                                <button class="add-time-btn" onclick="pauseTimer()" style="background: #e74c3c;">â¸ Pause</button>
                                <button class="add-time-btn" onclick="resetTimer()" style="background: #95a5a6;">ð Reset</button>
                        </div>
                        <div style="margin-top: 18px; text-align: center;">
                            <a href="https://cool-timer.com/" target="_blank" 
                            style="display: inline-block; 
                                    padding: 10px 16px; 
                                    background: linear-gradient(135deg, #3b82f6, #60a5fa); 
                                    color: white; 
                                    border-radius: 20px; 
                                    text-decoration: none; 
                                    font-weight: 600; 
                                    font-size: 0.9rem; 
                                    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
                                    transition: all 0.3s ease;
                                    margin-top: 8px;">
                                ð Try Cool-Timer.com
                            </a>
                        </div>
                    </div>

                    <div class="sidebar-card">
                        <h3 class="sidebar-title">ð Session Notes</h3>
                        <textarea id="sessionNote" 
                            placeholder="Ghi chÃº nhá»¯ng Äiá»u ÄÃ£ há»c ÄÆ°á»£c hÃ´m nay..." 
                            style="width: 100%; min-height: 100px; padding: 12px; margin: 10px 0; border-radius: var(--radius-md); border: 1px solid var(--border-color); background: var(--bg-white); color: var(--text-dark); resize: vertical;"
                        ></textarea>
                        <button class="add-time-btn" onclick="logSession()" style="width: 100%;">
                            ð Log Session
                        </button>
                        <div id="sessionLogsContainer" style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
                            <!-- Session logs will appear here -->
                        </div>
                    </div>






        <!-- - Course Manager Section - -->
        <div id="course-section" class="hidden">
            <div class="sidebar-card">
                <h3 class="sidebar-title">
                    <span> </span>
                    <span id="courseCareerTitle" class="career-title">Private Equity</span> Courses
                </h3>

                <button class="goal-add-btn" onclick="openAddCourseModal()">
                    â Add New Course
                </button>
                <div id="coursesContainer">
                    <p class="goal-empty-state">No courses added yet for this career. Click 'Add Course' to get started.</p>
                </div>
            </div>
        </div>

        <!-- --- Course Modals --- -->
        <!-- Add Course/Edit Course Modal -->
        <div id="courseModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
            <div class="modal-content" style="background:var(--bg-white); padding:20px; border-radius:10px; width:90%; max-width:500px; box-shadow:var(--shadow-lg);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 id="courseModalTitle" style="margin:0;">â Add New Course</h3>
                    <button onclick="closeCourseModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color: var(--text-dark);">&times;</button>
                </div>
                <form id="courseForm">
                    <input type="hidden" id="editCourseId">
                    <div style="margin-bottom: 12px;">
                        <label for="courseTitle" style="display: block; margin-bottom: 5px; font-weight: 500;">Course Title *</label>
                        <input type="text" id="courseTitle" required style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label for="courseCareer" style="display: block; margin-bottom: 5px; font-weight: 500;">Career Path *</label>
                        <select id="courseCareer" required style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                            <option value="pe">ð¼ Private Equity</option>
                            <option value="ib">ð¦ Investment Banking</option>
                            <option value="hf">ð Hedge Funds</option>
                            <option value="sc">ð¯ Strategy Consulting</option>
                            <option value="fintech">ð³ Fintech</option>
                            <option value="english">ð© English</option>
                            <option value="chinese">ð Chinese</option>
                            <option value="tools">ð ï¸ Finance Tools</option>
                            <option value="cfa1">ð CFA Level 1</option>
                            <option value="general">ð General Finance</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div>
                            <label for="courseDifficulty" style="display: block; margin-bottom: 5px; font-weight: 500;">Difficulty</label>
                            <select id="courseDifficulty" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                                <option value="Beginner">ð¢ Beginner</option>
                                <option value="Intermediate" selected>ð¡ Intermediate</option>
                                <option value="Advanced">ð´ Advanced</option>
                            </select>
                        </div>
                        <div>
                            <label for="coursePriority" style="display: block; margin-bottom: 5px; font-weight: 500;">Priority</label>
                            <select id="coursePriority" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                                <option value="High">ðº High</option>
                                <option value="Medium" selected>ð¸ Medium</option>
                                <option value="Low">ð» Low</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label for="courseUrl" style="display: block; margin-bottom: 5px; font-weight: 500;">Course URL</label>
                        <input type="text" id="courseUrl" placeholder="https://example.com" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div>
                            <label for="courseEstHours" style="display: block; margin-bottom: 5px; font-weight: 500;">Estimated Hours</label>
                            <input type="number" id="courseEstHours" min="0.5" step="0.5" value="5" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                        </div>
                        <div>
                            <label for="courseDeadline" style="display: block; margin-bottom: 5px; font-weight: 500;">Deadline (Optional)</label>
                            <input type="date" id="courseDeadline" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                        </div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label for="courseDescription" style="display: block; margin-bottom: 5px; font-weight: 500;">Description</label>
                        <textarea id="courseDescription" rows="3" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark); resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 15px;">
                        <button type="button" class="add-time-btn" onclick="closeCourseModal()" style="background: #95a5a6;">Cancel</button>
                        <button type="submit" class="add-time-btn">ð¾ Save Course</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Hours Modal -->
        <div id="addHoursModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
            <div class="modal-content" style="background:var(--bg-white); padding:20px; border-radius:10px; width:90%; max-width:400px; box-shadow:var(--shadow-lg);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">â±ï¸ Add Hours</h3>
                    <button onclick="closeAddHoursModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color: var(--text-dark);">&times;</button>
                </div>
                <form id="addHoursForm">
                    <input type="hidden" id="addHoursCourseId">
                    <div style="margin-bottom: 15px;">
                        <label for="hoursToAdd" style="display: block; margin-bottom: 5px; font-weight: 500;">Hours Studied *</label>
                        <input type="number" id="hoursToAdd" min="0.1" step="0.1" required style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button type="button" class="add-time-btn" onclick="closeAddHoursModal()" style="background: #95a5a6;">Cancel</button>
                        <button type="submit" class="add-time-btn">â Add Hours</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- --- End Course Modals --- -->




        <!-- ===== RESOURCE LIBRARY SIDEBAR CARD ===== -->
        <div class="sidebar-card">
            <h3 class="sidebar-title">ð Resource Library</h3>
            
            <!-- Tag Filter Section -->
            <div class="tag-filter-section">
                <div class="tag-filter-header">
                    <div class="tag-filter-title">
                        <span>ð·ï¸</span>
                        <span>Filter by Tags</span>
                    </div>
                    <button class="clear-tags-btn" onclick="clearAllTagFilters()" title="Clear all tag filters">
                        Clear All
                    </button>
                </div>
                <div class="tag-cloud" id="tagCloud">
                    <!-- Tag cloud will be rendered here -->
                </div>
                <div class="active-filters" id="activeFiltersContainer" style="display: none;">
                    <!-- Active filters will be rendered here -->
                </div>
            </div>
            
            <!-- Statistics Dashboard -->
            <div class="resource-dashboard" id="resourceDashboard" style="display: none; margin-bottom: 15px;">
                <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0; font-size: 1rem; color: var(--text-dark);">ð Dashboard</h4>
                    <button onclick="toggleResourceDashboard()" style="background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 0.9rem;">â²</button>
                </div>
                
                <div class="dashboard-stats">
                    <!-- Quick Stats -->
                    <div class="stats-row" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px;">
                        <div class="stat-box" style="text-align: center; padding: 8px; background: var(--bg-light); border-radius: 8px;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--primary);" id="statTotal">0</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Total</div>
                        </div>
                        <div class="stat-box" style="text-align: center; padding: 8px; background: var(--bg-light); border-radius: 8px;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: #f59e0b;" id="statUnread">0</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">To Read</div>
                        </div>
                        <div class="stat-box" style="text-align: center; padding: 8px; background: var(--bg-light); border-radius: 8px;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: #10b981;" id="statCompleted">0</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Completed</div>
                        </div>
                    </div>
                    
                    <!-- Progress Bars -->
                    <div class="progress-section" style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 0.8rem; color: var(--text-dark);">Completion Rate</span>
                            <span style="font-size: 0.8rem; font-weight: 600; color: var(--primary);" id="completionRate">0%</span>
                        </div>
                        <div style="height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden;">
                            <div id="completionBar" style="height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    
                    <!-- Type Distribution -->
                    <div class="type-distribution" style="margin-bottom: 10px;">
                        <div style="font-size: 0.8rem; color: var(--text-dark); margin-bottom: 6px;">By Type:</div>
                        <div id="typeDistribution" style="display: flex; flex-wrap: wrap; gap: 4px;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Top Categories -->
                    <div class="category-section">
                        <div style="font-size: 0.8rem; color: var(--text-dark); margin-bottom: 6px;">Top Categories:</div>
                        <div id="topCategories" style="font-size: 0.75rem; color: var(--text-muted);">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Toggle Dashboard Button -->
            <button onclick="toggleResourceDashboard()" id="toggleDashboardBtn" 
                    style="width: 100%; margin-bottom: 12px; padding: 8px; background: var(--bg-light); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; color: var(--text-dark); font-size: 0.9rem;">
                <span>ð</span>
                <span>Show Statistics</span>
                <span style="font-size: 0.8rem;">â¼</span>
            </button>
            
            <!-- Filters & Add Button -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <select id="resourceTypeFilter" onchange="filterResources()" class="filter-select">
                    <option value="all">All Types</option>
                    <option value="video">ð¥ Video</option>
                    <option value="journal">ð° Journal/Article</option>
                    <option value="research">ð Research Paper</option>
                    <option value="data">ð Data Source</option>
                    <option value="podcast">ðï¸ Podcast</option>
                    <option value="book">ð Book/PDF</option>
                    <option value="tool">ð ï¸ Tool/Platform</option>
                    <option value="other">ð Other</option>
                </select>

                <button class="add-analysis-btn" onclick="openResourceModal()">
                    <i class="fas fa-plus"></i> Add
                </button>
            </div>
            
            <!-- Search Bar -->
            <input type="text" id="resourceSearch" placeholder="ð Search resources..." 
                onkeyup="searchResources()" 
                style="width: 100%; padding: 8px 12px; margin-bottom: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
            
            <!-- Counter -->
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
                Total Resources: <span id="resourceCount">0</span>
            </div>
            
            <!-- Resource Cards Container -->
            <div id="resourceCardsContainer">
                <!-- Cards will render here -->
            </div>
        </div>

        <!-- ===== RESOURCE LIBRARY MODAL ===== -->
        <div id="resourceModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div class="modal-content" style="background-color: var(--bg-white); margin: 5% auto; padding: 20px; border-radius: var(--radius-lg); width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow-xl); border: 1px solid var(--border-color);">
                <!-- Modal Header -->
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                    <h3 id="resourceModalTitle" style="margin: 0; font-size: 1.2rem; color: var(--text-dark);">Add New Resource</h3>
                    <button onclick="closeResourceModal()" class="modal-close" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <form id="resourceForm">
                        <input type="hidden" id="resourceId">

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="resourceTitle" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Title *</label>
                            <input type="text" id="resourceTitle" required placeholder="e.g., Ray Dalio on Economic Cycles" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark);">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div class="form-group">
                                <label for="resourceType" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Type *</label>
                                <select id="resourceType" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark);">
                                    <option value="">Select Type</option>
                                    <option value="video">ð¥ Video</option>
                                    <option value="journal">ð° Journal/Article</option>
                                    <option value="research">ð Research Paper</option>
                                    <option value="data">ð Data Source</option>
                                    <option value="podcast">ðï¸ Podcast</option>
                                    <option value="book">ð Book/PDF</option>
                                    <option value="tool">ð ï¸ Tool/Platform</option>
                                    <option value="other">ð Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="resourceCategory" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Category</label>
                                <select id="resourceCategory" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark);">
                                    <option value="">Select Category</option>
                                    <option value="Economics">Economics</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Investing">Investing</option>
                                    <option value="Trading">Trading</option>
                                    <option value="Corporate Finance">Corporate Finance</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Psychology">Psychology</option>
                                    <option value="Strategy">Strategy</option>
                                    <option value="Data Science">Data Science</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="resourceUrl" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">URL *</label>
                            <input type="url" id="resourceUrl" required placeholder="https://..." style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark);">
                        </div>

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="resourceAuthor" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Author/Source</label>
                            <input type="text" id="resourceAuthor" placeholder="e.g., Ray Dalio, McKinsey, Bloomberg" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark);">
                        </div>

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="resourceNotes" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Notes / Key Takeaways</label>
                            <textarea id="resourceNotes" rows="4" placeholder="What makes this resource valuable? Key insights..." style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); resize: vertical;"></textarea>
                        </div>

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="resourceTags" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Tags (comma separated)</label>
                            <input type="text" id="resourceTags" placeholder="e.g., inflation, fed, macroeconomics" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark);">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div class="form-group">
                                <label for="resourcePriority" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Priority</label>
                                <select id="resourcePriority" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark);">
                                    <option value="high">ðº High</option>
                                    <option value="medium" selected>ð¸ Medium</option>
                                    <option value="low">ð» Low</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="resourceStatus" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Status</label>
                                <select id="resourceStatus" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark);">
                                    <option value="to-read">ð To Read</option>
                                    <option value="reading">ð Reading</option>
                                    <option value="completed">â Completed</option>
                                </select>
                            </div>
                        </div>

                        <!-- Modal Footer -->
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            <button type="button" onclick="closeResourceModal()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.85rem;">Cancel</button>
                            <button type="submit" class="btn-primary" style="padding: 8px 16px; font-size: 0.85rem;">Save Resource</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- ===== END RESOURCE LIBRARY SIDEBAR CARD ===== -->





        <!-- ===== INVESTMENT MEMO SIDEBAR CARD ===== -->
        <div class="sidebar-card">
            <h3 class="sidebar-title">Investment Analyses</h3>
            
            <!-- Filters & Add Button -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <select id="analysisTypeFilter" onchange="filterAnalyses()" class="filter-select">
                    <option value="all">All Types</option>
                    <option value="stock_pitch">ð Stock Pitch</option>
                    <option value="lbo">ð° LBO Model</option>
                    <option value="dcf">ð DCF Valuation</option>
                    <option value="ma">ð¤ M&A Analysis</option>
                    <option value="industry">ð Industry Report</option>
                </select>

                <button class="add-analysis-btn" onclick="openAnalysisModal()">
                    <i class="fas fa-plus"></i> Add New
                </button>

            </div>
            
            <!-- Counter -->
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
                Total Analyses: <span id="analysisCount">0</span>
            </div>
            
            <!-- Analysis Cards Container -->
            <div id="analysisCardsContainer">
                <!-- Cards sáº½ ÄÆ°á»£c render á» ÄÃ¢y -->
            </div>
        </div>






        <!-- ===== INVESTMENT ANALYSIS MODAL  ===== -->
        <div id="analysisModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div class="modal-content" style="background-color: var(--bg-white); margin: 5% auto; padding: 20px; border-radius: var(--radius-lg); width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow-xl); border: 1px solid var(--border-color);">
                <!-- Modal Header -->
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                    <h3 id="analysisModalTitle" style="margin: 0; font-size: 1.2rem; color: var(--text-dark);">Add New Investment Analysis</h3>
                    <button onclick="closeAnalysisModal()" class="modal-close" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <form id="analysisForm">
                        <input type="hidden" id="analysisId">

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="analysisTitle" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Title *</label>
                            <input type="text" id="analysisTitle" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div class="form-group">
                                <label for="analysisType" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Type *</label>
                                <select id="analysisType" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);">
                                    <option value="">Select Type</option>
                                    <option value="stock_pitch">ð Stock Pitch</option>
                                    <option value="lbo">ð° LBO Model</option>
                                    <option value="dcf">ð DCF Valuation</option>
                                    <option value="ma">ð¤ M&A Analysis</option>
                                    <option value="industry">ð Industry Report</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="analysisDate" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Date *</label>
                                <input type="date" id="analysisDate" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);">
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="analysisThesis" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Investment Thesis *</label>
                            <textarea id="analysisThesis" rows="4" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);"></textarea>
                        </div>

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="analysisTags" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Tags (comma separated)</label>
                            <input type="text" id="analysisTags" placeholder="e.g., Technology, Vietnam, Growth" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);">
                        </div>

                        <details style="margin-bottom: 16px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 12px; background: var(--bg-light);">
                            <summary style="font-weight: 500; cursor: pointer; padding: 6px 0; color: var(--text-dark);">Key Metrics (Optional)</summary>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div class="form-group">
                                    <label for="currentPrice" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Current Price</label>
                                    <input type="text" id="currentPrice" placeholder="e.g., $150.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-white); color: var(--text-dark);">
                                </div>
                                <div class="form-group">
                                    <label for="targetPrice" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Target Price</label>
                                    <input type="text" id="targetPrice" placeholder="e.g., $180.00" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-white); color: var(--text-dark);">
                                </div>
                                <div class="form-group">
                                    <label for="upside" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Upside</label>
                                    <input type="text" id="upside" placeholder="e.g., 20%" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-white); color: var(--text-dark);">
                                </div>
                                <div class="form-group">
                                    <label for="peRatio" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">P/E Ratio</label>
                                    <input type="text" id="peRatio" placeholder="e.g., 15x" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-white); color: var(--text-dark);">
                                </div>
                                <div class="form-group">
                                    <label for="recommendation" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Recommendation</label>
                                    <select id="recommendation" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-white); color: var(--text-dark);">
                                        <option value="">Select</option>
                                        <option value="BUY">BUY</option>
                                        <option value="HOLD">HOLD</option>
                                        <option value="SELL">SELL</option>
                                    </select>
                                </div>
                            </div>
                        </details>

                        <details style="margin-bottom: 16px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 12px; background: var(--bg-light);">
                            <summary style="font-weight: 500; cursor: pointer; padding: 6px 0; color: var(--text-dark);">Links (Optional)</summary>
                            <div style="margin-top: 10px;">
                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label for="pitchDeckLink" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Pitch Deck Link</label>
                                    <input type="url" id="pitchDeckLink" placeholder="https://..." style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-white); color: var(--text-dark);">
                                </div>
                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label for="excelModelLink" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Excel Model Link</label>
                                    <input type="url" id="excelModelLink" placeholder="https://..." style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-white); color: var(--text-dark);">
                                </div>
                                <div class="form-group">
                                    <label for="notesLink" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Notes Link</label>
                                    <input type="url" id="notesLink" placeholder="https://..." style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-white); color: var(--text-dark);">
                                </div>
                            </div>
                        </details>

                        <!-- Modal Footer -->
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            <button type="button" onclick="closeAnalysisModal()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.85rem;">Cancel</button>
                            <button type="submit" class="btn-primary" style="padding: 8px 16px; font-size: 0.85rem;">Save Analysis</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>




        <!-- ===== DEAL DIARY SIDEBAR CARD ===== -->
        <div class="sidebar-card">
            <h3 class="sidebar-title">DEAL DIARY</h3>
            
            <!-- Filters & Add Button -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <select id="dealTypeFilter" onchange="filterDeals()" class="filter-select">                
                    <option value="all">All Types</option>
                    <option value="M&A">ð¤ M&A</option>
                    <option value="LBO">ð° LBO</option>
                    <option value="IPO">ð IPO</option>
                    <option value="Restructuring">ð Restructuring</option>
                </select>

                <button class="add-deal-btn" onclick="openDealModal()">
                    <i class="fas fa-plus"></i> Add Deal
                </button>

            </div>
            
            <!-- Counter -->
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
                Total Deals: <span id="dealCount">0</span>
            </div>
            
            <!-- Deal Cards Container -->
            <div id="dealCardsContainer">
                <!-- Cards sáº½ ÄÆ°á»£c render á» ÄÃ¢y -->
            </div>
        </div>



        <!-- ===== DEAL DIARY MODAL ===== -->
        <div id="dealModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div class="modal-content" style="background-color: var(--bg-white); margin: 5% auto; padding: 20px; border-radius: var(--radius-lg); width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow-xl); border: 1px solid var(--border-color);">
                <!-- Modal Header -->
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                    <h3 id="dealModalTitle" style="margin: 0; font-size: 1.2rem; color: var(--text-dark);">Add New Deal</h3>
                    <button onclick="closeDealModal()" class="modal-close" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <form id="dealForm">
                        <input type="hidden" id="dealId">

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="dealName" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Deal Name *</label>
                            <input type="text" id="dealName" required placeholder="e.g., Microsoft acquires Activision Blizzard" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div class="form-group">
                                <label for="dealType" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Deal Type *</label>
                                <select id="dealType" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);">
                                    <option value="">Select Type</option>
                                    <option value="M&A">ð¤ M&A</option>
                                    <option value="LBO">ð° LBO</option>
                                    <option value="IPO">ð IPO</option>
                                    <option value="Restructuring">ð Restructuring</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dealValue" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Deal Value</label>
                                <input type="text" id="dealValue" placeholder="e.g., $68.7B" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div class="form-group">
                                <label for="dealStatus" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Status *</label>
                                <select id="dealStatus" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);">
                                    <option value="closed">â Closed</option>
                                    <option value="announced">ð¢ Announced</option>
                                    <option value="rumored">ð Rumored</option>
                                    <option value="terminated">â Terminated</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dealDate" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Date *</label>
                                <input type="date" id="dealDate" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div class="form-group">
                                <label for="dealBuyer" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Buyer/Issuer</label>
                                <input type="text" id="dealBuyer" placeholder="e.g., Microsoft" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);">
                            </div>
                            <div class="form-group">
                                <label for="dealTarget" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Target/Company</label>
                                <input type="text" id="dealTarget" placeholder="e.g., Activision Blizzard" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);">
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 16px;">
                            <label for="dealLearnings" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Key Learnings *</label>
                            <textarea id="dealLearnings" rows="4" required placeholder="What did you learn from this deal? What made it succeed/fail?" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-light); color: var(--text-dark); transition: var(--transition);"></textarea>
                        </div>

                        <details style="margin-bottom: 16px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 12px; background: var(--bg-light);">
                            <summary style="font-weight: 500; cursor: pointer; padding: 6px 0; color: var(--text-dark);">Additional Links</summary>
                            <div style="margin-top: 10px;">
                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label for="pressReleaseLink" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Press Release</label>
                                    <input type="url" id="pressReleaseLink" placeholder="https://..." style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-white); color: var(--text-dark);">
                                </div>
                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label for="analysisLink" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Deal Analysis</label>
                                    <input type="url" id="analysisLink" placeholder="https://..." style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-white); color: var(--text-dark);">
                                </div>
                                <div class="form-group">
                                    <label for="filingLink" style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Regulatory Filing</label>
                                    <input type="url" id="filingLink" placeholder="https://..." style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); background: var(--bg-white); color: var(--text-dark);">
                                </div>
                            </div>
                        </details>

                        <!-- Modal Footer -->
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            <button type="button" onclick="closeDealModal()" class="btn-secondary" style="padding: 8px 16px; font-size: 0.85rem;">Cancel</button>
                            <button type="submit" class="btn-primary" style="padding: 8px 16px; font-size: 0.85rem;">Save Deal</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>




        <!-- ===== SLEEP TRACKER SIDEBAR CARD ===== -->
        <div class="sidebar-card">
            <h3 class="sidebar-title">â±ï¸ Sleep Tracker</h3>
            <div id="sleepStatus" style="text-align: center; font-size: 1.1rem; margin: 10px 0;">
                ð´ Ready to sleep
            </div>
            <div id="sleepTimerDisplay" style="font-size: 2rem; text-align: center; font-weight: bold; color: var(--primary); margin: 10px 0; display: none;">
                00:00:00
            </div>
            
            <!-- Control Buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="startSleepBtn" class="add-time-btn" onclick="startSleepTracking()" style="flex: 1; background: #27ae60;">â¶ Start</button>
                <button id="stopSleepBtn" class="add-time-btn" onclick="stopSleepTracking()" style="flex: 1; background: #e74c3c; display: none;">â¸ Stop</button>
                <button class="add-time-btn" onclick="openManualSleepModal()" style="flex: 1; background: #3498db;">â Manual</button>
            </div>
            
            <!-- Sleep Chart -->
            <div class="chart-container" style="margin: 20px 0;">
                <canvas id="sleepChart"></canvas>
            </div>
            
            <!-- Sleep History -->
            <div style="margin-top: 20px;">
                <h4 style="font-size: 1rem; font-weight: 600; color: var(--text-dark); margin-bottom: 10px;">ð Recent Sessions</h4>
                <div id="sleepHistoryContainer" style="max-height: 300px; overflow-y: auto;">
                    <!-- History will render here -->
                </div>
            </div>
        </div>


        <!-- ===== READING LIST SIDEBAR CARD ===== -->      
        <div class="sidebar-card" id="readingListCard">
            <h3 class="sidebar-title">
                <span class="sidebar-title-icon">ð</span>
                <span class="sidebar-title-text">Reading List</span>
            </h3>

            <button class="add-time-btn" onclick="openAddBookModal()" style="margin-bottom: 15px; width: 100%;">
                â Add Book
            </button>

            <div class="stats-section">
                <div class="stat-item">
                    <div class="stat-emoji">ð</div>
                    <div class="stat-label">Total</div>
                    <div class="stat-value" id="totalCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-emoji">ð</div>
                    <div class="stat-label">Reading</div>
                    <div class="stat-value" id="readingCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-emoji">â</div>
                    <div class="stat-label">Finished</div>
                    <div class="stat-value" id="finishedCount">0</div>
                </div>
            </div>

            <div class="reading-list-section">
                <div class="reading-controls">
                    <select id="genreFilter" title="Filter by Genre">
                        <option value="all">All Genres</option>
                        <option value="Fiction">Fiction</option>
                        <option value="Non-Fiction">Non-Fiction</option>
                        <option value="Science">Science</option>
                        <option value="Technology">Technology</option>
                        <option value="Finance">Finance</option>
                        <option value="Biography">Biography</option>
                        <option value="History">History</option>
                        <option value="Philosophy">Philosophy</option>
                        <option value="Self-Help">Self-Help</option>
                        <option value="Fantasy">Fantasy</option>
                        <option value="Mystery">Mystery</option>
                        <option value="Psychology">Psychology</option>
                        <option value="Business">Business</option>
                        <option value="Politics">Politics</option>
                        <option value="Other">Other</option>
                    </select>
                    <select id="sortReadingList" title="Sort by">
                        <option value="default">Sort: Added</option>
                        <option value="titleAsc">Title (A-Z)</option>
                        <option value="titleDesc">Title (Z-A)</option>
                        <option value="ratingAsc">Rating (Low-High)</option>
                        <option value="ratingDesc">Rating (High-Low)</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="ð Search books..." style="max-width: 150px;">
                </div>

                <div class="reading-container" id="readingListContainer">
                    <div class="empty-state">No books added yet. Click 'Add Book' to get started.</div>
                </div>
            </div>
        </div>


        <!-- ===== ADD CUSTOM QUOTE CARD ===== -->
        <div class="sidebar-card" style="margin-top: 20px;">
            <h3 class="sidebar-title">â Add Your Own Quote</h3>
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">
                    Quote Text *
                </label>
                <textarea 
                    id="customQuoteText" 
                    placeholder="Enter your motivational quote..." 
                    rows="3"
                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-white); color: var(--text-dark); resize: vertical; font-size: 0.95rem;">
                </textarea>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">
                    Author (Optional)
                </label>
                <input 
                    type="text" 
                    id="customQuoteAuthor" 
                    placeholder="e.g., Fyodor Dostoevsky" 
                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-white); color: var(--text-dark); font-size: 0.95rem;">
            </div>
            <button 
                onclick="addCustomQuote()" 
                class="add-time-btn" 
                style="width: 100%; background: linear-gradient(135deg, #f59e0b, #f97316); margin-bottom: 10px;">
                â Add Quote
            </button>

            <!-- Stats: How many custom quotes -->
            <div style="text-align: center; font-size: 0.85rem; color: var(--text-muted); padding: 8px; background: var(--bg-light); border-radius: 6px;">
                ð Custom Quotes: <strong id="customQuotesCount">0</strong>
            </div>
            
            <!-- Button to manage custom quotes -->
            <button 
                onclick="openManageQuotesModal()" 
                class="add-time-btn" 
                style="width: 100%; background: var(--bg-light); color: var(--text-dark); border: 1px solid var(--border-color); margin-top: 10px;">
                ð Manage My Quotes
            </button>
        </div>


        <!-- ===== CUSTOM MEME MANAGER ===== -->
        <div class="sidebar-card" style="margin-top: 20px;">
            <h3 class="sidebar-title">ð­ Manage Memes</h3>
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">
                    Add Meme URL
                </label>
                <input 
                    type="url" 
                    id="customMemeUrl" 
                    placeholder="https://example.com/image.jpg" 
                    style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-white); color: var(--text-dark); font-size: 0.95rem;">
            </div>
            <button 
                onclick="addCustomMeme()" 
                class="add-time-btn" 
                style="width: 100%; background: linear-gradient(135deg, #8b5cf6, #a78bfa); margin-bottom: 10px;">
                â Add Meme
            </button>
            <div style="text-align: center; font-size: 0.85rem; color: var(--text-muted); padding: 8px; background: var(--bg-light); border-radius: 6px;">
                ð¸ Custom Memes: <strong id="customMemesCount">0</strong>
            </div>
            
            <button 
                onclick="openManageMemesModal()" 
                class="add-time-btn" 
                style="width: 100%; background: var(--bg-light); color: var(--text-dark); border: 1px solid var(--border-color); margin-top: 10px;">
                ð Manage My Memes
            </button>
        </div>


<!-- ===== FLASHCARD MANAGER SECTION ===== -->
<div class="sidebar-card" style="margin-top: 20px;">
    <h3 class="sidebar-title">ð´ Flashcard Manager</h3>
    
    <!-- Display Area -->
    <div id="flashcardDisplay" onclick="flipFlashcard()">
        <div id="flashcardFront">
            <div style="text-align: center; margin-bottom: 20px;">
                <img id="flashcardImage" src="" alt="" style="display: none;">
            </div>
            <div id="flashcardQuestion">
                <div class="flashcard-empty-state">
                    <div class="flashcard-empty-state-icon">ð´</div>
                    <div class="flashcard-empty-state-text">Click Random to start learning</div>
                </div>
            </div>
        </div>
        <div id="flashcardBack" style="display: none;">
            <div id="flashcardAnswer"></div>
        </div>
        <div class="flip-indicator">
            ð Click to flip
        </div>
    </div>
    
    <!-- Control buttons - Icon only -->
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button onclick="getRandomFlashcard()" class="flashcard-btn flashcard-btn-icon" style="flex: 1;" title="Random Flashcard">
            ð
        </button>
        <button onclick="openAddFlashcardModal()" class="flashcard-btn flashcard-btn-icon" style="flex: 1;" title="Add New Flashcard">
            â
        </button>
    </div>

    <!-- Anki Link -->
    <div style="margin-bottom: 15px;">
        <a href="https://ankiweb.net/decks" target="_blank" rel="noopener noreferrer" class="anki-glass-btn">
            <span class="anki-content">
                <span class="anki-icon-glass">ð´</span>
                <span class="anki-text-glass">Study on AnkiWeb</span>
                <span class="anki-badge">Premium</span>
            </span>
        </a>
    </div>  
    
    <!-- Stats -->
    <div class="flashcard-stats">
        ð Total Cards: <strong id="flashcardCount">0</strong>
    </div>
    
    <!-- Manage button -->
    <button onclick="openManageFlashcardsModal()" class="flashcard-btn" style="width: 100%;">
        ð Manage All Flashcards
    </button>
</div>

<!-- ===== ADD/EDIT MODAL ===== -->
<div id="addFlashcardModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 10001; align-items: center; justify-content: center; backdrop-filter: blur(5px); padding: 20px;">
    <div class="flashcard-modal-content">
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h3 style="margin: 0; font-size: 1.3rem; color: var(--fc-text);" id="flashcardModalTitle">
                â Add New Flashcard
            </h3>
            <button onclick="closeAddFlashcardModal()" class="flashcard-modal-close">
                &times;
            </button>
        </div>
        
        <!-- Formatting Guide -->
        <details class="formatting-guide">
            <summary>ð Formatting Guide & Tips</summary>
            <div class="formatting-guide-content">
                <strong>ð Markdown Syntax:</strong><br>
                **bold text** | *italic text* | - bullet points<br>
                ### Heading | `code snippet` | [link](url)
                <br><br>
                <strong>ð¢ Math (LaTeX):</strong><br>
                Inline math: $x^2 + y^2 = z^2$<br>
                Display math: $$\int_{0}^{\infty} e^{-x} dx = 1$$
                <br><br>
                <strong>ð¼ï¸ Images:</strong><br>
                Paste image URL in the Image field below
                <br><br>
                <strong>ð¡ Tips:</strong><br>
                â¢ Keep questions concise and clear<br>
                â¢ Use formatting to highlight key concepts<br>
                â¢ Add images for visual learners
            </div>
        </details>
        
        <form onsubmit="event.preventDefault(); saveFlashcard();">
            <!-- Question -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--fc-text); font-size: 0.95rem;">
                    â Question *
                </label>
                <textarea 
                    id="newFlashcardQuestion" 
                    rows="4" 
                    required
                    placeholder="Enter your question here...&#10;Example: What is the Current Ratio and what does it measure?"
                    class="flashcard-textarea"
                ></textarea>
            </div>
            
            <!-- Image URL -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--fc-text); font-size: 0.95rem;">
                    ð¼ï¸ Image URL (Optional)
                </label>
                <input 
                    type="url" 
                    id="newFlashcardImage" 
                    placeholder="https://example.com/image.jpg" 
                    style="width: 100%; padding: 12px; border: 2px solid var(--fc-border); border-radius: var(--fc-radius); background: var(--fc-bg); color: var(--fc-text); font-size: 0.95rem; transition: all 0.3s ease;"
                    onfocus="this.style.borderColor='var(--fc-primary)'"
                    onblur="this.style.borderColor='var(--fc-border)'"
                >
            </div>
            
            <!-- Answer -->
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--fc-text); font-size: 0.95rem;">
                    â Answer *
                </label>
                <textarea 
                    id="newFlashcardAnswer" 
                    rows="10" 
                    required
                    placeholder="Enter your answer here... (Markdown & LaTeX supported)&#10;&#10;Example:&#10;The **Current Ratio** measures liquidity:&#10;&#10;$$\text{Current Ratio} = \frac{\text{Current Assets}}{\text{Current Liabilities}}$$&#10;&#10;Key points:&#10;- Ratio > 1 means company can cover short-term obligations&#10;- Higher ratio = better liquidity position&#10;- Industry benchmarks vary"
                    class="flashcard-textarea"
                ></textarea>
            </div>
            
            <!-- Action buttons -->
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button 
                    type="button"
                    onclick="closeAddFlashcardModal()" 
                    class="flashcard-btn"
                    style="background: var(--fc-bg-secondary); border-color: var(--fc-border);"
                >
                    Cancel
                </button>
                <button 
                    type="submit"
                    class="flashcard-btn"
                >
                    ð¾ Save Flashcard
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ===== MANAGE MODAL ===== -->
<div id="manageFlashcardsModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(5px); padding: 20px;">
    <div class="flashcard-modal-content" style="max-width: 950px;">
        <!-- Sticky Header -->
        <div style="position: sticky; top: 0; background: var(--fc-bg); z-index: 10; padding-bottom: 20px; margin-bottom: 20px; border-bottom: 2px solid var(--fc-border);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0 0 8px 0; font-size: 1.4rem; color: var(--fc-text);">
                        ð Manage Flashcards
                    </h2>
                    <p style="margin: 0; color: var(--fc-text-muted); font-size: 0.95rem;">
                        <span id="manageFlashcardCount">0</span> flashcards total
                    </p>
                </div>
                <button 
                    onclick="closeManageFlashcardsModal()" 
                    class="flashcard-modal-close"
                >
                    &times;
                </button>
            </div>
        </div>
        
        <!-- Flashcards Container -->
        <div id="manageFlashcardsContainer">
            <!-- Cards will be rendered here by JavaScript -->
        </div>
    </div>
</div>

<!-- ===== FULLSCREEN FLASHCARD MODAL - SPACED REPETITION ===== -->
<div id="fullscreenFlashcardModal" style="display: none;">
    <div class="fullscreen-flashcard-container">
        
        <!-- ===== COMPACT HEADER ===== -->
        <div class="fullscreen-flashcard-header">
            <div class="fullscreen-flashcard-title">
                <span>ð´</span>
                <span>Flashcard Study Mode</span>
            </div>
            <div class="fullscreen-flashcard-info">
                <span id="fullscreenCardCounter">Card 1 of 10</span>
                <span id="fullscreenSessionTime">00:00</span>
                <span id="fullscreenCardMastery" style="color: var(--fc-primary); font-weight: 700;">0%</span>
            </div>
            <button class="fullscreen-close-btn" onclick="closeFullscreenFlashcard()">
                <span>â</span>
                <span>Close</span>
            </button>
        </div>

        <!-- ===== MAIN FLASHCARD DISPLAY - MAXIMIZED ===== -->
        <div class="fullscreen-flashcard-display" onclick="flipFullscreenFlashcard()">
            <div class="fullscreen-flashcard-content">
                <div id="fullscreenFlashcardFront">
                    <img id="fullscreenFlashcardImage" class="fullscreen-flashcard-image" style="display: none;">
                    <div id="fullscreenFlashcardQuestion" class="fullscreen-flashcard-question"></div>
                </div>
                <div id="fullscreenFlashcardBack" style="display: none;">
                    <div id="fullscreenFlashcardAnswer" class="fullscreen-flashcard-answer"></div>
                </div>
            </div>
        </div>

        <!-- ===== SPACED REPETITION CONTROLS ===== -->
        <div class="fullscreen-flashcard-controls" id="fullscreenControlsContainer">
            <!-- Controls sáº½ ÄÆ°á»£c táº¡o Äá»ng bá»i JavaScript -->
        </div>
        
    </div>
</div>
        

        <!-- Add Book Modal -->
        <div id="addBookModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>â Add New Book</h3>
                    <button class="modal-close" onclick="closeAddBookModal()">&times;</button>
                </div>
                <form id="addBookForm">
                    <div class="form-group">
                        <label for="bookTitle">Book Title *</label>
                        <input type="text" id="bookTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="bookAuthor">Author *</label>
                        <input type="text" id="bookAuthor" required>
                    </div>
                    <div class="form-group">
                        <label for="bookCoverUrl">Cover Image URL (Optional)</label>
                        <input type="text" id="bookCoverUrl" placeholder="https://example.com/book.jpg">
                    </div>
                    <div class="form-group">
                        <label for="bookGenre">Genre *</label>
                        <select id="bookGenre" required>
                            <option value="">Select a Genre</option>
                            <option value="Fiction">Fiction</option>
                            <option value="Non-Fiction">Non-Fiction</option>
                            <option value="Biography">Biography</option>
                            <option value="Business">Business</option>
                            <option value="Finance">Finance</option>
                            <option value="Technology">Technology</option>
                            <option value="Self-Help">Self-Help</option>
                            <option value="Psychology">Psychology</option>
                            <option value="History">History</option>
                            <option value="Science">Science</option>
                            <option value="Philosophy">Philosophy</option>
                            <option value="Politics">Politics</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bookStatus">Status *</label>
                        <select id="bookStatus" required>
                            <option value="want">Want to Read</option>
                            <option value="reading">Reading</option>
                            <option value="finished">Finished</option>
                        </select>
                    </div>
                    <!-- ADD THESE MISSING FIELDS -->
                    <div class="form-group">
                        <label for="bookRating">Rating (1-5 stars)</label>
                        <select id="bookRating">
                            <option value="">No rating</option>
                            <option value="1">â­</option>
                            <option value="2">â­â­</option>
                            <option value="3">â­â­â­</option>
                            <option value="4">â­â­â­â­</option>
                            <option value="5">â­â­â­â­â­</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bookReview">Review (Optional)</label>
                        <textarea id="bookReview" rows="3" placeholder="Your thoughts about this book..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="add-time-btn btn-secondary" onclick="closeAddBookModal()">Cancel</button>
                        <button type="submit" class="add-time-btn">â Add Book</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- End Add Book Modal -->


        <!-- Edit Book Modal -->
        <div id="editBookModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>âï¸ Edit Book</h3>
                    <button class="modal-close" onclick="closeEditBookModal()">&times;</button>
                </div>
                <form id="editBookForm">
                    <input type="hidden" id="editBookId">
                    <div class="form-group">
                        <label for="editBookTitle">Book Title *</label>
                        <input type="text" id="editBookTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="editBookAuthor">Author *</label>
                        <input type="text" id="editBookAuthor" required>
                    </div>
                    <div class="form-group">
                        <label for="editBookCoverUrl">Cover Image URL (Optional)</label>
                        <input type="text" id="editBookCoverUrl" placeholder="https://example.com/book.jpg">
                    </div>
                    <div class="form-group">
                        <label for="editBookGenre">Genre *</label>
                        <select id="editBookGenre" required>
                            <option value="">Select a Genre</option>
                            <option value="Fiction">Fiction</option>
                            <option value="Non-Fiction">Non-Fiction</option>
                            <option value="Biography">Biography</option>
                            <option value="Business">Business</option>
                            <option value="Finance">Finance</option>
                            <option value="Technology">Technology</option>
                            <option value="Self-Help">Self-Help</option>
                            <option value="Psychology">Psychology</option>
                            <option value="History">History</option>
                            <option value="Science">Science</option>
                            <option value="Philosophy">Philosophy</option>
                            <option value="Politics">Politics</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editBookStatus">Status *</label>
                        <select id="editBookStatus" required>
                            <option value="want">Want to Read</option>
                            <option value="reading">Reading</option>
                            <option value="finished">Finished</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 12px;">
                        <label for="editBookRating" style="display: block; margin-bottom: 5px; font-weight: 500;">Rating (1-5 sao)</label>
                        <select id="editBookRating" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                            <option value="">ChÆ°a ÄÃ¡nh giÃ¡</option>
                            <option value="1">â­</option>
                            <option value="2">â­â­</option>
                            <option value="3">â­â­â­</option>
                            <option value="4">â­â­â­â­</option>
                            <option value="5">â­â­â­â­â­</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label for="editBookReview" style="display: block; margin-bottom: 5px; font-weight: 500;">Review</label>
                        <textarea id="editBookReview" rows="3" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark); resize: vertical;"></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="add-time-btn btn-secondary" onclick="closeEditBookModal()">Cancel</button>
                        <button type="submit" class="add-time-btn">ð¾ Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- End Edit Book Modal -->

        

        
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">Data Management</h3>
                        <button class="export-btn" onclick="exportProgress()">
                            ð¥ Export Progress
                        </button>
                        <button class="import-btn" onclick="document.getElementById('importFile').click()">
                            ð¤ Import Progress
                        </button>
                        <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importProgress(event)">
                    </div>

                    <div class="sidebar-card" style="margin-top: 20px;">
                        <h3 class="sidebar-title">ð§  Pattern Detection</h3>
                        <button onclick="refreshPatternInsights()" class="add-time-btn" style="width: 100%; margin-bottom: 15px;">
                            ð Refresh Patterns
                        </button>
                        <div id="patternInsightsContainer">
                        </div>
                    </div>
                </div>  
            </div>
        </div>
    </div>


    <!-- Correlation Analytics Dashboard -->
    <div class="correlation-dashboard" id="correlationDashboard">
        <div class="correlation-header">
            <h2 class="correlation-title">
                <span>ð</span>
                <span>Correlation Analytics</span>
            </h2>
        </div>
        
        <!-- Key Insights -->
        <div class="correlation-insights" id="correlationInsights">
            <!-- Insights will be generated here -->
        </div>
        
        <!-- Charts -->
        <div class="chart-grid">
            <!-- Sleep vs Study Productivity -->
            <div class="chart-card">
                <div class="chart-card-title">
                    ð´ Sleep vs Study Productivity
                </div>
                <canvas id="sleepStudyChart" style="max-height: 300px;"></canvas>
            </div>
            
            <!-- Skill Progress vs Goal Completion -->
            <div class="chart-card">
                <div class="chart-card-title">
                    ð¯ Skills vs Goals Completion
                </div>
                <canvas id="skillGoalChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>



    <!-- --- Motivational Quote Card --- -->
    <div id="quoteCard" onclick="getRandomQuote()">
        <div class="quote-icon">
            <i class="fas fa-quote-left"></i>
        </div>
        <div id="quoteText">Loading your first quote of inspiration...</div>
        <div id="quoteAuthor">- Your Future Self</div>
    </div>
    <!-- --- End Motivational Quote Card --- -->


    <!-- GOAL MODAL -->
    <div id="goalModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="goalModalTitle">â Add New Goal</h3>
                <button onclick="closeGoalModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color: var(--text-dark);">&times;</button>
            </div>
            
            <form id="goalForm">
                <input type="hidden" id="editGoalId">
                
                <!-- Step 1: Goal Title -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">
                        ð Goal Title *
                    </label>
                    <input type="text" id="goalTitle" required 
                        placeholder="e.g., Master Financial Modeling"
                        style="width:100%; padding:12px; border:1px solid var(--border-color); border-radius:8px; background: var(--bg-white); color: var(--text-dark); font-size: 1rem;">
                </div>

                <!-- Step 2: Goal Type Selection -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-dark);">
                        ð¯ Goal Type *
                    </label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <!-- Study Hours Option -->
                        <div class="goal-type-option" data-type="study_hours" onclick="selectGoalType('study_hours')" 
                            style="padding: 16px; border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s ease; background: var(--bg-white);">
                            <div style="font-size: 2rem; margin-bottom: 8px;">ð</div>
                            <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-dark);">Study Hours</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">Auto-syncs</div>
                        </div>

                        <!-- Skill Mastery Option -->
                        <div class="goal-type-option" data-type="skill_mastery" onclick="selectGoalType('skill_mastery')"
                            style="padding: 16px; border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s ease; background: var(--bg-white);">
                            <div style="font-size: 2rem; margin-bottom: 8px;">ð¯</div>
                            <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-dark);">Skill Mastery</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">Track specific skill</div>
                        </div>

                        <!-- Custom Goal Option -->
                        <div class="goal-type-option" data-type="custom" onclick="selectGoalType('custom')"
                            style="padding: 16px; border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s ease; background: var(--bg-white);">
                            <div style="font-size: 2rem; margin-bottom: 8px;">â</div>
                            <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-dark);">Custom</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">Manual tracking</div>
                        </div>
                    </div>
                    <input type="hidden" id="goalType" required>
                </div>

                <!-- Step 3: Type-Specific Fields (Dynamic) -->
                <div id="goalTypeSpecificFields"></div>

                <!-- Step 4: Target & Deadline -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-dark);">
                            ð¯ Target Value *
                        </label>
                        <input type="number" id="goalTarget" min="0" step="0.1" required 
                            placeholder="e.g., 100"
                            style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-dark);">
                            ð Deadline (Optional)
                        </label>
                        <input type="date" id="goalDeadline" 
                            style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                    </div>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 10px; border-top: 1px solid var(--border-color);">
                    <button type="button" onclick="closeGoalModal()" 
                        style="padding: 10px 20px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-light); color: var(--text-dark); cursor: pointer; font-weight: 500;">
                        Cancel
                    </button>
                    <button type="submit" 
                        style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; cursor: pointer; font-weight: 600;">
                        ð¾ Save Goal
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Update Custom Goal Progress Modal -->
    <div id="updateCustomGoalModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
        <div class="modal-content" style="background:var(--bg-white); padding:20px; border-radius:10px; width:90%; max-width:400px; box-shadow:var(--shadow-lg);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Update Progress</h3>
                <button onclick="closeUpdateCustomGoalModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color: var(--text-dark);">&times;</button>
            </div>
            <form id="updateCustomGoalForm">
                <input type="hidden" id="updateGoalId">
                <div style="margin-bottom: 12px;">
                    <label for="updateGoalValue" style="display: block; margin-bottom: 5px; font-weight: 500;">Current Progress</label>
                    <input type="number" id="updateGoalValue" min="0" step="0.1" required style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" onclick="closeUpdateCustomGoalModal()" style="padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-light); color: var(--text-dark); cursor: pointer;">Cancel</button>
                    <button type="submit" style="padding: 10px 15px; border: none; border-radius: 6px; background: var(--primary); color: white; cursor: pointer;">Update</button>
                </div>
            </form>
        </div>
    </div>
    <!-- - End Goal Modals - -->
 
    
    <!-- Edit Book Modal -->
    <div id="editBookModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
        <div class="modal-content" style="background:var(--bg-white); padding:20px; border-radius:10px; width:90%; max-width:500px; box-shadow:var(--shadow-lg);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">âï¸ Edit Book</h3>
                <button onclick="closeEditBookModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color: var(--text-dark);">&times;</button>
            </div>
            <form id="editBookForm">
                <input type="hidden" id="editBookId">
                <div style="margin-bottom: 12px;">
                    <label for="editBookTitle" style="display: block; margin-bottom: 5px; font-weight: 500;">Book Title *</label>
                    <input type="text" id="editBookTitle" required style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                </div>
                <div style="margin-bottom: 12px;">
                    <label for="editBookAuthor" style="display: block; margin-bottom: 5px; font-weight: 500;">Author *</label>
                    <input type="text" id="editBookAuthor" required style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                </div>
                <div style="margin-bottom: 12px;">
                    <label for="editBookCoverUrl" style="display: block; margin-bottom: 5px; font-weight: 500;">Cover Image URL (Optional)</label>
                    <input type="text" id="editBookCoverUrl" placeholder="https://example.com/book.jpg" style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                </div>
                <div style="margin-bottom: 12px;">
                    <label for="editBookGenre" style="display: block; margin-bottom: 5px; font-weight: 500;">Genre *</label>
                    <select id="editBookGenre" required style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                        <option value="">Select a Genre</option>
                        <option value="Fiction">Fiction</option>
                        <option value="Non-Fiction">Non-Fiction</option>
                        <option value="Biography">Biography</option>
                        <option value="Business">Business</option>
                        <option value="Finance">Finance</option>
                        <option value="Technology">Technology</option>
                        <option value="Self-Help">Self-Help</option>
                        <option value="Psychology">Psychology</option>
                        <option value="History">History</option>
                        <option value="Science">Science</option>
                        <option value="Philosophy">Philosophy</option>
                        <option value="Politics">Politics</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div style="margin-bottom: 12px;">
                    <label for="editBookStatus" style="display: block; margin-bottom: 5px; font-weight: 500;">Status *</label>
                    <select id="editBookStatus" required style="width:100%; padding:10px; border:1px solid var(--border-color); border-radius:6px; background: var(--bg-white); color: var(--text-dark);">
                        <option value="want">Want to Read</option>
                        <option value="reading">Reading</option>
                        <option value="finished">Finished</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 15px;">
                    <button type="button" class="add-time-btn" onclick="closeEditBookModal()" style="background: #95a5a6;">Cancel</button>
                    <button type="submit" class="add-time-btn">ð¾ Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal xem toÃ n bá» Review -->
    <div id="fullReviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="fullReviewTitle">Full Review</h3>
                <button class="modal-close" onclick="closeFullReviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="fullReviewText" style="white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto; padding: 10px; background-color: #f5f5f5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; line-height: 1.5;"></pre>
            </div>
        </div>
    </div>

    <div id="bookDetailsModal" class="modal">
        <div class="modal-content">
           <div class="modal-header">
            <div>
                <h3 id="bookDetailsTitle">Book Title</h3>
                <p id="bookDetailsAuthor">by Author Name</p>
            </div>
            <button class="modal-close" onclick="closeBookDetailsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="display: flex; gap: 15px; align-items: flex-start;">
                <img id="bookDetailsCover" src="" alt="Book Cover" style="width: 100px; height: 140px; object-fit: cover; border-radius: 6px; display: none;"> <!-- áº¨n máº·c Äá»nh -->
                <div style="flex-grow: 1;">
                    <p><strong>Genre:</strong> <span id="bookDetailsGenre">Genre</span></p>
                    <p><strong>Status:</strong> <span id="bookDetailsStatus" class="book-status-badge">Status</span></p>
                    <div id="bookDetailsRating" style="margin: 8px 0; color: #f59e0b; font-size: 1.1rem;"></div> <!-- áº¨n máº·c Äá»nh náº¿u khÃ´ng cÃ³ rating -->
                    <div id="bookDetailsReview" style="margin-top: 10px; font-style: italic;"></div> <!-- áº¨n máº·c Äá»nh náº¿u khÃ´ng cÃ³ review -->
                </div>
            </div>
        </div>
    </div>


    <script>


        let investmentAnalyses = [];
        let dealDiary = [];
        let sleepSessions = [];
        let customMemes = [];
        let customQuotes = [];




        function debounce(func, delay) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        function checkLocalStorageAvailability() {
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }
        function checkLocalStorageQuota() {
            if (!checkLocalStorageAvailability()) {
                return false;
            }
            const maxStorage = 5 * 1024 * 1024;
            let usedStorage = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    usedStorage += localStorage.getItem(key).length * 2; 
                }
            }
            if (usedStorage > maxStorage * 0.8) {
                return false; 
            }
            return true;
        }


    const skillsData = {
            pe: {
                title: "Private Equity Skills",
                categories: {
                    "Core Finance": {
                        icon: "ð¦",
                        color: "#e74c3c",
                        skills: [
                            { name: "LBO Modeling", time: "morning", importance: 5, targetHours: 160 },
                            { name: "DCF Valuation", time: "morning", importance: 5, targetHours: 120 },
                            { name: "Due Diligence", time: "morning", importance: 4, targetHours: 80 },
                            { name: "Scenario / Sensitivity Analysis", time: "afternoon", importance: 4, targetHours: 60 },
                            { name: "Deal Sourcing & Execution", time: "afternoon", importance: 4, targetHours: 100 },
                            { name: "Portfolio Management", time: "afternoon", importance: 4, targetHours: 140 },
                            { name: "Exit Strategies", time: "evening", importance: 3, targetHours: 50 },
                            { name: "Debt vs Equity Structuring", time: "afternoon", importance: 3, targetHours: 70 },
                            { name: "Capital Calls & Distribution Waterfalls", time: "afternoon", importance: 3, targetHours: 90 },
                            { name: "Operational Value Creation", time: "evening", importance: 3, targetHours: 110 },
                            { name: "Fund Structuring", time: "evening", importance: 3, targetHours: 130 },
                            { name: "Tax Efficiency & Structure Optimization", time: "evening", importance: 2, targetHours: 100 },
                            { name: "Co-Investments & Side Pockets", time: "evening", importance: 2, targetHours: 60 },
                            { name: "Secondaries Investing", time: "evening", importance: 2, targetHours: 80 },
                            { name: "Governance & Board Oversight", time: "evening", importance: 2, targetHours: 70 },
                            { name: "ESG Integration in PE", time: "evening", importance: 1, targetHours: 120 },
                            { name: "M&A Deal Structuring & SPA Review", time: "morning", importance: 5, targetHours: 90 },
                            { name: "LegalâFinancial Translation", time: "morning", importance: 4, targetHours: 50 },
                            { name: "Valuation in Distressed / Illiquid Markets", time: "afternoon", importance: 4, targetHours: 100 },
                            { name: "Alternative Financing Instruments (Mezzanine, PIK, Convertible Prefs)", time: "afternoon", importance: 3, targetHours: 80 },
                            { name: "100-Day Value Creation Plan Design", time: "afternoon", importance: 5, targetHours: 70 },
                            { name: "Operational Turnaround / Lean Management", time: "evening", importance: 4, targetHours: 110 },
                            { name: "Digital Transformation for Portfolio Companies (AI, automation, ERP)", time: "evening", importance: 3, targetHours: 150 },
                            { name: "Regulatory & Policy Intelligence", time: "morning", importance: 4, targetHours: 90 },
                            { name: "Sector Deep Dives (Vertical Expertise)", time: "morning", importance: 4, targetHours: 130 },
                            { name: "Geopolitical / Macro Risk Assessment", time: "evening", importance: 3, targetHours: 80 },
                            { name: "Fundraising Strategy & LP Relations", time: "afternoon", importance: 5, targetHours: 100 },
                            { name: "Limited Partnership Agreement (LPA) & Fund Governance", time: "evening", importance: 4, targetHours: 110 },
                            { name: "Carried Interest / Performance Waterfall Mechanics", time: "evening", importance: 4, targetHours: 70 },
                            { name: "LP Reporting & Performance Benchmarking (IRR, TVPI, PME)", time: "evening", importance: 3, targetHours: 50 }                      
                        ]
                    },
                    "Tools & Software": {
                        icon: "ð ï¸",
                        color: "#c0392b",
                        skills: [
                            { name: "Excel Advanced (VBA, Macros)", time: "morning", importance: 5, targetHours: 100 },
                            { name: "Bloomberg Terminal", time: "afternoon", importance: 4, targetHours: 40 },
                            { name: "PitchBook", time: "afternoon", importance: 4, targetHours: 25 },
                            { name: "FactSet", time: "afternoon", importance: 3, targetHours: 35 },
                            { name: "S&P Capital IQ", time: "afternoon", importance: 3, targetHours: 30 },
                            { name: "Python for Financial / Operational Data Analysis", time: "morning", importance: 4, targetHours: 160 },
                            { name: "Alternative Data for Deal Sourcing (web scraping, hiring signals)", time: "afternoon", importance: 4, targetHours: 80 },
                            { name: "Predictive Modeling for Portfolio Risk (machine learning)", time: "afternoon", importance: 3, targetHours: 140 },
                            { name: "Power BI / Tableau for Portfolio Dashboards", time: "afternoon", importance: 3, targetHours: 60 },
                            { name: "CRM Software (Salesforce, HubSpot) for LP Management", time: "afternoon", importance: 2, targetHours: 30 },
                            { name: "Data Rooms (Intralinks, Datasite) for Due Diligence", time: "afternoon", importance: 3, targetHours: 20 },
                            { name: "PowerPoint Advanced", time: "afternoon", importance: 3, targetHours: 40 }
                        ]
                    },
                    "Soft Skills": {
                        icon: "ð¤",
                        color: "#a93226",
                        skills: [
                            { name: "Strategic Thinking", time: "morning", importance: 4, targetHours: 50 },
                            { name: "Negotiation", time: "evening", importance: 4, targetHours: 100 },
                            { name: "Stakeholder Management", time: "evening", importance: 4, targetHours: 90 },
                            { name: "Presentation Skills", time: "evening", importance: 4, targetHours: 70 },
                            { name: "Leadership", time: "evening", importance: 3, targetHours: 120 },
                            { name: "Crisis Management", time: "evening", importance: 3, targetHours: 60 },
                            { name: "Influence Without Authority", time: "evening", importance: 5, targetHours: 110 },
                            { name: "Boardroom Politics & Power Dynamics", time: "evening", importance: 4, targetHours: 85 },
                            { name: "Tactical Negotiation Psychology", time: "evening", importance: 4, targetHours: 75 },
                            { name: "Media & Narrative Control (Exit / Fundraising)", time: "evening", importance: 3, targetHours: 65 },
                            { name: "Reputation Management in Closed-Door Markets", time: "evening", importance: 3, targetHours: 55 },
                            { name: "Operational Due Diligence Coordination", time: "evening", importance: 3, targetHours: 45 }
                        ]
                    }
                }
            },

            ib: {
                title: "Investment Banking Skills",
                categories: {
                    "Core Finance": {
                        icon: "ð¦",
                        color: "#3498db",
                        skills: [
                            { name: "Financial Modeling", time: "morning", importance: 5, targetHours: 140 },
                            { name: "Valuation", time: "morning", importance: 5, targetHours: 120 },
                            { name: "M&A Advisory", time: "morning", importance: 5, targetHours: 130 },
                            { name: "IPO & Capital Raising", time: "afternoon", importance: 4, targetHours: 90 },
                            { name: "Leveraged Finance", time: "afternoon", importance: 4, targetHours: 100 },
                            { name: "Cap Table Modeling", time: "morning", importance: 4, targetHours: 60 },
                            { name: "Recapitalizations", time: "afternoon", importance: 4, targetHours: 70 },
                            { name: "Debt Restructuring", time: "afternoon", importance: 4, targetHours: 85 },
                            { name: "Industry Research", time: "afternoon", importance: 3, targetHours: 50 },
                            { name: "Syndicated Loans & Club Deals", time: "afternoon", importance: 3, targetHours: 45 },
                            { name: "Rule 144A / Private Placements", time: "afternoon", importance: 3, targetHours: 40 },
                            { name: "Regulatory Filings (S-1, F-1, Prospectus)", time: "afternoon", importance: 3, targetHours: 55 },
                            { name: "Industry-Specific Metrics (EBITDAX, ARR, EBITDA, etc.)", time: "afternoon", importance: 3, targetHours: 35 },
                            { name: "Pitchbook Modeling", time: "evening", importance: 2, targetHours: 30 },
                            { name: "Pitchbook Creation", time: "evening", importance: 2, targetHours: 40 },
                            { name: "LBO Modeling (Base, Sensitivity, Debt Schedules)", time: "morning", importance: 5, targetHours: 110 },
                            { name: "Merger Model (Accretion/Dilution, Synergy Build)", time: "morning", importance: 5, targetHours: 100 },
                            { name: "Credit Analysis (Covenants, Leverage Ratios, Interest Coverage)", time: "afternoon", importance: 4, targetHours: 75 },
                            { name: "Transaction Structuring (Cash vs Stock, Earn-outs, Contingent Payments)", time: "afternoon", importance: 4, targetHours: 65 },
                            { name: "Working Capital & Cash Flow Adjustments", time: "morning", importance: 4, targetHours: 50 },
                            { name: "Purchase Price Allocation (Goodwill, Intangibles, Write-ups)", time: "afternoon", importance: 3, targetHours: 45 },
                            { name: "Fairness Opinion / Board Materials", time: "evening", importance: 3, targetHours: 40 },
                            { name: "Scenario & Sensitivity Analysis", time: "morning", importance: 3, targetHours: 55 },
                            { name: "Tax Considerations in M&A (NOLs, Step-ups, Deferred Tax Liabilities)", time: "afternoon", importance: 3, targetHours: 60 }
                        ]
                    },
                    "Tools & Software": {
                        icon: "ð ï¸",
                        color: "#2980b9",
                        skills: [
                            { name: "Excel Advanced (Macros, VBA, Dynamic Arrays)", time: "morning", importance: 5, targetHours: 120 },
                            { name: "Bloomberg Terminal", time: "afternoon", importance: 4, targetHours: 45 },
                            { name: "Capital IQ", time: "afternoon", importance: 4, targetHours: 40 },
                            { name: "Refinitiv Eikon", time: "afternoon", importance: 4, targetHours: 35 },
                            { name: "Thomson One", time: "afternoon", importance: 3, targetHours: 25 },
                            { name: "FactSet Bond Analytics", time: "afternoon", importance: 3, targetHours: 30 },
                            { name: "DealRoom / Intralinks / SecureDocs", time: "afternoon", importance: 3, targetHours: 20 },
                            { name: "PowerPoint Advanced (Pitchbook Design & Storytelling)", time: "evening", importance: 3, targetHours: 60 },
                            { name: "PitchBook Platform (Deal & PE/VC Data)", time: "afternoon", importance: 4, targetHours: 25 },
                            { name: "Mergermarket / Preqin", time: "afternoon", importance: 3, targetHours: 20 },
                            { name: "Power BI / Tableau (Financial Dashboards)", time: "afternoon", importance: 3, targetHours: 50 },
                            { name: "Python for Financial Analysis", time: "morning", importance: 3, targetHours: 140 },
                            { name: "SQL (Data Extraction & Cleaning for Deal Databases)", time: "morning", importance: 3, targetHours: 80 },
                            { name: "Excel to PowerPoint Automation (VBA + Linking Charts)", time: "evening", importance: 2, targetHours: 35 },
                            { name: "Alteryx / Data Automation (optional)", time: "afternoon", importance: 2, targetHours: 60 },
                            { name: "QuickBooks / Xero (basic)", time: "afternoon", importance: 1, targetHours: 15 }
                        ]
                    },
                    "Soft Skills": {
                        icon: "ð¤",
                        color: "#21618c",
                        skills: [
                            { name: "High-Stakes Presentation to C-suite", time: "evening", importance: 5, targetHours: 90 },
                            { name: "Client Management", time: "evening", importance: 5, targetHours: 110 },
                            { name: "Attention to Detail", time: "morning", importance: 5, targetHours: 40 },
                            { name: "Time Management", time: "evening", importance: 5, targetHours: 25 },
                            { name: "Deadlines under 24h", time: "evening", importance: 5, targetHours: 30 },
                            { name: "Stress Tolerance", time: "evening", importance: 4, targetHours: 35 },
                            { name: "Political Savvy (Office Politics)", time: "evening", importance: 4, targetHours: 70 },
                            { name: "Communication Under Pressure", time: "evening", importance: 3, targetHours: 45 },
                            { name: "Active Listening", time: "evening", importance: 3, targetHours: 30 },
                            { name: "Managing Analyst-to-Associate Handoff", time: "evening", importance: 4, targetHours: 50 },
                            { name: "Stakeholder Mapping (Client vs. Internal vs. Regulator)", time: "evening", importance: 3, targetHours: 55 },
                            { name: "Negotiation under Information Asymmetry", time: "evening", importance: 4, targetHours: 85 },
                            { name: "Conflict Navigation (Cross-Team Politics)", time: "evening", importance: 3, targetHours: 60 },
                            { name: "Strategic Storytelling in Pitches", time: "evening", importance: 4, targetHours: 75 },
                            { name: "Deadline Triage (What to Drop vs. Deliver)", time: "evening", importance: 4, targetHours: 40 },
                            { name: "Precision QA under Fatigue (Night-Shift Review)", time: "night", importance: 5, targetHours: 35 },
                            { name: "Client EQ â Reading Unspoken Objections", time: "evening", importance: 4, targetHours: 65 },
                            { name: "Managing Up (to MDs)", time: "evening", importance: 3, targetHours: 45 }
                        ]
                    }
                }
            },

            hf: {
                title: "Hedge Fund Skills",
                categories: {
                    "Trading & Analysis": {
                        icon: "ð²",
                        color: "#f39c12",
                        skills: [
                            { name: "Fundamental Analysis", time: "morning", importance: 5, targetHours: 120 },
                            { name: "Risk Management (VaR, Max Drawdown, Tail Risk)", time: "morning", importance: 5, targetHours: 100 },
                            { name: "Long/Short Equity Strategy", time: "morning", importance: 5, targetHours: 110 },
                            { name: "Portfolio Construction (Concentration, Correlation, Diversification)", time: "morning", importance: 5, targetHours: 130 },
                            { name: "Market Microstructure (Order Flow, Liquidity, Spread Dynamics)", time: "morning", importance: 4, targetHours: 90 },
                            { name: "Global Macro Strategy", time: "afternoon", importance: 4, targetHours: 140 },
                            { name: "Event-Driven Investing", time: "afternoon", importance: 4, targetHours: 85 },
                            { name: "Distressed Debt Analysis", time: "afternoon", importance: 4, targetHours: 95 },
                            { name: "Options & Derivatives Trading (Greeks, Vol Surface)", time: "afternoon", importance: 4, targetHours: 110 },
                            { name: "Fixed Income & Credit Trading (Yield Curve, Spread Trades)", time: "afternoon", importance: 4, targetHours: 105 },
                            { name: "Short Selling Mechanics & Borrowing Costs", time: "afternoon", importance: 4, targetHours: 70 },
                            { name: "Volatility Arbitrage / VIX Strategies", time: "afternoon", importance: 3, targetHours: 80 },
                            { name: "Event-driven/Activist Investing Analysis", time: "afternoon", importance: 3, targetHours: 75 },
                            { name: "Market Manipulation Tactics (Understanding, Not Participating)", time: "evening", importance: 2, targetHours: 40 },
                            { name: "Sentiment Analysis (News, Social Media, ETF Flows)", time: "evening", importance: 3, targetHours: 65 },
                            { name: "Quantitative Signals & Factor Models", time: "evening", importance: 2, targetHours: 85 }
                        ]
                    },
                    "Execution & Portfolio Diagnostics": {
                        icon: "ð",
                        color: "#d35400",
                        skills: [
                            { name: "Trade Execution & Slippage Management", time: "afternoon", importance: 5, targetHours: 85 },
                            { name: "Performance Attribution (Alpha vs Beta vs Timing)", time: "morning", importance: 5, targetHours: 95 },
                            { name: "Position Sizing & Scaling (Kelly Criterion, Convexity)", time: "morning", importance: 4, targetHours: 75 },
                            { name: "Trade Journaling & Post-Mortem Analysis", time: "evening", importance: 4, targetHours: 45 },
                            { name: "Portfolio Stress Testing (Historical & Hypothetical Scenarios)", time: "morning", importance: 4, targetHours: 80 },
                            { name: "Cross-Asset Hedging Techniques (FX, Options, Futures)", time: "afternoon", importance: 4, targetHours: 100 },
                            { name: "Risk Budgeting & Exposure Decomposition", time: "afternoon", importance: 3, targetHours: 65 },
                            { name: "Transaction Cost Analysis (TCA)", time: "evening", importance: 2, targetHours: 50 }
                        ]
                    },
                    "Quantitative Skills": {
                        icon: "ð§®",
                        color: "#e67e22",
                        skills: [
                            { name: "Python for Finance (Pandas, NumPy, Backtrader)", time: "morning", importance: 5, targetHours: 180 },
                            { name: "Statistical Arbitrage", time: "morning", importance: 5, targetHours: 150 },
                            { name: "Backtesting Strategies (Avoiding Overfitting, Walk-Forward Analysis)", time: "morning", importance: 5, targetHours: 120 },
                            { name: "Time Series Analysis (Stationarity, Cointegration)", time: "morning", importance: 5, targetHours: 110 },
                            { name: "Portfolio Optimization (Markowitz, Black-Litterman)", time: "morning", importance: 4, targetHours: 95 },
                            { name: "Factor Exposure Analysis (Style, Sector, Country)", time: "afternoon", importance: 4, targetHours: 85 },
                            { name: "Financial Econometrics (OLS, VAR, GARCH)", time: "afternoon", importance: 4, targetHours: 105 },
                            { name: "Time Series Forecasting (ARIMA, GARCH)", time: "afternoon", importance: 4, targetHours: 100 },
                            { name: "Monte Carlo Simulation", time: "afternoon", importance: 4, targetHours: 90 },
                            { name: "Risk Parity / Volatility Targeting", time: "afternoon", importance: 3, targetHours: 70 },
                            { name: "AI & Machine Learning (Random Forest, XGBoost, LSTM for Returns)", time: "evening", importance: 3, targetHours: 160 },
                            { name: "SQL Database Management", time: "afternoon", importance: 3, targetHours: 80 },
                            { name: "R for Statistics (ggplot2, quantmod, PerformanceAnalytics)", time: "evening", importance: 2, targetHours: 100 },
                            { name: "API Data Integration (Alpha Vantage, IEX Cloud, Quandl)", time: "evening", importance: 2, targetHours: 45 },
                            { name: "Alternative Data (Web Scraping, Credit Card, Satellite, Job Data)", time: "morning", importance: 4, targetHours: 110 },
                            { name: "Feature Engineering for Market Prediction", time: "morning", importance: 4, targetHours: 95 },
                            { name: "Machine Learning Pipeline (Data Cleaning â Model â Evaluation)", time: "afternoon", importance: 3, targetHours: 130 },
                            { name: "NLP for Financial News / Earnings Call Sentiment", time: "evening", importance: 3, targetHours: 85 },
                            { name: "Backtesting with Realistic Frictions (Latency, Fees, Borrow)", time: "afternoon", importance: 3, targetHours: 75 }
                        ]
                    },
                    "Fund Management & Ops Edge": {
                        icon: "ðµ",
                        color: "#d35400",
                        skills: [
                            { name: "Prime Brokerage & Margin Mechanics", time: "afternoon", importance: 4, targetHours: 70 },
                            { name: "Fund Leverage & Liquidity Management", time: "afternoon", importance: 4, targetHours: 85 },
                            { name: "P&L Attribution & Risk Reports (Daily/Weekly)", time: "morning", importance: 3, targetHours: 55 },
                            { name: "Investor Letters & Transparency Reporting", time: "evening", importance: 2, targetHours: 40 },
                            { name: "Compliance & Trade Surveillance (Understanding Only)", time: "evening", importance: 2, targetHours: 35 },
                            { name: "Capital Allocation Across Strategies", time: "morning", importance: 3, targetHours: 75 }
                        ]
                    },
                    "Behavioral & Mental Edge": {
                        icon: "ð¡",
                        color: "#f1800f",
                        skills: [
                            { name: "Cognitive Bias Control (Recency, Confirmation, Anchoring)", time: "morning", importance: 5, targetHours: 60 },
                            { name: "Emotional Discipline During Drawdowns", time: "evening", importance: 5, targetHours: 55 },
                            { name: "Decision-Making Under Uncertainty", time: "evening", importance: 4, targetHours: 50 },
                            { name: "Probabilistic Thinking (Bayesian Updating)", time: "morning", importance: 4, targetHours: 65 },
                            { name: "Mental Reset Techniques (Post-Loss Recovery)", time: "evening", importance: 3, targetHours: 35 },
                            { name: "Performance Journaling & Pattern Recognition", time: "evening", importance: 3, targetHours: 45 }
                        ]
                    },
                    "Market Knowledge": {
                        icon: "ð",
                        color: "#e67e22",
                        skills: [
                            { name: "Macroeconomics (Business Cycle, Inflation, Interest Rates)", time: "morning", importance: 5, targetHours: 120 },
                            { name: "Central Bank Policy Impact (Fed, ECB, BoE, PBOC)", time: "morning", importance: 5, targetHours: 95 },
                            { name: "Behavioral Finance (Biases, Herding, Overreaction)", time: "morning", importance: 5, targetHours: 70 },
                            { name: "FX & Commodities (Correlations, Carry Trade, Oil-Gold Ratio)", time: "afternoon", importance: 4, targetHours: 85 },
                            { name: "Geopolitical Analysis (Trade Wars, Sanctions, Elections)", time: "afternoon", importance: 4, targetHours: 90 },
                            { name: "Emerging Markets Analysis (Capital Controls, Liquidity Risks)", time: "afternoon", importance: 4, targetHours: 80 },
                            { name: "Liquidity Events & Market Crashes (2008, 2020, 2022)", time: "evening", importance: 4, targetHours: 65 },
                            { name: "Market Regime Detection (Regime Switching Models)", time: "evening", importance: 3, targetHours: 75 },
                            { name: "Institutional Investor Behavior (Index Funds, Hedge Fund Flows)", time: "evening", importance: 3, targetHours: 60 },
                            { name: "Systemic Risk Identification (Shadow Banking, Repo Market Stress)", time: "evening", importance: 3, targetHours: 70 }
                        ]
                    }
                }
            },

            sc: {
                title: "Strategy Consulting Skills",
                categories: {
                    "Core Consulting": {
                        icon: "ð§©",
                        color: "#2ecc71",
                        skills: [
                            { name: "Case Framework Mastery (MECE, Issue Tree, Pyramid Principle)", time: "morning", importance: 5, targetHours: 80 },
                            { name: "Problem Solving (Structured Thinking)", time: "morning", importance: 5, targetHours: 90 },
                            { name: "Market Sizing (Top-down / Bottom-up / Analogous)", time: "morning", importance: 5, targetHours: 65 },
                            { name: "Competitive Analysis (Porterâs Five Forces, SWOT, Strategic Groups)", time: "morning", importance: 4, targetHours: 70 },
                            { name: "Scenario Planning & Sensitivity Analysis", time: "morning", importance: 4, targetHours: 75 },
                            { name: "Go-to-Market (GTM) Strategy", time: "afternoon", importance: 4, targetHours: 85 },
                            { name: "Cost Reduction Strategies", time: "afternoon", importance: 4, targetHours: 80 },
                            { name: "Pricing Strategy & Monetization Models", time: "afternoon", importance: 4, targetHours: 95 },
                            { name: "Business Restructuring", time: "afternoon", importance: 4, targetHours: 100 },
                            { name: "Corporate Restructuring Strategy", time: "afternoon", importance: 3, targetHours: 90 },
                            { name: "Digital Transformation", time: "afternoon", importance: 3, targetHours: 110 },
                            { name: "M&A Advisory", time: "afternoon", importance: 3, targetHours: 85 },
                            { name: "M&A Integration Planning", time: "evening", importance: 2, targetHours: 70 },
                            { name: "Value Chain Optimization", time: "evening", importance: 2, targetHours: 75 }
                        ]
                    },
                    "Data & Analytics": {
                        icon: "ð",
                        color: "#27ae60",
                        skills: [
                            { name: "Excel Advanced (Modeling, Dashboards, Dynamic Arrays)", time: "morning", importance: 5, targetHours: 90 },
                            { name: "ROI Analysis (NPV, IRR, Payback Period)", time: "morning", importance: 5, targetHours: 60 },
                            { name: "Data Analysis (Cleaning, Aggregation, Insight Extraction)", time: "morning", importance: 4, targetHours: 75 },
                            { name: "Process Mapping (BPMN, Swimlane Diagrams)", time: "morning", importance: 4, targetHours: 45 },
                            { name: "Scenario Modeling (What-if, Monte Carlo)", time: "morning", importance: 4, targetHours: 70 },
                            { name: "SQL", time: "afternoon", importance: 4, targetHours: 80 },
                            { name: "Tableau / Power BI", time: "afternoon", importance: 4, targetHours: 65 },
                            { name: "Predictive Modeling (Churn, CLV)", time: "afternoon", importance: 3, targetHours: 85 },
                            { name: "Customer Segmentation & RFM Analysis", time: "afternoon", importance: 3, targetHours: 55 },
                            { name: "Statistical Analysis (Regression, Correlation, Hypothesis Testing)", time: "afternoon", importance: 3, targetHours: 75 },
                            { name: "A/B Testing Design", time: "evening", importance: 2, targetHours: 40 }
                        ]
                    },
                    "Execution & Implementation": {
                        icon: "ð",
                        color: "#1abc9c",
                        skills: [
                            { name: "PMO Design & Implementation Tracking", time: "afternoon", importance: 5, targetHours: 85 },
                            { name: "KPI Tree Design & Performance Dashboarding", time: "morning", importance: 4, targetHours: 70 },
                            { name: "Change Management & Stakeholder Buy-in", time: "evening", importance: 4, targetHours: 90 },
                            { name: "Operational Excellence (Lean, Six Sigma, Kaizen)", time: "afternoon", importance: 3, targetHours: 95 },
                            { name: "Business Process Reengineering (BPR)", time: "afternoon", importance: 3, targetHours: 100 },
                            { name: "Implementation Roadmapping (Quick Wins â Long-term Impact)", time: "evening", importance: 3, targetHours: 75 }
                        ]
                    },
                    "Industry Expertise & Insight Generation": {
                        icon: "ðï¸",
                        color: "#16a085",
                        skills: [
                            { name: "Industry Benchmarking & Peer Analysis", time: "morning", importance: 5, targetHours: 80 },
                            { name: "Market Trend Forecasting (TAM, CAGR, Disruption)", time: "morning", importance: 4, targetHours: 95 },
                            { name: "Consumer Behavior & Demand Drivers", time: "afternoon", importance: 4, targetHours: 85 },
                            { name: "Value Pool Mapping by Sector", time: "afternoon", importance: 3, targetHours: 70 },
                            { name: "Geopolitical & Regulatory Impacts on Strategy", time: "evening", importance: 3, targetHours: 75 }                        
                        ]
                    },
                    "Advanced Strategic Thinking": {
                        icon: "ð",
                        color: "#81b214",
                        skills: [
                            { name: "Game Theory & Competitive Signaling", time: "morning", importance: 5, targetHours: 90 },
                            { name: "Incentive Design & Organizational Behavior", time: "morning", importance: 4, targetHours: 85 },
                            { name: "Systems Thinking (Feedback Loops, Second-Order Effects)", time: "morning", importance: 4, targetHours: 95 },
                            { name: "Scenario Narrative Development (Strategic Storytelling)", time: "evening", importance: 4, targetHours: 80 },
                            { name: "War-Gaming & Competitor Simulation", time: "afternoon", importance: 3, targetHours: 75 }
                        ]
                    },                    
                    "Client Power Dynamics & Influence": {
                        icon: "ð¥",
                        color: "#a8c545",
                        skills: [
                            { name: "Boardroom Politics & Power Mapping", time: "evening", importance: 5, targetHours: 85 },
                            { name: "Influence Without Authority (Client & Internal)", time: "evening", importance: 4, targetHours: 90 },
                            { name: "Managing Difficult Clients & Expectation Control", time: "evening", importance: 4, targetHours: 80 },
                            { name: "High-Stakes Negotiation (Budget, Scope, Timeline)", time: "evening", importance: 3, targetHours: 70 },
                            { name: "Narrative Control & Framing Strategy", time: "evening", importance: 3, targetHours: 65 }
                        ]
                    },                     
                    "Communication": {
                        icon: "ð¬",
                        color: "#59e099",
                        skills: [
                            { name: "Storytelling with Data", time: "evening", importance: 5, targetHours: 85 },
                            { name: "Presentation Skills (Client-ready Slides)", time: "evening", importance: 5, targetHours: 80 },
                            { name: "Executive Presence (Confidence, Poise, Authority)", time: "evening", importance: 5, targetHours: 90 },
                            { name: "Client Communication (Asking the Right Questions)", time: "evening", importance: 5, targetHours: 75 },
                            { name: "Managing Up (Communicating with Partners)", time: "evening", importance: 5, targetHours: 70 },
                            { name: "Stakeholder Alignment (Influencing Without Authority)", time: "evening", importance: 4, targetHours: 80 },
                            { name: "Facilitation Skills (Running Workshops, Brainstorms)", time: "evening", importance: 4, targetHours: 65 },
                            { name: "Visual Thinking & Slide Design Principles (MECE, Pyramid, One Idea per Slide)", time: "evening", importance: 4, targetHours: 60 },
                            { name: "Conflict Resolution in Teams", time: "evening", importance: 4, targetHours: 55 },
                            { name: "Active Listening", time: "evening", importance: 3, targetHours: 40 },
                            { name: "Giving & Receiving Feedback", time: "evening", importance: 3, targetHours: 45 },
                            { name: "Adaptability to Client Culture", time: "evening", importance: 3, targetHours: 50 }
                        ]
                    }
                }
            },

            fintech: {
                title: "Fintech Skills",
                categories: {
                    "Core Finance for Fintech": {
                        icon: "ð³",
                        color: "#00e5ff",
                        skills: [
                            { name: "Credit Scoring Models (Alternative Data)", time: "morning", importance: 5, targetHours: 120 },
                            { name: "Micro-lending & BNPL Risk Modeling", time: "morning", importance: 5, targetHours: 110 },
                            { name: "Interest Rate Risk in Digital Lending", time: "morning", importance: 5, targetHours: 95 },
                            { name: "Financial Products (Payments, Lending, Insurance)", time: "morning", importance: 4, targetHours: 85 },
                            { name: "Corporate Finance Basics (BS, Cash Flow, Credit Risk)", time: "morning", importance: 4, targetHours: 70 },
                            { name: "Banking Infrastructure (Core Systems, Payment Rails)", time: "afternoon", importance: 4, targetHours: 90 },
                            { name: "Embedded Finance Architecture (API-driven banking)", time: "afternoon", importance: 4, targetHours: 100 },
                            { name: "Treasury & Liquidity Management", time: "afternoon", importance: 3, targetHours: 75 },
                            { name: "Capital Markets Infrastructure (Settlement, Clearing)", time: "afternoon", importance: 3, targetHours: 80 },
                            { name: "Risk & Compliance (KYC, AML, Basel III)", time: "evening", importance: 3, targetHours: 95 },
                            { name: "Consumer Protection Laws (Fair Lending, Transparency)", time: "evening", importance: 2, targetHours: 50 },
                            { name: "Financial Inclusion Regulations", time: "evening", importance: 2, targetHours: 45 }
                        ]
                    },
                    "Technology & Data": {
                        icon: "ð±",
                        color: "#00b8ff",
                        skills: [
                            { name: "Python for Finance (pandas, NumPy, scikit-learn)", time: "morning", importance: 5, targetHours: 160 },
                            { name: "SQL & Databases (Relational, Query Optimization)", time: "morning", importance: 5, targetHours: 100 },
                            { name: "Machine Learning (Fraud Detection, Credit Scoring, Robo-advisors)", time: "morning", importance: 5, targetHours: 180 },
                            { name: "Data Analytics (Tableau/Power BI for Business Insights)", time: "morning", importance: 4, targetHours: 70 },
                            { name: "APIs & Integration (REST, Open Banking, Webhooks)", time: "morning", importance: 4, targetHours: 85 },
                            { name: "Real-time Processing (Kafka, Spark Streaming)", time: "afternoon", importance: 4, targetHours: 110 },
                            { name: "Data Engineering (ETL, Pipelines, Warehousing)", time: "afternoon", importance: 4, targetHours: 120 },
                            { name: "NoSQL Databases (MongoDB, Cassandra)", time: "afternoon", importance: 3, targetHours: 65 },
                            { name: "Cloud Computing (AWS, Azure, GCP)", time: "afternoon", importance: 3, targetHours: 90 },
                            { name: "API Security (OAuth, JWT, RBAC)", time: "evening", importance: 3, targetHours: 55 },
                            { name: "Cybersecurity Fundamentals (DDoS, Phishing, Zero Trust)", time: "evening", importance: 3, targetHours: 60 },
                            { name: "DevOps & CI/CD Pipelines", time: "evening", importance: 2, targetHours: 75 },
                            { name: "Cloud & DevOps Awareness", time: "evening", importance: 2, targetHours: 40 }
                        ]
                    },
                    "Fintech Business Models": {
                        icon: "ð»",
                        color: "#7cffff",
                        skills: [
                            { name: "Payments (Stripe, Momo, VNPay)", time: "morning", importance: 5, targetHours: 100 },
                            { name: "Lending & Credit (P2P, BNPL)", time: "morning", importance: 5, targetHours: 120 },
                            { name: "Neobanks (Digital-Only Banks)", time: "morning", importance: 5, targetHours: 110 },
                            { name: "Embedded Finance", time: "morning", importance: 5, targetHours: 90 },
                            { name: "Product Analytics Metrics (CAC, LTV, Churn, NRR)", time: "morning", importance: 5, targetHours: 80 },
                            { name: "WealthTech (Robo-advisors)", time: "afternoon", importance: 4, targetHours: 95 },
                            { name: "InsurTech", time: "afternoon", importance: 4, targetHours: 100 },
                            { name: "RegTech (Automated Compliance)", time: "afternoon", importance: 3, targetHours: 85 },
                            { name: "AI-Powered Personal Finance Apps", time: "afternoon", importance: 3, targetHours: 75 },
                            { name: "BNPL-as-a-Service (BaaS)", time: "afternoon", importance: 3, targetHours: 70 },
                            { name: "Crypto Wallets & Custody Solutions", time: "evening", importance: 2, targetHours: 60 },
                            { name: "Blockchain & DeFi (Smart Contracts, Yield Farming)", time: "evening", importance: 2, targetHours: 130 }
                        ]
                    },
                    "Regulation & Policy": {
                        icon: "âï¸",
                        color: "#8be2fe",
                        skills: [
                            { name: "Open Banking / PSD2", time: "evening", importance: 5, targetHours: 110 },
                            { name: "Anti-Money Laundering (AML) Tech", time: "evening", importance: 5, targetHours: 120 },
                            { name: "Data Protection (GDPR, PDPA)", time: "evening", importance: 5, targetHours: 100 },
                            { name: "Digital Banking Licenses", time: "evening", importance: 4, targetHours: 90 },
                            { name: "Consumer Protection Laws (Fair Lending, Transparency)", time: "evening", importance: 4, targetHours: 85 },
                            { name: "Crypto Regulations (SEC, MiCA)", time: "evening", importance: 4, targetHours: 130 },
                            { name: "Central Bank Digital Currencies (CBDC)", time: "evening", importance: 3, targetHours: 75 },
                            { name: "Cross-border Payments Regulation", time: "evening", importance: 3, targetHours: 70 },
                            { name: "Financial Inclusion Regulations", time: "evening", importance: 3, targetHours: 60 },
                            { name: "Basel III Implementation in Fintech", time: "evening", importance: 2, targetHours: 95 }
                        ]
                   },
                    "Product & Growth Optimization": {
                        icon: "â¬ï¸",
                        color: "#5efcff",
                        skills: [
                            { name: "Conversion Funnel Optimization (AARRR Framework)", time: "afternoon", importance: 4, targetHours: 90 },
                            { name: "User Retention & Engagement Loops", time: "afternoon", importance: 4, targetHours: 100 },
                            { name: "Pricing Experiments & Dynamic Pricing Models", time: "afternoon", importance: 3, targetHours: 85 },
                            { name: "Unit Economics Modeling (CAC/LTV Breakeven, Contribution Margin)", time: "morning", importance: 5, targetHours: 110 },
                            { name: "Behavioral Economics in Fintech (Nudges, Defaults, Frictions)", time: "afternoon", importance: 3, targetHours: 70 },
                            { name: "Growth Analytics (Cohort, Retention, Churn)", time: "morning", importance: 4, targetHours: 95 }
                        ]
                    },
                    "AI x Finance": {
                        icon: "ð¤",
                        color: "#3deaff",
                        skills: [
                            { name: "AI Strategy for Financial Products (Explainability, Bias, Ethics)", time: "morning", importance: 4, targetHours: 100 },
                            { name: "Generative AI in Finance (Chatbots, Report Automation)", time: "afternoon", importance: 3, targetHours: 85 },
                            { name: "LLMs for Credit Scoring & Risk Monitoring", time: "morning", importance: 3, targetHours: 110 },
                            { name: "Feature Engineering for Financial Data", time: "morning", importance: 4, targetHours: 120 },
                            { name: "Alternative Data Integration (Social, Geolocation, Mobile)", time: "morning", importance: 4, targetHours: 105 }
                        ]
                    },
                    "Payments Infrastructure Deep Dive": {
                        icon: "ð",
                        color: "#2be6ff",
                        skills: [
                            { name: "ISO 20022 & SWIFT Messaging Standards", time: "afternoon", importance: 4, targetHours: 95 },
                            { name: "Card Networks (Visa/Mastercard/BIN Management)", time: "afternoon", importance: 3, targetHours: 70 },
                            { name: "Real-time Payments (RTP, PIX, FAST, UPI)", time: "afternoon", importance: 4, targetHours: 90 },
                            { name: "Settlement Risk & Reconciliation Processes", time: "evening", importance: 3, targetHours: 80 },
                            { name: "Cross-border FX Infrastructure (Wise, Revolut)", time: "evening", importance: 3, targetHours: 85 }
                        ]
                    },
                    "Governance, Risk & Compliance": {
                        icon: "ð",
                        color: "#1affff",
                        skills: [
                            { name: "Model Risk Management (SR 11-7, Model Validation)", time: "afternoon", importance: 4, targetHours: 110 },
                            { name: "Operational Risk & Resilience in Digital Banks", time: "afternoon", importance: 4, targetHours: 100 },
                            { name: "Third-party Risk (Vendor Management, Cloud Risks)", time: "evening", importance: 3, targetHours: 85 },
                            { name: "Fraud Operations & Chargeback Management", time: "evening", importance: 3, targetHours: 90 }
                        ]
                    },                    
                    "Capital Strategy & Fintech Economics": {
                        icon: "ð²",
                        color: "#00ffff",
                        skills: [
                            { name: "Fintech Valuation Models (Unit Economics, LTV/CAC Multiple)", time: "morning", importance: 5, targetHours: 130 },
                            { name: "Revenue Modeling for Transaction-based Businesses", time: "morning", importance: 4, targetHours: 105 },
                            { name: "Regulatory Capital Optimization (Tier 1, Leverage Ratio)", time: "afternoon", importance: 3, targetHours: 95 },
                            { name: "Investor Reporting & Metrics (ARR, NRR, Take Rate)", time: "afternoon", importance: 4, targetHours: 80 }
                        ]
                    },
                    "Professional & Strategic Skills": {
                    icon: "ð¡",
                    color: "#00eaff",
                    skills: [
                            { name: "Product Management (MVP, Scaling, Roadmap)", time: "evening", importance: 5, targetHours: 150 },
                            { name: "Metrics-Driven Decision Making (CAC, LTV, Churn, NRR)", time: "evening", importance: 5, targetHours: 100 },
                            { name: "Strategic Thinking (Disruption, Platform Effects)", time: "evening", importance: 5, targetHours: 120 },
                            { name: "Pitching to Investors (VC, PE, Corporate VC)", time: "evening", importance: 5, targetHours: 90 },
                            { name: "Fundraising & Venture Finance", time: "evening", importance: 5, targetHours: 110 },
                            { name: "Agile & Scrum", time: "evening", importance: 4, targetHours: 70 },
                            { name: "Lean Startup Methodology", time: "evening", importance: 4, targetHours: 60 },
                            { name: "UX/UI in Fintech (Trust, Simplicity, Accessibility)", time: "evening", importance: 4, targetHours: 95 },
                            { name: "Partnerships & Ecosystem Building", time: "evening", importance: 4, targetHours: 85 },
                            { name: "Cross-functional Collaboration (Engineering Ã Legal Ã Marketing)", time: "evening", importance: 3, targetHours: 65 },
                            { name: "Stakeholder Alignment (Internal & External)", time: "evening", importance: 3, targetHours: 75 },
                            { name: "Adaptability to Regulatory Shifts", time: "evening", importance: 3, targetHours: 55 }
                       ]
                    }
                }
            },

            english: {
                title: "English Skills",
                categories: {
                    "Core Language": {
                        icon: "ð",
                        color: "#ffff00",
                        skills: [
                            { name: "Financial Terminology and Jargon", time: "morning", importance: 5, targetHours: 120 },
                            { name: "Business Vocabulary", time: "morning", importance: 5, targetHours: 100 },
                            { name: "Advanced Grammar (Conditionals, Inversion, Passive Voice in Reports)", time: "morning", importance: 4, targetHours: 90 },
                            { name: "Reading Comprehension (WSJ, FT, McKinsey Reports)", time: "morning", importance: 4, targetHours: 110 },
                            { name: "Academic Writing", time: "morning", importance: 4, targetHours: 130 },
                            { name: "Negotiation English (Phrasal Verbs, Persuasive Language, Softening Requests)", time: "afternoon", importance: 3, targetHours: 85 },
                            { name: "Idioms in Business Context", time: "afternoon", importance: 3, targetHours: 60 }
                        ]
                    },
                    "Speaking & Listening": {
                        icon: "ð¤",
                        color: "#ffff19",
                        skills: [
                            { name: "Business Presentations (Clarity, Structure, Storytelling)", time: "evening", importance: 5, targetHours: 140 },
                            { name: "Interview Skills (STAR Method, Behavioral Questions, Case Interviews)", time: "evening", importance: 4, targetHours: 100 },
                            { name: "Handling Difficult Questions (Q&A under Pressure)", time: "evening", importance: 4, targetHours: 90 },
                            { name: "Academic Listening (Listen to university lectures and academic discussions)", time: "morning", importance: 5, targetHours: 120 },
                            { name: "Active Listening", time: "afternoon", importance: 4, targetHours: 80 },
                            { name: "Diverse Content (Listen to a wide range of content, including podcasts, news broadcasts, movies, TV shows and audiobooks)", time: "afternoon", importance: 3, targetHours: 150 },
                            { name: "Specific Skill Practice (Practice listening for the main idea, details, and context. Listen to various accents to get used to different pronunciations and rhythms.)", time: "afternoon", importance: 3, targetHours: 110 },
                            { name: "Pronunciation & Intonation (Practice the correct pronunciation of individual sounds and words. Pay attention to intonation (the rise and fall of your voice) to sound more natural)", time: "morning", importance: 4, targetHours: 100 },
                            { name: "Fluency & Cohesion (Focus on speaking smoothly without long pauses. Use transition words and phrases to connect your ideas logically and make your speech flow.)", time: "morning", importance: 5, targetHours: 130 },
                            { name: "Vocabulary & Grammar (Use a wide range of vocabulary and grammatical structures. Try to incorporate new words you've learned into your daily conversations.)", time: "afternoon", importance: 5, targetHours: 160 },
                            { name: "Public Speaking & Presentations (Practice giving short talks or presentations on topics you know well. This helps you organize your thoughts and speak more confidently.)", time: "evening", importance: 5, targetHours: 120 }
                        ]
                    },
                    "Professional Skills": {
                        icon: "ð¼",
                        color: "#ffff33",
                        skills: [
                            { name: "Email Communication (Professional Tone, Subject Lines, Call-to-Action)", time: "evening", importance: 5, targetHours: 80 },
                            { name: "Report Writing (Executive Summary, Data Visualization Narratives)", time: "evening", importance: 5, targetHours: 120 },
                            { name: "Writing Executive Summaries", time: "evening", importance: 5, targetHours: 70 },
                            { name: "Business Writing Templates (Memos, Investment Notes, Project Updates)", time: "evening", importance: 5, targetHours: 90 },
                            { name: "Data Presentation and Analysis", time: "evening", importance: 4, targetHours: 100 },
                            { name: "Cross-cultural Communication (US Direct vs Japan Indirect, UK Politeness)", time: "evening", importance: 4, targetHours: 85 },
                            { name: "Negotiation and Persuasion", time: "evening", importance: 4, targetHours: 110 },
                            { name: "Professional Fluency and Idioms", time: "afternoon", importance: 3, targetHours: 65 }
                        ]
                    }
                }
            },

            chinese: {
              title: "Chinese",  
              categories: {
                "åºç¡æ±è¯­ (CÆ¡ báº£n)": { 
                  icon: "ð",
                  color: "#00ffe7",
                  skills: [
                    { name: "æ¼é³ (Pinyin - PhÃ¡t Ã¢m)", time: "morning", importance: 5, targetHours: 80 },
                    { name: "æ±å­ (HÃ¡n tá»± - Nháº­n diá»n & Viáº¿t)", time: "morning", importance: 5, targetHours: 300 },
                    { name: "åºç¡è¯­æ³ (Ngá»¯ phÃ¡p cÆ¡ báº£n)", time: "afternoon", importance: 4, targetHours: 100 },
                    { name: "æ¥å¸¸è¯æ± (Tá»« vá»±ng hÃ ng ngÃ y)", time: "morning", importance: 5, targetHours: 200 },
                    { name: "æ°å­ä¸æ¥æ (Sá» Äáº¿m & NgÃ y thÃ¡ng)", time: "morning", importance: 4, targetHours: 30 }
                  ]
                },
                "å¬è¯´è½å (Nghe - NÃ³i)": { 
                  icon: "ð£ï¸",
                  color: "#00fffd",
                  skills: [
                    { name: "æ¥å¸¸å¯¹è¯ (Há»i thoáº¡i hÃ ng ngÃ y)", time: "evening", importance: 5, targetHours: 250 },
                    { name: "åé³ä¸è¯­è° (PhÃ¡t Ã¢m & Ngá»¯ Äiá»u)", time: "morning", importance: 4, targetHours: 120 },
                    { name: "æµå©åº¦ä¸è¿è´¯æ§ (Äá» lÆ°u loÃ¡t & Máº¡ch láº¡c)", time: "morning", importance: 4, targetHours: 180 },
                    { name: "åå¡å¬å (Nghe hiá»u ngá»¯ cáº£nh kinh doanh)", time: "afternoon", importance: 4, targetHours: 150 },
                    { name: "ä¸»å¨å¾å¬ (Láº¯ng nghe chá»§ Äá»ng)", time: "afternoon", importance: 3, targetHours: 80 }
                  ]
                },
                "è¯»åè½å (Äá»c - Viáº¿t)": { 
                  icon: "ð",
                  color: "#00ecff",
                  skills: [
                    { name: "éè¯»çè§£ (Äá»c hiá»u)", time: "afternoon", importance: 5, targetHours: 220 },
                    { name: "æ±å­ä¹¦å (Viáº¿t HÃ¡n tá»±)", time: "evening", importance: 4, targetHours: 180 },
                    { name: "åå¡é®ä»¶åä½ (Viáº¿t email kinh doanh)", time: "evening", importance: 4, targetHours: 120 },
                    { name: "ç®ä½å­ä¸ç¹ä½å­ (HÃ¡n giáº£n thá» & Phá»n thá»)", time: "afternoon", importance: 3, targetHours: 90 },
                    { name: "æåè¯­å¢çè§£ (Hiá»u ngá»¯ cáº£nh vÄn hÃ³a)", time: "evening", importance: 3, targetHours: 80 }
                  ]
                },
                "éèä¸æç¥ä¸­æ (Finance & Strategy Chinese)": { 
                  icon: "ð¡",
                  color: "#89ffea",
                  skills: [
                    { name: "éèæ¯è¯­ (Thuáº­t ngá»¯ tÃ i chÃ­nh)", time: "morning", importance: 5, targetHours: 160 },
                    { name: "æèµæ¥åéè¯» (Äá»c hiá»u bÃ¡o cÃ¡o Äáº§u tÆ°)", time: "afternoon", importance: 4, targetHours: 140 },
                    { name: "å¬å¸æ²»çä¸æ³è§è¯æ± (Thuáº­t ngá»¯ phÃ¡p lÃ½ & quáº£n trá»)", time: "afternoon", importance: 3, targetHours: 110 },
                    { name: "è´¢å¡æ¥è¡¨ç¨è¯­ (NgÃ´n ngá»¯ bÃ¡o cÃ¡o tÃ i chÃ­nh)", time: "morning", importance: 4, targetHours: 130 },
                    { name: "å¹¶è´­ä¸è°å¤ç¨è¯­ (NgÃ´n ngá»¯ M&A & ÄÃ m phÃ¡n)", time: "evening", importance: 5, targetHours: 150 },
                    { name: "å¸åºè¶å¿è¡¨è¾¾ (MÃ´ táº£ xu hÆ°á»ng kinh táº¿, tÃ i chÃ­nh)", time: "evening", importance: 4, targetHours: 120 }
                  ]
                },
                "é«é¶è¡¨è¾¾ (Advanced Expression & Precision)": { 
                  icon: "ð",
                  color: "#9dfree",
                  skills: [
                    { name: "é«çº§è¯æ±ä¸æè¯­ (Tá»« vá»±ng nÃ¢ng cao & ThÃ nh ngá»¯)", time: "morning", importance: 5, targetHours: 200 },
                    { name: "è¯­æ°ä¸è¯­æ (Cáº£m giÃ¡c ngá»¯ Äiá»u & Ngá»¯ khÃ­)", time: "morning", importance: 4, targetHours: 180 },
                    { name: "ä¹¦é¢è¡¨è¾¾æå·§ (Ká»¹ nÄng viáº¿t formal)", time: "afternoon", importance: 4, targetHours: 160 },
                    { name: "å¬ä¼æ¼è®²ä¸è¯´æ (Diá»n thuyáº¿t & Thuyáº¿t phá»¥c)", time: "evening", importance: 4, targetHours: 220 },
                    { name: "é»è¾è¡¨è¾¾ (TrÃ¬nh bÃ y tÆ° duy logic báº±ng tiáº¿ng Trung)", time: "morning", importance: 4, targetHours: 190 }                  
                  ]
                },                
                "æåä¸äººèç­ç¥ (Cultural Intelligence & Guanxi Strategy)": { 
                  icon: "ð®",
                  color: "#62ffea",
                  skills: [
                    { name: "å³ç³»ç®¡ç (Guanxi â Nghá» thuáº­t xÃ¢y dá»±ng quan há»)", time: "evening", importance: 5, targetHours: 150 },
                    { name: "é¢å­æå (Face Culture â Giá»¯ thá» diá»n & chiáº¿n lÆ°á»£c lá»i nÃ³i)", time: "evening", importance: 4, targetHours: 120 },
                    { name: "é´æ¥è¡¨è¾¾ä¸å«èæ²é (CÃ¡ch nÃ³i vÃ²ng, uyá»n chuyá»n)", time: "evening", importance: 4, targetHours: 130 },
                    { name: "ç¤¾ä¼ç­çº§ä¸ç§°å¼ (CÃ¡ch xÆ°ng hÃ´ theo cáº¥p báº­c)", time: "afternoon", importance: 3, targetHours: 80 },
                    { name: "ä¸­è¥¿æåå·®å¼ (KhÃ¡c biá»t vÄn hÃ³a Trung â TÃ¢y)", time: "afternoon", importance: 3, targetHours: 90 }
                  ]
                },
                "åå¡ä¸­æ (Kinh doanh)": { 
                  icon: "ð",
                  color: "#4effe0",
                  skills: [
                    { name: "åå¡ä¼è®® (Há»p kinh doanh)", time: "evening", importance: 5 },
                    { name: "åå¡è°å¤ (ÄÃ m phÃ¡n kinh doanh)", time: "evening", importance: 5 },
                    { name: "é¡¹ç®ä»ç» (Giá»i thiá»u dá»± Ã¡n)", time: "evening", importance: 4 },
                    { name: "è¡ä¸æ¯è¯­ (Thuáº­t ngá»¯ chuyÃªn ngÃ nh)", time: "afternoon", importance: 4 },
                    { name: "è·¨æåæ²é (Giao tiáº¿p xuyÃªn vÄn hÃ³a)", time: "evening", importance: 4 }
                  ]
                }
              }
            },

            tools: {
                title: "Finance Tools",
                categories: {
                    "Programming & Data": {
                        icon: "ð»",
                        color: "#3b82f6",
                        skills: [
                            { name: "Python for Finance (pandas, NumPy, matplotlib)", time: "morning", importance: 5, targetHours: 180 },
                            { name: "SQL for Data Analysis (joins, CTEs, window functions)", time: "morning", importance: 5, targetHours: 100 },
                            { name: "R for Statistics (ggplot2, quantmod)", time: "afternoon", importance: 4, targetHours: 120 },
                            { name: "VBA for Excel Automation", time: "afternoon", importance: 4, targetHours: 80 },
                            { name: "Git & Version Control", time: "evening", importance: 3, targetHours: 40 },
                            { name: "Jupyter Notebook / VS Code with Finance extensions", time: "morning", importance: 4, targetHours: 60 },
                            { name: "Financial APIs (Alpha Vantage, IEX Cloud, Yahoo Finance)", time: "afternoon", importance: 3, targetHours: 50 }
                        ]
                    },
                    "Spreadsheets & BI": {
                        icon: "ð",
                        color: "#10b981",
                        skills: [
                            { name: "Excel Advanced (Power Query, Pivot Tables, Array Formulas)", time: "morning", importance: 5, targetHours: 120 },
                            { name: "Power BI (DAX, Power Query, Dashboards)", time: "afternoon", importance: 5, targetHours: 100 },
                            { name: "Tableau (Calculated Fields, LOD Expressions)", time: "afternoon", importance: 4, targetHours: 80 },
                            { name: "Google Sheets (Apps Script, ImportRange)", time: "evening", importance: 3, targetHours: 50 },
                            { name: "Excel Power Pivot (Data Model, Basic DAX)", time: "morning", importance: 4, targetHours: 55 },
                            { name: "Google Apps Script (Automate Sheets, Gmail)", time: "evening", importance: 3, targetHours: 40 }
                        ]
                    },
                    "Financial Platforms": {
                        icon: "ð¦",
                        color: "#f59e0b",
                        skills: [
                            { name: "Bloomberg Terminal (BQL, DAPI)", time: "afternoon", importance: 5, targetHours: 60 },
                            { name: "Capital IQ (Excel Plugin, Screening)", time: "afternoon", importance: 5, targetHours: 50 },
                            { name: "FactSet (Formula Builder, Analytics)", time: "afternoon", importance: 4, targetHours: 45 },
                            { name: "Refinitiv Eikon / Refinitiv Workspace", time: "afternoon", importance: 4, targetHours: 45 },
                            { name: "PitchBook Platform", time: "evening", importance: 3, targetHours: 30 },
                            { name: "Reuters Eikon", time: "afternoon", importance: 4, targetHours: 45 },
                            { name: "Morningstar Direct / Alternatives", time: "afternoon", importance: 3, targetHours: 35 }
                        ]
                    },
                    "Specialized Tools": {
                        icon: "ð§",
                        color: "#8b5cf6",
                        skills: [
                            { name: "Alteryx (Data Blending, Workflows)", time: "afternoon", importance: 3, targetHours: 70 },
                            { name: "MATLAB for Quantitative Finance", time: "morning", importance: 3, targetHours: 100 },
                            { name: "Jupyter Notebooks (Documentation, Reproducibility)", time: "evening", importance: 4, targetHours: 50 },
                            { name: "Docker & Cloud Deployment (AWS, Azure)", time: "evening", importance: 2, targetHours: 80 }
                        ]
                    },
                    "Accounting & ERP Systems": {
                        icon: "ð",
                        color: "#9d4edd",
                        skills: [
                            { name: "QuickBooks / Xero (Financial Statements, Reconciliation)", time: "morning", importance: 4, targetHours: 60 },
                            { name: "SAP ERP (FI/CO modules - Report reading, Data extraction)", time: "afternoon", importance: 4, targetHours: 70 },
                            { name: "Oracle NetSuite (Multi-currency, Consolidation)", time: "afternoon", importance: 3, targetHours: 50 },
                            { name: "Microsoft Dynamics 365 Finance", time: "evening", importance: 3, targetHours: 45 },
                            { name: "Local Accounting Software (MISA, FAST)", time: "morning", importance: 4, targetHours: 40 }
                        ]
                    },
                    "Financial Modeling Templates": {
                        icon: "ð",
                        color: "#ff6d00",
                        skills: [
                            { name: "Macabacus / Wall Street Prep Templates (Best Practice)", time: "morning", importance: 5, targetHours: 40 },
                            { name: "Custom Excel Add-ins (REFS, FV, TTS)", time: "afternoon", importance: 4, targetHours: 35 },
                            { name: "PPT/Excel Integration (Linking, Update Automation)", time: "afternoon", importance: 4, targetHours: 30 },
                            { name: "Financial Model Auditing Tools", time: "evening", importance: 3, targetHours: 25 }
                        ]
                    },
                    "Data Extraction & Automation": {
                        icon: "ð·ï¸",
                        color: "#00b4d8",
                        skills: [
                            { name: "Python BeautifulSoup/Selenium (Web Scraping)", time: "morning", importance: 4, targetHours: 80 },
                            { name: "Octoparse / ParseHub (No-code Scraping)", time: "afternoon", importance: 3, targetHours: 40 },
                            { name: "PDF Data Extraction (Tabula, Camelot)", time: "afternoon", importance: 3, targetHours: 35 },
                            { name: "OCR for Financial Documents (ABBYY, Tesseract)", time: "evening", importance: 2, targetHours: 30 },
                            { name: "Power Automate (MS Flow)", time: "afternoon", importance: 4, targetHours: 45 },
                            { name: "Zapier / Make (Integration Automation)", time: "evening", importance: 3, targetHours: 40 }
                        ]
                    },
                    "Deal Management & Collaboration": {
                        icon: "ð¤",
                        color: "#ff9e00",
                        skills: [
                            { name: "Virtual Data Rooms (Datasite, Intralinks, Merrill)", time: "afternoon", importance: 4, targetHours: 25 },
                            { name: "Deal Management Software (DealCloud, Affinity)", time: "afternoon", importance: 3, targetHours: 30 },
                            { name: "DocuSign / Adobe Sign (E-signature Workflows)", time: "evening", importance: 3, targetHours: 15 },
                            { name: "MS Teams / Slack Integration with Finance Tools", time: "evening", importance: 3, targetHours: 20 }
                        ]
                    },
                    "Visualization & Presentation": {
                        icon: "ð¨",
                        color: "#ff0054",
                        skills: [
                            { name: "Think-Cell (PowerPoint Charts Automation)", time: "afternoon", importance: 5, targetHours: 35 },
                            { name: "Datawrapper / Flourish (Interactive Charts)", time: "evening", importance: 3, targetHours: 40 },
                            { name: "Adobe Illustrator for Financial Graphics", time: "evening", importance: 2, targetHours: 50 },
                            { name: "Canva for Investor Decks", time: "evening", importance: 2, targetHours: 25 }
                        ]
                    },
                    "Free & Local Market Tools": {
                        icon: "ð¯",
                        color: "#7b2cbf",
                        skills: [
                            { name: "TradingView (Charting & Technical Analysis)", time: "morning", importance: 3, targetHours: 30 },
                            { name: "SEC EDGAR / Company Filings Navigation", time: "afternoon", importance: 4, targetHours: 25 },
                            { name: "FRED API / IMF/World Bank Data", time: "afternoon", importance: 3, targetHours: 35 },
                            { name: "FiinTrade / StoxPlus (Vietnam Market Data)", time: "morning", importance: 4, targetHours: 40 },
                            { name: "Google Finance / Yahoo Finance", time: "morning", importance: 3, targetHours: 20 }
                        ]
                    }
                }
            },

            cfa1: {
                title: "CFA Level 1 Skills",
                categories: {
                    "Ethical and Professional Standards": {
                        icon: "âï¸",
                        color: "#19ff8e",
                        skills: [
                            { name: "Code of Ethics and Standards of Professional Conduct", time: "evening", importance: 5, targetHours: 45 },
                            { name: "Guidance for Standard I(VII)", time: "evening", importance: 5, targetHours: 55 },
                            { name: "Application of Standards and Best Practices", time: "evening", importance: 4, targetHours: 35 },
                            { name: "Topic Review & Practice Questions", time: "evening", importance: 5, targetHours: 40 }
                        ]
                    },
                    "Quantitative Methods": {
                        icon: "ð",
                        color: "#32ff9b",
                        skills: [
                            { name: "Time Value of Money", time: "morning", importance: 5, targetHours: 30 },
                            { name: "Statistical Concepts and Market Returns", time: "morning", importance: 5, targetHours: 35 },
                            { name: "Probability Concepts", time: "morning", importance: 4, targetHours: 25 },
                            { name: "Common Probability Distributions", time: "morning", importance: 4, targetHours: 20 },
                            { name: "Sampling and Estimation", time: "afternoon", importance: 4, targetHours: 20 },
                            { name: "Hypothesis Testing", time: "afternoon", importance: 5, targetHours: 30 },
                            { name: "Correlation and Regression", time: "afternoon", importance: 5, targetHours: 35 },
                            { name: "Topic Review & Practice Questions", time: "evening", importance: 5, targetHours: 40 }
                        ]
                    },
                    "Economics": {
                        icon: "ð",
                        color: "#4cffa7",
                        skills: [
                            { name: "Demand and Supply Analysis: Introduction", time: "morning", importance: 4, targetHours: 25 },
                            { name: "Demand and Supply Analysis: Consumer and Producer Surplus", time: "morning", importance: 4, targetHours: 20 },
                            { name: "Firm and Market Structures", time: "morning", importance: 4, targetHours: 30 },
                            { name: "Aggregate Output, Price Level, and Economic Growth", time: "morning", importance: 5, targetHours: 40 },
                            { name: "Understanding Business Cycles", time: "afternoon", importance: 4, targetHours: 35 },
                            { name: "Monetary and Fiscal Policy", time: "afternoon", importance: 5, targetHours: 45 },
                            { name: "International Trade and Capital Flows", time: "afternoon", importance: 4, targetHours: 30 },
                            { name: "Topic Review & Practice Questions", time: "evening", importance: 5, targetHours: 50 }               
                        ]
                    },
                    "Financial Statement Analysis": {
                        icon: "ð",
                        color: "#66ffb4",
                        skills: [
                            { name: "Financial Reporting Standards", time: "morning", importance: 4, targetHours: 25 },
                            { name: "Understanding Income Statements", time: "morning", importance: 5, targetHours: 40 },
                            { name: "Understanding Balance Sheets", time: "morning", importance: 5, targetHours: 40 },
                            { name: "Understanding Cash Flow Statements", time: "morning", importance: 5, targetHours: 45 },
                            { name: "Financial Analysis Techniques", time: "afternoon", importance: 4, targetHours: 35 },
                            { name: "Inventory Valuation Methods", time: "afternoon", importance: 4, targetHours: 25 },
                            { name: "Long-lived Assets", time: "afternoon", importance: 4, targetHours: 30 },
                            { name: "Income Taxes", time: "evening", importance: 3, targetHours: 20 },
                            { name: "Non-current (Long-term) Liabilities", time: "afternoon", importance: 4, targetHours: 30 },
                            { name: "Leases", time: "afternoon", importance: 4, targetHours: 25 },
                            { name: "Financial Reporting Quality", time: "evening", importance: 3, targetHours: 20 },
                            { name: "Applications of Financial Statement Analysis", time: "afternoon", importance: 4, targetHours: 30 },
                            { name: "Topic Review & Practice Questions", time: "evening", importance: 5, targetHours: 60 }
                        ]
                    },
                    "Corporate Issuers": {
                        icon: "ð¢",
                        color: "#7fffc0",
                        skills: [
                            { name: "Corporate Governance and ESG: Overview", time: "evening", importance: 4, targetHours: 25 },
                            { name: "Capital Budgeting", time: "afternoon", importance: 5, targetHours: 40 },
                            { name: "Cost of Capital", time: "afternoon", importance: 5, targetHours: 45 },
                            { name: "Capital Structure", time: "afternoon", importance: 4, targetHours: 35 },
                            { name: "Dividend Policy", time: "evening", importance: 3, targetHours: 20 },
                            { name: "Working Capital Management", time: "afternoon", importance: 4, targetHours: 30 },
                            { name: "Topic Review & Practice Questions", time: "evening", importance: 5, targetHours: 40 }
                        ]
                    },
                    "Equity Investments": {
                        icon: "ð",
                        color: "#00ff82",
                        skills: [
                            { name: "Market Organization and Structure", time: "afternoon", importance: 3, targetHours: 20 },
                            { name: "Security Market Indexes", time: "afternoon", importance: 3, targetHours: 15 },
                            { name: "Market Efficiency", time: "afternoon", importance: 4, targetHours: 25 },
                            { name: "Overview of Equity Securities", time: "afternoon", importance: 4, targetHours: 30 },
                            { name: "Introduction to Industry and Company Analysis", time: "afternoon", importance: 4, targetHours: 35 },
                            { name: "Equity Valuation: Concepts and Basic Tools", time: "morning", importance: 5, targetHours: 50 },
                            { name: "Topic Review & Practice Questions", time: "evening", importance: 5, targetHours: 45 }
                        ]
                    },
                    "Fixed Income": {
                        icon: "ð¦",
                        color: "#00e675",
                        skills: [
                            { name: "Fixed-Income Securities: Defining Elements", time: "afternoon", importance: 4, targetHours: 35 },
                            { name: "Fixed-Income Markets: Issuance, Trading, and Funding", time: "afternoon", importance: 3, targetHours: 20 },
                            { name: "Introduction to Fixed-Income Valuation", time: "afternoon", importance: 5, targetHours: 55 },
                            { name: "Introduction to Asset-Backed Securities", time: "evening", importance: 2, targetHours: 15 },
                            { name: "Credit Analysis", time: "evening", importance: 3, targetHours: 25 },
                            { name: "Topic Review & Practice Questions", time: "evening", importance: 5, targetHours: 50 }
                        ]
                    },
                    "Derivatives": {
                        icon: "ð",
                        color: "#00ff82",
                        skills: [
                            { name: "Derivative Markets and Instruments", time: "afternoon", importance: 4, targetHours: 25 },
                            { name: "Basics of Derivative Pricing and Valuation", time: "afternoon", importance: 4, targetHours: 35 },
                            { name: "Forward Commitments", time: "afternoon", importance: 4, targetHours: 30 },
                            { name: "Options Basics (Calls, Puts)", time: "afternoon", importance: 4, targetHours: 40 },
                            { name: "Topic Review & Practice Questions", time: "evening", importance: 5, targetHours: 45 } 
                        ]
                    },
                    "Alternative Investments": {
                        icon: "ð±",
                        color: "#1aff8f",
                        skills: [
                            { name: "Alternative Investments Overview", time: "evening", importance: 3, targetHours: 20 },
                            { name: "Private Equity", time: "evening", importance: 3, targetHours: 25 },
                            { name: "Real Estate", time: "evening", importance: 3, targetHours: 25 },
                            { name: "Hedge Funds", time: "evening", importance: 3, targetHours: 25 },
                            { name: "Commodities and Natural Resources", time: "evening", importance: 2, targetHours: 15 },
                            { name: "Real Assets (Infrastructure, Timberland, Farmland)", time: "evening", importance: 2, targetHours: 15 },
                            { name: "Topic Review & Practice Questions", time: "evening", importance: 5, targetHours: 30 }
                        ]
                    },
                    "Portfolio Management and Wealth Planning": {
                        icon: "ð§­",
                        color: "#33ff9b",
                        skills: [
                            { name: "Portfolio Management Overview", time: "evening", importance: 3, targetHours: 20 },
                            { name: "Portfolio Risk and Return: Part I", time: "morning", importance: 5, targetHours: 45 },
                            { name: "Portfolio Risk and Return: Part II", time: "morning", importance: 4, targetHours: 35 },
                            { name: "Basics of Portfolio Planning and Construction", time: "afternoon", importance: 4, targetHours: 30 },
                            { name: "The Portfolio Management Process", time: "evening", importance: 3, targetHours: 20 },
                            { name: "Capital Market Theory", time: "morning", importance: 4, targetHours: 35 },
                            { name: "Basics of Risk Management", time: "evening", importance: 3, targetHours: 25 },
                            { name: "Introduction to Behavioral Finance", time: "evening", importance: 3, targetHours: 25 },
                            { name: "Introduction to Wealth Management", time: "evening", importance: 3, targetHours: 20 },
                            { name: "Topic Review & Practice Questions", time: "evening", importance: 5, targetHours: 50 }
                        ]
                    }
                }
            }
        };

        const careerIcons = {
            pe: "ð¼",
            ib: "ð¦",
            hf: "ð",
            sc: "ð¯",
            fintech: "ð³",
            english: "ð©",
            chinese: "ð",
            tools: "ð ï¸",
            cfa1: "ð"
        };

        

        const defaultQuotes = [
            { text: "The expert in anything was once a beginner.", author: "Helen Hayes" },
            { text: "Face it: You're not 'overwhelmed'. You're just under-qualified and too lazy to fix it.", author: "" }
        ];


        // Load custom quotes from localStorage
        customQuotes = JSON.parse(localStorage.getItem('customQuotes')) || [];

        // Merge default + custom quotes
        let motivationalQuotes = [...defaultQuotes, ...customQuotes];



        let currentCareer = 'pe';
        let currentMood = 'focused';
        let studyHours = JSON.parse(localStorage.getItem('studyHours')) || {};
        let gamification = JSON.parse(localStorage.getItem('gamification')) || {
            points: 0,
            level: 1,
            streak: 0,
            lastStreakDate: null
        };

        let progressChart = null;

        // ===== DEFAULT MEMES =====
        const defaultMemes = [
            'https://i.pinimg.com/736x/fb/ac/5f/fbac5f18cf0ad901d9d36d30b0cf7f3f.jpg',
            'https://i.pinimg.com/736x/67/be/19/67be19c0a81a54e97c57fcc847c96525.jpg',
            'https://pbs.twimg.com/media/GYZwl3KbIAAb6tw?format=jpg&name=small'
        ];
        customMemes = JSON.parse(localStorage.getItem('customMemes')) || [];
        let allMemes = [...defaultMemes, ...customMemes];

        // ===== MEME MIGRATION  =====
        (function migrateMemes() {
            const needsMigration = customMemes.some(m => typeof m === 'string');
            if (needsMigration) {
                customMemes = customMemes.map(m => 
                    typeof m === 'string' 
                        ? { url: m, caption: 'No caption', addedAt: new Date().toISOString() }
                        : m
                );
                localStorage.setItem('customMemes', JSON.stringify(customMemes));
            }
            allMemes = [...defaultMemes.map(url => ({ url, caption: 'Built-in meme' })), ...customMemes];
        })();


        // --- ADHD-OPTIMIZED TIME-BASED SKILL MAP ---
        const moodSkillMap = {
            focused: { skills: [] },   // Morning: Deep work (modeling, Python, LBO)
            analytical: { skills: [] }, // Afternoon: Analysis & research
            creative: { skills: [] },   // Evening: Communication & soft skills
            random: { skills: [] }
        };

        Object.entries(skillsData).forEach(([careerKey, careerData]) => {
            Object.values(careerData.categories).forEach(category => {
                category.skills.forEach(skill => {
                    const skillName = skill.name;
                    const career = careerKey;
                    const time = skill.time || 'afternoon'; // default
                    
                    moodSkillMap.random.skills.push({ career, name: skillName });

                    // â ADHD-OPTIMIZED: Map by TIME, not by content type
                    if (time === 'morning') {
                        // Morning = Best focus â Technical deep work
                        moodSkillMap.focused.skills.push({ career, name: skillName });
                    } else if (time === 'afternoon') {
                        // Afternoon = Medium focus â Analysis & research
                        moodSkillMap.analytical.skills.push({ career, name: skillName });
                    } else if (time === 'evening' || time === 'night') {
                        // Evening/Night = Low focus â Creative & soft skills
                        moodSkillMap.creative.skills.push({ career, name: skillName });
                    }
                });
            });
        });

        // Remove duplicates
        ['focused', 'analytical', 'creative'].forEach(mood => {
            moodSkillMap[mood].skills = [...new Map(
                moodSkillMap[mood].skills.map(item => [item.name, item])
            ).values()];
        });







        let quoteTimer;
        function getRandomQuote() {
            const randomIndex = Math.floor(Math.random() * motivationalQuotes.length);
            const quote = motivationalQuotes[randomIndex];
            document.getElementById('quoteText').textContent = quote.text;
            document.getElementById('quoteAuthor').textContent = quote.author ? `- ${quote.author}` : '';
            if (quoteTimer) {
                clearTimeout(quoteTimer);
            }
            quoteTimer = setTimeout(getRandomQuote, 1200000); 
        }

        window.addEventListener('beforeunload', () => {
            if (quoteTimer) {
                clearTimeout(quoteTimer);
                console.log("Cleared quoteTimer on unload.");
            }
        });


        // ===== CUSTOM QUOTES MANAGEMENT =====

        // Function: Add Custom Quote
        function addCustomQuote() {
            const text = document.getElementById('customQuoteText').value.trim();
            const author = document.getElementById('customQuoteAuthor').value.trim();
            
            if (!text) {
                showNotification('â Please enter quote text!', 'error');
                return;
            }
            
            // Check for duplicates
            const isDuplicate = customQuotes.some(q => q.text.toLowerCase() === text.toLowerCase());
            if (isDuplicate) {
                showNotification('â ï¸ This quote already exists!', 'error');
                return;
            }
            
            const newQuote = { 
                text, 
                author,
                id: Date.now(), 
                addedAt: new Date().toISOString()
            };
            
            customQuotes.push(newQuote);
            motivationalQuotes.push(newQuote);
            
            // Save to localStorage
            localStorage.setItem('customQuotes', JSON.stringify(customQuotes));
            
            // Clear inputs
            document.getElementById('customQuoteText').value = '';
            document.getElementById('customQuoteAuthor').value = '';
            
            // Update count
            updateCustomQuotesCount();
            
            // Show success + new quote
            showNotification('â Quote added successfully!', 'success');
            getRandomQuote(); // Show the new quote immediately
        }

        // Function: Update Custom Quotes Count
        function updateCustomQuotesCount() {
            const countEl = document.getElementById('customQuotesCount');
            if (countEl) {
                countEl.textContent = customQuotes.length;
            }
        }

        // Function: Open Manage Quotes Modal
        function openManageQuotesModal() {
            if (customQuotes.length === 0) {
                showNotification('ð No custom quotes yet. Add some first!', 'info');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'manageQuotesModal';
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-white); border-radius: 16px; max-width: 700px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="padding: 24px; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; background: var(--bg-white); z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0 0 8px 0; font-size: 1.5rem; color: var(--text-dark);">
                                    ð Manage Your Custom Quotes
                                </h2>
                                <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">
                                    ${customQuotes.length} custom quotes
                                </p>
                            </div>
                            <button onclick="closeManageQuotesModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-muted);">
                                Ã
                            </button>
                        </div>
                    </div>
                    
                    <!-- Body -->
                    <div style="padding: 20px;">
                        ${renderCustomQuotesList()}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeManageQuotesModal();
                }
            });
        }

        // Function: Close Manage Quotes Modal
        function closeManageQuotesModal() {
            const modal = document.getElementById('manageQuotesModal');
            if (modal) modal.remove();
        }

        // Function: Render Custom Quotes List
        function renderCustomQuotesList() {
            if (customQuotes.length === 0) {
                return '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No custom quotes yet.</p>';
            }
            
            return customQuotes.map((quote, index) => `
                <div style="background: var(--bg-light); padding: 16px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #f59e0b;">
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                        <div style="flex: 1;">
                            <div style="font-size: 1rem; color: var(--text-dark); margin-bottom: 6px; line-height: 1.5;">
                                "${quote.text}"
                            </div>
                            ${quote.author ? `
                                <div style="font-size: 0.85rem; color: var(--text-muted); font-style: italic;">
                                    â ${quote.author}
                                </div>
                            ` : ''}
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px;">
                                Added: ${new Date(quote.addedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                            </div>
                        </div>
                        
                        <button 
                            onclick="deleteCustomQuote(${quote.id})" 
                            style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; white-space: nowrap;">
                            ðï¸ Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Function: Delete Custom Quote
        function deleteCustomQuote(quoteId) {
            if (!confirm('ðï¸ Delete this quote?')) return;
            
            // Remove from customQuotes
            customQuotes = customQuotes.filter(q => q.id !== quoteId);
            
            // Remove from motivationalQuotes
            motivationalQuotes = [...defaultQuotes, ...customQuotes];
            
            // Save to localStorage
            localStorage.setItem('customQuotes', JSON.stringify(customQuotes));
            
            // Update UI
            updateCustomQuotesCount();
            
            // Re-render modal content
            const modalBody = document.querySelector('#manageQuotesModal > div > div:last-child');
            if (modalBody) {
                modalBody.innerHTML = renderCustomQuotesList();
            }
            
            // Update header count
            const headerCount = document.querySelector('#manageQuotesModal p');
            if (headerCount) {
                headerCount.textContent = `${customQuotes.length} custom quotes`;
            }
            
            showNotification('Quote deleted', 'info');
        }

        // Initialize count on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateCustomQuotesCount();
        });


        

        document.addEventListener('DOMContentLoaded', function() {
            const savedCareer = localStorage.getItem('currentCareer');
            const careerToLoad = savedCareer || 'pe';
            loadCareer(careerToLoad);
            updateStats();
            updateGamificationStats();
            updateDailyStreak();
            initChart();
            getRandomMeme();
            updateDailyStudyDisplay();


            // --- GOAL PROGRESS CHART ---
            let goalProgressChart = null;
            function initGoalProgressChart() {
                const ctx = document.getElementById('goalProgressChart').getContext('2d');                
                if (goalProgressChart) {
                    goalProgressChart.destroy();
                }
                const filteredGoals = goals.filter(g => g.career === currentCareer);
                const totalGoals = filteredGoals.length;
                const completedGoals = filteredGoals.filter(g => getGoalStatus(g) === 'completed').length;
                const completionRate = totalGoals > 0 ? Math.round((completedGoals / totalGoals) * 100) : 0;
                const data = {
                    labels: ['Completed', 'Remaining'],
                    datasets: [{
                        data: [completedGoals, totalGoals - completedGoals],
                        backgroundColor: [
                            '#10b981', 
                            '#e2e8f0'  
                        ],
                        borderColor: [
                            '#059669',
                            '#cbd5e1'
                        ],
                        borderWidth: 2,
                        cutout: '70%'
                    }]
                };
                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: ${value}`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `${completionRate}% Complete`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: 'var(--text-dark)',
                            padding: 10
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutBounce'
                    }
                };
                goalProgressChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: options
                });
                document.getElementById('goalProgressSummary').textContent = `${completedGoals}/${totalGoals} goals completed`;
            }


            function updateGoalProgressChart() {
                if (document.getElementById('goalProgressChart')) {
                    initGoalProgressChart();
                }
            }            
            loadSleepData(); 
            document.querySelector(`.mood-btn[data-mood="${currentMood}"]`).classList.add('active');
            suggestSkillByMood();
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMood = this.dataset.mood;
                    suggestSkillByMood();
                });
            });
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                updateChartColors();
            }
            getRandomQuote();
        });            

        function selectCareer(career) {
            localStorage.setItem('currentCareer', career); 
            loadCareer(career);
        }

        function loadCareer(career) {
            currentCareer = career;
            document.querySelectorAll('.career-card').forEach(card => card.classList.remove('selected'));
            document.querySelector(`[data-career="${career}"]`).classList.add('selected');
            document.getElementById('career-title').textContent = skillsData[career].title;
            document.getElementById('currentCareerTitle').textContent = skillsData[career].title;
            loadSkills(career);
            updateStats();
            updateChart();
            renderCourses();
            document.getElementById('goalsSection').style.display = 'block'; 
            updateGoals();
        }


        function loadSkills(career) {
            const container = document.getElementById('skillsContainer');
            container.innerHTML = '';
            const careerData = skillsData[career];

            Object.entries(careerData.categories).forEach(([categoryName, categoryData]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'skill-category';
                const sortedSkills = [...categoryData.skills].sort((a, b) => b.importance - a.importance);

                categoryDiv.innerHTML = `
                    <div class="category-header" onclick="toggleCategory(this)" data-category="${career}-${categoryName}">
                        <div class="category-info">
                            <span class="category-icon">${categoryData.icon}</span>
                            <span class="category-title">${categoryName}</span>
                        </div>
                        <span class="toggle-icon">â¼</span>
                    </div>
                    <div class="skills-list">
                        ${sortedSkills.map(skill => {
                            const hoursStudied = getSkillHours(career, skill.name);
                            const targetHours = skill.targetHours || 10; // Fallback to 10 if not set
                            const progressPercent = Math.min(100, (hoursStudied / targetHours) * 100);
                            const isDone = hoursStudied >= targetHours;

                            return `
                            <div class="skill-item ${isDone ? 'skill-done' : ''}" data-career="${career}">
                                <div class="skill-info">
                                    <div class="skill-name">
                                        ${skill.name} 
                                        ${isDone ? '<span style="color: #10b981; font-weight: bold;">â</span>' : ''}
                                    </div>
                                    <div class="skill-meta">
                                        <div class="skill-time">
                                            ${getTimeIcon(skill.time)} ${skill.time.charAt(0).toUpperCase() + skill.time.slice(1)}
                                        </div>
                                        <div class="skill-hours">
                                            ð ${hoursStudied.toFixed(1)} / ${targetHours} hours
                                        </div>
                                        <div class="skill-progress-container">
                                            <div class="skill-progress-fill" style="width: ${progressPercent}%"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="skill-controls">
                                    <input type="number" class="time-input" min="0" step="0.5" placeholder="0.5">
                                    <button class="add-time-btn" onclick="subtractStudyTime('${career}', '${skill.name}', this)" 
                                            style="background: #ef4444; margin-right: 5px;" 
                                            title="Subtract hours">
                                        -
                                    </button>
                                    <button class="add-time-btn" onclick="addStudyTime('${career}', '${skill.name}', this)">
                                        +
                                    </button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                `;
                container.appendChild(categoryDiv);

                // Restore collapse state
                Object.entries(careerData.categories).forEach(([categoryName]) => {
                    const categoryKey = `${career}-${categoryName}`;
                    const isExpanded = localStorage.getItem(`categoryExpanded_${categoryKey}`);
                    const header = document.querySelector(`[data-category="${categoryKey}"]`);
                    const skillsList = header?.nextElementSibling;

                    if (header && skillsList) {
                        if (isExpanded === 'false') {
                            skillsList.classList.add('collapsed');
                            header.querySelector('.toggle-icon').textContent = 'â¶';
                            header.querySelector('.toggle-icon').classList.add('collapsed');
                        } else {
                            skillsList.classList.remove('collapsed');
                            header.querySelector('.toggle-icon').textContent = 'â¼';
                            header.querySelector('.toggle-icon').classList.remove('collapsed');
                        }
                    }
                });
            });
        }

        function renderSkills(career) {
            const container = document.getElementById('skillsContainer');
            const data = skillsData[career];
            
            let html = '';
            
            for (const [category, content] of Object.entries(data.categories)) {
                html += `
                    <div class="category-section" data-career="${career}">
                        <div class="category-header">
                            <span class="category-icon">${content.icon}</span>
                            <h3 class="category-name">${category}</h3>
                            <span class="category-count">${content.skills.length} skills</span>
                        </div>
                        <div class="skills-grid">
                `;
                
                content.skills.forEach(skill => {
                    html += `
                        <div class="skill-item" data-career="${career}" data-importance="${skill.importance}">
                            <!-- skill content -->
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            container.innerHTML = html;
        }

        function getTimeIcon(time) {
            const icons = {
                morning: 'ð',
                afternoon: 'âï¸',
                evening: 'ð',
                night: 'ð'
            };
            return icons[time] || 'â°';
        }

        function getSkillHours(career, skillName) {
            return studyHours[career]?.[skillName] || 0;
        }

        function addStudyTime(career, skillName, button) {
            const controls = button.parentElement;
            const input = controls.querySelector('.time-input');
            const hours = parseFloat(input.value);
            
            if (!hours || hours <= 0) {
                showNotification('Please enter a valid number of hours', 'error');
                return;
            }

            if (!studyHours[career]) studyHours[career] = {};
            if (!studyHours[career][skillName]) studyHours[career][skillName] = 0;

            const careerData = skillsData[career];
            let targetHours = 10; // default
            let skillFound = false;
            
            Object.values(careerData.categories).forEach(category => {
                const skill = category.skills.find(s => s.name === skillName);
                if (skill) {
                    targetHours = skill.targetHours || 10;
                    skillFound = true;
                }
            });
            
            const currentHours = studyHours[career][skillName];

            if (currentHours >= targetHours) {
                showNotification(`â Skill "${skillName}" is already complete! (${currentHours.toFixed(1)}/${targetHours}h)`, 'error');
                input.value = '';
                return;
            }

            const newTotal = currentHours + hours;
            
            if (newTotal > targetHours) {
                const remainingHours = targetHours - currentHours;
                studyHours[career][skillName] = targetHours;
                
                showNotification(`â Added ${remainingHours.toFixed(1)}h to reach target! Skill complete at ${targetHours}h. Earned ${Math.floor(remainingHours * 10)} XP`, 'achievement');
            } else {
                studyHours[career][skillName] += hours;
                
                const pointsEarned = Math.floor(hours * 10);
                gamification.points += pointsEarned;
                
                showNotification(`â Added ${hours}h to ${skillName}! Earned ${pointsEarned} XP`, 'success');
            }
            
            gamification.level = Math.floor(gamification.points / 100) + 1;
            localStorage.setItem('studyHours', JSON.stringify(studyHours));
            localStorage.setItem('gamification', JSON.stringify(gamification));
            input.value = '';
            loadSkills(career);
            updateStats();
            updateGamificationStats();
            updateChart();
            updateDailyStreak();
            updateGoals(); 
            updateDailyStudyData(hours);
            checkAchievements(career, skillName, studyHours[career][skillName]);
            getRandomQuote();
            triggerBackup();
        }

        function subtractStudyTime(career, skillName, button) {
            const controls = button.parentElement;
            const input = controls.querySelector('.time-input');
            const hours = parseFloat(input.value);
            
            if (!hours || hours <= 0) {
                showNotification('Please enter a valid number of hours to subtract', 'error');
                return;
            }

            if (!studyHours[career] || !studyHours[career][skillName]) {
                showNotification('No hours recorded for this skill yet', 'error');
                return;
            }
            
            const currentHours = studyHours[career][skillName];

            if (currentHours - hours < 0) {
                showNotification(`â Cannot subtract ${hours}h. Current: ${currentHours.toFixed(1)}h`, 'error');
                return;
            }

            studyHours[career][skillName] -= hours;

            if (studyHours[career][skillName] === 0) {
                delete studyHours[career][skillName];
            }

            const pointsLost = Math.floor(hours * 10);
            gamification.points = Math.max(0, gamification.points - pointsLost);
            gamification.level = Math.floor(gamification.points / 100) + 1;
            
            localStorage.setItem('studyHours', JSON.stringify(studyHours));
            localStorage.setItem('gamification', JSON.stringify(gamification));

            input.value = '';
            loadSkills(career);
            updateStats();
            updateGamificationStats();
            updateChart();
            updateGoals();
            
            showNotification(`â Subtracted ${hours}h from ${skillName}. Lost ${pointsLost} XP`, 'info');
            triggerBackup();
        }


        function toggleCategory(header) {
            const skillsList = header.nextElementSibling;
            const categoryKey = header.dataset.category; 
            if (skillsList.classList.contains('collapsed')) {
                skillsList.classList.remove('collapsed');
                header.querySelector('.toggle-icon').textContent = 'â¼';
                header.querySelector('.toggle-icon').classList.remove('collapsed');
                localStorage.setItem(`categoryExpanded_${categoryKey}`, 'true');
            } else {
                skillsList.classList.add('collapsed');
                header.querySelector('.toggle-icon').textContent = 'â¶';
                header.querySelector('.toggle-icon').classList.add('collapsed');
                localStorage.setItem(`categoryExpanded_${categoryKey}`, 'false');
            }
        }

        function updateStats() {
            const careerData = skillsData[currentCareer];
            let totalSkills = 0;
            let completedSkills = 0;
            Object.values(careerData.categories).forEach(category => {
                category.skills.forEach(skill => {
                    totalSkills++;
                    const hoursStudied = getSkillHours(currentCareer, skill.name);
                    const targetHours = skill.targetHours || 10;

                    if (hoursStudied >= targetHours) {
                        completedSkills++;
                    }
                });
            });
            const currentCareerProgressPercent = totalSkills > 0 
                ? (completedSkills / totalSkills) * 100 
                : 0;  
            document.getElementById('total-progress').textContent = currentCareerProgressPercent.toFixed(1);
            document.getElementById('career-progress-bar').style.width = `${Math.min(100, currentCareerProgressPercent)}%`;

            let overallTotalHours = 0;
            Object.keys(studyHours).forEach(career => {
                overallTotalHours += Object.values(studyHours[career]).reduce((sum, h) => sum + h, 0);
            });
            document.getElementById('totalHours').textContent = `${overallTotalHours.toFixed(1)} hours`;
        }



        function suggestSkillByMood() {
            const suggestionDiv = document.getElementById('learningMoodWidget');
            const suggestionText = document.getElementById('learningMoodSkillText');

            if (!suggestionDiv || !suggestionText) return;

            suggestionDiv.style.display = 'none';

            const eligibleSkills = moodSkillMap[currentMood].skills;
            if (!eligibleSkills || eligibleSkills.length === 0) {
                suggestionText.innerHTML = "<em>No skills mapped for this mood yet.</em>";
                suggestionDiv.style.display = 'block';
                return;
            }

            // **FILTER OUT COMPLETED SKILLS**
            const incompleteSkills = eligibleSkills.filter(skillObj => {
                const career = skillObj.career;
                const skillName = skillObj.name;
                const careerData = skillsData[career];
                
                if (!careerData) return false;
                
                let foundSkill = null;
                Object.values(careerData.categories).some(category => {
                    foundSkill = category.skills.find(s => s.name === skillName);
                    return !!foundSkill;
                });
                
                if (!foundSkill) return false;
                
                const hoursStudied = getSkillHours(career, skillName);
                const targetHours = foundSkill.targetHours || 10;
                
                return hoursStudied < targetHours; // Only incomplete skills
            });

            if (incompleteSkills.length === 0) {
                suggestionText.innerHTML = `<em>ð All ${currentMood} skills completed! Try another mood.</em>`;
                suggestionDiv.style.display = 'block';
                return;
            }

            // Pick random incomplete skill
            const randomSkill = incompleteSkills[Math.floor(Math.random() * incompleteSkills.length)];
            const career = randomSkill.career;
            const skillName = randomSkill.name;
            const careerData = skillsData[career];

            let foundSkill = null;
            Object.values(careerData.categories).some(category => {
                foundSkill = category.skills.find(s => s.name === skillName);
                if (foundSkill) return true;
                return false;
            });

            const timeIcon = getTimeIcon(foundSkill?.time || 'â°');
            const priority = foundSkill?.importance || 3;
            const priorityIcon = getPriorityIcon(priority);

            suggestionText.innerHTML = `
                <strong>${skillName}</strong><br>
                <small style="color: var(--text-muted);">${careerData.title} â¢ ${timeIcon} ${priorityIcon}</small>
            `;
            suggestionDiv.style.display = 'block';
        }

        function checkAchievements(career, skillName, totalHours) {
            const careerData = skillsData[career];
            if (!careerData) return;
            
            let targetHours = 10; // Default
            Object.values(careerData.categories).some(category => {
                const skill = category.skills.find(s => s.name === skillName);
                if (skill) {
                    targetHours = skill.targetHours || 10;
                    return true;
                }
                return false;
            });
            
            // Achievement milestones
            if (totalHours === 1) {
                addAchievement(`ð¯ First hour in ${skillName}!`);
                showNotification(`Achievement Unlocked: First hour in ${skillName}!`, 'achievement');
            } else if (totalHours === 5) {
                addAchievement(`ð 5 hours milestone in ${skillName}!`);
                showNotification(`Achievement Unlocked: 5 hours milestone!`, 'achievement');
            } else if (totalHours >= targetHours) {
                addAchievement(`ðª MASTERED: ${skillName} (${targetHours}h)!`);
                showNotification(`ð Achievement Unlocked: ${skillName} MASTERED!`, 'achievement');
            }
        }


        function getSkillCompletion(career, skillName) {
            const careerData = skillsData[career];
            if (!careerData) return { completed: false, progress: 0, target: 10 };
            
            let targetHours = 10;
            Object.values(careerData.categories).some(category => {
                const skill = category.skills.find(s => s.name === skillName);
                if (skill) {
                    targetHours = skill.targetHours || 10;
                    return true;
                }
                return false;
            });
            
            const hoursStudied = getSkillHours(career, skillName);
            return {
                completed: hoursStudied >= targetHours,
                progress: hoursStudied,
                target: targetHours,
                percent: Math.min(100, (hoursStudied / targetHours) * 100)
            };
        }


        function addAchievement(text) {
            const achievementsDiv = document.getElementById('achievements');
            const achievement = document.createElement('div');
            achievement.className = 'achievement';
            achievement.textContent = text;
            achievementsDiv.appendChild(achievement);
            setTimeout(() => {
                if (achievement.parentNode) {
                    achievement.parentNode.removeChild(achievement);
                }
            }, 10000);
        }


        function updateDailyStreak() {
            const today = new Date().toDateString();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (gamification.lastStreakDate !== today) {
                if (gamification.lastStreakDate === yesterday.toDateString()) {
                    gamification.streak += 1;
                } else {
                    gamification.streak = 1;
                }
                gamification.lastStreakDate = today;
                localStorage.setItem('gamification', JSON.stringify(gamification));

                if (gamification.streak % 7 === 0) {
                    addAchievement(`ð¥ ${gamification.streak} day streak! Keep going!`);
                    showNotification(`Achievement Unlocked: ${gamification.streak} day streak!`, 'achievement');
                }
            }
            updateGamificationStats();
        }

        function updateGamificationStats() {
            document.getElementById('levelBadge').textContent = `Level ${gamification.level}`;
            document.getElementById('pointsDisplay').textContent = `${gamification.points} XP`;
            document.getElementById('streakDisplay').textContent = `${gamification.streak} day streak`;
        }

        function initChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['PE', 'IB', 'HF', 'SC', 'Fintech', 'English', 'Chinese', 'Tools', 'CFA L1'],
                    datasets: [{
                        label: 'Hours Studied',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#e74c3c', // PE
                            '#3498db', // IB
                            '#f39c12', // HF
                            '#2ecc71', // SC
                            '#00ffef', // Fintech
                            '#fbe82c', // English
                            '#00ffd2', // Chinese
                            '#ff1265', // Tools 
                            '#00ff82'  // CFA L1 
                        ],
                        borderColor: Array(8).fill('#c4d3e0'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#666'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#666'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }


        function updateChart() {
            if (!progressChart) return;
            const hours = [
                calculateTotalHours('pe'),
                calculateTotalHours('ib'),
                calculateTotalHours('hf'),
                calculateTotalHours('sc'),
                calculateTotalHours('fintech'),
                calculateTotalHours('english'),
                calculateTotalHours('chinese'),
                calculateTotalHours('tools'), 
                calculateTotalHours('cfa1')    
            ];
            progressChart.data.datasets[0].data = hours;
            progressChart.update();
        }       


        function updateChartColors() {
            if (!progressChart) return;
            const isDarkMode = document.body.classList.contains('dark-mode');
            const textColor = isDarkMode ? '#cbd5e1' : '#666';
            progressChart.options.scales.x.ticks.color = textColor;
            progressChart.options.scales.y.ticks.color = textColor;
            progressChart.update();
        }

        function calculateTotalHours(career) {
            if (!studyHours[career]) return 0;
            return Object.values(studyHours[career]).reduce((sum, hours) => sum + hours, 0);
        }


        function toggleDarkMode() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark);
            updateChartColors();
            if (sleepChart) {
                const textColor = isDark ? '#cbd5e1' : '#666';
                sleepChart.options.scales.y.ticks.color = textColor;
                sleepChart.options.scales.x.ticks.color = textColor;
                sleepChart.update();
            }
            if (dailyStudyChart) {
                const textColor = isDark ? '#cbd5e1' : '#666';
                dailyStudyChart.options.scales.y.ticks.color = textColor;
                dailyStudyChart.options.scales.x.ticks.color = textColor;
                dailyStudyChart.update();
            }
            if (goalProgressChart) {
                goalProgressChart.update();
            }
            body.style.transition = 'background-color 0.3s ease, color 0.3s ease';
            setTimeout(() => {
                body.style.transition = '';
            }, 300);
        }



        let sessionLogs = JSON.parse(localStorage.getItem('sessionLogs')) || [];
        
        function logSession() {
            const noteInput = document.getElementById('sessionNote');
            const noteText = noteInput.value.trim();
            if (!noteText) {
                showNotification('Please enter a note before logging!', 'error');
                return;
            }
            const newLog = {
                id: Date.now(),
                text: noteText,
                timestamp: new Date().toLocaleString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                })
            };
            sessionLogs.unshift(newLog);
            if (sessionLogs.length > 20) {
                sessionLogs.pop();
            }
            localStorage.setItem('sessionLogs', JSON.stringify(sessionLogs));
            noteInput.value = '';
            renderSessionLogs();
            showNotification('â Session logged successfully!', 'success');
        }
        
        // --- SESSION LOGS MANAGEMENT ---
        function formatLogText(text) {
            if (!text) return '';
            let html = text.replace(/\n/g, '<br>');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            return html;
        }

        function renderSessionLogs() {
            const container = document.getElementById('sessionLogsContainer');
            if (sessionLogs.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 10px;">No session logs yet...</p>';
                return;
            }
            container.innerHTML = sessionLogs.map(log => `
                <div class="session-log" data-id="${log.id}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 4px;">${log.timestamp}</div>
                            <div style="color: var(--text-dark); white-space: normal;">${formatLogText(log.text)}</div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="editSessionLog(${log.id})" style="background: none; border: none; color: #3498db; cursor: pointer; font-size: 1rem;" title="Sá»­a">âï¸</button>
                            <button onclick="deleteSessionLog(${log.id})" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 1rem;" title="XÃ³a">ðï¸</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        function deleteSessionLog(id) {
            if (confirm("Báº¡n cÃ³ cháº¯c muá»n xÃ³a ghi chÃº nÃ y?")) {
                sessionLogs = sessionLogs.filter(log => log.id !== id);
                localStorage.setItem('sessionLogs', JSON.stringify(sessionLogs));
                renderSessionLogs();
                showNotification('Ghi chÃº ÄÃ£ ÄÆ°á»£c xÃ³a!', 'success');
            }
        }

        function editSessionLog(id) {
            const log = sessionLogs.find(log => log.id === id);
            if (!log) return;
            const noteInput = document.getElementById('sessionNote');
            const currentText = log.text;
            noteInput.value = currentText;
            noteInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            noteInput.focus();
            noteInput.dataset.editingId = id;
            showNotification('ð Editing note. Click "Log Session" to save changes.', 'info');
        }


        function logSession() {
            const noteInput = document.getElementById('sessionNote');
            const noteText = noteInput.value.trim();
            if (!noteText) {
                showNotification('Please enter a note before logging!', 'error');
                return;
            }
            const editingId = noteInput.dataset.editingId;  
            if (editingId) {
                const log = sessionLogs.find(log => log.id === parseInt(editingId));
                if (log) {
                    log.text = noteText;
                    log.timestamp = new Date().toLocaleString('vi-VN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                delete noteInput.dataset.editingId;
                showNotification('â Note updated successfully!', 'success');
            } else {
                const newLog = {
                    id: Date.now(),
                    text: noteText,
                    timestamp: new Date().toLocaleString('vi-VN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                };
                sessionLogs.unshift(newLog);
                if (sessionLogs.length > 20) {
                    sessionLogs.pop();
                }
                showNotification('â Session logged successfully!', 'success');
            }
            localStorage.setItem('sessionLogs', JSON.stringify(sessionLogs));
            noteInput.value = '';
            renderSessionLogs();
        }


        let readingList = JSON.parse(localStorage.getItem('readingList')) || [];

        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"']/g, s => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[s]));
        }

        function getStatusText(status) {
            const statusMap = {
                'want': 'ð Want to Read',
                'reading': 'ð Reading', 
                'finished': 'â Finished'
            };
            return statusMap[status] || status;
        }

        function renderReadingList() {
            const container = document.getElementById('readingListContainer');
            if (!container) return;
            const genreFilter = document.getElementById('genreFilter')?.value || 'all';
            const sortValue = document.getElementById('sortReadingList')?.value || 'default';
            const searchQuery = document.getElementById('searchInput')?.value.trim().toLowerCase() || '';
            let filteredBooks = readingList.filter(book => {
                const matchesGenre = genreFilter === 'all' || book.genre === genreFilter;
                const matchesSearch = !searchQuery ||
                    book.title.toLowerCase().includes(searchQuery) ||
                    book.author.toLowerCase().includes(searchQuery) ||
                    (book.genre && book.genre.toLowerCase().includes(searchQuery)) ||
                    (book.review && book.review.toLowerCase().includes(searchQuery));
                return matchesGenre && matchesSearch;
            });

            filteredBooks.sort((a, b) => {
                const statusOrder = { finished: 3, reading: 2, want: 1 };
                const statusDiff = (statusOrder[b.status] || 0) - (statusOrder[a.status] || 0);
                if (statusDiff !== 0) return statusDiff;
                switch (sortValue) {
                    case 'titleAsc':
                        return a.title.localeCompare(b.title) || (a.id - b.id);
                    case 'titleDesc':
                        return b.title.localeCompare(a.title) || (a.id - b.id);
                    case 'ratingAsc':
                        const ratingA = a.rating || 0;
                        const ratingB = b.rating || 0;
                        return (ratingA - ratingB) || (a.id - b.id);
                    case 'ratingDesc':
                        const rA = a.rating || 0;
                        const rB = b.rating || 0;
                        return (rB - rA) || (a.id - b.id);
                    default: // 'default' = recently added
                        return (new Date(b.addedAt) - new Date(a.addedAt)) || (a.id - b.id);
                }
            });
            if (filteredBooks.length === 0) {
                const noResultsMessage = searchQuery
                    ? `No books found matching "${searchQuery}".`
                    : (genreFilter === 'all'
                        ? 'No books added yet. Click \'Add Book\' to get started.'
                        : `No books found in "${genreFilter}" genre.`);
                container.innerHTML = `<div class="empty-state">${noResultsMessage}</div>`;
                return;
            }
            container.innerHTML = filteredBooks.map(book => {
                const maxReviewLength = 100;
                let ratingDisplay = '';
                if (book.rating !== null && !isNaN(book.rating)) {
                    const ratingValue = book.rating;
                    const fullStars = Math.floor(ratingValue);
                    const hasHalfStar = ratingValue % 1 >= 0.5;
                    let starsHTML = '';
                    for (let i = 1; i <= 5; i++) {
                        if (i <= fullStars) {
                            starsHTML += '<span class="star filled">â</span>';
                        } else if (i === fullStars + 1 && hasHalfStar) {
                            starsHTML += '<span class="star half">â</span>';
                        } else {
                            starsHTML += '<span class="star">â</span>';
                        }
                    }
                    ratingDisplay = `<div class="book-rating">${starsHTML} (${ratingValue.toFixed(1)})</div>`;
                }
                let reviewDisplay = '';
                if (book.review) {
                    let displayReview = book.review;
                    let isTruncated = false;
                    if (book.review.length > maxReviewLength) {
                        displayReview = book.review.substring(0, maxReviewLength) + '...';
                        isTruncated = true;
                    }
                    reviewDisplay = `<div class="book-review ${isTruncated ? 'truncated' : ''}" onclick="showFullReview(\`${escapeHtml(book.review)}\`, \`${escapeHtml(book.title)}\`); event.stopPropagation();">
                                        <strong>Review:</strong> ${escapeHtml(displayReview)}
                                        ${isTruncated ? '<span class="read-more"> (Click to read more)</span>' : ''}
                                    </div>`;
                }

                const bookDetailsElements = [
                    `<div class="book-title">${escapeHtml(book.title)}</div>`,
                    `<div class="book-author">by ${escapeHtml(book.author)}</div>`,
                    `<div class="book-meta-row">`,
                    ` <span class="book-genre">${escapeHtml(book.genre)}</span>`,
                    ` <span class="book-status-badge ${book.status}">${getStatusText(book.status)}</span>`,
                    `</div>`,
                    ratingDisplay,
                    reviewDisplay
                ];
                const detailsHTML = bookDetailsElements.join('');

                return `<div class="book-item" data-id="${book.id}" onclick="showBookDetails(${book.id})">
                            <img class="book-cover" src="${book.cover || 'https://via.placeholder.com/60x84?text=ð'}" alt="${escapeHtml(book.title)} cover">
                            <div class="book-details">
                                ${detailsHTML}
                            </div>
                            <div class="book-actions">
                                <button class="book-action-btn" onclick="openEditBookModal(${book.id}); event.stopPropagation();" title="Edit Book">âï¸</button>
                                <button class="book-action-btn" onclick="removeBook(${book.id}); event.stopPropagation();" title="Delete Book">ðï¸</button>
                                <button class="book-action-btn" onclick="toggleBookStatus(${book.id}); event.stopPropagation();" title="Toggle Status">ð</button>
                                <button class="book-action-btn" onclick="showBookDetails(${book.id}); event.stopPropagation();" title="View Details">ðï¸</button>
                            </div>
                        </div>`;
            }).join('');
        }


        function updateReadingCounts() {
            document.getElementById('totalCount').textContent = readingList.length;
            document.getElementById('readingCount').textContent = readingList.filter(b => b.status === 'reading').length;
            document.getElementById('finishedCount').textContent = readingList.filter(b => b.status === 'finished').length;
        }

        function openAddBookModal() {
            document.getElementById('addBookModal').style.display = 'flex';
            document.getElementById('addBookForm').reset();
        }

        function closeAddBookModal() {
            document.getElementById('addBookModal').style.display = 'none';
        }


        function openEditBookModal(bookId) {
            const book = readingList.find(b => b.id === parseInt(bookId));
            if (!book) {
                console.error('Book not found for editing:', bookId);
                showNotification('Book not found!', 'error');
                return;
            }

            document.getElementById('editBookId').value = book.id;
            document.getElementById('editBookTitle').value = book.title;
            document.getElementById('editBookAuthor').value = book.author;
            document.getElementById('editBookCoverUrl').value = book.cover || '';
            document.getElementById('editBookGenre').value = book.genre || 'Other';
            document.getElementById('editBookStatus').value = book.status;
            document.getElementById('editBookRating').value = book.rating !== null ? book.rating : '';
            document.getElementById('editBookReview').value = book.review || '';

            document.getElementById('editBookModal').style.display = 'flex';
        }

        function closeEditBookModal() {
            document.getElementById('editBookModal').style.display = 'none';
        }


        function addBook(event) {
            event.preventDefault();
            console.log('addBook function called');

            const title = document.getElementById('bookTitle').value.trim();
            const author = document.getElementById('bookAuthor').value.trim();
            const cover = document.getElementById('bookCoverUrl').value.trim();
            const status = document.getElementById('bookStatus').value;
            const genre = document.getElementById('bookGenre').value.trim();
            const ratingValue = document.getElementById('bookRating').value;
            const rating = ratingValue ? parseInt(ratingValue) : null;
            const review = document.getElementById('bookReview').value.trim();

            console.log('Form values:', { title, author, genre, status, rating, review });

            if (!title || !author || !genre) {
                showNotification('Please fill in all required fields (Title, Author, Genre)!', 'error');
                return;
            }

            const book = {
                id: Date.now(),
                title,
                author,
                cover: cover || '',
                genre,
                status,
                addedAt: new Date().toISOString(),
                rating,
                review
            };

            console.log('Adding book:', book);
            readingList.push(book);
            localStorage.setItem('readingList', JSON.stringify(readingList));
            renderReadingList();
            updateReadingCounts();
            closeAddBookModal();
            showNotification('â Book added successfully!', 'success');
        }

        function updateReadingCounts() {
            const totalCount = document.getElementById('totalCount');
            const readingCount = document.getElementById('readingCount');
            const finishedCount = document.getElementById('finishedCount');
            
            if (totalCount) totalCount.textContent = readingList.length;
            if (readingCount) readingCount.textContent = readingList.filter(b => b.status === 'reading').length;
            if (finishedCount) finishedCount.textContent = readingList.filter(b => b.status === 'finished').length;
        }
 
        function updateBook(event) {
            event.preventDefault();

            const bookId = parseInt(document.getElementById('editBookId').value);
            const title = document.getElementById('editBookTitle').value.trim();
            const author = document.getElementById('editBookAuthor').value.trim();
            const cover = document.getElementById('editBookCoverUrl').value.trim();
            const status = document.getElementById('editBookStatus').value;
            const genre = document.getElementById('editBookGenre').value.trim();
            const ratingValue = document.getElementById('editBookRating').value;
            const review = document.getElementById('editBookReview').value.trim();

            console.log('Update form values:', { bookId, title, author, cover, status, genre, ratingValue, review });

            if (!title || !author || !genre) {
                showNotification('Please fill in all required fields (Title, Author, Genre)!', 'error');
                return;
            }

            const rating = ratingValue ? parseInt(ratingValue, 10) : null;

            const bookIndex = readingList.findIndex(b => b.id === bookId);
            if (bookIndex !== -1) {
                readingList[bookIndex] = {
                    ...readingList[bookIndex],
                    title,
                    author,
                    cover: cover || '',
                    genre,
                    status,
                    rating,
                    review
                };

                localStorage.setItem('readingList', JSON.stringify(readingList));
                renderReadingList();
                closeEditBookModal();
                showNotification('â Book updated successfully!', 'success');
                console.log('Updated book:', readingList[bookIndex]);
            } else {
                console.error('Book ID not found during update:', bookId);
                showNotification('Book not found for update!', 'error');
            }
        }

        function removeBook(id) {
            if (!confirm('Are you sure you want to delete this book?')) {
                return;
            }
            readingList = readingList.filter(b => b.id !== parseInt(id));
            localStorage.setItem('readingList', JSON.stringify(readingList));
            renderReadingList();
            updateReadingCounts();
            showNotification('â Book removed successfully!', 'success');
        }


        function toggleBookStatus(id) {
            const book = readingList.find(x => x.id === parseInt(id));
            if (!book) return;

            if (book.status === 'want') {
                book.status = 'reading';
            } else if (book.status === 'reading') {
                book.status = 'finished';
            } else {
                book.status = 'want';
            }

            localStorage.setItem('readingList', JSON.stringify(readingList));
            renderReadingList();
            updateReadingCounts();
            showNotification(`â Status changed to "${getStatusText(book.status)}"!`, 'success');
        }


        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing reading list...');
            if (!checkLocalStorageAvailability()) {
                showNotification('â Bá» nhá» cá»¥c bá» bá» cháº·n hoáº·c khÃ´ng kháº£ dá»¥ng. Tiáº¿n trÃ¬nh cÃ³ thá» khÃ´ng ÄÆ°á»£c lÆ°u.', 'error');
            }

            renderReadingList();
            updateReadingCounts();
            const addBookForm = document.getElementById('addBookForm');
            const editBookForm = document.getElementById('editBookForm');
            const genreFilter = document.getElementById('genreFilter');
            const sortSelect = document.getElementById('sortReadingList');
            const searchInput = document.getElementById('searchInput'); 
            if (addBookForm) {
                addBookForm.addEventListener('submit', addBook);
            }
            if (editBookForm) {
                editBookForm.addEventListener('submit', updateBook);
            }
            if (genreFilter) {
                genreFilter.addEventListener('change', () => { renderReadingList(); updateReadingCounts(); });
            }
            if (sortSelect) {
                sortSelect.addEventListener('change', () => { renderReadingList(); updateReadingCounts(); });
            }
            if (searchInput) {
                const debouncedSearch = debounce(() => {
                    renderReadingList();
                    updateReadingCounts();
                }, 300); 
                searchInput.addEventListener('input', debouncedSearch);
            }


            window.addEventListener('click', function(event) {
                const modals = ['addBookModal', 'editBookModal', 'fullReviewModal', 'bookDetailsModal'];
                modals.forEach(id => {
                    const modal = document.getElementById(id);
                    if (event.target === modal) {
                        if (id === 'addBookModal') closeAddBookModal();
                        else if (id === 'editBookModal') closeEditBookModal();
                        else if (id === 'fullReviewModal') closeFullReviewModal();
                        else if (id === 'bookDetailsModal') closeBookDetailsModal();
                    }
                });
            });
            if (readingList.length === 0) {
                console.log('Adding demo books...');
                const demoBooks = [
                    {
                        id: Date.now() + 1,
                        title: "Money: A Story of Humanity",
                        author: "David McWilliams",
                        cover: "",
                        status: "reading",
                        genre: "Finance",
                        rating: 4,
                        review: "Interesting perspective on money throughout history.",
                        addedAt: new Date().toISOString()
                    },
                    {
                        id: Date.now() + 2,
                        title: "The Psychology of Money",
                        author: "Morgan Housel",
                        cover: "",
                        status: "finished",
                        genre: "Finance",
                        rating: 5,
                        review: "Excellent insights into behavioral finance.",
                        addedAt: new Date(Date.now() - 86400000).toISOString()
                    },
                    {
                        id: Date.now() + 3,
                        title: "Atomic Habits",
                        author: "James Clear",
                        cover: "",
                        status: "want",
                        genre: "Self-Help",
                        rating: 4,
                        review: "",
                        addedAt: new Date(Date.now() - 172800000).toISOString()
                    }
                ];                
                readingList = demoBooks;
                localStorage.setItem('readingList', JSON.stringify(readingList));
                renderReadingList();
                updateReadingCounts();
            }
        }); 

        document.addEventListener('DOMContentLoaded', function() {
            // â ADD: Setup goal type selection buttons
            document.querySelectorAll('.goal-type-option').forEach(option => {
                option.addEventListener('click', function() {
                    const type = this.dataset.type;
                    selectGoalType(type);
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const customGoalForm = document.getElementById('updateCustomGoalForm');
            if (customGoalForm) {
                customGoalForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const id = document.getElementById('updateGoalId').value;
                    const newValue = parseFloat(document.getElementById('updateGoalValue').value);
                    
                    if (isNaN(newValue) || newValue < 0) {
                        showNotification('Please enter a valid progress value.', 'error');
                        return;
                    }
                    
                    const goal = goals.find(g => g.id === id);
                    if (goal && goal.type === 'custom') {
                        goal.currentProgress = newValue;
                        saveGoals();
                        renderGoals();
                        updateGoalProgressChart();
                        closeUpdateCustomGoalModal();
                        
                        // Check if completed
                        if (goal.currentProgress >= goal.target) {
                            gamification.points += 50;
                            gamification.level = Math.floor(gamification.points / 100) + 1;
                            localStorage.setItem('gamification', JSON.stringify(gamification));
                            updateGamificationStats();
                            showNotification(`ð Goal "${goal.title}" completed! Earned 50 XP!`, 'achievement');
                        } else {
                            showNotification('â Progress updated successfully!', 'success');
                        }
                    }
                });
            }
        });

        function showNotification(message, type) {
            alert(`${type.toUpperCase()}: ${message}`);
            // Báº¡n cÃ³ thá» thay báº±ng toast notification Äáº¹p hÆ¡n
        }


        // Focus timer
        let timerDuration = parseInt(localStorage.getItem('focusTimerDuration')) || 25 * 60; 
        let remainingSeconds = parseInt(localStorage.getItem('focusRemaining')) || timerDuration;
        let timerInterval = null;
        let timerRunning = localStorage.getItem('focusRunning') === 'true';
        let focusStartTimestamp = parseInt(localStorage.getItem('focusStartTimestamp')) || null;
        let remainingAtStart = parseInt(localStorage.getItem('focusRemainingAtStart')) || null;

        function formatTime(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function updateTimerDisplay() {
            const disp = document.getElementById('timerDisplay');
            if (disp) disp.textContent = formatTime(Math.max(0, remainingSeconds));
        }

        function persistTimerState() {
            localStorage.setItem('focusRemaining', remainingSeconds);
            localStorage.setItem('focusRunning', timerRunning);
            localStorage.setItem('focusTimerDuration', timerDuration);
            if (focusStartTimestamp) {
                localStorage.setItem('focusStartTimestamp', focusStartTimestamp);
            } else {
                localStorage.removeItem('focusStartTimestamp');
            }
            if (typeof remainingAtStart === 'number') {
                localStorage.setItem('focusRemainingAtStart', remainingAtStart);
            } else {
                localStorage.removeItem('focusRemainingAtStart');
            }
        }

        function onTimerComplete() {
            clearInterval(timerInterval);
            timerInterval = null;
            timerRunning = false;
            focusStartTimestamp = null;
            remainingAtStart = null;
            remainingSeconds = timerDuration;
            persistTimerState();
            updateTimerDisplay();
            const notificationTitle = "â° Focus Session Complete!";
            const notificationBody = "Great job! You've completed your 25-minute focus block.";
            showNotification(notificationTitle, 'success');
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(notificationTitle, {
                    body: notificationBody,
                    icon: "https://cdn-icons-png.flaticon.com/512/1828/1828976.png", 
                    requireInteraction: true 
                });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(notificationTitle, {
                            body: notificationBody,
                            icon: "https://cdn-icons-png.flaticon.com/512/1828/1828976.png"
                        });
                    }
                });
            }
            const xpReward = 25;
            gamification.points += xpReward;
            gamification.level = Math.floor(gamification.points / 100) + 1;
            localStorage.setItem('gamification', JSON.stringify(gamification));
            updateGamificationStats();
        }

        function tick() {
            if (timerRunning && focusStartTimestamp && typeof remainingAtStart === 'number') {
                const elapsed = Math.floor((Date.now() - focusStartTimestamp) / 1000);
                remainingSeconds = remainingAtStart - elapsed;
                if (remainingSeconds <= 0) {
                    onTimerComplete();
                    return;
                }
            } else {
                remainingSeconds = Math.max(0, remainingSeconds - 1);
                if (remainingSeconds <= 0) {
                    onTimerComplete();
                    return;
                }
            }
            updateTimerDisplay();
            // persist occasionally
            if (Date.now() % 5000 < 1000) persistTimerState();
        }

        function startTimer() {
            if (timerRunning) return;
            timerRunning = true;
            focusStartTimestamp = Date.now();
            remainingAtStart = remainingSeconds;
            persistTimerState();

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(tick, 1000);
            updateTimerDisplay();
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (timerRunning && focusStartTimestamp && typeof remainingAtStart === 'number') {
                const elapsed = Math.floor((Date.now() - focusStartTimestamp) / 1000);
                remainingSeconds = Math.max(0, remainingAtStart - elapsed);
            }
            timerRunning = false;
            focusStartTimestamp = null;
            remainingAtStart = null;
            persistTimerState();
            updateTimerDisplay();
        }

        function resetTimer() {
            pauseTimer();
            remainingSeconds = timerDuration;
            persistTimerState();
            updateTimerDisplay();
            showNotification('ð Timer reset', 'info');
        }

        // change duration by double-click
        const timerDisplayEl = document.getElementById('timerDisplay');
        if (timerDisplayEl) {
            timerDisplayEl.addEventListener('dblclick', () => {
                const mins = prompt('Set focus length in minutes (e.g. 25):', (timerDuration/60).toString());
                const m = parseInt(mins);
                if (!isNaN(m) && m > 0) {
                    timerDuration = m * 60;
                    remainingSeconds = timerDuration;
                    focusStartTimestamp = null;
                    remainingAtStart = null;
                    persistTimerState();
                    updateTimerDisplay();
                    showNotification(`Timer set to ${m} minutes`, 'success');
                }
            });
        }

        // restore timer on load: compute elapsed time if it was running
        (function restoreTimerOnLoad() {
            if (localStorage.getItem('focusTimerDuration')) {
                timerDuration = parseInt(localStorage.getItem('focusTimerDuration'));
            }
            const storedRunning = localStorage.getItem('focusRunning') === 'true';
            const storedStart = parseInt(localStorage.getItem('focusStartTimestamp'));
            const storedRemainingAtStart = parseInt(localStorage.getItem('focusRemainingAtStart'));

            if (storedRunning && storedStart && !isNaN(storedRemainingAtStart)) {
                const elapsed = Math.floor((Date.now() - storedStart) / 1000);
                const newRemaining = storedRemainingAtStart - elapsed;
                if (newRemaining <= 0) {
                    timerRunning = false;
                    remainingSeconds = timerDuration;
                    focusStartTimestamp = null;
                    remainingAtStart = null;
                    persistTimerState();
                } else {
                    timerRunning = true;
                    focusStartTimestamp = storedStart;
                    remainingAtStart = storedRemainingAtStart;
                    remainingSeconds = newRemaining;
                    if (timerInterval) clearInterval(timerInterval);
                    timerInterval = setInterval(tick, 1000);
                }
            } else {
                remainingSeconds = parseInt(localStorage.getItem('focusRemaining')) || timerDuration;
                timerRunning = false;
                focusStartTimestamp = null;
                remainingAtStart = null;
                persistTimerState();
            }
            updateTimerDisplay();
        })();

        // --- DAILY STUDY TRACKING ---
        let dailyStudyData = JSON.parse(localStorage.getItem('dailyStudyData')) || {};
        let dailyStudyChart = null;

        // HÃ m cáº­p nháº­t dá»¯ liá»u há»c táº­p hÃ ng ngÃ y
        function updateDailyStudyData(hours) {
            const today = new Date().toDateString();
            if (!dailyStudyData[today]) {
                dailyStudyData[today] = 0;
            }
            dailyStudyData[today] += hours;
            localStorage.setItem('dailyStudyData', JSON.stringify(dailyStudyData));
        }

        // HÃ m láº¥y dá»¯ liá»u 7 ngÃ y gáº§n nháº¥t
        function getWeeklyStudyData() {
            const weeklyData = [];
            const labels = [];
            
            // Láº¥y 7 ngÃ y gáº§n nháº¥t (bao gá»m hÃ´m nay)
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = date.toDateString();
                
                // Náº¿u cÃ³ dá»¯ liá»u cho ngÃ y nÃ y, dÃ¹ng nÃ³, náº¿u khÃ´ng thÃ¬ 0
                const hours = dailyStudyData[dateString] || 0;
                weeklyData.push(hours);
                
                // Äá»nh dáº¡ng nhÃ£n ngÃ y (VD: Mon 10/1)
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const monthDay = date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
                labels.push(`${dayName} ${monthDay}`);
            }
            
            return { labels, data: weeklyData };
        }

        // HÃ m cáº­p nháº­t giao diá»n (Text + Chart)
        function updateDailyStudyDisplay() {
            // Cáº­p nháº­t text
            const today = new Date().toDateString();
            const todayHours = (dailyStudyData[today] || 0).toFixed(1);
            document.getElementById('dailyStudyInfo').textContent = `Today: ${todayHours} hours`;
            
            // Cáº­p nháº­t tá»ng (ÄÃ£ cÃ³ sáºµn tá»« updateStats(), nhÆ°ng ta sáº½ cáº­p nháº­t láº¡i Äá» Äáº£m báº£o Äá»ng bá»)
            let overallTotalHours = 0;
            Object.keys(studyHours).forEach(career => {
                overallTotalHours += Object.values(studyHours[career]).reduce((sum, hours) => sum + hours, 0);
            });
            document.getElementById('totalStudyInfo').textContent = `Total: ${overallTotalHours.toFixed(1)} hours`;
            
            // Váº½ hoáº·c cáº­p nháº­t biá»u Äá»
            renderDailyStudyChart();
        }

        // HÃ m váº½ biá»u Äá» cá»t 7 ngÃ y
        function renderDailyStudyChart() {
            const ctx = document.getElementById('dailyStudyChart').getContext('2d');
            const { labels, data } = getWeeklyStudyData();
            if (dailyStudyChart) {
                dailyStudyChart.destroy();
                dailyStudyChart = null;
            }
            
            dailyStudyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Hours Studied',
                        data: data,
                        backgroundColor: function(context) {
                            const value = context.raw;
                            if (value === Math.max(...data)) {
                                return '#3b82f6'; // Xanh dÆ°Æ¡ng Äáº­m cho ngÃ y cao nháº¥t
                            }
                            return '#60a5fa'; // Xanh nháº¡t cho cÃ¡c ngÃ y cÃ²n láº¡i
                        },
                        borderColor: '#3b82f6',
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.8,
                        categoryPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} hours`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Last 7 Days',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: 'var(--text-dark)',
                            padding: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'var(--text-muted)',
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'var(--text-muted)',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }


        // --- Course Manager Logic ---
        let courses = JSON.parse(localStorage.getItem('courses')) || [];
    courses = courses.map(course => ({
        ...course,
        url: course.url || "" // Äáº£m báº£o táº¥t cáº£ course Äá»u cÃ³ property url, máº·c Äá»nh lÃ  ""
    }));        


        const careerTitles = {
            pe: "ð¼ Private Equity",
            ib: "ð¦ Investment Banking",
            hf: "ð Hedge Funds",
            sc: "ð¯ Strategy Consulting",
            fintech: "ð³ Fintech",
            english: "ð© English",
            chinese: "ð Chinese",
            tools: "ð ï¸ Finance Tools",
            cfa1: "ð CFA Level 1",
            general: "ð General Finance"
        };

        const priorityIcons = {
            High: "ðº",
            Medium: "ð¸",
            Low: "ð»"
        };
        const difficultyIcons = {
            Beginner: "ð¢",
            Intermediate: "ð¡",
            Advanced: "ð´"
        };

        // --- Helper Functions ---
        function getPriorityIcon(importance) {
            if (importance >= 4) return priorityIcons.High;     // High (4-5)
            if (importance === 3) return priorityIcons.Medium;  // Medium (3)
            return priorityIcons.Low;                           // Low (1-2)
        }

        function saveCourses() {
            localStorage.setItem('courses', JSON.stringify(courses));
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function getStatusClass(progressPercent) {
            if (progressPercent >= 100) return 'completed';
            // CÃ³ thá» thÃªm logic cho 'active', 'paused' náº¿u cáº§n
            return 'active'; // Máº·c Äá»nh
        }

        function getDeadlineClass(deadlineString) {
            if (!deadlineString) return '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadline = new Date(deadlineString);
            deadline.setHours(0, 0, 0, 0);

            const diffTime = deadline - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return 'overdue';
            if (diffDays <= 3) return 'soon'; 
            return '';
        }

        // --- Render Functions ---
        function renderCourses() {
            const container = document.getElementById('coursesContainer');
            const careerTitleEl = document.getElementById('courseCareerTitle');
            if (!container || !careerTitleEl) return;

            careerTitleEl.textContent = skillsData[currentCareer].title;

            const filteredCourses = courses.filter(course => course.career === currentCareer);

            if (filteredCourses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No courses added yet for this career. Click \'Add Course\' to get started.</p>';
                return;
            }

            container.innerHTML = filteredCourses.map(course => {
                const progressPercent = Math.min(100, (course.hoursStudied / course.estimatedHours) * 100);
                const statusClass = getStatusClass(progressPercent);
                const deadlineClass = getDeadlineClass(course.deadline);
                const deadlineText = course.deadline ? `ð ${formatDate(course.deadline)}` : 'ð N/A';
            return `<div class="course-item" data-career="${course.career}" data-id="${course.id}">
                <div class="course-header">
                    <div class="course-title">${escapeHtml(course.title)}</div>
                    <span class="favorite-icon" onclick="toggleFavorite('${course.id}')" title="${course.favorite ? 'Remove from favorites' : 'Add to favorites'}">${course.favorite ? 'â­' : 'â'}</span>
                    <span class="course-status-badge ${statusClass}">${progressPercent >= 100 ? 'Completed' : 'Active'}</span>
                </div>
                <div class="course-meta">
                    <div class="course-difficulty">${difficultyIcons[course.difficulty]|| ''} ${course.difficulty}</div>
                    <div class="course-priority">${priorityIcons[course.priority]|| ''} ${course.priority}</div>
                    <div class="course-deadline ${deadlineClass}">${deadlineText}</div>
                </div>
                <div class="course-progress-container">
                    <div class="course-progress-fill" style="width: ${progressPercent}%"></div>
                </div>
                <div class="course-progress-text">${course.hoursStudied.toFixed(1)} / ${course.estimatedHours.toFixed(1)} hours</div>
                ${course.description ? `<div class="course-description">${escapeHtml(course.description)}</div>` : ''}
                <div class="course-actions">
                    ${course.url && course.url.trim() !== '' ? `<button class="course-action-btn open-link" onclick="window.open('${course.url}', '_blank')">ð Open</button>` : ''}                
                    <button class="course-action-btn add-hours" onclick="openAddHoursModal('${course.id}')">â±ï¸ Add Hours</button>
                    <button class="course-action-btn edit" onclick="openEditCourseModal('${course.id}')">âï¸ Edit</button>
                    <button class="course-action-btn delete" onclick="deleteCourse('${course.id}')">ðï¸ Delete</button>
                </div>
            </div>`;
            }).join('');
        }

        // --- Modal Functions ---
        function openAddCourseModal() {
            document.getElementById('courseModalTitle').textContent = 'â Add New Course';
            document.getElementById('courseForm').reset();
            document.getElementById('editCourseId').value = '';
            document.getElementById('courseCareer').value = currentCareer; 
            document.getElementById('courseModal').style.display = 'flex';
        }

        function openEditCourseModal(courseId) {
             const course = courses.find(c => c.id === courseId);
             if (!course) return;
             document.getElementById('courseModalTitle').textContent = 'âï¸ Edit Course';
             document.getElementById('editCourseId').value = course.id;
             document.getElementById('courseTitle').value = course.title;
             document.getElementById('courseCareer').value = course.career;
             document.getElementById('courseDifficulty').value = course.difficulty;
             document.getElementById('coursePriority').value = course.priority;
             document.getElementById('courseUrl').value = course.url || '';
             document.getElementById('courseEstHours').value = course.estimatedHours;
             document.getElementById('courseDeadline').value = course.deadline || '';
             document.getElementById('courseDescription').value = course.description || '';
             document.getElementById('courseModal').style.display = 'flex';
        }

        function closeCourseModal() {
            document.getElementById('courseModal').style.display = 'none';
        }

        function openAddHoursModal(courseId) {
             const course = courses.find(c => c.id === courseId);
             if (!course) return;
             document.getElementById('addHoursCourseId').value = courseId;
             document.getElementById('hoursToAdd').value = ''; // Reset input
             document.getElementById('addHoursModal').style.display = 'flex';
        }

        function closeAddHoursModal() {
            document.getElementById('addHoursModal').style.display = 'none';
        }

         // --- Course Actions ---
        function saveCourse(event) {
            event.preventDefault();
            const id = document.getElementById('editCourseId').value;
            const title = document.getElementById('courseTitle').value.trim();
            const career = document.getElementById('courseCareer').value;
            const difficulty = document.getElementById('courseDifficulty').value;
            const priority = document.getElementById('coursePriority').value;
            const url = document.getElementById('courseUrl').value.trim();
            const estimatedHours = parseFloat(document.getElementById('courseEstHours').value) || 0;
            const deadline = document.getElementById('courseDeadline').value; // CÃ³ thá» lÃ  chuá»i rá»ng
            const description = document.getElementById('courseDescription').value.trim();

            if (!title) {
                showNotification('Please enter a course title.', 'error');
                return;
            }

            if (id) {
                // Edit existing course
                const courseIndex = courses.findIndex(c => c.id === id);
                if (courseIndex !== -1) {
                    courses[courseIndex] = {
                        ...courses[courseIndex],
                        title,
                        career,
                        difficulty,
                        priority,
                        url: url || undefined,
                        estimatedHours,
                        deadline: deadline || undefined,
                        description: description || undefined,
                        favorite: courses[courseIndex].favorite || false 
                    };
                    showNotification('Course updated successfully!', 'success');
                }
            } else {
                // Add new course
                const newCourse = {
                    id: Date.now().toString(),
                    title,
                    career,
                    difficulty,
                    priority,
                    url: url || undefined,
                    estimatedHours,
                    deadline: deadline || undefined,
                    description: description || undefined,
                    hoursStudied: 0,
                    createdAt: new Date().toISOString(),
                    favorite: false 
                };                
                courses.push(newCourse);
                showNotification('Course added successfully!', 'success');
            }
            triggerBackup();
            saveCourses();
            renderCourses(); 
            closeCourseModal();
        }

        function deleteCourse(courseId) {
            if (confirm('Are you sure you want to delete this course?')) {
                courses = courses.filter(c => c.id !== courseId);
                saveCourses();
                renderCourses();
                showNotification('Course deleted.', 'info');
            }
        }

        // --- FAVORITE COURSE FUNCTION ---
        function toggleFavorite(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;
            course.favorite = !course.favorite;
            saveCourses();
            renderCourses();
            showNotification(
                course.favorite 
                    ? 'â­ Added to Favorites!' 
                    : 'â Removed from Favorites',
                'success'
            );
        }


        function addHoursToCourse(event) {
            event.preventDefault();
            const courseId = document.getElementById('addHoursCourseId').value;
            const hoursStr = document.getElementById('hoursToAdd').value.trim();
            const hours = parseFloat(hoursStr);

            if (!hours || hours <= 0) {
                showNotification('Please enter a valid number of hours.', 'error');
                return;
            }

            const course = courses.find(c => c.id === courseId);
            if (course) {
                course.hoursStudied = (course.hoursStudied || 0) + hours;
                saveCourses();

                goals.forEach(goal => {
                    if (goal.career === currentCareer) { 
                        if (goal.type === 'study_hours') {
                            if (goal.courseId === courseId) {
                                goal.currentProgress = course.hoursStudied;
                            } else if (!goal.courseId) {
                                const careerHours = studyHours[currentCareer] || {};
                                const totalHours = Object.values(careerHours).reduce((sum, h) => sum + h, 0);
                                goal.currentProgress = totalHours;
                            }
                        }
                    }
                });
                
                saveGoals();
                renderCourses();
                renderGoals();
                updateGoalProgressChart(); 
                closeAddHoursModal();

                const pointsEarned = Math.floor(hours * 10);
                gamification.points += pointsEarned;
                gamification.level = Math.floor(gamification.points / 100) + 1;
                localStorage.setItem('gamification', JSON.stringify(gamification));
                updateGamificationStats();
                updateStats();
                updateChart();
                updateDailyStreak();
                showNotification(`Added ${hours} hours to "${course.title}"! Earned ${pointsEarned} XP`, 'success');
                getRandomQuote();
                updateDailyStudyData(hours);
            }
        }



        
        // --- GOAL MANAGEMENT ---
        let goals = JSON.parse(localStorage.getItem('goals')) || [];
        let archivedGoals = JSON.parse(localStorage.getItem('archivedGoals')) || [];

        // ===== ARCHIVE FUNCTION =====
        function archiveGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            const status = getGoalStatus(goal);
            
            if (status !== 'completed') {
                showNotification('â ï¸ Only completed goals can be archived!', 'error');
                return;
            }
            
            if (confirm(`ð¦ Archive "${goal.title}"? You can view it later in History.`)) {
                // Remove from active goals
                goals = goals.filter(g => g.id !== goalId);
                
                // Add to archived with timestamp
                archivedGoals.push({
                    ...goal,
                    archivedAt: new Date().toISOString()
                });
                
                // Save both
                localStorage.setItem('archivedGoals', JSON.stringify(archivedGoals));
                saveGoals();
                
                // Update UI
                renderGoals();
                updateGoalProgressChart();
                
                showNotification('â Goal archived successfully!', 'success');
            }
        }

        // ===== RESTORE FUNCTION =====
        function restoreArchivedGoal(goalId) {
            const goal = archivedGoals.find(g => g.id === goalId);
            if (!goal) return;
            
            if (confirm(`â©ï¸ Restore "${goal.title}" back to active goals?`)) {
                // Remove from archived
                archivedGoals = archivedGoals.filter(g => g.id !== goalId);
                
                // Add back to active goals (remove archivedAt timestamp)
                const restoredGoal = { ...goal };
                delete restoredGoal.archivedAt;
                goals.push(restoredGoal);
                
                localStorage.setItem('archivedGoals', JSON.stringify(archivedGoals));
                saveGoals();
                renderGoals();
                renderArchivedGoals();
                
                showNotification(`â Goal "${goal.title}" restored!`, 'success');
            }
        }

        // ===== PERMANENT DELETE FROM ARCHIVE =====
        function permanentlyDeleteArchivedGoal(goalId) {
            const goal = archivedGoals.find(g => g.id === goalId);
            if (!goal) return;
            
            if (confirm(`ðï¸ PERMANENTLY delete "${goal.title}"? This cannot be undone!`)) {
                archivedGoals = archivedGoals.filter(g => g.id !== goalId);
                localStorage.setItem('archivedGoals', JSON.stringify(archivedGoals));
                renderArchivedGoals();
                
                // Update button count if modal is open
                const archiveBtn = document.querySelector('.goal-archive-btn');
                if (archiveBtn) {
                    archiveBtn.innerHTML = `ð¦ View Archived Goals (${archivedGoals.length})`;
                }
                
                showNotification('Goal permanently deleted', 'info');
            }
        }



        function saveGoals() {
            localStorage.setItem('goals', JSON.stringify(goals));
        }

        function getGoalStatus(goal) {
            const now = new Date();
            if (goal.deadline) {
                const deadline = new Date(goal.deadline);
                if (deadline < now) return 'overdue';
                const diffTime = deadline - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays <= 3) return 'soon';
            }
            if (goal.currentProgress >= goal.target) return 'completed';
            return 'active';
        }

        function getGoalProgressPercent(goal) {
            const progress = calculateGoalProgress(goal);
            return goal.target > 0 ? Math.min(100, (progress / goal.target) * 100) : 0;
        }


        function openAddGoalModal() {
            document.getElementById('goalModalTitle').textContent = 'â Add New Goal';
            document.getElementById('goalForm').reset();
            document.getElementById('editGoalId').value = '';
            document.getElementById('goalTypeSpecificFields').innerHTML = '';
            document.getElementById('goalModal').style.display = 'flex';
        }

        function openEditGoalModal(id) {
            const goal = goals.find(g => g.id === id);
            if (!goal) return;
            document.getElementById('goalModalTitle').textContent = 'âï¸ Edit Goal';
            document.getElementById('editGoalId').value = goal.id;
            document.getElementById('goalTitle').value = goal.title;
            document.getElementById('goalType').value = goal.type;
            populateGoalTypeSpecificFields(goal.type, goal);
            document.getElementById('goalTarget').value = goal.target;
            document.getElementById('goalDeadline').value = goal.deadline || '';
            document.getElementById('goalModal').style.display = 'flex';
        }

        function closeGoalModal() {
            document.getElementById('goalModal').style.display = 'none';
        }

        function openUpdateCustomGoalModal(id) {
            const goal = goals.find(g => g.id === id);
            if (!goal || goal.type !== 'custom') return;
            document.getElementById('updateGoalId').value = goal.id;
            document.getElementById('updateGoalValue').value = goal.currentProgress || 0;
            document.getElementById('updateCustomGoalModal').style.display = 'flex';
        }

        function closeUpdateCustomGoalModal() {
            document.getElementById('updateCustomGoalModal').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const customGoalForm = document.getElementById('updateCustomGoalForm');
            if (customGoalForm) {
                customGoalForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const id = document.getElementById('updateGoalId').value;
                    const newValue = parseFloat(document.getElementById('updateGoalValue').value);
                    
                    if (isNaN(newValue) || newValue < 0) {
                        showNotification('Please enter a valid progress value.', 'error');
                        return false;
                    }
                    
                    const goal = goals.find(g => g.id === id);
                    if (goal && goal.type === 'custom') {
                        goal.currentProgress = newValue;
                        saveGoals();
                        renderGoals();
                        updateGoalProgressChart();
                        closeUpdateCustomGoalModal();
                        
                        // Check if completed
                        if (goal.currentProgress >= goal.target) {
                            gamification.points += 50;
                            gamification.level = Math.floor(gamification.points / 100) + 1;
                            localStorage.setItem('gamification', JSON.stringify(gamification));
                            updateGamificationStats();
                            showNotification(`ð Goal "${goal.title}" completed! Earned 50 XP!`, 'achievement');
                        } else {
                            showNotification('â Progress updated successfully!', 'success');
                        }
                    }
                    return false;
                });
            }
        });


        function deleteGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            const status = getGoalStatus(goal);
            
            if (status === 'completed') {
                // â Completed goals â Archive them
                if (confirm('ð¦ Archive this completed goal? (You can view it in History later)')) {
                    goals = goals.filter(g => g.id !== goalId);

                    archivedGoals.push({
                        ...goal,
                        archivedAt: new Date().toISOString()
                    });
                    
                    localStorage.setItem('archivedGoals', JSON.stringify(archivedGoals));
                    saveGoals();
                    renderGoals();
                    updateGoalProgressChart();
                    
                    // â Update archive button count
                    const archiveBtn = document.querySelector('.goal-archive-btn');
                    if (archiveBtn) {
                        archiveBtn.innerHTML = `ð¦ View Archived Goals (${archivedGoals.length})`;
                    }
                    
                    showNotification('â Goal archived successfully!', 'success');
                }
            } else {
                // â Active/Overdue goals â Normal delete
                if (confirm('ðï¸ Permanently delete this goal? This cannot be undone.')) {
                    goals = goals.filter(g => g.id !== goalId);
                    saveGoals();
                    renderGoals();
                    updateGoalProgressChart();
                    showNotification('Goal deleted', 'info');
                }
            }
        }




        function openUpdateCustomGoalModal(id) {
            const goal = goals.find(g => g.id === id);
            if (!goal || goal.type !== 'custom') return;
            
            document.getElementById('updateGoalId').value = goal.id;
            document.getElementById('updateGoalValue').value = goal.currentProgress || 0;
            document.getElementById('updateCustomGoalModal').style.display = 'flex';
        }

        function closeUpdateCustomGoalModal() {
            document.getElementById('updateCustomGoalModal').style.display = 'none';
        }




        function quickAddStudyTime(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) {
                showNotification('Goal not found!', 'error');
                return;
            }
            const hours = parseFloat(prompt('How many hours did you study?', '1.0'));
            if (!hours || hours <= 0) {
                showNotification('Please enter a valid number of hours.', 'error');
                return;
            }
            if (goal.type === 'study_hours' || goal.type === 'skill_mastery') {
                goal.currentProgress = (goal.currentProgress || 0) + hours;
                const pointsEarned = Math.floor(hours * 10);
                gamification.points += pointsEarned;
                gamification.level = Math.floor(gamification.points / 100) + 1;
                saveGoals();
                updateGamificationStats();
                renderGoals();
                showNotification(`Added ${hours} hours to "${goal.title}"! Earned ${pointsEarned} XP`, 'success');
            }
        }   

        function updateGoals() {
            renderGoals();
        }



        document.getElementById('archivedGoalsModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeArchivedGoalsModal();
            }
        });




        function showNotification(message, type = 'success') {
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
            `;
            switch(type) {
                case 'success':
                    notification.style.background = '#27ae60';
                    break;
                case 'error':
                    notification.style.background = '#e74c3c';
                    break;
                case 'achievement':
                    notification.style.background = '#f39c12';
                    break;
                case 'info':
                default:
                    notification.style.background = '#3498db';
                    break;
            }
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }




        function populateGoalTypeSpecificFields(type, goalData = {}) {
            const container = document.getElementById('goalTypeSpecificFields');
            container.innerHTML = '';
            
            // ð STUDY HOURS GOAL
            if (type === 'study_hours') {
                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(96, 165, 250, 0.05)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                        <div style="display: flex; align-items: start; gap: 15px;">
                            <div style="font-size: 2.5rem;">ð</div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: var(--text-dark); font-size: 1.1rem;">Study Hours Goal</h4>
                                <p style="margin: 0 0 12px 0; color: var(--text-muted); font-size: 0.9rem; line-height: 1.5;">
                                    Tracks total study hours in <strong>${skillsData[currentCareer]?.title || currentCareer}</strong>.<br>
                                    â <strong>Auto-updates</strong> when you add study time to any skill in this career.
                                </p>
                                
                                <!-- â UNLOCK TARGET INPUT FOR STUDY HOURS -->
                                <div style="margin-top: 12px; padding: 12px; background: rgba(59, 130, 246, 0.08); border-radius: 8px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-dark);">
                                        ð¯ Set Your Target Hours:
                                    </label>
                                    <input type="number" id="studyHoursCustomTarget" min="1" step="1" placeholder="e.g., 300 for Advanced, 1000 for Expert"
                                        style="width: 100%; padding: 10px; border: 2px solid #3b82f6; border-radius: 8px; background: white; color: var(--text-dark); font-size: 1rem;">
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 6px;">
                                        ð¡ Tip: 300h = Advanced, 1000h = Technical Mastery, 5000h+ = Expertise
                                    </div>
                                </div>
                                
                                <!-- Smart Suggestions -->
                                <div style="background: rgba(59, 130, 246, 0.08); padding: 12px; border-radius: 8px; margin-top: 12px;">
                                    <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-dark); font-size: 0.9rem;">
                                        ð¡ Quick Presets:
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${getStudyHoursSuggestions().map(suggestion => `
                                            <button type="button" class="suggestion-btn" onclick="applyStudyHoursSuggestion(${suggestion.hours}, '${suggestion.label}')"
                                                style="padding: 6px 12px; background: white; border: 1px solid #3b82f6; border-radius: 20px; cursor: pointer; font-size: 0.85rem; color: #3b82f6; transition: all 0.2s;">
                                                ${suggestion.label} (${suggestion.hours}h)
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // â AUTO-FILL TARGET when custom input changes
                const customTargetInput = document.getElementById('studyHoursCustomTarget');
                const mainTargetInput = document.getElementById('goalTarget');
                
                if (customTargetInput && mainTargetInput) {
                    customTargetInput.addEventListener('input', function() {
                        mainTargetInput.value = this.value;
                    });
                    
                    // â If editing, pre-fill
                    if (goalData && goalData.target) {
                        customTargetInput.value = goalData.target;
                        mainTargetInput.value = goalData.target;
                    }
                }
                
            // ð¯ SKILL MASTERY GOAL
            } else if (type === 'skill_mastery') {
                const careerData = skillsData[currentCareer];
                if (!careerData) {
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No skills available for this career.</p>';
                    return;
                }
                
                // Build skill options grouped by category
                let skillOptions = '<option value="">-- Select a Skill to Master --</option>';
                Object.entries(careerData.categories).forEach(([catName, catData]) => {
                    skillOptions += `<optgroup label="${catName}">`;
                    catData.skills.forEach(skill => {
                        const completion = getSkillCompletion(currentCareer, skill.name);
                        const statusEmoji = completion.completed ? 'â' : 'ð';
                        const progressText = `${completion.progress.toFixed(1)}/${completion.target}h`;
                        skillOptions += `<option value="${skill.name}" ${goalData.skillName === skill.name ? 'selected' : ''}>
                            ${statusEmoji} ${skill.name} (${progressText})
                        </option>`;
                    });
                    skillOptions += `</optgroup>`;
                });
                
                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                        <div style="display: flex; align-items: start; gap: 15px;">
                            <div style="font-size: 2.5rem;">ð¯</div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: var(--text-dark); font-size: 1.1rem;">Skill Mastery Goal</h4>
                                <p style="margin: 0 0 15px 0; color: var(--text-muted); font-size: 0.9rem; line-height: 1.5;">
                                    Master a specific skill. Progress <strong>auto-updates</strong> when you study that skill.<br>
                                    â Target hours are set automatically from skill requirements.
                                </p>
                                
                                <label for="goalSkillSelect" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">
                                    Choose Skill to Master:
                                </label>
                                <select id="goalSkillSelect" required 
                                    style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-white); color: var(--text-dark); font-size: 0.95rem; cursor: pointer;">
                                    ${skillOptions}
                                </select>
                                
                                <div id="skillPreview" style="margin-top: 12px; padding: 10px; background: rgba(16, 185, 129, 0.08); border-radius: 8px; display: none;">
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                                        <strong>Current Progress:</strong> <span id="skillCurrentHours">0</span>h / <span id="skillTargetHours">0</span>h
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Auto-update target when skill selected
                const skillSelect = document.getElementById('goalSkillSelect');
                const targetInput = document.getElementById('goalTarget');
                const titleInput = document.getElementById('goalTitle');
                const skillPreview = document.getElementById('skillPreview');
                
                if (skillSelect && targetInput) {
                    skillSelect.addEventListener('change', function() {
                        const selectedSkill = this.value;
                        if (selectedSkill) {
                            const completion = getSkillCompletion(currentCareer, selectedSkill);
                            
                            // Auto-fill target
                            targetInput.value = completion.target;
                            targetInput.readOnly = true;
                            targetInput.style.background = '#f8fafc';
                            targetInput.style.border = '2px solid #10b981';
                            
                            // Auto-suggest title if empty
                            if (!titleInput.value.trim()) {
                                titleInput.value = `Master ${selectedSkill}`;
                            }
                            
                            // Show preview
                            if (skillPreview) {
                                document.getElementById('skillCurrentHours').textContent = completion.progress.toFixed(1);
                                document.getElementById('skillTargetHours').textContent = completion.target;
                                skillPreview.style.display = 'block';
                            }
                        } else {
                            targetInput.readOnly = false;
                            targetInput.style.background = 'var(--bg-white)';
                            targetInput.style.border = '1px solid var(--border-color)';
                            if (skillPreview) skillPreview.style.display = 'none';
                        }
                    });
                    
                    // Trigger change if editing existing goal
                    if (goalData.skillName) {
                        skillSelect.dispatchEvent(new Event('change'));
                    }
                }
                
            // â CUSTOM GOAL
            } else if (type === 'custom') {
                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.05), rgba(245, 158, 11, 0.05)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #fbbf24;">
                        <div style="display: flex; align-items: start; gap: 15px;">
                            <div style="font-size: 2.5rem;">â</div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: var(--text-dark); font-size: 1.1rem;">Custom Goal</h4>
                                <p style="margin: 0 0 12px 0; color: var(--text-muted); font-size: 0.9rem; line-height: 1.5;">
                                    Track anything you want! You <strong>manually update</strong> progress by clicking "Update" button.<br>
                                    â Does NOT auto-update with study hours.
                                </p>
                                
                                <div style="background: rgba(251, 191, 36, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid #fbbf24;">
                                    <div style="font-weight: 600; margin-bottom: 6px; color: var(--text-dark); font-size: 0.9rem;">
                                        ð¡ Examples of Custom Goals:
                                    </div>
                                    <ul style="margin: 0; padding-left: 20px; color: var(--text-muted); font-size: 0.85rem; line-height: 1.8;">
                                        <li>Read 20 finance books this year</li>
                                        <li>Complete 100 workout sessions</li>
                                        <li>Learn 500 Chinese characters</li>
                                        <li>Attend 10 networking events</li>
                                        <li>Build 5 side projects</li>
                                    </ul>
                                </div>
                                
                                <!-- Quick Custom Suggestions -->
                                <div style="margin-top: 12px;">
                                    <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-dark); font-size: 0.9rem;">
                                        Quick Templates:
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${getCustomGoalTemplates().map(template => `
                                            <button type="button" onclick="applyCustomTemplate('${template.title}', ${template.target})"
                                                style="padding: 6px 12px; background: white; border: 1px solid #fbbf24; border-radius: 20px; cursor: pointer; font-size: 0.85rem; color: #92400e; transition: all 0.2s;">
                                                ${template.title}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // â Apply Study Hours Suggestion (different from skill-based suggestion)
        function applyStudyHoursSuggestion(hours, label) {
            const customInput = document.getElementById('studyHoursCustomTarget');
            const targetInput = document.getElementById('goalTarget');
            const titleInput = document.getElementById('goalTitle');
            
            if (customInput) customInput.value = hours;
            if (targetInput) targetInput.value = hours;
            
            // Auto-suggest title if empty
            if (titleInput && !titleInput.value.trim()) {
                const careerTitle = skillsData[currentCareer]?.title || currentCareer;
                titleInput.value = `${label} in ${careerTitle}`;
            }
            
            showNotification(`â Target set to ${hours} hours (${label})`, 'success');
        }



        // Helper: Get Study Hours Suggestions based on career
        function getStudyHoursSuggestions() {
            const suggestions = [
                { label: 'Foundation', hours: 50 },
                { label: 'Intermediate', hours: 150 },
                { label: 'Advanced', hours: 300 },
            ];
            
            // Career-specific suggestions
            if (currentCareer === 'pe' || currentCareer === 'ib') {
                suggestions.push({ label: 'Expert', hours: 500 });
            } else if (currentCareer === 'hf') {
                suggestions.push({ label: 'Quant Expert', hours: 600 });
            } else if (currentCareer === 'cfa1') {
                suggestions.push({ label: 'CFA L1 Ready', hours: 300 });
            }
            
            return suggestions;
        }

        // Helper: Apply Suggestion to Target
        function applySuggestion(hours, label) {
            const targetInput = document.getElementById('goalTarget');
            const titleInput = document.getElementById('goalTitle');
            
            if (targetInput) {
                targetInput.value = hours;
            }
            
            // Auto-suggest title if empty
            if (titleInput && !titleInput.value.trim()) {
                const careerTitle = skillsData[currentCareer]?.title || currentCareer;
                titleInput.value = `${label} in ${careerTitle}`;
            }
            
            showNotification(`â Target set to ${hours} hours`, 'success');
        }

        // Helper: Get Custom Goal Templates
        function getCustomGoalTemplates() {
            return [
                { title: 'ð Read 20 Books', target: 20 },
                { title: 'ðª 100 Workouts', target: 100 },
                { title: 'ð¯ 10 Projects', target: 10 },
                { title: 'ð Learn 500 Words', target: 500 }
            ];
        }

        // Helper: Apply Custom Template
        function applyCustomTemplate(title, target) {
            const titleInput = document.getElementById('goalTitle');
            const targetInput = document.getElementById('goalTarget');
            
            if (titleInput) titleInput.value = title;
            if (targetInput) targetInput.value = target;
            
            showNotification(`â Template applied: ${title}`, 'success');
        }


        function renderGoals() {
            const container = document.getElementById('goalsContainer');
            const careerTitleEl = document.getElementById('goalsCareerTitle');
            
            if (!container || !careerTitleEl) return;
            
            const careerData = skillsData[currentCareer];
            if (careerData) {
                careerTitleEl.textContent = careerData.title;
                careerTitleEl.setAttribute('data-career', currentCareer);
            }
            
            // â Lá»c Active vÃ  Completed goals
            const activeGoals = goals.filter(g => 
                g.career === currentCareer && getGoalStatus(g) !== 'completed'
            );
            const completedGoals = goals.filter(g => 
                g.career === currentCareer && getGoalStatus(g) === 'completed'
            );
            
            // â Náº¿u khÃ´ng cÃ³ goals nÃ o
            if (activeGoals.length === 0 && completedGoals.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px 20px; color: var(--text-muted);">
                        <div style="font-size: 5rem; margin-bottom: 15px; opacity: 0.5;">ð¯</div>
                        <h3 style="margin: 0 0 10px 0; color: var(--text-dark);">No Goals Yet</h3>
                        <p style="margin: 0 0 20px 0; font-size: 0.95rem;">
                            Set your first goal to start tracking progress in ${careerData ? careerData.title : currentCareer}.
                        </p>
                        <button onclick="showSmartSuggestions()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ð¡ Show Smart Suggestions
                        </button>
                    </div>
                `;
                updateGoalProgressChart();
                return;
            }
            
            let html = '';
            
            // â ACTIVE GOALS SECTION (Always Expanded)
            if (activeGoals.length > 0) {
                html += `
                    <div class="goals-section active-section" style="margin-bottom: 24px;">
                        <div class="section-header" style="display: flex; align-items: center; gap: 10px; padding: 12px 0; margin-bottom: 16px; border-bottom: 2px solid rgba(59, 130, 246, 0.2);">
                            <span style="font-size: 1.3rem; font-weight: 700; color: var(--text-dark);">
                                ð Active Goals
                            </span>
                            <span style="background: rgba(59, 130, 246, 0.15); color: #3b82f6; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                ${activeGoals.length}
                            </span>
                        </div>
                        <div class="goals-list">
                            ${activeGoals.map(goal => {
                                calculateGoalProgress(goal);
                                const status = getGoalStatus(goal);
                                const progressPercent = getGoalProgressPercent(goal);
                                const forecast = calculateGoalForecast(goal);
                                return renderGoalCard(goal, status, progressPercent, forecast);
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // â COMPLETED GOALS SECTION (Collapsible)
            if (completedGoals.length > 0) {
                const isExpanded = localStorage.getItem('completedGoalsExpanded') !== 'false';
                
                html += `
                    <div class="goals-section completed-section" style="margin-top: 24px;">
                        <div class="section-header" onclick="toggleCompletedGoals()" 
                            style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; margin-bottom: ${isExpanded ? '16px' : '0'}; background: rgba(16, 185, 129, 0.05); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; border: 1px solid rgba(16, 185, 129, 0.15);">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.3rem; font-weight: 700; color: #10b981;">
                                    â Completed Goals
                                </span>
                                <span style="background: rgba(16, 185, 129, 0.2); color: #065f46; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                    ${completedGoals.length}
                                </span>
                            </div>
                            <span class="toggle-icon" style="font-size: 1.2rem; color: #10b981; transition: transform 0.3s ease; ${isExpanded ? '' : 'transform: rotate(-90deg);'}">
                                â¼
                            </span>
                        </div>
                        <div class="goals-list completed-goals-list" style="display: ${isExpanded ? 'block' : 'none'};">
                            ${completedGoals.map(goal => {
                                calculateGoalProgress(goal);
                                const status = getGoalStatus(goal);
                                const progressPercent = getGoalProgressPercent(goal);
                                return renderGoalCard(goal, status, progressPercent, null);
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // â Render HTML vÃ o container
            container.innerHTML = html;

            // â ThÃªm nÃºt "View Archived Goals" NGAY SAU khi set innerHTML
            const addGoalBtn = document.querySelector('.goal-add-btn');
            if (addGoalBtn && !document.querySelector('.goal-archive-btn')) {
                const archiveBtn = document.createElement('button');
                archiveBtn.className = 'goal-archive-btn';
                archiveBtn.onclick = openArchivedGoalsModal;
                archiveBtn.innerHTML = `ð¦ View Archived Goals (${archivedGoals.length})`;
                archiveBtn.style.cssText = `
                    width: 100%; 
                    padding: 12px; 
                    background: rgba(100, 116, 139, 0.1); 
                    color: #64748b; 
                    border: 1px solid #cbd5e1; 
                    border-radius: 12px; 
                    font-weight: 600; 
                    font-size: 0.95rem; 
                    cursor: pointer; 
                    transition: all 0.3s ease; 
                    margin-bottom: 15px; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    gap: 8px;
                `;
                addGoalBtn.parentNode.insertBefore(archiveBtn, addGoalBtn.nextSibling);
            }

            // â Cáº­p nháº­t biá»u Äá» sau cÃ¹ng
            updateGoalProgressChart();
        }


        function toggleCompletedGoals() {
            const list = document.querySelector('.completed-goals-list');
            const icon = document.querySelector('.completed-section .toggle-icon');
            
            if (!list || !icon) return;
            
            const isExpanded = list.style.display !== 'none';
            
            list.style.display = isExpanded ? 'none' : 'block';
            icon.style.transform = isExpanded ? 'rotate(-90deg)' : 'rotate(0)';
            
            // â Save state to localStorage
            localStorage.setItem('completedGoalsExpanded', !isExpanded);
        }


        function toggleCompletedGoals() {
            const list = document.querySelector('.completed-goals-list');
            const icon = document.querySelector('.completed-section .toggle-icon');
            
            if (!list || !icon) return;
            
            const isExpanded = list.style.display !== 'none';
            
            list.style.display = isExpanded ? 'none' : 'block';
            icon.style.transform = isExpanded ? 'rotate(-90deg)' : 'rotate(0)';
            
            localStorage.setItem('completedGoalsExpanded', !isExpanded);
        }

        // Calculate Goal Forecast (7-day average + estimated completion)
        function calculateGoalForecast(goal) {
            if (goal.type === 'custom' || goal.currentProgress >= goal.target) {
                return null;
            }
            
            // Get last 7 days of progress
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const recentProgress = goal.progressHistory?.filter(p => p.timestamp > sevenDaysAgo) || [];
            
            if (recentProgress.length === 0) {
                return null;
            }
            
            // Calculate daily average
            const totalRecentProgress = recentProgress.reduce((sum, p) => sum + p.amount, 0);
            const dailyAverage = totalRecentProgress / 7;
            
            if (dailyAverage <= 0) {
                return null;
            }
            
            // Calculate days until completion
            const remaining = goal.target - goal.currentProgress;
            const daysUntilCompletion = Math.ceil(remaining / dailyAverage);
            const estimatedDate = new Date(Date.now() + daysUntilCompletion * 24 * 60 * 60 * 1000);
            
            return {
                dailyAverage: dailyAverage.toFixed(1),
                daysUntilCompletion,
                estimatedDate: estimatedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                isRealistic: daysUntilCompletion <= 365 // Less than a year
            };
        }

        // Render Individual Goal Card with Enhanced Visuals
        function renderGoalCard(goal, status, progressPercent, forecast) {
            const statusConfig = {
                active: { 
                    badge: 'ð Active', 
                    color: '#3b82f6',
                    bgColor: 'rgba(59, 130, 246, 0.1)',
                    borderColor: '#3b82f6'
                },
                overdue: { 
                    badge: 'â° Overdue', 
                    color: '#ef4444',
                    bgColor: 'rgba(239, 68, 68, 0.1)',
                    borderColor: '#ef4444'
                },
                completed: { 
                    badge: 'â Completed', 
                    color: '#10b981',
                    bgColor: 'rgba(16, 185, 129, 0.1)',
                    borderColor: '#10b981'
                }
            };
            
            const config = statusConfig[status] || statusConfig.active;
            const typeIcons = {
                study_hours: 'ð',
                skill_mastery: 'ð¯',
                custom: 'â'
            };
            
            const deadlineText = goal.deadline 
                ? formatDate(goal.deadline)
                : 'No deadline';
            
            const deadlineClass = status === 'overdue' 
                ? 'style="color: #ef4444; font-weight: 600;"'
                : status === 'soon' 
                ? 'style="color: #f59e0b; font-weight: 600;"'
                : '';
            
            return `
                <div class="goal-item" data-id="${goal.id}" 
                    style="background: var(--bg-white); border-radius: 12px; padding: 20px; margin-bottom: 16px; border-left: 4px solid ${config.borderColor}; box-shadow: var(--shadow-sm); transition: all 0.3s ease;">
                    
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                        <div style="flex: 1; min-width: 200px;">
                            <div style="font-size: 1.15rem; font-weight: 700; color: var(--text-dark); margin-bottom: 6px; line-height: 1.3;">
                                ${typeIcons[goal.type]} ${escapeHtml(goal.title)}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                ${getGoalTypeLabel(goal)} ${goal.skillName ? `â¢ ${goal.skillName}` : ''}
                            </div>
                        </div>
                        <span style="padding: 6px 14px; background: ${config.bgColor}; color: ${config.color}; border-radius: 20px; font-size: 0.8rem; font-weight: 600; white-space: nowrap;">
                            ${config.badge}
                        </span>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div style="margin: 16px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-dark);">
                                ${goal.currentProgress.toFixed(1)} / ${goal.target} ${goal.type === 'custom' ? 'items' : 'hours'}
                            </span>
                            <span style="font-size: 0.9rem; font-weight: 700; color: ${config.color};">
                                ${progressPercent.toFixed(0)}%
                            </span>
                        </div>
                        <div style="width: 100%; height: 10px; background: var(--border-color); border-radius: 10px; overflow: hidden;">
                            <div style="height: 100%; width: ${Math.min(100, progressPercent)}%; background: linear-gradient(90deg, ${config.color}, ${config.color}dd); border-radius: 10px; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                    
                    <!-- Forecast Section -->
                    ${forecast && status !== 'completed' ? `
                        <div style="background: rgba(59, 130, 246, 0.05); padding: 12px; border-radius: 8px; margin: 12px 0; border-left: 3px solid #3b82f6;">
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">
                                ð <strong>Progress Forecast</strong>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 0.85rem;">
                                <div>
                                    <span style="color: var(--text-muted);">7-day avg:</span>
                                    <strong style="color: var(--text-dark);"> ${forecast.dailyAverage}h/day</strong>
                                </div>
                                <div>
                                    <span style="color: var(--text-muted);">Est. completion:</span>
                                    <strong style="color: ${forecast.isRealistic ? '#10b981' : '#f59e0b'};"> ${forecast.estimatedDate}</strong>
                                </div>
                                <div>
                                    <span style="color: var(--text-muted);">Days left:</span>
                                    <strong style="color: var(--text-dark);"> ~${forecast.daysUntilCompletion}</strong>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Meta Info -->
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin: 12px 0; font-size: 0.85rem; color: var(--text-muted);">
                        <div>ð Deadline: <strong ${deadlineClass}>${deadlineText}</strong></div>
                        ${goal.createdAt ? `<div>ð Created: ${formatDate(goal.createdAt)}</div>` : ''}
                    </div>
                    
                    <!-- Actions -->
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                        ${renderGoalActionButtons(goal, status)}
                    </div>
                </div>
            `;
        }

        // Helper: Get Goal Type Label
        function getGoalTypeLabel(goal) {
            const labels = {
                study_hours: 'ð Study Hours (Auto-sync)',
                skill_mastery: 'ð¯ Skill Mastery (Auto-sync)',
                custom: 'â Custom Goal (Manual)'
            };
            return labels[goal.type] || goal.type;
        }

        function renderGoalActionButtons(goal, status) {
            let buttons = '';
            
            // â Update Progress (ONLY for custom goals)
            if (goal.type === 'custom') {
                buttons += `
                    <button onclick="openUpdateCustomGoalModal('${goal.id}')" 
                        style="padding: 8px 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;">
                        âï¸ Update Progress
                    </button>
                `;
            }
            
            // â Edit Goal
            buttons += `
                <button onclick="openEditGoalModal('${goal.id}')" 
                    style="padding: 8px 14px; background: var(--bg-light); color: var(--text-dark); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;">
                    âï¸ Edit
                </button>
            `;
            
            // â ARCHIVE BUTTON (for completed) OR DELETE (for active)
            if (status === 'completed') {
                buttons += `
                    <button onclick="deleteGoal('${goal.id}')" 
                        style="padding: 8px 14px; background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid #10b981; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;">
                        ð¦ Archive
                    </button>
                `;
            } else {
                buttons += `
                    <button onclick="deleteGoal('${goal.id}')" 
                        style="padding: 8px 14px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;">
                        ðï¸ Delete
                    </button>
                `;
            }
            
            return buttons;
        }




        // ===== OPEN ARCHIVED GOALS MODAL =====
        function openArchivedGoalsModal() {
            document.getElementById('archivedGoalsModal').style.display = 'flex';
            renderArchivedGoals();
        }

        // ===== CLOSE ARCHIVED GOALS MODAL =====
        function closeArchivedGoalsModal() {
            document.getElementById('archivedGoalsModal').style.display = 'none';
        }

        // ===== RENDER ARCHIVED GOALS =====
        function renderArchivedGoals() {
            const container = document.getElementById('archivedGoalsContainer');
            const careerFilter = document.getElementById('archiveCareerFilter').value;
            
            if (!container) return;
            
            let filteredArchived = archivedGoals;
            
            if (careerFilter !== 'all') {
                filteredArchived = archivedGoals.filter(g => g.career === careerFilter);
            }
            
            if (filteredArchived.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <div style="font-size: 4rem; margin-bottom: 15px; opacity: 0.3;">ð¦</div>
                        <h3 style="margin: 0 0 8px 0; color: var(--text-dark);">No Archived Goals</h3>
                        <p style="margin: 0; font-size: 0.95rem;">
                            ${careerFilter === 'all' ? 'Complete some goals to see them here!' : 'No archived goals for this career yet.'}
                        </p>
                    </div>
                `;
                return;
            }
            
            // Sort by archived date (newest first)
            filteredArchived.sort((a, b) => new Date(b.archivedAt) - new Date(a.archivedAt));
            
            // Group by month
            const groupedByMonth = {};
            filteredArchived.forEach(goal => {
                const date = new Date(goal.archivedAt);
                const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                
                if (!groupedByMonth[monthKey]) {
                    groupedByMonth[monthKey] = [];
                }
                groupedByMonth[monthKey].push(goal);
            });
            
            let html = `
                <div style="margin-bottom: 20px; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border-left: 4px solid #10b981;">
                    <div style="font-size: 1.1rem; font-weight: 600; color: #10b981; margin-bottom: 8px;">
                        ð Total Achievements
                    </div>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px;">
                            <div style="font-size: 0.85rem; color: var(--text-muted);">Total Archived</div>
                            <div style="font-size: 1.8rem; font-weight: 700; color: #10b981;">${filteredArchived.length}</div>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <div style="font-size: 0.85rem; color: var(--text-muted);">Total Hours Completed</div>
                            <div style="font-size: 1.8rem; font-weight: 700; color: #10b981;">
                                ${filteredArchived.reduce((sum, g) => sum + (g.target || 0), 0).toFixed(0)}h
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Render each month group
            Object.entries(groupedByMonth).forEach(([month, goals]) => {
                html += `
                    <div style="margin-bottom: 30px;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-dark); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border-color); display: flex; align-items: center; gap: 10px;">
                            ð ${month}
                            <span style="font-size: 0.85rem; font-weight: 500; color: var(--text-muted);">(${goals.length} goals)</span>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            ${goals.map(goal => renderArchivedGoalCard(goal)).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }


// ===== RENDER ARCHIVED GOAL CARD =====
function renderArchivedGoalCard(goal) {
    const archivedDate = new Date(goal.archivedAt);
    const progressPercent = getGoalProgressPercent(goal);
    
    return `
        <div class="goal-item" style="border-left-color: #10b981; position: relative;">
            <!-- Achievement Badge -->
            <div style="position: absolute; top: 10px; right: 10px; padding: 4px 12px; background: #10b981; color: white; border-radius: 12px; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 5px;">
                ð ACHIEVED
            </div>
            
            <div class="goal-header">
                <div class="goal-title" style="color: #10b981; font-size: 1.1rem;">
                    ${goal.title}
                </div>
            </div>
            
            <div class="goal-meta">
                <div class="goal-type">
                    <span class="goal-icon">${getGoalTypeIcon(goal.type)}</span>
                    <span>${getGoalTypeDisplayName(goal.type)}</span>
                </div>
                <div class="goal-deadline">
                    <span class="goal-icon">ð</span>
                    <span>Archived: ${formatDate(archivedDate)}</span>
                </div>
                ${goal.career ? `
                    <div style="display: flex; align-items: center; gap: 6px; padding: 4px 12px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; font-size: 0.85rem; color: var(--text-dark);">
                        ${getCareerIcon(goal.career)}
                        <span>${getCareerDisplayName(goal.career)}</span>
                    </div>
                ` : ''}
            </div>
            
            <!-- Progress Bar -->
            <div class="goal-progress-container">
                <div class="goal-progress-fill completed" style="width: 100%;"></div>
            </div>
            
            <div class="goal-progress-text">
                <strong>${goal.target} ${goal.type === 'study_hours' ? 'hours' : 'units'}</strong> completed
            </div>
            
            <!-- Original Goal Info -->
            <div style="margin: 12px 0; padding: 12px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Original Goal:</div>
                    <div style="font-size: 0.85rem; color: #10b981; font-weight: 600;">
                        ${goal.target} ${goal.type === 'study_hours' ? 'hours' : 'units'} target
                    </div>
                </div>
                ${goal.deadline ? `
                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                        ð Original deadline: ${formatDate(new Date(goal.deadline))}
                    </div>
                ` : ''}
            </div>
            
            <!-- Action Buttons -->
            <div class="goal-actions">
                <button onclick="restoreArchivedGoal('${goal.id}')" class="goal-action-btn" style="background: rgba(16, 185, 129, 0.1); color: #10b981; border-color: #10b981;">
                    â©ï¸ Restore Goal
                </button>
                <button onclick="permanentlyDeleteArchivedGoal('${goal.id}')" class="goal-action-btn delete">
                    ðï¸ Delete Forever
                </button>
            </div>
        </div>
    `;
}

// ===== CLEAR ALL ARCHIVED GOALS =====
function clearAllArchivedGoals() {
    if (archivedGoals.length === 0) {
        showNotification('No archived goals to clear.', 'info');
        return;
    }
    
    if (confirm(`â ï¸ PERMANENTLY delete ALL ${archivedGoals.length} archived goals? This cannot be undone!`)) {
        archivedGoals = [];
        localStorage.setItem('archivedGoals', JSON.stringify(archivedGoals));
        
        // Update UI
        renderArchivedGoals();
        
        // Update archive button count
        const archiveBtn = document.querySelector('.goal-archive-btn');
        if (archiveBtn) {
            archiveBtn.innerHTML = `ð¦ View Archived Goals (${archivedGoals.length})`;
        }
        
        showNotification(`ðï¸ All archived goals have been permanently deleted.`, 'info');
    }
}





// ===== CALCULATE GOAL PROGRESS =====
function calculateGoalProgress(goal) {
    // For study_hours goals, sum up sessions
    if (goal.type === 'study_hours') {
        const sessions = JSON.parse(localStorage.getItem('studySessions') || '[]');
        return sessions
            .filter(s => s.courseId === goal.courseId)
            .reduce((total, s) => total + (parseFloat(s.duration) || 0), 0);
    }
    // For custom and skill_mastery goals, use stored progress
    return goal.currentProgress || 0;
}

// ===== HELPER FUNCTIONS =====
function getGoalTypeIcon(type) {
    const icons = {
        'study_hours': 'ð',
        'skill_mastery': 'ð¯',
        'custom': 'â'
    };
    return icons[type] || 'ð';
}

function getGoalTypeDisplayName(type) {
    const names = {
        'study_hours': 'Study Hours',
        'skill_mastery': 'Skill Mastery',
        'custom': 'Custom Goal'
    };
    return names[type] || 'Goal';
}

function getCareerIcon(career) {
    const icons = {
        'pe': 'ð¼',
        'ib': 'ð¦',
        'hf': 'ð',
        'sc': 'ð¯',
        'fintech': 'ð³',
        'english': 'ð©',
        'chinese': 'ð',
        'tools': 'ð ï¸',
        'cfa1': 'ð'
    };
    return icons[career] || 'ð¯';
}

function getCareerDisplayName(career) {
    const names = {
        'pe': 'Private Equity',
        'ib': 'Investment Banking',
        'hf': 'Hedge Funds',
        'sc': 'Strategy Consulting',
        'fintech': 'Fintech',
        'english': 'English',
        'chinese': 'Chinese',
        'tools': 'Finance Tools',
        'cfa1': 'CFA Level 1'
    };
    return names[career] || career;
}

function formatDate(date) {
    if (!date) return '';
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// ===== INITIAL RENDER =====
document.addEventListener('DOMContentLoaded', function() {
    // Initialize archive button with count
    const archiveBtn = document.querySelector('.goal-archive-btn');
    if (archiveBtn) {
        archiveBtn.innerHTML = `ð¦ View Archived Goals (${archivedGoals.length})`;
        archiveBtn.onclick = openArchivedGoalsModal;
    }
    
    // Add event listener for archive career filter
    const archiveFilter = document.getElementById('archiveCareerFilter');
    if (archiveFilter) {
        archiveFilter.addEventListener('change', renderArchivedGoals);
    }
});


        // Track Progress History (for forecasting)
        function trackGoalProgressHistory(goalId, amount) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            if (!goal.progressHistory) {
                goal.progressHistory = [];
            }  
            goal.progressHistory.push({
                timestamp: Date.now(),
                amount: amount
            });
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            goal.progressHistory = goal.progressHistory.filter(p => p.timestamp > thirtyDaysAgo);
            
            saveGoals();
        }


        function showSmartSuggestions() {
            const suggestions = suggestGoalsForCareer(currentCareer);
            
            if (suggestions.length === 0) {
                showNotification('No suggestions available for this career yet.', 'info');
                return;
            }
            const modal = document.createElement('div');
            modal.id = 'smartSuggestionsModal';
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                backdrop-filter: blur(4px);
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-white); border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="padding: 24px; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; background: var(--bg-white); z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0 0 8px 0; font-size: 1.5rem; color: var(--text-dark);">
                                    ð¡ Smart Goal Suggestions
                                </h2>
                                <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">
                                    Recommended goals for <strong>${skillsData[currentCareer]?.title || currentCareer}</strong>
                                </p>
                            </div>
                            <button onclick="closeSmartSuggestions()" 
                                style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-muted); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s;">
                                Ã
                            </button>
                        </div>
                    </div>
                    
                    <!-- Body -->
                    <div style="padding: 20px;">
                        ${renderSuggestionsByTier(suggestions)}
                    </div>
                    
                    <!-- Footer -->
                    <div style="padding: 16px 24px; border-top: 1px solid var(--border-color); background: var(--bg-light); text-align: center;">
                        <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">
                            ð¡ Click any suggestion to add it as a goal
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listener for backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeSmartSuggestions();
                }
            });
        }

        // Close Smart Suggestions Modal
        function closeSmartSuggestions() {
            const modal = document.getElementById('smartSuggestionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Render Suggestions by Tier
        function renderSuggestionsByTier(suggestions) {
            // Group suggestions by category
            const tiers = {
                foundation: suggestions.filter(s => s.target <= 100 || s.description?.includes('Foundation')),
                intermediate: suggestions.filter(s => s.target > 100 && s.target <= 500 && !s.description?.includes('Foundation') && !s.description?.includes('Expert')),
                advanced: suggestions.filter(s => s.target > 500 && !s.description?.includes('Expert')),
                expert: suggestions.filter(s => s.description?.includes('Expert') || s.target >= 1000)
            };
            
            const tierConfig = {
                foundation: {
                    title: 'ð± Foundation Level',
                    description: 'Start your journey here',
                    color: '#10b981',
                    bgColor: 'rgba(16, 185, 129, 0.1)'
                },
                intermediate: {
                    title: 'ð Intermediate Level',
                    description: 'Build your skills',
                    color: '#3b82f6',
                    bgColor: 'rgba(59, 130, 246, 0.1)'
                },
                advanced: {
                    title: 'ð Advanced Level',
                    description: 'Level up your expertise',
                    color: '#8b5cf6',
                    bgColor: 'rgba(139, 92, 246, 0.1)'
                },
                expert: {
                    title: 'ð Expert Level',
                    description: 'Reach mastery',
                    color: '#f59e0b',
                    bgColor: 'rgba(245, 158, 11, 0.1)'
                }
            };
            
            let html = '';
            
            Object.entries(tiers).forEach(([tier, goals]) => {
                if (goals.length === 0) return;
                
                const config = tierConfig[tier];
                
                html += `
                    <div style="margin-bottom: 30px;">
                        <!-- Tier Header -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid ${config.color};">
                            <div style="font-size: 1.3rem; font-weight: 700; color: ${config.color};">
                                ${config.title}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); font-style: italic;">
                                ${config.description}
                            </div>
                        </div>
                        
                        <!-- Goal Cards -->
                        <div style="display: grid; gap: 12px;">
                            ${goals.map(suggestion => renderSuggestionCard(suggestion, config)).join('')}
                        </div>
                    </div>
                `;
            });
            
            return html || '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No suggestions available.</p>';
        }



        function renderSuggestionCard(suggestion, config) {
            if (!suggestion || !config) return '';    
            const typeIcons = {
                study_hours: 'ð',
                skill_mastery: 'ð¯',
                custom: 'â'
            };
            const icon = typeIcons[suggestion.type] || 'ð';
            const existingGoal = goals.find(g => 
                g.title === suggestion.title && 
                g.career === currentCareer
            );
            
            return `
                <div class="suggestion-card" 
                    onclick="${existingGoal ? '' : `applySuggestionToGoal(${JSON.stringify(suggestion).replace(/"/g, '&quot;')})`}"
                    style="
                        padding: 16px;
                        background: ${existingGoal ? 'var(--bg-light)' : config.bgColor};
                        border: 2px solid ${existingGoal ? 'var(--border-color)' : config.color};
                        border-radius: 12px;
                        cursor: ${existingGoal ? 'default' : 'pointer'};
                        transition: all 0.3s ease;
                        opacity: ${existingGoal ? '0.6' : '1'};
                        ${existingGoal ? '' : 'box-shadow: 0 2px 8px rgba(0,0,0,0.05);'}
                    ">
                    <div style="display: flex; gap: 12px; align-items: start;">
                        <div style="font-size: 2rem; flex-shrink: 0;">${icon}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 4px; font-size: 1rem; line-height: 1.3;">
                                ${suggestion.title}
                                ${existingGoal ? '<span style="margin-left: 8px; font-size: 0.75rem; color: #10b981;">â Added</span>' : ''}
                            </div>
                            ${suggestion.description ? `
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; line-height: 1.4;">
                                    ${suggestion.description}
                                </div>
                            ` : ''}
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 0.8rem; color: var(--text-muted);">
                                <span style="padding: 4px 10px; background: white; border-radius: 12px; font-weight: 500;">
                                    ð¯ ${suggestion.target} ${suggestion.type === 'custom' ? 'items' : 'hours'}
                                </span>
                                ${suggestion.skillName ? `
                                    <span style="padding: 4px 10px; background: white; border-radius: 12px; font-weight: 500;">
                                        ð ${suggestion.skillName}
                                    </span>
                                ` : ''}
                                ${!existingGoal ? `
                                    <span style="color: ${config.color}; font-weight: 600; margin-left: auto;">
                                        Click to add â
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Apply Suggestion to Goal Form
        function applySuggestionToGoal(suggestion) {
            closeSmartSuggestions();
            openAddGoalModal();
            
            // Wait for modal to render
            setTimeout(() => {
                // Fill in the form
                document.getElementById('goalTitle').value = suggestion.title;
                document.getElementById('goalTarget').value = suggestion.target;
                
                // Select goal type
                selectGoalType(suggestion.type);
                
                // Set skill if applicable
                if (suggestion.type === 'skill_mastery' && suggestion.skillName) {
                    setTimeout(() => {
                        const skillSelect = document.getElementById('goalSkillSelect');
                        if (skillSelect) {
                            skillSelect.value = suggestion.skillName;
                            skillSelect.dispatchEvent(new Event('change'));
                        }
                    }, 100);
                }
                
                showNotification(`â Template applied: ${suggestion.title}`, 'success');
            }, 100);
        }

        // ENHANCED: Career-Specific Goal Suggestions
        function suggestGoalsForCareer(career) {
            const suggestions = [];
            
            switch (career) {
                // --- ENGLISH ---
                case 'english':
                    suggestions.push(
                        { title: "Reach B2 Level (Fluent)", type: "study_hours", target: 260, description: "Upper-intermediate proficiency for professional use" },
                        { title: "Reach C1 Level (Advanced)", type: "study_hours", target: 610, description: "Advanced proficiency for academic/professional excellence" },
                        { title: "Reach C2 Level (Mastery)", type: "study_hours", target: 1010, description: "Near-native proficiency" },
                        { title: "Master Business Presentations", type: "skill_mastery", target: 140, skillName: "Business Presentations (Clarity, Structure, Storytelling)", description: "Professional communication skills" },
                        { title: "Master Interview Skills", type: "skill_mastery", target: 100, skillName: "Interview Skills (STAR Method, Behavioral Questions, Case Interviews)", description: "Ace any interview" }
                    );
                    break;
                    
                // --- CHINESE ---
                case 'chinese':
                    suggestions.push(
                        { title: "Master Pinyin & Tones", type: "skill_mastery", target: 50, skillName: "æ¼é³ (Pinyin - PhÃ¡t Ã¢m)", description: "Foundation of Chinese pronunciation" },
                        { title: "Learn 500 Core Characters", type: "skill_mastery", target: 100, skillName: "æ±å­ (HÃ¡n tá»± - Nháº­n diá»n & Viáº¿t)", description: "Build reading foundation" },
                        { title: "Complete HSK 1-3 Foundation", type: "study_hours", target: 300, description: "Basic to intermediate proficiency" },
                        { title: "HSK 4-6 Proficiency", type: "study_hours", target: 500, description: "Advanced fluency and HSK 6 level" },
                        { title: "Business Chinese Communication", type: "skill_mastery", target: 200, skillName: "åå¡ä¼è®® (Há»p kinh doanh)", description: "Professional workplace Chinese" },
                        { title: "Achieve Expert Level (10,000h)", type: "study_hours", target: 10000, description: "Reach top 1-5% proficiency" }
                    );
                    break;
                    
                // --- CFA LEVEL 1 ---
                case 'cfa1':
                    suggestions.push(
                        { title: "Master Ethics & Standards", type: "skill_mastery", target: 100, skillName: "Code of Ethics and Standards of Professional Conduct", description: "15% of exam weight" },
                        { title: "Master Quantitative Methods", type: "skill_mastery", target: 70, skillName: "Time Value of Money", description: "Essential calculation skills" },
                        { title: "Master Financial Statement Analysis", type: "skill_mastery", target: 120, skillName: "Understanding Financial Statements", description: "20% of exam weight" },
                        { title: "Complete CFA L1 Foundation (300h)", type: "study_hours", target: 300, description: "Recommended study time by CFA Institute" },
                        { title: "Complete Intensive CFA L1 Prep (450h)", type: "study_hours", target: 450, description: "For comprehensive mastery" }
                    );
                    break;

                    
                // --- FINANCE CAREERS (PE, IB, HF, SC, FINTECH) ---
                case 'pe':
                case 'ib':
                case 'hf':
                case 'sc':
                case 'fintech':
                    // FOUNDATION LAYER (70-80% shared base)
                    suggestions.push({
                        title: "Finance Foundation (CFA L1 + Core)",
                        type: "study_hours",
                        target: 500,
                        description: "Build the shared 70-80% base across all finance careers"
                    });
                    
                    // BRANCHING LAYER (Career-specific)
                    if (career === 'pe') {
                        suggestions.push(
                            { title: "Master LBO Modeling", type: "skill_mastery", target: 160, skillName: "LBO Modeling", description: "Core PE skill" },
                            { title: "Master DCF Valuation", type: "skill_mastery", target: 120, skillName: "DCF Valuation", description: "Essential valuation technique" },
                            { title: "PE Expertise (Deal Structuring, LBO)", type: "study_hours", target: 2000, description: "Deep dive into PE-specific skills" },
                            { title: "Achieve PE Expert Level", type: "study_hours", target: 5000, description: "Reach top 1-5% proficiency in Private Equity" }
                        );
                    } else if (career === 'ib') {
                        suggestions.push(
                            { title: "Master Financial Modeling", type: "skill_mastery", target: 140, skillName: "Financial Modeling", description: "Core IB skill" },
                            { title: "Master M&A Advisory", type: "skill_mastery", target: 130, skillName: "M&A Advisory", description: "Deal execution skills" },
                            { title: "IB Expertise (Pitchbooks, Live Deals)", type: "study_hours", target: 2000, description: "Master the IB workflow and tools" },
                            { title: "Achieve IB Expert Level", type: "study_hours", target: 5000, description: "Reach top 1-5% proficiency in Investment Banking" }
                        );
                    } else if (career === 'hf') {
                        suggestions.push(
                            { title: "Master Python for Finance", type: "skill_mastery", target: 180, skillName: "Python for Finance (Pandas, NumPy, Backtrader)", description: "Quant foundations" },
                            { title: "Master Statistical Arbitrage", type: "skill_mastery", target: 150, skillName: "Statistical Arbitrage", description: "Advanced trading strategy" },
                            { title: "HF Expertise (Quant, Risk, Coding)", type: "study_hours", target: 3000, description: "Become proficient in quant strategies" },
                            { title: "Achieve HF Expert Level", type: "study_hours", target: 6000, description: "Reach top 1-5% proficiency in Hedge Funds" }
                        );
                    } else if (career === 'sc') {
                        suggestions.push(
                            { title: "Master Case Frameworks", type: "skill_mastery", target: 80, skillName: "Case Framework Mastery (MECE, Issue Tree, Pyramid Principle)", description: "Essential for case interviews" },
                            { title: "Master Problem Solving", type: "skill_mastery", target: 90, skillName: "Problem Solving (Structured Thinking)", description: "Core consulting skill" },
                            { title: "SC Expertise (Frameworks, Cases)", type: "study_hours", target: 2000, description: "Master case-solving and strategic thinking" },
                            { title: "Achieve SC Expert Level", type: "study_hours", target: 4500, description: "Reach top 1-5% proficiency in Strategy Consulting" }
                        );
                    } else if (career === 'fintech') {
                        suggestions.push(
                            { title: "Master Python for Finance", type: "skill_mastery", target: 160, skillName: "Python for Finance (pandas, NumPy, scikit-learn)", description: "Tech foundation" },
                            { title: "Master SQL & Databases", type: "skill_mastery", target: 100, skillName: "SQL & Databases (Relational, Query Optimization)", description: "Data skills" },
                            { title: "Fintech Expertise (Code, Products, Regs)", type: "study_hours", target: 2500, description: "Deep dive into tech, data, and fintech models" },
                            { title: "Achieve Fintech Expert Level", type: "study_hours", target: 5500, description: "Reach top 1-5% proficiency in Fintech" }
                        );
                    }
                    break;
                    
                default:
                    suggestions.push(
                        { title: "Explore & Build Foundation", type: "study_hours", target: 50, description: "Start your learning journey" },
                        { title: "Develop Basic Proficiency", type: "study_hours", target: 150, description: "Build fundamental skills" }
                    );
            }
            
            return suggestions;
        }


        function openUpdateGoalProgressModal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;           
            document.getElementById('updateGoalProgressId').value = goal.id;
            document.getElementById('updateGoalProgressValue').value = goal.currentProgress || 0;
            document.getElementById('updateGoalProgressModal').style.display = 'flex';
            const modalTitle = document.getElementById('updateGoalProgressModalTitle');
            if (modalTitle) {
                modalTitle.textContent = `ð Update Progress: ${goal.title}`;
            }
        }

        function closeUpdateGoalProgressModal() {
            document.getElementById('updateGoalProgressModal').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const updateGoalProgressForm = document.getElementById('updateGoalProgressForm');
            if (updateGoalProgressForm) {
                updateGoalProgressForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const id = document.getElementById('updateGoalProgressId').value;
                    const newValue = parseFloat(document.getElementById('updateGoalProgressValue').value);
                    
                    if (isNaN(newValue) || newValue < 0) {
                        showNotification('Please enter a valid progress value.', 'error');
                        return;
                    }
                    
                    const goal = goals.find(g => g.id === id);
                    if (goal && (goal.type === 'study_hours' || goal.type === 'skill_mastery')) {
                        goal.currentProgress = newValue;
                        goal.manuallyUpdated = true;                        
                        saveGoals();
                        renderGoals();
                        closeUpdateGoalProgressModal();
                        showNotification('Goal progress updated manually!', 'success');
                        if (goal.currentProgress >= goal.target && getGoalStatus(goal) !== 'completed') {
                            gamification.points += 50;
                            gamification.level = Math.floor(gamification.points / 100) + 1;
                            localStorage.setItem('gamification', JSON.stringify(gamification));
                            updateGamificationStats();
                            showNotification(`ð Goal completed! Earned 50 XP!`, 'achievement');
                        }
                    }
                });
            }
        });


        function calculateGoalProgress(goal) {
            if (goal.manuallyUpdated) {
                return Math.min(goal.target, Math.max(0, goal.currentProgress || 0));
            }
            
            if (goal.type === 'study_hours') {
                if (goal.courseId) {
                    const course = courses.find(c => c.id === goal.courseId);
                    goal.currentProgress = course ? (course.hoursStudied || 0) : 0;
                } else {
                    const careerHours = studyHours[currentCareer] || {};
                    const totalHours = Object.values(careerHours).reduce((sum, h) => sum + h, 0);
                    goal.currentProgress = totalHours;
                }
            } else if (goal.type === 'skill_mastery') {
                if (goal.skillName) {
                    goal.currentProgress = getSkillHours(currentCareer, goal.skillName);
                } else {
                    const careerData = skillsData[currentCareer];
                    let totalSkillHours = 0;
                    if (careerData) {
                        Object.values(careerData.categories).forEach(category => {
                            category.skills.forEach(skill => {
                                totalSkillHours += getSkillHours(currentCareer, skill.name);
                            });
                        });
                    }
                    goal.currentProgress = totalSkillHours;
                }
            }
            return Math.min(goal.target, Math.max(0, goal.currentProgress || 0));
        }
 

        function resetManualUpdateFlag(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (goal) {
                goal.manuallyUpdated = false;
                saveGoals();
            }
        }

        document.getElementById('goalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const id = document.getElementById('editGoalId').value;
            const title = document.getElementById('goalTitle').value.trim();
            const type = document.getElementById('goalType').value;
            const target = parseFloat(document.getElementById('goalTarget').value);
            const deadline = document.getElementById('goalDeadline').value || undefined;
            
            if (!title || !type || isNaN(target) || target <= 0) {
                showNotification('Please fill in all required fields with valid values.', 'error');
                return;
            }
            let courseId = undefined;
            let skillName = undefined;
            
            if (type === 'study_hours') {
                const courseSelect = document.getElementById('goalCourseSelect');
                courseId = courseSelect ? courseSelect.value || undefined : undefined;
            } else if (type === 'skill_mastery') {
                const skillSelect = document.getElementById('goalSkillSelect');
                skillName = skillSelect ? skillSelect.value || undefined : undefined;
            } else if (type === 'complete_course') {
                const courseCompleteSelect = document.getElementById('goalCourseComplete');
                courseId = courseCompleteSelect ? courseCompleteSelect.value : undefined;
                if (!courseId) {
                    showNotification('Please select a course to complete.', 'error');
                    return;
                }
            }
            
            if (id) {
                const goalIndex = goals.findIndex(g => g.id === id);
                if (goalIndex !== -1) {
                    goals[goalIndex] = {
                        ...goals[goalIndex],
                        title,
                        type,
                        target,
                        deadline,
                        courseId,
                        skillName,
                        manuallyUpdated: false 
                    };
                    showNotification('Goal updated successfully!', 'success');
                }
            } else {
                const newGoal = {
                    id: Date.now().toString(),
                    title,
                    type,
                    target,
                    deadline,
                    career: currentCareer,
                    courseId,
                    skillName,
                    currentProgress: 0,
                    manuallyUpdated: false
                };
                goals.push(newGoal);
                showNotification('Goal added successfully!', 'success');
            }
            saveGoals();
            renderGoals();
            closeGoalModal();
        });


        function getGoalProgressPercent(goal) {
            const progress = calculateGoalProgress(goal);
            return goal.target > 0 ? Math.min(100, (progress / goal.target) * 100) : 0;
        }

        function openAddGoalModal() {
            document.getElementById('goalModalTitle').textContent = 'â Add New Goal';
            document.getElementById('goalForm').reset();
            document.getElementById('editGoalId').value = '';
            document.getElementById('goalTypeSpecificFields').innerHTML = '';
            document.getElementById('goalModal').style.display = 'flex';
        }

        function closeGoalModal() {
            document.getElementById('goalModal').style.display = 'none';
        }

        document.getElementById('goalType').addEventListener('change', function() {
            populateGoalTypeSpecificFields(this.value);
        });



        // --- GOAL PROGRESS CHART ---
        let goalProgressChart = null;
        function initGoalProgressChart() {
            const ctx = document.getElementById('goalProgressChart').getContext('2d');
            if (goalProgressChart) {
                goalProgressChart.destroy();
            }
            const filteredGoals = goals.filter(g => g.career === currentCareer);
            const totalGoals = filteredGoals.length;
            const completedGoals = filteredGoals.filter(g => getGoalStatus(g) === 'completed').length;
            const remainingGoals = totalGoals - completedGoals;
            const completionRate = totalGoals > 0 ? Math.round((completedGoals / totalGoals) * 100) : 0;
            const data = {
                labels: ['Completed', 'Remaining'],
                datasets: [{
                    data: [completedGoals, remainingGoals],
                    backgroundColor: [
                        '#10b981', 
                        '#e2e8f0' 
                    ],
                    borderColor: [
                        '#059669',
                        '#cbd5e1'
                    ],
                    borderWidth: 2,
                    cutout: '70%' 
                }]
            };
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                return `${label}: ${value}`;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: `${completionRate}% Complete`,
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        color: 'var(--text-dark)',
                        padding: 10
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutBounce'
                }
            };
            goalProgressChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: options
            });
            document.getElementById('goalProgressSummary').textContent = `${completedGoals}/${totalGoals} goals completed`;
        }

        function updateGoalProgressChart() {
            if (document.getElementById('goalProgressChart')) {
                initGoalProgressChart();
            }
        }

        document.getElementById('courseForm').addEventListener('submit', saveCourse);
        document.getElementById('addHoursForm').addEventListener('submit', addHoursToCourse);
        document.addEventListener('DOMContentLoaded', function() {
            renderSessionLogs();
        });
 
        document.addEventListener('DOMContentLoaded', function() {
            const quoteCard = document.getElementById('quoteCard');
            if (quoteCard) {
                quoteCard.addEventListener('touchstart', function() {
                    this.style.transform = 'translateY(-6px) scale(1.03)';
                });
                
                quoteCard.addEventListener('touchend', function() {
                    this.style.transform = 'translateY(-3px) scale(1.02)';
                });
            }

            document.querySelectorAll('.career-card').forEach(card => {
                card.addEventListener('touchstart', function() {
                    this.style.transform = 'translateY(-8px) scale(1.02)';
                });
                
                card.addEventListener('touchend', function() {
                    this.style.transform = this.classList.contains('selected') ? 'translateY(-5px)' : 'translateY(0)';
                });
            });
        });





        // ===== SLEEP TRACKER =====
        let sleepStartTime = null;
        let isSleeping = false;
        let sleepInterval = null;
        sleepSessions = JSON.parse(localStorage.getItem('sleepSessions')) || [];
        let sleepChart = null;

        function startSleepTracking() {
            if (isSleeping) return;
            sleepStartTime = Date.now();
            isSleeping = true;
            localStorage.setItem('sleepStartTime', sleepStartTime);
            localStorage.setItem('isSleeping', 'true');
            
            updateSleepUI();
            
            if (sleepInterval) clearInterval(sleepInterval);
            sleepInterval = setInterval(updateSleepDisplay, 1000);
            updateSleepDisplay();
            
            showNotification('ð Sleep tracking started.', 'info');
        }

        function stopSleepTracking() {
            if (!isSleeping) return;
            
            const endTime = Date.now();
            const durationMs = endTime - sleepStartTime;
            const durationHours = (durationMs / (1000 * 60 * 60));
            
            // â Cáº¢NH BÃO Náº¾U QUÃ DÃI
            if (durationHours > 16) {
                if (!confirm(`â ï¸ Sleep duration is ${durationHours.toFixed(1)} hours (>16h). This might be a mistake. Continue?`)) {
                    return;
                }
            }
            
            const session = {
                id: Date.now(),
                start: sleepStartTime,
                end: endTime,
                duration: parseFloat(durationHours.toFixed(2)),
                startFormatted: new Date(sleepStartTime).toLocaleString('vi-VN'),
                endFormatted: new Date(endTime).toLocaleString('vi-VN'),
                manual: true
            };
            
            sleepSessions.push(session);
            saveSleepData();
            
            isSleeping = false;
            sleepStartTime = null;
            if (sleepInterval) clearInterval(sleepInterval);
            sleepInterval = null;
            localStorage.removeItem('sleepStartTime');
            localStorage.removeItem('isSleeping');
            
            updateSleepUI();
            renderSleepHistory();
            renderSleepChart();
            updateCorrelationAnalytics();
            
            showNotification(`âï¸ Woke up! You slept for ${session.duration} hours.`, 'success');
        }


        function openManualSleepModal() {
            const now = new Date();
            
            // Helper function to format datetime-local input value
            function toLocalDatetimeString(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }
            
            // Use local time instead of ISO (which is UTC)
            const defaultEnd = toLocalDatetimeString(now);
            const defaultStart = toLocalDatetimeString(new Date(now.getTime() - 8 * 60 * 60 * 1000));
            
            // Close any existing modal first
            closeManualSleepModal();
            
            const html = `
                <div id="manualSleepModal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>ð Add Sleep Session</h3>
                            <button class="modal-close-btn" onclick="closeManualSleepModal()">&times;</button>
                        </div>
                        <form id="manualSleepForm">
                            <div class="form-group">
                                <label for="manualSleepStart">Sleep Start</label>
                                <input type="datetime-local" id="manualSleepStart" value="${defaultStart}" required>
                            </div>
                            <div class="form-group">
                                <label for="manualSleepEnd">Sleep End</label>
                                <input type="datetime-local" id="manualSleepEnd" value="${defaultEnd}" required>
                            </div>
                            <div id="manualSleepDuration" class="duration-display">Duration: -- hours</div>
                            <div class="modal-actions">
                                <button type="button" class="btn-secondary" onclick="closeManualSleepModal()">Cancel</button>
                                <button type="submit" class="btn-primary">ð¾ Save Session</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Add CSS styles for the modal
            const style = document.createElement('style');
            style.textContent = `
                .modal-overlay {
                    position: fixed;
                    inset: 0;
                    background: rgba(0,0,0,0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    backdrop-filter: blur(4px);
                    animation: fadeIn 0.3s ease;
                }
                
                .modal-content {
                    background: var(--bg-white, #ffffff);
                    border-radius: 16px;
                    padding: 24px;
                    max-width: 450px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    animation: slideUp 0.3s ease;
                }
                
                .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                    padding-bottom: 15px;
                    border-bottom: 1px solid var(--border-color, #e5e7eb);
                }
                
                .modal-header h3 {
                    margin: 0;
                    color: var(--text-dark, #1f2937);
                    font-size: 1.25rem;
                }
                
                .modal-close-btn {
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: var(--text-muted, #6b7280);
                    padding: 0;
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s;
                }
                
                .modal-close-btn:hover {
                    background: var(--bg-light, #f3f4f6);
                    color: var(--text-dark, #1f2937);
                }
                
                .form-group {
                    margin-bottom: 15px;
                }
                
                .form-group label {
                    display: block;
                    margin-bottom: 6px;
                    font-weight: 500;
                    color: var(--text-dark, #1f2937);
                    font-size: 0.875rem;
                }
                
                .form-group input {
                    width: 100%;
                    padding: 10px 12px;
                    border: 1px solid var(--border-color, #e5e7eb);
                    border-radius: 8px;
                    background: var(--bg-light, #f9fafb);
                    color: var(--text-dark, #1f2937);
                    font-size: 0.9375rem;
                    transition: border-color 0.2s;
                }
                
                .form-group input:focus {
                    outline: none;
                    border-color: #3b82f6;
                    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                }
                
                .duration-display {
                    text-align: center;
                    color: var(--text-muted, #6b7280);
                    font-size: 0.9rem;
                    margin-bottom: 15px;
                    padding: 8px;
                    background: var(--bg-light, #f9fafb);
                    border-radius: 8px;
                    font-weight: 500;
                    transition: all 0.2s;
                }
                
                .modal-actions {
                    display: flex;
                    gap: 10px;
                    margin-top: 20px;
                }
                
                .btn-primary, .btn-secondary {
                    flex: 1;
                    padding: 12px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 0.9375rem;
                    transition: all 0.2s;
                    border: none;
                }
                
                .btn-primary {
                    background: #3b82f6;
                    color: white;
                }
                
                .btn-primary:hover {
                    background: #2563eb;
                    transform: translateY(-1px);
                }
                
                .btn-secondary {
                    background: var(--bg-light, #f3f4f6);
                    color: var(--text-dark, #1f2937);
                    border: 1px solid var(--border-color, #e5e7eb);
                }
                
                .btn-secondary:hover {
                    background: var(--border-color, #e5e7eb);
                }
                
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes slideUp {
                    from {
                        opacity: 0;
                        transform: translateY(20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            
            document.head.appendChild(style);
            
            const modal = document.createElement('div');
            modal.innerHTML = html;
            document.body.appendChild(modal);
            
            // Focus on the first input field
            setTimeout(() => {
                document.getElementById('manualSleepStart')?.focus();
            }, 100);
            
            // Auto-calculate duration with improved logic
            const startInput = document.getElementById('manualSleepStart');
            const endInput = document.getElementById('manualSleepEnd');
            const durationDisplay = document.getElementById('manualSleepDuration');
            
            // Store event listeners for cleanup
            const eventListeners = {
                updateDuration: null,
                formSubmit: null
            };
            
            eventListeners.updateDuration = () => {
                const start = new Date(startInput.value);
                const end = new Date(endInput.value);
                
                if (start && end && !isNaN(start.getTime()) && !isNaN(end.getTime())) {
                    if (end <= start) {
                        durationDisplay.textContent = 'â ï¸ End time must be after start time';
                        durationDisplay.style.color = '#ef4444';
                        return;
                    }
                    
                    const durationMs = end - start;
                    const durationHours = durationMs / (1000 * 60 * 60);
                    
                    if (durationHours < 1) {
                        const durationMinutes = Math.round(durationHours * 60);
                        durationDisplay.textContent = `Duration: ${durationMinutes} minutes`;
                    } else {
                        durationDisplay.textContent = `Duration: ${durationHours.toFixed(1)} hours`;
                    }
                    
                    // Color coding based on duration
                    if (durationHours > 16) {
                        durationDisplay.style.color = '#ef4444';
                    } else if (durationHours < 4) {
                        durationDisplay.style.color = '#f59e0b';
                    } else if (durationHours >= 7 && durationHours <= 9) {
                        durationDisplay.style.color = '#10b981';
                    } else {
                        durationDisplay.style.color = '#3b82f6';
                    }
                } else {
                    durationDisplay.textContent = 'Duration: -- hours';
                    durationDisplay.style.color = 'var(--text-muted)';
                }
            };
            
            startInput.addEventListener('change', eventListeners.updateDuration);
            endInput.addEventListener('change', eventListeners.updateDuration);
            startInput.addEventListener('input', eventListeners.updateDuration);
            endInput.addEventListener('input', eventListeners.updateDuration);
            
            // Calculate initial duration
            eventListeners.updateDuration();
            
            // Form submission with improved validation
            eventListeners.formSubmit = function(e) {
                e.preventDefault();
                
                const start = new Date(startInput.value);
                const end = new Date(endInput.value);
                
                // Validate inputs
                if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                    alert('Please enter valid date and time values.');
                    return;
                }
                
                if (end <= start) {
                    alert('End time must be after start time!');
                    return;
                }
                
                const durationMs = end - start;
                const durationHours = durationMs / (1000 * 60 * 60);
                
                // Check if sleep session is in the future
                if (start > new Date()) {
                    if (!confirm('Sleep start time is in the future. Are you sure this is correct?')) {
                        return;
                    }
                }
                
                // Duration validation
                if (durationHours < 0.25) { // Less than 15 minutes
                    if (!confirm(`Sleep duration is only ${Math.round(durationHours * 60)} minutes. This seems very short. Continue?`)) {
                        return;
                    }
                } else if (durationHours > 24) {
                    alert('Sleep duration cannot exceed 24 hours. Please check your times.');
                    return;
                } else if (durationHours > 16) {
                    if (!confirm(`Sleep duration is ${durationHours.toFixed(1)} hours (>16h). This might be a mistake. Continue?`)) {
                        return;
                    }
                }
                
                const session = {
                    id: Date.now(),
                    start: start.getTime(),
                    end: end.getTime(),
                    duration: parseFloat(durationHours.toFixed(2)),
                    startFormatted: start.toLocaleString('vi-VN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }),
                    endFormatted: end.toLocaleString('vi-VN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }),
                    manual: true
                };
                
                // Add to sleep sessions
                sleepSessions.push(session);
                saveSleepData();
                
                // Update all UI components
                renderSleepHistory();
                renderSleepChart();
                updateCorrelationAnalytics();
                
                // Clean up and close modal
                cleanupModal();
                closeManualSleepModal();
                
                // Show success notification
                showNotification(`â Sleep session added: ${session.duration}h of sleep`, 'success');
            };
            
            document.getElementById('manualSleepForm').addEventListener('submit', eventListeners.formSubmit);
            
            // Prevent modal from closing when clicking inside
            modal.querySelector('.modal-content').addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeManualSleepModal();
                }
            });
            
            // Handle escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeManualSleepModal();
                }
            };
            document.addEventListener('keydown', handleEscape);
            
            // Cleanup function
            function cleanupModal() {
                if (eventListeners.updateDuration) {
                    startInput.removeEventListener('change', eventListeners.updateDuration);
                    endInput.removeEventListener('change', eventListeners.updateDuration);
                    startInput.removeEventListener('input', eventListeners.updateDuration);
                    endInput.removeEventListener('input', eventListeners.updateDuration);
                }
                
                document.removeEventListener('keydown', handleEscape);
                
                const form = document.getElementById('manualSleepForm');
                if (form && eventListeners.formSubmit) {
                    form.removeEventListener('submit', eventListeners.formSubmit);
                }
                
                // Remove style element
                const styleElement = document.querySelector('style:last-of-type');
                if (styleElement && styleElement.textContent.includes('modal-overlay')) {
                    styleElement.remove();
                }
            }
            
            // Override the close function to include cleanup
            const originalCloseManualSleepModal = closeManualSleepModal;
            window.closeManualSleepModal = function() {
                cleanupModal();
                originalCloseManualSleepModal();
            };
        }







        function closeManualSleepModal() {
            const modal = document.getElementById('manualSleepModal');
            if (modal) modal.remove();
        }

        function editSleepSession(id) {
            const session = sleepSessions.find(s => s.id === id);
            if (!session) return;
            
            const startDate = new Date(session.start).toISOString().slice(0, 16);
            const endDate = new Date(session.end).toISOString().slice(0, 16);
            
            const html = `
                <div id="editSleepModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(4px);">
                    <div style="background: var(--bg-white); border-radius: 16px; padding: 24px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: var(--text-dark);">âï¸ Edit Sleep Session</h3>
                            <button onclick="closeEditSleepModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted);">&times;</button>
                        </div>
                        <form id="editSleepForm">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Sleep Start</label>
                                <input type="datetime-local" id="editSleepStart" value="${startDate}" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-light); color: var(--text-dark);">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-dark);">Sleep End</label>
                                <input type="datetime-local" id="editSleepEnd" value="${endDate}" required style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-light); color: var(--text-dark);">
                            </div>
                            <div id="editSleepDuration" style="text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">Duration: ${session.duration}h</div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" onclick="closeEditSleepModal()" style="flex: 1; padding: 12px; background: var(--bg-light); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
                                <button type="submit" style="flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ð¾ Update</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.innerHTML = html;
            document.body.appendChild(modal);
            
            const startInput = document.getElementById('editSleepStart');
            const endInput = document.getElementById('editSleepEnd');
            const durationDisplay = document.getElementById('editSleepDuration');
            
            const updateDuration = () => {
                const start = new Date(startInput.value);
                const end = new Date(endInput.value);
                if (start && end && end > start) {
                    const hours = ((end - start) / (1000 * 60 * 60)).toFixed(1);
                    durationDisplay.textContent = `Duration: ${hours} hours`;
                    durationDisplay.style.color = hours > 16 ? '#ef4444' : 'var(--primary)';
                }
            };
            
            startInput.addEventListener('change', updateDuration);
            endInput.addEventListener('change', updateDuration);
            
            document.getElementById('editSleepForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const start = new Date(startInput.value).getTime();
                const end = new Date(endInput.value).getTime();
                
                if (end <= start) {
                    alert('End time must be after start time!');
                    return;
                }
                
                const durationHours = (end - start) / (1000 * 60 * 60);
                
                if (durationHours > 16) {
                    if (!confirm(`Duration is ${durationHours.toFixed(1)} hours (>16h). Continue?`)) {
                        return;
                    }
                }
                
                const index = sleepSessions.findIndex(s => s.id === id);
                if (index !== -1) {
                    sleepSessions[index] = {
                        ...sleepSessions[index],
                        start: start,
                        end: end,
                        duration: parseFloat(durationHours.toFixed(2)),
                        startFormatted: new Date(start).toLocaleString('vi-VN'),
                        endFormatted: new Date(end).toLocaleString('vi-VN')
                    };
                    
                    saveSleepData();
                    renderSleepHistory();
                    renderSleepChart();
                    updateCorrelationAnalytics();
                    closeEditSleepModal();
                    
                    showNotification('â Sleep session updated!', 'success');
                }
            });
        }

        function closeEditSleepModal() {
            const modal = document.getElementById('editSleepModal');
            if (modal) modal.remove();
        }

        function deleteSleepSession(id) {
            if (confirm('ðï¸ Delete this sleep session?')) {
                sleepSessions = sleepSessions.filter(s => s.id !== id);
                saveSleepData();
                renderSleepHistory();
                renderSleepChart();
                updateCorrelationAnalytics();
                showNotification('Session deleted', 'info');
            }
        }

        function renderSleepHistory() {
            const container = document.getElementById('sleepHistoryContainer');
            if (!container) return;
            
            if (sleepSessions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px; font-style: italic;">No sleep sessions recorded yet.</div>';
                return;
            }
            
            const recentSessions = sleepSessions.slice(-10).reverse(); // Last 10, newest first
            
            container.innerHTML = recentSessions.map(session => `
                <div style="background: var(--bg-light); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${session.duration > 16 ? '#ef4444' : '#3b82f6'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 4px;">
                                ð´ ${session.duration} hours ${session.manual ? '(Manual)' : ''}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                ${session.startFormatted} â ${session.endFormatted}
                            </div>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="editSleepSession(${session.id})" style="background: none; border: 1px solid var(--border-color); padding: 4px 8px; border-radius: 6px; cursor: pointer; color: var(--text-dark); font-size: 0.85rem;">âï¸</button>
                            <button onclick="deleteSleepSession(${session.id})" style="background: none; border: 1px solid #ef4444; padding: 4px 8px; border-radius: 6px; cursor: pointer; color: #ef4444; font-size: 0.85rem;">ðï¸</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateSleepDisplay() {
            if (!isSleeping || !sleepStartTime) return;
            const now = Date.now();
            const elapsedMs = now - sleepStartTime;
            const totalSeconds = Math.floor(elapsedMs / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const display = document.getElementById('sleepTimerDisplay');
            if (display) display.textContent = formattedTime;
        }

        function updateSleepUI() {
            document.getElementById('sleepStatus').textContent = isSleeping ? "ð¤ Sleeping..." : "ð´ Ready to sleep";
            document.getElementById('sleepTimerDisplay').style.display = isSleeping ? 'block' : 'none';
            document.getElementById('startSleepBtn').style.display = isSleeping ? 'none' : 'block';
            document.getElementById('stopSleepBtn').style.display = isSleeping ? 'block' : 'none';
        }

        function saveSleepData() {
            localStorage.setItem('sleepSessions', JSON.stringify(sleepSessions));
        }

        function renderSleepChart() {
            const ctx = document.getElementById('sleepChart');
            if (!ctx) return;
            
            const recentSessions = sleepSessions.slice(-7);
            const labels = recentSessions.map(session => session.startFormatted.split(',')[0]);
            const durations = recentSessions.map(session => session.duration);
            
            if (sleepChart) {
                sleepChart.destroy();
            }
            
            sleepChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Hours Slept',
                        data: durations,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Duration: ${context.parsed.y} hours`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Hours'
                            }
                        }
                    }
                }
            });
        }

        function loadSleepData() {
            const savedIsSleeping = localStorage.getItem('isSleeping') === 'true';
            const savedStartTime = localStorage.getItem('sleepStartTime');
            
            if (savedIsSleeping && savedStartTime) {
                isSleeping = true;
                sleepStartTime = parseInt(savedStartTime);
                updateSleepUI();
                if (sleepInterval) clearInterval(sleepInterval);
                sleepInterval = setInterval(updateSleepDisplay, 1000);
                updateSleepDisplay();
            } else {
                updateSleepUI();
            }
            
            renderSleepHistory();
            renderSleepChart();
        }









        function showBookDetails(bookId) {
            const book = readingList.find(b => b.id === parseInt(bookId));
            if (!book) {
                console.error('Book not found for details:', bookId);
                showNotification('Book not found!', 'error');
                return;
            }

            const modal = document.getElementById('bookDetailsModal');
            const titleEl = document.getElementById('bookDetailsTitle');
            const authorEl = document.getElementById('bookDetailsAuthor');
            const genreEl = document.getElementById('bookDetailsGenre');
            const statusEl = document.getElementById('bookDetailsStatus');
            const coverEl = document.getElementById('bookDetailsCover');
            const ratingEl = document.getElementById('bookDetailsRating');
            const reviewEl = document.getElementById('bookDetailsReview');

            if (modal && titleEl && authorEl && genreEl && statusEl && coverEl && ratingEl && reviewEl) {
                titleEl.textContent = book.title;
                authorEl.textContent = `by ${book.author}`;
                genreEl.textContent = book.genre;
                statusEl.textContent = getStatusText(book.status);
                statusEl.className = 'book-status-badge'; 
                statusEl.classList.add(book.status); 

                if (book.cover) {
                    coverEl.src = book.cover;
                    coverEl.alt = `${book.title} cover`;
                    coverEl.style.display = 'block';
                } else {
                    coverEl.style.display = 'none';
                }

                if (book.rating !== null && !isNaN(book.rating)) {
                    const fullStars = Math.floor(book.rating);
                    const hasHalfStar = book.rating % 1 >= 0.5;
                    let starsHTML = '';
                    for (let i = 0; i < fullStars; i++) starsHTML += 'â­';
                    if (hasHalfStar) starsHTML += 'â­';
                    starsHTML += ` (${book.rating.toFixed(1)})`;
                    ratingEl.innerHTML = `<strong>Rating:</strong> ${starsHTML}`;
                    ratingEl.style.display = 'block';
                } else {
                    ratingEl.style.display = 'none';
                }

                if (book.review) {
                    reviewEl.innerHTML = `<strong>Review:</strong> ${escapeHtml(book.review).replace(/\n/g, '<br> ')}`;
                    reviewEl.style.display = 'block';
                } else {
                    reviewEl.style.display = 'none';
                }

                modal.style.display = 'flex';
            } else {
                console.error('Book details modal elements not found');
                alert(`Details for "${book.title}":\nAuthor: ${book.author}\nGenre: ${book.genre}\nStatus: ${getStatusText(book.status)}\nRating: ${book.rating || 'N/A'}\nReview: ${book.review || 'N/A'}`);
            }
        }

        function closeBookDetailsModal() {
            const modal = document.getElementById('bookDetailsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function autoBackup() {
            try {
                const backupData = {
                    studyHours,
                    gamification,
                    readingList,
                    courses,
                    goals,
                    dailyStudyData,
                    sessionLogs,
                    timestamp: new Date().toISOString(),
                    version: "2.0"
                };
                
                const dataStr = JSON.stringify(backupData);
                const dataSize = new Blob([dataStr]).size;

                if (dataSize > 4 * 1024 * 1024) { 
                    console.warn('Dá»¯ liá»u sao lÆ°u sáº¯p Äáº¡t giá»i háº¡n localStorage');
                    showNotification('â ï¸ Dung lÆ°á»£ng lÆ°u trá»¯ gáº§n Äáº§y. HÃ£y cÃ¢n nháº¯c xuáº¥t dá»¯ liá»u.', 'warning');
                }               
                localStorage.setItem('autoBackup', dataStr);
                const backups = JSON.parse(localStorage.getItem('backupHistory') || '[]');
                backups.unshift(backupData);
                if (backups.length > 3) backups.splice(3); 
                localStorage.setItem('backupHistory', JSON.stringify(backups));
                console.log('â Sao lÆ°u tá»± Äá»ng thÃ nh cÃ´ng');                
            } catch (e) {
                console.error('â Sao lÆ°u tháº¥t báº¡i:', e);
                showNotification('Sao lÆ°u tháº¥t báº¡i! HÃ£y xuáº¥t dá»¯ liá»u cá»§a báº¡n ngay bÃ¢y giá».', 'error');
            }
        }

        function triggerBackup() {
            clearTimeout(window.backupTimeout);
            window.backupTimeout = setTimeout(autoBackup, 5000); 
        }

        setInterval(autoBackup, 30 * 60 * 1000); 

        function selectGoalType(type) {
            document.querySelectorAll('.goal-type-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            const selectedOption = document.querySelector(`[data-type="${type}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            document.getElementById('goalType').value = type;
            populateGoalTypeSpecificFields(type);
        }

        function interpretCorrelation(r, xLabel, yLabel) {
            const abs = Math.abs(r);
            const direction = r > 0 ? 'positive' : 'negative';
            const strength = getCorrelationStrength(r);
            
            if (abs < 0.2) {
                return `Almost no relationship between ${xLabel} and ${yLabel}.`;
            } else if (abs < 0.4) {
                return `Weak ${direction} correlation. ${xLabel} has minor impact on ${yLabel}.`;
            } else if (abs < 0.7) {
                return `Moderate ${direction} correlation. ${xLabel} influences ${yLabel} noticeably.`;
            } else {
                return `Strong ${direction} correlation! ${xLabel} significantly affects ${yLabel}.`;
            }
        }

        function calculateDailyProductivity() {
            const data = [];
            const sortedDates = Object.keys(dailyStudyData).sort();
            
            sortedDates.forEach(date => {
                const hours = dailyStudyData[date] || 0;
                data.push({
                    date: date,
                    hours: hours
                });
            });
            
            return data;
        }

        function getEmptyResult(reason = "", data = []) {
            return {
                correlation: 0,
                sleepData: data.map(d => d.sleep) || [],
                studyData: data.map(d => d.study) || [],
                data: data,
                matchedDays: data.length,
                isValid: false,
                reason: reason
            };
        }

        function calculateSkillGoalCorrelation() {
            const skillProgress = [];
            const goalCompletion = [];
            
            if (!currentCareer || !skillsData[currentCareer]) {
                console.warn('No career selected or career data not found');
                return null;
            }
            
            const careerData = skillsData[currentCareer];
            if (!careerData || !careerData.categories) {
                console.warn('Invalid career data structure');
                return null;
            }
            
            try {
                Object.values(careerData.categories).forEach(category => {
                    if (category && category.skills) {
                        category.skills.forEach(skill => {
                            if (skill && skill.name) {
                                const completion = getSkillCompletion(currentCareer, skill.name);
                                if (completion && typeof completion.percent === 'number') {
                                    skillProgress.push(completion.percent);
                                }
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('Error processing skills:', error);
                return null;
            }
            
            try {
                const careerGoals = goals.filter(g => g.career === currentCareer);
                careerGoals.forEach(goal => {
                    if (goal) {
                        const percent = getGoalProgressPercent(goal);
                        if (typeof percent === 'number') {
                            goalCompletion.push(percent);
                        }
                    }
                });
            } catch (error) {
                console.error('Error processing goals:', error);
                return null;
            }
            
            const minLength = Math.min(skillProgress.length, goalCompletion.length);
            if (minLength < 3) {
                console.log(`Not enough data: ${skillProgress.length} skills, ${goalCompletion.length} goals`);
                return null;
            }
            
            try {
                const correlation = calculateCorrelation(
                    skillProgress.slice(0, minLength),
                    goalCompletion.slice(0, minLength)
                );
                
                return {
                    correlation: correlation,
                    data: skillProgress.slice(0, minLength).map((skill, i) => ({
                        skill: skill,
                        goal: goalCompletion[i]
                    })),
                    skillData: skillProgress,
                    goalData: goalCompletion
                };
            } catch (error) {
                console.error('Error calculating correlation:', error);
                return null;
            }
        }

        function renderCorrelationInsights() {
            const container = document.getElementById('correlationInsights');
            if (!container) return;
            
            const sleepStudy = calculateSleepStudyCorrelation();
            const skillGoal = calculateSkillGoalCorrelation();
            
            let html = '';

            if (sleepStudy && sleepStudy.data && sleepStudy.data.length >= 3) {
                const r = sleepStudy.correlation || 0;
                const strength = getCorrelationStrength(r);
                const avgSleep = sleepStudy.sleepData && sleepStudy.sleepData.length > 0 
                    ? (sleepStudy.sleepData.reduce((sum, d) => sum + d, 0) / sleepStudy.sleepData.length).toFixed(1)
                    : '0.0';
                
                html += `
                    <div class="insight-card">
                        <div class="insight-label">ð´ Sleep â Study Correlation</div>
                        <div class="insight-value">
                            r = ${r.toFixed(3)}
                            <span class="correlation-strength ${strength}">${strength}</span>
                        </div>
                        <div class="insight-description">
                            ${interpretCorrelation(r, 'Sleep hours', 'study productivity')}<br>
                            <strong>Avg sleep:</strong> ${avgSleep}h (${sleepStudy.sleepData?.length || 0} days)
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="insight-card">
                        <div class="insight-label">ð´ Sleep â Study Correlation</div>
                        <div class="insight-value">--</div>
                        <div class="insight-description">
                            Need at least 3 days with both sleep and study data.<br>
                            <strong>Current:</strong> ${sleepStudy?.sleepData?.length || 0} days
                        </div>
                    </div>
                `;
            }

            if (skillGoal && skillGoal.data && skillGoal.data.length >= 3) {
                const r = skillGoal.correlation || 0;
                const strength = getCorrelationStrength(r);
                const avgSkill = skillGoal.data && skillGoal.data.length > 0
                    ? (skillGoal.data.reduce((sum, d) => sum + (d.skill || 0), 0) / skillGoal.data.length).toFixed(1)
                    : '0.0';
                
                html += `
                    <div class="insight-card">
                        <div class="insight-label">ð¯ Skills â Goals Correlation</div>
                        <div class="insight-value">
                            r = ${r.toFixed(3)}
                            <span class="correlation-strength ${strength}">${strength}</span>
                        </div>
                        <div class="insight-description">
                            ${interpretCorrelation(r, 'Skill mastery', 'goal completion')}<br>
                            <strong>Avg skill progress:</strong> ${avgSkill}%
                        </div>
                    </div>
                `;
            } else {
                const careerData = skillsData[currentCareer];
                const skillCount = careerData ? 
                    Object.values(careerData.categories || {}).reduce((sum, cat) => sum + (cat.skills?.length || 0), 0) : 0;
                const goalCount = goals.filter(g => g.career === currentCareer).length;
                
                html += `
                    <div class="insight-card">
                        <div class="insight-label">ð¯ Skills â Goals Correlation</div>
                        <div class="insight-value">--</div>
                        <div class="insight-description">
                            Need at least 3 skills and goals for analysis.<br>
                            <strong>Current:</strong> ${skillCount} skills, ${goalCount} goals
                        </div>
                    </div>
                `;
            }
            
            const totalHours = Object.values(dailyStudyData || {}).reduce((sum, h) => sum + (parseFloat(h) || 0), 0);
            const daysTracked = Object.keys(dailyStudyData || {}).length;
            const avgDaily = daysTracked > 0 ? (totalHours / daysTracked).toFixed(1) : 0;
            
            html += `
                <div class="insight-card">
                    <div class="insight-label">ð Overall Productivity</div>
                    <div class="insight-value">${avgDaily}h/day</div>
                    <div class="insight-description">
                        Average daily study time over ${daysTracked} days tracked.<br>
                        <strong>Total:</strong> ${totalHours.toFixed(1)} hours
                    </div>
                </div>
            `;
            
            const totalSleepHours = (sleepSessions || []).reduce((sum, session) => sum + (session.duration || 0), 0);
            const avgSleepDuration = sleepSessions.length > 0 ? (totalSleepHours / sleepSessions.length).toFixed(1) : 0;
            
            html += `
                <div class="insight-card">
                    <div class="insight-label">ð´ Sleep Statistics</div>
                    <div class="insight-value">${avgSleepDuration}h</div>
                    <div class="insight-description">
                        Average sleep duration across all sessions.<br>
                        <strong>Total sessions:</strong> ${sleepSessions.length}
                    </div>
                </div>
            `;
            
            if (html === '') {
                html = '<div class="no-data-message">Not enough data yet. Keep tracking to see correlations!</div>';
            }
            
            container.innerHTML = html;
        }

        let sleepStudyChart = null;

        function renderSleepStudyChart() {
            const ctx = document.getElementById('sleepStudyChart');
            if (!ctx) return;
            
            const data = calculateSleepStudyCorrelation();
            
            if (sleepStudyChart) {
                sleepStudyChart.destroy();
            }
            
            // FIX: Check if data exists and has valid structure
            if (!data || !data.data || !Array.isArray(data.data) || data.data.length < 3) {
                const parent = ctx.parentElement;
                if (parent) {
                    parent.innerHTML = `
                        <div class="no-data-message">
                            <div style="margin-bottom: 8px;">ð Sleep vs Study Correlation</div>
                            <div style="font-size: 0.9rem; color: var(--text-muted);">
                                Need at least 3 days with both sleep and study data.<br>
                                <strong>Current:</strong> ${data?.sleepData?.length || 0} days matched
                            </div>
                            ${data?.sleepData?.length >= 1 ? `
                                <div style="margin-top: 12px; font-size: 0.85rem;">
                                    <strong>Recent data:</strong><br>
                                    ${data.sleepData.slice(-3).map((sleep, i) => 
                                        `Day ${i+1}: ${sleep.toFixed(1)}h sleep, ${data.studyData?.[i]?.toFixed(1) || '?'}h study`
                                    ).join('<br>')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                return;
            }
            
            // FIX: Check if pairedData exists
            const scatterData = data.data.map(d => ({ 
                x: d.sleep || 0, 
                y: d.study || 0 
            }));
            
            sleepStudyChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Sleep vs Study',
                        data: scatterData,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Sleep: ${context.parsed.x.toFixed(1)}h, Study: ${context.parsed.y.toFixed(1)}h`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Correlation: r = ${(data.correlation || 0).toFixed(3)}`,
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: 'var(--text-dark)'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Sleep Hours',
                                color: 'var(--text-dark)'
                            },
                            ticks: {
                                color: 'var(--text-muted)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Study Hours',
                                color: 'var(--text-dark)'
                            },
                            ticks: {
                                color: 'var(--text-muted)'
                            }
                        }
                    }
                }
            });
        }

        let skillGoalChart = null;

        function renderSkillGoalChart() {
            const ctx = document.getElementById('skillGoalChart');
            if (!ctx) return;
            
            const data = calculateSkillGoalCorrelation();
            
            if (skillGoalChart) {
                skillGoalChart.destroy();
            }
            
            if (!data || data.data.length < 3) {
                const parent = ctx.parentElement;
                parent.innerHTML = '<div class="no-data-message">Need at least 3 skills and goals to analyze</div>';
                return;
            }
            
            const scatterData = data.data.map(d => ({ x: d.skill, y: d.goal }));
            
            skillGoalChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Skill vs Goal',
                        data: scatterData,
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Skill: ${context.parsed.x.toFixed(1)}%, Goal: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Correlation: r = ${data.correlation.toFixed(3)}`,
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: 'var(--text-dark)'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Skill Progress (%)',
                                color: 'var(--text-dark)'
                            },
                            ticks: {
                                color: 'var(--text-muted)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Goal Completion (%)',
                                color: 'var(--text-dark)'
                            },
                            ticks: {
                                color: 'var(--text-muted)'
                            }
                        }
                    }
                }
            });
        }

        function updateCorrelationAnalytics() {
            try {
                renderCorrelationInsights();
            } catch (error) {
                console.error('Error in renderCorrelationInsights:', error);
            }
            
            try {
                renderSleepStudyChart();
            } catch (error) {
                console.error('Error in renderSleepStudyChart:', error);
                // Show error message in chart container
                const container = document.getElementById('sleepStudyChart')?.parentElement;
                if (container) {
                    container.innerHTML = `<div class="error-message">Error loading chart: ${error.message}</div>`;
                }
            }
            
            try {
                renderSkillGoalChart();
            } catch (error) {
                console.error('Error in renderSkillGoalChart:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateCorrelationAnalytics();

            const darkModeToggle = document.querySelector('.dark-mode-toggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', function() {
                    setTimeout(updateCorrelationAnalytics, 100);
                });
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                updateCorrelationAnalytics();
            }, 500); 

            const darkModeToggle = document.querySelector('.dark-mode-toggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', function() {
                    setTimeout(updateCorrelationAnalytics, 100);
                });
            }
        });

        const originalAddStudyTime = addStudyTime; 
        addStudyTime = function(...args) {
            originalAddStudyTime(...args);
            updateCorrelationAnalytics();
        };

        const originalStopSleepTracking = stopSleepTracking;
        stopSleepTracking = function(...args) {
            const result = originalStopSleepTracking(...args); 
            updateCorrelationAnalytics();
            return result;
        };

        let correlationUpdateTimeout;
        function scheduleCorrelationUpdate() {
            clearTimeout(correlationUpdateTimeout);
            correlationUpdateTimeout = setTimeout(updateCorrelationAnalytics, 1000);
        }

        function getUnmatchedDates() {
            const sleepByDate = {};
            
            try {
                (sleepSessions || []).forEach(session => {
                    if (!session || !session.start || !session.end) return;
                    
                    const startTime = session.start;
                    const endTime = session.end;
                    const durationHours = session.duration || 0;
                    
                    const startDate = new Date(startTime);
                    const endDate = new Date(endTime);
                    
                    const formatDateToKey = (date) => {
                        return date.toISOString().split('T')[0];
                    };
                    
                    if (formatDateToKey(startDate) === formatDateToKey(endDate)) {
                        const dateKey = formatDateToKey(startDate);
                        if (!sleepByDate[dateKey]) sleepByDate[dateKey] = 0;
                        sleepByDate[dateKey] += durationHours;
                    } else {
                        const endOfStartDay = new Date(startDate);
                        endOfStartDay.setHours(23, 59, 59, 999);
                        
                        const hoursBeforeMidnight = Math.max(0, (endOfStartDay - startTime) / (1000 * 60 * 60));
                        const hoursAfterMidnight = Math.max(0, durationHours - hoursBeforeMidnight);
                        
                        const startDateKey = formatDateToKey(startDate);
                        if (!sleepByDate[startDateKey]) sleepByDate[startDateKey] = 0;
                        sleepByDate[startDateKey] += hoursBeforeMidnight;
                        
                        const endDateKey = formatDateToKey(endDate);
                        if (!sleepByDate[endDateKey]) sleepByDate[endDateKey] = 0;
                        sleepByDate[endDateKey] += hoursAfterMidnight;
                    }
                });
                
                const unmatchedStudy = []; 
                const unmatchedSleep = []; 

                const studyDates = Object.keys(dailyStudyData || {});
                
                studyDates.forEach(date => {
                    if (sleepByDate[date] === undefined) {
                        unmatchedStudy.push({
                            date: date,
                            studyHours: dailyStudyData[date],
                            formattedDate: formatDateDisplay(date)
                        });
                    }
                });
                
                Object.keys(sleepByDate).forEach(date => {
                    if (!dailyStudyData || dailyStudyData[date] === undefined) {
                        unmatchedSleep.push({
                            date: date,
                            sleepHours: sleepByDate[date],
                            formattedDate: formatDateDisplay(date)
                        });
                    }
                });
                
                const matchedDates = studyDates.filter(date => sleepByDate[date] !== undefined);
                const totalTrackedDays = new Set([
                    ...studyDates,
                    ...Object.keys(sleepByDate)
                ]).size;
                
                const coveragePercent = totalTrackedDays > 0 
                    ? Math.round((matchedDates.length / totalTrackedDays) * 100)
                    : 0;
                
                const summary = {
                    totalDaysTracked: totalTrackedDays,
                    daysWithBothData: matchedDates.length,
                    daysWithOnlyStudy: unmatchedStudy.length,
                    daysWithOnlySleep: unmatchedSleep.length,
                    dataCoveragePercent: coveragePercent,
                    
                    recentUnmatchedStudy: unmatchedStudy
                        .filter(d => isDateWithinDays(d.date, 7))
                        .sort((a, b) => new Date(b.date) - new Date(a.date)),
                    
                    recentUnmatchedSleep: unmatchedSleep
                        .filter(d => isDateWithinDays(d.date, 7))
                        .sort((a, b) => new Date(b.date) - new Date(a.date)),
                    
                    hasSuspiciousData: hasSuspiciousEntries(unmatchedStudy, unmatchedSleep),
                    recommendations: generateRecommendations(unmatchedStudy, unmatchedSleep, coveragePercent)
                };
                
                return {
                    unmatchedStudy: unmatchedStudy,
                    unmatchedSleep: unmatchedSleep,
                    matchedDates: matchedDates,
                    sleepByDate: sleepByDate,
                    summary: summary
                };
                
            } catch (error) {
                console.error('Error in getUnmatchedDates:', error);
                return {
                    unmatchedStudy: [],
                    unmatchedSleep: [],
                    matchedDates: [],
                    sleepByDate: {},
                    summary: {
                        totalDaysTracked: 0,
                        daysWithBothData: 0,
                        daysWithOnlyStudy: 0,
                        daysWithOnlySleep: 0,
                        dataCoveragePercent: 0,
                        recentUnmatchedStudy: [],
                        recentUnmatchedSleep: [],
                        hasSuspiciousData: false,
                        recommendations: []
                    },
                    error: error.message
                };
            }
        }

        function formatDateDisplay(dateStr) {
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('vi-VN', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
            } catch {
                return dateStr;
            }
        }

        function isDateWithinDays(dateStr, days) {
            try {
                const date = new Date(dateStr);
                const today = new Date();
                const diffTime = Math.abs(today - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= days;
            } catch {
                return false;
            }
        }

        function hasSuspiciousEntries(unmatchedStudy, unmatchedSleep) {
            const highStudyNoSleep = unmatchedStudy.some(day => day.studyHours > 12);
            const veryShortSleepNoStudy = unmatchedSleep.some(day => day.sleepHours < 2);
            const unrealisticSleep = unmatchedSleep.some(day => day.sleepHours > 20);
            
            return highStudyNoSleep || veryShortSleepNoStudy || unrealisticSleep;
        }

        function generateRecommendations(unmatchedStudy, unmatchedSleep, coveragePercent) {
            const recommendations = [];
            
            if (coveragePercent < 50) {
                recommendations.push({
                    priority: 'high',
                    icon: 'ð',
                    title: 'Low Data Coverage',
                    message: `Only ${coveragePercent}% of tracked days have both sleep and study data.`,
                    action: 'Try to track both sleep and study consistently for better insights.'
                });
            } else if (coveragePercent < 80) {
                recommendations.push({
                    priority: 'medium',
                    icon: 'ð',
                    title: 'Moderate Data Coverage',
                    message: `${coveragePercent}% of tracked days have complete data.`,
                    action: 'Fill in missing days to improve correlation accuracy.'
                });
            }
            
            if (unmatchedStudy.length > 0) {
                const recentMissing = unmatchedStudy
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 3);
                
                if (recentMissing.length > 0) {
                    recommendations.push({
                        priority: 'medium',
                        icon: 'ð´',
                        title: 'Missing Sleep Data',
                        message: `${unmatchedStudy.length} days have study but no sleep data.`,
                        action: `Add sleep sessions for: ${recentMissing.map(d => d.formattedDate).join(', ')}`,
                        actionType: 'add_sleep',
                        dates: recentMissing.map(d => d.date)
                    });
                }
            }
            
            if (unmatchedSleep.length > 0) {
                const recentMissing = unmatchedSleep
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 3);
                
                if (recentMissing.length > 0) {
                    recommendations.push({
                        priority: 'medium',
                        icon: 'ð',
                        title: 'Missing Study Data',
                        message: `${unmatchedSleep.length} days have sleep but no study data.`,
                        action: `Add study hours for: ${recentMissing.map(d => d.formattedDate).join(', ')}`,
                        actionType: 'add_study',
                        dates: recentMissing.map(d => d.date)
                    });
                }
            }
            
            const matchedCount = Object.keys(dailyStudyData || {}).filter(date => {
                // Simplified check for matched dates
                const sleepByDate = {}; // Would need to recalc, but for simplicity...
                // We'll handle this in the calling function
                return true;
            }).length;
            
            if (matchedCount < 3) {
                recommendations.push({
                    priority: 'high',
                    icon: 'ð',
                    title: 'More Data Needed',
                    message: `Need at least 3 days with both sleep and study data for correlation analysis.`,
                    action: `Currently have ${matchedCount} matched days.`
                });
            }
            
            return recommendations.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
        }

        function showDataQualityReport() {
            const result = getUnmatchedDates();
            const summary = result.summary;
            
            console.log('=== DATA QUALITY REPORT ===');
            console.log(`Total tracked days: ${summary.totalDaysTracked}`);
            console.log(`Days with complete data: ${summary.daysWithBothData}`);
            console.log(`Days with only study: ${summary.daysWithOnlyStudy}`);
            console.log(`Days with only sleep: ${summary.daysWithOnlySleep}`);
            console.log(`Data coverage: ${summary.dataCoveragePercent}%`);
            
            if (summary.recentUnmatchedStudy.length > 0) {
                console.log('\nð Recent days missing sleep data:');
                summary.recentUnmatchedStudy.forEach(day => {
                    console.log(`  ${day.formattedDate}: ${day.studyHours}h study`);
                });
            }
            
            if (summary.recentUnmatchedSleep.length > 0) {
                console.log('\nð´ Recent days missing study data:');
                summary.recentUnmatchedSleep.forEach(day => {
                    console.log(`  ${day.formattedDate}: ${day.sleepHours}h sleep`);
                });
            }
            
            if (summary.recommendations.length > 0) {
                console.log('\nð¡ Recommendations:');
                summary.recommendations.forEach((rec, i) => {
                    console.log(`${i + 1}. ${rec.icon} ${rec.title}: ${rec.message}`);
                });
            }
            
            return result;
        }

        function updateDataQualityUI() {
            const container = document.getElementById('dataQualityContainer');
            if (!container) return;
            
            const result = getUnmatchedDates();
            const summary = result.summary;
            
            let html = `
                <div class="data-quality-card">
                    <div class="data-quality-header">
                        <h3>ð Data Quality</h3>
                        <div class="coverage-badge ${summary.dataCoveragePercent >= 80 ? 'good' : summary.dataCoveragePercent >= 50 ? 'medium' : 'poor'}">
                            ${summary.dataCoveragePercent}% complete
                        </div>
                    </div>
                    
                    <div class="data-stats">
                        <div class="stat-item">
                            <div class="stat-value">${summary.daysWithBothData}</div>
                            <div class="stat-label">â Complete days</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${summary.daysWithOnlyStudy}</div>
                            <div class="stat-label">ð Study only</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${summary.daysWithOnlySleep}</div>
                            <div class="stat-label">ð´ Sleep only</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${summary.totalDaysTracked}</div>
                            <div class="stat-label">ð Total tracked</div>
                        </div>
                    </div>
            `;
            
            if (summary.recommendations.length > 0) {
                html += `
                    <div class="recommendations-section">
                        <h4>ð¡ Recommendations</h4>
                        ${summary.recommendations.map(rec => `
                            <div class="recommendation ${rec.priority}">
                                <div class="rec-icon">${rec.icon}</div>
                                <div class="rec-content">
                                    <div class="rec-title">${rec.title}</div>
                                    <div class="rec-message">${rec.message}</div>
                                    <div class="rec-action">${rec.action}</div>
                                    ${rec.actionType ? `
                                        <button onclick="handleRecommendation('${rec.actionType}', ${JSON.stringify(rec.dates)})" 
                                                class="rec-action-btn">
                                            Take Action
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            html += `</div>`;
            container.innerHTML = html;
        }

        function handleRecommendation(actionType, dates) {
            switch (actionType) {
                case 'add_sleep':
                    const firstDate = dates[0];
                    if (firstDate) {
                        const dateObj = new Date(firstDate);
                        const modalTitle = `Add missing sleep for ${formatDateDisplay(firstDate)}`;
                        openManualSleepForDate(firstDate);
                    }
                    break;
                    
                case 'add_study':
                    if (dates.length > 0) {
                        showNotification(`Add study hours for ${dates.length} missing days`, 'info');
                    }
                    break;
            }
        }

        function openManualSleepForDate(dateStr) {
            const date = new Date(dateStr);
            const nextDay = new Date(date);
            nextDay.setDate(nextDay.getDate() + 1);
            function toLocalDatetimeString(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }
            const sleepStart = new Date(date);
            sleepStart.setHours(23, 0, 0);
            const sleepEnd = new Date(date);
            sleepEnd.setDate(sleepEnd.getDate() + 1);
            sleepEnd.setHours(7, 0, 0);
            openManualSleepModal(sleepStart, sleepEnd, `Add missing sleep for ${formatDateDisplay(dateStr)}`);
        }

        function getRecommendations() {
            const result = getUnmatchedDates();
            const { unmatchedStudy, unmatchedSleep } = result;
            const summary = result.summary;
            
            const recommendations = [];
            
            if (summary.daysWithBothData < 3) {
                const daysNeeded = 3 - summary.daysWithBothData;
                const missingType = unmatchedStudy.length >= unmatchedSleep.length ? 'sleep' : 'study';
                
                recommendations.push({
                    id: 'priority_correlation',
                    priority: 'high',
                    icon: 'ð',
                    title: 'Enable Correlation Analysis',
                    message: `Need ${daysNeeded} more day${daysNeeded > 1 ? 's' : ''} with both sleep and study data to see correlations.`,
                    action: `Quick fix: Add ${missingType} data for recent days`,
                    actionType: 'quick_fill_correlation',
                    actionData: { daysNeeded, missingType },
                    progress: `${summary.daysWithBothData}/3 days`,
                    progressPercent: Math.round((summary.daysWithBothData / 3) * 100)
                });
            }
            
            const recentCutoff = new Date();
            recentCutoff.setDate(recentCutoff.getDate() - 3);
            
            const recentUnmatchedStudy = unmatchedStudy.filter(d => 
                new Date(d.date) >= recentCutoff
            ).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const recentUnmatchedSleep = unmatchedSleep.filter(d => 
                new Date(d.date) >= recentCutoff
            ).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (recentUnmatchedStudy.length > 0) {
                const dates = recentUnmatchedStudy.slice(0, 2).map(d => d.formattedDate);
                const totalHours = recentUnmatchedStudy.reduce((sum, d) => sum + (d.studyHours || 0), 0);
                
                recommendations.push({
                    id: 'recent_missing_sleep',
                    priority: 'medium',
                    icon: 'ð´',
                    title: 'Recent Days Missing Sleep Data',
                    message: `${recentUnmatchedStudy.length} recent day${recentUnmatchedStudy.length > 1 ? 's' : ''} have study data (${totalHours.toFixed(1)}h total) but no sleep data.`,
                    action: `Add sleep sessions for: ${dates.join(', ')}`,
                    actionType: 'add_multiple_sleep',
                    actionData: {
                        dates: recentUnmatchedStudy.map(d => d.date),
                        studyHours: recentUnmatchedStudy.map(d => d.studyHours)
                    },
                    quickAction: true
                });
            }
            
            if (recentUnmatchedSleep.length > 0) {
                const dates = recentUnmatchedSleep.slice(0, 2).map(d => d.formattedDate);
                const totalHours = recentUnmatchedSleep.reduce((sum, d) => sum + (d.sleepHours || 0), 0);
                
                recommendations.push({
                    id: 'recent_missing_study',
                    priority: 'medium',
                    icon: 'ð',
                    title: 'Recent Days Missing Study Data',
                    message: `${recentUnmatchedSleep.length} recent day${recentUnmatchedSleep.length > 1 ? 's' : ''} have sleep data (${totalHours.toFixed(1)}h total) but no study data.`,
                    action: `Add study hours for: ${dates.join(', ')}`,
                    actionType: 'add_multiple_study',
                    actionData: {
                        dates: recentUnmatchedSleep.map(d => d.date),
                        sleepHours: recentUnmatchedSleep.map(d => d.sleepHours)
                    },
                    quickAction: true
                });
            }
            
            if (summary.hasSuspiciousData) {
                const suspiciousItems = [];
                
                const highStudyNoSleep = unmatchedStudy.filter(d => d.studyHours > 12);
                if (highStudyNoSleep.length > 0) {
                    suspiciousItems.push(`${highStudyNoSleep.length} day${highStudyNoSleep.length > 1 ? 's' : ''} with >12h study but no sleep`);
                }
                
                const veryShortSleep = unmatchedSleep.filter(d => d.sleepHours < 2);
                if (veryShortSleep.length > 0) {
                    suspiciousItems.push(`${veryShortSleep.length} day${veryShortSleep.length > 1 ? 's' : ''} with <2h sleep but no study`);
                }
                
                if (suspiciousItems.length > 0) {
                    recommendations.push({
                        id: 'suspicious_data',
                        priority: 'medium',
                        icon: 'â ï¸',
                        title: 'Data Quality Check',
                        message: `Found potentially inaccurate data: ${suspiciousItems.join('; ')}.`,
                        action: 'Review and correct these entries',
                        actionType: 'review_suspicious',
                        actionData: {
                            highStudy: highStudyNoSleep,
                            shortSleep: veryShortSleep
                        }
                    });
                }
            }
            
            if (summary.totalDaysTracked >= 7) { 
                const weeklyCoverage = summary.dataCoveragePercent;
                
                if (weeklyCoverage < 70) {
                    const bestDay = getBestCoverageDay();
                    const worstDay = getWorstCoverageDay();
                    
                    recommendations.push({
                        id: 'consistency_pattern',
                        priority: 'low',
                        icon: 'ð',
                        title: 'Improve Tracking Consistency',
                        message: `You track consistently on ${bestDay}, but often miss on ${worstDay}.`,
                        action: `Set reminder for ${worstDay}`,
                        actionType: 'set_reminder',
                        actionData: { bestDay, worstDay }
                    });
                }
            }
            
            if (summary.daysWithBothData >= 7 && summary.dataCoveragePercent >= 80) {
                recommendations.push({
                    id: 'achievement_good',
                    priority: 'low',
                    icon: 'ð',
                    title: 'Excellent Tracking!',
                    message: `You've maintained ${summary.dataCoveragePercent}% data completeness for the past week.`,
                    action: 'Keep up the great work!',
                    actionType: 'celebrate',
                    isPositive: true
                });
            }
            
            return recommendations.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                if (a.isPositive && !b.isPositive) return 1;
                if (!a.isPositive && b.isPositive) return -1;
                return 0;
            });
        }

        function getBestCoverageDay() {
            const dayStats = {
                'Monday': 0, 'Tuesday': 0, 'Wednesday': 0, 'Thursday': 0,
                'Friday': 0, 'Saturday': 0, 'Sunday': 0
            };
            
            const result = getUnmatchedDates();
            const { matchedDates } = result;
            
            matchedDates.forEach(dateStr => {
                try {
                    const date = new Date(dateStr);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                    dayStats[dayName] = (dayStats[dayName] || 0) + 1;
                } catch (e) {}
            });
            
            let bestDay = 'Monday';
            let maxCount = 0;
            
            Object.entries(dayStats).forEach(([day, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    bestDay = day;
                }
            });
            
            return bestDay;
        }

        function getWorstCoverageDay() {
            const dayStats = {
                'Monday': 0, 'Tuesday': 0, 'Wednesday': 0, 'Thursday': 0,
                'Friday': 0, 'Saturday': 0, 'Sunday': 0
            };
            
            const result = getUnmatchedDates();
            const { unmatchedStudy, unmatchedSleep } = result;
            
            [...unmatchedStudy, ...unmatchedSleep].forEach(item => {
                try {
                    const date = new Date(item.date);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                    dayStats[dayName] = (dayStats[dayName] || 0) + 1;
                } catch (e) {}
            });
            
            let worstDay = 'Sunday'; 
            let maxCount = 0;
            
            Object.entries(dayStats).forEach(([day, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    worstDay = day;
                }
            });
            
            return worstDay;
        }

        function handleRecommendationAction(recommendation) {
            console.log('Handling recommendation:', recommendation);
            
            switch (recommendation.actionType) {
                case 'quick_fill_correlation':
                    openQuickFillModal(recommendation.actionData);
                    break;
                    
                case 'add_multiple_sleep':
                    openBulkSleepModal(recommendation.actionData);
                    break;
                    
                case 'add_multiple_study':
                    openBulkStudyModal(recommendation.actionData);
                    break;
                    
                case 'review_suspicious':
                    openDataReviewModal(recommendation.actionData);
                    break;
                    
                case 'set_reminder':
                    setTrackingReminder(recommendation.actionData);
                    break;
                    
                case 'celebrate':
                    showAchievement(recommendation);
                    break;
                    
                default:
                    console.log('No handler for action type:', recommendation.actionType);
            }
        }

        function renderRecommendationsUI() {
            const container = document.getElementById('recommendationsContainer');
            if (!container) return;
            
            const recommendations = getRecommendations();
            
            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="no-recommendations">
                        <div class="celebrate-icon">ð</div>
                        <h3>Great Job!</h3>
                        <p>Your data is complete and ready for analysis.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="recommendations-list">
                    <div class="recommendations-header">
                        <h3>ð¡ Smart Recommendations</h3>
                        <div class="recommendations-count">${recommendations.length} suggestions</div>
                    </div>
            `;
            
            recommendations.forEach(rec => {
                const priorityClass = rec.priority || 'medium';
                const isPositive = rec.isPositive || false;
                
                html += `
                    <div class="recommendation-card ${priorityClass} ${isPositive ? 'positive' : ''}">
                        <div class="rec-main">
                            <div class="rec-icon">${rec.icon}</div>
                            <div class="rec-content">
                                <div class="rec-header">
                                    <div class="rec-title">${rec.title}</div>
                                    ${rec.progress ? `
                                        <div class="rec-progress">
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${rec.progressPercent}%"></div>
                                            </div>
                                            <span class="progress-text">${rec.progress}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div class="rec-message">${rec.message}</div>
                                
                                ${rec.action ? `
                                    <div class="rec-actions">
                                        <div class="rec-action-text">${rec.action}</div>
                                        ${rec.quickAction ? `
                                            <button onclick="handleRecommendationAction(${JSON.stringify(rec).replace(/"/g, '&quot;')})" 
                                                    class="rec-action-btn quick">
                                                Quick Fix
                                            </button>
                                        ` : `
                                            <button onclick="handleRecommendationAction(${JSON.stringify(rec).replace(/"/g, '&quot;')})" 
                                                    class="rec-action-btn">
                                                Fix It
                                            </button>
                                        `}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${rec.priority === 'high' ? `
                            <div class="rec-priority-badge">
                                <span class="priority-dot"></span>
                                High Priority
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `</div>`;
            
            if (!document.querySelector('#recommendations-styles')) {
                const style = document.createElement('style');
                style.id = 'recommendations-styles';
                style.textContent = `
                    .recommendations-list {
                        background: var(--bg-white);
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: var(--shadow-sm);
                    }
                    
                    .recommendations-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        padding-bottom: 15px;
                        border-bottom: 1px solid var(--border-color);
                    }
                    
                    .recommendations-header h3 {
                        margin: 0;
                        font-size: 1.1rem;
                        color: var(--text-dark);
                    }
                    
                    .recommendations-count {
                        background: var(--primary-light);
                        color: var(--primary);
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 0.85rem;
                        font-weight: 600;
                    }
                    
                    .recommendation-card {
                        background: var(--bg-light);
                        border-radius: 10px;
                        padding: 16px;
                        margin-bottom: 12px;
                        border-left: 4px solid;
                        position: relative;
                        transition: transform 0.2s;
                    }
                    
                    .recommendation-card:hover {
                        transform: translateY(-2px);
                        box-shadow: var(--shadow-md);
                    }
                    
                    .recommendation-card.high {
                        border-left-color: #ef4444;
                        background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), transparent);
                    }
                    
                    .recommendation-card.medium {
                        border-left-color: #f59e0b;
                        background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), transparent);
                    }
                    
                    .recommendation-card.low {
                        border-left-color: #3b82f6;
                        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), transparent);
                    }
                    
                    .recommendation-card.positive {
                        border-left-color: #10b981;
                        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), transparent);
                    }
                    
                    .rec-main {
                        display: flex;
                        gap: 12px;
                    }
                    
                    .rec-icon {
                        font-size: 1.5rem;
                        flex-shrink: 0;
                    }
                    
                    .rec-content {
                        flex: 1;
                        min-width: 0;
                    }
                    
                    .rec-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 8px;
                        flex-wrap: wrap;
                        gap: 8px;
                    }
                    
                    .rec-title {
                        font-weight: 700;
                        color: var(--text-dark);
                        font-size: 1rem;
                    }
                    
                    .rec-progress {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    
                    .progress-bar {
                        width: 60px;
                        height: 6px;
                        background: var(--border-color);
                        border-radius: 3px;
                        overflow: hidden;
                    }
                    
                    .progress-fill {
                        height: 100%;
                        background: var(--primary);
                        border-radius: 3px;
                        transition: width 0.3s;
                    }
                    
                    .progress-text {
                        font-size: 0.8rem;
                        color: var(--text-muted);
                        font-weight: 600;
                    }
                    
                    .rec-message {
                        color: var(--text-dark);
                        font-size: 0.9rem;
                        line-height: 1.4;
                        margin-bottom: 12px;
                    }
                    
                    .rec-actions {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        gap: 10px;
                        flex-wrap: wrap;
                    }
                    
                    .rec-action-text {
                        color: var(--text-muted);
                        font-size: 0.85rem;
                        flex: 1;
                        min-width: 200px;
                    }
                    
                    .rec-action-btn {
                        background: var(--primary);
                        color: white;
                        border: none;
                        padding: 6px 16px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 0.85rem;
                        font-weight: 600;
                        transition: all 0.2s;
                        white-space: nowrap;
                    }
                    
                    .rec-action-btn:hover {
                        background: var(--primary-dark);
                        transform: translateY(-1px);
                    }
                    
                    .rec-action-btn.quick {
                        background: #10b981;
                    }
                    
                    .rec-action-btn.quick:hover {
                        background: #0da271;
                    }
                    
                    .rec-priority-badge {
                        position: absolute;
                        top: -8px;
                        right: 12px;
                        background: #ef4444;
                        color: white;
                        padding: 4px 10px;
                        border-radius: 12px;
                        font-size: 0.75rem;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    }
                    
                    .priority-dot {
                        width: 6px;
                        height: 6px;
                        background: white;
                        border-radius: 50%;
                        animation: pulse 1.5s infinite;
                    }
                    
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.5; }
                    }
                    
                    .no-recommendations {
                        text-align: center;
                        padding: 40px 20px;
                        color: var(--text-muted);
                    }
                    
                    .celebrate-icon {
                        font-size: 3rem;
                        margin-bottom: 15px;
                        animation: bounce 2s infinite;
                    }
                    
                    .no-recommendations h3 {
                        color: #10b981;
                        margin: 0 0 8px 0;
                    }
                    
                    @keyframes bounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-10px); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            container.innerHTML = html;
        }

        function updateAllRecommendations() {
            renderRecommendationsUI();
            updateDataQualityUI();
            updateCorrelationAnalytics();
        }

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(updateAllRecommendations, 1000);
            
            const originalAddStudyTime = addStudyTime;
            if (originalAddStudyTime) {
                addStudyTime = function(...args) {
                    const result = originalAddStudyTime(...args);
                    setTimeout(updateAllRecommendations, 500);
                    return result;
                };
            }
            
            const originalStopSleepTracking = stopSleepTracking;
            stopSleepTracking = function() {
                const result = originalStopSleepTracking();
                setTimeout(updateAllRecommendations, 500);
                return result;
            };
            
            const originalOpenManualSleepModal = openManualSleepModal;
            openManualSleepModal = function(...args) {
                const result = originalOpenManualSleepModal(...args);
                setTimeout(updateAllRecommendations, 500);
                return result;
            };
        });






// ===== HELPER FUNCTIONS FOR PATTERN DETECTION =====
function calculateWeeklyConsistency(weeklyAverages) {
    if (!weeklyAverages || weeklyAverages.length < 2) return 0;
    
    try {
        const durations = weeklyAverages
            .map(w => w.avgDuration)
            .filter(d => d !== undefined && d !== null && !isNaN(d));
        
        if (durations.length < 2) return 0;
        
        return calculateConsistencyScore(durations);
    } catch (error) {
        console.error('Error in calculateWeeklyConsistency:', error);
        return 0;
    }
}

function calculateAverageForDays(weekData, days, metric) {
    if (!weekData || !days || days.length === 0) return 0;
    
    try {
        const values = days
            .map(day => {
                if (!weekData[day]) return null;
                return metric === 'sleep' ? weekData[day].avgSleep : weekData[day].avgStudy;
            })
            .filter(v => v !== undefined && v !== null && !isNaN(v));
        
        if (values.length === 0) return 0;
        
        const sum = values.reduce((a, b) => a + b, 0);
        return parseFloat((sum / values.length).toFixed(1));
    } catch (error) {
        console.error('Error in calculateAverageForDays:', error);
        return 0;
    }
}

function calculateDifference(weekData, weekdays, weekends, metric) {
    if (!weekData) return 0;
    
    try {
        const weekdayAvg = calculateAverageForDays(weekData, weekdays, metric);
        const weekendAvg = calculateAverageForDays(weekData, weekends, metric);
        return parseFloat((weekdayAvg - weekendAvg).toFixed(1));
    } catch (error) {
        console.error('Error in calculateDifference:', error);
        return 0;
    }
}

function detectWeeklyCycles(weekData) {
    if (!weekData || Object.keys(weekData).length < 14) {
        return {
            hasCycle: false,
            cycleLength: null,
            pattern: 'insufficient_data',
            confidence: 0
        };
    }
    
    try {
        const days = Object.keys(weekData).sort();
        const sleepValues = days.map(d => weekData[d].avgSleep || 0);

        let cycleMatches = 0;
        let totalComparisons = 0;
        
        for (let i = 7; i < sleepValues.length; i++) {
            const diff = Math.abs(sleepValues[i] - sleepValues[i - 7]);
            totalComparisons++;

            if (diff < 1.0) {
                cycleMatches++;
            }
        }
        
        const matchRate = totalComparisons > 0 ? cycleMatches / totalComparisons : 0;
        const hasCycle = matchRate >= 0.6; 

        let cycleStrength = 'weak';
        if (matchRate >= 0.8) cycleStrength = 'strong';
        else if (matchRate >= 0.7) cycleStrength = 'moderate';
        
        return {
            hasCycle: hasCycle,
            cycleLength: hasCycle ? 7 : null,
            pattern: hasCycle ? 'weekly' : 'irregular',
            confidence: Math.round(matchRate * 100),
            strength: hasCycle ? cycleStrength : null,
            matchRate: matchRate
        };
    } catch (error) {
        console.error('Error in detectWeeklyCycles:', error);
        return {
            hasCycle: false,
            cycleLength: null,
            pattern: 'error',
            confidence: 0
        };
    }
}

function findMostConsistentDay(weekData) {
    if (!weekData || Object.keys(weekData).length === 0) {
        return { day: 'Unknown', variance: null };
    }
    
    try {
        let mostConsistent = null;
        let lowestVariance = Infinity;
        
        Object.entries(weekData).forEach(([day, data]) => {
            if (data.sleep && Array.isArray(data.sleep) && data.sleep.length >= 2) {
                const variance = calculateVariance(data.sleep);
                if (variance < lowestVariance) {
                    lowestVariance = variance;
                    mostConsistent = day;
                }
            }
        });
        
        return {
            day: mostConsistent || 'Unknown',
            variance: mostConsistent ? lowestVariance.toFixed(2) : null,
            consistency: mostConsistent ? (100 - Math.min(100, lowestVariance * 10)).toFixed(0) : null
        };
    } catch (error) {
        console.error('Error in findMostConsistentDay:', error);
        return { day: 'Error', variance: null };
    }
}

function findLeastConsistentDay(weekData) {
    if (!weekData || Object.keys(weekData).length === 0) {
        return { day: 'Unknown', variance: null };
    }
    
    try {
        let leastConsistent = null;
        let highestVariance = -Infinity;
        
        Object.entries(weekData).forEach(([day, data]) => {
            if (data.sleep && Array.isArray(data.sleep) && data.sleep.length >= 2) {
                const variance = calculateVariance(data.sleep);
                if (variance > highestVariance) {
                    highestVariance = variance;
                    leastConsistent = day;
                }
            }
        });
        
        return {
            day: leastConsistent || 'Unknown',
            variance: leastConsistent ? highestVariance.toFixed(2) : null,
            consistency: leastConsistent ? (100 - Math.min(100, highestVariance * 10)).toFixed(0) : null
        };
    } catch (error) {
        console.error('Error in findLeastConsistentDay:', error);
        return { day: 'Error', variance: null };
    }
}

function calculatePatternStrength(weekData) {
    if (!weekData || Object.keys(weekData).length === 0) return 0;
    
    try {
        const avgScores = Object.values(weekData)
            .filter(d => d.avgSleep !== undefined && d.avgSleep !== null)
            .map(d => d.avgSleep);
        
        if (avgScores.length < 2) return 0;
        
        return calculateConsistencyScore(avgScores);
    } catch (error) {
        console.error('Error in calculatePatternStrength:', error);
        return 0;
    }
}

function getAverageByWeekday(bedtimes, isWeekend) {
    if (!bedtimes || bedtimes.length === 0) return 'N/A';
    
    try {
        const filtered = bedtimes.filter(b => b.isWeekend === isWeekend);
        if (filtered.length === 0) return 'N/A';
        
        const avgDecimal = filtered.reduce((sum, t) => sum + t.hour + (t.minute / 60), 0) / filtered.length;
        return formatTimeFromDecimal(avgDecimal);
    } catch (error) {
        console.error('Error in getAverageByWeekday:', error);
        return 'Error';
    }
}

function calculateStudyStreak() {
    if (!dailyStudyData || Object.keys(dailyStudyData).length === 0) return 0;
    
    try {
        const dates = Object.keys(dailyStudyData)
            .filter(date => dailyStudyData[date] > 0)
            .sort();
        
        if (dates.length === 0) return 0;
        
        let streak = 1;
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const lastDate = new Date(dates[dates.length - 1]);
        lastDate.setHours(0, 0, 0, 0);
        const daysSinceLastStudy = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
        
        if (daysSinceLastStudy > 1) {
            return 0; 
        }

        for (let i = dates.length - 1; i > 0; i--) {
            const current = new Date(dates[i]);
            const previous = new Date(dates[i - 1]);
            const diffDays = Math.floor((current - previous) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                streak++;
            } else {
                break;
            }
        }
        
        return streak;
    } catch (error) {
        console.error('Error in calculateStudyStreak:', error);
        return 0;
    }
}

function calculateMissedStudyDays(studyDays) {
    if (!studyDays || studyDays.length < 2) return 0;
    
    try {
        const sorted = [...studyDays].sort();
        const start = new Date(sorted[0]);
        const end = new Date(sorted[sorted.length - 1]);
        const totalDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
        return Math.max(0, totalDays - studyDays.length);
    } catch (error) {
        console.error('Error in calculateMissedStudyDays:', error);
        return 0;
    }
}

function calculateStudyConsistencyScore(hours) {
    if (!hours || hours.length < 2) return 0;
    
    try {
        const validHours = hours.filter(h => !isNaN(h) && h >= 0);
        if (validHours.length < 2) return 0;
        
        const avg = validHours.reduce((a, b) => a + b, 0) / validHours.length;
        if (avg === 0) return 0;
        
        const stdDev = calculateStandardDeviation(validHours);
        const cv = (stdDev / avg) * 100; 

        const consistencyScore = Math.max(0, Math.min(100, 100 - cv));
        
        return Math.round(consistencyScore);
    } catch (error) {
        console.error('Error in calculateStudyConsistencyScore:', error);
        return 0;
    }
}

function analyzeStudyEfficiency(sessionLogs) {
    if (!sessionLogs || sessionLogs.length === 0) {
        return {
            avgEfficiency: 0,
            totalSessions: 0,
            qualitySessions: 0,
            efficiency: 'unknown'
        };
    }
    
    try {
        let qualityCount = 0;
        let totalDuration = 0;
        
        sessionLogs.forEach(log => {
            const duration = log.duration || 0;
            totalDuration += duration;

            if (duration >= 1) {
                const completionRate = log.completionRate || 100;
                if (completionRate >= 70) {
                    qualityCount++;
                }
            }
        });
        
        const qualityRate = sessionLogs.length > 0 ? 
            (qualityCount / sessionLogs.length) * 100 : 0;
        
        const avgDuration = sessionLogs.length > 0 ? 
            totalDuration / sessionLogs.length : 0;
        
        const avgEfficiency = Math.min(100, Math.round(
            (qualityRate * 0.7) + (Math.min(avgDuration / 3, 1) * 30)
        ));
        
        let efficiencyLevel = 'low';
        if (avgEfficiency >= 75) efficiencyLevel = 'high';
        else if (avgEfficiency >= 50) efficiencyLevel = 'medium';
        
        return {
            avgEfficiency: avgEfficiency,
            totalSessions: sessionLogs.length,
            qualitySessions: qualityCount,
            efficiency: efficiencyLevel,
            avgDuration: avgDuration.toFixed(1),
            qualityRate: qualityRate.toFixed(1)
        };
    } catch (error) {
        console.error('Error in analyzeStudyEfficiency:', error);
        return {
            avgEfficiency: 0,
            totalSessions: 0,
            qualitySessions: 0,
            efficiency: 'error'
        };
    }
}

function analyzeStudyTiming(sessionLogs) {
    if (!sessionLogs || sessionLogs.length === 0) {
        return {
            peakHours: 'Unknown',
            avgSessionLength: 0,
            morningCount: 0,
            afternoonCount: 0,
            eveningCount: 0,
            nightCount: 0
        };
    }
    
    try {
        const hourCounts = {};
        const timePeriods = {
            morning: 0,   // 6-12
            afternoon: 0, // 12-18
            evening: 0,   // 18-22
            night: 0      // 22-6
        };
        let totalDuration = 0;
        
        sessionLogs.forEach(log => {
            const timestamp = log.timestamp || Date.now();
            const date = new Date(timestamp);
            const hour = date.getHours();
            
            hourCounts[hour] = (hourCounts[hour] || 0) + 1;
            totalDuration += (log.duration || 0);

            if (hour >= 6 && hour < 12) timePeriods.morning++;
            else if (hour >= 12 && hour < 18) timePeriods.afternoon++;
            else if (hour >= 18 && hour < 22) timePeriods.evening++;
            else timePeriods.night++;
        });

        const sortedHours = Object.entries(hourCounts)
            .sort(([,a], [,b]) => b - a);
        
        const peakHour = sortedHours[0]?.[0];
        const peakCount = sortedHours[0]?.[1] || 0;

        const peakRange = peakHour ? 
            `${String(peakHour).padStart(2, '0')}:00-${String((parseInt(peakHour) + 2) % 24).padStart(2, '0')}:00` : 
            'Not enough data';

        const preferredPeriod = Object.entries(timePeriods)
            .sort(([,a], [,b]) => b - a)[0]?.[0] || 'unknown';
        
        return {
            peakHours: peakRange,
            peakHourCount: peakCount,
            avgSessionLength: sessionLogs.length > 0 ? 
                (totalDuration / sessionLogs.length).toFixed(1) : 0,
            morningCount: timePeriods.morning,
            afternoonCount: timePeriods.afternoon,
            eveningCount: timePeriods.evening,
            nightCount: timePeriods.night,
            preferredPeriod: preferredPeriod,
            totalSessions: sessionLogs.length
        };
    } catch (error) {
        console.error('Error in analyzeStudyTiming:', error);
        return {
            peakHours: 'Error',
            avgSessionLength: 0
        };
    }
}

function analyzeWeeklyStudyTrend(studyDays, dailyData) {
    if (!studyDays || !dailyData || studyDays.length < 14) {
        return 'insufficient_data';
    }
    
    try {
        const sortedDays = [...studyDays].sort();
        const recentDays = sortedDays.slice(-7);
        const previousDays = sortedDays.slice(-14, -7);
        
        const recentAvg = recentDays.reduce((sum, day) => 
            sum + (dailyData[day] || 0), 0) / recentDays.length;
        
        const previousAvg = previousDays.reduce((sum, day) => 
            sum + (dailyData[day] || 0), 0) / previousDays.length;
        
        const change = ((recentAvg - previousAvg) / previousAvg) * 100;
        
        if (Math.abs(change) < 5) return 'stable';
        if (change > 15) return 'rapidly_improving';
        if (change > 5) return 'improving';
        if (change < -15) return 'declining_sharply';
        if (change < -5) return 'declining';
        
        return 'stable';
    } catch (error) {
        console.error('Error in analyzeWeeklyStudyTrend:', error);
        return 'error';
    }
}

function calculateMonthlyGrowth(studyDays, dailyData) {
    if (!studyDays || !dailyData || studyDays.length < 30) {
        return 'N/A';
    }
    
    try {
        const sortedDays = [...studyDays].sort();
        const recentMonth = sortedDays.slice(-30);
        const previousMonth = sortedDays.slice(-60, -30);
        
        if (previousMonth.length < 15) return 'N/A';
        
        const recentTotal = recentMonth.reduce((sum, day) => 
            sum + (dailyData[day] || 0), 0);
        
        const previousTotal = previousMonth.reduce((sum, day) => 
            sum + (dailyData[day] || 0), 0);
        
        if (previousTotal === 0) return 'N/A';
        
        const growth = ((recentTotal - previousTotal) / previousTotal) * 100;
        const sign = growth >= 0 ? '+' : '';
        
        return `${sign}${growth.toFixed(0)}%`;
    } catch (error) {
        console.error('Error in calculateMonthlyGrowth:', error);
        return 'Error';
    }
}

function findOptimalSleepForStudy(sleepStudyData) {
    if (!sleepStudyData || !sleepStudyData.data || sleepStudyData.data.length < 3) {
        return {
            optimal: 'N/A',
            range: 'N/A',
            confidence: 0
        };
    }
    
    try {
        const sorted = [...sleepStudyData.data]
            .filter(d => d.sleep > 0 && d.study > 0)
            .sort((a, b) => b.study - a.study);
        
        if (sorted.length < 3) {
            return {
                optimal: 'N/A',
                range: 'N/A',
                confidence: 0
            };
        }

        const topCount = Math.max(3, Math.ceil(sorted.length * 0.3));
        const topPerformers = sorted.slice(0, topCount);

        const avgOptimalSleep = topPerformers
            .reduce((sum, d) => sum + d.sleep, 0) / topPerformers.length;

        const sleepValues = topPerformers.map(d => d.sleep);
        const stdDev = calculateStandardDeviation(sleepValues);
        
        const minOptimal = Math.max(4, avgOptimalSleep - stdDev);
        const maxOptimal = Math.min(12, avgOptimalSleep + stdDev);

        const cv = (stdDev / avgOptimalSleep) * 100;
        const confidence = Math.max(0, Math.min(100, 100 - cv));
        
        return {
            optimal: `${avgOptimalSleep.toFixed(1)}h`,
            range: `${minOptimal.toFixed(1)}-${maxOptimal.toFixed(1)}h`,
            confidence: Math.round(confidence),
            sampleSize: topPerformers.length
        };
    } catch (error) {
        console.error('Error in findOptimalSleepForStudy:', error);
        return {
            optimal: 'Error',
            range: 'Error',
            confidence: 0
        };
    }
}

function calculateSleepStudyCorrelation() {
    const sleepByDate = {};
    const pairedData = [];

    if (!sleepSessions || !dailyStudyData) {
        return getEmptyResult("Missing input data");
    }

    (sleepSessions || []).forEach(session => {
        if (!session?.start || !session?.end || !session?.duration) return;
        
        const durationHours = session.duration;
        if (durationHours <= 0 || durationHours > 24) return;
        
        const startDate = new Date(session.start);
        const endDate = new Date(session.end);
        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return;
        
        const formatDateToKey = (date) => date.toISOString().split('T')[0];
        const startKey = formatDateToKey(startDate);
        const endKey = formatDateToKey(endDate);

        if (startKey === endKey) {
            sleepByDate[startKey] = (sleepByDate[startKey] || 0) + durationHours;
        } else {
            const endOfStartDay = new Date(startDate);
            endOfStartDay.setHours(23, 59, 59, 999);
            
            const hoursBeforeMidnight = Math.max(0, (endOfStartDay - startDate) / (1000 * 60 * 60));
            const hoursAfterMidnight = Math.max(0, durationHours - hoursBeforeMidnight);
            
            sleepByDate[startKey] = Math.min(24, (sleepByDate[startKey] || 0) + hoursBeforeMidnight);
            sleepByDate[endKey] = Math.min(24, (sleepByDate[endKey] || 0) + hoursAfterMidnight);
        }
    });

    Object.keys(dailyStudyData).forEach(dateKey => {
        const sleepHours = sleepByDate[dateKey];
        if (sleepHours === undefined) return;
        
        const studyHours = dailyStudyData[dateKey] || 0;
        if (sleepHours >= 1 && sleepHours <= 24 && studyHours >= 0 && studyHours <= 24) {
            pairedData.push({
                sleep: parseFloat(sleepHours.toFixed(1)),
                study: parseFloat(studyHours.toFixed(1)),
                date: dateKey
            });
        }
    });

    if (pairedData.length < 2) {
        return getEmptyResult("Insufficient data points", pairedData);
    }

    const sleepData = pairedData.map(d => d.sleep);
    const studyData = pairedData.map(d => d.study);
    const correlation = calculateCorrelation(sleepData, studyData);

    return {
        correlation: parseFloat(correlation.toFixed(3)),
        sleepData: sleepData,
        studyData: studyData,
        data: pairedData,
        matchedDays: pairedData.length,
        isValid: true,
        sleepStats: {
            min: Math.min(...sleepData),
            max: Math.max(...sleepData),
            avg: parseFloat((sleepData.reduce((a,b) => a + b, 0) / sleepData.length).toFixed(1))
        },
        studyStats: {
            min: Math.min(...studyData),
            max: Math.max(...studyData),
            avg: parseFloat((studyData.reduce((a,b) => a + b, 0) / studyData.length).toFixed(1))
        }
    };
}

function getCorrelationStrength(r) {
    const abs = Math.abs(r || 0);
    if (abs >= 0.7) return 'strong';
    if (abs >= 0.4) return 'moderate';
    if (abs >= 0.2) return 'weak';
    return 'very_weak';
}

function detectInvertedURelationship(sleepStudy) {
    if (!sleepStudy?.data || sleepStudy.data.length < 8) {
        return {
            isInvertedU: false,
            confidence: 0,
            reason: 'Insufficient data',
            method: 'none'
        };
    }

    const quadratic = detectInvertedUQuadratic(sleepStudy);
    const piecewise = detectInvertedUPiecewise(sleepStudy);
    const simple = detectInvertedUSimple(sleepStudy);

    const results = [
        { method: 'quadratic', ...quadratic, weight: 0.5 },
        { method: 'piecewise', ...piecewise, weight: 0.3 },
        { method: 'simple', ...simple, weight: 0.2 }
    ];

    let weightedYes = 0;
    let totalWeight = 0;
    let avgConfidence = 0;

    results.forEach(r => {
        if (r.isInvertedU) weightedYes += r.weight;
        totalWeight += r.weight;
        avgConfidence += (r.confidence || 0) * r.weight;
    });

    const finalIsInvertedU = weightedYes / totalWeight >= 0.5;
    const finalConfidence = avgConfidence / totalWeight;
    const bestMethod = results.reduce((best, current) => 
        (current.confidence || 0) > (best.confidence || 0) ? current : best
    );

    const peak = bestMethod.peak || null;
    let interpretation = "";

    if (finalIsInvertedU && finalConfidence >= 60) {
        interpretation = `Inverted-U detected with ${Math.round(finalConfidence)}% confidence. `;
        if (peak?.sleepHours) {
            interpretation += `Optimal sleep: ${peak.sleepHours.toFixed(1)}h. `;
            if (peak.sleepHours < 6) interpretation += "Below recommended range.";
            else if (peak.sleepHours > 9) interpretation += "Above typical range.";
            else interpretation += "Within healthy range.";
        }
    } else if (finalIsInvertedU) {
        interpretation = "Weak Inverted-U pattern detected.";
    } else {
        interpretation = "No clear Inverted-U relationship.";
    }

    return {
        isInvertedU: finalIsInvertedU,
        confidence: Math.round(finalConfidence),
        peak: peak,
        methods: {
            quadratic: { isInvertedU: quadratic.isInvertedU, confidence: quadratic.confidence },
            piecewise: { isInvertedU: piecewise.isInvertedU, confidence: piecewise.confidence },
            simple: { isInvertedU: simple.isInvertedU, confidence: simple.confidence }
        },
        agreement: {
            yesVotes: results.filter(r => r.isInvertedU).length,
            totalVotes: results.length,
            weightedAgreement: parseFloat((weightedYes / totalWeight).toFixed(2))
        },
        interpretation: interpretation
    };
}

function detectInvertedUQuadratic(sleepStudy) {
    if (!sleepStudy.data || sleepStudy.data.length < 7) {
        return { isInvertedU: false, confidence: 0 };
    }

    const points = sleepStudy.data.map(d => ({ x: d.sleep, y: d.study })).sort((a, b) => a.x - b.x);
    const n = points.length;
    
    let sumX = 0, sumX2 = 0, sumX3 = 0, sumX4 = 0;
    let sumY = 0, sumXY = 0, sumX2Y = 0;

    points.forEach(p => {
        const x = p.x, x2 = x * x;
        sumX += x;
        sumX2 += x2;
        sumX3 += x2 * x;
        sumX4 += x2 * x2;
        sumY += p.y;
        sumXY += x * p.y;
        sumX2Y += x2 * p.y;
    });

    const Sxx = sumX2 - (sumX * sumX) / n;
    const Sxy = sumXY - (sumX * sumY) / n;
    const Sxx2 = sumX3 - (sumX * sumX2) / n;
    const Sx2x2 = sumX4 - (sumX2 * sumX2) / n;
    const Sx2y = sumX2Y - (sumX2 * sumY) / n;

    const denominator = Sxx * Sx2x2 - Sxx2 * Sxx2;
    if (Math.abs(denominator) < 1e-10) {
        return { isInvertedU: false, confidence: 0 };
    }

    const a = (Sx2y * Sxx - Sxy * Sxx2) / denominator;
    const b = (Sxy * Sx2x2 - Sx2y * Sxx2) / denominator;
    const c = (sumY - b * sumX - a * sumX2) / n;

    const isConcave = a < -0.01;
    if (!isConcave) return { isInvertedU: false, confidence: 0 };

    const peakX = -b / (2 * a);
    const peakY = a * peakX * peakX + b * peakX + c;

    const yMean = sumY / n;
    let SST = 0, SSE = 0;
    points.forEach(p => {
        const yPred = a * p.x * p.x + b * p.x + c;
        SST += Math.pow(p.y - yMean, 2);
        SSE += Math.pow(p.y - yPred, 2);
    });

    const rSquared = 1 - (SSE / SST);
    const xValues = points.map(p => p.x);
    const withinRange = peakX >= Math.min(...xValues) && peakX <= Math.max(...xValues);

    const confidence = Math.min(100, Math.max(0,
        rSquared * 40 +
        (Math.abs(a) > 0.05 ? 30 : 0) +
        (withinRange ? 30 : 0)
    ));

    return {
        isInvertedU: true,
        confidence: Math.round(confidence),
        peak: { sleepHours: peakX, studyHours: peakY },
        coefficients: { a, b, c },
        rSquared: rSquared,
        vertexWithinRange: withinRange
    };
}

function detectInvertedUPiecewise(sleepStudy) {
    if (!sleepStudy.data || sleepStudy.data.length < 10) {
        return { isInvertedU: false, confidence: 0 };
    }

    const points = sleepStudy.data.map(d => ({ x: d.sleep, y: d.study })).sort((a, b) => a.x - b.x);
    
    let bestBreakpoint = null;
    let bestRSquared = -Infinity;

    for (let i = 3; i < points.length - 3; i++) {
        const left = points.slice(0, i);
        const right = points.slice(i);
        
        const leftFit = linearRegression(left);
        const rightFit = linearRegression(right);
        
        const totalRSquared = (leftFit.rSquared * left.length + rightFit.rSquared * right.length) / points.length;
        
        if (totalRSquared > bestRSquared) {
            bestRSquared = totalRSquared;
            bestBreakpoint = {
                index: i,
                x: points[i].x,
                leftSlope: leftFit.slope,
                rightSlope: rightFit.slope,
                leftRSquared: leftFit.rSquared,
                rightRSquared: rightFit.rSquared
            };
        }
    }

    if (!bestBreakpoint) return { isInvertedU: false, confidence: 0 };

    const isInvertedU = bestBreakpoint.leftSlope > 0.1 && bestBreakpoint.rightSlope < -0.1;
    const slopeDiff = Math.abs(bestBreakpoint.leftSlope - bestBreakpoint.rightSlope);
    const confidence = Math.min(100, Math.max(0, bestRSquared * 40 + slopeDiff * 100 + (isInvertedU ? 20 : 0)));

    return {
        isInvertedU: isInvertedU,
        confidence: Math.round(confidence),
        peak: { sleepHours: bestBreakpoint.x },
        breakpoint: bestBreakpoint,
        rSquared: bestRSquared
    };
}

function detectInvertedUSimple(sleepStudy) {
    if (!sleepStudy.data || sleepStudy.data.length < 7) {
        return { isInvertedU: false, confidence: 0 };
    }

    const sorted = [...sleepStudy.data].sort((a, b) => a.sleep - b.sleep);
    const third = Math.floor(sorted.length / 3);
    
    const lowSleep = sorted.slice(0, third);
    const midSleep = sorted.slice(third, third * 2);
    const highSleep = sorted.slice(third * 2);

    if (lowSleep.length === 0 || midSleep.length === 0 || highSleep.length === 0) {
        return { isInvertedU: false, confidence: 0 };
    }

    const avgLow = lowSleep.reduce((sum, d) => sum + d.study, 0) / lowSleep.length;
    const avgMid = midSleep.reduce((sum, d) => sum + d.study, 0) / midSleep.length;
    const avgHigh = highSleep.reduce((sum, d) => sum + d.study, 0) / highSleep.length;

    const isInvertedU = avgMid > avgLow && avgMid > avgHigh;
    const lowToMid = ((avgMid - avgLow) / avgLow) * 100;
    const midToHigh = ((avgHigh - avgMid) / avgMid) * 100;
    const confidence = Math.min(100, Math.max(0, (Math.abs(lowToMid) + Math.abs(midToHigh)) / 2));

    return {
        isInvertedU: isInvertedU,
        confidence: Math.round(confidence),
        peak: { sleepHours: midSleep[Math.floor(midSleep.length/2)]?.sleep },
        averages: { low: avgLow, mid: avgMid, high: avgHigh }
    };
}

function linearRegression(points) {
    const n = points.length;
    const sumX = points.reduce((sum, p) => sum + p.x, 0);
    const sumY = points.reduce((sum, p) => sum + p.y, 0);
    const sumXY = points.reduce((sum, p) => sum + p.x * p.y, 0);
    const sumX2 = points.reduce((sum, p) => sum + p.x * p.x, 0);
    
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    
    const yMean = sumY / n;
    let SST = 0, SSE = 0;
    points.forEach(p => {
        const yPred = slope * p.x + intercept;
        SST += Math.pow(p.y - yMean, 2);
        SSE += Math.pow(p.y - yPred, 2);
    });
    
    const rSquared = SST === 0 ? 0 : 1 - (SSE / SST);
    return { slope, intercept, rSquared };
}

function getEmptyResult(reason, data = []) {
    return {
        correlation: 0,
        sleepData: data.map(d => d.sleep) || [],
        studyData: data.map(d => d.study) || [],
        data: data,
        matchedDays: data.length,
        isValid: false,
        reason: reason
    };
}

function calculateCorrelation(x, y) {
    if (x.length !== y.length || x.length === 0) return 0;
    
    const n = x.length;
    const sumX = x.reduce((a, b) => a + b, 0);
    const sumY = y.reduce((a, b) => a + b, 0);
    const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
    const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
    const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
    
    const numerator = n * sumXY - sumX * sumY;
    const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
    
    if (denominator === 0) return 0;
    return numerator / denominator;
}





function detectOptimalSleepRange(data) {
    if (!data || !data.data || data.data.length < 5) return false;
    
    try {

        const ranges = {
            '4-5': [],
            '5-6': [],
            '6-7': [],
            '7-8': [],
            '8-9': [],
            '9-10': [],
            '10+': []
        };
        
        data.data.forEach(d => {
            const sleep = d.sleep;
            if (sleep >= 4 && sleep < 5) ranges['4-5'].push(d.study);
            else if (sleep >= 5 && sleep < 6) ranges['5-6'].push(d.study);
            else if (sleep >= 6 && sleep < 7) ranges['6-7'].push(d.study);
            else if (sleep >= 7 && sleep < 8) ranges['7-8'].push(d.study);
            else if (sleep >= 8 && sleep < 9) ranges['8-9'].push(d.study);
            else if (sleep >= 9 && sleep < 10) ranges['9-10'].push(d.study);
            else if (sleep >= 10) ranges['10+'].push(d.study);
        });

        const rangeAverages = {};
        Object.entries(ranges).forEach(([range, studies]) => {
            if (studies.length > 0) {
                rangeAverages[range] = studies.reduce((a, b) => a + b, 0) / studies.length;
            }
        });
        
        const values = Object.values(rangeAverages);
        if (values.length < 3) return false;
        
        const maxAvg = Math.max(...values);
        const minAvg = Math.min(...values);

        return (maxAvg - minAvg) / minAvg > 0.2;
    } catch (error) {
        console.error('Error in detectOptimalSleepRange:', error);
        return false;
    }
}

function detectInvertedURelationship(data) {
    if (!data || !data.data || data.data.length < 7) return false;
    
    try {

        const sorted = [...data.data].sort((a, b) => a.sleep - b.sleep);

        const third = Math.floor(sorted.length / 3);
        const lowSleep = sorted.slice(0, third);
        const midSleep = sorted.slice(third, third * 2);
        const highSleep = sorted.slice(third * 2);
        
        const avgLow = lowSleep.reduce((sum, d) => sum + d.study, 0) / lowSleep.length;
        const avgMid = midSleep.reduce((sum, d) => sum + d.study, 0) / midSleep.length;
        const avgHigh = highSleep.reduce((sum, d) => sum + d.study, 0) / highSleep.length;

        return avgMid > avgLow && avgMid > avgHigh && 
               (avgMid - avgLow) / avgLow > 0.1 && 
               (avgMid - avgHigh) / avgHigh > 0.1;
    } catch (error) {
        console.error('Error in detectInvertedURelationship:', error);
        return false;
    }
}

function calculateSleepImpactOnStudy(data) {
    if (!data || !data.correlation) return 'unknown';
    
    try {
        const r = Math.abs(data.correlation);
        const n = data.matchedDays || 0;
        
        if (n < 3) return 'unknown';

        const rSquared = r * r;
        
        if (rSquared >= 0.49) return 'strong'; 
        if (rSquared >= 0.25) return 'moderate'; 
        if (rSquared >= 0.09) return 'weak'; 
        return 'very_weak'; // <9%
    } catch (error) {
        console.error('Error in calculateSleepImpactOnStudy:', error);
        return 'error';
    }
}

function calculateAverageCompletionTime(completedGoals) {
    if (!completedGoals || completedGoals.length === 0) return 'N/A';
    
    try {
        const times = completedGoals
            .filter(g => g.createdAt && g.completedAt)
            .map(g => {
                const created = new Date(g.createdAt).getTime();
                const completed = new Date(g.completedAt).getTime();
                return (completed - created) / (1000 * 60 * 60 * 24); 
            })
            .filter(t => t > 0 && t < 365); 
        
        if (times.length === 0) return 'N/A';
        
        const avgDays = times.reduce((a, b) => a + b, 0) / times.length;
        
        if (avgDays < 7) return `${Math.round(avgDays)} days`;
        if (avgDays < 30) return `${Math.round(avgDays / 7)} weeks`;
        return `${Math.round(avgDays / 30)} months`;
    } catch (error) {
        console.error('Error in calculateAverageCompletionTime:', error);
        return 'Error';
    }
}

function calculateSuccessRateByType(goals) {
    if (!goals || goals.length === 0) return {};
    
    try {
        const types = {};
        
        goals.forEach(goal => {
            const type = goal.type || 'unknown';
            if (!types[type]) {
                types[type] = { total: 0, completed: 0 };
            }
            types[type].total++;
            if (goal.status === 'completed') {
                types[type].completed++;
            }
        });
        
        const rates = {};
        Object.entries(types).forEach(([type, data]) => {
            const rate = data.total > 0 ? 
                (data.completed / data.total) * 100 : 0;
            rates[type] = `${Math.round(rate)}%`;
        });
        
        return rates;
    } catch (error) {
        console.error('Error in calculateSuccessRateByType:', error);
        return {};
    }
}

function getGoalDifficulty(goal) {
    if (!goal) return 'unknown';
    
    try {
        const target = goal.target || 0;
        const duration = goal.duration || 0; 
        const complexity = goal.complexity || 'medium';

        const dailyRequirement = duration > 0 ? target / duration : target;

        let score = 0;

        if (target < 50) score += 1;
        else if (target < 100) score += 2;
        else if (target < 200) score += 3;
        else score += 4;

        if (duration > 180) score += 1; 
        else if (duration > 90) score += 2;
        else if (duration > 30) score += 3;
        else score += 4; 

        if (complexity === 'easy') score += 1;
        else if (complexity === 'medium') score += 2;
        else if (complexity === 'hard') score += 3;

        if (score <= 4) return 'easy';
        if (score <= 7) return 'medium';
        return 'hard';
    } catch (error) {
        console.error('Error in getGoalDifficulty:', error);
        return 'unknown';
    }
}

function analyzeDifficultyBias(goals) {
    if (!goals || goals.length === 0) return 'unknown';
    
    try {
        const difficulties = {
            easy: 0,
            medium: 0,
            hard: 0,
            unknown: 0
        };
        
        goals.forEach(goal => {
            const difficulty = getGoalDifficulty(goal);
            difficulties[difficulty] = (difficulties[difficulty] || 0) + 1;
        });
        
        const total = goals.length;
        const max = Math.max(difficulties.easy, difficulties.medium, difficulties.hard);
        const maxPercent = (max / total) * 100;

        if (maxPercent <= 50) return 'balanced';

        if (difficulties.easy === max) return 'easy-biased';
        if (difficulties.hard === max) return 'hard-biased';
        return 'medium-biased';
    } catch (error) {
        console.error('Error in analyzeDifficultyBias:', error);
        return 'error';
    }
}

function calculateSuccessByDifficulty(goals) {
    if (!goals || goals.length === 0) return {};
    
    try {
        const difficultyStats = {
            easy: { total: 0, completed: 0 },
            medium: { total: 0, completed: 0 },
            hard: { total: 0, completed: 0 }
        };
        
        goals.forEach(goal => {
            const difficulty = getGoalDifficulty(goal);
            if (difficultyStats[difficulty]) {
                difficultyStats[difficulty].total++;
                if (goal.status === 'completed') {
                    difficultyStats[difficulty].completed++;
                }
            }
        });
        
        const rates = {};
        Object.entries(difficultyStats).forEach(([difficulty, stats]) => {
            const rate = stats.total > 0 ? 
                (stats.completed / stats.total) * 100 : 0;
            rates[difficulty] = `${Math.round(rate)}%`;
        });
        
        return rates;
    } catch (error) {
        console.error('Error in calculateSuccessByDifficulty:', error);
        return {};
    }
}

function calculateProductivityTrend(hours) {
    if (!hours || hours.length < 7) return 'insufficient_data';
    
    try {
        const validHours = hours.filter(h => !isNaN(h) && h >= 0);
        if (validHours.length < 7) return 'insufficient_data';
        
        const n = validHours.length;
        const xSum = (n * (n + 1)) / 2; 
        const ySum = validHours.reduce((a, b) => a + b, 0);
        const xySum = validHours.reduce((sum, y, x) => sum + (x + 1) * y, 0);
        const xSquaredSum = (n * (n + 1) * (2 * n + 1)) / 6;
        
        const slope = (n * xySum - xSum * ySum) / (n * xSquaredSum - xSum * xSum);

        if (Math.abs(slope) < 0.1) return 'stable';
        if (slope > 0.5) return 'rapidly_increasing';
        if (slope > 0.2) return 'increasing';
        if (slope < -0.5) return 'rapidly_decreasing';
        if (slope < -0.2) return 'decreasing';
        return 'stable';
    } catch (error) {
        console.error('Error in calculateProductivityTrend:', error);
        return 'error';
    }
}

function calculateStudyToSleepRatio() {
    if (!dailyStudyData || !sleepSessions) {
        return 0;
    }
    
    try {
        const studyHours = Object.values(dailyStudyData)
            .reduce((sum, h) => sum + (parseFloat(h) || 0), 0);
        
        const sleepHours = sleepSessions
            .reduce((sum, s) => sum + (parseFloat(s.duration) || 0), 0);
        
        if (sleepHours === 0) return 0;
        
        return parseFloat((studyHours / sleepHours).toFixed(2));
    } catch (error) {
        console.error('Error in calculateStudyToSleepRatio:', error);
        return 0;
    }
}

function calculateProductiveHours() {
    if (!dailyStudyData) return 0;
    
    try {
        return Object.values(dailyStudyData)
            .reduce((sum, h) => sum + (parseFloat(h) || 0), 0);
    } catch (error) {
        console.error('Error in calculateProductiveHours:', error);
        return 0;
    }
}

function detectPeakProductivityTimes() {
    if (!sessionLogs || sessionLogs.length === 0) {
        return [];
    }
    
    try {
        const periods = {
            'Early Morning': 0,   // 5-8
            'Morning': 0,         // 8-12
            'Afternoon': 0,       // 12-17
            'Evening': 0,         // 17-21
            'Night': 0            // 21-24
        };
        
        sessionLogs.forEach(log => {
            const hour = new Date(log.timestamp).getHours();
            const duration = log.duration || 0;
            
            if (hour >= 5 && hour < 8) periods['Early Morning'] += duration;
            else if (hour >= 8 && hour < 12) periods['Morning'] += duration;
            else if (hour >= 12 && hour < 17) periods['Afternoon'] += duration;
            else if (hour >= 17 && hour < 21) periods['Evening'] += duration;
            else periods['Night'] += duration;
        });

        const sorted = Object.entries(periods)
            .filter(([, hours]) => hours > 0)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 2)
            .map(([period]) => period);
        
        return sorted.length > 0 ? sorted : ['Unknown'];
    } catch (error) {
        console.error('Error in detectPeakProductivityTimes:', error);
        return ['Error'];
    }
}

function calculateAverageSessionLength() {
    if (!sessionLogs || sessionLogs.length === 0) return 0;
    
    try {
        const total = sessionLogs.reduce((sum, s) => sum + (s.duration || 0), 0);
        return parseFloat((total / sessionLogs.length).toFixed(1));
    } catch (error) {
        console.error('Error in calculateAverageSessionLength:', error);
        return 0;
    }
}

function countDeepWorkSessions() {
    if (!sessionLogs || sessionLogs.length === 0) return 0;
    
    try {
        return sessionLogs.filter(s => (s.duration || 0) >= 2).length;
    } catch (error) {
        console.error('Error in countDeepWorkSessions:', error);
        return 0;
    }
}

function assessBurnoutRisk() {
    try {
        const factors = {
            highStudyHours: 0,
            lowSleepQuality: 0,
            inconsistentSchedule: 0,
            noBreaks: 0
        };
        
        let riskScore = 0;
        
        if (dailyStudyData) {
            const recentDays = Object.keys(dailyStudyData)
                .sort()
                .slice(-7);
            
            const recentHours = recentDays.map(d => dailyStudyData[d] || 0);
            const avgRecent = recentHours.reduce((a, b) => a + b, 0) / recentHours.length;
            
            if (avgRecent > 12) {
                factors.highStudyHours = 2;
                riskScore += 2;
            } else if (avgRecent > 10) {
                factors.highStudyHours = 1;
                riskScore += 1;
            }
        }
        
        if (sleepSessions && sleepSessions.length >= 7) {
            const recentSleep = sleepSessions.slice(-7);
            const avgSleep = recentSleep.reduce((sum, s) => sum + (s.duration || 0), 0) / recentSleep.length;
            const consistency = calculateConsistencyScore(recentSleep.map(s => s.duration || 0));
            
            if (avgSleep < 6 || consistency < 50) {
                factors.lowSleepQuality = 2;
                riskScore += 2;
            } else if (avgSleep < 7 || consistency < 70) {
                factors.lowSleepQuality = 1;
                riskScore += 1;
            }
        }
        
        if (dailyStudyData) {
            const days = Object.keys(dailyStudyData);
            const hours = Object.values(dailyStudyData);
            
            if (days.length >= 7) {
                const consistency = calculateStudyConsistencyScore(hours);
                
                if (consistency < 50) {
                    factors.inconsistentSchedule = 1;
                    riskScore += 1;
                }
            }
        }
        
        if (dailyStudyData) {
            const recentDays = Object.keys(dailyStudyData)
                .sort()
                .slice(-7);
            
            const hasBreakDay = recentDays.some(d => (dailyStudyData[d] || 0) < 2);
            
            if (!hasBreakDay) {
                factors.noBreaks = 1;
                riskScore += 1;
            }
        }

        let riskLevel = 'low';
        if (riskScore >= 5) riskLevel = 'critical';
        else if (riskScore >= 4) riskLevel = 'high';
        else if (riskScore >= 2) riskLevel = 'medium';
        
        return {
            level: riskLevel,
            score: riskScore,
            maxScore: 6,
            factors: factors,
            recommendations: generateBurnoutRecommendations(riskLevel, factors)
        };
    } catch (error) {
        console.error('Error in assessBurnoutRisk:', error);
        return {
            level: 'unknown',
            score: 0,
            factors: {}
        };
    }
}

function generateBurnoutRecommendations(riskLevel, factors) {
    const recommendations = [];
    
    if (factors.highStudyHours >= 1) {
        recommendations.push('Reduce daily study hours to 8-10h maximum');
    }
    
    if (factors.lowSleepQuality >= 1) {
        recommendations.push('Prioritize consistent 7-8h sleep schedule');
    }
    
    if (factors.inconsistentSchedule >= 1) {
        recommendations.push('Establish regular study routine');
    }
    
    if (factors.noBreaks >= 1) {
        recommendations.push('Schedule at least 1 light day per week');
    }
    
    if (riskLevel === 'critical' || riskLevel === 'high') {
        recommendations.push('Consider taking a 2-3 day recovery break');
    }
    
    return recommendations;
}

function identifyTimeWasters() {
    const wasters = [];
    
    try {

        if (sleepSessions && sleepSessions.length >= 7) {
            const durations = sleepSessions.slice(-7).map(s => s.duration || 0);
            const consistency = calculateConsistencyScore(durations);
            
            if (consistency < 60) {
                const hoursLost = calculateStandardDeviation(durations) * durations.length;
                wasters.push({
                    type: 'Inconsistent sleep schedule',
                    impact: `~${hoursLost.toFixed(1)}h lost due to sleep irregularity`,
                    severity: 'medium'
                });
            }
        }

        if (dailyStudyData) {
            const days = Object.keys(dailyStudyData).sort();
            const missedDays = calculateMissedStudyDays(days);
            
            if (missedDays > 2) {
                wasters.push({
                    type: 'Missed study days',
                    impact: `${missedDays} days with no tracked study time`,
                    severity: 'high'
                });
            }
        }

        if (sessionLogs && sessionLogs.length >= 5) {
            const shortSessions = sessionLogs.filter(s => (s.duration || 0) < 0.5);
            const shortPercent = (shortSessions.length / sessionLogs.length) * 100;
            
            if (shortPercent > 20) {
                wasters.push({
                    type: 'Too many short sessions',
                    impact: `${shortPercent.toFixed(0)}% of sessions under 30 minutes`,
                    severity: 'medium'
                });
            }
        }
        
        return wasters;
    } catch (error) {
        console.error('Error in identifyTimeWasters:', error);
        return [];
    }
}

function calculateOptimizationPotential() {
    try {
        let potential = 0;
        const factors = [];
        if (sleepSessions && sleepSessions.length >= 7) {
            const durations = sleepSessions.slice(-7).map(s => s.duration || 0);
            const consistency = calculateConsistencyScore(durations);
            
            if (consistency < 70) {
                const gain = (70 - consistency) / 10;
                potential += gain;
                factors.push(`+${gain.toFixed(1)}% from sleep consistency`);
            }
        }

        if (dailyStudyData) {
            const hours = Object.values(dailyStudyData);
            const consistency = calculateStudyConsistencyScore(hours);
            
            if (consistency < 70) {
                const gain = (70 - consistency) / 10;
                potential += gain;
                factors.push(`+${gain.toFixed(1)}% from study consistency`);
            }
        }

        if (sessionLogs && sessionLogs.length >= 5) {
            const avgLength = calculateAverageSessionLength();
            
            if (avgLength < 2) {
                const gain = 5;
                potential += gain;
                factors.push(`+${gain}% from longer focus sessions`);
            }
        }
        
        return {
            percent: Math.round(potential),
            factors: factors,
            highPriority: potential > 20
        };
    } catch (error) {
        console.error('Error in calculateOptimizationPotential:', error);
        return {
            percent: 0,
            factors: [],
            highPriority: false
        };
    }
}

function calculateVariance(values) {
    if (!values || values.length === 0) return 0;
    
    try {
        const validValues = values.filter(v => !isNaN(v));
        if (validValues.length === 0) return 0;
        
        const avg = validValues.reduce((a, b) => a + b, 0) / validValues.length;
        const squareDiffs = validValues.map(v => Math.pow(v - avg, 2));
        return squareDiffs.reduce((a, b) => a + b, 0) / validValues.length;
    } catch (error) {
        console.error('Error in calculateVariance:', error);
        return 0;
    }
}

function calculateStandardDeviation(values) {
    return Math.sqrt(calculateVariance(values));
}

function calculateConsistencyScore(values) {
    if (!values || values.length < 2) return 0;
    
    try {
        const validValues = values.filter(v => !isNaN(v) && v >= 0);
        if (validValues.length < 2) return 0;
        
        const avg = validValues.reduce((a, b) => a + b, 0) / validValues.length;
        if (avg === 0) return 0;
        
        const stdDev = calculateStandardDeviation(validValues);
        const cv = (stdDev / avg) * 100; 
        return Math.max(0, Math.min(100, 100 - cv));
    } catch (error) {
        console.error('Error in calculateConsistencyScore:', error);
        return 0;
    }
}

function formatTimeFromDecimal(decimal) {
    try {
        const hours = Math.floor(decimal);
        const minutes = Math.round((decimal - hours) * 60);
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
    } catch (error) {
        return 'N/A';
    }
}

function detectCorrelationThreshold(data) {
    if (!data || !data.data || data.data.length < 5) return false;
    
    try {
        const sorted = [...data.data].sort((a, b) => a.sleep - b.sleep);

        const quartile = Math.floor(sorted.length / 4);
        const lowSleep = sorted.slice(0, quartile);
        const highSleep = sorted.slice(-quartile);
        
        const avgLowStudy = lowSleep.reduce((sum, d) => sum + d.study, 0) / lowSleep.length;
        const avgHighStudy = highSleep.reduce((sum, d) => sum + d.study, 0) / highSleep.length;
        
        const difference = Math.abs(avgHighStudy - avgLowStudy) / Math.min(avgLowStudy, avgHighStudy);
        
        return difference > 0.3; 
    } catch (error) {
        console.error('Error in detectCorrelationThreshold:', error);
        return false;
    }
}

function checkLinearRelationship(data) {
    if (!data || !data.correlation) return false;
    
    try {
        const r = Math.abs(data.correlation);
        return r >= 0.3;
    } catch (error) {
        console.error('Error in checkLinearRelationship:', error);
        return false;
    }
}

function calculateStudyImpactOnSleep(correlationData) {
    if (!correlationData || !correlationData.data || correlationData.data.length < 2) {
        return 'unknown';
    }
    
    try {
        const r = Math.abs(correlationData.correlation || 0);
        if (r < 0.2) return 'very low';
        if (r < 0.4) return 'low';
        if (r < 0.6) return 'moderate';
        if (r < 0.8) return 'high';
        return 'very high';
    } catch (error) {
        console.error('Error in calculateStudyImpactOnSleep:', error);
        return 'error';
    }
}

function calculateMarginalReturns(data) {
    if (!data || !data.data || data.data.length < 5) return 'unknown';
    
    try {
        const sorted = [...data.data].sort((a, b) => a.study - b.study);
        const quartile = Math.floor(sorted.length / 4);
        
        const lowStudy = sorted.slice(0, quartile);
        const highStudy = sorted.slice(-quartile);
        
        const avgLowSleep = lowStudy.reduce((sum, d) => sum + d.sleep, 0) / lowStudy.length;
        const avgHighSleep = highStudy.reduce((sum, d) => sum + d.sleep, 0) / highStudy.length;
        
        const studyDiff = highStudy[0]?.study - lowStudy[0]?.study || 0;
        const sleepDiff = avgHighSleep - avgLowSleep;
        
        if (studyDiff === 0) return 'unknown';
        const returnRatio = sleepDiff / studyDiff;
        
        if (returnRatio > 0.5) return 'increasing';
        if (returnRatio > 0.2) return 'steady';
        if (returnRatio > 0) return 'diminishing';
        return 'negative';
    } catch (error) {
        console.error('Error in calculateMarginalReturns:', error);
        return 'error';
    }
}

function findCrossoverPoints(data) {
    if (!data || !data.data || data.data.length < 10) return [];
    
    try {
        const sorted = [...data.data].sort((a, b) => a.sleep - b.sleep);
        const points = [];
        
        for (let i = 1; i < sorted.length - 1; i++) {
            const prev = sorted[i - 1];
            const curr = sorted[i];
            const next = sorted[i + 1];

            if (curr.study > prev.study && curr.study > next.study) {
                points.push(`${curr.sleep.toFixed(1)}h`);
            }
        }
        
        return points.slice(0, 2); 
    } catch (error) {
        console.error('Error in findCrossoverPoints:', error);
        return [];
    }
}

function detectStudyThresholds(data) {
    if (!data || !data.data || data.data.length < 5) {
        return { minimum: 0, optimal: 0, maximum: 0 };
    }
    
    try {
        const sorted = [...data.data].sort((a, b) => a.sleep - b.study);
        const studyValues = sorted.map(d => d.study);
        
        const min = Math.min(...studyValues);
        const max = Math.max(...studyValues);
        
        const avg = studyValues.reduce((sum, val) => sum + val, 0) / studyValues.length;
        
        return {
            minimum: parseFloat(min.toFixed(1)),
            optimal: parseFloat(avg.toFixed(1)),
            maximum: parseFloat(max.toFixed(1))
        };
    } catch (error) {
        console.error('Error in detectStudyThresholds:', error);
        return { minimum: 0, optimal: 0, maximum: 0 };
    }
}

function detectDiminishingReturns(data) {
    if (!data || !data.data || data.data.length < 7) return 'unknown';
    
    try {
        const sorted = [...data.data].sort((a, b) => a.study - b.study);
        
        const lowerHalf = sorted.slice(0, Math.floor(sorted.length / 2));
        const upperHalf = sorted.slice(Math.floor(sorted.length / 2));
        
        const avgSleepLower = lowerHalf.reduce((sum, d) => sum + d.sleep, 0) / lowerHalf.length;
        const avgSleepUpper = upperHalf.reduce((sum, d) => sum + d.sleep, 0) / upperHalf.length;
        
        const studyDiff = upperHalf[0]?.study - lowerHalf[0]?.study || 1;
        const sleepDiff = avgSleepUpper - avgSleepLower;
        
        const returnRatio = sleepDiff / studyDiff;
        
        if (returnRatio < 0) return 'negative after any study';
        if (returnRatio < 0.1) return 'diminishing after moderate study';
        if (returnRatio < 0.3) return 'diminishing after high study';
        return 'consistent';
    } catch (error) {
        console.error('Error in detectDiminishingReturns:', error);
        return 'error';
    }
}

function findOptimalCombinations(data) {
    if (!data || !data.data || data.data.length < 5) return [];
    
    try {
        const combinations = [];
        const avgSleep = data.data.reduce((sum, d) => sum + d.sleep, 0) / data.data.length;
        const avgStudy = data.data.reduce((sum, d) => sum + d.study, 0) / data.data.length;
        
        const optimalPoints = data.data.filter(d => 
            d.sleep >= avgSleep && d.study >= avgStudy
        );
        
        if (optimalPoints.length > 0) {
            const point = optimalPoints[0];
            combinations.push(`${point.sleep.toFixed(1)}h sleep + ${point.study.toFixed(1)}h study`);
        }
        
        return combinations;
    } catch (error) {
        console.error('Error in findOptimalCombinations:', error);
        return [];
    }
}

function calculateSkillGoalAlignment() {
    try {
        return 75;
    } catch (error) {
        console.error('Error in calculateSkillGoalAlignment:', error);
        return 0;
    }
}

function analyzeCareerFocus(goals) {
    if (!goals || goals.length === 0) return 'general';
    
    try {
        const categories = {};
        goals.forEach(goal => {
            const category = goal.category || 'other';
            categories[category] = (categories[category] || 0) + 1;
        });
        
        const maxCategory = Object.entries(categories)
            .sort(([,a], [,b]) => b - a)[0]?.[0] || 'general';
        
        return `${maxCategory}-focused`;
    } catch (error) {
        console.error('Error in analyzeCareerFocus:', error);
        return 'unknown';
    }
}

function detectGoalInterdependencies(goals) {
    if (!goals || goals.length < 2) return [];
    
    try {
        const dependencies = [];
        goals.forEach((goal, i) => {
            goals.slice(i + 1).forEach(otherGoal => {
                if (goal.prerequisites?.includes(otherGoal.id) || 
                    otherGoal.prerequisites?.includes(goal.id)) {
                    dependencies.push({
                        goal1: goal.title || goal.id,
                        goal2: otherGoal.title || otherGoal.id,
                        type: 'prerequisite'
                    });
                }
            });
        });
        
        return dependencies.slice(0, 5); 
    } catch (error) {
        console.error('Error in detectGoalInterdependencies:', error);
        return [];
    }
}

function analyzePriorityDistribution(goals) {
    if (!goals || goals.length === 0) return { high: 0, medium: 0, low: 0 };
    
    try {
        const distribution = { high: 0, medium: 0, low: 0 };
        
        goals.forEach(goal => {
            const priority = goal.priority || 'medium';
            if (distribution[priority] !== undefined) {
                distribution[priority]++;
            }
        });
        
        return distribution;
    } catch (error) {
        console.error('Error in analyzePriorityDistribution:', error);
        return { high: 0, medium: 0, low: 0 };
    }
}

function analyzeEfficiencyTrend() {
    try {
        return 'stable';
    } catch (error) {
        console.error('Error in analyzeEfficiencyTrend:', error);
        return 'unknown';
    }
}

function estimateDistractionFrequency() {
    try {
        return 'low';
    } catch (error) {
        console.error('Error in estimateDistractionFrequency:', error);
        return 'unknown';
    }
}

function calculateFocusConsistency() {
    try {
        return 75;
    } catch (error) {
        console.error('Error in calculateFocusConsistency:', error);
        return 0;
    }
}

function identifyQuickWins() {
    try {
        return 3;
    } catch (error) {
        console.error('Error in identifyQuickWins:', error);
        return 0;
    }
}

function suggestSystemicImprovements() {
    try {
        return ['Consistent sleep schedule', 'Daily study routine'];
    } catch (error) {
        console.error('Error in suggestSystemicImprovements:', error);
        return [];
    }
}

function calculateSustainabilityScore() {
    try {
        return 75;
    } catch (error) {
        console.error('Error in calculateSustainabilityScore:', error);
        return 0;
    }
}

function calculateConfidenceInterval(r, n, confidence = 0.95) {
    const z = 1.96; 
    const se = 1 / Math.sqrt(n - 3);
    const lower = Math.tanh(Math.atanh(r) - z * se);
    const upper = Math.tanh(Math.atanh(r) + z * se);
    return [lower, upper];
}

function calculatePValue(r, n) {
    const t = r * Math.sqrt((n - 2) / (1 - r * r));
    return pValue;
}

// ====== INVERTED-U DETECTION ENSEMBLE ======

function detectInvertedURelationship(data) {
    if (!data || !data.data || data.data.length < 8) {
        return {
            isInvertedU: false,
            confidence: 0,
            reason: 'Insufficient data (need at least 8 points)',
            method: 'none'
        };
    }
    
    try {
        // 1. Quadratic Regression Method
        const quadraticResult = detectInvertedUQuadratic(data);
        
        // 2. Piecewise Linear Method  
        const piecewiseResult = detectInvertedUPiecewise(data);
        
        // 3. Simple Method (original)
        const simpleResult = detectInvertedUSimple(data);
        
        // Ensemble Voting vá»i weights
        const results = [
            { method: 'quadratic', ...quadraticResult, weight: 0.5 },
            { method: 'piecewise', ...piecewiseResult, weight: 0.3 },
            { method: 'simple', ...simpleResult, weight: 0.2 }
        ];
        
        // Weighted voting
        let weightedYes = 0;
        let totalWeight = 0;
        let avgConfidence = 0;
        
        results.forEach(r => {
            if (r.isInvertedU) {
                weightedYes += r.weight;
            }
            totalWeight += r.weight;
            avgConfidence += (r.confidence || 0) * r.weight;
        });
        
        const finalIsInvertedU = weightedYes / totalWeight >= 0.5;
        const finalConfidence = avgConfidence / totalWeight;
        
        // TÃ¬m phÆ°Æ¡ng phÃ¡p cÃ³ confidence cao nháº¥t
        const bestMethod = results.reduce((best, current) => 
            (current.confidence || 0) > (best.confidence || 0) ? current : best
        );
        
        return {
            isInvertedU: finalIsInvertedU,
            confidence: Math.round(finalConfidence),
            peak: bestMethod.peak || null,
            methods: {
                quadratic: {
                    isInvertedU: quadraticResult.isInvertedU,
                    confidence: quadraticResult.confidence,
                    peak: quadraticResult.peak
                },
                piecewise: {
                    isInvertedU: piecewiseResult.isInvertedU,
                    confidence: piecewiseResult.confidence,
                    peak: piecewiseResult.peak
                },
                simple: {
                    isInvertedU: simpleResult.isInvertedU,
                    confidence: simpleResult.confidence,
                    peak: simpleResult.peak
                }
            },
            agreement: {
                yesVotes: results.filter(r => r.isInvertedU).length,
                totalVotes: results.length,
                weightedAgreement: parseFloat((weightedYes / totalWeight).toFixed(2))
            },
            interpretation: generateInvertedUInterpretation(finalIsInvertedU, finalConfidence, bestMethod)
        };
        
    } catch (error) {
        console.error('Error in Inverted-U detection:', error);
        return {
            isInvertedU: false,
            confidence: 0,
            error: error.message
        };
    }
}

// ====== 1. QUADRATIC REGRESSION METHOD ======

function detectInvertedUQuadratic(data) {
    if (!data.data || data.data.length < 7) {
        return { isInvertedU: false, confidence: 0, reason: 'Need at least 7 points' };
    }
    
    try {
        const points = data.data.map(d => ({ x: d.sleep, y: d.study }))
            .sort((a, b) => a.x - b.x);
        
        // Fit quadratic: y = axÂ² + bx + c
        const n = points.length;
        let sumX = 0, sumX2 = 0, sumX3 = 0, sumX4 = 0;
        let sumY = 0, sumXY = 0, sumX2Y = 0;
        
        points.forEach(p => {
            const x = p.x, x2 = x * x;
            sumX += x;
            sumX2 += x2;
            sumX3 += x2 * x;
            sumX4 += x2 * x2;
            sumY += p.y;
            sumXY += x * p.y;
            sumX2Y += x2 * p.y;
        });
        
        // Solve for a, b, c
        const Sxx = sumX2 - (sumX * sumX) / n;
        const Sxy = sumXY - (sumX * sumY) / n;
        const Sxx2 = sumX3 - (sumX * sumX2) / n;
        const Sx2x2 = sumX4 - (sumX2 * sumX2) / n;
        const Sx2y = sumX2Y - (sumX2 * sumY) / n;
        
        const denominator = Sxx * Sx2x2 - Sxx2 * Sxx2;
        if (Math.abs(denominator) < 1e-10) {
            return { isInvertedU: false, confidence: 0, reason: 'Cannot solve quadratic' };
        }
        
        const a = (Sx2y * Sxx - Sxy * Sxx2) / denominator;
        const b = (Sxy * Sx2x2 - Sx2y * Sxx2) / denominator;
        const c = (sumY - b * sumX - a * sumX2) / n;
        
        // Check if concave (a < 0)
        const isConcave = a < -0.01; // Small threshold
        
        if (!isConcave) {
            return { 
                isInvertedU: false, 
                confidence: 0, 
                reason: 'Not concave (a = ' + a.toFixed(4) + ')' 
            };
        }
        
        // Find vertex (peak)
        const peakX = -b / (2 * a);
        const peakY = a * peakX * peakX + b * peakX + c;
        
        // Calculate RÂ²
        const yMean = sumY / n;
        let SST = 0, SSE = 0;
        points.forEach(p => {
            const yPred = a * p.x * p.x + b * p.x + c;
            SST += Math.pow(p.y - yMean, 2);
            SSE += Math.pow(p.y - yPred, 2);
        });
        
        const rSquared = 1 - (SSE / SST);
        
        // Check if peak is within data range
        const xValues = points.map(p => p.x);
        const withinRange = peakX >= Math.min(...xValues) && 
                           peakX <= Math.max(...xValues);
        
        // Calculate confidence
        const confidence = Math.min(100, Math.max(0,
            rSquared * 40 +
            (Math.abs(a) > 0.05 ? 30 : 0) +
            (withinRange ? 30 : 0)
        ));
        
        return {
            isInvertedU: true,
            confidence: Math.round(confidence),
            peak: { sleepHours: peakX, studyHours: peakY },
            coefficients: { a, b, c },
            rSquared: rSquared,
            vertexWithinRange: withinRange
        };
        
    } catch (error) {
        return { isInvertedU: false, confidence: 0, error: error.message };
    }
}

// ====== 2. PIECEWISE LINEAR METHOD ======

function detectInvertedUPiecewise(data) {
    if (!data.data || data.data.length < 10) {
        return { isInvertedU: false, confidence: 0, reason: 'Need at least 10 points' };
    }
    
    try {
        const points = data.data.map(d => ({ x: d.sleep, y: d.study }))
            .sort((a, b) => a.x - b.x);
        
        // Find optimal breakpoint
        let bestBreakpoint = null;
        let bestRSquared = -Infinity;
        
        // Try breakpoints from 3rd to n-3 point
        for (let i = 3; i < points.length - 3; i++) {
            const left = points.slice(0, i);
            const right = points.slice(i);
            
            const leftFit = linearRegression(left);
            const rightFit = linearRegression(right);
            
            const totalRSquared = (leftFit.rSquared * left.length + 
                                 rightFit.rSquared * right.length) / points.length;
            
            if (totalRSquared > bestRSquared) {
                bestRSquared = totalRSquared;
                bestBreakpoint = {
                    index: i,
                    x: points[i].x,
                    leftSlope: leftFit.slope,
                    rightSlope: rightFit.slope,
                    leftRSquared: leftFit.rSquared,
                    rightRSquared: rightFit.rSquared
                };
            }
        }
        
        if (!bestBreakpoint) {
            return { isInvertedU: false, confidence: 0 };
        }
        
        // Check Inverted-U pattern
        const isInvertedU = bestBreakpoint.leftSlope > 0.1 && 
                           bestBreakpoint.rightSlope < -0.1;
        
        // Calculate confidence
        const slopeDiff = Math.abs(bestBreakpoint.leftSlope - bestBreakpoint.rightSlope);
        const confidence = Math.min(100, Math.max(0,
            bestRSquared * 40 +
            slopeDiff * 100 +
            (isInvertedU ? 20 : 0)
        ));
        
        return {
            isInvertedU: isInvertedU,
            confidence: Math.round(confidence),
            peak: { sleepHours: bestBreakpoint.x },
            breakpoint: bestBreakpoint,
            rSquared: bestRSquared
        };
        
    } catch (error) {
        return { isInvertedU: false, confidence: 0, error: error.message };
    }
}

// ====== 3. SIMPLE METHOD (Original) ======

function detectInvertedUSimple(data) {
    if (!data.data || data.data.length < 7) {
        return { isInvertedU: false, confidence: 0 };
    }
    
    try {
        const sorted = [...data.data].sort((a, b) => a.sleep - b.sleep);
        const third = Math.floor(sorted.length / 3);
        
        const lowSleep = sorted.slice(0, third);
        const midSleep = sorted.slice(third, third * 2);
        const highSleep = sorted.slice(third * 2);
        
        const avgLow = lowSleep.reduce((sum, d) => sum + d.study, 0) / lowSleep.length;
        const avgMid = midSleep.reduce((sum, d) => sum + d.study, 0) / midSleep.length;
        const avgHigh = highSleep.reduce((sum, d) => sum + d.study, 0) / highSleep.length;
        
        const isInvertedU = avgMid > avgLow && avgMid > avgHigh;
        
        // Calculate improvement percentages
        const lowToMid = ((avgMid - avgLow) / avgLow) * 100;
        const midToHigh = ((avgHigh - avgMid) / avgMid) * 100;
        
        const confidence = Math.min(100, Math.max(0,
            (Math.abs(lowToMid) + Math.abs(midToHigh)) / 2
        ));
        
        return {
            isInvertedU: isInvertedU,
            confidence: Math.round(confidence),
            peak: { 
                sleepHours: midSleep[Math.floor(midSleep.length/2)]?.sleep 
            },
            averages: { low: avgLow, mid: avgMid, high: avgHigh }
        };
        
    } catch (error) {
        return { isInvertedU: false, confidence: 0 };
    }
}

// ====== HELPER FUNCTIONS ======


function generateInvertedUInterpretation(isInvertedU, confidence, bestMethod) {
    if (!isInvertedU) {
        if (confidence < 30) return "No clear Inverted-U pattern detected.";
        return "Insufficient evidence for Inverted-U relationship.";
    }
    
    const peak = bestMethod.peak;
    let interpretation = `Strong Inverted-U relationship detected (${confidence}% confidence). `;
    
    if (peak && peak.sleepHours) {
        interpretation += `Optimal sleep for study productivity: ${peak.sleepHours.toFixed(1)} hours. `;
        
        if (peak.sleepHours < 6) {
            interpretation += "Note: Optimal is below recommended 7-9h range.";
        } else if (peak.sleepHours > 9) {
            interpretation += "Note: Optimal is above typical 7-9h range.";
        } else {
            interpretation += "This aligns well with health recommendations.";
        }
    }
    
    interpretation += " Both insufficient and excessive sleep reduce study effectiveness.";
    
    return interpretation;
}


// ====== RENDER INVERTED-U INSIGHTS IN UI ======

function renderInvertedUInsights(invertedUAnalysis) {
    if (!invertedUAnalysis || !invertedUAnalysis.isInvertedU) {
        return `
            <div class="insight-card">
                <div class="insight-label">â° Inverted-U Analysis</div>
                <div class="insight-value">Not detected</div>
                <div class="insight-description">
                    No clear optimal sleep range found. More data needed.
                </div>
            </div>
        `;
    }
    
    const peak = invertedUAnalysis.peak;
    const confidence = invertedUAnalysis.confidence;
    
    let confidenceBadge = 'ð¢ Strong';
    if (confidence < 60) confidenceBadge = 'ð¡ Moderate';
    if (confidence < 40) confidenceBadge = 'ð´ Weak';
    
    return `
        <div class="insight-card inverted-u-insight">
            <div class="insight-label">
                â° Inverted-U Pattern Detected
                <span class="confidence-badge" style="background: ${getConfidenceColor(confidence)}">
                    ${confidence}% confidence
                </span>
            </div>
            <div class="insight-value">
                ${peak?.sleepHours ? peak.sleepHours.toFixed(1) + 'h' : 'N/A'}
                <div class="insight-subvalue">Optimal Sleep</div>
            </div>
            <div class="insight-description">
                ${invertedUAnalysis.interpretation || 'Study productivity peaks at this sleep duration, then declines.'}
                <div class="method-agreement">
                    Agreement: ${invertedUAnalysis.agreement?.yesVotes || 0}/${invertedUAnalysis.agreement?.totalVotes || 3} methods
                </div>
            </div>
        </div>
    `;
}

function getConfidenceColor(confidence) {
    if (confidence >= 80) return '#10b981';
    if (confidence >= 60) return '#f59e0b';
    return '#ef4444';
}

        

        function detectPatterns() {
            try {
                const patterns = {
                    sleepPatterns: detectSleepPatterns(),
                    studyPatterns: detectStudyPatterns(),
                    correlationPatterns: detectCorrelationPatterns(),
                    weeklyPatterns: detectWeeklyPatterns(),
                    goalPatterns: detectGoalPatterns(),
                    productivityPatterns: detectProductivityPatterns()
                };
                
                return {
                    ...patterns,
                    insights: generatePatternInsights(patterns),
                    recommendations: generatePatternRecommendations(patterns),
                    confidence: calculateConfidenceScores(patterns)
                };
            } catch (error) {
                console.error('Pattern detection failed:', error);
                return {
                    sleepPatterns: { error: error.message },
                    studyPatterns: { error: error.message },
                    correlationPatterns: { error: error.message },
                    weeklyPatterns: { error: error.message },
                    goalPatterns: { error: error.message },
                    productivityPatterns: { error: error.message },
                    insights: [],
                    recommendations: [],
                    confidence: 0,
                    hasError: true
                };
            }
        }

        function detectSleepPatterns() {
            if (sleepSessions.length < 5) return { insufficientData: true };
            
            const patterns = {
                consistency: {},
                quality: {},
                timing: {},
                anomalies: []
            };
            
            try {
                const durations = sleepSessions.map(s => s.duration);
                const avgDuration = durations.reduce((a, b) => a + b, 0) / durations.length;
                const minDuration = Math.min(...durations);
                const maxDuration = Math.max(...durations);
                
                patterns.consistency = {
                    avgDuration: parseFloat(avgDuration.toFixed(1)),
                    minDuration: parseFloat(minDuration.toFixed(1)),
                    maxDuration: parseFloat(maxDuration.toFixed(1)),
                    consistencyScore: calculateConsistencyScore(durations),
                    stdDev: calculateStandardDeviation(durations),
                    cv: (calculateStandardDeviation(durations) / avgDuration) * 100 
                };
                
                const bedtimes = sleepSessions.map(s => {
                    const start = new Date(s.start);
                    return {
                        hour: start.getHours(),
                        minute: start.getMinutes(),
                        weekday: start.getDay(),
                        isWeekend: [0, 6].includes(start.getDay())
                    };
                });
                
                const avgBedtimeHour = bedtimes.reduce((sum, t) => sum + t.hour + (t.minute / 60), 0) / bedtimes.length;
                patterns.timing = {
                    avgBedtime: formatTimeFromDecimal(avgBedtimeHour),
                    bedtimeRange: getBedtimeRange(bedtimes),
                    weekdayBedtime: getAverageByWeekday(bedtimes, false),
                    weekendBedtime: getAverageByWeekday(bedtimes, true),
                    bedtimeConsistency: calculateTimeConsistency(bedtimes.map(b => b.hour * 60 + b.minute))
                };
                
                const qualityScores = sleepSessions.map(s => {
                    let score = 0;
                    if (s.duration >= 7 && s.duration <= 9) score += 40; 
                    const bedtime = new Date(s.start).getHours();
                    if (bedtime >= 22 && bedtime <= 24) score += 30; 
                    if (!s.manual) score += 30; 
                    return score;
                });
                
                patterns.quality = {
                    avgQualityScore: Math.round(qualityScores.reduce((a, b) => a + b, 0) / qualityScores.length),
                    qualityDistribution: getScoreDistribution(qualityScores),
                    optimalSleepDays: sleepSessions.filter(s => s.duration >= 7 && s.duration <= 9).length,
                    poorSleepDays: sleepSessions.filter(s => s.duration < 6 || s.duration > 10).length
                };

                patterns.anomalies = detectSleepAnomalies(sleepSessions);

                patterns.weeklyTrend = analyzeWeeklyTrend(sleepSessions);

                patterns.improvement = detectImprovementTrend(sleepSessions.slice(-14)); // Last 2 weeks
                
            } catch (error) {
                console.error('Error detecting sleep patterns:', error);
                patterns.error = error.message;
            }
            
            return patterns;
        }

        function detectStudyPatterns() {
            const studyDays = Object.keys(dailyStudyData || {});
            if (studyDays.length < 5) return { insufficientData: true };
            
            const patterns = {
                intensity: {},
                consistency: {},
                timing: {},
                efficiency: {},
                trends: {}
            };
            
            try {
                const hours = studyDays.map(date => dailyStudyData[date]);
                
                patterns.intensity = {
                    avgDailyHours: parseFloat((hours.reduce((a, b) => a + b, 0) / hours.length).toFixed(1)),
                    maxDailyHours: Math.max(...hours),
                    minDailyHours: Math.min(...hours),
                    totalHours: hours.reduce((a, b) => a + b, 0),
                    highIntensityDays: hours.filter(h => h > 8).length,
                    lowIntensityDays: hours.filter(h => h < 2).length
                };
                
                patterns.consistency = {
                    streak: calculateStudyStreak(),
                    missedDays: calculateMissedStudyDays(studyDays),
                    consistencyScore: calculateStudyConsistencyScore(hours),
                    dailyVariance: calculateVariance(hours),
                    studyDaysPerWeek: Math.round((studyDays.length / (studyDays.length / 7)) * 10) / 10
                };
                
                if (sessionLogs && sessionLogs.length > 0) {
                    patterns.efficiency = analyzeStudyEfficiency(sessionLogs);
                }
                
                patterns.timing = analyzeStudyTiming(sessionLogs);
                
                patterns.trends = {
                    weeklyTrend: analyzeWeeklyStudyTrend(studyDays, dailyStudyData),
                    monthlyGrowth: calculateMonthlyGrowth(studyDays, dailyStudyData),
                    productivityTrend: calculateProductivityTrend(hours)
                };
                
            } catch (error) {
                console.error('Error detecting study patterns:', error);
                patterns.error = error.message;
            }
            
            return patterns;
        }









        // ====== HELPER FUNCTION FOR CONFIDENCE ======
        function detectWeeklyPatterns() {
            const patterns = {
                weekdayVsWeekend: {},
                dayOfWeek: {},
                weeklyCycles: {},
                consistency: {}
            };
            
            try {
                const weekData = {
                    Monday: { sleep: [], study: [], count: 0 },
                    Tuesday: { sleep: [], study: [], count: 0 },
                    Wednesday: { sleep: [], study: [], count: 0 },
                    Thursday: { sleep: [], study: [], count: 0 },
                    Friday: { sleep: [], study: [], count: 0 },
                    Saturday: { sleep: [], study: [], count: 0 },
                    Sunday: { sleep: [], study: [], count: 0 }
                };
                
                sleepSessions.forEach(session => {
                    const date = new Date(session.start);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                    if (weekData[dayName]) {
                        weekData[dayName].sleep.push(session.duration);
                        weekData[dayName].count++;
                    }
                });
                
                Object.keys(dailyStudyData || {}).forEach(dateStr => {
                    const date = new Date(dateStr);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                    if (weekData[dayName]) {
                        weekData[dayName].study.push(dailyStudyData[dateStr]);
                    }
                });
                
                Object.keys(weekData).forEach(day => {
                    const data = weekData[day];
                    if (data.sleep.length > 0) {
                        data.avgSleep = data.sleep.reduce((a, b) => a + b, 0) / data.sleep.length;
                    }
                    if (data.study.length > 0) {
                        data.avgStudy = data.study.reduce((a, b) => a + b, 0) / data.study.length;
                    }
                });
                
                patterns.dayOfWeek = weekData;
                
                const weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                const weekends = ['Saturday', 'Sunday'];
                
                patterns.weekdayVsWeekend = {
                    weekdaySleep: calculateAverageForDays(weekData, weekdays, 'sleep'),
                    weekendSleep: calculateAverageForDays(weekData, weekends, 'sleep'),
                    weekdayStudy: calculateAverageForDays(weekData, weekdays, 'study'),
                    weekendStudy: calculateAverageForDays(weekData, weekends, 'study'),
                    sleepDifference: calculateDifference(weekData, weekdays, weekends, 'sleep'),
                    studyDifference: calculateDifference(weekData, weekdays, weekends, 'study')
                };
                
                patterns.weeklyCycles = detectWeeklyCycles(weekData);
                
                patterns.consistency = {
                    mostConsistentDay: findMostConsistentDay(weekData),
                    leastConsistentDay: findLeastConsistentDay(weekData),
                    weeklyPatternStrength: calculatePatternStrength(weekData)
                };
                
            } catch (error) {
                console.error('Error detecting weekly patterns:', error);
                patterns.error = error.message;
                patterns.insufficientData = true;
            }
            
            if (!patterns.weekdayVsWeekend) {
                patterns.weekdayVsWeekend = {
                    weekdaySleep: 0,
                    weekendSleep: 0,
                    weekdayStudy: 0,
                    weekendStudy: 0,
                    sleepDifference: 0,
                    studyDifference: 0
                };
            }
            
            return patterns;
        }



        function detectGoalPatterns() {
            const patterns = {
                completion: {},
                pacing: {},
                difficulty: {},
                alignment: {}
            };
            
            if (goals.length === 0) return { insufficientData: true };
            
            try {
                const completedGoals = goals.filter(g => getGoalProgressPercent(g) >= 100);
                const inProgressGoals = goals.filter(g => getGoalProgressPercent(g) > 0 && getGoalProgressPercent(g) < 100);
                const notStartedGoals = goals.filter(g => getGoalProgressPercent(g) === 0);
                
                patterns.completion = {
                    totalGoals: goals.length,
                    completed: completedGoals.length,
                    inProgress: inProgressGoals.length,
                    notStarted: notStartedGoals.length,
                    completionRate: Math.round((completedGoals.length / goals.length) * 100),
                    avgCompletionTime: calculateAverageCompletionTime(completedGoals),
                    successRateByType: calculateSuccessRateByType(goals)
                };
                
                patterns.pacing = {
                    avgPace: calculateAveragePace(goals),
                    aheadOfSchedule: goals.filter(g => isAheadOfSchedule(g)).length,
                    behindSchedule: goals.filter(g => isBehindSchedule(g)).length,
                    pacingConsistency: calculatePacingConsistency(goals),
                    deadlineAdherence: calculateDeadlineAdherence(goals)
                };
                
                patterns.difficulty = {
                    easyGoals: goals.filter(g => getGoalDifficulty(g) === 'easy').length,
                    mediumGoals: goals.filter(g => getGoalDifficulty(g) === 'medium').length,
                    hardGoals: goals.filter(g => getGoalDifficulty(g) === 'hard').length,
                    successByDifficulty: calculateSuccessByDifficulty(goals),
                    difficultyBias: analyzeDifficultyBias(goals)
                };
                
                patterns.alignment = {
                    skillGoalAlignment: calculateSkillGoalAlignment(),
                    careerFocus: analyzeCareerFocus(goals),
                    goalInterdependencies: detectGoalInterdependencies(goals),
                    priorityDistribution: analyzePriorityDistribution(goals)
                };
                
            } catch (error) {
                console.error('Error detecting goal patterns:', error);
                patterns.error = error.message;
            }
            
            return patterns;
        }

        function detectProductivityPatterns() {
            const patterns = {
                efficiency: {},
                focus: {},
                burnoutRisk: {},
                optimization: {}
            };
            
            try {

                patterns.efficiency = {
                    studyToSleepRatio: calculateStudyToSleepRatio(),
                    productiveHours: calculateProductiveHours(),
                    efficiencyTrend: analyzeEfficiencyTrend(),
                    peakProductivityTimes: detectPeakProductivityTimes()
                };
                
                patterns.focus = {
                    averageSessionLength: calculateAverageSessionLength(),
                    deepWorkSessions: countDeepWorkSessions(),
                    distractionFrequency: estimateDistractionFrequency(),
                    focusConsistency: calculateFocusConsistency()
                };
                
                patterns.burnoutRisk = {
                    currentRisk: assessBurnoutRisk(),
                    riskFactors: identifyBurnoutRiskFactors(),
                    recoveryIndicators: checkRecoveryIndicators(),
                    sustainabilityScore: calculateSustainabilityScore()
                };
                
                patterns.optimization = {
                    timeWasters: identifyTimeWasters(),
                    optimizationPotential: calculateOptimizationPotential(),
                    quickWins: identifyQuickWins(),
                    systemicImprovements: suggestSystemicImprovements()
                };
                
            } catch (error) {
                console.error('Error detecting productivity patterns:', error);
                patterns.error = error.message;
            }
            
            return patterns;
        }

        function calculateConsistencyScore(values) {
            if (values.length < 2) return 0;
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / values.length;
            const stdDev = Math.sqrt(variance);
            const cv = (stdDev / avg) * 100; 
            const score = Math.max(0, 100 - Math.min(cv, 100));
            return Math.round(score);
        }

        function calculateStandardDeviation(values) {
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const squareDiffs = values.map(value => Math.pow(value - avg, 2));
            const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
            return Math.sqrt(avgSquareDiff);
        }

        function formatTimeFromDecimal(decimalHours) {
            const hours = Math.floor(decimalHours);
            const minutes = Math.round((decimalHours - hours) * 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        function getBedtimeRange(bedtimes) {
            const times = bedtimes.map(b => b.hour * 60 + b.minute);
            const minTime = Math.min(...times);
            const maxTime = Math.max(...times);
            return {
                earliest: formatTimeFromDecimal(minTime / 60),
                latest: formatTimeFromDecimal(maxTime / 60),
                rangeHours: ((maxTime - minTime) / 60).toFixed(1)
            };
        }

        function calculateTimeConsistency(times) {
            if (times.length < 2) return 0;
            const avg = times.reduce((a, b) => a + b, 0) / times.length;
            const variance = times.reduce((sum, t) => sum + Math.pow(t - avg, 2), 0) / times.length;
            const stdDev = Math.sqrt(variance);
            const score = Math.max(0, 100 - (stdDev / 60) * 100);
            return Math.round(score);
        }

        function getScoreDistribution(scores) {
            const distribution = {
                excellent: 0, // 80-100
                good: 0,      // 60-79
                fair: 0,      // 40-59
                poor: 0       // 0-39
            };
            
            scores.forEach(score => {
                if (score >= 80) distribution.excellent++;
                else if (score >= 60) distribution.good++;
                else if (score >= 40) distribution.fair++;
                else distribution.poor++;
            });
            
            Object.keys(distribution).forEach(key => {
                distribution[key] = Math.round((distribution[key] / scores.length) * 100);
            });
            
            return distribution;
        }

        function detectSleepAnomalies(sessions) {
            const anomalies = [];
            
            sessions.forEach((session, index) => {
                if (session.duration < 3) {
                    anomalies.push({
                        type: 'very_short_sleep',
                        date: new Date(session.start).toLocaleDateString(),
                        duration: session.duration,
                        severity: 'high',
                        message: `Very short sleep: ${session.duration}h`
                    });
                }
                
                if (session.duration > 12) {
                    anomalies.push({
                        type: 'very_long_sleep',
                        date: new Date(session.start).toLocaleDateString(),
                        duration: session.duration,
                        severity: 'medium',
                        message: `Unusually long sleep: ${session.duration}h`
                    });
                }

                if (index > 0) {
                    const prevSession = sessions[index - 1];
                    const timeDiff = Math.abs(session.start - prevSession.end) / (1000 * 60 * 60);
                    
                    if (timeDiff < 12) {
                        anomalies.push({
                            type: 'short_interval',
                            date: new Date(session.start).toLocaleDateString(),
                            interval: timeDiff.toFixed(1),
                            severity: 'medium',
                            message: `Short interval between sleeps: ${timeDiff.toFixed(1)}h`
                        });
                    }
                }
            });
            
            return anomalies;
        }

        function analyzeWeeklyTrend(sessions) {
            const weeklyAverages = [];
            const weeks = {};
            
            sessions.forEach(session => {
                const date = new Date(session.start);
                const year = date.getFullYear();
                const week = getWeekNumber(date);
                const key = `${year}-W${week}`;
                
                if (!weeks[key]) {
                    weeks[key] = { durations: [], count: 0 };
                }
                weeks[key].durations.push(session.duration);
                weeks[key].count++;
            });
            
            Object.keys(weeks).sort().forEach(weekKey => {
                const weekData = weeks[weekKey];
                const avgDuration = weekData.durations.reduce((a, b) => a + b, 0) / weekData.durations.length;
                weeklyAverages.push({
                    week: weekKey,
                    avgDuration: parseFloat(avgDuration.toFixed(1)),
                    sessions: weekData.count
                });
            });
            
            return {
                weeklyAverages,
                trend: calculateTrend(weeklyAverages.map(w => w.avgDuration)),
                consistency: calculateWeeklyConsistency(weeklyAverages)
            };
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function calculateTrend(values) {
            if (values.length < 2) return 'insufficient_data';
            
            const n = values.length;
            const xSum = values.reduce((sum, _, i) => sum + (i + 1), 0);
            const ySum = values.reduce((sum, val) => sum + val, 0);
            const xySum = values.reduce((sum, val, i) => sum + (val * (i + 1)), 0);
            const xSquaredSum = values.reduce((sum, _, i) => sum + Math.pow(i + 1, 2), 0);
            
            const slope = (n * xySum - xSum * ySum) / (n * xSquaredSum - Math.pow(xSum, 2));
            
            if (Math.abs(slope) < 0.1) return 'stable';
            if (slope > 0.1) return 'improving';
            if (slope < -0.1) return 'declining';
            return 'stable';
        }

        function detectImprovementTrend(recentSessions) {
            if (recentSessions.length < 5) return null;
            
            const mid = Math.floor(recentSessions.length / 2);
            const firstHalf = recentSessions.slice(0, mid);
            const secondHalf = recentSessions.slice(mid);
            
            const firstAvg = firstHalf.reduce((sum, s) => sum + s.duration, 0) / firstHalf.length;
            const secondAvg = secondHalf.reduce((sum, s) => sum + s.duration, 0) / secondHalf.length;
            
            const improvement = ((secondAvg - firstAvg) / firstAvg) * 100;
            
            return {
                improvementPercent: parseFloat(improvement.toFixed(1)),
                direction: improvement > 0 ? 'improving' : 'declining',
                significance: Math.abs(improvement) > 10 ? 'significant' : 'minor',
                firstHalfAvg: parseFloat(firstAvg.toFixed(1)),
                secondHalfAvg: parseFloat(secondAvg.toFixed(1))
            };
        }

        let cachedPatterns = null;
        let lastPatternUpdate = 0;
        const CACHE_TIMEOUT = 5 * 60 * 1000;

        function detectPatterns(forceRefresh = false) {
            const now = Date.now();
            
            if (!forceRefresh && cachedPatterns && (now - lastPatternUpdate) < CACHE_TIMEOUT) {
                return cachedPatterns;
            }
            
            cachedPatterns = {
                sleepPatterns: detectSleepPatterns(),
                studyPatterns: detectStudyPatterns(),
                correlationPatterns: detectCorrelationPatterns(),
                weeklyPatterns: detectWeeklyPatterns(),
                goalPatterns: detectGoalPatterns(),
                productivityPatterns: detectProductivityPatterns()
            };
            
            lastPatternUpdate = now;
            return cachedPatterns;
        }

        function renderPatternInsights() {
            const container = document.getElementById('patternInsightsContainer');
            if (!container) {
                const section = document.createElement('div');
                section.id = 'patternInsightsSection';
                section.innerHTML = `
                    <div class="dashboard-section">
                        <div class="section-header">
                            <h2>ð§  Pattern Detection</h2>
                            <div class="section-actions">
                                <button onclick="refreshPatternInsights()" class="btn-icon" title="Refresh">
                                    ð
                                </button>
                                <button onclick="togglePatternDetails()" class="btn-icon" title="Toggle details">
                                    âï¸
                                </button>
                            </div>
                        </div>
                        <div id="patternInsightsContainer"></div>
                    </div>
                `;
                
                const correlationSection = document.querySelector('#correlationAnalyticsSection') || 
                                        document.querySelector('.dashboard-section:last-child');
                if (correlationSection) {
                    correlationSection.parentNode.insertBefore(section, correlationSection.nextSibling);
                } else {
                    document.body.appendChild(section);
                }
                
                container = document.getElementById('patternInsightsContainer');
            }
            
            const patterns = detectPatterns();
            
            if (!document.getElementById('pattern-styles')) {
                const style = document.createElement('style');
                style.id = 'pattern-styles';
                style.textContent = `
                    .pattern-insights-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                        gap: 16px;
                        margin-top: 16px;
                    }
                    
                    .pattern-card {
                        background: var(--bg-white);
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: var(--shadow-sm);
                        border: 1px solid var(--border-color);
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    }
                    
                    .pattern-card:hover {
                        transform: translateY(-4px);
                        box-shadow: var(--shadow-md);
                        border-color: var(--primary);
                    }
                    
                    .pattern-card-header {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        margin-bottom: 16px;
                        padding-bottom: 12px;
                        border-bottom: 2px solid var(--border-color);
                    }
                    
                    .pattern-icon {
                        font-size: 1.8rem;
                        width: 50px;
                        height: 50px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 10px;
                        background: linear-gradient(135deg, var(--primary-light), var(--primary));
                        color: white;
                    }
                    
                    .pattern-title {
                        font-size: 1.1rem;
                        font-weight: 700;
                        color: var(--text-dark);
                        margin: 0;
                    }
                    
                    .pattern-subtitle {
                        font-size: 0.9rem;
                        color: var(--text-muted);
                        margin-top: 4px;
                    }
                    
                    .pattern-stats {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 12px;
                        margin-bottom: 16px;
                    }
                    
                    .stat-item {
                        text-align: center;
                        padding: 10px;
                        background: var(--bg-light);
                        border-radius: 8px;
                    }
                    
                    .stat-value {
                        font-size: 1.4rem;
                        font-weight: 800;
                        color: var(--primary);
                        line-height: 1;
                    }
                    
                    .stat-label {
                        font-size: 0.8rem;
                        color: var(--text-muted);
                        margin-top: 4px;
                        font-weight: 500;
                    }
                    
                    .pattern-insight {
                        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), transparent);
                        padding: 12px;
                        border-radius: 8px;
                        margin-top: 12px;
                        border-left: 3px solid var(--primary);
                    }
                    
                    .insight-title {
                        font-weight: 700;
                        color: var(--text-dark);
                        font-size: 0.95rem;
                        margin-bottom: 6px;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }
                    
                    .insight-text {
                        font-size: 0.9rem;
                        color: var(--text-dark);
                        line-height: 1.4;
                    }
                    
                    .pattern-trend {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-top: 12px;
                        padding-top: 12px;
                        border-top: 1px dashed var(--border-color);
                    }
                    
                    .trend-indicator {
                        padding: 4px 10px;
                        border-radius: 20px;
                        font-size: 0.8rem;
                        font-weight: 600;
                    }
                    
                    .trend-up {
                        background: rgba(16, 185, 129, 0.15);
                        color: #10b981;
                    }
                    
                    .trend-down {
                        background: rgba(239, 68, 68, 0.15);
                        color: #ef4444;
                    }
                    
                    .trend-stable {
                        background: rgba(59, 130, 246, 0.15);
                        color: #3b82f6;
                    }
                    
                    .confidence-badge {
                        position: absolute;
                        top: 12px;
                        right: 12px;
                        background: var(--bg-light);
                        padding: 4px 10px;
                        border-radius: 20px;
                        font-size: 0.75rem;
                        font-weight: 600;
                        color: var(--text-muted);
                    }
                    
                    .pattern-details {
                        margin-top: 16px;
                        padding-top: 16px;
                        border-top: 1px solid var(--border-color);
                    }
                    
                    .detail-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 6px 0;
                        border-bottom: 1px dotted var(--border-color);
                    }
                    
                    .detail-label {
                        font-size: 0.85rem;
                        color: var(--text-muted);
                    }
                    
                    .detail-value {
                        font-size: 0.85rem;
                        font-weight: 600;
                        color: var(--text-dark);
                    }
                    
                    .pattern-alert {
                        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), transparent);
                        border: 1px solid rgba(239, 68, 68, 0.3);
                        padding: 12px;
                        border-radius: 8px;
                        margin-top: 12px;
                    }
                    
                    .alert-icon {
                        color: #ef4444;
                        font-size: 1.2rem;
                        margin-right: 8px;
                    }
                    
                    .pattern-recommendation {
                        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), transparent);
                        border: 1px solid rgba(16, 185, 129, 0.3);
                        padding: 12px;
                        border-radius: 8px;
                        margin-top: 12px;
                    }
                    
                    .recommendation-icon {
                        color: #10b981;
                        font-size: 1.2rem;
                        margin-right: 8px;
                    }
                    
                    @media (max-width: 768px) {
                        .pattern-insights-grid {
                            grid-template-columns: 1fr;
                        }
                        
                        .pattern-stats {
                            grid-template-columns: repeat(2, 1fr);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            let html = `
                <div class="pattern-insights-grid">
                    ${renderSleepPatternCard(patterns.sleepPatterns || {})}
                    ${renderStudyPatternCard(patterns.studyPatterns || {})}
                    ${renderCorrelationPatternCard(patterns.correlationPatterns || {})}
                    ${renderWeeklyPatternCard(patterns.weeklyPatterns || {})}
                    ${renderGoalPatternCard(patterns.goalPatterns || {})}
                    ${renderProductivityPatternCard(patterns.productivityPatterns || {})}
                </div>
            `;
            
            container.innerHTML = html;
        }

        function refreshPatternInsights() {
            detectPatterns(true);
            renderPatternInsights();
        }







        function renderSleepPatternCard(sleepPatterns) {
            if (sleepPatterns.insufficientData) {
                return `
                    <div class="pattern-card">
                        <div class="pattern-card-header">
                            <div class="pattern-icon">ð´</div>
                            <div>
                                <h3 class="pattern-title">Sleep Patterns</h3>
                                <div class="pattern-subtitle">Need more data</div>
                            </div>
                        </div>
                        <div class="pattern-insight">
                            <div class="insight-text">
                                Track at least 5 sleep sessions to see patterns
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const consistency = sleepPatterns.consistency || {};
            const timing = sleepPatterns.timing || {};
            const quality = sleepPatterns.quality || {};
            const trend = sleepPatterns.weeklyTrend?.trend || 'stable';
            
            const trendClass = trend === 'improving' ? 'trend-up' : 
                            trend === 'declining' ? 'trend-down' : 'trend-stable';
            const trendText = trend === 'improving' ? 'Improving' : 
                            trend === 'declining' ? 'Declining' : 'Stable';
            
            return `
                <div class="pattern-card">
                    <div class="pattern-card-header">
                        <div class="pattern-icon">ð´</div>
                        <div>
                            <h3 class="pattern-title">Sleep Patterns</h3>
                            <div class="pattern-subtitle">${sleepSessions.length} sessions analyzed</div>
                        </div>
                        <div class="confidence-badge">
                            ${consistency.consistencyScore || 0}% consistent
                        </div>
                    </div>
                    
                    <div class="pattern-stats">
                        <div class="stat-item">
                            <div class="stat-value">${consistency.avgDuration || 0}</div>
                            <div class="stat-label">Avg hours</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${timing.bedtimeConsistency || 0}%</div>
                            <div class="stat-label">Time consistency</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${quality.avgQualityScore || 0}</div>
                            <div class="stat-label">Quality score</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${quality.optimalSleepDays || 0}</div>
                            <div class="stat-label">Optimal days</div>
                        </div>
                    </div>
                    
                    <div class="pattern-trend">
                        <span class="trend-indicator ${trendClass}">${trendText}</span>
                        <span class="trend-text">Weekly sleep trend</span>
                    </div>
                    
                    ${sleepPatterns.anomalies?.length > 0 ? `
                        <div class="pattern-alert">
                            <div class="insight-title">
                                <span class="alert-icon">â ï¸</span>
                                Sleep Anomalies Detected
                            </div>
                            <div class="insight-text">
                                Found ${sleepPatterns.anomalies.length} unusual sleep patterns
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="pattern-details">
                        <div class="detail-item">
                            <span class="detail-label">Bedtime range</span>
                            <span class="detail-value">${timing.bedtimeRange?.earliest || 'N/A'} - ${timing.bedtimeRange?.latest || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Weekday bedtime</span>
                            <span class="detail-value">${timing.weekdayBedtime || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Weekend bedtime</span>
                            <span class="detail-value">${timing.weekendBedtime || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStudyPatternCard(studyPatterns) {
            if (studyPatterns.insufficientData) {
                return `
                    <div class="pattern-card">
                        <div class="pattern-card-header">
                            <div class="pattern-icon">ð</div>
                            <div>
                                <h3 class="pattern-title">Study Patterns</h3>
                                <div class="pattern-subtitle">Need more data</div>
                            </div>
                        </div>
                        <div class="pattern-insight">
                            <div class="insight-text">
                                Track at least 5 study days to see patterns
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const intensity = studyPatterns.intensity || {};
            const consistency = studyPatterns.consistency || {};
            const trends = studyPatterns.trends || {};
            
            return `
                <div class="pattern-card">
                    <div class="pattern-card-header">
                        <div class="pattern-icon">ð</div>
                        <div>
                            <h3 class="pattern-title">Study Patterns</h3>
                            <div class="pattern-subtitle">${Object.keys(dailyStudyData || {}).length} days analyzed</div>
                        </div>
                        <div class="confidence-badge">
                            ${consistency.consistencyScore || 0}% consistent
                        </div>
                    </div>
                    
                    <div class="pattern-stats">
                        <div class="stat-item">
                            <div class="stat-value">${intensity.avgDailyHours || 0}</div>
                            <div class="stat-label">Avg hours/day</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${consistency.streak || 0}</div>
                            <div class="stat-label">Current streak</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${intensity.totalHours || 0}</div>
                            <div class="stat-label">Total hours</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${consistency.studyDaysPerWeek || 0}</div>
                            <div class="stat-label">Days/week</div>
                        </div>
                    </div>
                    
                    <div class="pattern-insight">
                        <div class="insight-title">
                            ð Study Intensity
                        </div>
                        <div class="insight-text">
                            ${intensity.highIntensityDays || 0} high-intensity days (>8h), 
                            ${intensity.lowIntensityDays || 0} low-intensity days (<2h)
                        </div>
                    </div>
                    
                    <div class="pattern-details">
                        <div class="detail-item">
                            <span class="detail-label">Max daily hours</span>
                            <span class="detail-value">${intensity.maxDailyHours || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Min daily hours</span>
                            <span class="detail-value">${intensity.minDailyHours || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Missed days</span>
                            <span class="detail-value">${consistency.missedDays || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Weekly trend</span>
                            <span class="detail-value">${trends.weeklyTrend || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCorrelationPatternCard(correlationPatterns) {
            const sleepStudy = calculateSleepStudyCorrelation();
            
            if (sleepStudy.matchedDays < 3) {
                return `
                    <div class="pattern-card">
                        <div class="pattern-card-header">
                            <div class="pattern-icon">ð</div>
                            <div>
                                <h3 class="pattern-title">Correlation Patterns</h3>
                                <div class="pattern-subtitle">Need matched data</div>
                            </div>
                        </div>
                        <div class="pattern-insight">
                            <div class="insight-text">
                                Need at least 3 days with both sleep and study data
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const relationships = correlationPatterns.relationships || {};
            const optimal = correlationPatterns.optimalRanges || {};
            
            const correlationStrength = getCorrelationStrength(sleepStudy.correlation);
            const strengthClass = correlationStrength === 'strong' ? 'trend-up' : 
                                correlationStrength === 'moderate' ? 'trend-stable' : 'trend-down';
            
            return `
                <div class="pattern-card">
                    <div class="pattern-card-header">
                        <div class="pattern-icon">ð</div>
                        <div>
                            <h3 class="pattern-title">Correlation Patterns</h3>
                            <div class="pattern-subtitle">${sleepStudy.matchedDays} matched days</div>
                        </div>
                        <div class="confidence-badge">
                            r = ${sleepStudy.correlation?.toFixed(3) || 0}
                        </div>
                    </div>
                    
                    <div class="pattern-stats">
                        <div class="stat-item">
                            <div class="stat-value">${sleepStudy.correlation?.toFixed(2) || 0}</div>
                            <div class="stat-label">Correlation</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${sleepStudy.matchedDays}</div>
                            <div class="stat-label">Data points</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${relationships.direction === 'positive' ? '+' : '-'}</div>
                            <div class="stat-label">Direction</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${correlationStrength}</div>
                            <div class="stat-label">Strength</div>
                        </div>
                    </div>
                    
                    <div class="pattern-trend">
                        <span class="trend-indicator ${strengthClass}">${correlationStrength}</span>
                        <span class="trend-text">Sleep-Study relationship</span>
                    </div>
                    
                    ${optimal.bestStudyPerformance ? `
                        <div class="pattern-recommendation">
                            <div class="insight-title">
                                <span class="recommendation-icon">ð¡</span>
                                Optimal Sleep Range
                            </div>
                            <div class="insight-text">
                                Best study performance at ${optimal.bestStudyPerformance || 'N/A'} hours of sleep
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="pattern-details">
                        <div class="detail-item">
                            <span class="detail-label">Relationship type</span>
                            <span class="detail-value">${relationships.isLinear ? 'Linear' : 'Non-linear'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Optimal sleep</span>
                            <span class="detail-value">${optimal.sleepForPeakProductivity || 'N/A'}h</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Significance</span>
                            <span class="detail-value">${relationships.significance || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Pattern detected</span>
                            <span class="detail-value">${relationships.isInvertedU ? 'Inverted U' : 'Other'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWeeklyPatternCard(weeklyPatterns) {
            const hasData = weeklyPatterns && 
                        !weeklyPatterns.insufficientData && 
                        weeklyPatterns.weekdayVsWeekend && 
                        weeklyPatterns.weekdayVsWeekend.weekdaySleep !== undefined;
            
            if (!hasData) {
                return `
                    <div class="pattern-card">
                        <div class="pattern-card-header">
                            <div class="pattern-icon">ð</div>
                            <div>
                                <h3 class="pattern-title">Weekly Patterns</h3>
                                <div class="pattern-subtitle">Need more data</div>
                            </div>
                        </div>
                        <div class="pattern-insight">
                            <div class="insight-text">
                                Track at least 3 days across different weekdays and weekends
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const weekdayVsWeekend = weeklyPatterns.weekdayVsWeekend || {};
            
            const sleepDiff = weekdayVsWeekend.sleepDifference || 0;
            const studyDiff = weekdayVsWeekend.studyDifference || 0;
            
            const sleepTrend = Math.abs(sleepDiff) > 0.5 ? 
                (sleepDiff > 0 ? 'Weekdays > Weekends' : 'Weekends > Weekdays') : 'Balanced';
            const studyTrend = Math.abs(studyDiff) > 0.5 ? 
                (studyDiff > 0 ? 'Weekdays > Weekends' : 'Weekends > Weekdays') : 'Balanced';
            
            return `
                <div class="pattern-card">
                    <div class="pattern-card-header">
                        <div class="pattern-icon">ð</div>
                        <div>
                            <h3 class="pattern-title">Weekly Patterns</h3>
                            <div class="pattern-subtitle">Day-by-day analysis</div>
                        </div>
                    </div>
                    
                    <div class="pattern-stats">
                        <div class="stat-item">
                            <div class="stat-value">${weekdayVsWeekend.weekdaySleep?.toFixed(1) || 0}</div>
                            <div class="stat-label">Weekday sleep</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${weekdayVsWeekend.weekendSleep?.toFixed(1) || 0}</div>
                            <div class="stat-label">Weekend sleep</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${weekdayVsWeekend.weekdayStudy?.toFixed(1) || 0}</div>
                            <div class="stat-label">Weekday study</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${weekdayVsWeekend.weekendStudy?.toFixed(1) || 0}</div>
                            <div class="stat-label">Weekend study</div>
                        </div>
                    </div>
                    
                    <div class="pattern-insight">
                        <div class="insight-title">
                            ð Weekly Comparison
                        </div>
                        <div class="insight-text">
                            Sleep: ${sleepTrend} | Study: ${studyTrend}
                        </div>
                    </div>
                    
                    <div class="pattern-details">
                        <div class="detail-item">
                            <span class="detail-label">Sleep difference</span>
                            <span class="detail-value">${sleepDiff?.toFixed(1) || 0}h</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Study difference</span>
                            <span class="detail-value">${studyDiff?.toFixed(1) || 0}h</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Most consistent day</span>
                            <span class="detail-value">${weeklyPatterns.consistency?.mostConsistentDay || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Pattern strength</span>
                            <span class="detail-value">${weeklyPatterns.consistency?.weeklyPatternStrength || 0}%</span>
                        </div>
                    </div>
                </div>
            `;
        }




        function renderGoalPatternCard(goalPatterns) {
            if (goalPatterns.insufficientData) {
                return `
                    <div class="pattern-card">
                        <div class="pattern-card-header">
                            <div class="pattern-icon">ð¯</div>
                            <div>
                                <h3 class="pattern-title">Goal Patterns</h3>
                                <div class="pattern-subtitle">No goals set</div>
                            </div>
                        </div>
                        <div class="pattern-insight">
                            <div class="insight-text">
                                Set some goals to see completion patterns
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const completion = goalPatterns.completion || {};
            const pacing = goalPatterns.pacing || {};
            
            const completionRate = completion.completionRate || 0;
            const completionClass = completionRate >= 70 ? 'trend-up' : 
                                completionRate >= 40 ? 'trend-stable' : 'trend-down';
            
            return `
                <div class="pattern-card">
                    <div class="pattern-card-header">
                        <div class="pattern-icon">ð¯</div>
                        <div>
                            <h3 class="pattern-title">Goal Patterns</h3>
                            <div class="pattern-subtitle">${completion.totalGoals || 0} total goals</div>
                        </div>
                        <div class="confidence-badge">
                            ${completionRate}% complete
                        </div>
                    </div>
                    
                    <div class="pattern-stats">
                        <div class="stat-item">
                            <div class="stat-value">${completion.completed || 0}</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${completion.inProgress || 0}</div>
                            <div class="stat-label">In progress</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${pacing.aheadOfSchedule || 0}</div>
                            <div class="stat-label">Ahead</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${pacing.behindSchedule || 0}</div>
                            <div class="stat-label">Behind</div>
                        </div>
                    </div>
                    
                    <div class="pattern-trend">
                        <span class="trend-indicator ${completionClass}">${completionRate}% rate</span>
                        <span class="trend-text">Goal completion rate</span>
                    </div>
                    
                    <div class="pattern-details">
                        <div class="detail-item">
                            <span class="detail-label">Success rate</span>
                            <span class="detail-value">${completion.successRateByType || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Avg completion time</span>
                            <span class="detail-value">${completion.avgCompletionTime || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Pacing consistency</span>
                            <span class="detail-value">${pacing.pacingConsistency || 0}%</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Deadline adherence</span>
                            <span class="detail-value">${pacing.deadlineAdherence || 0}%</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProductivityPatternCard(productivityPatterns) {
            const efficiency = productivityPatterns.efficiency || {};
            const burnout = productivityPatterns.burnoutRisk || {};
            
            const riskLevel = burnout.currentRisk || 'low';
            const riskClass = riskLevel === 'high' ? 'trend-down' : 
                            riskLevel === 'medium' ? 'trend-stable' : 'trend-up';
            
            return `
                <div class="pattern-card">
                    <div class="pattern-card-header">
                        <div class="pattern-icon">â¡</div>
                        <div>
                            <h3 class="pattern-title">Productivity Patterns</h3>
                            <div class="pattern-subtitle">Efficiency analysis</div>
                        </div>
                        <div class="confidence-badge">
                            ${efficiency.efficiencyTrend || 'N/A'}
                        </div>
                    </div>
                    
                    <div class="pattern-stats">
                        <div class="stat-item">
                            <div class="stat-value">${efficiency.studyToSleepRatio?.toFixed(1) || 0}</div>
                            <div class="stat-label">Study/Sleep ratio</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${efficiency.productiveHours || 0}</div>
                            <div class="stat-label">Productive hours</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${productivityPatterns.focus?.averageSessionLength?.toFixed(1) || 0}</div>
                            <div class="stat-label">Avg session (h)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${burnout.sustainabilityScore || 0}</div>
                            <div class="stat-label">Sustainability</div>
                        </div>
                    </div>
                    
                    <div class="pattern-trend">
                        <span class="trend-indicator ${riskClass}">${riskLevel} risk</span>
                        <span class="trend-text">Burnout risk level</span>
                    </div>
                    
                    ${riskLevel === 'high' ? `
                        <div class="pattern-alert">
                            <div class="insight-title">
                                <span class="alert-icon">ð¨</span>
                                High Burnout Risk
                            </div>
                            <div class="insight-text">
                                Consider taking breaks and adjusting study intensity
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="pattern-details">
                        <div class="detail-item">
                            <span class="detail-label">Deep work sessions</span>
                            <span class="detail-value">${productivityPatterns.focus?.deepWorkSessions || 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Focus consistency</span>
                            <span class="detail-value">${productivityPatterns.focus?.focusConsistency || 0}%</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Optimization potential</span>
                            <span class="detail-value">${productivityPatterns.optimization?.optimizationPotential || 0}%</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Quick wins available</span>
                            <span class="detail-value">${productivityPatterns.optimization?.quickWins || 0}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function refreshPatternInsights() {
            renderPatternInsights();
            showNotification('ð Pattern insights refreshed', 'success');
        }

        function togglePatternDetails() {
            const container = document.getElementById('patternInsightsContainer');
            if (!container) return;
            
            const details = container.querySelectorAll('.pattern-details');
            const isHidden = details[0]?.style.display === 'none';
            
            details.forEach(detail => {
                detail.style.display = isHidden ? 'block' : 'none';
            });
            
            showNotification(isHidden ? 'ð Details shown' : 'ð Details hidden', 'info');
        }

        function generatePatternInsights(patterns) {
            const insights = [];
            
            if (patterns.sleepPatterns && !patterns.sleepPatterns.insufficientData) {
                const sleep = patterns.sleepPatterns;
                if (sleep.consistency?.consistencyScore < 60) {
                    insights.push({
                        type: 'sleep_consistency',
                        priority: 'medium',
                        message: 'Sleep schedule varies significantly. Try consistent bedtimes.',
                        icon: 'ð´'
                    });
                }
                
                if (sleep.quality?.optimalSleepDays < (sleepSessions.length * 0.5)) {
                    insights.push({
                        type: 'sleep_quality',
                        priority: 'high',
                        message: 'Less than 50% of sleep sessions are in optimal range (7-9 hours).',
                        icon: 'ð¤'
                    });
                }
            }
            
            if (patterns.studyPatterns && !patterns.studyPatterns.insufficientData) {
                const study = patterns.studyPatterns;
                if (study.consistency?.streak < 3) {
                    insights.push({
                        type: 'study_consistency',
                        priority: 'medium',
                        message: 'Study streak is short. Try to study consistently every day.',
                        icon: 'ð'
                    });
                }
                
                if (study.intensity?.highIntensityDays > study.intensity?.lowIntensityDays * 2) {
                    insights.push({
                        type: 'study_intensity',
                        priority: 'low',
                        message: 'Many high-intensity study days detected. Remember to balance with rest.',
                        icon: 'â¡'
                    });
                }
            }
            
            if (patterns.correlationPatterns && !patterns.correlationPatterns.insufficientData) {
                const corr = patterns.correlationPatterns;
                if (corr.relationships?.correlationStrength === 'strong') {
                    insights.push({
                        type: 'strong_correlation',
                        priority: 'high',
                        message: 'Strong correlation detected! Sleep significantly affects study performance.',
                        icon: 'ð'
                    });
                }
            }
            
            if (patterns.weeklyPatterns && patterns.weeklyPatterns.weekdayVsWeekend) {
                const weekly = patterns.weeklyPatterns;
                const diff = Math.abs(weekly.weekdayVsWeekend.studyDifference || 0);
                if (diff > 2) {
                    insights.push({
                        type: 'weekly_imbalance',
                        priority: 'medium',
                        message: `Large study difference between weekdays and weekends (${diff.toFixed(1)}h).`,
                        icon: 'ð'
                    });
                }
            }
            
            if (patterns.goalPatterns && !patterns.goalPatterns.insufficientData) {
                const goals = patterns.goalPatterns;
                if (goals.completion?.completionRate < 30) {
                    insights.push({
                        type: 'goal_completion',
                        priority: 'high',
                        message: 'Low goal completion rate. Consider smaller, more achievable goals.',
                        icon: 'ð¯'
                    });
                }
            }
            
            if (patterns.productivityPatterns) {
                const prod = patterns.productivityPatterns;
                if (prod.burnoutRisk?.currentRisk === 'high') {
                    insights.push({
                        type: 'burnout_risk',
                        priority: 'high',
                        message: 'High burnout risk detected. Schedule rest and recovery time.',
                        icon: 'ð¨'
                    });
                }
            }
            
            return insights.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                renderPatternInsights();

                const updatePatterns = () => {
                    setTimeout(renderPatternInsights, 500);
                };
                
                const originalStopSleepTracking = stopSleepTracking;
                stopSleepTracking = function(...args) {
                    const result = originalStopSleepTracking(...args);
                    updatePatterns();
                    return result;
                };
                
                const originalAddStudyTime = addStudyTime;
                if (originalAddStudyTime) {
                    addStudyTime = function(...args) {
                        const result = originalAddStudyTime(...args);
                        updatePatterns();
                        return result;
                    };
                }
                
                setInterval(renderPatternInsights, 5 * 60 * 1000);
                
            }, 2000); 
        });

        function showPatternDetailsModal(patternType) {
            const patterns = detectPatterns();
            const patternData = patterns[patternType] || {};
            
            const modal = document.createElement('div');
            modal.id = 'patternDetailsModal';
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
                padding: 20px;
            `;
            
            const titles = {
                sleepPatterns: 'ð´ Sleep Pattern Details',
                studyPatterns: 'ð Study Pattern Details',
                correlationPatterns: 'ð Correlation Pattern Details',
                weeklyPatterns: 'ð Weekly Pattern Details',
                goalPatterns: 'ð¯ Goal Pattern Details',
                productivityPatterns: 'â¡ Productivity Pattern Details'
            };
            
            modal.innerHTML = `
                <div style="background: var(--bg-white); border-radius: 16px; max-width: 800px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="padding: 24px; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; background: var(--bg-white); z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0 0 8px 0; font-size: 1.5rem; color: var(--text-dark);">
                                    ${titles[patternType] || 'Pattern Details'}
                                </h2>
                                <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">
                                    Detailed analysis and insights
                                </p>
                            </div>
                            <button onclick="closePatternDetailsModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-muted);">
                                Ã
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <pre style="background: var(--bg-light); padding: 20px; border-radius: 8px; overflow-x: auto; font-size: 0.85rem; line-height: 1.4;">
        ${JSON.stringify(patternData, null, 2)}
                        </pre>
                        
                        <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, var(--primary-light), transparent); border-radius: 8px;">
                            <h3 style="margin: 0 0 12px 0; color: var(--primary);">ð¡ Key Insights</h3>
                            ${generatePatternInsights(patterns).filter(insight => 
                                insight.type.includes(patternType.replace('Patterns', ''))
                            ).map(insight => `
                                <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px; border-left: 3px solid var(--primary);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <span style="font-size: 1.2rem;">${insight.icon}</span>
                                        <strong style="color: var(--text-dark);">${insight.type.replace('_', ' ').toUpperCase()}</strong>
                                    </div>
                                    <p style="margin: 0; color: var(--text-dark);">${insight.message}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const handleEscape = (e) => {
                if (e.key === 'Escape') closePatternDetailsModal();
            };
            document.addEventListener('keydown', handleEscape);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closePatternDetailsModal();
            });
        }

        function closePatternDetailsModal() {
            const modal = document.getElementById('patternDetailsModal');
            if (modal) modal.remove();
        }

        function exportPatterns() {
            const patterns = detectPatterns();
            const dataStr = JSON.stringify(patterns, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `pattern-insights-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('ð Patterns exported successfully', 'success');
        }

        function getPatternBasedRecommendations() {
            const patterns = detectPatterns();
            const insights = generatePatternInsights(patterns);
            
            return insights.map(insight => ({
                ...insight,
                action: getActionForInsight(insight.type),
                timestamp: new Date().toISOString()
            }));
        }

        function getActionForInsight(insightType) {
            const actions = {
                'sleep_consistency': 'Set a consistent bedtime and wake-up time',
                'sleep_quality': 'Aim for 7-9 hours of sleep each night',
                'study_consistency': 'Study at the same time each day',
                'study_intensity': 'Balance intense study days with lighter days',
                'strong_correlation': 'Use sleep data to predict and optimize study performance',
                'weekly_imbalance': 'Distribute study hours more evenly across the week',
                'goal_completion': 'Break large goals into smaller, manageable tasks',
                'burnout_risk': 'Schedule regular breaks and rest days'
            };
            
            return actions[insightType] || 'Review your data and adjust your approach';
        }

        function detectCorrelationPatterns() {
            const sleepStudy = calculateSleepStudyCorrelation();
            if (sleepStudy.matchedDays < 3) {
                return { 
                    insufficientData: true,
                    matchedDays: sleepStudy.matchedDays,
                    requiredDays: 3,
                    message: 'Need at least 3 days with both sleep and study data'
                };
            }
            
            const patterns = {
                relationships: {},
                thresholds: {},
                optimalRanges: {},
                impact: {},
                invertedU: detectInvertedURelationship(sleepStudy)
            };
            
            try {
                patterns.relationships = {
                    sleepStudyCorrelation: parseFloat(sleepStudy.correlation?.toFixed(3) || 0),
                    correlationStrength: getCorrelationStrength(sleepStudy.correlation),
                    direction: sleepStudy.correlation > 0 ? 'positive' : 'negative',
                    significance: calculateCorrelationSignificance(sleepStudy),
                    isLinear: checkLinearRelationship(sleepStudy),
                    isInvertedU: patterns.invertedU.isInvertedU,
                    invertedUConfidence: patterns.invertedU.confidence,
                    optimalSleep: patterns.invertedU.peak?.sleepHours
                };
                
                patterns.optimalRanges = {
                    bestStudyPerformance: patterns.invertedU.peak || 
                                        findOptimalSleepForStudy(sleepStudy),
                    sleepForPeakProductivity: patterns.invertedU.peak?.sleepHours || 
                                            calculateSleepForPeakProductivity(sleepStudy),
                    studyHoursForBestSleep: calculateStudyForBestSleep(sleepStudy)
                };
                
                patterns.impact = {
                    sleepImpactOnStudy: calculateSleepImpactOnStudy(sleepStudy),
                    marginalReturns: calculateMarginalReturns(sleepStudy)
                };
                
                patterns.thresholds = {
                    diminishingReturns: detectDiminishingReturns(sleepStudy)
                };

                patterns.metadata = {
                    matchedDays: sleepStudy.matchedDays,
                    totalDataPoints: sleepStudy.data?.length || 0,
                    calculationTimestamp: new Date().toISOString(),
                    confidenceScore: calculateOverallConfidence(sleepStudy, patterns),
                    dataRange: {
                        sleep: sleepStudy.data ? {
                            min: Math.min(...sleepStudy.data.map(d => d.sleep)),
                            max: Math.max(...sleepStudy.data.map(d => d.sleep)),
                            avg: sleepStudy.data.reduce((sum, d) => sum + d.sleep, 0) / sleepStudy.data.length
                        } : null,
                        study: sleepStudy.data ? {
                            min: Math.min(...sleepStudy.data.map(d => d.study)),
                            max: Math.max(...sleepStudy.data.map(d => d.study)),
                            avg: sleepStudy.data.reduce((sum, d) => sum + d.study, 0) / sleepStudy.data.length
                        } : null
                    }
                };
                
            } catch (error) {
                console.error('Error detecting correlation patterns:', error);
                patterns.error = error.message;
                patterns.partialData = true;
            }
            
            return patterns;
        }

        function calculateCorrelationSignificance(sleepStudy) {
            if (!sleepStudy) return 'insufficient_data';
            
            try {
                const n = sleepStudy.matchedDays || 0;
                const r = Math.abs(sleepStudy.correlation || 0);

                if (n < 3) return 'insufficient_data';
                const tStat = r * Math.sqrt((n - 2) / (1 - r * r));
                if (n >= 30 && Math.abs(tStat) > 2.75) return 'highly_significant'; 
                if (n >= 20 && Math.abs(tStat) > 2.09) return 'significant';       
                if (n >= 10 && r > 0.7) return 'high';                             
                if (n >= 5 && r > 0.5) return 'moderate';                          
                
                return 'low';                                                       
            } catch (error) {
                console.error('Error in calculateCorrelationSignificance:', error);
                return 'error';
            }
        }

        function checkLinearRelationship(sleepStudy) {
            if (!sleepStudy || !sleepStudy.correlation) return false;
            const r = Math.abs(sleepStudy.correlation);
            return r >= 0.3; 
        }

        function calculateOverallConfidence(sleepStudy, patterns) {
            let confidence = 50; 

            if (sleepStudy.matchedDays >= 10) confidence += 20;
            else if (sleepStudy.matchedDays >= 5) confidence += 10;

            const strength = getCorrelationStrength(sleepStudy.correlation);
            if (strength === 'strong') confidence += 15;
            else if (strength === 'moderate') confidence += 10;

            if (patterns.invertedU?.confidence >= 70) confidence += 15;
            
            return Math.min(100, Math.max(0, confidence));
        }

        function calculateSleepImpactOnStudy(sleepStudy) {
            if (!sleepStudy || !sleepStudy.correlation) return 'unknown';
            
            const r = Math.abs(sleepStudy.correlation);
            const rSquared = r * r;
            
            if (rSquared >= 0.49) return 'strong';        // â¥49% variance explained
            if (rSquared >= 0.25) return 'moderate';      // â¥25% variance explained
            if (rSquared >= 0.09) return 'weak';          // â¥9% variance explained
            return 'very_weak';                           // <9% variance explained
        }

        function calculateMarginalReturns(sleepStudy) {
            if (!sleepStudy || !sleepStudy.data || sleepStudy.data.length < 5) {
                return 'unknown';
            }
            
            try {
                const sorted = [...sleepStudy.data].sort((a, b) => a.sleep - b.sleep);
                const quartile = Math.floor(sorted.length / 4);
                
                if (quartile < 1) return 'unknown';
                
                const lowStudy = sorted.slice(0, quartile);
                const highStudy = sorted.slice(-quartile);
                
                const avgLowSleep = lowStudy.reduce((sum, d) => sum + d.sleep, 0) / lowStudy.length;
                const avgHighSleep = highStudy.reduce((sum, d) => sum + d.sleep, 0) / highStudy.length;
                
                const studyDiff = highStudy[0]?.study - lowStudy[0]?.study || 1;
                const sleepDiff = avgHighSleep - avgLowSleep;
                
                if (studyDiff === 0) return 'unknown';
                const returnRatio = sleepDiff / studyDiff;
                
                if (returnRatio > 0.5) return 'increasing';
                if (returnRatio > 0.2) return 'steady';
                if (returnRatio > 0) return 'diminishing';
                return 'negative';
            } catch (error) {
                console.error('Error calculating marginal returns:', error);
                return 'error';
            }
        }

        function detectDiminishingReturns(sleepStudy) {
            if (!sleepStudy || !sleepStudy.data || sleepStudy.data.length < 7) {
                return 'unknown';
            }
            
            try {
                const sorted = [...sleepStudy.data].sort((a, b) => a.sleep - b.study);
                const lowerHalf = sorted.slice(0, Math.floor(sorted.length / 2));
                const upperHalf = sorted.slice(Math.floor(sorted.length / 2));
                
                if (lowerHalf.length === 0 || upperHalf.length === 0) {
                    return 'unknown';
                }
                
                const avgSleepLower = lowerHalf.reduce((sum, d) => sum + d.sleep, 0) / lowerHalf.length;
                const avgSleepUpper = upperHalf.reduce((sum, d) => sum + d.sleep, 0) / upperHalf.length;
                
                const studyDiff = upperHalf[0]?.study - lowerHalf[0]?.study || 1;
                const sleepDiff = avgSleepUpper - avgSleepLower;
                
                const returnRatio = sleepDiff / studyDiff;
                
                if (returnRatio < 0) return 'negative after any study';
                if (returnRatio < 0.1) return 'diminishing after moderate study';
                if (returnRatio < 0.3) return 'diminishing after high study';
                return 'consistent';
            } catch (error) {
                console.error('Error detecting diminishing returns:', error);
                return 'error';
            }
        }

        function findOptimalSleepForStudy(sleepStudy) {
            if (!sleepStudy || !sleepStudy.data || sleepStudy.data.length < 3) {
                return null;
            }
            
            try {
                const sorted = [...sleepStudy.data]
                    .filter(d => d.sleep > 0 && d.study > 0)
                    .sort((a, b) => b.study - a.study);
                
                if (sorted.length < 3) return null;
                
                const topCount = Math.max(3, Math.ceil(sorted.length * 0.3));
                const topPerformers = sorted.slice(0, topCount);
                
                const avgSleep = topPerformers.reduce((sum, d) => sum + d.sleep, 0) / topPerformers.length;
                
                return {
                    sleepHours: parseFloat(avgSleep.toFixed(1)),
                    studyHours: parseFloat(topPerformers[0]?.study.toFixed(1) || 0),
                    sampleSize: topPerformers.length
                };
            } catch (error) {
                console.error('Error finding optimal sleep:', error);
                return null;
            }
        }

        function calculateSleepForPeakProductivity(sleepStudy) {
            const optimal = findOptimalSleepForStudy(sleepStudy);
            return optimal?.sleepHours || null;
        }

        function calculateStudyForBestSleep(sleepStudy) {
            if (!sleepStudy || !sleepStudy.data || sleepStudy.data.length < 3) {
                return null;
            }
            
            try {
                const sorted = [...sleepStudy.data]
                    .filter(d => d.sleep >= 7 && d.sleep <= 9) 
                    .sort((a, b) => b.study - a.study);
                
                if (sorted.length === 0) return null;
                
                return parseFloat(sorted[0]?.study.toFixed(1) || 0);
            } catch (error) {
                console.error('Error calculating study for best sleep:', error);
                return null;
            }
        }










// ====== INSOMNIA ANALYSIS SYSTEM ======

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (!document.getElementById('insomniaAnalysisContainer')) {
        const container = document.createElement('div');
        container.id = 'insomniaAnalysisContainer';
        document.body.appendChild(container);
    }
    
    setTimeout(() => {
        renderInsomniaAnalysis();
    }, 1000);
});

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (!document.getElementById('insomniaAnalysisContainer')) {
            addInsomniaSection();
        }
        renderInsomniaAnalysis();
    }, 1000);
});

// Main analysis function
function analyzeInsomniaPatterns() {
    if (!sleepSessions || sleepSessions.length < 5) {
        return {
            error: true,
            message: 'Need at least 5 sleep sessions for analysis',
            insomniaRisk: 'unknown'
        };
    }
    
    try {
        const analysis = {
            insomniaRisk: detectAllNighterRisk(),
            insomniaType: classifyInsomniaType(),
            sleepFragmentation: analyzeSleepFragmentation(),
            circadianDisruption: analyzeCircadianDisruption(),
            recoveryPatterns: analyzeRecoveryPatterns()
        };
        
        // Calculate derived metrics
        analysis.insomniaPenalty = calculateInsomniaPenalty(analysis);
        analysis.cognitiveEfficiency = calculateCognitiveEfficiency(analysis);
        analysis.insomniaSeverity = calculateInsomniaSeverity(analysis);
        analysis.recommendations = generateInsomniaRecommendations(analysis);
        
        return analysis;
        
    } catch (error) {
        console.error('Insomnia analysis error:', error);
        return {
            error: true,
            message: error.message,
            insomniaRisk: 'error'
        };
    }
}

// 1. Detect All-Nighter Risk
function detectAllNighterRisk() {
    if (!sleepSessions || sleepSessions.length < 2) return 'normal';
    
    const sortedSessions = [...sleepSessions].sort((a, b) => a.start - b.start);
    let maxAwakeHours = 0;
    let allNighterCount = 0;
    
    for (let i = 1; i < sortedSessions.length; i++) {
        const prevEnd = new Date(sortedSessions[i-1].end);
        const currStart = new Date(sortedSessions[i].start);
        const awakeHours = (currStart - prevEnd) / (1000 * 60 * 60);
        maxAwakeHours = Math.max(maxAwakeHours, awakeHours);
        if (awakeHours > 24) allNighterCount++;
    }
    
    if (maxAwakeHours > 36) return 'critical';
    if (maxAwakeHours > 24) return 'extreme';
    if (maxAwakeHours > 20) return 'high';
    return 'normal';
}

// 2. Classify Insomnia Type
function classifyInsomniaType() {
    const sessions = [...sleepSessions].sort((a, b) => a.start - b.start);
    const total = sessions.length;
    
    let sleepOnset = 0, maintenance = 0, earlyAwake = 0, nonRestorative = 0;
    
    sessions.forEach(session => {
        const startHour = new Date(session.start).getHours();
        const endHour = new Date(session.end).getHours();
        const duration = session.duration;
        
        if (startHour >= 2 && startHour <= 6) sleepOnset++;
        if (duration < 5) maintenance++;
        if (endHour >= 1 && endHour <= 5) earlyAwake++;
        if (duration >= 7 && duration <= 9 && hasLowQualityIndicators(session)) {
            nonRestorative++;
        }
    });
    
    const types = [];
    if (sleepOnset / total >= 0.3) types.push('sleep_onset');
    if (maintenance / total >= 0.3) types.push('maintenance');
    if (earlyAwake / total >= 0.3) types.push('early_awakening');
    if (nonRestorative / total >= 0.3) types.push('non_restorative');
    
    const typeDescriptions = {
        'sleep_onset': 'Difficulty falling asleep',
        'maintenance': 'Frequent nighttime awakenings',
        'early_awakening': 'Waking up too early',
        'non_restorative': 'Poor sleep quality despite duration'
    };
    
    return {
        primaryType: types[0] || 'mixed',
        allTypes: types,
        percentages: {
            sleepOnset: Math.round((sleepOnset / total) * 100),
            maintenance: Math.round((maintenance / total) * 100),
            earlyAwakening: Math.round((earlyAwake / total) * 100),
            nonRestorative: Math.round((nonRestorative / total) * 100)
        },
        description: types.map(t => typeDescriptions[t] || t).join(', ') || 'No specific pattern detected'
    };
}

// 3. Analyze Sleep Fragmentation
function analyzeSleepFragmentation() {
    const sorted = [...sleepSessions].sort((a, b) => a.start - b.start);
    const intervals = [];
    
    for (let i = 1; i < sorted.length; i++) {
        const interval = (new Date(sorted[i].start) - new Date(sorted[i-1].end)) / (1000 * 60 * 60);
        intervals.push(interval);
    }
    
    const fragmentedSessions = sorted.filter((session, idx) => {
        if (idx === 0) return false;
        const interval = intervals[idx-1];
        return interval < 12 && session.duration < 6;
    });
    
    const avgDuration = sorted.reduce((sum, s) => sum + s.duration, 0) / sorted.length;
    const avgInterval = intervals.length > 0 ? 
        intervals.reduce((sum, i) => sum + i, 0) / intervals.length : 24;
    
    return {
        isFragmented: fragmentedSessions.length >= sorted.length * 0.3,
        fragmentationScore: Math.round((fragmentedSessions.length / sorted.length) * 100),
        averageDuration: parseFloat(avgDuration.toFixed(1)),
        averageInterval: parseFloat(avgInterval.toFixed(1)),
        napPatterns: detectNapPatterns()
    };
}

// 4. Analyze Circadian Disruption
function analyzeCircadianDisruption() {
    const bedtimes = sleepSessions.map(s => {
        const d = new Date(s.start);
        return {
            hour: d.getHours(),
            minute: d.getMinutes(),
            weekday: d.getDay(),
            date: d
        };
    });
    
    const bedtimeHours = bedtimes.map(b => b.hour + b.minute/60);
    const avgBedtime = bedtimeHours.reduce((sum, h) => sum + h, 0) / bedtimeHours.length;
    const stdDev = calculateStandardDeviation(bedtimeHours);
    
    const weekdayBedtimes = bedtimes.filter(b => b.weekday >= 1 && b.weekday <= 5);
    const weekendBedtimes = bedtimes.filter(b => b.weekday === 0 || b.weekday === 6);
    
    const avgWeekday = weekdayBedtimes.length > 0 ? 
        weekdayBedtimes.reduce((sum, b) => sum + b.hour + b.minute/60, 0) / weekdayBedtimes.length : null;
    const avgWeekend = weekendBedtimes.length > 0 ? 
        weekendBedtimes.reduce((sum, b) => sum + b.hour + b.minute/60, 0) / weekendBedtimes.length : null;
    
    const socialJetlag = avgWeekday && avgWeekend ? Math.abs(avgWeekend - avgWeekday) : 0;
    const daytimeSleep = sleepSessions.filter(s => {
        const hour = new Date(s.start).getHours();
        return hour >= 6 && hour <= 18;
    }).length;
    
    return {
        circadianDisruption: stdDev > 3 ? 'severe' : stdDev > 2 ? 'moderate' : 'mild',
        bedtimeConsistency: Math.max(0, 100 - (stdDev * 10)),
        averageBedtime: formatTimeFromDecimal(avgBedtime),
        standardDeviation: parseFloat(stdDev.toFixed(1)),
        socialJetlag: parseFloat(socialJetlag.toFixed(1)),
        daytimeSleepPercentage: Math.round((daytimeSleep / sleepSessions.length) * 100),
        phaseShift: daytimeSleep > sleepSessions.length * 0.5 ? 'daytime_sleeper' : 'nighttime_sleeper'
    };
}

// 5. Analyze Recovery Patterns
function analyzeRecoveryPatterns() {
    if (sleepSessions.length < 7) return { insufficientData: true };
    
    const sorted = [...sleepSessions].sort((a, b) => a.start - b.start);
    const idealSleep = 7.5;
    let cumulativeDebt = 0;
    const recoveryCycles = [];
    const debtPatterns = [];
    
    for (let i = 0; i < sorted.length; i++) {
        const deficit = idealSleep - sorted[i].duration;
        if (deficit > 0) cumulativeDebt += deficit;
        
        if (i < sorted.length - 2 && deficit > 0) {
            const next = sorted[i + 1];
            const nextNext = sorted[i + 2];
            if (next.duration > idealSleep + 1 || nextNext.duration > idealSleep + 1) {
                recoveryCycles.push({
                    deficitDay: new Date(sorted[i].start).toLocaleDateString(),
                    deficitHours: parseFloat(deficit.toFixed(1)),
                    recoveryHours: Math.max(next.duration, nextNext.duration)
                });
            }
        }
        
        debtPatterns.push({
            duration: sorted[i].duration,
            deficit: deficit > 0 ? parseFloat(deficit.toFixed(1)) : 0
        });
    }
    
    const totalDebt = debtPatterns.reduce((sum, p) => sum + p.deficit, 0);
    const recoveryEfficiency = recoveryCycles.length > 0 ? 
        recoveryCycles.reduce((sum, r) => sum + r.recoveryHours, 0) / 
        recoveryCycles.reduce((sum, r) => sum + r.deficitHours, 0) : 0;
    
    return {
        hasRecoveryPatterns: recoveryCycles.length > 0,
        averageSleepDebt: parseFloat((totalDebt / sorted.length).toFixed(1)),
        cumulativeDebt: parseFloat(cumulativeDebt.toFixed(1)),
        recoveryEfficiency: parseFloat(recoveryEfficiency.toFixed(2)),
        recoveryCycles: recoveryCycles.slice(0, 3),
        debtAccumulationRate: parseFloat((cumulativeDebt / sorted.length).toFixed(2))
    };
}

// 6. Calculate Insomnia Penalty
function calculateInsomniaPenalty(analysis) {
    let totalPenalty = 0;
    const reasons = [];
    
    // Daytime sleep penalty
    const daytimeSleep = sleepSessions.filter(s => {
        const hour = new Date(s.start).getHours();
        return hour >= 6 && hour <= 18 && s.duration > 1;
    });
    
    if (daytimeSleep.length > 0) {
        const daySleepHours = daytimeSleep.reduce((sum, s) => sum + s.duration, 0);
        const penalty = Math.min(30, daySleepHours * 3);
        totalPenalty += penalty;
        reasons.push({
            type: 'daytime_sleep',
            hours: parseFloat(daySleepHours.toFixed(1)),
            penalty: penalty,
            message: `${daySleepHours.toFixed(1)}h of daytime sleep disrupts circadian rhythm`
        });
    }
    
    // All-nighter penalty
    const sorted = [...sleepSessions].sort((a, b) => a.start - b.start);
    for (let i = 1; i < sorted.length; i++) {
        const awakeHours = (new Date(sorted[i].start) - new Date(sorted[i-1].end)) / (1000 * 60 * 60);
        if (awakeHours > 24) {
            const penalty = Math.min(50, (awakeHours - 24) * 2);
            totalPenalty += penalty;
            reasons.push({
                type: 'all_nighter',
                awakeHours: parseFloat(awakeHours.toFixed(1)),
                penalty: penalty,
                message: `Awake for ${awakeHours.toFixed(1)}h - brain needs 48h to recover`
            });
        }
    }
    
    // Irregular schedule penalty
    const stdDev = analysis.circadianDisruption?.standardDeviation || 0;
    if (stdDev > 3) {
        const penalty = Math.min(20, (stdDev - 2) * 5);
        totalPenalty += penalty;
        reasons.push({
            type: 'irregular_schedule',
            stdDev: parseFloat(stdDev.toFixed(1)),
            penalty: penalty,
            message: `Bedtime varies by ${stdDev.toFixed(1)}h daily - brain cannot adapt`
        });
    }
    
    // Sleep debt penalty
    const sleepDebt = analysis.recoveryPatterns?.cumulativeDebt || 0;
    if (sleepDebt > 5) {
        const penalty = Math.min(40, sleepDebt * 2);
        totalPenalty += penalty;
        reasons.push({
            type: 'sleep_debt',
            debtHours: parseFloat(sleepDebt.toFixed(1)),
            penalty: penalty,
            message: `${sleepDebt.toFixed(1)}h sleep debt - reduces learning ability by 40%`
        });
    }
    
    return {
        totalPenalty: Math.min(100, totalPenalty),
        penaltyScore: Math.round(totalPenalty),
        penaltyLevel: totalPenalty >= 60 ? 'severe' : totalPenalty >= 30 ? 'moderate' : 'mild',
        reasons: reasons
    };
}

// 7. Calculate Cognitive Efficiency
function calculateCognitiveEfficiency(analysis) {
    const penalty = analysis.insomniaPenalty?.totalPenalty || 0;
    const severity = analysis.insomniaSeverity?.severityScore || 0;
    
    let baseEfficiency = 1.0;
    if (severity >= 80) baseEfficiency -= 0.5;
    else if (severity >= 60) baseEfficiency -= 0.35;
    else if (severity >= 40) baseEfficiency -= 0.2;
    else if (severity >= 20) baseEfficiency -= 0.1;
    
    const penaltyReduction = penalty / 200;
    baseEfficiency -= penaltyReduction;
    
    const finalEfficiency = Math.max(0.1, Math.min(1.0, baseEfficiency));
    
    const totalStudyHours = Object.values(dailyStudyData || {}).reduce((a, b) => a + (parseFloat(b) || 0), 0);
    const effectiveStudyHours = totalStudyHours * finalEfficiency;
    const wastedStudyHours = totalStudyHours - effectiveStudyHours;
    
    const efficiencyLevel = finalEfficiency >= 0.9 ? 'peak_performance' :
                          finalEfficiency >= 0.7 ? 'optimal' :
                          finalEfficiency >= 0.5 ? 'moderate' :
                          finalEfficiency >= 0.3 ? 'impaired' : 'severe_impairment';
    
    const brainStatus = {
        'peak_performance': 'ð§  Brain at peak performance - Learn 1 understand 1',
        'optimal': 'ð Good efficiency - Stable knowledge absorption',
        'moderate': 'â ï¸ Moderate efficiency - Need more effort',
        'impaired': 'ð« Brain fatigued - Learn 10 remember 5',
        'severe_impairment': 'ð¨ Brain exhausted - Learning is ineffective, need sleep now'
    }[efficiencyLevel] || '';
    
    return {
        efficiencyScore: parseFloat(finalEfficiency.toFixed(2)),
        efficiencyPercentage: Math.round(finalEfficiency * 100),
        efficiencyLevel: efficiencyLevel,
        brainStatus: brainStatus,
        studyROI: {
            totalStudyHours: parseFloat(totalStudyHours.toFixed(1)),
            effectiveStudyHours: parseFloat(effectiveStudyHours.toFixed(1)),
            wastedStudyHours: parseFloat(wastedStudyHours.toFixed(1)),
            wastePercentage: Math.round((wastedStudyHours / totalStudyHours) * 100) || 0
        }
    };
}

// 8. Calculate Insomnia Severity
function calculateInsomniaSeverity(analysis) {
    let severityScore = 0;
    const factors = [];
    
    const avgDuration = analysis.sleepFragmentation?.averageDuration || 0;
    if (avgDuration < 4) severityScore += 40, factors.push('very_short_sleep');
    else if (avgDuration < 6) severityScore += 30, factors.push('short_sleep');
    
    const fragScore = analysis.sleepFragmentation?.fragmentationScore || 0;
    if (fragScore > 50) severityScore += 30, factors.push('high_fragmentation');
    else if (fragScore > 30) severityScore += 20, factors.push('moderate_fragmentation');
    
    const circDisruption = analysis.circadianDisruption?.circadianDisruption;
    if (circDisruption === 'severe') severityScore += 40, factors.push('severe_circadian');
    else if (circDisruption === 'moderate') severityScore += 25, factors.push('moderate_circadian');
    
    const sleepDebt = analysis.recoveryPatterns?.cumulativeDebt || 0;
    if (sleepDebt > 10) severityScore += 35, factors.push('high_sleep_debt');
    else if (sleepDebt > 5) severityScore += 20, factors.push('moderate_sleep_debt');
    
    const insomniaType = analysis.insomniaType?.primaryType;
    if (insomniaType === 'mixed') severityScore += 25, factors.push('mixed_type');
    
    const severityLevel = severityScore >= 100 ? 'severe' :
                         severityScore >= 70 ? 'moderate_severe' :
                         severityScore >= 50 ? 'moderate' :
                         severityScore >= 30 ? 'mild' : 'subclinical';
    
    const interpretations = {
        'severe': 'Significant impact on daily functioning. Professional consultation recommended.',
        'moderate_severe': 'Noticeable impact on energy and mood. Behavioral interventions needed.',
        'moderate': 'Regular sleep difficulties affecting quality of life.',
        'mild': 'Occasional sleep problems with minimal functional impact.',
        'subclinical': 'Minor sleep variations within normal range.'
    };
    
    const actions = {
        'severe': 'Consult sleep specialist + implement CBT-I',
        'moderate_severe': 'Sleep restriction therapy + strict sleep hygiene',
        'moderate': 'Sleep schedule consolidation + relaxation techniques',
        'mild': 'Sleep hygiene improvement + stress management',
        'subclinical': 'Monitor patterns + maintain healthy habits'
    };
    
    return {
        severityScore: Math.min(100, severityScore),
        severityLevel: severityLevel,
        contributingFactors: factors,
        interpretation: interpretations[severityLevel] || 'Unable to determine severity.',
        suggestedAction: actions[severityLevel] || 'Continue tracking and maintain consistency'
    };
}

// 9. Generate Recommendations
function generateInsomniaRecommendations(analysis) {
    const recommendations = [];
    const riskLevel = analysis.insomniaRisk;
    const penalty = analysis.insomniaPenalty;
    const efficiency = analysis.cognitiveEfficiency;
    
    // Emergency: All-nighter detected
    if (riskLevel === 'extreme' || riskLevel === 'critical') {
        recommendations.push({
            priority: 'critical',
            action: 'ð¨ RESET CIRCADIAN RHYTHM WITH SUNLIGHT',
            rationale: 'Awake >24h completely disrupts circadian rhythm. Go outside for 30min of natural light tomorrow morning.',
            urgency: 'immediate'
        });
        
        recommendations.push({
            priority: 'critical',
            action: 'ð COMPENSATORY SLEEP & NO CAFFEINE',
            rationale: 'Brain needs 48h to recover from all-nighter. Take 1-2 short naps (20min) but avoid >6h daytime sleep.',
            urgency: 'immediate'
        });
    }

    // Penalty-based recommendations
    if (penalty?.reasons?.length > 0) {
        penalty.reasons.forEach(reason => {
            if (reason.type === 'daytime_sleep') {
                recommendations.push({
                    priority: 'high',
                    action: 'âï¸ RESTRICT DAYTIME SLEEP TO <1H',
                    rationale: `${reason.hours}h of daytime sleep disrupts night sleep drive. Limit naps to 20-30min before 3pm.`,
                    urgency: 'today'
                });
            }
            
            if (reason.type === 'all_nighter') {
                recommendations.push({
                    priority: 'high',
                    action: 'â° SET ALARM FOR BEDTIME 10PM TONIGHT',
                    rationale: `Awake ${reason.awakeHours}h requires immediate recovery. Sleep at least 7h tonight.`,
                    urgency: 'immediate'
                });
            }
            
            if (reason.type === 'irregular_schedule') {
                recommendations.push({
                    priority: 'medium',
                    action: 'ð FIXED BEDTIME WITHIN 30-MIN WINDOW',
                    rationale: `Bedtime varies ${reason.stdDev}h daily. Pick bedtime and stick to it Â±30min for 7 days.`,
                    urgency: 'this_week'
                });
            }
        });
    }

    // Cognitive efficiency recommendations
    if (efficiency?.efficiencyLevel === 'severe_impairment') {
        recommendations.push({
            priority: 'critical',
            action: 'ð¤ PRIORITIZE SLEEP OVER STUDYING TODAY',
            rationale: `Learning efficiency at ${efficiency.efficiencyPercentage}%. Sleep 7-8h tonight to restore brain function.`,
            urgency: 'immediate'
        });
    }

    if (efficiency?.studyROI?.wastePercentage > 50) {
        recommendations.push({
            priority: 'high',
            action: 'ð¯ STUDY IN 90-MIN FOCUS BLOCKS WITH BREAKS',
            rationale: `${efficiency.studyROI.wastePercentage}% of study time wasted. Use Pomodoro technique (25min study, 5min break).`,
            urgency: 'today'
        });
    }

    // Sleep type specific recommendations
    const insomniaType = analysis.insomniaType;
    if (insomniaType?.primaryType === 'sleep_onset') {
        recommendations.push({
            priority: 'medium',
            action: 'ðµ NO SCREENS 1H BEFORE BED',
            rationale: `Difficulty falling asleep reported ${insomniaType.percentages.sleepOnset}% of nights. Blue light suppresses melatonin.`,
            urgency: 'this_week'
        });
    }

    if (insomniaType?.primaryType === 'maintenance') {
        recommendations.push({
            priority: 'medium',
            action: 'ð° REDUCE FLUIDS 2H BEFORE BED',
            rationale: `Frequent awakenings ${insomniaType.percentages.maintenance}% of nights. Avoid caffeine/alcohol 6h before bed.`,
            urgency: 'this_week'
        });
    }

    // Add general recommendations if less than 3 specific ones
    if (recommendations.length < 3) {
        recommendations.push({
            priority: 'medium',
            action: 'ð CREATE BEDTIME RITUAL',
            rationale: 'Consistent pre-sleep routine signals brain to wind down. Try: 1) Warm shower 2) Light reading 3) 5-min breathing',
            urgency: 'this_week'
        });
        
        recommendations.push({
            priority: 'medium',
            action: 'ð¡ï¸ OPTIMIZE SLEEP ENVIRONMENT',
            rationale: 'Ideal: 18-20Â°C, pitch dark, white noise. Use eye mask and earplugs if needed.',
            urgency: 'this_week'
        });
    }

    // Sort by priority (critical â high â medium)
    const priorityOrder = { critical: 0, high: 1, medium: 2 };
    return recommendations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
}

// 10. Render Analysis Results
function renderInsomniaAnalysis() {
    const container = document.getElementById('insomniaAnalysisContainer');
    if (!container) return;
    
    const analysis = analyzeInsomniaPatterns();
    
    if (analysis.error) {
        container.innerHTML = `
            <div class="insomnia-analysis">
                <div class="insomnia-header">
                    <h3>â ï¸ Insufficient Data</h3>
                    <span class="severity-badge subclinical">Data Needed</span>
                </div>
                <p>${analysis.message || 'Need more sleep sessions to analyze insomnia patterns.'}</p>
            </div>
        `;
        return;
    }
    
    const severity = analysis.insomniaSeverity;
    const penalty = analysis.insomniaPenalty;
    const efficiency = analysis.cognitiveEfficiency;
    const insomniaType = analysis.insomniaType;
    
    let html = `
        <div class="insomnia-analysis">
            <div class="insomnia-header">
                <h3>ð´ Insomnia Pattern Analysis</h3>
                <div>
                    <span class="severity-badge ${severity.severityLevel.replace(' ', '_')}">
                        ${severity.severityLevel.replace('_', ' ').toUpperCase()}
                    </span>
                    ${penalty.totalPenalty > 30 ? `
                        <span class="risk-badge extreme-risk" style="margin-left: 12px;">
                            â ï¸ ${penalty.totalPenalty}% PENALTY
                        </span>
                    ` : ''}
                </div>
            </div>
            
            <div class="insomnia-grid">
                <div class="insomnia-card">
                    <h4>Avg. Sleep Duration</h4>
                    <div class="insomnia-value">${analysis.sleepFragmentation.averageDuration}h</div>
                    <div class="insomnia-description">
                        ${analysis.sleepFragmentation.averageDuration < 6 ? 
                          'â Below recommended 7-9h' : 
                          analysis.sleepFragmentation.averageDuration < 7 ? 
                          'â ï¸ Slightly insufficient' : 'â Within healthy range'}
                    </div>
                </div>
                
                <div class="insomnia-card">
                    <h4>Sleep Fragmentation</h4>
                    <div class="insomnia-value">${analysis.sleepFragmentation.fragmentationScore}%</div>
                    <div class="insomnia-description">
                        ${analysis.sleepFragmentation.isFragmented ? 
                          'â High fragmentation' : 
                          'â Good continuity'}
                    </div>
                </div>
                
                <div class="insomnia-card">
                    <h4>Circadian Consistency</h4>
                    <div class="insomnia-value">${analysis.circadianDisruption.bedtimeConsistency}%</div>
                    <div class="insomnia-description">
                        ${analysis.circadianDisruption.circadianDisruption === 'severe' ? 
                          'â Severe disruption' : 
                          analysis.circadianDisruption.circadianDisruption === 'moderate' ? 
                          'â ï¸ Needs improvement' : 'â Good consistency'}
                    </div>
                </div>
                
                <div class="insomnia-card penalty-card">
                    <h4>Sleep Penalty Score</h4>
                    <div class="insomnia-value">${penalty.penaltyScore}%</div>
                    <div class="insomnia-description">
                        ${penalty.penaltyLevel === 'severe' ? 
                          'â Severe efficiency loss' : 
                          penalty.penaltyLevel === 'moderate' ? 
                          'â ï¸ Moderate impact' : 'â Minimal impact'}
                    </div>
                </div>
            </div>
            
            <div class="efficiency-section">
                <h4>ð Cognitive Efficiency Analysis</h4>
                <div class="brain-status">
                    ${efficiency.brainStatus}
                </div>
                
                <div class="efficiency-metrics">
                    <div class="metric-item">
                        <div class="metric-label">Learning Efficiency</div>
                        <div class="metric-value ${efficiency.efficiencyLevel === 'severe_impairment' ? 'low' : 
                                               efficiency.efficiencyLevel === 'impaired' ? 'medium' : 'high'}">
                            ${efficiency.efficiencyPercentage}%
                        </div>
                    </div>
                    
                    <div class="metric-item">
                        <div class="metric-label">Study Hours</div>
                        <div class="metric-value">${efficiency.studyROI.totalStudyHours}h</div>
                    </div>
                    
                    <div class="metric-item">
                        <div class="metric-label">Effective Hours</div>
                        <div class="metric-value high">${efficiency.studyROI.effectiveStudyHours}h</div>
                    </div>
                    
                    <div class="metric-item">
                        <div class="metric-label">Wasted Hours</div>
                        <div class="metric-value waste">${efficiency.studyROI.wastedStudyHours}h</div>
                    </div>
                </div>
                
                <div class="roi-visualization">
                    <div class="roi-bar">
                        <div class="roi-effective" style="width: ${100 - efficiency.studyROI.wastePercentage}%">
                            ${100 - efficiency.studyROI.wastePercentage}% Effective
                        </div>
                        <div class="roi-wasted" style="width: ${efficiency.studyROI.wastePercentage}%">
                            ${efficiency.studyROI.wastePercentage}% Wasted
                        </div>
                    </div>
                    <div class="roi-labels">
                        <span>High ROI Study</span>
                        <span>Low ROI Study</span>
                    </div>
                </div>
                
                ${efficiency.studyROI.wastePercentage > 40 ? `
                    <div class="efficiency-message">
                        â ï¸ <strong>Warning:</strong> ${efficiency.studyROI.wastePercentage}% of study time is wasted due to poor sleep.
                        <span class="highlight">Sleep 7h tonight to boost efficiency by ${Math.min(50, efficiency.studyROI.wastePercentage/2)}%</span>
                    </div>
                ` : ''}
            </div>
    `;
    
    // Show penalty details if any
    if (penalty.reasons && penalty.reasons.length > 0) {
        html += `
            <div class="penalty-details">
                <strong>â ï¸ Sleep Penalties Detected (${penalty.totalPenalty}% total):</strong>
                <ul>
                    ${penalty.reasons.map(r => `
                        <li>${r.message} <span class="penalty-score">+${r.penalty}%</span></li>
                    `).join('')}
                </ul>
            </div>
        `;
    }
    
    // Show insomnia type breakdown
    if (insomniaType && insomniaType.primaryType !== 'mixed') {
        html += `
            <div style="margin: 20px 0; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                <strong>Insomnia Type:</strong> ${insomniaType.description}
                <div style="display: flex; gap: 20px; margin-top: 12px; flex-wrap: wrap;">
                    ${Object.entries(insomniaType.percentages).map(([type, percent]) => `
                        <div style="text-align: center;">
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7)">${type.replace(/([A-Z])/g, ' $1')}</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: ${percent > 30 ? '#ff6b6b' : '#1dd1a1'}">
                                ${percent}%
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // Show recommendations
    if (analysis.recommendations && analysis.recommendations.length > 0) {
        html += `
            <div class="insomnia-recommendations">
                <h4>ð¯ Recommended Actions</h4>
                ${analysis.recommendations.map(rec => `
                    <div class="recommendation ${rec.priority}">
                        <div class="rec-icon">${rec.action.split(' ')[0]}</div>
                        <div class="rec-content">
                            <strong>${rec.action}</strong>
                            <p>${rec.rationale}</p>
                            <span class="urgency-tag ${rec.urgency.replace(' ', '_')}">
                                ${rec.urgency.toUpperCase()}
                            </span>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    // Emergency notice for critical cases
    if (severity.severityLevel === 'severe' || penalty.totalPenalty > 60) {
        html += `
            <div class="emergency-notice">
                <div class="emergency-icon">ð¨</div>
                <div class="emergency-content">
                    <h4>MEDICAL CONSULTATION RECOMMENDED</h4>
                    <p>Your sleep patterns indicate significant disruption that may require professional intervention:</p>
                    <ol>
                        <li><strong>Consult a sleep specialist</strong> - Chronic insomnia affects long-term health</li>
                        <li><strong>Consider Cognitive Behavioral Therapy for Insomnia (CBT-I)</strong> - Gold standard treatment</li>
                        <li><strong>Rule out medical conditions</strong> - Sleep apnea, thyroid issues, etc.</li>
                    </ol>
                    <p class="warning">Continuing with these sleep patterns may lead to: Depression, Weight gain, Memory problems, Weakened immune system</p>
                </div>
            </div>
        `;
    }
    
    html += `</div>`;
    container.innerHTML = html;
}

// ====== UTILITY FUNCTIONS ======

function hasLowQualityIndicators(session) {
    // Check for signs of poor sleep quality
    const start = new Date(session.start);
    const end = new Date(session.end);
    const duration = session.duration;
    
    // Very short sleep cycles (<1.5h intervals might indicate awakenings)
    const potentialAwakenings = duration / 1.5;
    return potentialAwakenings > 4; // More than 4 potential awakenings
}

function calculateStandardDeviation(values) {
    const avg = values.reduce((a, b) => a + b) / values.length;
    const squareDiffs = values.map(value => Math.pow(value - avg, 2));
    const avgSquareDiff = squareDiffs.reduce((a, b) => a + b) / squareDiffs.length;
    return Math.sqrt(avgSquareDiff);
}

function formatTimeFromDecimal(decimal) {
    const hour = Math.floor(decimal);
    const minute = Math.round((decimal - hour) * 60);
    return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
}

function detectNapPatterns() {
    const naps = sleepSessions.filter(s => {
        const hour = new Date(s.start).getHours();
        return (hour >= 6 && hour <= 18) && s.duration <= 3;
    });
    
    return {
        napCount: naps.length,
        totalNapHours: parseFloat(naps.reduce((sum, s) => sum + s.duration, 0).toFixed(1)),
        isCompensatory: naps.length > 0 && naps[0].duration > 2
    };
}

// ====== UI CONTROLS ======

function refreshInsomniaAnalysis() {
    const container = document.getElementById('insomniaAnalysisContainer');
    if (container) {
        container.style.opacity = '0.7';
        setTimeout(() => {
            renderInsomniaAnalysis();
            container.style.opacity = '1';
        }, 300);
    }
}

function toggleInsomniaDetails() {
    const container = document.getElementById('insomniaAnalysisContainer');
    if (container) {
        const details = container.querySelector('.efficiency-section, .penalty-details, .insomnia-recommendations');
        if (details) {
            details.style.display = details.style.display === 'none' ? 'block' : 'none';
        }
    }
}

// ====== EXPORT FUNCTION ======

function getInsomniaReport() {
    const analysis = analyzeInsomniaPatterns();
    return {
        timestamp: new Date().toISOString(),
        summary: {
            severity: analysis.insomniaSeverity?.severityLevel || 'unknown',
            penaltyScore: analysis.insomniaPenalty?.penaltyScore || 0,
            cognitiveEfficiency: analysis.cognitiveEfficiency?.efficiencyPercentage || 0,
            primaryIssue: analysis.insomniaType?.primaryType || 'unknown'
        },
        detailedAnalysis: analysis,
        recommendations: analysis.recommendations || []
    };
}

setInterval(() => {
    if (document.hasFocus()) {
        renderInsomniaAnalysis();
    }
}, 300000);


// ====== FIX ALL MISSING FUNCTIONS ======

// 1. Fix insomnia functions (náº¿u chÆ°a cÃ³)
if (typeof addInsomniaSection === 'undefined') {
    function addInsomniaSection() {
        // ÄÆ¡n giáº£n chá» gá»i render
        renderInsomniaAnalysis();
    }
}

// 2. Fix pattern detection functions
if (typeof calculateAveragePace === 'undefined') {
    function calculateAveragePace() {
        console.warn('calculateAveragePace not implemented');
        return 0;
    }
}

if (typeof identifyBurnoutRiskFactors === 'undefined') {
    function identifyBurnoutRiskFactors() {
        console.warn('identifyBurnoutRiskFactors not implemented');
        return [];
    }
}

if (typeof Patterns === 'undefined') {
    window.Patterns = {
        detectGoalPatterns: function() { return {}; },
        detectProductivityPatterns: function() { return {}; },
        detectPatterns: function() { return {}; }
    };
}

// 3. Fix insomnia functions Äáº§y Äá»§
if (typeof renderInsomniaAnalysis === 'undefined') {
    function renderInsomniaAnalysis() {
        console.error('Insomnia analysis script not loaded!');
        
        const container = document.getElementById('insomniaAnalysisContainer');
        if (!container) return;
        
        container.innerHTML = `
            <div style="padding: 20px; background: #1a237e; color: white; border-radius: 10px;">
                <h3>ð´ Insomnia Analysis</h3>
                <p>Loading insomnia analysis system...</p>
                <button onclick="loadInsomniaSystem()" style="background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-top: 10px;">
                    Load Insomnia System
                </button>
            </div>
        `;
    }
    
    function loadInsomniaSystem() {
        // Táº£i script insomnia
        const script = document.createElement('script');
        script.src = 'insomnia-analysis.js'; // Hoáº·c URL Äáº§y Äá»§
        document.head.appendChild(script);
        
        // Hiá»n thá» loading
        const container = document.getElementById('insomniaAnalysisContainer');
        container.innerHTML = '<p>Loading insomnia analysis...</p>';
        
        script.onload = function() {
            renderInsomniaAnalysis();
        };
    }
}


// ====== COMPLETE PATTERN DETECTION FUNCTIONS ======

// 1. Goal Pattern Functions
function calculateAveragePace(goals = []) {
    try {
        if (!goals || goals.length === 0) return 0;
        
        const completedGoals = goals.filter(g => g.progress >= 100);
        if (completedGoals.length === 0) return 0;
        
        const totalDays = completedGoals.reduce((sum, goal) => {
            if (!goal.created || !goal.completedAt) return sum;
            const created = new Date(goal.created);
            const completed = new Date(goal.completedAt);
            const days = Math.max(1, (completed - created) / (1000 * 60 * 60 * 24));
            return sum + days;
        }, 0);
        
        return totalDays / completedGoals.length;
    } catch (error) {
        console.error('calculateAveragePace error:', error);
        return 7; // Default: 7 days per goal
    }
}

function isAheadOfSchedule(goal) {
    if (!goal || !goal.deadline || !goal.created) return false;
    
    const deadline = new Date(goal.deadline);
    const created = new Date(goal.created);
    const today = new Date();
    
    const totalDays = Math.max(1, (deadline - created) / (1000 * 60 * 60 * 24));
    const daysPassed = Math.max(0, (today - created) / (1000 * 60 * 60 * 24));
    
    const expectedProgress = Math.min(100, (daysPassed / totalDays) * 100);
    return goal.progress > expectedProgress + 10; // 10% ahead
}

function isBehindSchedule(goal) {
    if (!goal || !goal.deadline || !goal.created) return false;
    
    const deadline = new Date(goal.deadline);
    const created = new Date(goal.created);
    const today = new Date();
    
    const totalDays = Math.max(1, (deadline - created) / (1000 * 60 * 60 * 24));
    const daysPassed = Math.max(0, (today - created) / (1000 * 60 * 60 * 24));
    
    const expectedProgress = Math.min(100, (daysPassed / totalDays) * 100);
    return goal.progress < expectedProgress - 20; // 20% behind
}

// 2. Productivity Pattern Functions
function identifyBurnoutRiskFactors(data = {}) {
    try {
        const risks = [];
        const now = new Date();
        
        // Check for overwork
        const dailyStudyData = data.dailyStudyData || window.dailyStudyData || {};
        const recentDays = Object.entries(dailyStudyData)
            .filter(([date, hours]) => {
                const dayDiff = (now - new Date(date)) / (1000 * 60 * 60 * 24);
                return dayDiff <= 7;
            })
            .map(([_, hours]) => parseFloat(hours) || 0);
        
        if (recentDays.length > 0) {
            const avgStudyHours = recentDays.reduce((a, b) => a + b, 0) / recentDays.length;
            if (avgStudyHours > 8) risks.push({ factor: 'overwork', severity: 'high', hours: avgStudyHours });
            if (avgStudyHours > 6 && avgStudyHours <= 8) risks.push({ factor: 'heavy_load', severity: 'medium', hours: avgStudyHours });
        }
        
        // Check sleep deprivation
        const sleepSessions = data.sleepSessions || window.sleepSessions || [];
        if (sleepSessions.length > 0) {
            const recentSleep = sleepSessions.filter(s => {
                const dayDiff = (now - new Date(s.start)) / (1000 * 60 * 60 * 24);
                return dayDiff <= 7;
            });
            
            if (recentSleep.length > 0) {
                const avgSleep = recentSleep.reduce((sum, s) => sum + s.duration, 0) / recentSleep.length;
                if (avgSleep < 5) risks.push({ factor: 'severe_sleep_deprivation', severity: 'critical', hours: avgSleep });
                else if (avgSleep < 6) risks.push({ factor: 'sleep_deprivation', severity: 'high', hours: avgSleep });
            }
        }
        
        // Check for no rest days
        const activityData = data.activityData || window.activityData || {};
        const hasRestDay = Object.values(activityData).some(hours => parseFloat(hours) < 2);
        if (!hasRestDay && Object.keys(activityData).length >= 7) {
            risks.push({ factor: 'no_rest_days', severity: 'medium' });
        }
        
        return risks;
    } catch (error) {
        console.error('identifyBurnoutRiskFactors error:', error);
        return [];
    }
}

function checkRecoveryIndicators(data = {}) {
    try {
        const indicators = [];
        const now = new Date();
        
        // Check sleep quality improvement
        const sleepSessions = data.sleepSessions || window.sleepSessions || [];
        if (sleepSessions.length >= 4) {
            const recentSleep = sleepSessions.slice(-3);
            const olderSleep = sleepSessions.slice(-6, -3);
            
            if (recentSleep.length >= 2 && olderSleep.length >= 2) {
                const recentAvg = recentSleep.reduce((s, a) => s + a.duration, 0) / recentSleep.length;
                const olderAvg = olderSleep.reduce((s, a) => s + a.duration, 0) / olderSleep.length;
                
                if (recentAvg > olderAvg + 1) {
                    indicators.push({
                        type: 'sleep_improvement',
                        improvement: parseFloat((recentAvg - olderAvg).toFixed(1)),
                        recentAvg: parseFloat(recentAvg.toFixed(1)),
                        olderAvg: parseFloat(olderAvg.toFixed(1))
                    });
                }
            }
        }
        
        // Check study consistency
        const dailyStudyData = data.dailyStudyData || window.dailyStudyData || {};
        const studyHours = Object.values(dailyStudyData).map(h => parseFloat(h) || 0);
        if (studyHours.length >= 7) {
            const stdDev = calculateStandardDeviation(studyHours);
            if (stdDev < 2) {
                indicators.push({ type: 'consistent_study_patterns', consistency: parseFloat(stdDev.toFixed(1)) });
            }
        }
        
        // Check goal completion rate
        const goals = data.goals || window.goals || [];
        if (goals.length >= 3) {
            const completed = goals.filter(g => g.progress >= 100);
            if (completed.length > 0) {
                const completionRate = (completed.length / goals.length) * 100;
                if (completionRate > 60) {
                    indicators.push({ type: 'good_goal_completion', rate: Math.round(completionRate) });
                }
            }
        }
        
        return indicators;
    } catch (error) {
        console.error('checkRecoveryIndicators error:', error);
        return [];
    }
}

// 3. Utility Functions
function calculateStandardDeviation(values) {
    if (!values || values.length === 0) return 0;
    const avg = values.reduce((a, b) => a + b) / values.length;
    const squareDiffs = values.map(value => Math.pow(value - avg, 2));
    const avgSquareDiff = squareDiffs.reduce((a, b) => a + b) / squareDiffs.length;
    return Math.sqrt(avgSquareDiff);
}

// 4. Complete Patterns Object
if (typeof Patterns === 'undefined') {
    window.Patterns = {
        detectGoalPatterns: function(goals = []) {
            try {
                const patterns = {
                    totalGoals: goals.length,
                    completedGoals: goals.filter(g => g.progress >= 100).length,
                    activeGoals: goals.filter(g => g.progress > 0 && g.progress < 100).length,
                    avgCompletionTime: calculateAveragePace(goals),
                    aheadOfSchedule: goals.filter(isAheadOfSchedule).length,
                    behindSchedule: goals.filter(isBehindSchedule).length,
                    completionRate: goals.length > 0 ? 
                        Math.round((goals.filter(g => g.progress >= 100).length / goals.length) * 100) : 0
                };
                
                // Detect patterns
                if (patterns.completionRate > 80) {
                    patterns.primaryPattern = 'high_achiever';
                    patterns.description = 'Excellent goal completion rate!';
                } else if (patterns.behindSchedule > patterns.aheadOfSchedule * 2) {
                    patterns.primaryPattern = 'falling_behind';
                    patterns.description = 'Multiple goals behind schedule';
                } else if (patterns.aheadOfSchedule > patterns.behindSchedule) {
                    patterns.primaryPattern = 'ahead_of_pace';
                    patterns.description = 'Maintaining good progress';
                } else {
                    patterns.primaryPattern = 'steady_progress';
                    patterns.description = 'Consistent goal tracking';
                }
                
                return patterns;
            } catch (error) {
                console.error('detectGoalPatterns error:', error);
                return { error: error.message };
            }
        },
        
        detectProductivityPatterns: function(data = {}) {
            try {
                const patterns = {
                    burnoutRisks: identifyBurnoutRiskFactors(data),
                    recoveryIndicators: checkRecoveryIndicators(data),
                    overallStatus: 'normal'
                };
                
                // Determine overall status
                const criticalRisks = patterns.burnoutRisks.filter(r => r.severity === 'critical');
                const highRisks = patterns.burnoutRisks.filter(r => r.severity === 'high');
                const recoverySigns = patterns.recoveryIndicators.length;
                
                if (criticalRisks.length > 0) {
                    patterns.overallStatus = 'critical_burnout_risk';
                    patterns.alert = 'Immediate intervention needed';
                } else if (highRisks.length >= 2) {
                    patterns.overallStatus = 'high_burnout_risk';
                    patterns.alert = 'Reduce workload immediately';
                } else if (highRisks.length === 1 && recoverySigns === 0) {
                    patterns.overallStatus = 'moderate_risk';
                    patterns.alert = 'Monitor closely';
                } else if (recoverySigns >= 2) {
                    patterns.overallStatus = 'recovering';
                    patterns.alert = 'Good recovery patterns';
                } else {
                    patterns.overallStatus = 'stable';
                    patterns.alert = 'Productivity patterns normal';
                }
                
                return patterns;
            } catch (error) {
                console.error('detectProductivityPatterns error:', error);
                return { error: error.message };
            }
        },
        
        detectPatterns: function(goals = [], data = {}) {
            try {
                return {
                    goals: this.detectGoalPatterns(goals),
                    productivity: this.detectProductivityPatterns(data),
                    timestamp: new Date().toISOString(),
                    recommendations: this.generateRecommendations(goals, data)
                };
            } catch (error) {
                console.error('detectPatterns error:', error);
                return { error: error.message };
            }
        },
        
        generateRecommendations: function(goals = [], data = {}) {
            const recommendations = [];
            const goalPatterns = this.detectGoalPatterns(goals);
            const prodPatterns = this.detectProductivityPatterns(data);
            
            // Goal-related recommendations
            if (goalPatterns.behindSchedule > 2) {
                recommendations.push({
                    priority: 'high',
                    type: 'goal_management',
                    action: 'Prioritize 1-2 most important goals',
                    reason: `${goalPatterns.behindSchedule} goals behind schedule`
                });
            }
            
            if (goalPatterns.completionRate < 50 && goals.length > 5) {
                recommendations.push({
                    priority: 'medium',
                    type: 'goal_setting',
                    action: 'Break large goals into smaller tasks',
                    reason: 'Low completion rate suggests goals may be too ambitious'
                });
            }
            
            // Productivity recommendations
            prodPatterns.burnoutRisks.forEach(risk => {
                if (risk.severity === 'critical' || risk.severity === 'high') {
                    recommendations.push({
                        priority: 'critical',
                        type: 'burnout_prevention',
                        action: risk.factor === 'overwork' ? 'Reduce daily study hours by 25%' :
                               risk.factor === 'sleep_deprivation' ? 'Aim for 7+ hours sleep tonight' :
                               'Take a complete rest day tomorrow',
                        reason: `${risk.severity} ${risk.factor.replace('_', ' ')} detected`
                    });
                }
            });
            
            // If no risks and good patterns, add positive reinforcement
            if (recommendations.length === 0 && goalPatterns.completionRate > 70) {
                recommendations.push({
                    priority: 'low',
                    type: 'maintenance',
                    action: 'Continue current productive patterns',
                    reason: 'Good progress and healthy habits detected'
                });
            }
            
            return recommendations.slice(0, 5); // Return top 5 recommendations
        }
    };
}

// 5. Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Pattern detection system loaded');
    
    // Auto-detect patterns after 2 seconds
    setTimeout(() => {
        if (typeof renderPatternInsights === 'function') {
            renderPatternInsights();
        }
    }, 2000);
});

// 6. Emergency export for debugging
window.PatternDetection = {
    calculateAveragePace,
    isAheadOfSchedule,
    isBehindSchedule,
    identifyBurnoutRiskFactors,
    checkRecoveryIndicators,
    calculateStandardDeviation
};


// ====== ADDITIONAL MISSING FUNCTIONS ======

// 1. Pacing Consistency
function calculatePacingConsistency(goals = []) {
    try {
        if (!goals || goals.length < 2) return 0;
        
        const activeGoals = goals.filter(g => g.progress > 0 && g.progress < 100);
        if (activeGoals.length < 2) return 0;
        
        // Calculate daily progress rates
        const dailyRates = activeGoals.map(goal => {
            if (!goal.created || !goal.deadline) return 0;
            
            const created = new Date(goal.created);
            const deadline = new Date(goal.deadline);
            const today = new Date();
            
            const totalDays = Math.max(1, (deadline - created) / (1000 * 60 * 60 * 24));
            const daysPassed = Math.max(0, (today - created) / (1000 * 60 * 60 * 24));
            
            if (daysPassed === 0) return 0;
            return goal.progress / daysPassed;
        });
        
        // Remove outliers
        const validRates = dailyRates.filter(rate => rate > 0);
        if (validRates.length < 2) return 0;
        
        // Calculate coefficient of variation (lower = more consistent)
        const avg = validRates.reduce((a, b) => a + b, 0) / validRates.length;
        const variance = validRates.reduce((sum, rate) => sum + Math.pow(rate - avg, 2), 0) / validRates.length;
        const stdDev = Math.sqrt(variance);
        const cv = stdDev / avg;
        
        // Convert to consistency score (0-100)
        const consistencyScore = Math.max(0, 100 - (cv * 100));
        return Math.round(consistencyScore);
    } catch (error) {
        console.error('calculatePacingConsistency error:', error);
        return 50;
    }
}

// 2. Sleep Pattern Analysis (for renderSleepPatternCard)
function analyzeSleepPatterns(sleepSessions = []) {
    try {
        if (!sleepSessions || sleepSessions.length < 3) {
            return { insufficientData: true, message: 'Need at least 3 sleep sessions' };
        }
        
        const sorted = [...sleepSessions].sort((a, b) => new Date(a.start) - new Date(b.start));
        
        // Calculate basic stats
        const durations = sorted.map(s => s.duration);
        const avgDuration = durations.reduce((a, b) => a + b, 0) / durations.length;
        const minDuration = Math.min(...durations);
        const maxDuration = Math.max(...durations);
        
        // Analyze bedtime consistency
        const bedtimes = sorted.map(s => {
            const d = new Date(s.start);
            return d.getHours() + d.getMinutes() / 60;
        });
        const bedtimeStdDev = calculateStandardDeviation(bedtimes);
        
        // Detect patterns
        const shortSleeps = durations.filter(d => d < 5).length;
        const longSleeps = durations.filter(d => d > 9).length;
        const normalSleeps = durations.filter(d => d >= 5 && d <= 9).length;
        
        // Analyze sleep timing
        const daySleeps = sorted.filter(s => {
            const hour = new Date(s.start).getHours();
            return hour >= 6 && hour <= 18;
        }).length;
        
        return {
            insufficientData: false,
            totalSessions: sorted.length,
            avgDuration: parseFloat(avgDuration.toFixed(1)),
            minDuration: parseFloat(minDuration.toFixed(1)),
            maxDuration: parseFloat(maxDuration.toFixed(1)),
            consistencyScore: Math.max(0, 100 - (bedtimeStdDev * 10)),
            bedtimeStdDev: parseFloat(bedtimeStdDev.toFixed(1)),
            pattern: avgDuration < 5 ? 'sleep_deprived' :
                    avgDuration > 9 ? 'oversleeping' :
                    bedtimeStdDev > 3 ? 'irregular_schedule' :
                    daySleeps > sorted.length * 0.3 ? 'daytime_sleeper' : 'healthy',
            recommendations: generateSleepRecommendations({
                avgDuration,
                bedtimeStdDev,
                shortSleeps,
                longSleeps,
                normalSleeps,
                daySleeps,
                total: sorted.length
            }),
            metrics: {
                shortSleepPercentage: Math.round((shortSleeps / sorted.length) * 100),
                normalSleepPercentage: Math.round((normalSleeps / sorted.length) * 100),
                longSleepPercentage: Math.round((longSleeps / sorted.length) * 100),
                daytimeSleepPercentage: Math.round((daySleeps / sorted.length) * 100)
            }
        };
    } catch (error) {
        console.error('analyzeSleepPatterns error:', error);
        return { 
            insufficientData: true, 
            error: error.message,
            message: 'Error analyzing sleep patterns'
        };
    }
}

function generateSleepRecommendations(data) {
    const recs = [];
    
    if (data.avgDuration < 5) {
        recs.push({
            priority: 'critical',
            action: 'Increase sleep to minimum 6 hours',
            reason: `Average sleep only ${data.avgDuration}h (need 7-9h)`
        });
    } else if (data.avgDuration > 9) {
        recs.push({
            priority: 'medium',
            action: 'Consider sleep quality over quantity',
            reason: `Average sleep ${data.avgDuration}h (excessive sleep can indicate poor quality)`
        });
    }
    
    if (data.bedtimeStdDev > 3) {
        recs.push({
            priority: 'high',
            action: 'Fix bedtime within 1-hour window',
            reason: `Bedtime varies ${data.bedtimeStdDev.toFixed(1)}h daily`
        });
    }
    
    if (data.daySleeps > data.total * 0.3) {
        recs.push({
            priority: 'medium',
            action: 'Limit daytime naps to 20 minutes',
            reason: `${Math.round((data.daySleeps/data.total)*100)}% of sleep is during daytime`
        });
    }
    
    if (recs.length === 0 && data.avgDuration >= 7 && data.avgDuration <= 9) {
        recs.push({
            priority: 'low',
            action: 'Maintain current healthy sleep habits',
            reason: 'Good sleep duration and consistency detected'
        });
    }
    
    return recs;
}

// 3. Fix detectGoalPatterns by adding the missing function call
if (typeof detectGoalPatterns === 'function') {
    const originalDetectGoalPatterns = detectGoalPatterns;
    detectGoalPatterns = function(goals) {
        try {
            const result = originalDetectGoalPatterns.call(this, goals);
            
            // Add pacing consistency if missing
            if (result && typeof result.pacingConsistency === 'undefined') {
                result.pacingConsistency = calculatePacingConsistency(goals);
                
                // Add interpretation
                if (result.pacingConsistency >= 80) {
                    result.pacingNote = 'Excellent pacing consistency';
                } else if (result.pacingConsistency >= 60) {
                    result.pacingNote = 'Good pacing consistency';
                } else if (result.pacingConsistency >= 40) {
                    result.pacingNote = 'Moderate pacing consistency';
                } else {
                    result.pacingNote = 'Inconsistent pacing - needs attention';
                }
            }
            
            return result;
        } catch (error) {
            console.error('Enhanced detectGoalPatterns error:', error);
            return originalDetectGoalPatterns.call(this, goals);
        }
    };
}

// 4. Fix renderSleepPatternCard by providing missing data
if (typeof renderSleepPatternCard === 'function') {
    const originalRenderSleepPatternCard = renderSleepPatternCard;
    renderSleepPatternCard = function(sleepPatterns) {
        try {
            // If sleepPatterns is undefined or has insufficientData, analyze fresh
            if (!sleepPatterns || sleepPatterns.insufficientData) {
                const analyzed = analyzeSleepPatterns(window.sleepSessions || []);
                return originalRenderSleepPatternCard.call(this, analyzed);
            }
            return originalRenderSleepPatternCard.call(this, sleepPatterns);
        } catch (error) {
            console.error('Enhanced renderSleepPatternCard error:', error);
            
            // Fallback display
            return `
                <div class="pattern-card">
                    <h4>ð´ Sleep Patterns</h4>
                    <div style="color: #ff6b6b; padding: 20px; text-align: center;">
                        <p>Unable to analyze sleep patterns</p>
                        <small>${error.message || 'Data unavailable'}</small>
                    </div>
                </div>
            `;
        }
    };
}

// 5. Utility function for sleep data
function getSleepData() {
    return window.sleepSessions || [];
}

// 6. Auto-initialize when needed
document.addEventListener('DOMContentLoaded', function() {
    // Ensure sleepPatterns object exists
    if (typeof window.sleepPatterns === 'undefined') {
        window.sleepPatterns = analyzeSleepPatterns(getSleepData());
    }
    
    // Patch existing functions after 1 second
    setTimeout(() => {
        console.log('Sleep pattern functions patched');
    }, 1000);
});

// 7. Export all functions
window.SleepPatterns = {
    analyzeSleepPatterns,
    generateSleepRecommendations,
    calculatePacingConsistency,
    getSleepData
};


// ====== FINAL COMPLETE FIX ======

// 1. Deadline Adherence
function calculateDeadlineAdherence(goals = []) {
    try {
        const completedGoals = goals.filter(g => g.progress >= 100 && g.deadline && g.completedAt);
        if (completedGoals.length === 0) return 50; // Default
        
        const adherenceScores = completedGoals.map(goal => {
            const deadline = new Date(goal.deadline);
            const completed = new Date(goal.completedAt);
            const daysDiff = (completed - deadline) / (1000 * 60 * 60 * 24);
            
            if (daysDiff <= 0) return 100; // Completed early or on time
            if (daysDiff <= 3) return 80;  // Slightly late
            if (daysDiff <= 7) return 60;  // Moderately late
            if (daysDiff <= 14) return 40; // Late
            return 20; // Very late
        });
        
        return Math.round(adherenceScores.reduce((a, b) => a + b, 0) / adherenceScores.length);
    } catch {
        return 50;
    }
}

// 2. Study Pattern Analysis
function analyzeStudyPatterns(studyData = {}) {
    try {
        const entries = Object.entries(studyData || {});
        if (entries.length < 3) {
            return { insufficientData: true, message: 'Need at least 3 days of study data' };
        }
        
        const hours = entries.map(([_, h]) => parseFloat(h) || 0);
        const dates = entries.map(([date, _]) => new Date(date));
        
        const totalHours = hours.reduce((a, b) => a + b, 0);
        const avgHours = totalHours / hours.length;
        const maxHours = Math.max(...hours);
        const consistency = calculateConsistencyScore(hours);
        
        // Detect patterns
        const highDays = hours.filter(h => h >= 6).length;
        const lowDays = hours.filter(h => h < 2).length;
        const mediumDays = hours.filter(h => h >= 2 && h < 6).length;
        
        let pattern = 'balanced';
        if (highDays > lowDays * 2) pattern = 'intense';
        if (lowDays > highDays * 2) pattern = 'sporadic';
        if (consistency > 80) pattern = 'consistent';
        if (maxHours > 10) pattern = 'burnout_risk';
        
        return {
            insufficientData: false,
            totalDays: hours.length,
            totalHours: parseFloat(totalHours.toFixed(1)),
            avgHours: parseFloat(avgHours.toFixed(1)),
            maxHours: parseFloat(maxHours.toFixed(1)),
            consistencyScore: consistency,
            pattern: pattern,
            distribution: {
                highDays: highDays,
                mediumDays: mediumDays,
                lowDays: lowDays,
                highPercentage: Math.round((highDays / hours.length) * 100),
                mediumPercentage: Math.round((mediumDays / hours.length) * 100),
                lowPercentage: Math.round((lowDays / hours.length) * 100)
            },
            recommendations: generateStudyRecommendations({
                avgHours,
                pattern,
                consistency,
                highDays,
                lowDays
            })
        };
    } catch {
        return { insufficientData: true, message: 'Error analyzing study patterns' };
    }
}

function calculateConsistencyScore(values) {
    if (values.length < 2) return 100;
    const avg = values.reduce((a, b) => a + b) / values.length;
    const deviations = values.map(v => Math.abs(v - avg) / avg);
    const avgDeviation = deviations.reduce((a, b) => a + b) / deviations.length;
    return Math.max(0, 100 - (avgDeviation * 100));
}

function generateStudyRecommendations(data) {
    const recs = [];
    
    if (data.pattern === 'burnout_risk') {
        recs.push({
            priority: 'critical',
            action: 'Reduce study load immediately',
            reason: 'Extremely long study hours detected'
        });
    }
    
    if (data.avgHours > 8) {
        recs.push({
            priority: 'high',
            action: 'Aim for 6-7 hours max per day',
            reason: `Average ${data.avgHours.toFixed(1)}h/day may lead to burnout`
        });
    } else if (data.avgHours < 2) {
        recs.push({
            priority: 'medium',
            action: 'Increase daily study time',
            reason: `Only ${data.avgHours.toFixed(1)}h/day average`
        });
    }
    
    if (data.consistency < 60) {
        recs.push({
            priority: 'medium',
            action: 'Create consistent study schedule',
            reason: `Inconsistent study patterns (${data.consistency}% consistency)`
        });
    }
    
    if (recs.length === 0 && data.avgHours >= 3 && data.avgHours <= 6) {
        recs.push({
            priority: 'low',
            action: 'Maintain current study habits',
            reason: 'Good balance detected'
        });
    }
    
    return recs;
}

// 3. Patch ALL missing functions at once
function patchAllMissingFunctions() {
    console.log('Patching all missing functions...');
    
    // List of all potentially missing functions
    const functionTemplates = {
        // Goal tracking functions
        'calculateDeadlineAdherence': calculateDeadlineAdherence,
        'calculateGoalDifficulty': () => 50,
        'calculateFocusEfficiency': () => 75,
        'identifyBlockedGoals': () => [],
        'calculateMotivationTrend': () => 'stable',
        
        // Study functions
        'analyzeStudyPatterns': analyzeStudyPatterns,
        'calculateStudyRetention': () => 65,
        'identifyOptimalStudyTimes': () => ['morning', 'evening'],
        'calculateProductivityScore': () => 70,
        
        // Sleep functions  
        'calculateSleepQuality': () => 75,
        'identifySleepDisruptors': () => [],
        'calculateRecoveryScore': () => 80,
        
        // General utility
        'formatTime': (hours) => `${Math.floor(hours)}h ${Math.round((hours % 1) * 60)}m`,
        'calculateTrend': (values) => values.length > 1 ? 
            ((values[values.length-1] - values[0]) / values[0] * 100).toFixed(1) : '0',
        'getCurrentStreak': () => 0,
        'getLongestStreak': () => 0
    };
    
    // Patch each missing function
    Object.entries(functionTemplates).forEach(([name, func]) => {
        if (typeof window[name] === 'undefined') {
            window[name] = func;
            console.log(`â Patched: ${name}`);
        }
    });
    
    // Ensure critical objects exist
    if (typeof window.sleepPatterns === 'undefined') {
        window.sleepPatterns = analyzeStudyPatterns(window.dailyStudyData || {});
    }
    
    if (typeof window.studyPatterns === 'undefined') {
        window.studyPatterns = analyzeStudyPatterns(window.dailyStudyData || {});
    }
    
    if (typeof window.goalPatterns === 'undefined') {
        window.goalPatterns = {
            pacingConsistency: 60,
            deadlineAdherence: 65,
            difficultyLevel: 'medium'
        };
    }
    
    console.log('All functions patched successfully');
}

// 4. Safe wrapper for render functions
function safeRenderSleepPatternCard(sleepPatterns) {
    try {
        if (!sleepPatterns || sleepPatterns.insufficientData) {
            const analyzed = analyzeStudyPatterns(window.dailyStudyData || {});
            return window.renderSleepPatternCard?.(analyzed) || 
                   '<div class="pattern-card"><h4>Sleep Analysis</h4><p>Data unavailable</p></div>';
        }
        return window.renderSleepPatternCard?.(sleepPatterns) || '';
    } catch {
        return '<div class="pattern-card"><h4>Sleep Analysis</h4><p>Error loading data</p></div>';
    }
}

function safeRenderStudyPatternCard(studyPatterns) {
    try {
        if (!studyPatterns || studyPatterns.insufficientData) {
            const analyzed = analyzeStudyPatterns(window.dailyStudyData || {});
            return window.renderStudyPatternCard?.(analyzed) || 
                   '<div class="pattern-card"><h4>Study Analysis</h4><p>Data unavailable</p></div>';
        }
        return window.renderStudyPatternCard?.(studyPatterns) || '';
    } catch {
        return '<div class="pattern-card"><h4>Study Analysis</h4><p>Error loading data</p></div>';
    }
}

// 5. Replace original functions with safe versions
function replaceWithSafeFunctions() {
    if (typeof window.renderSleepPatternCard === 'function') {
        window._originalRenderSleepPatternCard = window.renderSleepPatternCard;
        window.renderSleepPatternCard = safeRenderSleepPatternCard;
    }
    
    if (typeof window.renderStudyPatternCard === 'function') {
        window._originalRenderStudyPatternCard = window.renderStudyPatternCard;
        window.renderStudyPatternCard = safeRenderStudyPatternCard;
    }
    
    // Make detectGoalPatterns more robust
    if (typeof window.detectGoalPatterns === 'function') {
        window._originalDetectGoalPatterns = window.detectGoalPatterns;
        window.detectGoalPatterns = function(goals) {
            try {
                const result = window._originalDetectGoalPatterns(goals);
                // Ensure all required properties exist
                result.deadlineAdherence = result.deadlineAdherence || calculateDeadlineAdherence(goals);
                result.pacingConsistency = result.pacingConsistency || 50;
                return result;
            } catch {
                // Fallback result
                return {
                    totalGoals: goals?.length || 0,
                    completedGoals: goals?.filter(g => g.progress >= 100)?.length || 0,
                    deadlineAdherence: calculateDeadlineAdherence(goals),
                    pacingConsistency: 50,
                    error: 'Simplified analysis'
                };
            }
        };
    }
}

// 6. Initialize everything
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        patchAllMissingFunctions();
        replaceWithSafeFunctions();
        console.log('All systems patched and ready');
        
        // Force refresh if patterns are visible
        if (document.querySelector('.pattern-insights')) {
            setTimeout(() => {
                if (typeof window.renderPatternInsights === 'function') {
                    window.renderPatternInsights();
                }
            }, 500);
        }
    }, 1000);
});

// 7. Emergency export
window.AppPatcher = {
    patchAllMissingFunctions,
    safeRenderSleepPatternCard,
    safeRenderStudyPatternCard,
    analyzeStudyPatterns,
    calculateDeadlineAdherence
};

// ====== TARGETED FIX FOR CORRELATION PATTERNS ======

// 1. Function to analyze correlations between sleep, study, and goals
function analyzeCorrelations(data = {}) {
    try {
        const { 
            sleepSessions = [], 
            dailyStudyData = {}, 
            goals = [] 
        } = data;
        
        // If insufficient data, return empty but valid structure
        if (sleepSessions.length < 3 || Object.keys(dailyStudyData).length < 3) {
            return {
                hasData: false,
                message: 'Need more data for correlation analysis',
                relationships: [],
                strongestCorrelation: null,
                insights: []
            };
        }
        
        // Process last 7 days of data
        const last7Days = getLast7DaysData(sleepSessions, dailyStudyData);
        
        // Calculate correlations
        const relationships = calculateCorrelations(last7Days);
        
        // Generate insights
        const insights = generateCorrelationInsights(relationships);
        
        return {
            hasData: true,
            message: 'Correlation analysis complete',
            relationships: relationships,
            strongestCorrelation: findStrongestCorrelation(relationships),
            insights: insights,
            dataPoints: last7Days.length
        };
    } catch (error) {
        console.warn('Correlation analysis failed:', error);
        return {
            hasData: false,
            message: 'Analysis failed: ' + error.message,
            relationships: [],
            strongestCorrelation: null,
            insights: []
        };
    }
}

// 2. Get last 7 days of comparable data
function getLast7DaysData(sleepSessions, studyData) {
    const days = [];
    const today = new Date();
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        // Find sleep for this day
        const daySleep = sleepSessions.filter(s => {
            const sleepDate = new Date(s.start).toISOString().split('T')[0];
            return sleepDate === dateStr;
        });
        
        const totalSleep = daySleep.reduce((sum, s) => sum + s.duration, 0);
        const studyHours = parseFloat(studyData[dateStr] || 0);
        
        if (totalSleep > 0 && studyHours > 0) {
            days.push({
                date: dateStr,
                sleepHours: totalSleep,
                studyHours: studyHours,
                efficiency: calculateEfficiency(totalSleep, studyHours)
            });
        }
    }
    
    return days;
}

// 3. Calculate correlation coefficients
function calculateCorrelations(days) {
    if (days.length < 3) return [];
    
    const sleepHours = days.map(d => d.sleepHours);
    const studyHours = days.map(d => d.studyHours);
    const efficiencies = days.map(d => d.efficiency);
    
    // Sleep vs Study correlation
    const sleepStudyCorr = calculatePearsonCorrelation(sleepHours, studyHours);
    
    // Sleep vs Efficiency correlation  
    const sleepEffCorr = calculatePearsonCorrelation(sleepHours, efficiencies);
    
    return [
        {
            type: 'sleep_vs_study',
            correlation: sleepStudyCorr,
            strength: Math.abs(sleepStudyCorr),
            interpretation: interpretCorrelation(sleepStudyCorr, 'sleep', 'study time'),
            description: sleepStudyCorr > 0 ? 
                'More sleep â More study time' : 
                'More sleep â Less study time'
        },
        {
            type: 'sleep_vs_efficiency',
            correlation: sleepEffCorr,
            strength: Math.abs(sleepEffCorr),
            interpretation: interpretCorrelation(sleepEffCorr, 'sleep', 'study efficiency'),
            description: sleepEffCorr > 0 ? 
                'More sleep â Better efficiency' : 
                'More sleep â Worse efficiency'
        }
    ].filter(r => !isNaN(r.correlation));
}

// 4. Pearson correlation calculation
function calculatePearsonCorrelation(x, y) {
    if (x.length !== y.length || x.length < 2) return 0;
    
    const n = x.length;
    const sumX = x.reduce((a, b) => a + b, 0);
    const sumY = y.reduce((a, b) => a + b, 0);
    const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
    const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
    const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
    
    const numerator = n * sumXY - sumX * sumY;
    const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
    
    return denominator === 0 ? 0 : numerator / denominator;
}

// 5. Calculate efficiency score
function calculateEfficiency(sleepHours, studyHours) {
    // Simple efficiency model: optimal sleep is 7-8 hours
    const sleepFactor = sleepHours >= 7 && sleepHours <= 8 ? 1.0 :
                       sleepHours >= 6 && sleepHours < 7 ? 0.8 :
                       sleepHours > 8 && sleepHours <= 9 ? 0.7 : 0.5;
    
    // Study hours factor: optimal is 4-6 hours
    const studyFactor = studyHours >= 4 && studyHours <= 6 ? 1.0 :
                       studyHours > 2 && studyHours < 4 ? 0.8 :
                       studyHours > 6 && studyHours <= 8 ? 0.7 : 0.5;
    
    return sleepFactor * studyFactor;
}

// 6. Interpret correlation value
function interpretCorrelation(r, var1, var2) {
    const absR = Math.abs(r);
    
    if (absR < 0.3) return `No clear relationship between ${var1} and ${var2}`;
    if (absR < 0.5) return `Weak ${r > 0 ? 'positive' : 'negative'} relationship`;
    if (absR < 0.7) return `Moderate ${r > 0 ? 'positive' : 'negative'} relationship`;
    if (absR < 0.9) return `Strong ${r > 0 ? 'positive' : 'negative'} relationship`;
    return `Very strong ${r > 0 ? 'positive' : 'negative'} relationship`;
}

// 7. Find strongest correlation
function findStrongestCorrelation(relationships) {
    if (!relationships || relationships.length === 0) return null;
    
    return relationships.reduce((strongest, current) => 
        current.strength > strongest.strength ? current : strongest
    );
}

// 8. Generate insights from correlations
function generateCorrelationInsights(relationships) {
    const insights = [];
    
    relationships.forEach(rel => {
        if (Math.abs(rel.correlation) > 0.5) {
            if (rel.type === 'sleep_vs_study' && rel.correlation > 0) {
                insights.push({
                    type: 'positive_feedback',
                    message: 'Your sleep and study time are positively linked - good rest leads to more productive study sessions',
                    recommendation: 'Maintain this healthy cycle'
                });
            }
            
            if (rel.type === 'sleep_vs_efficiency' && rel.correlation > 0) {
                insights.push({
                    type: 'efficiency_insight',
                    message: 'Better sleep significantly improves your study efficiency',
                    recommendation: 'Prioritize 7-8 hours of sleep for maximum learning'
                });
            }
            
            if (rel.correlation < -0.5) {
                insights.push({
                    type: 'compensation_pattern',
                    message: 'You may be compensating for lack of sleep with more study time',
                    recommendation: 'Balance is key - avoid trading sleep for study'
                });
            }
        }
    });
    
    // Default insight if no strong correlations
    if (insights.length === 0 && relationships.length > 0) {
        insights.push({
            type: 'balanced_pattern',
            message: 'Your sleep and study patterns show a balanced, independent relationship',
            recommendation: 'Continue maintaining healthy habits'
        });
    }
    
    return insights;
}

// 9. SAFE VERSION of renderCorrelationPatternCard
function createSafeCorrelationCard() {
    try {
        // Get data from global scope
        const data = {
            sleepSessions: window.sleepSessions || [],
            dailyStudyData: window.dailyStudyData || {},
            goals: window.goals || []
        };
        
        const correlationData = analyzeCorrelations(data);
        
        return `
            <div class="pattern-card">
                <h4>ð Sleep-Study Correlations</h4>
                
                ${correlationData.hasData ? `
                    <div class="correlation-content">
                        ${correlationData.relationships.length > 0 ? `
                            <div class="correlation-metrics">
                                ${correlationData.relationships.map(rel => `
                                    <div class="correlation-item">
                                        <div class="correlation-label">${rel.type.replace(/_/g, ' ')}</div>
                                        <div class="correlation-value ${rel.correlation > 0 ? 'positive' : 'negative'}">
                                            ${rel.correlation.toFixed(2)}
                                        </div>
                                        <div class="correlation-desc">${rel.description}</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${correlationData.strongestCorrelation ? `
                                <div class="strongest-correlation">
                                    <strong>Strongest pattern:</strong> 
                                    ${correlationData.strongestCorrelation.interpretation}
                                </div>
                            ` : ''}
                            
                            ${correlationData.insights.length > 0 ? `
                                <div class="correlation-insights">
                                    ${correlationData.insights.map(insight => `
                                        <div class="insight-item">
                                            <div class="insight-message">${insight.message}</div>
                                            <div class="insight-recommendation">ð¡ ${insight.recommendation}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        ` : `
                            <div class="no-correlation">
                                <p>Not enough data to analyze correlations yet.</p>
                                <small>Track at least 3 days of both sleep and study data.</small>
                            </div>
                        `}
                    </div>
                ` : `
                    <div class="correlation-error">
                        <p>${correlationData.message}</p>
                    </div>
                `}
            </div>
        `;
        
    } catch (error) {
        console.error('Error in correlation card:', error);
        return `
            <div class="pattern-card">
                <h4>ð Correlation Analysis</h4>
                <div class="error-message">
                    <p>Unable to analyze correlations at the moment.</p>
                    <button onclick="location.reload()">Retry</button>
                </div>
            </div>
        `;
    }
}

// 10. Replace the broken function with our safe version
function patchCorrelationPatternCard() {
    console.log('Patching correlation pattern card...');
    
    // Store original if it exists
    if (typeof window.renderCorrelationPatternCard === 'function') {
        window._originalRenderCorrelationPatternCard = window.renderCorrelationPatternCard;
    }
    
    // Replace with safe version
    window.renderCorrelationPatternCard = function(correlationPatterns) {
        try {
            // If correlationPatterns is provided and valid, use original
            if (correlationPatterns && correlationPatterns.relationships) {
                return window._originalRenderCorrelationPatternCard 
                    ? window._originalRenderCorrelationPatternCard(correlationPatterns)
                    : createSafeCorrelationCard();
            }
            
            // Otherwise use our safe version
            return createSafeCorrelationCard();
            
        } catch (error) {
            console.warn('renderCorrelationPatternCard failed, using fallback:', error);
            return createSafeCorrelationCard();
        }
    };
    
    console.log('â Correlation card patched successfully');
}

// 11. Add minimal CSS for the card
function addCorrelationCardCSS() {
    if (!document.querySelector('#correlation-css')) {
        const style = document.createElement('style');
        style.id = 'correlation-css';
        style.textContent = `
            .correlation-content {
                padding: 15px 0;
            }
            .correlation-metrics {
                display: flex;
                flex-direction: column;
                gap: 15px;
                margin-bottom: 20px;
            }
            .correlation-item {
                background: rgba(255,255,255,0.05);
                padding: 12px;
                border-radius: 8px;
                border-left: 4px solid #3b82f6;
            }
            .correlation-label {
                font-size: 0.85rem;
                color: rgba(255,255,255,0.7);
                margin-bottom: 5px;
                text-transform: capitalize;
            }
            .correlation-value {
                font-size: 1.5rem;
                font-weight: bold;
                margin: 5px 0;
            }
            .correlation-value.positive { color: #10b981; }
            .correlation-value.negative { color: #ef4444; }
            .correlation-desc {
                font-size: 0.9rem;
                color: rgba(255,255,255,0.9);
            }
            .strongest-correlation {
                background: rgba(59, 130, 246, 0.1);
                padding: 12px;
                border-radius: 8px;
                margin: 15px 0;
                border-left: 4px solid #3b82f6;
            }
            .correlation-insights {
                margin-top: 20px;
            }
            .insight-item {
                background: rgba(255,255,255,0.03);
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 10px;
                border-left: 4px solid #10b981;
            }
            .insight-message {
                font-size: 0.9rem;
                margin-bottom: 5px;
                color: rgba(255,255,255,0.9);
            }
            .insight-recommendation {
                font-size: 0.85rem;
                color: #10b981;
                font-weight: 500;
            }
            .no-correlation, .correlation-error {
                text-align: center;
                padding: 30px 20px;
                color: rgba(255,255,255,0.7);
            }
            .error-message {
                text-align: center;
                padding: 20px;
                color: #ef4444;
            }
        `;
        document.head.appendChild(style);
    }
}

// 12. Initialize everything
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        addCorrelationCardCSS();
        patchCorrelationPatternCard();
        console.log('Correlation analysis system ready');
    }, 500);
});

// 13. Export for debugging
window.CorrelationAnalysis = {
    analyzeCorrelations,
    patchCorrelationPatternCard,
    createSafeCorrelationCard
};

function analyzeWeeklyPatterns(studyData = {}, sleepData = []) {
    try {
        const weekdays = [];
        const weekends = [];
        const today = new Date();
        
        // PhÃ¢n loáº¡i dá»¯ liá»u 14 ngÃ y gáº§n nháº¥t
        for (let i = 0; i < 14; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            
            // Láº¥y giá» há»c
            const studyHours = parseFloat(studyData[dateStr] || 0);
            
            // Láº¥y giá» ngá»§
            const daySleep = sleepData.filter(s => {
                const sleepDate = new Date(s.start).toISOString().split('T')[0];
                return sleepDate === dateStr;
            });
            const sleepHours = daySleep.reduce((sum, s) => sum + s.duration, 0);
            
            // PhÃ¢n loáº¡i ngÃ y trong tuáº§n (0=CN, 1=T2, ..., 6=T7)
            const dayOfWeek = date.getDay();
            
            if (dayOfWeek >= 1 && dayOfWeek <= 5) { // T2-T6
                if (studyHours > 0 || sleepHours > 0) {
                    weekdays.push({
                        date: dateStr,
                        studyHours,
                        sleepHours,
                        isWeekend: false
                    });
                }
            } else { // T7-CN
                if (studyHours > 0 || sleepHours > 0) {
                    weekends.push({
                        date: dateStr,
                        studyHours,
                        sleepHours,
                        isWeekend: true
                    });
                }
            }
        }
        
        // Kiá»m tra Äá»§ dá»¯ liá»u
        if (weekdays.length < 3 || weekends.length < 2) {
            return getDefaultWeeklyPatterns();
        }
        
        // TÃ­nh trung bÃ¬nh
        const weekdayStudyAvg = weekdays.reduce((sum, d) => sum + d.studyHours, 0) / weekdays.length;
        const weekendStudyAvg = weekends.reduce((sum, d) => sum + d.studyHours, 0) / weekends.length;
        
        const weekdaySleepAvg = weekdays.reduce((sum, d) => sum + d.sleepHours, 0) / weekdays.length;
        const weekendSleepAvg = weekends.reduce((sum, d) => sum + d.sleepHours, 0) / weekends.length;
        
        // XÃ¡c Äá»nh pattern
        let pattern = 'balanced';
        if (weekdayStudyAvg > weekendStudyAvg * 1.5) pattern = 'weekday_heavy';
        if (weekendStudyAvg > weekdayStudyAvg * 1.5) pattern = 'weekend_heavy';
        if (weekdaySleepAvg < 5 && weekendSleepAvg > 8) pattern = 'weekend_catchup';
        if (weekdayStudyAvg > 6 && weekendStudyAvg < 2) pattern = 'weekday_burnout';
        
        return {
            weekdayVsWeekend: {
                weekdayAvg: parseFloat(weekdayStudyAvg.toFixed(1)),
                weekendAvg: parseFloat(weekendStudyAvg.toFixed(1)),
                difference: parseFloat((weekdayStudyAvg - weekendStudyAvg).toFixed(1)),
                sleepDifference: parseFloat((weekdaySleepAvg - weekendSleepAvg).toFixed(1)),
                pattern: pattern,
                hasSufficientData: true
            },
            hasData: true,
            dataPoints: {
                weekdays: weekdays.length,
                weekends: weekends.length,
                total: weekdays.length + weekends.length
            },
            recommendations: generateWeeklyRecommendations(pattern, weekdayStudyAvg, weekendStudyAvg)
        };
        
    } catch (error) {
        console.error('Weekly pattern analysis error:', error);
        return getDefaultWeeklyPatterns();
    }
}

function generateWeeklyRecommendations(pattern, weekdayAvg, weekendAvg) {
    const recs = [];
    
    switch(pattern) {
        case 'weekday_heavy':
            recs.push({
                priority: 'medium',
                action: 'Distribute study time more evenly',
                reason: `Weekdays: ${weekdayAvg.toFixed(1)}h vs Weekends: ${weekendAvg.toFixed(1)}h`,
                tip: 'Try adding 1-2h of light review on weekends'
            });
            break;
            
        case 'weekend_heavy':
            recs.push({
                priority: 'medium',
                action: 'Add small daily study sessions',
                reason: `Weekends carry ${Math.round((weekendAvg/(weekdayAvg+weekendAvg))*100)}% of weekly study load`,
                tip: '20-30 minutes daily is better than 4h only on weekends'
            });
            break;
            
        case 'weekend_catchup':
            recs.push({
                priority: 'high',
                action: 'Improve weekday sleep consistency',
                reason: 'Sleeping in on weekends suggests weekday sleep deprivation',
                tip: 'Aim for consistent 7-8h sleep every night'
            });
            break;
            
        case 'weekday_burnout':
            recs.push({
                priority: 'high',
                action: 'Schedule weekend recovery time',
                reason: `Intense weekdays (${weekdayAvg.toFixed(1)}h/day) need proper recovery`,
                tip: 'Use weekends for active recovery: walks, hobbies, socializing'
            });
            break;
            
        default:
            recs.push({
                priority: 'low',
                action: 'Maintain balanced weekly schedule',
                reason: 'Good balance between weekdays and weekends detected',
                tip: 'Keep up the consistent effort!'
            });
    }
    
    return recs;
}


// ====== SLEEP DEBT CALCULATOR WITH COMPOUND INTEREST ======

// 1. Main Sleep Debt Calculator
function calculateSleepDebtWithInterest(sleepSessions = []) {
    try {
        if (!sleepSessions || sleepSessions.length < 2) {
            return {
                error: true,
                message: 'Need at least 2 sleep sessions to calculate debt',
                totalDebt: 0,
                debug: {
                    sessions: sleepSessions?.length || 0,
                    reason: 'insufficient_data'
                }
            };
        }
        
        const sorted = [...sleepSessions].sort((a, b) => a.start - b.start);
        
        console.log('â Processing sessions:', sorted.length);
        console.log('Date range:', 
            new Date(sorted[0].start).toLocaleDateString(), 
            'â', 
            new Date(sorted[sorted.length-1].start).toLocaleDateString()
        );
        
        const IDEAL_SLEEP = 7.5; // hours
        const INTEREST_RATE = 0.10; // 10% daily compound
        const REPAYMENT_EFFICIENCY = 0.6; // Only 60% of extra sleep pays debt
        
        let cumulativeDebt = 0;
        const debtHistory = [];
        let consecutiveDeficit = 0;
        let consecutiveSurplus = 0;
        let maxConsecDeficit = 0;
        let maxConsecSurplus = 0;
        
        sorted.forEach((session, index) => {
            const deficit = IDEAL_SLEEP - session.duration;
            const date = new Date(session.start);
            const dateStr = date.toISOString().split('T')[0];
            
            if (deficit > 0) {
                // Accumulate debt with compound interest
                cumulativeDebt = (cumulativeDebt * (1 + INTEREST_RATE)) + deficit;
                consecutiveDeficit++;
                maxConsecDeficit = Math.max(maxConsecDeficit, consecutiveDeficit);
                consecutiveSurplus = 0;
                
                debtHistory.push({
                    date: dateStr,
                    type: 'deficit',
                    hours: parseFloat(deficit.toFixed(1)),
                    debt: parseFloat(cumulativeDebt.toFixed(1)),
                    interest: parseFloat((cumulativeDebt * INTEREST_RATE).toFixed(1)),
                    sessionDuration: parseFloat(session.duration.toFixed(1))
                });
                
                console.log(`ð ${dateStr}: Slept ${session.duration}h â Deficit ${deficit.toFixed(1)}h â Total debt: ${cumulativeDebt.toFixed(1)}h`);
                
            } else {
                // Repay debt (but not 100% efficient)
                const surplus = -deficit;
                const repayment = surplus * REPAYMENT_EFFICIENCY;
                cumulativeDebt = Math.max(0, cumulativeDebt - repayment);
                consecutiveSurplus++;
                maxConsecSurplus = Math.max(maxConsecSurplus, consecutiveSurplus);
                consecutiveDeficit = 0;
                
                debtHistory.push({
                    date: dateStr,
                    type: 'surplus',
                    hours: parseFloat(surplus.toFixed(1)),
                    repayment: parseFloat(repayment.toFixed(1)),
                    debt: parseFloat(cumulativeDebt.toFixed(1)),
                    sessionDuration: parseFloat(session.duration.toFixed(1))
                });
                
                console.log(`ð ${dateStr}: Slept ${session.duration}h â Surplus ${surplus.toFixed(1)}h â Repaid ${repayment.toFixed(1)}h â Debt: ${cumulativeDebt.toFixed(1)}h`);
            }
        });
        
        // Calculate metrics
        const totalDeficit = debtHistory
            .filter(d => d.type === 'deficit')
            .reduce((sum, d) => sum + d.hours, 0);
        
        const totalSurplus = debtHistory
            .filter(d => d.type === 'surplus')
            .reduce((sum, d) => sum + d.hours, 0);
        
        const deficitDays = debtHistory.filter(d => d.type === 'deficit').length;
        const surplusDays = debtHistory.filter(d => d.type === 'surplus').length;
        
        const avgDeficit = deficitDays > 0 ? totalDeficit / deficitDays : 0;
        const avgSurplus = surplusDays > 0 ? totalSurplus / surplusDays : 0;
        
        // Generate recovery plan
        const recoveryPlan = generateDebtRecoveryPlan(cumulativeDebt);
        
        // Determine severity
        const severity = cumulativeDebt >= 30 ? 'critical' :
                        cumulativeDebt >= 20 ? 'severe' :
                        cumulativeDebt >= 10 ? 'high' :
                        cumulativeDebt >= 5 ? 'moderate' : 'low';
        
        console.log('â Final debt:', cumulativeDebt.toFixed(1), 'hours');
        console.log('Severity:', severity);
        
        return {
            error: false,
            totalDebt: parseFloat(cumulativeDebt.toFixed(1)),
            severity: severity,
            metrics: {
                totalDeficitHours: parseFloat(totalDeficit.toFixed(1)),
                totalSurplusHours: parseFloat(totalSurplus.toFixed(1)),
                avgDeficitPerNight: parseFloat(avgDeficit.toFixed(1)),
                avgSurplusPerNight: parseFloat(avgSurplus.toFixed(1)),
                deficitDays: deficitDays,
                surplusDays: surplusDays,
                interestRate: `${INTEREST_RATE * 100}%`,
                repaymentEfficiency: `${REPAYMENT_EFFICIENCY * 100}%`
            },
            patterns: {
                longestDeficitStreak: maxConsecDeficit,
                longestSurplusStreak: maxConsecSurplus,
                currentDeficitStreak: consecutiveDeficit,
                currentSurplusStreak: consecutiveSurplus,
                debtAccelerating: isDebtAccelerating(debtHistory),
                debtDecreasing: isDebtDecreasing(debtHistory)
            },
            debtHistory: debtHistory, // All history now
            recoveryPlan: recoveryPlan,
            warnings: generateDebtWarnings(cumulativeDebt, debtHistory),
            recommendations: generateDebtRecommendations(cumulativeDebt, severity),
            debug: {
                sessionsProcessed: sorted.length,
                dateRange: {
                    start: new Date(sorted[0].start).toLocaleDateString(),
                    end: new Date(sorted[sorted.length-1].start).toLocaleDateString()
                }
            }
        };
        
    } catch (error) {
        console.error('â Sleep debt calculation error:', error);
        return {
            error: true,
            message: error.message,
            totalDebt: 0,
            stack: error.stack
        };
    }
}

// 2. Generate Recovery Plan
function generateDebtRecoveryPlan(totalDebt) {
    if (totalDebt < 5) {
        return {
            phase: 'maintenance',
            duration: '7 days',
            targetSleep: '7.5h per night',
            expectedRecovery: 'Full recovery in 1 week',
            actions: [
                'Maintain consistent 7.5h sleep',
                'No need for catch-up sleep',
                'Focus on sleep quality'
            ]
        };
    }
    
    if (totalDebt < 15) {
        const daysNeeded = Math.ceil(totalDebt / 1.5);
        return {
            phase: 'moderate_recovery',
            duration: `${daysNeeded} days`,
            targetSleep: '9h per night',
            expectedRecovery: `Reduce debt by 60% in ${daysNeeded} days`,
            actions: [
                `Sleep 9h per night for ${daysNeeded} days`,
                'Go to bed 30 min earlier',
                'Take 20-min nap at 2pm if needed',
                'Avoid all-nighters completely'
            ],
            dailyReduction: '~1.5h debt per night',
            weeklyGoal: 'Reduce debt to <5h by end of week'
        };
    }
    
    // Severe debt (>15h)
    const phase1Days = 3;
    const phase2Days = 7;
    const phase3Days = 14;
    
    return {
        phase: 'aggressive_recovery',
        totalDuration: `${phase1Days + phase2Days + phase3Days} days`,
        phases: [
            {
                name: 'Phase 1: Emergency Recovery',
                duration: `${phase1Days} days`,
                targetSleep: '10h per night',
                actions: [
                    'ð¨ Clear schedule - prioritize sleep',
                    `Sleep 10h for ${phase1Days} consecutive nights`,
                    '30-min sunlight exposure at 8am',
                    'No caffeine after 12pm',
                    '20-min power nap at 2pm',
                    'No screens 2h before bed'
                ],
                expectedReduction: `~${(phase1Days * 1.8).toFixed(1)}h debt`
            },
            {
                name: 'Phase 2: Stabilization',
                duration: `${phase2Days} days`,
                targetSleep: '8.5h per night',
                actions: [
                    'Sleep 8.5h consistently',
                    'Fixed bedtime Â±15 min',
                    'Track sleep quality daily',
                    'Continue sunlight exposure',
                    'Light exercise (20-min walk)'
                ],
                expectedReduction: `~${(phase2Days * 1.2).toFixed(1)}h debt`
            },
            {
                name: 'Phase 3: Maintenance',
                duration: `${phase3Days} days`,
                targetSleep: '7.5-8h per night',
                actions: [
                    'Maintain 7.5-8h sleep',
                    'Weekend consistency (no catch-up)',
                    'Monthly sleep audit',
                    'Establish bedtime routine'
                ],
                expectedReduction: 'Eliminate remaining debt'
            }
        ],
        criticalWarning: 'â ï¸ Debt >15h requires immediate intervention. Consider consulting sleep specialist.',
        estimatedFullRecovery: `${phase1Days + phase2Days + phase3Days} days with strict adherence`
    };
}

// 3. Check if debt is accelerating
function isDebtAccelerating(debtHistory) {
    if (debtHistory.length < 4) return false;
    
    const recent = debtHistory.slice(-2);
    const older = debtHistory.slice(-4, -2);
    
    if (older.length < 2) return false;
    
    const recentAvg = recent.reduce((sum, d) => sum + d.debt, 0) / recent.length;
    const olderAvg = older.reduce((sum, d) => sum + d.debt, 0) / older.length;
    
    return recentAvg > olderAvg * 1.2; 
}

// 4. Check if debt is decreasing
function isDebtDecreasing(debtHistory) {
    if (debtHistory.length < 4) return false;
    
    const recent = debtHistory.slice(-2);
    const older = debtHistory.slice(-4, -2);
    
    if (older.length < 2) return false;
    
    const recentAvg = recent.reduce((sum, d) => sum + d.debt, 0) / recent.length;
    const olderAvg = older.reduce((sum, d) => sum + d.debt, 0) / older.length;
    
    return recentAvg < olderAvg * 0.8; 
}

// 5. Generate Warnings
function generateDebtWarnings(totalDebt, debtHistory) {
    const warnings = [];
    
    if (totalDebt >= 30) {
        warnings.push({
            level: 'critical',
            icon: 'ð¨',
            message: 'CRITICAL SLEEP DEBT: Your cognitive function is severely impaired',
            impact: 'Equivalent to being legally drunk (0.08% BAC)',
            action: 'Consult sleep specialist immediately'
        });
    }
    
    if (totalDebt >= 20) {
        warnings.push({
            level: 'severe',
            icon: 'â ï¸',
            message: 'SEVERE SLEEP DEBT: Health risks increase significantly',
            impact: 'Memory problems, weakened immune system, increased accident risk',
            action: 'Begin aggressive recovery protocol today'
        });
    }
    
    if (isDebtAccelerating(debtHistory)) {
        warnings.push({
            level: 'high',
            icon: 'ð',
            message: 'DEBT ACCELERATING: Pattern worsening recently',
            impact: 'Debt increasing - unsustainable pattern',
            action: 'Break the cycle now before it becomes chronic'
        });
    }
    
    if (totalDebt >= 10 && totalDebt < 20) {
        warnings.push({
            level: 'moderate',
            icon: 'â¡',
            message: 'MODERATE SLEEP DEBT: Performance noticeably impaired',
            impact: '30-40% reduction in learning efficiency',
            action: 'Implement recovery plan within 48 hours'
        });
    }
    
    return warnings;
}

// 6. Generate Recommendations
function generateDebtRecommendations(totalDebt, severity) {
    const recs = [];
    
    if (severity === 'critical' || severity === 'severe') {
        recs.push({
            priority: 'P0',
            timeframe: 'Immediate (today)',
            action: 'CLEAR TONIGHT\'S SCHEDULE',
            rationale: `${totalDebt}h debt = severe cognitive impairment`,
            steps: [
                '1. Cancel non-essential commitments tonight',
                '2. Set alarm for 10pm (bedtime)',
                '3. Target 10h sleep tonight',
                '4. No exceptions'
            ],
            expectedImpact: 'Reduce debt by ~2h, improve function by 15%'
        });
        
        recs.push({
            priority: 'P0',
            timeframe: 'Next 3 days',
            action: 'EMERGENCY RECOVERY MODE',
            rationale: 'Debt at dangerous level - requires aggressive intervention',
            steps: [
                '1. Sleep 9-10h for next 3 nights',
                '2. 20-min nap daily at 2pm',
                '3. 30-min morning sunlight',
                '4. Zero caffeine after noon'
            ],
            expectedImpact: 'Reduce debt by 40-50%'
        });
    }
    
    if (severity === 'high' || severity === 'moderate') {
        recs.push({
            priority: 'P1',
            timeframe: 'Next 7 days',
            action: 'STRUCTURED RECOVERY',
            rationale: `${totalDebt}h debt affecting performance`,
            steps: [
                '1. Sleep 8.5h per night this week',
                '2. Fixed bedtime (Â±15 min)',
                '3. Track progress daily',
                '4. Avoid weekend oversleep'
            ],
            expectedImpact: 'Reduce debt by 60-70%'
        });
    }
    
    recs.push({
        priority: 'P2',
        timeframe: 'Ongoing',
        action: 'PREVENT FUTURE DEBT',
        rationale: 'Break the debt cycle permanently',
        steps: [
            '1. Set hard bedtime (non-negotiable)',
            '2. Weekly sleep audit',
            '3. Debt threshold alert (<5h)',
            '4. Monthly consistency review'
        ],
        expectedImpact: 'Maintain debt <5h long-term'
    });
    
    return recs;
}

// 7. Render Sleep Debt Card
function renderSleepDebtCard() {
    const sleepSessions = window.sleepSessions || [];
    const debtData = calculateSleepDebtWithInterest(sleepSessions);
    
    if (debtData.error) {
        return `
            <div class="debt-card">
                <h4>ð¤ Sleep Debt Calculator</h4>
                <div class="debt-error">
                    <p>${debtData.message}</p>
                </div>
            </div>
        `;
    }
    
    const severityColors = {
        'critical': '#dc2626',
        'severe': '#ea580c',
        'high': '#f59e0b',
        'moderate': '#eab308',
        'low': '#10b981'
    };
    
    const severityColor = severityColors[debtData.severity] || '#6b7280';
    
    return `
        <div class="debt-card" style="
            background: linear-gradient(135deg, rgba(30,30,50,0.95) 0%, rgba(20,20,40,0.98) 100%);
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
            border: 2px solid ${severityColor}40;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        ">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h4 style="margin: 0; font-size: 1.3rem; color: #fff;">
                    ð¤ Sleep Debt Calculator
                </h4>
                <div style="
                    background: ${severityColor}20;
                    color: ${severityColor};
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 0.9rem;
                    font-weight: bold;
                    text-transform: uppercase;
                    border: 2px solid ${severityColor};
                ">
                    ${debtData.severity}
                </div>
            </div>
            
            <!-- Main Debt Display -->
            <div style="
                text-align: center;
                background: ${severityColor}10;
                padding: 32px 20px;
                border-radius: 12px;
                margin-bottom: 24px;
                border: 2px solid ${severityColor}30;
            ">
                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 8px;">
                    Total Sleep Debt (with compound interest)
                </div>
                <div style="font-size: 3.5rem; font-weight: bold; color: ${severityColor}; margin: 12px 0;">
                    ${debtData.totalDebt}h
                </div>
                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 8px;">
                    ${debtData.totalDebt >= 20 ? 'â ï¸ Equivalent to missing 3+ full nights of sleep' :
                      debtData.totalDebt >= 10 ? 'â¡ Equivalent to missing 1-2 full nights' :
                      'â Manageable debt level'}
                </div>
            </div>
            
            <!-- Metrics Grid -->
            <div style="
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
                margin-bottom: 24px;
            ">
                <div style="
                    background: rgba(255,255,255,0.05);
                    padding: 16px;
                    border-radius: 10px;
                    border-left: 4px solid #ef4444;
                ">
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 6px;">
                        Total Deficit
                    </div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #ef4444;">
                        ${debtData.metrics.totalDeficitHours}h
                    </div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px;">
                        Avg: ${debtData.metrics.avgDeficitPerNight}h/night
                    </div>
                </div>
                
                <div style="
                    background: rgba(255,255,255,0.05);
                    padding: 16px;
                    border-radius: 10px;
                    border-left: 4px solid #10b981;
                ">
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 6px;">
                        Total Surplus
                    </div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #10b981;">
                        ${debtData.metrics.totalSurplusHours}h
                    </div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px;">
                        Avg: ${debtData.metrics.avgSurplusPerNight}h/night
                    </div>
                </div>
                
                <div style="
                    background: rgba(255,255,255,0.05);
                    padding: 16px;
                    border-radius: 10px;
                    border-left: 4px solid #f59e0b;
                ">
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 6px;">
                        Interest Rate
                    </div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #f59e0b;">
                        ${debtData.metrics.interestRate}
                    </div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px;">
                        Daily compound
                    </div>
                </div>
                
                <div style="
                    background: rgba(255,255,255,0.05);
                    padding: 16px;
                    border-radius: 10px;
                    border-left: 4px solid #8b5cf6;
                ">
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 6px;">
                        Repayment Efficiency
                    </div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #8b5cf6;">
                        ${debtData.metrics.repaymentEfficiency}
                    </div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px;">
                        Of extra sleep
                    </div>
                </div>
            </div>
            
            <!-- Patterns -->
            ${debtData.patterns.debtAccelerating || debtData.patterns.debtDecreasing ? `
                <div style="
                    background: ${debtData.patterns.debtAccelerating ? 'rgba(239, 68, 68, 0.1)' : 'rgba(16, 185, 129, 0.1)'};
                    padding: 16px;
                    border-radius: 10px;
                    margin-bottom: 24px;
                    border-left: 4px solid ${debtData.patterns.debtAccelerating ? '#ef4444' : '#10b981'};
                ">
                    <div style="font-weight: bold; color: ${debtData.patterns.debtAccelerating ? '#ef4444' : '#10b981'}; margin-bottom: 8px;">
                        ${debtData.patterns.debtAccelerating ? 'ð DEBT ACCELERATING' : 'ð DEBT DECREASING'}
                    </div>
                    <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8);">
                        ${debtData.patterns.debtAccelerating ? 
                            'Your sleep debt is increasing by 20%+ week-over-week. This pattern is unsustainable.' :
                            'Good progress! Sleep debt has decreased by 20%+ this week. Keep it up!'}
                    </div>
                </div>
            ` : ''}
            
            <!-- Warnings -->
            ${debtData.warnings.length > 0 ? `
                <div style="margin-bottom: 24px;">
                    <div style="font-weight: bold; color: #fff; margin-bottom: 12px; font-size: 1.1rem;">
                        â ï¸ Warnings
                    </div>
                    ${debtData.warnings.map(warning => `
                        <div style="
                            background: rgba(239, 68, 68, 0.1);
                            padding: 16px;
                            border-radius: 10px;
                            margin-bottom: 12px;
                            border-left: 4px solid #ef4444;
                        ">
                            <div style="font-weight: bold; color: #ef4444; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2rem;">${warning.icon}</span>
                                <span>${warning.message}</span>
                            </div>
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8); margin-bottom: 8px;">
                                <strong>Impact:</strong> ${warning.impact}
                            </div>
                            <div style="font-size: 0.9rem; color: #fbbf24; font-weight: 500;">
                                â ${warning.action}
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            <!-- Recovery Plan -->
            <div style="margin-bottom: 24px;">
                <div style="font-weight: bold; color: #fff; margin-bottom: 12px; font-size: 1.1rem;">
                    ð¯ Recovery Plan
                </div>
                
                ${debtData.recoveryPlan.phases ? `
                    ${debtData.recoveryPlan.criticalWarning ? `
                        <div style="
                            background: rgba(220, 38, 38, 0.15);
                            padding: 16px;
                            border-radius: 10px;
                            margin-bottom: 16px;
                            border: 2px solid #dc2626;
                            color: #fca5a5;
                            font-weight: 500;
                        ">
                            ${debtData.recoveryPlan.criticalWarning}
                        </div>
                    ` : ''}
                    
                    ${debtData.recoveryPlan.phases.map((phase, index) => `
                        <div style="
                            background: rgba(255,255,255,0.05);
                            padding: 18px;
                            border-radius: 10px;
                            margin-bottom: 14px;
                            border-left: 4px solid ${index === 0 ? '#dc2626' : index === 1 ? '#f59e0b' : '#10b981'};
                        ">
                            <div style="font-weight: bold; color: #fff; margin-bottom: 10px; font-size: 1.05rem;">
                                ${phase.name}
                            </div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 12px;">
                                Duration: ${phase.duration} | Target: ${phase.targetSleep}
                            </div>
                            <ul style="margin: 0; padding-left: 20px; color: rgba(255,255,255,0.85); font-size: 0.9rem;">
                                ${phase.actions.map(action => `
                                    <li style="margin-bottom: 6px;">${action}</li>
                                `).join('')}
                            </ul>
                            <div style="
                                margin-top: 12px;
                                padding: 10px;
                                background: rgba(16, 185, 129, 0.1);
                                border-radius: 6px;
                                font-size: 0.85rem;
                                color: #10b981;
                            ">
                                â Expected: ${phase.expectedReduction}
                            </div>
                        </div>
                    `).join('')}
                    
                    <div style="
                        text-align: center;
                        margin-top: 16px;
                        padding: 14px;
                        background: rgba(59, 130, 246, 0.1);
                        border-radius: 10px;
                        color: #60a5fa;
                        font-weight: 500;
                    ">
                        â±ï¸ Estimated Full Recovery: ${debtData.recoveryPlan.estimatedFullRecovery}
                    </div>
                ` : `
                    <div style="
                        background: rgba(255,255,255,0.05);
                        padding: 18px;
                        border-radius: 10px;
                        border-left: 4px solid #10b981;
                    ">
                        <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">
                            ${debtData.recoveryPlan.phase.toUpperCase()}
                        </div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8); margin-bottom: 12px;">
                            Duration: ${debtData.recoveryPlan.duration} | Target: ${debtData.recoveryPlan.targetSleep}
                        </div>
                        <ul style="margin: 0; padding-left: 20px; color: rgba(255,255,255,0.85);">
                            ${debtData.recoveryPlan.actions.map(action => `
                                <li style="margin-bottom: 6px;">${action}</li>
                            `).join('')}
                        </ul>
                        <div style="
                            margin-top: 12px;
                            padding: 10px;
                            background: rgba(16, 185, 129, 0.1);
                            border-radius: 6px;
                            font-size: 0.85rem;
                            color: #10b981;
                        ">
                            â ${debtData.recoveryPlan.expectedRecovery}
                        </div>
                    </div>
                `}
            </div>
            
            <!-- Recommendations -->
            <div>
                <div style="font-weight: bold; color: #fff; margin-bottom: 12px; font-size: 1.1rem;">
                    ð¡ Action Items
                </div>
                ${debtData.recommendations.map(rec => `
                    <div style="
                        background: rgba(255,255,255,0.05);
                        padding: 16px;
                        border-radius: 10px;
                        margin-bottom: 12px;
                        border-left: 4px solid ${rec.priority === 'P0' ? '#dc2626' : rec.priority === 'P1' ? '#f59e0b' : '#10b981'};
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-weight: bold; color: #fff;">
                                ${rec.action}
                            </div>
                            <div style="
                                background: ${rec.priority === 'P0' ? '#dc2626' : rec.priority === 'P1' ? '#f59e0b' : '#10b981'};
                                color: white;
                                padding: 4px 10px;
                                border-radius: 12px;
                                font-size: 0.75rem;
                                font-weight: bold;
                            ">
                                ${rec.priority}
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 10px;">
                            â±ï¸ ${rec.timeframe}
                        </div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-bottom: 12px;">
                            ${rec.rationale}
                        </div>
                        <ol style="margin: 0; padding-left: 20px; color: rgba(255,255,255,0.85); font-size: 0.9rem;">
                            ${rec.steps.map(step => `
                                <li style="margin-bottom: 4px;">${step}</li>
                            `).join('')}
                        </ol>
                        <div style="
                            margin-top: 12px;
                            padding: 10px;
                            background: rgba(16, 185, 129, 0.1);
                            border-radius: 6px;
                            font-size: 0.85rem;
                            color: #10b981;
                            font-weight: 500;
                        ">
                            ð ${rec.expectedImpact}
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <!-- Debt History Chart (simple text-based) -->
            <div style="margin-top: 24px;">
                <div style="font-weight: bold; color: #fff; margin-bottom: 12px; font-size: 1.1rem;">
                    ð Debt History (Last 14 Days)
                </div>
                <div style="
                    background: rgba(255,255,255,0.03);
                    padding: 16px;
                    border-radius: 10px;
                    font-family: monospace;
                    font-size: 0.85rem;
                ">
                    ${debtData.debtHistory.slice(-7).map(entry => {
                        const barLength = Math.min(50, Math.round(entry.debt * 2));
                        const barColor = entry.type === 'deficit' ? '#ef4444' : '#10b981';
                        return `
                            <div style="margin-bottom: 8px;">
                                <div style="color: rgba(255,255,255,0.6); margin-bottom: 4px;">
                                    ${entry.date} | ${entry.type === 'deficit' ? 'ð' : 'ð'} ${entry.hours}h
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="
                                        height: 8px;
                                        width: ${barLength}%;
                                        background: ${barColor};
                                        border-radius: 4px;
                                    "></div>
                                    <span style="color: ${barColor}; font-weight: bold;">
                                        ${entry.debt}h
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;
}

// 8. Initialize Sleep Debt Card
document.addEventListener('DOMContentLoaded', function() {
    // Find or create container
    let container = document.getElementById('sleepDebtContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'sleepDebtContainer';
        
        // Insert after insomnia analysis if it exists
        const insomniaContainer = document.getElementById('insomniaAnalysisContainer');
        if (insomniaContainer) {
            insomniaContainer.parentNode.insertBefore(container, insomniaContainer.nextSibling);
        } else {
            document.body.appendChild(container);
        }
    }
    
    // Render after 1 second
    setTimeout(() => {
        container.innerHTML = renderSleepDebtCard();
    }, 1000);
});

// 9. Refresh function
function refreshSleepDebtCard() {
    const container = document.getElementById('sleepDebtContainer');
    if (container) {
        container.style.opacity = '0.7';
        setTimeout(() => {
            container.innerHTML = renderSleepDebtCard();
            container.style.opacity = '1';
        }, 300);
    }
}

// 10. Export for debugging
window.SleepDebtCalculator = {
    calculate: calculateSleepDebtWithInterest,
    render: renderSleepDebtCard,
    refresh: refreshSleepDebtCard
};

console.log('ð¤ Sleep Debt Calculator loaded successfully!');

// ====== CSS FOR SLEEP DEBT CARD ======
const sleepDebtCSS = `
<style id="sleep-debt-css">
    .debt-card {
        background: linear-gradient(135deg, rgba(30,30,50,0.95) 0%, rgba(20,20,40,0.98) 100%);
        border-radius: 16px;
        padding: 24px;
        margin: 20px 0;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    .debt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }
    
    .debt-header h4 {
        margin: 0;
        font-size: 1.4rem;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .severity-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        text-transform: uppercase;
        border: 2px solid;
    }
    
    .severity-badge.critical {
        background: rgba(220, 38, 38, 0.2);
        color: #dc2626;
        border-color: #dc2626;
    }
    
    .severity-badge.severe {
        background: rgba(234, 88, 12, 0.2);
        color: #ea580c;
        border-color: #ea580c;
    }
    
    .severity-badge.high {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
        border-color: #f59e0b;
    }
    
    .severity-badge.moderate {
        background: rgba(234, 179, 8, 0.2);
        color: #eab308;
        border-color: #eab308;
    }
    
    .severity-badge.low {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border-color: #10b981;
    }
    
    .debt-main-display {
        text-align: center;
        padding: 32px 20px;
        border-radius: 12px;
        margin-bottom: 24px;
        border: 2px solid;
    }
    
    .debt-label {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.7);
        margin-bottom: 8px;
    }
    
    .debt-value {
        font-size: 3.5rem;
        font-weight: bold;
        margin: 12px 0;
    }
    
    .debt-sublabel {
        font-size: 0.85rem;
        color: rgba(255,255,255,0.6);
        margin-top: 8px;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    
    .metric-card {
        background: rgba(255,255,255,0.05);
        padding: 16px;
        border-radius: 10px;
        border-left: 4px solid;
    }
    
    .metric-card.deficit {
        border-left-color: #ef4444;
    }
    
    .metric-card.surplus {
        border-left-color: #10b981;
    }
    
    .metric-card.interest {
        border-left-color: #f59e0b;
    }
    
    .metric-card.efficiency {
        border-left-color: #8b5cf6;
    }
    
    .metric-label {
        font-size: 0.85rem;
        color: rgba(255,255,255,0.6);
        margin-bottom: 6px;
    }
    
    .metric-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 4px;
    }
    
    .metric-subvalue {
        font-size: 0.75rem;
        color: rgba(255,255,255,0.5);
    }
    
    .pattern-alert {
        padding: 16px;
        border-radius: 10px;
        margin-bottom: 24px;
        border-left: 4px solid;
    }
    
    .pattern-alert.accelerating {
        background: rgba(239, 68, 68, 0.1);
        border-left-color: #ef4444;
    }
    
    .pattern-alert.decreasing {
        background: rgba(16, 185, 129, 0.1);
        border-left-color: #10b981;
    }
    
    .pattern-alert-title {
        font-weight: bold;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .pattern-alert-message {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.8);
    }
    
    .warnings-section {
        margin-bottom: 24px;
    }
    
    .section-title {
        font-weight: bold;
        color: #fff;
        margin-bottom: 12px;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .warning-item {
        background: rgba(239, 68, 68, 0.1);
        padding: 16px;
        border-radius: 10px;
        margin-bottom: 12px;
        border-left: 4px solid #ef4444;
    }
    
    .warning-header {
        font-weight: bold;
        color: #ef4444;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.05rem;
    }
    
    .warning-impact {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.8);
        margin-bottom: 8px;
    }
    
    .warning-action {
        font-size: 0.9rem;
        color: #fbbf24;
        font-weight: 500;
    }
    
    .recovery-section {
        margin-bottom: 24px;
    }
    
    .recovery-phase {
        background: rgba(255,255,255,0.05);
        padding: 18px;
        border-radius: 10px;
        margin-bottom: 14px;
        border-left: 4px solid;
    }
    
    .recovery-phase.phase-1 {
        border-left-color: #dc2626;
    }
    
    .recovery-phase.phase-2 {
        border-left-color: #f59e0b;
    }
    
    .recovery-phase.phase-3 {
        border-left-color: #10b981;
    }
    
    .phase-name {
        font-weight: bold;
        color: #fff;
        margin-bottom: 10px;
        font-size: 1.05rem;
    }
    
    .phase-duration {
        font-size: 0.85rem;
        color: rgba(255,255,255,0.6);
        margin-bottom: 12px;
    }
    
    .phase-actions {
        margin: 0;
        padding-left: 20px;
        color: rgba(255,255,255,0.85);
        font-size: 0.9rem;
    }
    
    .phase-actions li {
        margin-bottom: 6px;
    }
    
    .phase-result {
        margin-top: 12px;
        padding: 10px;
        background: rgba(16, 185, 129, 0.1);
        border-radius: 6px;
        font-size: 0.85rem;
        color: #10b981;
    }
    
    .recovery-summary {
        text-align: center;
        margin-top: 16px;
        padding: 14px;
        background: rgba(59, 130, 246, 0.1);
        border-radius: 10px;
        color: #60a5fa;
        font-weight: 500;
    }
    
    .recommendations-section {
        margin-bottom: 24px;
    }
    
    .recommendation-item {
        background: rgba(255,255,255,0.05);
        padding: 16px;
        border-radius: 10px;
        margin-bottom: 12px;
        border-left: 4px solid;
    }
    
    .recommendation-item.p0 {
        border-left-color: #dc2626;
    }
    
    .recommendation-item.p1 {
        border-left-color: #f59e0b;
    }
    
    .recommendation-item.p2 {
        border-left-color: #10b981;
    }
    
    .rec-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .rec-title {
        font-weight: bold;
        color: #fff;
    }
    
    .rec-priority {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        color: white;
    }
    
    .rec-priority.p0 {
        background: #dc2626;
    }
    
    .rec-priority.p1 {
        background: #f59e0b;
    }
    
    .rec-priority.p2 {
        background: #10b981;
    }
    
    .rec-timeframe {
        font-size: 0.85rem;
        color: rgba(255,255,255,0.7);
        margin-bottom: 10px;
    }
    
    .rec-rationale {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.6);
        margin-bottom: 12px;
    }
    
    .rec-steps {
        margin: 0;
        padding-left: 20px;
        color: rgba(255,255,255,0.85);
        font-size: 0.9rem;
    }
    
    .rec-steps li {
        margin-bottom: 4px;
    }
    
    .rec-impact {
        margin-top: 12px;
        padding: 10px;
        background: rgba(16, 185, 129, 0.1);
        border-radius: 6px;
        font-size: 0.85rem;
        color: #10b981;
        font-weight: 500;
    }
    
    .history-section {
        margin-top: 24px;
    }
    
    .history-chart {
        background: rgba(255,255,255,0.03);
        padding: 16px;
        border-radius: 10px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
    }
    
    .history-entry {
        margin-bottom: 12px;
    }
    
    .history-date {
        color: rgba(255,255,255,0.6);
        margin-bottom: 4px;
    }
    
    .history-bar-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .history-bar {
        height: 8px;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .history-bar.deficit {
        background: #ef4444;
    }
    
    .history-bar.surplus {
        background: #10b981;
    }
    
    .history-value {
        font-weight: bold;
        min-width: 50px;
    }
    
    .debt-error {
        text-align: center;
        padding: 40px 20px;
        color: rgba(255,255,255,0.7);
    }
    
    .critical-warning {
        background: rgba(220, 38, 38, 0.15);
        padding: 16px;
        border-radius: 10px;
        margin-bottom: 16px;
        border: 2px solid #dc2626;
        color: #fca5a5;
        font-weight: 500;
    }
    
    @media (max-width: 768px) {
        .debt-card {
            padding: 16px;
        }
        
        .debt-value {
            font-size: 2.5rem;
        }
        
        .metrics-grid {
            grid-template-columns: 1fr;
        }
        
        .metric-value {
            font-size: 1.5rem;
        }
    }
</style>
`;

// Inject CSS
if (!document.getElementById('sleep-debt-css')) {
    document.head.insertAdjacentHTML('beforeend', sleepDebtCSS);
}

// ====== RENDER FUNCTION ======
function renderSleepDebtCard() {
    const sleepSessions = window.sleepSessions || [];
    const debtData = calculateSleepDebtWithInterest(sleepSessions);
    
    if (debtData.error) {
        return `
            <div class="debt-card">
                <h4>ð¤ Sleep Debt Calculator</h4>
                <div class="debt-error">
                    <p>${debtData.message}</p>
                    ${debtData.debug ? `
                        <small style="color: rgba(255,255,255,0.5); margin-top: 10px; display: block;">
                            Debug: ${debtData.debug.sessions} sessions | ${debtData.debug.reason}
                        </small>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    const severityColors = {
        'critical': '#dc2626',
        'severe': '#ea580c',
        'high': '#f59e0b',
        'moderate': '#eab308',
        'low': '#10b981'
    };
    
    const severityColor = severityColors[debtData.severity] || '#6b7280';
    
    return `
        <div class="debt-card" style="border: 2px solid ${severityColor}40;">
            <!-- Header -->
            <div class="debt-header">
                <h4>ð¤ Sleep Debt Calculator</h4>
                <div class="severity-badge ${debtData.severity}">
                    ${debtData.severity}
                </div>
            </div>
            
            <!-- Main Debt Display -->
            <div class="debt-main-display" style="
                background: ${severityColor}10;
                border-color: ${severityColor}30;
            ">
                <div class="debt-label">
                    Total Sleep Debt (with 10% compound interest)
                </div>
                <div class="debt-value" style="color: ${severityColor};">
                    ${debtData.totalDebt}h
                </div>
                <div class="debt-sublabel">
                    ${debtData.totalDebt >= 20 ? 'â ï¸ Equivalent to missing 3+ full nights of sleep' :
                      debtData.totalDebt >= 10 ? 'â¡ Equivalent to missing 1-2 full nights' :
                      debtData.totalDebt >= 5 ? 'ð Moderate debt - manageable' :
                      'â Low debt - good control'}
                </div>
            </div>
            
            <!-- Metrics Grid -->
            <div class="metrics-grid">
                <div class="metric-card deficit">
                    <div class="metric-label">Total Deficit</div>
                    <div class="metric-value" style="color: #ef4444;">
                        ${debtData.metrics.totalDeficitHours}h
                    </div>
                    <div class="metric-subvalue">
                        ${debtData.metrics.deficitDays} days | Avg: ${debtData.metrics.avgDeficitPerNight}h/night
                    </div>
                </div>
                
                <div class="metric-card surplus">
                    <div class="metric-label">Total Surplus</div>
                    <div class="metric-value" style="color: #10b981;">
                        ${debtData.metrics.totalSurplusHours}h
                    </div>
                    <div class="metric-subvalue">
                        ${debtData.metrics.surplusDays} days | Avg: ${debtData.metrics.avgSurplusPerNight}h/night
                    </div>
                </div>
                
                <div class="metric-card interest">
                    <div class="metric-label">Interest Rate</div>
                    <div class="metric-value" style="color: #f59e0b;">
                        ${debtData.metrics.interestRate}
                    </div>
                    <div class="metric-subvalue">
                        Daily compound
                    </div>
                </div>
                
                <div class="metric-card efficiency">
                    <div class="metric-label">Repayment Rate</div>
                    <div class="metric-value" style="color: #8b5cf6;">
                        ${debtData.metrics.repaymentEfficiency}
                    </div>
                    <div class="metric-subvalue">
                        Of extra sleep
                    </div>
                </div>
            </div>
            
            <!-- Patterns Alert -->
            ${debtData.patterns.debtAccelerating || debtData.patterns.debtDecreasing ? `
                <div class="pattern-alert ${debtData.patterns.debtAccelerating ? 'accelerating' : 'decreasing'}">
                    <div class="pattern-alert-title" style="color: ${debtData.patterns.debtAccelerating ? '#ef4444' : '#10b981'};">
                        ${debtData.patterns.debtAccelerating ? 'ð DEBT ACCELERATING' : 'ð DEBT DECREASING'}
                    </div>
                    <div class="pattern-alert-message">
                        ${debtData.patterns.debtAccelerating ? 
                            'Your sleep debt is increasing. This pattern is unsustainable and needs immediate attention.' :
                            'Good progress! Sleep debt has decreased. Keep maintaining healthy sleep habits!'}
                    </div>
                </div>
            ` : ''}
            
            <!-- Warnings -->
            ${debtData.warnings.length > 0 ? `
                <div class="warnings-section">
                    <div class="section-title">
                        â ï¸ Warnings
                    </div>
                    ${debtData.warnings.map(warning => `
                        <div class="warning-item">
                            <div class="warning-header">
                                <span>${warning.icon}</span>
                                <span>${warning.message}</span>
                            </div>
                            <div class="warning-impact">
                                <strong>Impact:</strong> ${warning.impact}
                            </div>
                            <div class="warning-action">
                                â ${warning.action}
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            <!-- Recovery Plan -->
            <div class="recovery-section">
                <div class="section-title">
                    ð¯ Recovery Plan
                </div>
                
                ${debtData.recoveryPlan.phases ? `
                    ${debtData.recoveryPlan.criticalWarning ? `
                        <div class="critical-warning">
                            ${debtData.recoveryPlan.criticalWarning}
                        </div>
                    ` : ''}
                    
                    ${debtData.recoveryPlan.phases.map((phase, index) => `
                        <div class="recovery-phase phase-${index + 1}">
                            <div class="phase-name">
                                ${phase.name}
                            </div>
                            <div class="phase-duration">
                                Duration: ${phase.duration} | Target: ${phase.targetSleep}
                            </div>
                            <ul class="phase-actions">
                                ${phase.actions.map(action => `
                                    <li>${action}</li>
                                `).join('')}
                            </ul>
                            <div class="phase-result">
                                â Expected: ${phase.expectedReduction}
                            </div>
                        </div>
                    `).join('')}
                    
                    <div class="recovery-summary">
                        â±ï¸ Estimated Full Recovery: ${debtData.recoveryPlan.estimatedFullRecovery}
                    </div>
                ` : `
                    <div class="recovery-phase phase-1">
                        <div class="phase-name">
                            ${debtData.recoveryPlan.phase.toUpperCase()}
                        </div>
                        <div class="phase-duration">
                            Duration: ${debtData.recoveryPlan.duration} | Target: ${debtData.recoveryPlan.targetSleep}
                        </div>
                        <ul class="phase-actions">
                            ${debtData.recoveryPlan.actions.map(action => `
                                <li>${action}</li>
                            `).join('')}
                        </ul>
                        <div class="phase-result">
                            â ${debtData.recoveryPlan.expectedRecovery}
                        </div>
                    </div>
                `}
            </div>
            
            <!-- Recommendations -->
            <div class="recommendations-section">
                <div class="section-title">
                    ð¡ Action Items
                </div>
                ${debtData.recommendations.map(rec => `
                    <div class="recommendation-item ${rec.priority.toLowerCase()}">
                        <div class="rec-header">
                            <div class="rec-title">
                                ${rec.action}
                            </div>
                            <div class="rec-priority ${rec.priority.toLowerCase()}">
                                ${rec.priority}
                            </div>
                        </div>
                        <div class="rec-timeframe">
                            â±ï¸ ${rec.timeframe}
                        </div>
                        <div class="rec-rationale">
                            ${rec.rationale}
                        </div>
                        <ol class="rec-steps">
                            ${rec.steps.map(step => `
                                <li>${step}</li>
                            `).join('')}
                        </ol>
                        <div class="rec-impact">
                            ð ${rec.expectedImpact}
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <!-- Debt History Chart -->
            <div class="history-section">
                <div class="section-title">
                    ð Debt History (Last ${Math.min(7, debtData.debtHistory.length)} Days)
                </div>
                <div class="history-chart">
                    ${debtData.debtHistory.slice(-7).map(entry => {
                        const barLength = Math.min(100, Math.round(entry.debt * 3));
                        const barColor = entry.type === 'deficit' ? '#ef4444' : '#10b981';
                        return `
                            <div class="history-entry">
                                <div class="history-date">
                                    ${entry.date} | ${entry.type === 'deficit' ? 'ð' : 'ð'} Slept: ${entry.sessionDuration}h (${entry.type === 'deficit' ? `deficit ${entry.hours}h` : `surplus ${entry.hours}h`})
                                </div>
                                <div class="history-bar-container">
                                    <div class="history-bar ${entry.type}" style="
                                        width: ${barLength}%;
                                        background: ${barColor};
                                    "></div>
                                    <span class="history-value" style="color: ${barColor};">
                                        ${entry.debt}h
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            ${debtData.debug ? `
                <div style="margin-top: 20px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; font-size: 0.8rem; color: rgba(255,255,255,0.5);">
                    <strong>Debug:</strong> Processed ${debtData.debug.sessionsProcessed} sessions | 
                    Date range: ${debtData.debug.dateRange.start} â ${debtData.debug.dateRange.end}
                </div>
            ` : ''}
        </div>
    `;
}

// ====== UPDATE REFRESH FUNCTION ======
function refreshSleepDebtCard() {
    const container = document.getElementById('sleepDebtContainer');
    if (container) {
        container.style.opacity = '0.7';
        setTimeout(() => {
            container.innerHTML = renderSleepDebtCard();
            container.style.opacity = '1';
        }, 300);
    }
}

// ====== AUTO-INITIALIZE ======
document.addEventListener('DOMContentLoaded', function() {
    let container = document.getElementById('sleepDebtContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'sleepDebtContainer';
        
        const insomniaContainer = document.getElementById('insomniaAnalysisContainer');
        if (insomniaContainer) {
            insomniaContainer.parentNode.insertBefore(container, insomniaContainer.nextSibling);
        } else {
            document.body.appendChild(container);
        }
    }
    
    setTimeout(() => {
        container.innerHTML = renderSleepDebtCard();
    }, 1000);
});

// ====== UPDATE EXPORTS ======
window.SleepDebtCalculator = {
    calculate: calculateSleepDebtWithInterest,
    render: renderSleepDebtCard,
    refresh: refreshSleepDebtCard
};

window.renderSleepDebtCard = renderSleepDebtCard;

console.log('â Sleep Debt Card CSS & Render function loaded!');
console.log('ð Rendering card...');

// Auto-render if container exists
setTimeout(() => {
    const container = document.getElementById('sleepDebtContainer');
    if (container) {
        container.innerHTML = renderSleepDebtCard();
    }
}, 500);
















// ====== OPTIMAL SLEEP WINDOW DETECTION SYSTEM ======
// ð¤ ML-Powered Sleep Optimization with Hybrid Visualization
// ð Complete implementation - Copy and paste ready

// ====== 1. INJECT HYBRID CSS ======
const optimalSleepHybridCSS = `
<style id="optimal-sleep-hybrid-css">
    .optimal-sleep-hybrid {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        border-radius: 20px;
        padding: 28px;
        margin: 24px 0;
        box-shadow: 0 12px 48px rgba(0,0,0,0.4);
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        border: 2px solid rgba(59, 130, 246, 0.3);
        position: relative;
        overflow: hidden;
    }
    
    .optimal-sleep-hybrid::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.1), transparent 70%);
    }
    
    .hybrid-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 20px;
        position: relative;
        z-index: 2;
    }
    
    .hybrid-header h3 {
        margin: 0;
        font-size: 1.6rem;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 16px;
        background: linear-gradient(135deg, #60a5fa, #a78bfa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .ml-badge {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        color: white;
        padding: 10px 20px;
        border-radius: 24px;
        font-size: 0.9rem;
        font-weight: bold;
        text-transform: uppercase;
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* ML Results Section */
    .ml-section {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
        border: 2px solid rgba(59, 130, 246, 0.3);
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 28px;
        position: relative;
        z-index: 2;
    }
    
    .optimal-display {
        text-align: center;
        padding: 32px;
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%);
        border-radius: 16px;
        margin-bottom: 32px;
        border: 2px solid rgba(16, 185, 129, 0.4);
        box-shadow: 0 8px 32px rgba(16, 185, 129, 0.2);
        position: relative;
        overflow: hidden;
    }
    
    .optimal-display::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #10b981, #059669);
    }
    
    .optimal-title {
        font-size: 1rem;
        color: rgba(255,255,255,0.7);
        margin-bottom: 16px;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        font-weight: 600;
    }
    
    .optimal-time {
        font-size: 3.5rem;
        font-weight: bold;
        background: linear-gradient(135deg, #10b981, #059669);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 20px 0;
        text-shadow: 0 0 30px rgba(16, 185, 129, 0.3);
    }
    
    .optimal-score {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
        padding: 12px 24px;
        border-radius: 24px;
        font-weight: bold;
        margin-top: 16px;
        border: 2px solid rgba(16, 185, 129, 0.3);
    }
    
    .score-badge {
        background: #10b981;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
    }
    
    /* Clusters Grid - From ML version */
    .clusters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }
    
    .cluster-card {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
        border-radius: 12px;
        padding: 20px;
        border-left: 4px solid;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .cluster-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.3);
    }
    
    .cluster-card.best {
        border-left-color: #10b981;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(15, 23, 42, 0.9) 100%);
        border: 2px solid rgba(16, 185, 129, 0.3);
    }
    
    .cluster-card.good {
        border-left-color: #3b82f6;
    }
    
    .cluster-card.poor {
        border-left-color: #ef4444;
    }
    
    .cluster-badge {
        position: absolute;
        top: 16px;
        right: 16px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 6px 14px;
        border-radius: 14px;
        font-size: 0.75rem;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .cluster-name {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.7);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }
    
    .cluster-time {
        font-size: 1.5rem;
        font-weight: bold;
        color: #fff;
        margin-bottom: 16px;
    }
    
    .cluster-stats {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .cluster-stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .stat-label {
        color: rgba(255,255,255,0.6);
        font-size: 0.85rem;
    }
    
    .stat-value {
        font-weight: bold;
        color: rgba(255,255,255,0.9);
        font-size: 0.95rem;
    }
    
    /* Heatmap - From v1 */
    .heatmap-section {
        margin: 32px 0;
    }
    
    .section-title {
        font-size: 1.3rem;
        font-weight: bold;
        color: #fff;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .heatmap-container {
        padding: 24px;
        background: rgba(15, 23, 42, 0.8);
        border-radius: 16px;
        border: 2px solid rgba(59, 130, 246, 0.2);
    }
    
    .heatmap-grid {
        display: grid;
        grid-template-columns: 70px repeat(7, 1fr);
        gap: 6px;
        font-family: 'SF Mono', 'Courier New', monospace;
        font-size: 0.8rem;
    }
    
    .heatmap-cell {
        aspect-ratio: 1;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    
    .heatmap-cell:hover {
        transform: scale(1.15);
        z-index: 10;
        box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }
    
    .heatmap-cell.empty { background: rgba(100,100,100,0.15); color: rgba(255,255,255,0.3); }
    .heatmap-cell.low { background: linear-gradient(135deg, rgba(239, 68, 68, 0.4), rgba(239, 68, 68, 0.2)); color: #fca5a5; }
    .heatmap-cell.medium { background: linear-gradient(135deg, rgba(245, 158, 11, 0.4), rgba(245, 158, 11, 0.2)); color: #fbbf24; }
    .heatmap-cell.good { background: linear-gradient(135deg, rgba(59, 130, 246, 0.4), rgba(59, 130, 246, 0.2)); color: #93c5fd; }
    .heatmap-cell.excellent { background: linear-gradient(135deg, rgba(16, 185, 129, 0.5), rgba(16, 185, 129, 0.3)); color: #10b981; }
    .heatmap-cell.current { border: 2px solid #f59e0b; }
    .heatmap-cell.recommended { border: 2px solid #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3); }
    
    .heatmap-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }
    
    /* Insights - From ML version */
    .insights-section {
        margin: 32px 0;
    }
    
    .insight-card {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        border-left: 4px solid;
        transition: all 0.3s ease;
    }
    
    .insight-card:hover {
        transform: translateX(4px);
    }
    
    .insight-card.high {
        border-left-color: #ef4444;
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(15, 23, 42, 0.9) 100%);
    }
    
    .insight-card.medium {
        border-left-color: #f59e0b;
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(15, 23, 42, 0.9) 100%);
    }
    
    .insight-card.low {
        border-left-color: #10b981;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(15, 23, 42, 0.9) 100%);
    }
    
    .insight-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }
    
    .insight-icon {
        font-size: 1.8rem;
    }
    
    .insight-title {
        font-weight: bold;
        color: #fff;
        font-size: 1.1rem;
    }
    
    .insight-message {
        color: rgba(255,255,255,0.85);
        line-height: 1.6;
        font-size: 0.95rem;
    }
    
    /* Schedule - From ML version */
    .schedule-card {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
        border-left: 4px solid;
        transition: all 0.3s ease;
    }
    
    .schedule-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    
    .schedule-card.p0 {
        border-left-color: #dc2626;
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.1) 0%, rgba(15, 23, 42, 0.9) 100%);
    }
    
    .schedule-card.p1 {
        border-left-color: #f59e0b;
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(15, 23, 42, 0.9) 100%);
    }
    
    .schedule-card.p2 {
        border-left-color: #10b981;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(15, 23, 42, 0.9) 100%);
    }
    
    .schedule-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        flex-wrap: wrap;
        gap: 12px;
    }
    
    .schedule-action {
        font-weight: bold;
        color: #fff;
        font-size: 1.2rem;
    }
    
    .schedule-priority {
        padding: 6px 16px;
        border-radius: 16px;
        font-size: 0.8rem;
        font-weight: bold;
        color: white;
        text-transform: uppercase;
    }
    
    .schedule-priority.p0 {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
    }
    
    .schedule-priority.p1 {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    
    .schedule-priority.p2 {
        background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .schedule-timeframe {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.7);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .schedule-rationale {
        font-size: 0.95rem;
        color: rgba(255,255,255,0.8);
        margin-bottom: 16px;
        line-height: 1.6;
    }
    
    .schedule-steps {
        margin: 0 0 0 20px;
        padding: 0;
        color: rgba(255,255,255,0.85);
        line-height: 1.8;
    }
    
    .schedule-steps li {
        margin-bottom: 8px;
        padding-left: 8px;
    }
    
    .schedule-steps li::marker {
        color: #60a5fa;
        font-weight: bold;
    }
    
    .schedule-impact {
        margin-top: 16px;
        padding: 14px;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
        border-radius: 10px;
        color: #10b981;
        font-weight: 500;
        font-size: 0.95rem;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    /* Circadian Timeline - From v1 */
    .timeline-section {
        margin: 32px 0;
    }
    
    .circadian-timeline {
        position: relative;
        height: 200px;
        margin: 24px 0;
        background: rgba(15, 23, 42, 0.8);
        border-radius: 16px;
        padding: 24px;
        border: 2px solid rgba(59, 130, 246, 0.2);
    }
    
    .timeline-bar {
        position: absolute;
        height: 32px;
        border-radius: 16px;
        padding: 0 16px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        font-weight: 500;
        border: 2px solid transparent;
        transition: all 0.3s ease;
    }
    
    .timeline-bar:hover {
        transform: translateX(4px);
        z-index: 10;
    }
    
    .timeline-bar.melatonin { 
        background: linear-gradient(90deg, rgba(139, 92, 246, 0.5), rgba(139, 92, 246, 0.3)); 
        color: #c4b5fd; 
        top: 20px; 
        width: 160px; 
        left: 40px; 
    }
    
    .timeline-bar.deep-sleep { 
        background: linear-gradient(90deg, rgba(59, 130, 246, 0.5), rgba(59, 130, 246, 0.3)); 
        color: #93c5fd; 
        top: 70px; 
        width: 200px; 
        left: 120px; 
    }
    
    .timeline-bar.rem-sleep { 
        background: linear-gradient(90deg, rgba(16, 185, 129, 0.5), rgba(16, 185, 129, 0.3)); 
        color: #6ee7b7; 
        top: 120px; 
        width: 180px; 
        left: 160px; 
    }
    
    .timeline-bar.your-optimal { 
        background: linear-gradient(90deg, rgba(251, 191, 36, 0.6), rgba(245, 158, 11, 0.4)); 
        color: #fbbf24; 
        top: 170px; 
        width: 120px; 
        left: 100px; 
        border: 2px solid #f59e0b;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }
    
    .error-state {
        text-align: center;
        padding: 60px 40px;
        color: rgba(255,255,255,0.7);
        background: rgba(30, 41, 59, 0.8);
        border-radius: 16px;
        border: 2px solid rgba(239, 68, 68, 0.3);
    }
    
    .stats-footer {
        margin-top: 32px;
        padding: 20px;
        background: rgba(15, 23, 42, 0.8);
        border-radius: 16px;
        border: 2px solid rgba(59, 130, 246, 0.2);
        font-size: 0.85rem;
        color: rgba(255,255,255,0.6);
    }
    
    @media (max-width: 1024px) {
        .clusters-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }
    
    @media (max-width: 768px) {
        .optimal-sleep-hybrid {
            padding: 20px;
        }
        
        .optimal-time {
            font-size: 2.5rem;
        }
        
        .clusters-grid {
            grid-template-columns: 1fr;
        }
        
        .heatmap-grid {
            grid-template-columns: 60px repeat(7, 1fr);
            font-size: 0.7rem;
        }
        
        .circadian-timeline {
            height: 240px;
            padding: 20px;
        }
        
        .timeline-bar {
            font-size: 0.75rem;
            padding: 0 12px;
        }
    }
</style>
`;

if (!document.getElementById('optimal-sleep-hybrid-css')) {
    document.head.insertAdjacentHTML('beforeend', optimalSleepHybridCSS);
}

// ====== 2. CORE ML ALGORITHM ======

function findOptimalSleepWindow(sleepSessions = [], studyData = {}) {
    try {
        // Validation
        if (!sleepSessions || sleepSessions.length < 5) {
            return {
                error: true,
                message: 'Need at least 5 sleep sessions for ML analysis',
                dataPoints: sleepSessions?.length || 0
            };
        }
        
        console.log('ð¤ ML Sleep Window Analysis: Processing', sleepSessions.length, 'sessions');
        
        // ========== STEP 1: Feature Engineering ==========
        const features = extractSleepFeatures(sleepSessions, studyData);
        console.log('â Feature engineering complete:', features.length, 'features');
        
        // ========== STEP 2: Performance Scoring ==========
        const scoredSessions = scorePerformance(features, studyData);
        console.log('â Performance scoring complete');
        
        // ========== STEP 3: Cluster Analysis ==========
        const clusters = clusterSleepWindows(scoredSessions);
        console.log('â Cluster analysis:', Object.keys(clusters).filter(k => clusters[k]).length, 'clusters');
        
        // ========== STEP 4: Find Optimal Window ==========
        const optimalWindow = findBestPerformingWindow(clusters);
        console.log('â Optimal window found:', optimalWindow.window);
        
        // ========== STEP 5: Heatmap Data ==========
        const heatmap = generateEfficiencyHeatmap(scoredSessions);
        console.log('â Heatmap generated');
        
        // ========== STEP 6: Current Pattern Analysis ==========
        const currentPattern = calculateCurrentPattern(scoredSessions);
        console.log('â Current pattern analyzed');
        
        // ========== STEP 7: Generate Insights ==========
        const insights = generateOptimalityInsights(optimalWindow, clusters, scoredSessions);
        console.log('â Insights generated:', insights.length);
        
        // ========== STEP 8: Personalized Schedule ==========
        const recommendations = generatePersonalizedSchedule(optimalWindow, currentPattern);
        console.log('â Personalized schedule generated');
        
        // ========== STEP 9: Circadian Alignment ==========
        const circadianAlignment = calculateCircadianAlignment(optimalWindow);
        console.log('â Circadian alignment calculated:', circadianAlignment, '%');
        
        return {
            error: false,
            optimalWindow: {
                ...optimalWindow,
                circadianAlignment: circadianAlignment
            },
            currentPattern: currentPattern,
            clusters: clusters,
            heatmap: heatmap,
            insights: insights,
            recommendations: recommendations,
            metadata: {
                totalSessions: sleepSessions.length,
                analyzedSessions: scoredSessions.length,
                clustersFound: Object.keys(clusters).filter(k => clusters[k] && clusters[k].count >= 2).length,
                dataQuality: calculateDataQuality(scoredSessions)
            }
        };
        
    } catch (error) {
        console.error('â Optimal window detection error:', error);
        return {
            error: true,
            message: error.message,
            stack: error.stack
        };
    }
}

// ========== FEATURE EXTRACTION ==========
function extractSleepFeatures(sleepSessions, studyData) {
    return sleepSessions.map(session => {
        const startTime = new Date(session.start);
        const endTime = new Date(session.end);
        
        // Time-based features
        const bedtimeHour = startTime.getHours() + startTime.getMinutes() / 60;
        const wakeHour = endTime.getHours() + endTime.getMinutes() / 60;
        const dayOfWeek = startTime.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        
        // Sleep quality features
        const duration = session.duration;
        const sleepDebt = Math.max(0, 7.5 - duration);
        const isShortSleep = duration < 6;
        const isLongSleep = duration > 9;
        
        // Study performance (next day)
        const nextDay = new Date(startTime);
        nextDay.setDate(nextDay.getDate() + 1);
        const nextDayStr = nextDay.toISOString().split('T')[0];
        const nextDayStudy = parseFloat(studyData[nextDayStr] || 0);
        
        // Circadian timing
        const circadianScore = calculateCircadianAlignmentScore(bedtimeHour);
        
        // Sleep window category
        const sleepWindow = categorizeSleepWindow(bedtimeHour);
        
        return {
            sessionId: session.id || `session_${Date.now()}_${Math.random()}`,
            date: startTime.toISOString().split('T')[0],
            bedtimeHour: parseFloat(bedtimeHour.toFixed(2)),
            wakeHour: parseFloat(wakeHour.toFixed(2)),
            duration: duration,
            dayOfWeek: dayOfWeek,
            isWeekend: isWeekend,
            sleepDebt: parseFloat(sleepDebt.toFixed(2)),
            isShortSleep: isShortSleep,
            isLongSleep: isLongSleep,
            nextDayStudy: nextDayStudy,
            circadianScore: circadianScore,
            sleepWindow: sleepWindow
        };
    });
}

function calculateCircadianAlignmentScore(bedtimeHour) {
    // Optimal bedtime range: 21:30-23:30 (9:30pm-11:30pm)
    const optimalStart = 21.5;
    const optimalEnd = 23.5;
    
    if (bedtimeHour >= optimalStart && bedtimeHour <= optimalEnd) {
        return 100; // Perfect alignment
    }
    
    // Calculate distance to optimal range
    let distance;
    if (bedtimeHour < optimalStart) {
        distance = optimalStart - bedtimeHour;
    } else {
        distance = bedtimeHour - optimalEnd;
    }
    
    // Exponential decay: score = 100 * e^(-distance/2)
    return Math.max(30, Math.round(100 * Math.exp(-distance / 2)));
}

function categorizeSleepWindow(bedtimeHour) {
    if (bedtimeHour >= 20 && bedtimeHour < 22) return 'early_bird';
    if (bedtimeHour >= 22 && bedtimeHour < 24) return 'optimal';
    if (bedtimeHour >= 0 && bedtimeHour < 2) return 'night_owl';
    if (bedtimeHour >= 2 && bedtimeHour < 6) return 'late_night';
    if (bedtimeHour >= 6 && bedtimeHour < 12) return 'daytime_sleeper';
    return 'irregular';
}

// ========== PERFORMANCE SCORING ==========
function scorePerformance(features, studyData) {
    return features.map(feature => {
        let performanceScore = 50; // Neutral base score
        
        // 1. Duration score (30% weight) - Optimal: 7-9 hours
        const durationScore = Math.max(0, 100 - Math.abs(feature.duration - 8) * 15);
        performanceScore += (durationScore - 50) * 0.3;
        
        // 2. Circadian alignment (25% weight)
        performanceScore += (feature.circadianScore - 50) * 0.25;
        
        // 3. Next-day study performance (20% weight)
        if (feature.nextDayStudy > 0) {
            const studyScore = Math.min(100, feature.nextDayStudy * 15);
            performanceScore += (studyScore - 50) * 0.2;
        }
        
        // 4. Sleep debt penalty (15% weight)
        performanceScore -= feature.sleepDebt * 8;
        
        // 5. Weekend consistency bonus (10% weight)
        if (!feature.isWeekend && feature.duration >= 7 && feature.duration <= 9) {
            performanceScore += 10;
        }
        
        // Clamp and round
        performanceScore = Math.max(0, Math.min(100, performanceScore));
        
        return {
            ...feature,
            performanceScore: parseFloat(performanceScore.toFixed(1)),
            durationScore: parseFloat(durationScore.toFixed(1))
        };
    });
}

// ========== CLUSTER ANALYSIS ==========
function clusterSleepWindows(scoredSessions) {
    const clusters = {
        'early_bird': { sessions: [], stats: null },
        'optimal': { sessions: [], stats: null },
        'night_owl': { sessions: [], stats: null },
        'late_night': { sessions: [], stats: null },
        'daytime_sleeper': { sessions: [], stats: null },
        'irregular': { sessions: [], stats: null }
    };
    
    // Group sessions by window category
    scoredSessions.forEach(session => {
        clusters[session.sleepWindow].sessions.push(session);
    });
    
    // Calculate statistics for each cluster
    Object.keys(clusters).forEach(window => {
        const sessions = clusters[window].sessions;
        if (sessions.length === 0) {
            clusters[window].stats = null;
            return;
        }
        
        const scores = sessions.map(s => s.performanceScore);
        const durations = sessions.map(s => s.duration);
        const studyHours = sessions.map(s => s.nextDayStudy).filter(h => h > 0);
        
        clusters[window].stats = {
            count: sessions.length,
            avgPerformance: parseFloat((scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1)),
            avgDuration: parseFloat((durations.reduce((a, b) => a + b, 0) / durations.length).toFixed(1)),
            avgNextDayStudy: studyHours.length > 0 ? 
                parseFloat((studyHours.reduce((a, b) => a + b, 0) / studyHours.length).toFixed(1)) : 0,
            minScore: Math.min(...scores),
            maxScore: Math.max(...scores),
            consistency: calculateConsistency(scores),
            avgBedtime: parseFloat((sessions.reduce((sum, s) => sum + s.bedtimeHour, 0) / sessions.length).toFixed(2)),
            avgWakeTime: parseFloat((sessions.reduce((sum, s) => sum + s.wakeHour, 0) / sessions.length).toFixed(2)),
            sessions: sessions
        };
    });
    
    return clusters;
}

function calculateConsistency(scores) {
    if (scores.length < 2) return 100;
    const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
    const variance = scores.reduce((sum, score) => sum + Math.pow(score - avg, 2), 0) / scores.length;
    const stdDev = Math.sqrt(variance);
    return Math.max(0, Math.min(100, 100 - stdDev * 1.5));
}

// ========== FIND BEST PERFORMING WINDOW ==========
function findBestPerformingWindow(clusters) {
    let bestWindow = null;
    let bestScore = -1;
    
    Object.entries(clusters).forEach(([window, data]) => {
        const stats = data.stats;
        if (!stats || stats.count < 2) return; // Need at least 2 samples
        
        // Composite score: performance (60%) + consistency (30%) + data confidence (10%)
        const dataConfidence = Math.min(100, stats.count * 15); // More data = more confidence
        const compositeScore = stats.avgPerformance * 0.6 + 
                              stats.consistency * 0.3 + 
                              dataConfidence * 0.1;
        
        if (compositeScore > bestScore) {
            bestScore = compositeScore;
            bestWindow = {
                window: window,
                stats: stats,
                compositeScore: parseFloat(compositeScore.toFixed(1)),
                dataConfidence: dataConfidence
            };
        }
    });
    
    if (!bestWindow) {
        // Fallback to most common window
        const windowsByCount = Object.entries(clusters)
            .filter(([_, data]) => data.stats)
            .sort((a, b) => b[1].stats.count - a[1].stats.count);
        
        if (windowsByCount.length > 0) {
            const [window, data] = windowsByCount[0];
            bestWindow = {
                window: window,
                stats: data.stats,
                compositeScore: 70,
                dataConfidence: 70
            };
        }
    }
    
    // Add time range and description
    const timeRanges = {
        'early_bird': '20:00-22:00 (8pm-10pm)',
        'optimal': '22:00-00:00 (10pm-12am)',
        'night_owl': '00:00-02:00 (12am-2am)',
        'late_night': '02:00-06:00 (2am-6am)',
        'daytime_sleeper': '06:00-12:00 (6am-12pm)',
        'irregular': 'Variable timing'
    };
    
    const descriptions = {
        'early_bird': 'Early sleeper pattern. You perform best with early bedtimes, aligning well with traditional schedules.',
        'optimal': 'Classic optimal timing. Your peak performance occurs during the scientifically recommended sleep window.',
        'night_owl': 'Night owl pattern. You thrive with slightly later sleep, showing better performance than early sleep.',
        'late_night': 'Very late sleeper. While this works for you, consider long-term health impacts of late-night sleep.',
        'daytime_sleeper': 'Daytime sleep dominant. This pattern may indicate shift work or irregular schedule.',
        'irregular': 'Inconsistent timing. Your sleep schedule varies significantly, affecting performance consistency.'
    };
    
    bestWindow.timeRange = timeRanges[bestWindow.window] || 'Unknown';
    bestWindow.description = descriptions[bestWindow.window] || 'Pattern analysis complete.';
    
    return bestWindow;
}

// ========== HEATMAP GENERATION ==========
function generateEfficiencyHeatmap(scoredSessions) {
    const heatmap = [];
    const bedtimeHours = [20, 21, 22, 23, 0, 1, 2]; // 8pm-2am
    const wakeHours = [4, 5, 6, 7, 8, 9, 10]; // 4am-10am
    
    // Initialize heatmap matrix
    wakeHours.forEach(wakeHour => {
        const row = { wakeHour: wakeHour, cells: [] };
        bedtimeHours.forEach(bedHour => {
            row.cells.push({
                bedHour: bedHour,
                wakeHour: wakeHour,
                score: 0,
                level: 'empty',
                duration: bedHour >= 20 ? (24 - bedHour) + wakeHour : wakeHour - bedHour
            });
        });
        heatmap.push(row);
    });
    
    // Score each cell based on sessions
    scoredSessions.forEach(session => {
        const bedtime = Math.floor(session.bedtimeHour);
        const wakeup = Math.floor(session.wakeHour);
        
        // Find matching cell
        for (let i = 0; i < wakeHours.length; i++) {
            if (Math.abs(wakeup - wakeHours[i]) <= 1) {
                for (let j = 0; j < bedtimeHours.length; j++) {
                    if (Math.abs(bedtime - bedtimeHours[j]) <= 1) {
                        const cell = heatmap[i].cells[j];
                        // Add score weighted by duration match
                        const durationMatch = 100 - Math.abs(cell.duration - session.duration) * 10;
                        const performanceWeight = session.performanceScore / 100;
                        cell.score = Math.min(100, cell.score + (durationMatch * performanceWeight * 0.8));
                        break;
                    }
                }
                break;
            }
        }
    });
    
    // Normalize and classify cells
    heatmap.forEach(row => {
        row.cells.forEach(cell => {
            if (cell.score > 0) {
                cell.score = Math.round(cell.score / 3); // Normalize
                cell.level = cell.score < 60 ? 'low' :
                            cell.score < 75 ? 'medium' :
                            cell.score < 90 ? 'good' : 'excellent';
            }
        });
    });
    
    return heatmap;
}

// ========== CURRENT PATTERN ANALYSIS ==========
function calculateCurrentPattern(scoredSessions) {
    if (scoredSessions.length === 0) return null;
    
    const recentSessions = scoredSessions.slice(-7); // Last 7 days
    const avgBedtime = recentSessions.reduce((sum, s) => sum + s.bedtimeHour, 0) / recentSessions.length;
    const avgWakeup = recentSessions.reduce((sum, s) => sum + s.wakeHour, 0) / recentSessions.length;
    const avgDuration = recentSessions.reduce((sum, s) => sum + s.duration, 0) / recentSessions.length;
    const avgPerformance = recentSessions.reduce((sum, s) => sum + s.performanceScore, 0) / recentSessions.length;
    
    // Find most common window in recent sessions
    const windowCounts = {};
    recentSessions.forEach(s => {
        windowCounts[s.sleepWindow] = (windowCounts[s.sleepWindow] || 0) + 1;
    });
    const mostCommonWindow = Object.entries(windowCounts)
        .sort((a, b) => b[1] - a[1])[0]?.[0] || 'irregular';
    
    return {
        bedtime: formatHour(avgBedtime),
        wakeup: formatHour(avgWakeup),
        duration: parseFloat(avgDuration.toFixed(1)),
        performance: parseFloat(avgPerformance.toFixed(1)),
        window: mostCommonWindow,
        sessionsAnalyzed: recentSessions.length
    };
}

// ========== GENERATE INSIGHTS ==========
function generateOptimalityInsights(optimalWindow, clusters, scoredSessions) {
    const insights = [];
    
    // Current average performance
    const avgCurrentPerformance = scoredSessions.reduce((sum, s) => sum + s.performanceScore, 0) / scoredSessions.length;
    const improvementPotential = optimalWindow.stats.avgPerformance - avgCurrentPerformance;
    
    // Insight 1: Improvement potential
    if (improvementPotential > 15) {
        insights.push({
            type: 'improvement_potential',
            priority: 'high',
            icon: 'ð',
            title: `${Math.round(improvementPotential)}% Performance Boost Available`,
            message: `Switching to your optimal window (${optimalWindow.timeRange}) could improve sleep performance from ${avgCurrentPerformance.toFixed(1)}% to ${optimalWindow.stats.avgPerformance}%.`,
            impact: 'high'
        });
    } else if (improvementPotential > 5) {
        insights.push({
            type: 'modest_improvement',
            priority: 'medium',
            icon: 'ð',
            title: `${Math.round(improvementPotential)}% Potential Gain`,
            message: `Small but meaningful improvement available by optimizing sleep timing.`,
            impact: 'medium'
        });
    } else {
        insights.push({
            type: 'already_optimal',
            priority: 'low',
            icon: 'â',
            title: 'Near-Optimal Performance',
            message: `Your current sleep timing is already close to optimal. Focus on consistency.`,
            impact: 'low'
        });
    }
    
    // Insight 2: Next-day study correlation
    if (optimalWindow.stats.avgNextDayStudy > 4) {
        insights.push({
            type: 'study_correlation',
            priority: 'medium',
            icon: 'ð',
            title: `+${optimalWindow.stats.avgNextDayStudy.toFixed(1)}h Next-Day Study`,
            message: `When sleeping in your optimal window, you study ${optimalWindow.stats.avgNextDayStudy.toFixed(1)} hours more the next day on average.`,
            impact: 'medium'
        });
    }
    
    // Insight 3: Consistency analysis
    if (optimalWindow.stats.consistency >= 85) {
        insights.push({
            type: 'high_consistency',
            priority: 'low',
            icon: 'ð¯',
            title: 'Excellent Consistency',
            message: `Your optimal window shows ${optimalWindow.stats.consistency.toFixed(0)}% consistency, indicating reliable performance.`,
            impact: 'low'
        });
    } else if (optimalWindow.stats.consistency < 65) {
        insights.push({
            type: 'low_consistency',
            priority: 'high',
            icon: 'â ï¸',
            title: 'Inconsistent Performance',
            message: `Even in your best window, performance varies (${optimalWindow.stats.consistency.toFixed(0)}% consistency). Focus on sleep duration consistency.`,
            impact: 'high'
        });
    }
    
    // Insight 4: Circadian alignment
    const circadianAlignedSessions = scoredSessions.filter(s => s.circadianScore >= 80);
    const circadianAlignmentRate = (circadianAlignedSessions.length / scoredSessions.length) * 100;
    
    if (circadianAlignmentRate >= 70) {
        insights.push({
            type: 'circadian_aligned',
            priority: 'low',
            icon: 'ð',
            title: `${Math.round(circadianAlignmentRate)}% Circadian Alignment`,
            message: `Most of your sleep aligns well with natural circadian rhythms, optimizing sleep quality.`,
            impact: 'low'
        });
    } else {
        insights.push({
            type: 'circadian_misaligned',
            priority: 'medium',
            icon: 'ð',
            title: `${Math.round(circadianAlignmentRate)}% Circadian Alignment`,
            message: `Consider adjusting bedtime to better align with natural circadian rhythms for improved sleep quality.`,
            impact: 'medium'
        });
    }
    
    return insights;
}

// ========== PERSONALIZED SCHEDULE ==========
function generatePersonalizedSchedule(optimalWindow, currentPattern) {
    const recommendations = [];
    
    // Get target times
    const targetBedtime = optimalWindow.stats.avgBedtime;
    const targetDuration = optimalWindow.stats.avgDuration;
    const targetWaketime = (targetBedtime + targetDuration) % 24;
    
    // Primary recommendation
    recommendations.push({
        priority: 'P0',
        timeframe: 'Starting tonight',
        action: `SET BEDTIME: ${formatHour(targetBedtime)}`,
        rationale: `ML analysis shows ${optimalWindow.stats.avgPerformance}% performance in this window (vs your current ${currentPattern.performance}%).`,
        steps: [
            `Set alarm for ${formatHour(targetBedtime - 0.5)} (30min wind-down)`,
            `Complete dinner by ${formatHour(targetBedtime - 3)}`,
            `No screens after ${formatHour(targetBedtime - 1)}`,
            `In bed by ${formatHour(targetBedtime)} sharp`,
            `Target ${targetDuration.toFixed(1)}h sleep â Wake at ${formatHour(targetWaketime)}`
        ],
        expectedImpact: `Improve sleep performance by ${Math.round(optimalWindow.stats.avgPerformance - currentPattern.performance)}%`,
        scientificBasis: `Based on ${optimalWindow.stats.count} sessions with ${optimalWindow.dataConfidence}% data confidence`
    });
    
    // Consistency recommendation
    recommendations.push({
        priority: 'P1',
        timeframe: 'Next 14 days',
        action: `MAINTAIN ${formatHour(targetBedtime - 0.5)}-${formatHour(targetBedtime + 0.5)} BEDTIME WINDOW`,
        rationale: `Your optimal window shows ${optimalWindow.stats.consistency.toFixed(0)}% consistency. Â±30 minute consistency will boost this to 90%+.`,
        steps: [
            `Weekday consistency: Â±15 minutes variation`,
            `Weekend consistency: Â±45 minutes max (avoid social jetlag)`,
            `Track daily with sleep diary`,
            `Adjust gradually if schedule conflicts arise`
        ],
        expectedImpact: `Improve consistency to 90%+, boost recovery efficiency by 15-20%`,
        scientificBasis: 'Consistent bedtimes regulate circadian rhythm and improve sleep architecture'
    });
    
    // Pre-sleep optimization
    recommendations.push({
        priority: 'P1',
        timeframe: 'Daily routine',
        action: 'OPTIMIZE PRE-SLEEP ENVIRONMENT',
        rationale: 'Maximize sleep quality in your personal optimal window',
        steps: [
            `Last caffeine: ${formatHour(targetBedtime - 8)} (8h before bed)`,
            `Last meal: ${formatHour(targetBedtime - 3)} (3h before)`,
            `Light dimming: Start at ${formatHour(targetBedtime - 2)}`,
            `Temperature: 18-20Â°C bedroom temperature`,
            `Wind-down routine: 30min of reading/meditation`
        ],
        expectedImpact: 'Reduce sleep onset latency by 10-15 minutes, increase deep sleep by 5-10%',
        scientificBasis: 'Optimal environment enhances sleep efficiency and architecture'
    });
    
    // Alternative windows
    const alternativeWindows = Object.entries(optimalWindow.stats.sessions.reduce((acc, session) => {
        const window = session.sleepWindow;
        if (!acc[window]) acc[window] = { sum: 0, count: 0 };
        acc[window].sum += session.performanceScore;
        acc[window].count += 1;
        return acc;
    }, {}))
        .filter(([window]) => window !== optimalWindow.window)
        .map(([window, data]) => ({
            window,
            avgPerformance: data.sum / data.count,
            count: data.count
        }))
        .sort((a, b) => b.avgPerformance - a.avgPerformance);
    
    if (alternativeWindows.length > 0 && alternativeWindows[0].count >= 2) {
        const altWindow = alternativeWindows[0];
        recommendations.push({
            priority: 'P2',
            timeframe: 'Backup schedule',
            action: `ALTERNATIVE: ${getWindowName(altWindow.window)} WINDOW`,
            rationale: `When primary window is impossible, this alternative achieves ${altWindow.avgPerformance.toFixed(1)}% performance.`,
            steps: [
                `Use only when schedule conflicts prevent optimal timing`,
                `Limit to 2-3 times per week max`,
                `Return to optimal window as soon as possible`,
                `Compensate with nap if sleep duration reduced`
            ],
            expectedImpact: `${Math.round(altWindow.avgPerformance - 70)}% performance (vs ${Math.round(optimalWindow.stats.avgPerformance - 70)}% optimal)`,
            scientificBasis: 'Having backup options maintains performance during schedule disruptions'
        });
    }
    
    return recommendations;
}

function getWindowName(window) {
    const names = {
        'early_bird': 'Early Bird',
        'optimal': 'Optimal',
        'night_owl': 'Night Owl',
        'late_night': 'Late Night',
        'daytime_sleeper': 'Daytime',
        'irregular': 'Irregular'
    };
    return names[window] || window;
}

// ========== CIRCADIAN ALIGNMENT CALCULATION ==========
function calculateCircadianAlignment(optimalWindow) {
    const targetBedtime = optimalWindow.stats.avgBedtime;
    
    // Optimal circadian windows
    const melatoninWindow = { start: 21.5, end: 23.5 }; // 9:30pm-11:30pm
    const deepSleepWindow = { start: 23, end: 3 };      // 11pm-3am
    const remSleepWindow = { start: 5, end: 7 };        // 5am-7am
    
    let alignmentScore = 0;
    
    // Check melatonin window alignment (40% weight)
    if (targetBedtime >= melatoninWindow.start && targetBedtime <= melatoninWindow.end) {
        alignmentScore += 40;
    } else {
        const distance = Math.min(
            Math.abs(targetBedtime - melatoninWindow.start),
            Math.abs(targetBedtime - melatoninWindow.end)
        );
        alignmentScore += Math.max(0, 40 - distance * 10);
    }
    
    // Check deep sleep window alignment (40% weight)
    const sleepEndTime = (targetBedtime + optimalWindow.stats.avgDuration) % 24;
    const coversDeepSleep = (targetBedtime <= deepSleepWindow.start && sleepEndTime >= deepSleepWindow.start) ||
                          (targetBedtime <= deepSleepWindow.end && sleepEndTime >= deepSleepWindow.end);
    
    if (coversDeepSleep) {
        alignmentScore += 40;
    } else {
        alignmentScore += 20; // Partial credit
    }
    
    // Check REM sleep window alignment (20% weight)
    const coversRemSleep = sleepEndTime >= remSleepWindow.start && sleepEndTime <= remSleepWindow.end;
    if (coversRemSleep) {
        alignmentScore += 20;
    } else {
        alignmentScore += 10; // Partial credit
    }
    
    return Math.min(100, Math.round(alignmentScore));
}

// ========== DATA QUALITY CALCULATION ==========
function calculateDataQuality(scoredSessions) {
    if (scoredSessions.length < 5) return 'low';
    
    const durations = scoredSessions.map(s => s.duration);
    const avgDuration = durations.reduce((a, b) => a + b, 0) / durations.length;
    const durationConsistency = 100 - Math.abs(avgDuration - 7.5) * 10;
    
    const performanceScores = scoredSessions.map(s => s.performanceScore);
    const avgPerformance = performanceScores.reduce((a, b) => a + b, 0) / performanceScores.length;
    
    const qualityScore = (durationConsistency * 0.4) + (avgPerformance * 0.6);
    
    if (qualityScore >= 80) return 'excellent';
    if (qualityScore >= 65) return 'good';
    if (qualityScore >= 50) return 'fair';
    return 'poor';
}

// ========== UTILITY FUNCTIONS ==========
function formatHour(hour) {
    const h = Math.floor(hour) % 24;
    const m = Math.round((hour % 1) * 60);
    const period = h >= 12 ? 'PM' : 'AM';
    const displayHour = h > 12 ? h - 12 : (h === 0 ? 12 : h);
    return `${displayHour}:${m.toString().padStart(2, '0')}${period}`;
}

function formatHour24(hour) {
    const h = Math.floor(hour) % 24;
    const m = Math.round((hour % 1) * 60);
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

// ========== 3. RENDER FUNCTION ==========
function renderOptimalSleepWindow() {
    const sleepSessions = window.sleepSessions || [];
    const studyData = window.dailyStudyData || {};
    
    if (!sleepSessions || sleepSessions.length < 3) {
        return `
            <div class="optimal-sleep-hybrid">
                <div class="hybrid-header">
                    <h3>ð¤ Optimal Sleep Window Detection</h3>
                    <div class="ml-badge">ML-Powered</div>
                </div>
                <div class="error-state">
                    <p>Need at least 3 sleep sessions for analysis</p>
                    <div style="margin-top: 20px; font-size: 0.9rem; color: rgba(255,255,255,0.5);">
                        <p>ð You have: ${sleepSessions.length} sleep sessions</p>
                        <p>ð¯ Required: 5+ for ML analysis, 3+ for basic analysis</p>
                    </div>
                    <button onclick="location.reload()" style="
                        margin-top: 24px;
                        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 24px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: all 0.3s;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        ð Refresh Analysis
                    </button>
                </div>
            </div>
        `;
    }
    
    const result = findOptimalSleepWindow(sleepSessions, studyData);
    
    if (result.error) {
        return `
            <div class="optimal-sleep-hybrid">
                <div class="hybrid-header">
                    <h3>ð¤ Optimal Sleep Window Detection</h3>
                    <div class="ml-badge">ML-Powered</div>
                </div>
                <div class="error-state">
                    <p>â Analysis Error</p>
                    <p style="color: rgba(255,255,255,0.6); margin-top: 12px;">${result.message}</p>
                    ${result.stack ? `
                        <details style="margin-top: 20px; color: rgba(255,255,255,0.4);">
                            <summary>Technical Details</summary>
                            <pre style="font-size: 0.7rem; margin-top: 8px; overflow: auto; max-height: 100px;">${result.stack}</pre>
                        </details>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    const { optimalWindow, currentPattern, clusters, heatmap, insights, recommendations, metadata } = result;
    
    return `
        <div class="optimal-sleep-hybrid">
            <!-- Header -->
            <div class="hybrid-header">
                <h3>ð¤ Optimal Sleep Window Detection</h3>
                <div class="ml-badge">
                    ð¤ ML-Powered Analysis
                </div>
            </div>
            
            <!-- ML Results Section -->
            <div class="ml-section">
                <!-- Optimal Window Display -->
                <div class="optimal-display">
                    <div class="optimal-title">Your Machine-Learned Optimal Sleep Window</div>
                    <div class="optimal-time">${optimalWindow.timeRange}</div>
                    <div style="color: rgba(255,255,255,0.85); max-width: 600px; margin: 0 auto 20px; line-height: 1.6;">
                        ${optimalWindow.description}
                    </div>
                    <div class="optimal-score">
                        <span class="score-badge">Performance</span>
                        <span>${optimalWindow.stats.avgPerformance}%</span>
                        <span style="margin: 0 8px;">â¢</span>
                        <span class="score-badge">Consistency</span>
                        <span>${optimalWindow.stats.consistency.toFixed(0)}%</span>
                        <span style="margin: 0 8px;">â¢</span>
                        <span class="score-badge">Alignment</span>
                        <span>${optimalWindow.circadianAlignment}%</span>
                    </div>
                </div>
                
                <!-- Current vs Optimal -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 32px;">
                    <div style="
                        background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
                        border-radius: 12px;
                        padding: 20px;
                        border: 2px solid rgba(245, 158, 11, 0.3);
                        text-align: center;
                    ">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 12px;">ð CURRENT</div>
                        <div style="font-size: 1.8rem; font-weight: bold; color: #f59e0b; margin-bottom: 8px;">${currentPattern.bedtime} â ${currentPattern.wakeup}</div>
                        <div style="color: rgba(255,255,255,0.85); margin-bottom: 8px;">${currentPattern.duration}h sleep</div>
                        <div style="color: #f59e0b; font-weight: bold;">${currentPattern.performance}% performance</div>
                    </div>
                    
                    <div style="
                        background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
                        border-radius: 12px;
                        padding: 20px;
                        border: 2px solid rgba(16, 185, 129, 0.3);
                        text-align: center;
                    ">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-bottom: 12px;">ð¯ OPTIMAL</div>
                        <div style="font-size: 1.8rem; font-weight: bold; color: #10b981; margin-bottom: 8px;">${formatHour(optimalWindow.stats.avgBedtime)} â ${formatHour(optimalWindow.stats.avgWakeTime)}</div>
                        <div style="color: rgba(255,255,255,0.85); margin-bottom: 8px;">${optimalWindow.stats.avgDuration.toFixed(1)}h sleep</div>
                        <div style="color: #10b981; font-weight: bold;">${optimalWindow.stats.avgPerformance}% performance</div>
                    </div>
                </div>
                
                <!-- Improvement Potential -->
                ${optimalWindow.stats.avgPerformance > currentPattern.performance ? `
                    <div style="
                        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
                        border: 2px solid rgba(16, 185, 129, 0.3);
                        border-radius: 12px;
                        padding: 20px;
                        text-align: center;
                        margin-bottom: 32px;
                    ">
                        <div style="font-size: 1.2rem; font-weight: bold; color: #10b981; margin-bottom: 8px;">
                            ð ${Math.round(optimalWindow.stats.avgPerformance - currentPattern.performance)}% Performance Improvement Available
                        </div>
                        <div style="color: rgba(255,255,255,0.85);">
                            Switching to optimal window could boost your sleep performance significantly
                        </div>
                    </div>
                ` : ''}
            </div>
            
            <!-- All Windows Analyzed -->
            <div class="section-title">ð All Sleep Windows Analyzed</div>
            <div class="clusters-grid">
                ${Object.entries(clusters)
                    .filter(([_, data]) => data.stats !== null && data.stats.count >= 2)
                    .sort((a, b) => b[1].stats.avgPerformance - a[1].stats.avgPerformance)
                    .map(([window, data], index) => {
                        const isBest = window === optimalWindow.window;
                        const stats = data.stats;
                        const cardClass = isBest ? 'best' : 
                                        stats.avgPerformance >= 70 ? 'good' : 'poor';
                        
                        const timeRanges = {
                            'early_bird': '8pm-10pm',
                            'optimal': '10pm-12am',
                            'night_owl': '12am-2am',
                            'late_night': '2am-6am',
                            'daytime_sleeper': '6am-12pm',
                            'irregular': 'Variable'
                        };
                        
                        return `
                            <div class="cluster-card ${cardClass}">
                                ${isBest ? '<div class="cluster-badge">BEST</div>' : ''}
                                <div class="cluster-name">${window.replace('_', ' ').toUpperCase()}</div>
                                <div class="cluster-time">${timeRanges[window]}</div>
                                <div class="cluster-stats">
                                    <div class="cluster-stat">
                                        <span class="stat-label">Performance:</span>
                                        <span class="stat-value" style="color: ${stats.avgPerformance >= 70 ? '#10b981' : stats.avgPerformance >= 60 ? '#f59e0b' : '#ef4444'}">
                                            ${stats.avgPerformance}%
                                        </span>
                                    </div>
                                    <div class="cluster-stat">
                                        <span class="stat-label">Samples:</span>
                                        <span class="stat-value">${stats.count} nights</span>
                                    </div>
                                    <div class="cluster-stat">
                                        <span class="stat-label">Avg Sleep:</span>
                                        <span class="stat-value">${stats.avgDuration}h</span>
                                    </div>
                                    <div class="cluster-stat">
                                        <span class="stat-label">Next Day Study:</span>
                                        <span class="stat-value">${stats.avgNextDayStudy.toFixed(1)}h</span>
                                    </div>
                                    <div class="cluster-stat">
                                        <span class="stat-label">Consistency:</span>
                                        <span class="stat-value">${stats.consistency.toFixed(0)}%</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
            </div>
            
            <!-- Efficiency Heatmap -->
            <div class="heatmap-section">
                <div class="section-title">ð¯ Sleep Efficiency Heatmap</div>
                <div class="heatmap-container">
                    <div class="heatmap-grid">
                        <!-- Header row -->
                        <div></div>
                        ${['8PM', '9PM', '10PM', '11PM', '12AM', '1AM', '2AM'].map(time => 
                            `<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 10px 4px; font-weight: 600; font-size: 0.75rem;">${time}</div>`
                        ).join('')}
                        
                        <!-- Data rows -->
                        ${heatmap.map(row => `
                            <div style="color: rgba(255,255,255,0.6); padding: 10px 4px; text-align: right; font-weight: 600; font-size: 0.75rem;">
                                ${row.wakeHour.toString().padStart(2, '0')}:00
                            </div>
                            ${row.cells.map(cell => {
                                // Check if this cell matches current pattern
                                const isCurrent = Math.abs(parseFloat(currentPattern.bedtime.split(':')[0]) - cell.bedHour) <= 1;
                                // Check if this cell matches optimal window
                                const isOptimal = Math.abs(optimalWindow.stats.avgBedtime - cell.bedHour) <= 1;
                                
                                return `
                                    <div class="heatmap-cell ${cell.level} ${isCurrent ? 'current' : ''} ${isOptimal ? 'recommended' : ''}" 
                                         title="Bedtime: ${cell.bedHour}:00 | Wake-up: ${row.wakeHour}:00 | Duration: ${cell.duration}h | Score: ${cell.score}%">
                                        ${cell.score > 0 ? cell.score : 'Â·'}
                                    </div>
                                `;
                            }).join('')}
                        `).join('')}
                    </div>
                    
                    <!-- Legend -->
                    <div class="heatmap-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.5), rgba(16, 185, 129, 0.3));"></div>
                            <span>Excellent (90-100%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.4), rgba(59, 130, 246, 0.2));"></div>
                            <span>Good (75-89%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.4), rgba(245, 158, 11, 0.2));"></div>
                            <span>Medium (60-74%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="border: 2px solid #f59e0b;"></div>
                            <span>ð Current</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="border: 2px solid #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);"></div>
                            <span>ð¯ Optimal</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Circadian Timeline -->
            <div class="timeline-section">
                <div class="section-title">ð Circadian Rhythm Alignment</div>
                <div class="circadian-timeline">
                    <div class="timeline-bar melatonin">ð Melatonin Window (9:30-11:30 PM)</div>
                    <div class="timeline-bar deep-sleep">ð¤ Deep Sleep Peak (11PM-3AM)</div>
                    <div class="timeline-bar rem-sleep">ð REM Sleep Peak (5-7 AM)</div>
                    <div class="timeline-bar your-optimal">ð¯ Your Optimal Window</div>
                </div>
                <div style="text-align: center; margin-top: 16px; color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                    Your optimal window shows <strong style="color: #10b981;">${optimalWindow.circadianAlignment}% circadian alignment</strong>
                </div>
            </div>
            
            <!-- Insights -->
            <div class="insights-section">
                <div class="section-title">ð¡ ML-Generated Insights</div>
                ${insights.map(insight => `
                    <div class="insight-card ${insight.impact}">
                        <div class="insight-header">
                            <span class="insight-icon">${insight.icon}</span>
                            <span class="insight-title">${insight.title}</span>
                        </div>
                        <div class="insight-message">${insight.message}</div>
                    </div>
                `).join('')}
            </div>
            
            <!-- Personalized Schedule -->
            <div style="margin: 32px 0;">
                <div class="section-title">ð Personalized Sleep Schedule</div>
                ${recommendations.map(rec => `
                    <div class="schedule-card ${rec.priority.toLowerCase()}">
                        <div class="schedule-header">
                            <div class="schedule-action">${rec.action}</div>
                            <div class="schedule-priority ${rec.priority.toLowerCase()}">${rec.priority}</div>
                        </div>
                        <div class="schedule-timeframe">
                            <span>â±ï¸</span> ${rec.timeframe}
                        </div>
                        <div class="schedule-rationale">${rec.rationale}</div>
                        <ol class="schedule-steps">
                            ${rec.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                        <div class="schedule-impact">
                            ð ${rec.expectedImpact}
                        </div>
                        ${rec.scientificBasis ? `
                            <div style="margin-top: 12px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                                ð¬ ${rec.scientificBasis}
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
            
            <!-- Stats Footer -->
            <div class="stats-footer">
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <strong>ML Model Stats:</strong>
                        <div style="margin-top: 8px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <span>Total Sessions: ${metadata.totalSessions}</span>
                            <span>Analyzed: ${metadata.analyzedSessions}</span>
                            <span>Clusters Found: ${metadata.clustersFound}</span>
                            <span>Data Quality: <span style="color: ${metadata.dataQuality === 'excellent' ? '#10b981' : metadata.dataQuality === 'good' ? '#f59e0b' : '#ef4444'}">${metadata.dataQuality}</span></span>
                        </div>
                    </div>
                    <div>
                        <strong>Optimal Window Confidence:</strong>
                        <div style="margin-top: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 100px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${optimalWindow.dataConfidence}%; height: 100%; background: linear-gradient(90deg, #10b981, #059669);"></div>
                                </div>
                                <span>${optimalWindow.dataConfidence}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ====== 4. INITIALIZATION ======

document.addEventListener('DOMContentLoaded', function() {
    // Create container if it doesn't exist
    let container = document.getElementById('optimalSleepHybridContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'optimalSleepHybridContainer';
        container.style.opacity = '0';
        
        // Insert after sleep debt container or at end of body
        const debtContainer = document.getElementById('sleepDebtContainer');
        if (debtContainer) {
            debtContainer.parentNode.insertBefore(container, debtContainer.nextSibling);
        } else {
            const insomniaContainer = document.getElementById('insomniaAnalysisContainer');
            if (insomniaContainer) {
                insomniaContainer.parentNode.insertBefore(container, insomniaContainer.nextSibling);
            } else {
                document.body.appendChild(container);
            }
        }
    }
    
    // Render after 1 second delay (allow other components to load)
    setTimeout(() => {
        container.innerHTML = renderOptimalSleepWindow();
        container.style.transition = 'opacity 0.5s ease';
        container.style.opacity = '1';
        
        // Log success
        console.log('ð¤ Optimal Sleep Window Hybrid System loaded successfully!');
        console.log('ð Features: ML Analysis + Heatmap + Circadian Timeline + Personalized Schedule');
    }, 1000);
});

// ====== 5. REFRESH FUNCTION ======

function refreshOptimalSleepWindow() {
    const container = document.getElementById('optimalSleepHybridContainer');
    if (!container) return;
    
    container.style.opacity = '0.7';
    container.style.transition = 'opacity 0.3s ease';
    
    setTimeout(() => {
        container.innerHTML = renderOptimalSleepWindow();
        container.style.opacity = '1';
        
        console.log('ð Optimal Sleep Window analysis refreshed');
    }, 300);
}

// ====== 6. EXPORTS ======

window.OptimalSleepWindowHybrid = {
    analyze: findOptimalSleepWindow,
    render: renderOptimalSleepWindow,
    refresh: refreshOptimalSleepWindow,
    version: '1.0.0',
    features: ['ML Analysis', 'Heatmap Visualization', 'Circadian Alignment', 'Personalized Scheduling']
};

window.renderOptimalSleepWindow = renderOptimalSleepWindow;
window.refreshOptimalSleepWindow = refreshOptimalSleepWindow;

console.log('ð Optimal Sleep Window Detection System loaded!');
console.log('ð Features:');
console.log('   â¢ ð¤ ML-Powered Cluster Analysis');
console.log('   â¢ ð¯ Performance Scoring with Study Data');
console.log('   â¢ ð Interactive Efficiency Heatmap');
console.log('   â¢ ð Circadian Rhythm Alignment');
console.log('   â¢ ð¡ Personalized Insights & Recommendations');
console.log('   â¢ ð Actionable Sleep Schedule');

























        // ===== LOAD INVESTMENT ANALYSIS DATA =====
        investmentAnalyses = JSON.parse(localStorage.getItem('investmentAnalyses')) || [];

        // ===== SCHEMA =====
        const analysisSchema = {
            id: Date.now(),
            title: "",
            type: "", 
            date: "",
            thesis: "",
            tags: [],
            keyMetrics: {
                currentPrice: "",
                targetPrice: "",
                upside: "",
                peRatio: "",
                recommendation: ""
            },
            links: {
                pitchDeck: "",
                excelModel: "",
                notes: ""
            },
            createdAt: new Date().toISOString()
        };

        // ===== RENDER ANALYSIS CARDS =====
        function renderAnalysisCards(analyses = investmentAnalyses) {
            const container = document.getElementById('analysisCardsContainer');
            const countElement = document.getElementById('analysisCount');
            
            countElement.textContent = analyses.length;
            
            if (analyses.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No analyses yet. Add your first one!</div>';
                return;
            }
            
            container.innerHTML = analyses
                .sort((a, b) => new Date(b.date) - new Date(a.date)) 
                .map(analysis => renderAnalysisCard(analysis))
                .join('');
        }



        function renderAnalysisCard(analysis) {
            // Color & Icon mapping remains the same
            const typeIcons = {
                stock_pitch: "ð",
                lbo: "ð°",
                dcf: "ð",
                ma: "ð¤",
                industry: "ð"
            };
            const typeColors = {
                stock_pitch: '#10b981',
                lbo: '#f59e0b',
                dcf: '#8b5cf6',
                ma: '#ef4444',
                industry: '#06b6d4'
            };
            const cardColor = typeColors[analysis.type] || '#3b82f6';

            // Recommendation badge
            const recommendationBadge = analysis.keyMetrics?.recommendation ? `
                <span class="tag" style="background: ${analysis.keyMetrics.recommendation === 'BUY' ? 'rgba(16, 185, 129, 0.2)' : analysis.keyMetrics.recommendation === 'SELL' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(245, 158, 11, 0.2)'}; color: ${analysis.keyMetrics.recommendation === 'BUY' ? '#10b981' : analysis.keyMetrics.recommendation === 'SELL' ? '#ef4444' : '#f59e0b'};">
                    ${analysis.keyMetrics.recommendation}
                </span>
            ` : '';

            // Tags
            const tagsHTML = analysis.tags && analysis.tags.length > 0 ? `
                <div class="finance-card-tags">
                    ${analysis.tags.map(tag => `<span class="tag" style="background: rgba(${parseInt(cardColor.slice(1,3), 16)}, ${parseInt(cardColor.slice(3,5), 16)}, ${parseInt(cardColor.slice(5,7), 16)}, 0.15); color: ${cardColor};">${tag}</span>`).join('')}
                </div>
            ` : '';

            // Key Metrics
            let metricsHTML = '';
            const km = analysis.keyMetrics || {};
            if (km.currentPrice || km.targetPrice || km.upside || km.peRatio) {
                metricsHTML = `
                    <div class="finance-card-metrics">
                        ${km.currentPrice ? `<div class="metric-item"><span class="metric-label">Current</span><span class="metric-value">${km.currentPrice}</span></div>` : ''}
                        ${km.targetPrice ? `<div class="metric-item"><span class="metric-label">Target</span><span class="metric-value">${km.targetPrice}</span></div>` : ''}
                        ${km.upside ? `<div class="metric-item"><span class="metric-label">Upside</span><span class="metric-value" style="color: ${km.upside.includes('-') ? '#ef4444' : '#10b981'};">${km.upside}</span></div>` : ''}
                        ${km.peRatio ? `<div class="metric-item"><span class="metric-label">P/E</span><span class="metric-value">${km.peRatio}</span></div>` : ''}
                    </div>
                `;
            }

            // Links
            const linksHTML = (analysis.links.pitchDeck || analysis.links.excelModel || analysis.links.notes) ? `
                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px;">
                    ${analysis.links.pitchDeck ? `<a href="${analysis.links.pitchDeck}" target="_blank" class="course-action-btn open-link" style="flex: 1; text-align: center; text-decoration: none; padding: 4px 8px; font-size: 0.75rem;">ð Pitch Deck</a>` : ''}
                    ${analysis.links.excelModel ? `<a href="${analysis.links.excelModel}" target="_blank" class="course-action-btn open-link" style="flex: 1; text-align: center; text-decoration: none; padding: 4px 8px; font-size: 0.75rem;">ð Excel Model</a>` : ''}
                    ${analysis.links.notes ? `<a href="${analysis.links.notes}" target="_blank" class="course-action-btn open-link" style="flex: 1; text-align: center; text-decoration: none; padding: 4px 8px; font-size: 0.75rem;">ð Notes</a>` : ''}
                </div>
            ` : '';

            return `
                <div class="finance-card" style="border-left: 4px solid ${cardColor};">
                    <div class="finance-card-header">
                        <div>
                            <div class="finance-card-title">${analysis.title}</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; margin-top: 4px;">
                                ${typeIcons[analysis.type]} ${formatDate(analysis.date)}
                            </div>
                        </div>
                        ${recommendationBadge}
                    </div>
                    <div class="finance-card-content">
                        <div class="finance-card-thesis">"${analysis.thesis}"</div>
                        ${metricsHTML}
                        ${tagsHTML}
                        ${linksHTML}
                    </div>
                    <div class="finance-card-actions">
                        <button onclick="editAnalysis('${analysis.id}')" class="course-action-btn edit">âï¸ Edit</button>
                        <button onclick="deleteAnalysis('${analysis.id}')" class="course-action-btn delete">ðï¸ Delete</button>
                    </div>
                </div>
            `;
        }


        let saveQueue = [];
        let saveTimeout = null;
        function queueSave(key, data) {
            saveQueue.push({ key, data });
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveQueue.forEach(({ key, data }) => {
                    localStorage.setItem(key, JSON.stringify(data));
                });
                saveQueue = [];
            }, 500); // Batch save sau 500ms
        }
        // Use: queueSave('studyHours', studyHours);


        // ===== MODAL FUNCTIONS =====
        function openAnalysisModal(analysisId = null) {
            const modal = document.getElementById('analysisModal');
            const form = document.getElementById('analysisForm');
            const title = document.getElementById('analysisModalTitle');
            const idInput = document.getElementById('analysisId');
            
            if (analysisId) {
                // Edit mode
                const analysis = investmentAnalyses.find(a => a.id == analysisId);
                if (analysis) {
                    title.textContent = 'Edit Investment Analysis';
                    idInput.value = analysis.id;
                    document.getElementById('analysisTitle').value = analysis.title;
                    document.getElementById('analysisType').value = analysis.type;
                    document.getElementById('analysisDate').value = analysis.date;
                    document.getElementById('analysisThesis').value = analysis.thesis;
                    document.getElementById('analysisTags').value = analysis.tags ? analysis.tags.join(', ') : '';
                    
                    // Populate Key Metrics
                    document.getElementById('currentPrice').value = analysis.keyMetrics?.currentPrice || '';
                    document.getElementById('targetPrice').value = analysis.keyMetrics?.targetPrice || '';
                    document.getElementById('upside').value = analysis.keyMetrics?.upside || '';
                    document.getElementById('peRatio').value = analysis.keyMetrics?.peRatio || '';
                    document.getElementById('recommendation').value = analysis.keyMetrics?.recommendation || '';
                    
                    // Populate Links
                    document.getElementById('pitchDeckLink').value = analysis.links?.pitchDeck || '';
                    document.getElementById('excelModelLink').value = analysis.links?.excelModel || '';
                    document.getElementById('notesLink').value = analysis.links?.notes || '';
                }
            } else {
                // Add mode
                title.textContent = 'Add New Investment Analysis';
                form.reset();
                idInput.value = '';
                document.getElementById('analysisDate').value = new Date().toISOString().split('T')[0]; 
            }
            
            modal.style.display = 'block';
        }

        function closeAnalysisModal() {
            document.getElementById('analysisModal').style.display = 'none';
        }

        // ===== FORM HANDLING =====
        document.getElementById('analysisForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('analysisId').value;
            const isNew = !id;
            
            const analysis = {
                id: isNew ? Date.now().toString() : id,
                title: document.getElementById('analysisTitle').value,
                type: document.getElementById('analysisType').value,
                date: document.getElementById('analysisDate').value,
                thesis: document.getElementById('analysisThesis').value,
                tags: document.getElementById('analysisTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                keyMetrics: {
                    currentPrice: document.getElementById('currentPrice').value,
                    targetPrice: document.getElementById('targetPrice').value,
                    upside: document.getElementById('upside').value,
                    peRatio: document.getElementById('peRatio').value,
                    recommendation: document.getElementById('recommendation').value
                },
                links: {
                    pitchDeck: document.getElementById('pitchDeckLink').value,
                    excelModel: document.getElementById('excelModelLink').value,
                    notes: document.getElementById('notesLink').value
                },
                createdAt: isNew ? new Date().toISOString() : investmentAnalyses.find(a => a.id == id)?.createdAt
            };
            
            if (isNew) {
                investmentAnalyses.push(analysis);
            } else {
                const index = investmentAnalyses.findIndex(a => a.id == id);
                if (index !== -1) investmentAnalyses[index] = analysis;
            }
            
            saveAnalyses();
            renderAnalysisCards();
            closeAnalysisModal();
        });

        // ===== CRUD OPERATIONS =====
        function saveAnalyses() {
            localStorage.setItem('investmentAnalyses', JSON.stringify(investmentAnalyses));
        }

        function editAnalysis(id) {
            openAnalysisModal(id);
        }

        function deleteAnalysis(id) {
            if (confirm('Are you sure you want to delete this analysis?')) {
                investmentAnalyses = investmentAnalyses.filter(a => a.id != id);
                saveAnalyses();
                renderAnalysisCards();
            }
        }

        // ===== FILTERING =====
        function filterAnalyses() {
            const filterType = document.getElementById('analysisTypeFilter').value;
            if (filterType === 'all') {
                renderAnalysisCards();
            } else {
                const filtered = investmentAnalyses.filter(a => a.type === filterType);
                renderAnalysisCards(filtered);
            }
        }

        // ===== UTILITY =====
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            renderAnalysisCards();
        });


        // ===== LOAD DEAL DIARY DATA =====
        dealDiary = JSON.parse(localStorage.getItem('dealDiary')) || [];
        
        // ===== DEAL SCHEMA =====
        const dealSchema = {
            id: Date.now(),
            dealName: "",
            dealType: "", 
            dealValue: "",
            status: "closed",
            date: "",
            parties: {
                buyer: "",
                target: ""
            },
            learnings: "",
            links: {
                pressRelease: "",
                analysis: "",
                filing: ""
            },
            createdAt: new Date().toISOString()
        };

        // ===== RENDER DEAL CARDS =====
        function renderDealCards(deals = dealDiary) {
            const container = document.getElementById('dealCardsContainer');
            const countElement = document.getElementById('dealCount');
            
            countElement.textContent = deals.length;
            
            if (deals.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No deals tracked yet. Add your first one!</div>';
                return;
            }
            
            container.innerHTML = deals
                .sort((a, b) => new Date(b.date) - new Date(a.date)) 
                .map(deal => renderDealCard(deal))
                .join('');
        }





        function renderDealCard(deal) {
            // Color & Icon mapping remains the same
            const typeIcons = {
                'M&A': 'ð¤',
                'LBO': 'ð°',
                'IPO': 'ð',
                'Restructuring': 'ð'
            };
            const typeColors = {
                'M&A': '#ef4444',
                'LBO': '#f59e0b',
                'IPO': '#10b981',
                'Restructuring': '#6366f1'
            };
            const cardColor = typeColors[deal.dealType] || '#8b5cf6';

            // Status badge
            const statusBadges = {
                'closed': '<span class="tag" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">â Closed</span>',
                'announced': '<span class="tag" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;">ð¢ Announced</span>',
                'rumored': '<span class="tag" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;">ð Rumored</span>',
                'terminated': '<span class="tag" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">â Terminated</span>'
            };

            // Parties
            const partiesHTML = (deal.parties?.buyer || deal.parties?.target) ? `
                <div class="finance-card-metrics">
                    <div class="metric-item"><span class="metric-label">Buyer</span><span class="metric-value">${deal.parties?.buyer || 'N/A'}</span></div>
                    <div class="metric-item"><span class="metric-label">Target</span><span class="metric-value">${deal.parties?.target || 'N/A'}</span></div>
                </div>
            ` : '';

            // Deal Value
            const valueHTML = deal.dealValue ? `<div class="finance-card-metrics"><div class="metric-item"><span class="metric-label">Deal Value</span><span class="metric-value">${deal.dealValue}</span></div></div>` : '';

            // Links
            const linksHTML = (deal.links.pressRelease || deal.links.analysis || deal.links.filing) ? `
                <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px;">
                    ${deal.links.pressRelease ? `<a href="${deal.links.pressRelease}" target="_blank" class="course-action-btn open-link" style="flex: 1; text-align: center; text-decoration: none; padding: 4px 8px; font-size: 0.75rem;">ð Press</a>` : ''}
                    ${deal.links.analysis ? `<a href="${deal.links.analysis}" target="_blank" class="course-action-btn open-link" style="flex: 1; text-align: center; text-decoration: none; padding: 4px 8px; font-size: 0.75rem;">ð Analysis</a>` : ''}
                    ${deal.links.filing ? `<a href="${deal.links.filing}" target="_blank" class="course-action-btn open-link" style="flex: 1; text-align: center; text-decoration: none; padding: 4px 8px; font-size: 0.75rem;">ð Filing</a>` : ''}
                </div>
            ` : '';

            return `
                <div class="finance-card" style="border-left: 4px solid ${cardColor};">
                    <div class="finance-card-header">
                        <div>
                            <div class="finance-card-title">${deal.dealName}</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; margin-top: 4px;">
                                ${typeIcons[deal.dealType]} ${formatDate(deal.date)}
                            </div>
                        </div>
                        ${statusBadges[deal.status]}
                    </div>
                    <div class="finance-card-content">
                        ${valueHTML}
                        ${partiesHTML}
                        <div class="finance-card-learnings">
                            <strong>Key Learning:</strong> ${deal.learnings}
                        </div>
                        ${linksHTML}
                    </div>
                    <div class="finance-card-actions">
                        <button onclick="editDeal('${deal.id}')" class="course-action-btn edit">âï¸ Edit</button>
                        <button onclick="deleteDeal('${deal.id}')" class="course-action-btn delete">ðï¸ Delete</button>
                    </div>
                </div>
            `;
        }




        // ===== DEAL MODAL FUNCTIONS =====
        function openDealModal(dealId = null) {
            const modal = document.getElementById('dealModal');
            const form = document.getElementById('dealForm');
            const title = document.getElementById('dealModalTitle');
            const idInput = document.getElementById('dealId');
            
            if (dealId) {
                const deal = dealDiary.find(d => d.id == dealId);
                if (deal) {
                    title.textContent = 'Edit Deal';
                    idInput.value = deal.id;
                    document.getElementById('dealName').value = deal.dealName;
                    document.getElementById('dealType').value = deal.dealType;
                    document.getElementById('dealValue').value = deal.dealValue;
                    document.getElementById('dealStatus').value = deal.status;
                    document.getElementById('dealDate').value = deal.date;
                    document.getElementById('dealBuyer').value = deal.parties?.buyer || '';
                    document.getElementById('dealTarget').value = deal.parties?.target || '';
                    document.getElementById('dealLearnings').value = deal.learnings;
                    document.getElementById('pressReleaseLink').value = deal.links?.pressRelease || '';
                    document.getElementById('analysisLink').value = deal.links?.analysis || '';
                    document.getElementById('filingLink').value = deal.links?.filing || '';
                }
            } else {
                title.textContent = 'Add New Deal';
                form.reset();
                idInput.value = '';
                document.getElementById('dealDate').value = new Date().toISOString().split('T')[0]; 
            }
            
            modal.style.display = 'block';
        }

        function closeDealModal() {
            document.getElementById('dealModal').style.display = 'none';
        }

        // ===== DEAL FORM HANDLING =====
        document.getElementById('dealForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('dealId').value;
            const isNew = !id;
            
            const deal = {
                id: isNew ? Date.now().toString() : id,
                dealName: document.getElementById('dealName').value,
                dealType: document.getElementById('dealType').value,
                dealValue: document.getElementById('dealValue').value,
                status: document.getElementById('dealStatus').value,
                date: document.getElementById('dealDate').value,
                parties: {
                    buyer: document.getElementById('dealBuyer').value,
                    target: document.getElementById('dealTarget').value
                },
                learnings: document.getElementById('dealLearnings').value,
                links: {
                    pressRelease: document.getElementById('pressReleaseLink').value,
                    analysis: document.getElementById('analysisLink').value,
                    filing: document.getElementById('filingLink').value
                },
                createdAt: isNew ? new Date().toISOString() : dealDiary.find(d => d.id == id)?.createdAt
            };
            
            if (isNew) {
                dealDiary.push(deal);
            } else {
                const index = dealDiary.findIndex(d => d.id == id);
                if (index !== -1) dealDiary[index] = deal;
            }
            
            saveDeals();
            renderDealCards();
            closeDealModal();
        });

        // ===== DEAL CRUD OPERATIONS =====
        function saveDeals() {
            localStorage.setItem('dealDiary', JSON.stringify(dealDiary));
        }

        function editDeal(id) {
            openDealModal(id);
        }

        function deleteDeal(id) {
            if (confirm('Are you sure you want to delete this deal?')) {
                dealDiary = dealDiary.filter(d => d.id != id);
                saveDeals();
                renderDealCards();
            }
        }

        // ===== DEAL FILTERING =====
        function filterDeals() {
            const filterType = document.getElementById('dealTypeFilter').value;
            if (filterType === 'all') {
                renderDealCards();
            } else {
                const filtered = dealDiary.filter(d => d.dealType === filterType);
                renderDealCards(filtered);
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            renderDealCards();
        });

        function showFullReview(reviewText, bookTitle) {
            const modal = document.getElementById('fullReviewModal');
            if (!modal) {
                alert(`Review for "${bookTitle}":\n\n${reviewText}`);
                return;
            }
            
            document.getElementById('fullReviewTitle').textContent = `Review: ${bookTitle}`;
            document.getElementById('fullReviewText').textContent = reviewText;
            modal.style.display = 'flex';
        }

        function closeFullReviewModal() {
            const modal = document.getElementById('fullReviewModal');
            if (modal) modal.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                updateChartColors();
                if (sleepChart) {
                    const textColor = '#cbd5e1';
                    sleepChart.options.scales.y.ticks.color = textColor;
                    sleepChart.options.scales.x.ticks.color = textColor;
                    sleepChart.update();
                }
                if (dailyStudyChart) {
                    const textColor = '#cbd5e1';
                    dailyStudyChart.options.scales.y.ticks.color = textColor;
                    dailyStudyChart.options.scales.x.ticks.color = textColor;
                    dailyStudyChart.update();
                }
            }
        });


        // â Open Archived Goals Modal
        function openArchivedGoalsModal() {
            document.getElementById('archivedGoalsModal').style.display = 'flex';
            renderArchivedGoals();
        }

        // â Close Archived Goals Modal
        function closeArchivedGoalsModal() {
            document.getElementById('archivedGoalsModal').style.display = 'none';
        }

        // â Render Archived Goals
        function renderArchivedGoals() {
            const container = document.getElementById('archivedGoalsContainer');
            const careerFilter = document.getElementById('archiveCareerFilter').value;
            
            if (!container) return;
            
            let filteredArchived = archivedGoals;
            
            if (careerFilter !== 'all') {
                filteredArchived = archivedGoals.filter(g => g.career === careerFilter);
            }
            
            if (filteredArchived.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <div style="font-size: 4rem; margin-bottom: 15px; opacity: 0.3;">ð¦</div>
                        <h3 style="margin: 0 0 8px 0; color: var(--text-dark);">No Archived Goals</h3>
                        <p style="margin: 0; font-size: 0.95rem;">
                            ${careerFilter === 'all' ? 'Complete some goals to see them here!' : 'No archived goals for this career yet.'}
                        </p>
                    </div>
                `;
                return;
            }
            
            // Sort by archived date (newest first)
            filteredArchived.sort((a, b) => new Date(b.archivedAt) - new Date(a.archivedAt));
            
            // Group by month
            const groupedByMonth = {};
            filteredArchived.forEach(goal => {
                const date = new Date(goal.archivedAt);
                const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                
                if (!groupedByMonth[monthKey]) {
                    groupedByMonth[monthKey] = [];
                }
                groupedByMonth[monthKey].push(goal);
            });
            
            let html = `
                <div style="margin-bottom: 20px; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border-left: 4px solid #10b981;">
                    <div style="font-size: 1.1rem; font-weight: 600; color: #10b981; margin-bottom: 8px;">
                        ð Total Achievements
                    </div>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px;">
                            <div style="font-size: 0.85rem; color: var(--text-muted);">Total Archived</div>
                            <div style="font-size: 1.8rem; font-weight: 700; color: #10b981;">${filteredArchived.length}</div>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <div style="font-size: 0.85rem; color: var(--text-muted);">Total Hours Completed</div>
                            <div style="font-size: 1.8rem; font-weight: 700; color: #10b981;">
                                ${filteredArchived.reduce((sum, g) => sum + (g.target || 0), 0).toFixed(0)}h
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Render each month group
            Object.entries(groupedByMonth).forEach(([month, goals]) => {
                html += `
                    <div style="margin-bottom: 30px;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-dark); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border-color); display: flex; align-items: center; gap: 10px;">
                            ð ${month}
                            <span style="font-size: 0.85rem; font-weight: 500; color: var(--text-muted);">(${goals.length} goals)</span>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            ${goals.map(goal => renderArchivedGoalCard(goal)).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // â Render Single Archived Goal Card
        function renderArchivedGoalCard(goal) {
            const typeIcons = {
                study_hours: 'ð',
                skill_mastery: 'ð¯',
                custom: 'â'
            };
            
            const careerColors = {
                pe: '#e74c3c', ib: '#3498db', hf: '#f39c12', sc: '#2ecc71',
                fintech: '#00ffef', english: '#fbe82c', chinese: '#00ffd2',
                tools: '#ff1265', cfa1: '#00ff82'
            };
            
            const careerColor = careerColors[goal.career] || '#3b82f6';
            const archivedDate = new Date(goal.archivedAt).toLocaleDateString('en-US', { 
                year: 'numeric', month: 'short', day: 'numeric' 
            });
            
            return `
                <div style="background: var(--bg-white); border-radius: 12px; padding: 20px; border-left: 4px solid ${careerColor}; box-shadow: var(--shadow-sm); transition: all 0.3s ease;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                        <div style="flex: 1; min-width: 200px;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-dark); margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                ${typeIcons[goal.type] || 'ð'} ${goal.title}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span style="background: ${careerColor}; color: white; padding: 3px 10px; border-radius: 12px; font-weight: 600; font-size: 0.75rem;">
                                    ${skillsData[goal.career]?.title || goal.career}
                                </span>
                                <span>â¢</span>
                                <span>Completed: ${archivedDate}</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px;">
                            <button onclick="restoreArchivedGoal('${goal.id}')" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                                â©ï¸ Restore
                            </button>
                            <button onclick="permanentlyDeleteArchivedGoal('${goal.id}')" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                                ðï¸
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; font-size: 0.9rem; color: var(--text-muted); flex-wrap: wrap;">
                        <span><strong>Target:</strong> ${goal.target} ${goal.type === 'custom' ? 'items' : 'hours'}</span>
                        ${goal.skillName ? `<span>â¢ <strong>Skill:</strong> ${goal.skillName}</span>` : ''}
                        ${goal.deadline ? `<span>â¢ <strong>Deadline was:</strong> ${formatDate(goal.deadline)}</span>` : ''}
                    </div>
                </div>
            `;
        }

        // â Restore Archived Goal
        function restoreArchivedGoal(goalId) {
            const goal = archivedGoals.find(g => g.id === goalId);
            if (!goal) return;
            
            if (confirm(`â©ï¸ Restore "${goal.title}" back to active goals?`)) {
                // Remove from archived
                archivedGoals = archivedGoals.filter(g => g.id !== goalId);
                
                // Add back to active goals (remove archivedAt timestamp)
                const restoredGoal = { ...goal };
                delete restoredGoal.archivedAt;
                goals.push(restoredGoal);
                
                localStorage.setItem('archivedGoals', JSON.stringify(archivedGoals));
                saveGoals();
                renderGoals();
                renderArchivedGoals();
                
                showNotification(`â Goal "${goal.title}" restored!`, 'success');
            }
        }

        // â Permanently Delete Archived Goal
        function permanentlyDeleteArchivedGoal(goalId) {
            const goal = archivedGoals.find(g => g.id === goalId);
            if (!goal) return;
            
            if (confirm(`ðï¸ PERMANENTLY delete "${goal.title}"? This cannot be undone!`)) {
                archivedGoals = archivedGoals.filter(g => g.id !== goalId);
                localStorage.setItem('archivedGoals', JSON.stringify(archivedGoals));
                renderArchivedGoals();
                
                // Update button count if modal is open
                const archiveBtn = document.querySelector('.goal-archive-btn');
                if (archiveBtn) {
                    archiveBtn.innerHTML = `ð¦ View Archived Goals (${archivedGoals.length})`;
                }
                
                showNotification('Goal permanently deleted', 'info');
            }
        }




        // ===== DEFAULT MEMES =====
        function getRandomMeme() {
            if (allMemes.length === 0) {
                document.getElementById('memeImage').src = 'https://via.placeholder.com/300x200?text=No+Memes';
                document.getElementById('memeCaption').textContent = 'No memes available. Add some!';
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * allMemes.length);
            const meme = allMemes[randomIndex];
            
            // â HANDLE BOTH OLD (string) & NEW (object) FORMAT
            const url = typeof meme === 'string' ? meme : meme.url;
            const caption = typeof meme === 'string' ? 'Click to see another meme!' : meme.caption;
            
            const img = document.getElementById('memeImage');
            img.src = url;
            document.getElementById('memeCaption').textContent = caption;
            
            img.onerror = function() {
                console.warn('Failed to load meme:', url);
                allMemes = allMemes.filter(m => {
                    const mUrl = typeof m === 'string' ? m : m.url;
                    return mUrl !== url;
                });
                customMemes = customMemes.filter(m => m.url !== url);
                localStorage.setItem('customMemes', JSON.stringify(customMemes));
                updateCustomMemesCount();
                
                if (allMemes.length > 0) {
                    getRandomMeme();
                } else {
                    img.src = 'https://via.placeholder.com/300x200?text=No+Memes';
                }
            };
        }

        function addCustomMeme() {
            const urlInput = document.getElementById('customMemeUrl');
            const url = urlInput.value.trim();
            
            if (!url) {
                showNotification('â Please enter a meme URL!', 'error');
                return;
            }
            
            // Validate URL
            try {
                new URL(url);
            } catch {
                showNotification('â Invalid URL format!', 'error');
                return;
            }
            
            // Check duplicate
            if (customMemes.some(m => m.url === url)) {
                showNotification('â ï¸ This meme already exists!', 'error');
                return;
            }
            
            // â PROMPT FOR CAPTION
            const caption = prompt('Enter a caption for this meme (optional):', '') || 'No caption';
            
            // â LÆ¯U OBJECT THAY VÃ STRING
            const newMeme = { url, caption, addedAt: new Date().toISOString() };
            customMemes.push(newMeme);
            allMemes.push(newMeme);
            
            localStorage.setItem('customMemes', JSON.stringify(customMemes));
            
            urlInput.value = '';
            updateCustomMemesCount();
            showNotification('â Meme added successfully!', 'success');
            getRandomMeme();
        }

        function updateCustomMemesCount() {
            const countEl = document.getElementById('customMemesCount');
            if (countEl) countEl.textContent = customMemes.length;
        }

        function openManageMemesModal() {
            if (customMemes.length === 0) {
                showNotification('ð¸ No custom memes yet. Add some first!', 'info');
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'manageMemesModal';
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--bg-white); border-radius: 16px; max-width: 800px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div style="padding: 24px; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; background: var(--bg-white); z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="margin: 0 0 8px 0; font-size: 1.5rem; color: var(--text-dark);">
                                    ð¸ Manage Your Memes
                                </h2>
                                <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">
                                    ${customMemes.length} custom memes
                                </p>
                            </div>
                            <button onclick="closeManageMemesModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-muted);">
                                Ã
                            </button>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        ${renderCustomMemesList()}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeManageMemesModal();
            });
        }

        function closeManageMemesModal() {
            const modal = document.getElementById('manageMemesModal');
            if (modal) modal.remove();
        }

        function renderCustomMemesList() {
            return customMemes.map((meme, index) => {
                const url = typeof meme === 'string' ? meme : meme.url;
                const caption = typeof meme === 'string' ? 'No caption' : meme.caption;
                
                return `
                    <div style="background: var(--bg-light); padding: 12px; border-radius: 12px; margin-bottom: 12px;">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <img src="${url}" alt="Meme ${index + 1}" 
                                style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; flex-shrink: 0;"
                                onerror="this.src='https://via.placeholder.com/100?text=Error'">
                            
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 6px;">
                                    "${caption}"
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); word-break: break-all; margin-bottom: 6px;">
                                    ${url}
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">
                                    Added: ${typeof meme === 'object' && meme.addedAt ? new Date(meme.addedAt).toLocaleDateString() : 'Unknown'}
                                </div>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <button onclick="editMemeCaption('${url.replace(/'/g, "\\'")}', '${caption.replace(/'/g, "\\'")}')" 
                                    style="background: #3b82f6; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; white-space: nowrap;">
                                    âï¸ Edit
                                </button>
                                <button onclick="deleteCustomMeme('${url.replace(/'/g, "\\'")}')" 
                                    style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; white-space: nowrap;">
                                    ðï¸ Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editMemeCaption(url, oldCaption) {
            const newCaption = prompt('Edit caption:', oldCaption);
            if (newCaption === null) return; // User cancelled
            
            const memeIndex = customMemes.findIndex(m => m.url === url);
            if (memeIndex !== -1) {
                customMemes[memeIndex].caption = newCaption || 'No caption';
                localStorage.setItem('customMemes', JSON.stringify(customMemes));
                
                // Update allMemes
                const allIndex = allMemes.findIndex(m => (typeof m === 'object' ? m.url : m) === url);
                if (allIndex !== -1) {
                    allMemes[allIndex] = customMemes[memeIndex];
                }
                
                // Re-render modal
                const modalBody = document.querySelector('#manageMemesModal > div > div:last-child');
                if (modalBody) {
                    modalBody.innerHTML = renderCustomMemesList();
                }
                
                showNotification('â Caption updated!', 'success');
            }
        }

        function deleteCustomMeme(url) {
            if (!confirm('ðï¸ Delete this meme?')) return;
            
            customMemes = customMemes.filter(m => m.url !== url);
            allMemes = allMemes.filter(m => {
                const mUrl = typeof m === 'string' ? m : m.url;
                return mUrl !== url;
            });
            
            localStorage.setItem('customMemes', JSON.stringify(customMemes));
            updateCustomMemesCount();
            
            const modalBody = document.querySelector('#manageMemesModal > div > div:last-child');
            if (modalBody) {
                modalBody.innerHTML = renderCustomMemesList();
            }
            
            const headerCount = document.querySelector('#manageMemesModal p');
            if (headerCount) {
                headerCount.textContent = `${customMemes.length} custom memes`;
            }
            
            showNotification('Meme deleted', 'info');
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateCustomMemesCount();
            getRandomMeme();
        });
        // ===== END DEFAULT MEMES ===== //
















        // ===== OPEN ARCHIVED GOALS MODAL =====
        function openArchivedGoalsModal() {
            document.getElementById('archivedGoalsModal').style.display = 'flex';
            renderArchivedGoals();
        }

        // ===== CLOSE ARCHIVED GOALS MODAL =====
        function closeArchivedGoalsModal() {
            document.getElementById('archivedGoalsModal').style.display = 'none';
        }

        // ===== RENDER ARCHIVED GOALS =====
        function renderArchivedGoals() {
            const container = document.getElementById('archivedGoalsContainer');
            const careerFilter = document.getElementById('archiveCareerFilter').value;
            
            if (!container) return;
            
            let filteredArchived = archivedGoals;
            
            if (careerFilter !== 'all') {
                filteredArchived = archivedGoals.filter(g => g.career === careerFilter);
            }
            
            if (filteredArchived.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <div style="font-size: 4rem; margin-bottom: 15px; opacity: 0.3;">ð¦</div>
                        <h3 style="margin: 0 0 8px 0; color: var(--text-dark);">No Archived Goals</h3>
                        <p style="margin: 0; font-size: 0.95rem;">
                            ${careerFilter === 'all' ? 'Complete some goals to see them here!' : 'No archived goals for this career yet.'}
                        </p>
                    </div>
                `;
                return;
            }
            
            // Sort by archived date (newest first)
            filteredArchived.sort((a, b) => new Date(b.archivedAt) - new Date(a.archivedAt));
            
            // Group by month
            const groupedByMonth = {};
            filteredArchived.forEach(goal => {
                const date = new Date(goal.archivedAt);
                const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                
                if (!groupedByMonth[monthKey]) {
                    groupedByMonth[monthKey] = [];
                }
                groupedByMonth[monthKey].push(goal);
            });
            
            let html = `
                <div style="margin-bottom: 20px; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border-left: 4px solid #10b981;">
                    <div style="font-size: 1.1rem; font-weight: 600; color: #10b981; margin-bottom: 8px;">
                        ð Total Achievements
                    </div>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px;">
                            <div style="font-size: 0.85rem; color: var(--text-muted);">Total Archived</div>
                            <div style="font-size: 1.8rem; font-weight: 700; color: #10b981;">${filteredArchived.length}</div>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <div style="font-size: 0.85rem; color: var(--text-muted);">Total Hours Completed</div>
                            <div style="font-size: 1.8rem; font-weight: 700; color: #10b981;">
                                ${filteredArchived.reduce((sum, g) => sum + (g.target || 0), 0).toFixed(0)}h
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Render each month group
            Object.entries(groupedByMonth).forEach(([month, goals]) => {
                html += `
                    <div style="margin-bottom: 30px;">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-dark); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border-color); display: flex; align-items: center; gap: 10px;">
                            ð ${month}
                            <span style="font-size: 0.85rem; font-weight: 500; color: var(--text-muted);">(${goals.length} goals)</span>
                        </div>
                        <div style="display: grid; gap: 12px;">
                            ${goals.map(goal => renderArchivedGoalCard(goal)).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ===== RENDER SINGLE ARCHIVED GOAL CARD =====
        function renderArchivedGoalCard(goal) {
            const typeIcons = {
                study_hours: 'ð',
                skill_mastery: 'ð¯',
                custom: 'â'
            };
            
            const careerColors = {
                pe: '#e74c3c', ib: '#3498db', hf: '#f39c12', sc: '#2ecc71',
                fintech: '#00ffef', english: '#fbe82c', chinese: '#00ffd2',
                tools: '#ff1265', cfa1: '#00ff82'
            };
            
            const careerColor = careerColors[goal.career] || '#3b82f6';
            const archivedDate = new Date(goal.archivedAt).toLocaleDateString('en-US', { 
                year: 'numeric', month: 'short', day: 'numeric' 
            });
            
            return `
                <div style="background: var(--bg-white); border-radius: 12px; padding: 20px; border-left: 4px solid ${careerColor}; box-shadow: var(--shadow-sm); transition: all 0.3s ease;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                        <div style="flex: 1; min-width: 200px;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-dark); margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                ${typeIcons[goal.type] || 'ð'} ${goal.title}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span style="background: ${careerColor}; color: white; padding: 3px 10px; border-radius: 12px; font-weight: 600; font-size: 0.75rem;">
                                    ${skillsData[goal.career]?.title || goal.career}
                                </span>
                                <span>â¢</span>
                                <span>Completed: ${archivedDate}</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px;">
                            <button onclick="restoreArchivedGoal('${goal.id}')" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                                â©ï¸ Restore
                            </button>
                            <button onclick="permanentlyDeleteArchivedGoal('${goal.id}')" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                                ðï¸
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; font-size: 0.9rem; color: var(--text-muted); flex-wrap: wrap;">
                        <span><strong>Target:</strong> ${goal.target} ${goal.type === 'custom' ? 'items' : 'hours'}</span>
                        ${goal.skillName ? `<span>â¢ <strong>Skill:</strong> ${goal.skillName}</span>` : ''}
                        ${goal.deadline ? `<span>â¢ <strong>Deadline was:</strong> ${formatDate(goal.deadline)}</span>` : ''}
                    </div>
                </div>
            `;
        }

        // ===== RESTORE ARCHIVED GOAL =====
        function restoreArchivedGoal(goalId) {
            const goal = archivedGoals.find(g => g.id === goalId);
            if (!goal) return;
            
            if (confirm(`â©ï¸ Restore "${goal.title}" back to active goals?`)) {
                // Remove from archived
                archivedGoals = archivedGoals.filter(g => g.id !== goalId);
                
                // Add back to active goals (remove archivedAt timestamp)
                const restoredGoal = { ...goal };
                delete restoredGoal.archivedAt;
                goals.push(restoredGoal);
                
                localStorage.setItem('archivedGoals', JSON.stringify(archivedGoals));
                saveGoals();
                renderGoals();
                renderArchivedGoals();
                
                // Update button count
                const archiveBtn = document.querySelector('.goal-archive-btn');
                if (archiveBtn) {
                    archiveBtn.innerHTML = `ð¦ View Archived Goals (${archivedGoals.length})`;
                }
                
                showNotification(`â Goal "${goal.title}" restored!`, 'success');
            }
        }

        // ===== PERMANENTLY DELETE ARCHIVED GOAL =====
        function permanentlyDeleteArchivedGoal(goalId) {
            const goal = archivedGoals.find(g => g.id === goalId);
            if (!goal) return;
            
            if (confirm(`ðï¸ PERMANENTLY delete "${goal.title}"? This cannot be undone!`)) {
                archivedGoals = archivedGoals.filter(g => g.id !== goalId);
                localStorage.setItem('archivedGoals', JSON.stringify(archivedGoals));
                renderArchivedGoals();
                
                // Update button count
                const archiveBtn = document.querySelector('.goal-archive-btn');
                if (archiveBtn) {
                    archiveBtn.innerHTML = `ð¦ View Archived Goals (${archivedGoals.length})`;
                }
                
                showNotification('Goal permanently deleted', 'info');
            }
        }




// ===================================================================
//  FLASHCARD SYSTEM - COMPLETE JAVASCRIPT
// ===================================================================

// ===== GLOBAL VARIABLES =====
let flashcards = JSON.parse(localStorage.getItem('flashcards')) || [];
let currentFlashcard = null;
let isFlipped = false;
let editingFlashcardId = null;

// Fullscreen variables
let fullscreenFlashcardOpen = false;
let fullscreenFlipped = false;
let currentFullscreenCard = null;
let fullscreenCardIndex = 0;
let studySessionStats = {
    cardsStudied: [],
    cardsKnown: [],  
    startTime: null
};
let sessionTimerInterval = null;

// ===== LIBRARY LOADING =====

// Load MathJax
(function() {
    if (window.MathJax) return;
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
        },
        svg: { fontCache: 'global' }
    };
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js';
    script.async = true;
    document.head.appendChild(script);
})();

// Load Marked.js for Markdown
(function() {
    if (window.marked) return;
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
    script.async = true;
    document.head.appendChild(script);
})();

// ===== UTILITY FUNCTIONS =====

// Format text with Markdown + LaTeX
function formatFlashcardText(text) {
    if (!text) return '';
    
    if (window.marked) {
        const html = marked.parse(text);
        return html;
    }
    
    // Fallback: Basic formatting
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/\n/g, '<br>');
}

// Render LaTeX
function renderLatex(element) {
    if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([element]).catch(err => 
            console.warn('MathJax error:', err)
        );
    }
}

// Helper function for HTML escaping
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Notification helper
function showNotification(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    // You can enhance this with a toast notification system
}

// Get mastery color
function getMasteryColor(mastery) {
    if (mastery >= 80) return '#10b981'; // Green
    if (mastery >= 50) return '#f59e0b'; // Yellow
    if (mastery >= 20) return '#ef4444'; // Red
    return '#6b7280'; // Gray
}

// ===== STORAGE FUNCTIONS =====

function saveFlashcardsToStorage() {
    localStorage.setItem('flashcards', JSON.stringify(flashcards));
    updateFlashcardStats();
    updateFlashcardDashboard();
}

function updateFlashcardStats() {
    const totalCount = document.getElementById('flashcardCount');
    if (totalCount) totalCount.textContent = flashcards.length;
    
    const manageCount = document.getElementById('manageFlashcardCount');
    if (manageCount) manageCount.textContent = flashcards.length;
}

// ===== SIDEBAR FLASHCARD FUNCTIONS =====

function getRandomFlashcard() {
    if (flashcards.length === 0) {
        const questionEl = document.getElementById('flashcardQuestion');
        if (questionEl) questionEl.textContent = 'No flashcards. Add one!';
        return;
    }
    
    const randomIndex = Math.floor(Math.random() * flashcards.length);
    currentFlashcard = flashcards[randomIndex];
    isFlipped = false;
    
    const questionEl = document.getElementById('flashcardQuestion');
    const answerEl = document.getElementById('flashcardAnswer');
    const imageEl = document.getElementById('flashcardImage');
    const frontEl = document.getElementById('flashcardFront');
    const backEl = document.getElementById('flashcardBack');
    
    if (questionEl) {
        questionEl.innerHTML = formatFlashcardText(currentFlashcard.question);
        renderLatex(questionEl);
    }
    
    if (answerEl) {
        answerEl.innerHTML = formatFlashcardText(currentFlashcard.answer);
        renderLatex(answerEl);
    }
    
    // Handle image
    if (imageEl) {
        if (currentFlashcard.imageUrl) {
            imageEl.src = currentFlashcard.imageUrl;
            imageEl.style.display = 'block';
            imageEl.onerror = () => imageEl.style.display = 'none';
        } else {
            imageEl.style.display = 'none';
        }
    }
    
    if (frontEl) frontEl.style.display = 'block';
    if (backEl) backEl.style.display = 'none';
}

function flipFlashcard() {
    if (!currentFlashcard) return;
    
    isFlipped = !isFlipped;
    const frontEl = document.getElementById('flashcardFront');
    const backEl = document.getElementById('flashcardBack');
    
    if (isFlipped) {
        frontEl.style.display = 'none';
        backEl.style.display = 'block';
    } else {
        frontEl.style.display = 'block';
        backEl.style.display = 'none';
    }
}

// ===== MODAL FUNCTIONS =====

function openAddFlashcardModal(flashcardId = null) {
    const modal = document.getElementById('addFlashcardModal');
    if (!modal) return;
    
    const title = document.getElementById('flashcardModalTitle');
    const questionInput = document.getElementById('newFlashcardQuestion');
    const answerInput = document.getElementById('newFlashcardAnswer');
    const imageInput = document.getElementById('newFlashcardImage');
    
    if (flashcardId) {
        const flashcard = flashcards.find(f => f.id === flashcardId);
        if (flashcard) {
            if (title) title.textContent = 'âï¸ Edit Flashcard';
            if (questionInput) questionInput.value = flashcard.question;
            if (answerInput) answerInput.value = flashcard.answer;
            if (imageInput) imageInput.value = flashcard.imageUrl || '';
            editingFlashcardId = flashcardId;
        }
    } else {
        if (title) title.textContent = 'â Add New Flashcard';
        if (questionInput) questionInput.value = '';
        if (answerInput) answerInput.value = '';
        if (imageInput) imageInput.value = '';
        editingFlashcardId = null;
    }
    
    modal.style.display = 'flex';
}

function closeAddFlashcardModal() {
    const modal = document.getElementById('addFlashcardModal');
    if (modal) modal.style.display = 'none';
    editingFlashcardId = null;
}

function saveFlashcard() {
    const questionInput = document.getElementById('newFlashcardQuestion');
    const answerInput = document.getElementById('newFlashcardAnswer');
    const imageInput = document.getElementById('newFlashcardImage');
    
    if (!questionInput || !answerInput) {
        alert('â Error!');
        return;
    }
    
    const question = questionInput.value.trim();
    const answer = answerInput.value.trim();
    const imageUrl = imageInput ? imageInput.value.trim() : '';
    
    if (!question || !answer) {
        alert('â ï¸ Fill Question & Answer!');
        return;
    }
    
    if (editingFlashcardId) {
        const index = flashcards.findIndex(f => f.id === editingFlashcardId);
        if (index !== -1) {
            flashcards[index].question = question;
            flashcards[index].answer = answer;
            flashcards[index].imageUrl = imageUrl;
            flashcards[index].lastReviewed = new Date().toISOString();
            showNotification('â Updated!', 'success');
        }
    } else {
        const now = new Date();
        flashcards.push({
            id: Date.now().toString(),
            question: question,
            answer: answer,
            imageUrl: imageUrl,
            createdAt: now.toISOString(),
            lastReviewed: now.toISOString(),
            mastery: 0,
            nextReview: now.toISOString(),
            reviewCount: 0,
            lastMasteryUpdate: now.toISOString()
        });
        showNotification('â Added!', 'success');
    }        

    saveFlashcardsToStorage();
    closeAddFlashcardModal();
    getRandomFlashcard();
    renderManageFlashcards();
}

function deleteFlashcard(id) {
    if (confirm('ðï¸ Delete?')) {
        flashcards = flashcards.filter(f => f.id !== id);
        saveFlashcardsToStorage();
        renderManageFlashcards();
        showNotification('Deleted', 'info');
    }
}

// ===== MANAGE FLASHCARDS =====

function openManageFlashcardsModal() {
    const modal = document.getElementById('manageFlashcardsModal');
    if (modal) modal.style.display = 'flex';
    renderManageFlashcards();
}

function closeManageFlashcardsModal() {
    const modal = document.getElementById('manageFlashcardsModal');
    if (modal) modal.style.display = 'none';
}

function renderManageFlashcards() {
    const container = document.getElementById('manageFlashcardsContainer');
    if (!container) return;
    
    if (flashcards.length === 0) {
        container.innerHTML = `
            <div class="flashcard-empty-state">
                <div class="flashcard-empty-state-icon">ð­</div>
                <div class="flashcard-empty-state-text">No flashcards yet. Create your first one!</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = flashcards
        .sort((a, b) => new Date(b.lastReviewed) - new Date(a.lastReviewed))
        .map(flashcard => `
            <div class="manage-flashcard-item">
                <div style="display: flex; justify-content: space-between; gap: 15px; margin-bottom: 12px;">
                    <div style="flex: 1;">
                        <div class="manage-flashcard-question">
                            ${escapeHtml(flashcard.question.substring(0, 100))}${flashcard.question.length > 100 ? '...' : ''}
                        </div>
                        <div class="manage-flashcard-date">
                            ð Last reviewed: ${new Date(flashcard.lastReviewed).toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                            })}
                        </div>
                    </div>
                    <div class="manage-flashcard-buttons">
                        <button 
                            onclick="openAddFlashcardModal('${flashcard.id}')" 
                            style="background: #3b82f6; color: white;"
                            title="Edit"
                        >
                            âï¸ Edit
                        </button>
                        <button 
                            onclick="deleteFlashcard('${flashcard.id}')" 
                            style="background: #ef4444; color: white;"
                            title="Delete"
                        >
                            ðï¸
                        </button>
                    </div>
                </div>
                
                ${flashcard.imageUrl ? `
                    <img 
                        src="${escapeHtml(flashcard.imageUrl)}" 
                        style="width: 100%; max-height: 220px; object-fit: contain; border-radius: 10px; margin-bottom: 10px; background: var(--fc-bg);" 
                        onerror="this.style.display='none'"
                    >
                ` : ''}
                
                <!-- Mastery Progress Bar -->
                <div style="margin-top: 12px; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-size: 0.85rem; color: var(--fc-text-muted);">
                            Mastery: ${flashcard.mastery || 0}%
                        </span>
                        <span style="font-size: 0.75rem; color: var(--fc-text-muted);">
                            Reviewed: ${flashcard.reviewCount || 0} times
                        </span>
                    </div>
                    <div style="width: 100%; height: 8px; background: var(--fc-border); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${flashcard.mastery || 0}%; height: 100%; background: ${getMasteryColor(flashcard.mastery)}; transition: width 0.3s ease;"></div>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--fc-text-muted); margin-top: 4px;">
                        Next review: ${new Date(flashcard.nextReview || flashcard.lastReviewed).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </div>
                </div>
                
                <details>
                    <summary style="cursor: pointer; color: #3b82f6; font-size: 0.9rem; font-weight: 600; padding: 8px 0;">
                        ðï¸ Show Answer
                    </summary>
                    <div class="manage-flashcard-answer-preview">
                        ${formatFlashcardText(flashcard.answer)}
                    </div>
                </details>
            </div>
        `).join('');
    
    // Render LaTeX in all answer previews
    container.querySelectorAll('.manage-flashcard-answer-preview').forEach(el => {
        if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise([el]).catch(err => console.warn('MathJax error:', err));
        }
    });
}

// ===================================================================
//  FULLSCREEN FLASHCARD SYSTEM - SPACED REPETITION
// ===================================================================

function initializeFullscreenFlashcards() {
    // Create fullscreen modal HTML with spaced repetition controls
    const modalHTML = `
        <div id="fullscreenFlashcardModal" style="display: none;">
            <div class="fullscreen-flashcard-container">
                
                <!-- Compact Header -->
                <div class="fullscreen-flashcard-header">
                    <div class="fullscreen-flashcard-title">
                        <span>ð´</span>
                        <span>Flashcard Study Mode</span>
                    </div>
                    <div class="fullscreen-flashcard-info">
                        <span id="fullscreenCardCounter">Card 1 of 10</span>
                        <span id="fullscreenSessionTime">00:00</span>
                        <span id="fullscreenCardMastery" style="color: var(--fc-primary); font-weight: 700;">0%</span>
                    </div>
                    <button class="fullscreen-close-btn" onclick="closeFullscreenFlashcard()">
                        <span>â</span>
                        <span>Close</span>
                    </button>
                </div>

                <!-- Main Flashcard Display -->
                <div class="fullscreen-flashcard-display" onclick="flipFullscreenFlashcard()">
                    <div class="fullscreen-flashcard-content">
                        <div id="fullscreenFlashcardFront">
                            <img id="fullscreenFlashcardImage" class="fullscreen-flashcard-image" style="display: none;">
                            <div id="fullscreenFlashcardQuestion" class="fullscreen-flashcard-question"></div>
                        </div>
                        <div id="fullscreenFlashcardBack" style="display: none;">
                            <div id="fullscreenFlashcardAnswer" class="fullscreen-flashcard-answer"></div>
                        </div>
                    </div>
                </div>

                <!-- Combined Bottom Bar with Spaced Repetition -->
                <div class="fullscreen-flashcard-controls" id="fullscreenControlsContainer">
                    <!-- Will be populated by updateFullscreenControls() -->
                </div>
                
            </div>
        </div>
    `;

    // Add modal to body if it doesn't exist
    if (!document.getElementById('fullscreenFlashcardModal')) {
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    // Add expand button to sidebar flashcard
    const sidebarFlashcard = document.getElementById('flashcardDisplay');
    if (sidebarFlashcard && !sidebarFlashcard.querySelector('.flashcard-expand-btn')) {
        const expandBtn = document.createElement('button');
        expandBtn.className = 'flashcard-expand-btn';
        expandBtn.innerHTML = '<span>â¶</span><span>Expand</span>';
        expandBtn.onclick = function(e) {
            e.stopPropagation();
            openFullscreenFlashcard();
        };
        sidebarFlashcard.appendChild(expandBtn);
    }

    // Setup keyboard shortcuts
    setupKeyboardShortcuts();

    // Start session timer
    startSessionTimer();
}

function updateFullscreenControls() {
    const controlsContainer = document.getElementById('fullscreenControlsContainer');
    if (!controlsContainer) return;
    
    const mastery = currentFullscreenCard ? (currentFullscreenCard.mastery || 0) : 0;
    const masteryColor = getMasteryColor(mastery);
    
    controlsContainer.innerHTML = `
        <!-- Navigation Buttons -->
        <button class="flashcard-btn flashcard-btn-secondary" onclick="previousFullscreenCard()">
            â Previous
        </button>
        
        <!-- Difficulty Buttons (Spaced Repetition) -->
        <button class="flashcard-btn" style="background: #ef4444; color: white;" onclick="rateCard('again')" title="Didn't remember (Space)">
            ð´ Again
        </button>
        <button class="flashcard-btn" style="background: #f59e0b; color: white;" onclick="rateCard('hard')" title="Remembered with difficulty">
            ð¡ Hard
        </button>
        <button class="flashcard-btn" style="background: #3b82f6; color: white;" onclick="rateCard('medium')" title="Remembered with some effort">
            ðµ Medium
        </button>
        <button class="flashcard-btn" style="background: #10b981; color: white;" onclick="rateCard('easy')" title="Easily remembered">
            ð¢ Easy
        </button>
        
        <!-- Inline Stats -->
        <div class="fullscreen-stat-inline">
            <span>ð¯ <strong id="fullscreenMastery" style="color: ${masteryColor}">${mastery}%</strong></span>
            <span>ð <strong id="fullscreenCardsStudied">0</strong>/<span id="fullscreenTotalCards">0</span></span>
            <span>â° <strong id="fullscreenDueCards">0</strong> due</span>
        </div>
        
        <!-- Keyboard Shortcuts -->
        <div class="fullscreen-shortcuts-inline">
            <kbd>1</kbd> Again
            <kbd>2</kbd> Hard  
            <kbd>3</kbd> Medium
            <kbd>4</kbd> Easy
            <kbd>SPACE</kbd> Flip
            <kbd>ââ</kbd> Navigate
        </div>
    `;
}

function openFullscreenFlashcard() {
    if (flashcards.length === 0) {
        showNotification('â ï¸ No flashcards available. Add some first!', 'warning');
        return;
    }

    const modal = document.getElementById('fullscreenFlashcardModal');
    if (!modal) return;

    // Reset session stats
    studySessionStats = {
        cardsStudied: [],
        cardsKnown: [],
        startTime: Date.now()
    };

    // Get next card to review (smart selection)
    getNextCardToReview();

    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    fullscreenFlashcardOpen = true;

    // Load the card
    loadFullscreenCard();
    updateFullscreenStats();
    updateFullscreenControls();
}

function closeFullscreenFlashcard() {
    const modal = document.getElementById('fullscreenFlashcardModal');
    if (!modal) return;

    modal.style.display = 'none';
    document.body.style.overflow = '';
    fullscreenFlashcardOpen = false;
    fullscreenFlipped = false;

    // Show completion message if cards were studied
    const cardsStudied = studySessionStats.cardsStudied.length;
    if (cardsStudied > 0) {
        const duration = Math.floor((Date.now() - studySessionStats.startTime) / 1000);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        const known = studySessionStats.cardsKnown.length;
        showNotification(
            `ð Session Complete! Studied ${cardsStudied}/${flashcards.length} cards (${known} known) in ${minutes}m ${seconds}s`,
            'success'
        );
    }
}

function loadFullscreenCard() {
    if (fullscreenCardIndex < 0 || fullscreenCardIndex >= flashcards.length) {
        fullscreenCardIndex = 0;
    }

    const card = flashcards[fullscreenCardIndex];
    if (!card) return;

    currentFullscreenCard = card;
    fullscreenFlipped = false;

    const questionEl = document.getElementById('fullscreenFlashcardQuestion');
    const answerEl = document.getElementById('fullscreenFlashcardAnswer');
    const imageEl = document.getElementById('fullscreenFlashcardImage');
    const frontEl = document.getElementById('fullscreenFlashcardFront');
    const backEl = document.getElementById('fullscreenFlashcardBack');
    const counterEl = document.getElementById('fullscreenCardCounter');
    const totalEl = document.getElementById('fullscreenTotalCards');
    const masteryEl = document.getElementById('fullscreenCardMastery');

    if (questionEl) {
        questionEl.innerHTML = formatFlashcardText(card.question);
        renderLatex(questionEl);
    }

    if (answerEl) {
        answerEl.innerHTML = formatFlashcardText(card.answer);
        renderLatex(answerEl);
    }

    // Handle image
    if (imageEl) {
        if (card.imageUrl) {
            imageEl.src = card.imageUrl;
            imageEl.style.display = 'block';
            imageEl.onerror = () => imageEl.style.display = 'none';
        } else {
            imageEl.style.display = 'none';
        }
    }

    if (frontEl) {
        frontEl.style.display = 'flex';
        frontEl.style.flexDirection = 'column';
        frontEl.style.alignItems = 'center';
        frontEl.style.justifyContent = 'center';
    }
    if (backEl) backEl.style.display = 'none';

    // Update counter
    if (counterEl) {
        counterEl.textContent = `Card ${fullscreenCardIndex + 1} of ${flashcards.length}`;
    }

    // Update total cards in stats
    if (totalEl) {
        totalEl.textContent = flashcards.length;
    }

    // Update mastery display
    if (masteryEl) {
        masteryEl.textContent = `${card.mastery || 0}%`;
        masteryEl.style.color = getMasteryColor(card.mastery);
    }

    updateFullscreenStats();
    updateFullscreenControls();
}

function flipFullscreenFlashcard() {
    if (!currentFullscreenCard) return;

    fullscreenFlipped = !fullscreenFlipped;
    const frontEl = document.getElementById('fullscreenFlashcardFront');
    const backEl = document.getElementById('fullscreenFlashcardBack');

    if (fullscreenFlipped) {
        // When flipping to see answer, count as studied
        if (!studySessionStats.cardsStudied.includes(currentFullscreenCard.id)) {
            studySessionStats.cardsStudied.push(currentFullscreenCard.id);
        }
        
        // Update session stats
        updateFullscreenStats();
        
        // Show back, hide front
        if (frontEl) frontEl.style.display = 'none';
        if (backEl) backEl.style.display = 'block';
    } else {
        // Show front, hide back
        if (frontEl) {
            frontEl.style.display = 'flex';
            frontEl.style.flexDirection = 'column';
            frontEl.style.alignItems = 'center';
            frontEl.style.justifyContent = 'center';
        }
        if (backEl) backEl.style.display = 'none';
    }
}

// ===== SPACED REPETITION FUNCTIONS =====

function updateCardMastery(cardId, difficulty) {
    const card = flashcards.find(c => c.id === cardId);
    if (!card) return;
    
    const now = new Date();
    card.lastReviewed = now.toISOString();
    card.reviewCount = (card.reviewCount || 0) + 1;
    
    // Mastery change based on difficulty
    const masteryChange = {
        'easy': 25,
        'medium': 15,
        'hard': 5,
        'again': -30
    };
    
    const change = masteryChange[difficulty] || 0;
    card.mastery = Math.max(0, Math.min(100, (card.mastery || 0) + change));
    card.lastMasteryUpdate = now.toISOString();
    
    // Calculate next review date (spaced repetition algorithm)
    let daysToNextReview = 1;
    if (difficulty === 'easy') {
        daysToNextReview = card.reviewCount > 3 ? 7 : 3;
    } else if (difficulty === 'medium') {
        daysToNextReview = 2;
    } else if (difficulty === 'hard') {
        daysToNextReview = 1;
    } else { // again
        daysToNextReview = 0.5; // Review again in 12 hours
    }
    
    const nextReviewDate = new Date(now.getTime() + daysToNextReview * 24 * 60 * 60 * 1000);
    card.nextReview = nextReviewDate.toISOString();
    
    saveFlashcardsToStorage();
    
    return card.mastery;
}

function rateCard(difficulty) {
    if (!currentFullscreenCard) return;
    
    // Update card mastery
    const newMastery = updateCardMastery(currentFullscreenCard.id, difficulty);
    
    // Show feedback
    const feedback = {
        'again': 'ð´ Will review again soon',
        'hard': 'ð¡ Marked as Hard',
        'medium': 'ðµ Marked as Medium',
        'easy': 'ð¢ Marked as Easy'
    };
    
    showNotification(`${feedback[difficulty]} (Mastery: ${newMastery}%)`, 'success');
    
    // Add to known cards if rated medium or easy
    if (difficulty === 'medium' || difficulty === 'easy') {
        if (!studySessionStats.cardsKnown.includes(currentFullscreenCard.id)) {
            studySessionStats.cardsKnown.push(currentFullscreenCard.id);
        }
    }
    
    // Add to studied cards
    if (!studySessionStats.cardsStudied.includes(currentFullscreenCard.id)) {
        studySessionStats.cardsStudied.push(currentFullscreenCard.id);
    }
    
    // Update stats
    updateFullscreenStats();
    
    // Move to next card after delay
    setTimeout(() => {
        getNextCardToReview();
    }, 500);
}

function getNextCardToReview() {
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    
    // 1. Get cards due for review (nextReview <= now)
    const dueCards = flashcards.filter(card => {
        const nextReviewDate = new Date(card.nextReview || card.lastReviewed);
        return nextReviewDate <= now;
    });
    
    // 2. Sort: lowest mastery first, then oldest last reviewed
    dueCards.sort((a, b) => {
        if (a.mastery !== b.mastery) return a.mastery - b.mastery;
        return new Date(a.lastReviewed) - new Date(b.lastReviewed);
    });
    
    if (dueCards.length > 0) {
        // Select from due cards
        fullscreenCardIndex = flashcards.findIndex(c => c.id === dueCards[0].id);
    } else {
        // If no cards due, select from low mastery cards
        const lowMasteryCards = flashcards.filter(c => (c.mastery || 0) < 70);
        if (lowMasteryCards.length > 0) {
            const randomCard = lowMasteryCards[Math.floor(Math.random() * lowMasteryCards.length)];
            fullscreenCardIndex = flashcards.findIndex(c => c.id === randomCard.id);
        } else {
            // All cards have high mastery, random selection
            fullscreenCardIndex = Math.floor(Math.random() * flashcards.length);
        }
    }
    
    loadFullscreenCard();
}

function getFlashcardDashboard() {
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    
    // Cards due today
    const dueToday = flashcards.filter(card => {
        const nextReviewDate = new Date(card.nextReview || card.lastReviewed);
        return nextReviewDate.toISOString().split('T')[0] <= today;
    }).length;
    
    // Average mastery
    const totalMastery = flashcards.reduce((sum, card) => sum + (card.mastery || 0), 0);
    const avgMastery = flashcards.length > 0 ? Math.round(totalMastery / flashcards.length) : 0;
    
    // Cards by mastery level
    const mastered = flashcards.filter(c => (c.mastery || 0) >= 80).length;
    const learning = flashcards.filter(c => (c.mastery || 0) >= 30 && (c.mastery || 0) < 80).length;
    const newCards = flashcards.filter(c => (c.mastery || 0) < 30).length;
    
    return {
        total: flashcards.length,
        dueToday,
        avgMastery,
        mastered,
        learning,
        newCards
    };
}

function updateFlashcardDashboard() {
    const dashboard = getFlashcardDashboard();
    
    // You can display this in your UI somewhere
    console.log('Flashcard Dashboard:', dashboard);
    
    return dashboard;
}

// ===== NAVIGATION FUNCTIONS =====

function nextFullscreenCard() {
    fullscreenCardIndex++;
    
    if (fullscreenCardIndex >= flashcards.length) {
        fullscreenCardIndex = 0;
        showNotification('ð Back to first card!', 'info');
    }
    
    loadFullscreenCard();
}

function previousFullscreenCard() {
    fullscreenCardIndex--;
    
    if (fullscreenCardIndex < 0) {
        fullscreenCardIndex = flashcards.length - 1;
        showNotification('ð Jumped to last card!', 'info');
    }
    
    loadFullscreenCard();
}

// ===== STATS FUNCTIONS =====

function updateFullscreenStats() {
    const studiedEl = document.getElementById('fullscreenCardsStudied');
    const totalEl = document.getElementById('fullscreenTotalCards');
    const progressEl = document.getElementById('fullscreenProgress');
    const knownEl = document.getElementById('fullscreenKnownCards');
    const dueEl = document.getElementById('fullscreenDueCards');

    const cardsStudied = studySessionStats.cardsStudied.length;
    const cardsKnown = studySessionStats.cardsKnown.length;
    const totalCards = flashcards.length;
    
    // Calculate due cards
    const now = new Date();
    const dueCards = flashcards.filter(card => 
        new Date(card.nextReview || card.lastReviewed) <= now
    ).length;

    if (studiedEl) {
        studiedEl.textContent = cardsStudied;
    }

    if (totalEl) {
        totalEl.textContent = totalCards;
    }

    const progressPercent = totalCards > 0 
        ? Math.round((cardsStudied / totalCards) * 100) 
        : 0;

    if (progressEl) {
        progressEl.textContent = `${progressPercent}%`;
    }

    if (knownEl) {
        knownEl.textContent = cardsKnown;
    }
    
    if (dueEl) {
        dueEl.textContent = dueCards;
    }
}

// ===== TIMER FUNCTIONS =====

function startSessionTimer() {
    if (sessionTimerInterval) clearInterval(sessionTimerInterval);

    sessionTimerInterval = setInterval(() => {
        if (!fullscreenFlashcardOpen || !studySessionStats.startTime) return;

        const elapsed = Math.floor((Date.now() - studySessionStats.startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;

        const timerEl = document.getElementById('fullscreenSessionTime');
        if (timerEl) {
            timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }, 1000);
}

// ===== KEYBOARD SHORTCUTS =====

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        if (!fullscreenFlashcardOpen) return;

        switch(e.key) {
            case 'Escape':
                closeFullscreenFlashcard();
                break;
            case ' ':
            case 'Enter':
                e.preventDefault();
                flipFullscreenFlashcard();
                break;
            case 'ArrowRight':
                e.preventDefault();
                nextFullscreenCard();
                break;
            case 'ArrowLeft':
                e.preventDefault();
                previousFullscreenCard();
                break;
            case '1':
                e.preventDefault();
                rateCard('again');
                break;
            case '2':
                e.preventDefault();
                rateCard('hard');
                break;
            case '3':
                e.preventDefault();
                rateCard('medium');
                break;
            case '4':
                e.preventDefault();
                rateCard('easy');
                break;
        }
    });
}

// ===== INITIALIZATION =====

document.addEventListener('DOMContentLoaded', function() {
    updateFlashcardStats();
    if (flashcards.length > 0) getRandomFlashcard();
    
    // Update existing flashcards to include mastery fields
    flashcards.forEach(card => {
        if (!card.mastery) card.mastery = 0;
        if (!card.nextReview) card.nextReview = card.lastReviewed || new Date().toISOString();
        if (!card.reviewCount) card.reviewCount = 0;
        if (!card.lastMasteryUpdate) card.lastMasteryUpdate = card.lastReviewed || new Date().toISOString();
    });
    saveFlashcardsToStorage();
    
    // Wait a bit to ensure everything is loaded
    setTimeout(() => {
        initializeFullscreenFlashcards();
    }, 500);
});

// ===== EXPORT FUNCTIONS FOR GLOBAL ACCESS =====

window.getRandomFlashcard = getRandomFlashcard;
window.flipFlashcard = flipFlashcard;
window.openAddFlashcardModal = openAddFlashcardModal;
window.closeAddFlashcardModal = closeAddFlashcardModal;
window.saveFlashcard = saveFlashcard;
window.deleteFlashcard = deleteFlashcard;
window.openManageFlashcardsModal = openManageFlashcardsModal;
window.closeManageFlashcardsModal = closeManageFlashcardsModal;
window.openFullscreenFlashcard = openFullscreenFlashcard;
window.closeFullscreenFlashcard = closeFullscreenFlashcard;
window.flipFullscreenFlashcard = flipFullscreenFlashcard;
window.nextFullscreenCard = nextFullscreenCard;
window.previousFullscreenCard = previousFullscreenCard;
window.rateCard = rateCard;
window.getFlashcardDashboard = getFlashcardDashboard;











        // ===== RESOURCE LIBRARY SYSTEM =====
        let resourceLibrary = JSON.parse(localStorage.getItem('resourceLibrary')) || [];

        // ===== RESOURCE SCHEMA =====
        const resourceSchema = {
            id: Date.now(),
            title: "",
            type: "", 
            category: "",
            url: "",
            author: "",
            notes: "",
            tags: [],
            priority: "medium",
            status: "to-read",
            dateAdded: new Date().toISOString(),
            lastViewed: null
        };

        // ===== RENDER RESOURCE CARDS =====
        function renderResourceCards(resources = resourceLibrary) {
            const container = document.getElementById('resourceCardsContainer');
            const countElement = document.getElementById('resourceCount');
            updateResourceDashboard();
            
            countElement.textContent = resources.length;
            
            if (resources.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No resources yet. Add your first one!</div>';
                return;
            }
            
            container.innerHTML = resources
                .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded))
                .map(resource => renderResourceCard(resource))
                .join('');
        }

        // ===== TOGGLE RESOURCE CARD =====
        function toggleResourceCard(cardId) {
            const content = document.getElementById(`${cardId}-content`);
            const icon = document.getElementById(`${cardId}-icon`);
            const text = document.getElementById(`${cardId}-text`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.textContent = 'â¼';
                text.textContent = 'Show More';
            } else {
                content.classList.add('expanded');
                icon.textContent = 'â²';
                text.textContent = 'Show Less';
            }
        }

        // ===== TOGGLE TAGS =====
        function toggleTags(tagsId) {
            const tagsContainer = document.getElementById(tagsId);
            const icon = document.getElementById(`${tagsId}-icon`);
            const text = document.getElementById(`${tagsId}-text`);
            
            if (tagsContainer.classList.contains('expanded')) {
                tagsContainer.classList.remove('expanded');
                icon.textContent = 'â¼';
                const tagCount = tagsContainer.querySelectorAll('.tag').length;
                text.textContent = `Show all ${tagCount} tags`;
            } else {
                tagsContainer.classList.add('expanded');
                icon.textContent = 'â²';
                text.textContent = 'Show less';
            }
        }

        // ===== RENDER RESOURCE CARD =====
        function renderResourceCard(resource) {
            const typeIcons = {
                video: "ð¥",
                journal: "ð°",
                research: "ð",
                data: "ð",
                podcast: "ðï¸",
                book: "ð",
                tool: "ð ï¸",
                other: "ð"
            };
            
            const typeColors = {
                video: '#ef4444',
                journal: '#3b82f6',
                research: '#8b5cf6',
                data: '#10b981',
                podcast: '#f59e0b',
                book: '#06b6d4',
                tool: '#ec4899',
                other: '#6366f1'
            };
            
            const priorityIcons = {
                high: 'ðº',
                medium: 'ð¸',
                low: 'ð»'
            };
            
            const statusBadges = {
                'to-read': '<span class="tag" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b;">ð To Read</span>',
                'reading': '<span class="tag" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;">ð Reading</span>',
                'completed': '<span class="tag" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">â Completed</span>'
            };
            
            const cardColor = typeColors[resource.type] || '#8b5cf6';
            const cardId = `resource-card-${resource.id}`;
            const tagsId = `tags-${resource.id}`;
            
            // ===== IMPROVED TAGS WITH CLICK-TO-FILTER =====
            let tagsHTML = '';
            if (resource.tags && resource.tags.length > 0) {
                const hasMany = resource.tags.length > 8;
                tagsHTML = `
                    <div id="${tagsId}" class="finance-card-tags ${hasMany ? '' : 'expanded'}">
                        ${resource.tags.map(tag => {
                            const isActive = activeTagFilters.has(tag);
                            return `<span class="tag" 
                                style="background: rgba(${parseInt(cardColor.slice(1,3), 16)}, ${parseInt(cardColor.slice(3,5), 16)}, ${parseInt(cardColor.slice(5,7), 16)}, 0.15); 
                                    color: ${cardColor};
                                    ${isActive ? 'border-color: ' + cardColor + '; font-weight: 600;' : ''}" 
                                onclick="filterByTag('${tag.replace(/'/g, "\\'")}')"
                                title="Click to filter by this tag">
                                ${tag}
                            </span>`;
                        }).join('')}
                    </div>
                    ${hasMany ? `
                        <button onclick="toggleTags('${tagsId}')" class="tag-expand-btn">
                            <span id="${tagsId}-icon">â¼</span>
                            <span id="${tagsId}-text">Show all ${resource.tags.length} tags</span>
                        </button>
                    ` : ''}
                `;
            }
            
            // ===== IMPROVED MARKDOWN PARSING =====
            let notesHTML = '';
            let hasLongNotes = false;
            if (resource.notes) {
                let processedNotes = resource.notes
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<span style="font-weight: 500;">$1</span>')
                    .replace(/^- (.*?)(?:\n|$)/gm, 'â¢ $1<br>')
                    .replace(/^(\d+)\. (.*?)(?:\n|$)/gm, '$1. $2<br>')
                    .replace(/\n/g, '<br>');
                
                hasLongNotes = resource.notes.length > 300 || (resource.notes.match(/\n/g) || []).length > 3;
                
                notesHTML = `
                    <div id="${cardId}-content" class="resource-card-collapsible ${hasLongNotes ? '' : 'expanded'}">
                        <div class="finance-card-thesis">${processedNotes}</div>
                        ${hasLongNotes ? '<div class="resource-card-fade"></div>' : ''}
                    </div>
                    ${hasLongNotes ? `
                        <button onclick="toggleResourceCard('${cardId}')" class="resource-expand-btn">
                            <span id="${cardId}-icon">â¼</span>
                            <span id="${cardId}-text">Show More</span>
                        </button>
                    ` : ''}
                `;
            }
            
            // ===== PROGRESS INDICATOR =====
            let progressHTML = '';
            if (resource.status === 'reading' && resource.progress) {
                progressHTML = `
                    <div style="margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">
                            <span>Progress</span>
                            <span>${resource.progress}%</span>
                        </div>
                        <div style="height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden;">
                            <div style="height: 100%; background: ${cardColor}; width: ${resource.progress}%;"></div>
                        </div>
                    </div>
                `;
            }
            
            // ===== STATUS BUTTONS =====
            let statusButtons = '';
            if (resource.status === 'to-read') {
                statusButtons = `
                    <button onclick="startReadingResource('${resource.id}')" class="resource-status-btn" title="Start Reading">
                        ð
                    </button>
                `;
            } else if (resource.status === 'reading') {
                statusButtons = `
                    <button onclick="completeResource('${resource.id}')" class="resource-status-btn" title="Mark Complete">
                        â
                    </button>
                    <button onclick="updateResourceProgress('${resource.id}')" class="resource-status-btn" title="Update Progress">
                        ð
                    </button>
                `;
            } else {
                statusButtons = `
                    <button onclick="reopenResource('${resource.id}')" class="resource-status-btn" title="Re-open">
                        ð
                    </button>
                `;
            }
            
            return `
                <div class="finance-card" style="border-left: 4px solid ${cardColor};">
                    <div class="finance-card-header">
                        <div>
                            <div class="finance-card-title">${resource.title}</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 6px; margin-top: 4px;">
                                ${typeIcons[resource.type]} ${resource.author || 'Unknown Source'} ${resource.category ? `â¢ ${resource.category}` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            ${priorityIcons[resource.priority]}
                            ${statusBadges[resource.status]}
                        </div>
                    </div>
                    <div class="finance-card-content">
                        ${notesHTML}
                        ${progressHTML}
                        ${tagsHTML}
                        <div style="margin-top: 12px;">
                            <a href="${resource.url}" target="_blank" class="resource-status-btn open-link" title="Open Resource" style="width: 100%; text-align: center; text-decoration: none; padding: 8px 12px; font-size: 0.85rem;">ð Open Link</a>
                        </div>
                    </div>
                    <div class="resource-buttons-grid">
                        ${statusButtons}
                        <button onclick="editResource('${resource.id}')" class="resource-status-btn" title="Edit">
                            âï¸
                        </button>
                        <button onclick="deleteResource('${resource.id}')" class="resource-status-btn" title="Delete">
                            ðï¸
                        </button>
                    </div>
                </div>
            `;
        }

        function startReadingResource(id) {
            const resource = resourceLibrary.find(r => r.id == id);
            if (resource) {
                resource.status = 'reading';
                resource.lastViewed = new Date().toISOString();
                resource.startedDate = resource.startedDate || new Date().toISOString();
                saveResources();
                renderResourceCards();
                showNotification('ð Started reading: ' + resource.title, 'success');
            }
        }

        function completeResource(id) {
            const resource = resourceLibrary.find(r => r.id == id);
            if (resource) {
                resource.status = 'completed';
                resource.lastViewed = new Date().toISOString();
                resource.completedDate = new Date().toISOString();
                if (resource.startedDate) {
                    const start = new Date(resource.startedDate);
                    const end = new Date();
                    const days = Math.floor((end - start) / (1000 * 60 * 60 * 24));
                    resource.timeToComplete = days;
                }
                
                saveResources();
                renderResourceCards();
                showNotification('â Completed: ' + resource.title, 'success');
            }
        }

        function reopenResource(id) {
            const resource = resourceLibrary.find(r => r.id == id);
            if (resource) {
                resource.status = 'reading';
                resource.lastViewed = new Date().toISOString();
                saveResources();
                renderResourceCards();
                showNotification('ð Re-opened: ' + resource.title, 'info');
            }
        }

        function updateResourceProgress(id) {
            const progress = prompt('Update progress (1-100%):', '50');
            if (progress && !isNaN(progress)) {
                const resource = resourceLibrary.find(r => r.id == id);
                if (resource) {
                    resource.progress = Math.min(100, Math.max(0, parseInt(progress)));
                    resource.lastViewed = new Date().toISOString();
                    saveResources();
                    renderResourceCards();
                    showNotification(`ð Progress updated: ${resource.progress}%`, 'success');
                }
            }
        }

        // ===== TAG FILTERS =====
        let activeTagFilters = new Set();

        // ===== GET ALL UNIQUE TAGS WITH COUNTS =====
        function getAllResourceTags() {
            const tagCounts = {};
            
            resourceLibrary.forEach(resource => {
                if (resource.tags && resource.tags.length > 0) {
                    resource.tags.forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                }
            });
            
            return Object.entries(tagCounts)
                .sort((a, b) => {
                    if (b[1] !== a[1]) return b[1] - a[1]; 
                    return a[0].localeCompare(b[0]); 
                });
        }

        // ===== RENDER TAG CLOUD =====
        function renderTagCloud() {
            const allTags = getAllResourceTags();
            const tagCloudContainer = document.getElementById('tagCloud');
            
            if (!tagCloudContainer) return;
            
            if (allTags.length === 0) {
                tagCloudContainer.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 10px;">No tags yet</div>';
                return;
            }
            
            tagCloudContainer.innerHTML = allTags
                .map(([tag, count]) => `
                    <div class="tag-cloud-item ${activeTagFilters.has(tag) ? 'active' : ''}" 
                        onclick="toggleTagFilter('${tag.replace(/'/g, "\\'")}')">
                        <span>${tag}</span>
                        <span class="tag-count">${count}</span>
                    </div>
                `).join('');
        }

        // ===== TOGGLE TAG FILTER =====
        function toggleTagFilter(tag) {
            if (activeTagFilters.has(tag)) {
                activeTagFilters.delete(tag);
            } else {
                activeTagFilters.add(tag);
            }
            
            renderTagCloud();
            renderActiveFilters();
            filterResources();
        }

        // ===== RENDER ACTIVE FILTERS =====
        function renderActiveFilters() {
            const container = document.getElementById('activeFiltersContainer');
            if (!container) return;
            
            if (activeTagFilters.size === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            container.innerHTML = Array.from(activeTagFilters)
                .map(tag => `
                    <div class="active-filter-chip">
                        <span>${tag}</span>
                        <button onclick="toggleTagFilter('${tag.replace(/'/g, "\\'")}')">Ã</button>
                    </div>
                `).join('');
        }

        // ===== CLEAR ALL TAG FILTERS =====
        function clearAllTagFilters() {
            activeTagFilters.clear();
            renderTagCloud();
            renderActiveFilters();
            filterResources();
        }

        // ===== FILTER RESOURCES BY TAG =====
        function filterByTag(tag) {
            activeTagFilters.clear();
            activeTagFilters.add(tag);
            renderTagCloud();
            renderActiveFilters();
            filterResources();

            document.getElementById('resourceCardsContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // ===== MODAL FUNCTIONS =====
        function openResourceModal(resourceId = null) {
            const modal = document.getElementById('resourceModal');
            const form = document.getElementById('resourceForm');
            const title = document.getElementById('resourceModalTitle');
            const idInput = document.getElementById('resourceId');
            
            if (resourceId) {
                const resource = resourceLibrary.find(r => r.id == resourceId);
                if (resource) {
                    title.textContent = 'Edit Resource';
                    idInput.value = resource.id;
                    document.getElementById('resourceTitle').value = resource.title;
                    document.getElementById('resourceType').value = resource.type;
                    document.getElementById('resourceCategory').value = resource.category || '';
                    document.getElementById('resourceUrl').value = resource.url;
                    document.getElementById('resourceAuthor').value = resource.author || '';
                    document.getElementById('resourceNotes').value = resource.notes || '';
                    document.getElementById('resourceTags').value = resource.tags ? resource.tags.join(', ') : '';
                    document.getElementById('resourcePriority').value = resource.priority;
                    document.getElementById('resourceStatus').value = resource.status;
                }
            } else {
                title.textContent = 'Add New Resource';
                form.reset();
                idInput.value = '';
            }
            
            modal.style.display = 'block';
        }

        function closeResourceModal() {
            document.getElementById('resourceModal').style.display = 'none';
        }

        // ===== FORM HANDLING =====
        document.getElementById('resourceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('resourceId').value;
            const isNew = !id;
            
            const resource = {
                id: isNew ? Date.now().toString() : id,
                title: document.getElementById('resourceTitle').value,
                type: document.getElementById('resourceType').value,
                category: document.getElementById('resourceCategory').value,
                url: document.getElementById('resourceUrl').value,
                author: document.getElementById('resourceAuthor').value,
                notes: document.getElementById('resourceNotes').value,
                tags: document.getElementById('resourceTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                priority: document.getElementById('resourcePriority').value,
                status: document.getElementById('resourceStatus').value,
                dateAdded: isNew ? new Date().toISOString() : resourceLibrary.find(r => r.id == id)?.dateAdded,
                lastViewed: resourceLibrary.find(r => r.id == id)?.lastViewed || null
            };
            
            if (isNew) {
                resourceLibrary.push(resource);
            } else {
                const index = resourceLibrary.findIndex(r => r.id == id);
                if (index !== -1) resourceLibrary[index] = resource;
            }
            
            saveResources();
            renderResourceCards();
            closeResourceModal();
        });

        // ===== CRUD OPERATIONS =====
        function saveResources() {
            localStorage.setItem('resourceLibrary', JSON.stringify(resourceLibrary));
        }

        function editResource(id) {
            openResourceModal(id);
        }

        function deleteResource(id) {
            if (confirm('Are you sure you want to delete this resource?')) {
                resourceLibrary = resourceLibrary.filter(r => r.id != id);
                saveResources();
                renderResourceCards();
            }
        }

        function markResourceViewed(id) {
            const resource = resourceLibrary.find(r => r.id == id);
            if (resource) {
                resource.lastViewed = new Date().toISOString();
                if (resource.status === 'to-read') {
                    resource.status = 'reading';
                }
                saveResources();
                renderResourceCards();
                showNotification('â Marked as viewed!', 'success');
            }
        }

        // ===== RESOURCE LIBRARY STATISTICS =====
        function getResourceStats() {
            const stats = {
                total: resourceLibrary.length,
                byType: {},
                byStatus: {
                    'to-read': 0,
                    'reading': 0,
                    'completed': 0
                },
                byCategory: {},
                byPriority: {
                    'high': 0,
                    'medium': 0,
                    'low': 0
                },
                unread: 0,
                completed: 0,
                reading: 0,
                last30Days: 0,
                avgProgress: 0,
                inProgress: 0,
                completedThisMonth: 0
            };
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            let totalProgress = 0;
            let readingCount = 0;
            const thisMonth = new Date().getMonth();
            
            resourceLibrary.forEach(resource => {

                stats.byType[resource.type] = (stats.byType[resource.type] || 0) + 1;

                stats.byStatus[resource.status] = (stats.byStatus[resource.status] || 0) + 1;

                if (resource.category) {
                    stats.byCategory[resource.category] = (stats.byCategory[resource.category] || 0) + 1;
                }

                if (resource.priority) {
                    stats.byPriority[resource.priority] = (stats.byPriority[resource.priority] || 0) + 1;
                }

                if (resource.status === 'to-read') stats.unread++;
                if (resource.status === 'completed') stats.completed++;
                if (resource.status === 'reading') stats.reading++;

                if (new Date(resource.dateAdded) >= thirtyDaysAgo) {
                    stats.last30Days++;
                }

                if (resource.status === 'reading' && resource.progress) {
                    totalProgress += resource.progress;
                    readingCount++;
                }

                if (resource.status === 'completed' && resource.completedDate) {
                    const completedMonth = new Date(resource.completedDate).getMonth();
                    if (completedMonth === thisMonth) {
                        stats.completedThisMonth++;
                    }
                }
            });
            
            stats.completionRate = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
            stats.readingRate = stats.total > 0 ? Math.round((stats.reading / stats.total) * 100) : 0;
            stats.unreadRate = stats.total > 0 ? Math.round((stats.unread / stats.total) * 100) : 0;
            
            stats.avgProgress = readingCount > 0 ? Math.round(totalProgress / readingCount) : 0;
            stats.inProgress = readingCount;
            
            return stats;
        }

        function updateResourceDashboard() {
            const stats = getResourceStats();

            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statUnread').textContent = stats.unread;
            document.getElementById('statCompleted').textContent = stats.completed;
            document.getElementById('completionRate').textContent = `${stats.completionRate}%`;
            document.getElementById('completionBar').style.width = `${stats.completionRate}%`;

            const statsRow = document.querySelector('.stats-row');
            if (statsRow) {
                if (!document.getElementById('statInProgress')) {
                    const progressStat = `
                        <div class="stat-box" style="text-align: center; padding: 8px; background: var(--bg-light); border-radius: 8px;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: #f59e0b;" id="statInProgress">${stats.inProgress}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">In Progress</div>
                            <div style="font-size: 0.7rem; color: #f59e0b; margin-top: 2px;">${stats.avgProgress}% avg</div>
                        </div>
                    `;
                    
                    statsRow.style.gridTemplateColumns = 'repeat(4, 1fr)';
                    statsRow.insertAdjacentHTML('beforeend', progressStat);
                } else {
                    document.getElementById('statInProgress').textContent = stats.inProgress;
                    const avgProgressElement = document.querySelector('#statInProgress + div + div');
                    if (avgProgressElement) {
                        avgProgressElement.textContent = `${stats.avgProgress}% avg`;
                    }
                }
            }
            
            // Update type distribution
            const typeContainer = document.getElementById('typeDistribution');
            typeContainer.innerHTML = '';
            
            const typeIcons = {
                video: "ð¥",
                journal: "ð°",
                research: "ð",
                data: "ð",
                podcast: "ðï¸",
                book: "ð",
                tool: "ð ï¸",
                other: "ð"
            };
            
            const typeColors = {
                video: '#ef4444',
                journal: '#3b82f6',
                research: '#8b5cf6',
                data: '#10b981',
                podcast: '#f59e0b',
                book: '#06b6d4',
                tool: '#ec4899',
                other: '#6366f1'
            };
            
            Object.entries(stats.byType)
                .sort(([,a], [,b]) => b - a)
                .forEach(([type, count]) => {
                    const percentage = stats.total > 0 ? Math.round((count / stats.total) * 100) : 0;
                    const color = typeColors[type] || '#6b7280';
                    
                    const typeBadge = document.createElement('div');
                    typeBadge.style.cssText = `
                        padding: 4px 8px;
                        background: ${color}15;
                        border: 1px solid ${color}30;
                        border-radius: 12px;
                        font-size: 0.7rem;
                        display: flex;
                        align-items: center;
                        gap: 4px;
                        color: ${color};
                    `;
                    typeBadge.innerHTML = `
                        <span>${typeIcons[type] || 'ð'}</span>
                        <span style="font-weight: 600;">${count}</span>
                        <span style="opacity: 0.7;">(${percentage}%)</span>
                    `;
                    typeContainer.appendChild(typeBadge);
                });
            
            // Update top categories
            const categoryContainer = document.getElementById('topCategories');
            const sortedCategories = Object.entries(stats.byCategory)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3);
            
            if (sortedCategories.length > 0) {
                categoryContainer.innerHTML = sortedCategories
                    .map(([category, count]) => 
                        `<span style="display: inline-block; margin-right: 8px; background: var(--bg-light); padding: 2px 6px; border-radius: 4px;">${category} (${count})</span>`
                    ).join('');
            } else {
                categoryContainer.textContent = 'No categories yet';
            }
            
            // Update main counter
            document.getElementById('resourceCount').textContent = stats.total;
        }

        // ===== TOGGLE RESOURCE DASHBOARD =====
        function toggleResourceDashboard() {
            const dashboard = document.getElementById('resourceDashboard');
            const toggleBtn = document.getElementById('toggleDashboardBtn');
            
            if (dashboard.style.display === 'none') {
                dashboard.style.display = 'block';
                toggleBtn.innerHTML = `
                    <span>ð</span>
                    <span>Hide Statistics</span>
                    <span style="font-size: 0.8rem;">â²</span>
                `;
            } else {
                dashboard.style.display = 'none';
                toggleBtn.innerHTML = `
                    <span>ð</span>
                    <span>Show Statistics</span>
                    <span style="font-size: 0.8rem;">â¼</span>
                `;
            }
        }

        // ===== FILTERING & SEARCH =====
        function filterResources() {
            const filterType = document.getElementById('resourceTypeFilter').value;
            const searchQuery = document.getElementById('resourceSearch').value.toLowerCase();
            
            let filtered = resourceLibrary;
            
            // Filter by type
            if (filterType !== 'all') {
                filtered = filtered.filter(r => r.type === filterType);
            }
            
            // Filter by search query
            if (searchQuery) {
                filtered = filtered.filter(r => 
                    r.title.toLowerCase().includes(searchQuery) ||
                    r.author?.toLowerCase().includes(searchQuery) ||
                    r.notes?.toLowerCase().includes(searchQuery) ||
                    r.tags?.some(tag => tag.toLowerCase().includes(searchQuery))
                );
            }
            
            // Filter by active tags 
            if (activeTagFilters.size > 0) {
                filtered = filtered.filter(r => {
                    if (!r.tags || r.tags.length === 0) return false;
                    return Array.from(activeTagFilters).every(tag => r.tags.includes(tag));
                });
            }
            
            renderResourceCards(filtered);
            
            // Update filter stats
            const statsText = [];
            if (filterType !== 'all') statsText.push(`Type: ${filterType}`);
            if (searchQuery) statsText.push(`Search: "${searchQuery}"`);
            if (activeTagFilters.size > 0) statsText.push(`Tags: ${activeTagFilters.size}`);
            
            if (statsText.length > 0) {
                showNotification(`Showing ${filtered.length} of ${resourceLibrary.length} resources (${statsText.join(', ')})`, 'info');
            }
        }

        // ===== SEARCH =====
        function searchResources() {
            filterResources();
        }

        // ===== INITIALIZE ON PAGE LOAD =====
        document.addEventListener('DOMContentLoaded', function() {
            renderResourceCards();
            renderTagCloud();
            renderActiveFilters();
        });

        // ===== END RESOURCE LIBRARY SYSTEM ===== //











        // --- DATA MANAGEMENT (EXPORT/IMPORT) ---
        function exportProgress() {
            try {
                // â Get data directly from localStorage instead of variables
                const data = {
                    studyHours: JSON.parse(localStorage.getItem('studyHours') || '{}'),
                    gamification: JSON.parse(localStorage.getItem('gamification') || '{}'),
                    readingList: JSON.parse(localStorage.getItem('readingList') || '[]'),
                    courses: JSON.parse(localStorage.getItem('courses') || '[]'),
                    goals: JSON.parse(localStorage.getItem('goals') || '[]'),
                    archivedGoals: JSON.parse(localStorage.getItem('archivedGoals') || '[]'),
                    dailyStudyData: JSON.parse(localStorage.getItem('dailyStudyData') || '{}'),
                    sessionLogs: JSON.parse(localStorage.getItem('sessionLogs') || '[]'),
                    customQuotes: JSON.parse(localStorage.getItem('customQuotes') || '[]'),
                    customMemes: JSON.parse(localStorage.getItem('customMemes') || '[]'),
                    sleepSessions: JSON.parse(localStorage.getItem('sleepSessions') || '[]'),
                    investmentAnalyses: JSON.parse(localStorage.getItem('investmentAnalyses') || '[]'),
                    dealDiary: JSON.parse(localStorage.getItem('dealDiary') || '[]'),
                    flashcards: JSON.parse(localStorage.getItem('flashcards') || '[]'),
                    resourceLibrary: JSON.parse(localStorage.getItem('resourceLibrary') || '[]'), 
                    exportDate: new Date().toISOString(),
                    version: "2.3" 
                };

                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `finance-skills-tracker-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('â Data exported successfully!', 'success');
            } catch (err) {
                console.error("Export failed:", err);
                showNotification('â Export failed: ' + err.message, 'error');
            }
        }


        function exportProgress() {
            try {
                // â Get data directly from localStorage instead of variables
                const data = {
                    studyHours: JSON.parse(localStorage.getItem('studyHours') || '{}'),
                    gamification: JSON.parse(localStorage.getItem('gamification') || '{}'),
                    readingList: JSON.parse(localStorage.getItem('readingList') || '[]'),
                    courses: JSON.parse(localStorage.getItem('courses') || '[]'),
                    goals: JSON.parse(localStorage.getItem('goals') || '[]'),
                    archivedGoals: JSON.parse(localStorage.getItem('archivedGoals') || '[]'),
                    dailyStudyData: JSON.parse(localStorage.getItem('dailyStudyData') || '{}'),
                    sessionLogs: JSON.parse(localStorage.getItem('sessionLogs') || '[]'),
                    customQuotes: JSON.parse(localStorage.getItem('customQuotes') || '[]'),
                    customMemes: JSON.parse(localStorage.getItem('customMemes') || '[]'),
                    sleepSessions: JSON.parse(localStorage.getItem('sleepSessions') || '[]'),
                    investmentAnalyses: JSON.parse(localStorage.getItem('investmentAnalyses') || '[]'),
                    dealDiary: JSON.parse(localStorage.getItem('dealDiary') || '[]'),
                    flashcards: JSON.parse(localStorage.getItem('flashcards') || '[]'),
                    resourceLibrary: JSON.parse(localStorage.getItem('resourceLibrary') || '[]'), 
                    resourceStats: getResourceStats(), 
                    
                    exportDate: new Date().toISOString(),
                    version: "2.3" 
                };

                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `finance-skills-tracker-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('â Data exported successfully!', 'success');
            } catch (err) {
                console.error("Export failed:", err);
                showNotification('â Export failed: ' + err.message, 'error');
            }
        }

        function importProgress(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.studyHours) { 
                        localStorage.setItem('studyHours', JSON.stringify(data.studyHours));
                        studyHours = JSON.parse(localStorage.getItem('studyHours')) || {};
                    }
                    if (data.gamification) { 
                        localStorage.setItem('gamification', JSON.stringify(data.gamification));
                        gamification = JSON.parse(localStorage.getItem('gamification')) || {};
                    }
                    if (data.readingList) { 
                        localStorage.setItem('readingList', JSON.stringify(data.readingList));
                        readingList = JSON.parse(localStorage.getItem('readingList')) || [];
                    }
                    if (data.courses) { 
                        localStorage.setItem('courses', JSON.stringify(data.courses));
                        courses = JSON.parse(localStorage.getItem('courses')) || [];
                    }
                    if (data.goals) { 
                        localStorage.setItem('goals', JSON.stringify(data.goals));
                        goals = JSON.parse(localStorage.getItem('goals')) || [];
                    }
                    if (data.archivedGoals) { 
                        localStorage.setItem('archivedGoals', JSON.stringify(data.archivedGoals));
                        archivedGoals = JSON.parse(localStorage.getItem('archivedGoals')) || [];
                    }
                    if (data.dailyStudyData) { 
                        localStorage.setItem('dailyStudyData', JSON.stringify(data.dailyStudyData));
                        dailyStudyData = JSON.parse(localStorage.getItem('dailyStudyData')) || {};
                    }
                    if (data.sessionLogs) { 
                        localStorage.setItem('sessionLogs', JSON.stringify(data.sessionLogs));
                        sessionLogs = JSON.parse(localStorage.getItem('sessionLogs')) || [];
                    }
                    
                    // â Custom Quotes Import 
                    if (data.customQuotes) { 
                        localStorage.setItem('customQuotes', JSON.stringify(data.customQuotes));
                        // Force reload from localStorage instead of using variables
                        customQuotes = JSON.parse(localStorage.getItem('customQuotes')) || [];
                        
                        if (typeof defaultQuotes !== 'undefined') {
                            motivationalQuotes = [...defaultQuotes, ...customQuotes];
                        }
                        
                        if (typeof updateCustomQuotesCount === 'function') {
                            updateCustomQuotesCount();
                        }
                    }
                    
                    // â Custom Memes Import
                    if (data.customMemes) { 
                        localStorage.setItem('customMemes', JSON.stringify(data.customMemes));
                        // Force reload from localStorage instead of using variables
                        customMemes = JSON.parse(localStorage.getItem('customMemes')) || [];
                        
                        if (typeof defaultMemes !== 'undefined') {
                            const defaultMemesArray = defaultMemes.map(url => 
                                typeof url === 'string' ? { url, caption: 'Built-in meme' } : url
                            );
                            allMemes = [...defaultMemesArray, ...customMemes];
                        }
                        
                        if (typeof updateCustomMemesCount === 'function') {
                            updateCustomMemesCount();
                        }
                    }
                    
                    if (data.sleepSessions) { 
                        localStorage.setItem('sleepSessions', JSON.stringify(data.sleepSessions));
                        sleepSessions = JSON.parse(localStorage.getItem('sleepSessions')) || [];
                    }
                    if (data.investmentAnalyses) { 
                        localStorage.setItem('investmentAnalyses', JSON.stringify(data.investmentAnalyses));
                        investmentAnalyses = JSON.parse(localStorage.getItem('investmentAnalyses')) || [];
                    }
                    if (data.dealDiary) { 
                        localStorage.setItem('dealDiary', JSON.stringify(data.dealDiary));
                        dealDiary = JSON.parse(localStorage.getItem('dealDiary')) || [];
                    }
                    if (data.flashcards) { 
                        localStorage.setItem('flashcards', JSON.stringify(data.flashcards));
                        flashcards = JSON.parse(localStorage.getItem('flashcards')) || [];
                        if (typeof updateFlashcardStats === 'function') {
                            updateFlashcardStats();
                        }
                    }
                    
                    // â Resource Library Import 
                    if (data.resourceLibrary) { 
                        localStorage.setItem('resourceLibrary', JSON.stringify(data.resourceLibrary));
                        resourceLibrary = JSON.parse(localStorage.getItem('resourceLibrary')) || [];
                        if (typeof renderResourceCards === 'function') renderResourceCards();
                    }

                    // â Reload ALL UI components
                    if (typeof loadCareer === 'function') loadCareer(currentCareer);
                    if (typeof updateStats === 'function') updateStats();
                    if (typeof updateGamificationStats === 'function') updateGamificationStats();
                    if (typeof renderReadingList === 'function') renderReadingList();
                    if (typeof updateReadingCounts === 'function') updateReadingCounts();
                    if (typeof renderCourses === 'function') renderCourses();
                    if (typeof renderGoals === 'function') renderGoals();
                    if (typeof renderSessionLogs === 'function') renderSessionLogs();
                    if (typeof renderSleepHistory === 'function') renderSleepHistory();
                    if (typeof renderSleepChart === 'function') renderSleepChart();
                    if (typeof renderAnalysisCards === 'function') renderAnalysisCards();
                    if (typeof renderDealCards === 'function') renderDealCards();
                    if (typeof getRandomQuote === 'function') getRandomQuote();
                    if (typeof getRandomMeme === 'function') getRandomMeme();
                    if (typeof updateDailyStudyDisplay === 'function') updateDailyStudyDisplay();
                    if (typeof updateCorrelationAnalytics === 'function') updateCorrelationAnalytics();
                    
                    showNotification('â Data imported successfully! All data restored.', 'success');
                    
                    // â Force page reload after 2 seconds to ensure everything syncs
                    setTimeout(() => {
                        if (confirm('Data imported! Reload page to ensure everything syncs properly?')) {
                            location.reload();
                        }
                    }, 2000);
                    
                } catch (err) {
                    console.error("Import failed:", err);
                    showNotification('â Import failed: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }


        // â Global image error handler
        document.addEventListener('DOMContentLoaded', function() {
            // Handle all image errors gracefully
            document.addEventListener('error', function(e) {
                if (e.target.tagName === 'IMG') {
                    console.warn('Image failed to load:', e.target.src);
                    e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23f3f4f6" width="100" height="100"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%239ca3af" font-family="sans-serif" font-size="12">Image</text></svg>';
                    e.target.alt = 'Image not available';
                }
            }, true);
        });




    </script>

    <!--Goal Progress Modal -->
    <div id="updateGoalProgressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="updateGoalProgressModalTitle">ð Update Goal Progress</h2>
                <button class="close-btn" onclick="closeUpdateGoalProgressModal()">Ã</button>
            </div>
            <form id="updateGoalProgressForm">
                <input type="hidden" id="updateGoalProgressId" />
                <div class="form-group">
                    <label for="updateGoalProgressValue">Current Progress (hours):</label>
                    <input type="number" id="updateGoalProgressValue" min="0" step="0.1" required />
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeUpdateGoalProgressModal()">Cancel</button>
                    <button type="submit">Update Progress</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Archived Goals Modal -->
    <div id="archivedGoalsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header" style="position: sticky; top: 0; background: var(--bg-white); z-index: 10; padding-bottom: 15px; border-bottom: 2px solid var(--border-color);">
                <div>
                    <h2 style="margin: 0 0 8px 0; font-size: 1.5rem; color: var(--text-dark);">
                        ð¦ Archived Goals History
                    </h2>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">
                        All your completed goals, preserved forever
                    </p>
                </div>
                <button class="modal-close" onclick="closeArchivedGoalsModal()">&times;</button>
            </div>
            
            <div style="margin: 20px 0;">
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <select id="archiveCareerFilter" onchange="renderArchivedGoals()" style="flex: 1; min-width: 150px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-white); color: var(--text-dark);">
                        <option value="all">All Careers</option>
                        <option value="pe">ð¼ Private Equity</option>
                        <option value="ib">ð¦ Investment Banking</option>
                        <option value="hf">ð Hedge Funds</option>
                        <option value="sc">ð¯ Strategy Consulting</option>
                        <option value="fintech">ð³ Fintech</option>
                        <option value="english">ð© English</option>
                        <option value="chinese">ð Chinese</option>
                        <option value="tools">ð ï¸ Finance Tools</option>
                        <option value="cfa1">ð CFA Level 1</option>
                    </select>
                    
                    <button onclick="clearAllArchivedGoals()" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        ðï¸ Clear All
                    </button>
                </div>
                
                <div id="archivedGoalsContainer">
                    <!-- Archived goals will render here -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>
